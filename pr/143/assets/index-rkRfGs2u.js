const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/medalLoader.vite-DTeEacal.js","assets/vendor-DKE9o5kA.js"])))=>i.map(i=>d[i]);
import{_ as e,r as t,j as r,I as n,C as a,a as s,u as i,c as l,L as o,O as d,d as c,S as u,e as m,T as p,f as h,g as f,h as x,R as b,i as g,k as y,B as v,l as j,m as w,n as N,o as k}from"./vendor-DKE9o5kA.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const S=new Set(["placeholder","under_review","reviewed"]);class C{constructor(e){var t;this.id=e.id,this.type=e.type,this.tier=e.tier,this.name=e.name,this.displayName=e.displayName,this.tierName=e.tierName,this.color=e.color,this.icon=e.icon,this.typeName=e.typeName??null,this.status=(t=e.status,S.has(t)?t:"placeholder"),this.prerequisites=e.prerequisites||[],this.requirements=e.requirements||[],this.unlocksFollowingMedals=e.unlocksFollowingMedals||[],this.description=e.description||"",this.requirementsOriginal=e.requirements_original||"",this.references=Array.isArray(e.references)?e.references:[],this.yearIntroduced=e.yearIntroduced,this.sortOrder=e.sortOrder}getFullName(){const e=this.tier?this.tier.charAt(0).toUpperCase()+this.tier.slice(1).replace("_"," "):"";return`${this.displayName}${e?` (${e})`:""}`}getColorClass(){return{"#FFD700":"text-medal-gold","#C0C0C0":"text-medal-silver","#CD7F32":"text-medal-bronze"}[this.color]||"text-foreground"}isPlaceholder(){return"placeholder"===this.status}isUnderReview(){return"under_review"===this.status}isReviewed(){return"reviewed"===this.status}}class M{constructor(e){this.medals=(e.medals||[]).map(e=>new C(e))}getMedalById(e){return this.medals.find(t=>t.id===e)}getMedalsByType(e){return this.medals.filter(t=>t.type===e)}getMedalsByTier(e){return this.medals.filter(t=>t.tier===e)}getAllMedals(){return[...this.medals]}}function A(e){return e?.id||e?.medalId}function T(e){const t=e?.medals||[],r=[],n=function(e=[]){const t=new Map;for(const r of e){const e=A(r);e&&t.set(e,r)}return t}(t);return t.forEach(e=>{(e.prerequisites||[]).forEach((t,a)=>{if("medal"===t?.type){const s=t.medalId;n.has(s)||r.push(`Medal ${A(e)} prerequisite #${a} references missing medalId: ${s}`)}})}),{ok:0===r.length,errors:r}}function P(e){const t=[],r=new Set;for(const{path:n,data:a}of e){if(!a.type||!Array.isArray(a.medals))throw new Error(`Invalid medal file structure in ${n}: missing 'type' or 'medals' array`);if(r.has(a.type))throw new Error(`Duplicate medal type '${a.type}' found in ${n}`);r.add(a.type);for(const e of a.medals)if(e.type!==a.type)throw new Error(`Medal ${e.id} in ${n} has type '${e.type}' but file is for '${a.type}'`);t.push(...a.medals)}return{version:"1.0",medals:t}}const I={medalDatabase:null,loading:!0,error:null},_=t.createContext(I);function D({children:n}){const[a,s]=t.useState(null),[i,l]=t.useState(!0),[o,d]=t.useState(null);return t.useEffect(()=>{let t=!1;return async function(r){l(!0);try{const n=r??await async function(){const{loadAllMedalFiles:t,mergeAndValidateMedalFiles:r}=await e(async()=>{const{loadAllMedalFiles:e,mergeAndValidateMedalFiles:t}=await import("./medalLoader.vite-DTeEacal.js");return{loadAllMedalFiles:e,mergeAndValidateMedalFiles:t}},__vite__mapDeps([0,1]));return r(await t())}(),a=T(n);a.ok||console.warn("Medal dataset validation errors:",a.errors);const i=new M(n);t||(s(i),d(null))}catch(n){t||(d(`Failed to load medal database: ${n.message}`),console.error("Medal database error:",n))}finally{t||l(!1)}}(),()=>{t=!0}},[]),r.jsx(_.Provider,{value:{medalDatabase:a,loading:i,error:o},children:n})}const F=t.createContext(null),q={allowManualUnlock:!0,enforceCurrentYearForSustained:!1},E=["male","female"];class ${constructor(e){this.userId=e.userId||`user-${Date.now()}`,this.displayName=e.displayName||"",this.createdDate=e.createdDate||(new Date).toISOString(),this.lastModified=e.lastModified||(new Date).toISOString(),this.dateOfBirth=e.dateOfBirth||"",this.sex=e.sex,this.unlockedMedals=e.unlockedMedals||[],this.prerequisites=e.prerequisites||[],this.features={...q,...e.features||{}},this.isGuest=Boolean(e.isGuest)}touch(){this.lastModified=(new Date).toISOString()}}function Y(e){let t;try{t="string"==typeof e?JSON.parse(e):e}catch{throw new Error("Invalid JSON")}if(!t||"profile-backup"!==t.kind||"1.0"!==t.version||!t.profile||"object"!=typeof t.profile)throw new Error("Invalid profile backup");const r=t.profile,n=Array.isArray(r.prerequisites)?r.prerequisites.map((e,t)=>({...e,id:e?.id||`achievement-${Date.now()}-${t}`})):[];return{kind:t.kind,version:t.version,exportedAt:t.exportedAt,profile:{userId:"string"==typeof r.userId?r.userId.trim():"",displayName:"string"==typeof r.displayName?r.displayName:"",createdDate:r.createdDate||(new Date).toISOString(),lastModified:r.lastModified||(new Date).toISOString(),dateOfBirth:"string"==typeof r.dateOfBirth?r.dateOfBirth:"",sex:"string"==typeof r.sex?r.sex.trim().toLowerCase():"",unlockedMedals:Array.isArray(r.unlockedMedals)?r.unlockedMedals:[],prerequisites:n,features:{allowManualUnlock:!(!r.features||!r.features.allowManualUnlock),enforceCurrentYearForSustained:!(!r.features||!r.features.enforceCurrentYearForSustained)},notifications:!!r.notifications}}}class L{async getUserProfile(){throw new Error("Not implemented")}async saveUserProfile(){throw new Error("Not implemented")}async getAllProfiles(){throw new Error("Not implemented")}async deleteProfile(){throw new Error("Not implemented")}async getAchievements(){throw new Error("Not implemented")}async addAchievement(){throw new Error("Not implemented")}async updateAchievement(){throw new Error("Not implemented")}async upsertAchievements(){throw new Error("Not implemented")}async removeAchievement(){throw new Error("Not implemented")}async exportData(){throw new Error("Not implemented")}async importData(){throw new Error("Not implemented")}}const R="profiles",G="metadata";class B extends L{constructor(){super(),this.db=null,this.dbName=this._generateDBName(),this._lastValidationReasons=[]}_generateDBName(){return`medal-app-${window.location.pathname.split("/")[1]||"main"}`}async init(){return new Promise((e,t)=>{const r=indexedDB.open(this.dbName,1);r.onerror=()=>{t(new Error("IndexedDB open failed"))},r.onsuccess=t=>{this.db=t.target.result,e()},r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(R)){const e=t.createObjectStore(R,{keyPath:"userId"});e.createIndex("lastModified","lastModified",{unique:!1}),e.createIndex("createdDate","createdDate",{unique:!1})}t.objectStoreNames.contains(G)||t.createObjectStore(G,{keyPath:"key"})}})}async getUserProfile(e){return await this._transaction(R,"readonly",t=>t.get(e))||null}async saveUserProfile(e){if(!this.validateProfile(e))throw new Error("Invalid profile structure");const t={allowManualUnlock:null!=e.features?.allowManualUnlock?!!e.features.allowManualUnlock:q.allowManualUnlock,enforceCurrentYearForSustained:null!=e.features?.enforceCurrentYearForSustained?!!e.features.enforceCurrentYearForSustained:q.enforceCurrentYearForSustained},r=(new Date).toISOString(),n=await this.getUserProfile(e.userId);let a;return a=n?{...n,...e,sex:e.sex,features:t,userId:n.userId,lastModified:r}:{userId:e.userId||new $(e).userId,displayName:e.displayName||"",createdDate:r,lastModified:r,dateOfBirth:e.dateOfBirth,sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:Boolean(e.notifications),features:t},await this._transaction(R,"readwrite",e=>e.put(a)),a}async getAllProfiles(){return await this._transaction(R,"readonly",e=>e.getAll())||[]}async deleteProfile(e){await this._transaction(R,"readwrite",t=>t.delete(e))}_generateAchievementId(){try{if("undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID)return`achievement-${crypto.randomUUID()}`}catch{}return`achievement-${Date.now()}-${Math.random().toString(36).slice(2,11)}`}_ensureAchievementIds(e){let t=!1;return e.prerequisites=Array.isArray(e.prerequisites)?e.prerequisites:[],e.prerequisites.forEach(e=>{e.id||(e.id=this._generateAchievementId(),t=!0)}),t}async getAchievements(e){const t=await this.getUserProfile(e);if(!t)return[];return this._ensureAchievementIds(t)&&await this.saveUserProfile(t),t&&t.prerequisites||[]}buildNaturalKey(e){const t=[e.type,e.year,e.weaponGroup].map(e=>String(e??"").trim().toLowerCase()).join("|");switch(e.type){case"precision_series":return`${t}|${String(e.points??"").trim()}`;case"standard_medal":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.medalType||"").toLowerCase()}`;case"competition_result":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.ppcClass||"").toLowerCase()}|${String(e.date||"").toLowerCase()}|${String(e.score??"").trim()}`;case"qualification_result":return`${t}|${(e.weapon||"").toLowerCase()}|${String(e.score??"").trim()}`;case"team_event":return`${t}|${(e.teamName||"").toLowerCase()}|${String(e.position??"").trim()}`;case"event":return`${t}|${(e.eventName||"").toLowerCase()}`;case"running_shooting_course":return`${t}|${String(e.date||"").toLowerCase()}|${String(e.points??"").trim()}`;default:return null}}async upsertAchievements(e,t,{updateById:r=!0,matchNaturalKey:n=!1,addNew:a=!0,dryRun:s=!0}={}){if(!t||0===t.length)return{added:0,updated:0,skipped:0,failed:0,errors:[]};const i=await this.getUserProfile(e);if(!i)throw new Error("Profile not found");this._ensureAchievementIds(i);const l=Array.isArray(i.prerequisites)?i.prerequisites:[],o=new Map(l.map(e=>[e.id,e])),d=new Map;if(n)for(const p of l){const e=this.buildNaturalKey(p);e&&d.set(e,p)}const c=[...l],u={added:0,updated:0,skipped:0,failed:0,errors:[]};for(let p=0;p<(t||[]).length;p++){const e=t[p];try{if(!this.validateAchievement(e)){const t=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";false,u.failed++,u.errors.push({record:e,row:p+1,error:t});continue}}catch(m){u.failed++,u.errors.push({record:e,row:p+1,error:m?.message||"Validation failed"});continue}let s=null;if(r&&e.id&&o.has(e.id))s=o.get(e.id);else if(n){const t=this.buildNaturalKey(e);t&&d.has(t)&&(s=d.get(t))}if(s){const t=c.findIndex(e=>e.id===s.id);t>=0&&(c[t]={...e,id:s.id},u.updated++);continue}if(a){const t=e.id&&!o.has(e.id)?e.id:this._generateAchievementId();c.push({...e,id:t}),u.added++}else u.skipped++}return s||(i.prerequisites=c,await this.saveUserProfile(i)),u}async addAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");if(!this.validateAchievement(t)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}const n=t.id||this._generateAchievementId(),a={...t,id:n};return r.prerequisites=Array.isArray(r.prerequisites)?r.prerequisites:[],r.prerequisites.push(a),await this.saveUserProfile(r),a}async updateAchievement(e,t,r){const n=await this.getUserProfile(e);if(!n)throw new Error("Profile not found");const a=(n.prerequisites||[]).findIndex(e=>e.id===t);if(a<0)throw new Error("Achievement not found");const s={...r,id:t};if(!this.validateAchievement(s)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}return n.prerequisites[a]=s,await this.saveUserProfile(n),n.prerequisites[a]}async removeAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");r.prerequisites=(r.prerequisites||[]).filter(e=>e.id!==t),await this.saveUserProfile(r)}validateProfile(e){if(!e||"object"!=typeof e)return!1;if(!e.userId||"string"!=typeof e.userId)return!1;if("string"!=typeof e.displayName)return!1;if(!Array.isArray(e.unlockedMedals))return!1;if(!Array.isArray(e.prerequisites))return!1;if(!this._isValidDob(e.dateOfBirth))return!1;if(!e.sex||"string"!=typeof e.sex)return!1;if(!E.includes(e.sex))return!1;if(null!=e.features){if("object"!=typeof e.features)return!1;if("allowManualUnlock"in e.features&&"boolean"!=typeof e.features.allowManualUnlock)return!1;if("enforceCurrentYearForSustained"in e.features&&"boolean"!=typeof e.features.enforceCurrentYearForSustained)return!1}const t=this._computeAge(e.dateOfBirth);return!(t<8||t>100)}validateAchievement(e){const t=[];if(e&&"object"==typeof e){e.type&&"string"==typeof e.type||t.push("type missing or not a string"),("number"!=typeof e.year||Number.isNaN(e.year))&&t.push("year must be a finite number");const r=e.weaponGroup||"";if(["A","B","C","R"].includes(r)||t.push(`weaponGroup must be one of A/B/C/R (got "${r}")`),"precision_series"===e.type&&("number"!=typeof e.points||Number.isNaN(e.points)?t.push("points must be a number"):(e.points<0||e.points>50)&&t.push("points must be between 0 and 50")),"application_series"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}("number"!=typeof e.timeSeconds||!Number.isFinite(e.timeSeconds)||e.timeSeconds<=0)&&t.push("timeSeconds must be a positive number"),("number"!=typeof e.hits||!Number.isFinite(e.hits)||e.hits<0)&&t.push("hits must be a non-negative number")}if("competition_result"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}"number"==typeof e.score&&Number.isFinite(e.score)?e.score<0&&t.push("score must be >= 0"):t.push("score must be a number");const r=["national_whole_match","military_fast_match","ppc"],n=String(e.disciplineType||"").toLowerCase();if(r.includes(n)||t.push(`disciplineType must be one of ${r.join(", ")} (got "${n||"(empty)"}")`),"ppc"===n){const r=e.ppcClass;r&&""!==String(r).trim()||t.push('ppcClass is required when disciplineType is "ppc"')}}if("running_shooting_course"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}("number"!=typeof e.points||!Number.isFinite(e.points)||e.points<0)&&t.push("points must be a non-negative number")}}else t.push("achievement must be an object");const r=0===t.length;return this._lastValidationReasons=t,r}_isValidDob(e){if(!e||"string"!=typeof e)return!1;if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const t=new Date(e);if(Number.isNaN(t.getTime()))return!1;const[r,n,a]=e.split("-").map(Number);return t.getFullYear()===r&&t.getMonth()+1===n&&t.getDate()===a}_computeAge(e){if(!this._isValidDob(e))return NaN;const t=new Date(e),r=new Date;let n=r.getFullYear()-t.getFullYear();const a=r.getMonth()-t.getMonth();return(a<0||0===a&&r.getDate()<t.getDate())&&n--,n}_generateUserId(){try{if("undefined"!=typeof crypto){if("function"==typeof crypto.randomUUID)return`user-${crypto.randomUUID()}`;if("function"==typeof crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e);return`user-${Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}`}}}catch{}return`user-${Date.now()}`}async _ensureUniqueId(e){const t=e&&"string"==typeof e&&e.trim()?e.trim():this._generateUserId();let r=t,n=1;for(;await this.getUserProfile(r);)r=`${t}-${n++}`;return r}async restoreProfile(e,{strategy:t="new-id"}={}){if(!e||"object"!=typeof e)throw new Error("Invalid profile");const r=(new Date).toISOString(),n={userId:String(e.userId||""),displayName:String(e.displayName||""),createdDate:e.createdDate||r,lastModified:r,dateOfBirth:e.dateOfBirth||"",sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:!!e.notifications,features:{...q,...e.features?{allowManualUnlock:!!e.features.allowManualUnlock,enforceCurrentYearForSustained:!!e.features.enforceCurrentYearForSustained}:{}}};if("new-id"===t)n.userId=await this._ensureUniqueId(this._generateUserId());else{if("overwrite"!==t)throw new Error("Invalid restore strategy");if(!n.userId)throw new Error("userId is required for overwrite")}if(!this.validateProfile(n))throw new Error("Invalid profile structure");return await this.saveUserProfile(n),n}async getMetadata(e){const t=await this._transaction(G,"readonly",t=>t.get(e));return t?.value}async setMetadata(e,t){return this._transaction(G,"readwrite",r=>r.put({key:e,value:t}))}async _transaction(e,t,r){if(!this.db)throw new Error("Database not initialized. Call init() first.");return new Promise((n,a)=>{try{const s=this.db.transaction(e,t),i=s.objectStore(e),l=r(i);l.onsuccess=()=>n(l.result),l.onerror=()=>a(l.error),s.onerror=()=>a(s.error),s.onabort=()=>a(new Error("Transaction aborted"))}catch(s){a(s)}})}close(){this.db&&(this.db.close(),this.db=null)}}class O extends L{constructor(){super(),this.storageKey="medal-app-data",this.initializeStorage()}initializeStorage(){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");if(!localStorage.getItem(this.storageKey)){const e={version:"2.0",profiles:[],lastBackup:(new Date).toISOString()};return void localStorage.setItem(this.storageKey,JSON.stringify(e))}try{const e=localStorage.getItem(this.storageKey),t=e?JSON.parse(e):null;if(t&&"2.0"!==t.version){const e=this._migrateToV2(t);this.saveStorageData(e)}}catch{const e={version:"2.0",profiles:[],lastBackup:(new Date).toISOString()};localStorage.setItem(this.storageKey,JSON.stringify(e))}}async getUserProfile(e){return this.getStorageData().profiles.find(t=>t.userId===e)||null}async saveUserProfile(e){if(!this.validateProfile(e))throw new Error("Invalid profile structure");const t={allowManualUnlock:null!=e.features?.allowManualUnlock?!!e.features.allowManualUnlock:q.allowManualUnlock,enforceCurrentYearForSustained:null!=e.features?.enforceCurrentYearForSustained?!!e.features.enforceCurrentYearForSustained:q.enforceCurrentYearForSustained},r=this.getStorageData(),n=(new Date).toISOString();e.lastModified=n;const a=r.profiles.findIndex(t=>t.userId===e.userId);if(a>=0)r.profiles[a]={...r.profiles[a],...e,sex:e.sex,features:t,userId:r.profiles[a].userId};else{const a={userId:e.userId||new $(e).userId,displayName:e.displayName||"",createdDate:n,lastModified:n,dateOfBirth:e.dateOfBirth,sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:Boolean(e.notifications),features:t};r.profiles.push(a),e=a}return this.saveStorageData(r),e}async getAllProfiles(){return this.getStorageData().profiles}async deleteProfile(e){const t=this.getStorageData(),r=t.profiles.length;t.profiles=t.profiles.filter(t=>t.userId!==e),t.profiles.length!==r&&this.saveStorageData(t)}_ensureAchievementIds(e){let t=!1;return e.prerequisites=Array.isArray(e.prerequisites)?e.prerequisites:[],e.prerequisites.forEach((e,r)=>{e.id||(e.id=`achievement-${Date.now()}-${r}-${Math.random().toString(36).slice(2,8)}`,t=!0)}),t}async getAchievements(e){const t=await this.getUserProfile(e);if(!t)return[];return this._ensureAchievementIds(t)&&await this.saveUserProfile(t),t&&t.prerequisites||[]}buildNaturalKey(e){const t=[e.type,e.year,e.weaponGroup].map(e=>String(e??"").trim().toLowerCase()).join("|");switch(e.type){case"precision_series":return`${t}|${String(e.points??"").trim()}`;case"standard_medal":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.medalType||"").toLowerCase()}`;case"competition_result":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.ppcClass||"").toLowerCase()}|${String(e.date||"").toLowerCase()}|${String(e.score??"").trim()}`;case"qualification_result":return`${t}|${(e.weapon||"").toLowerCase()}|${String(e.score??"").trim()}`;case"team_event":return`${t}|${(e.teamName||"").toLowerCase()}|${String(e.position??"").trim()}`;case"event":return`${t}|${(e.eventName||"").toLowerCase()}`;case"running_shooting_course":return`${t}|${String(e.date||"").toLowerCase()}|${String(e.points??"").trim()}`;default:return null}}async upsertAchievements(e,t,{updateById:r=!0,matchNaturalKey:n=!1,addNew:a=!0,dryRun:s=!0}={}){const i=await this.getUserProfile(e);if(!i)throw new Error("Profile not found");this._ensureAchievementIds(i);const l=Array.isArray(i.prerequisites)?i.prerequisites:[],o=new Map(l.map(e=>[e.id,e])),d=new Map;if(n)for(const p of l){const e=this.buildNaturalKey(p);e&&d.set(e,p)}const c=[...l],u={added:0,updated:0,skipped:0,failed:0,errors:[]};for(let p=0;p<(t||[]).length;p++){const e=t[p];try{if(!this.validateAchievement(e)){const t=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";console.groupCollapsed(`[LocalStorageDataManager] Validation failed for row #${p+1}`),console.error("Reason:",t),console.log("Record:",e),console.groupEnd(),u.failed++,u.errors.push({record:e,row:p+1,error:t});continue}}catch(m){console.groupCollapsed(`[LocalStorageDataManager] Exception validating row #${p+1}`),console.error(m),console.log("Record:",e),console.groupEnd(),u.failed++,u.errors.push({record:e,row:p+1,error:m?.message||"Validation failed"});continue}let s=null;if(r&&e.id&&o.has(e.id))s=o.get(e.id),console.debug("[LocalStorageDataManager] Matched by id",{row:p+1,id:e.id});else if(n){const t=this.buildNaturalKey(e);t?d.has(t)?(console.debug("[LocalStorageDataManager] Matched by natural key",{row:p+1,key:t}),s=d.get(t)):console.debug("[LocalStorageDataManager] No match by natural key",{row:p+1,key:t}):console.debug("[LocalStorageDataManager] No natural key for record",{row:p+1})}if(s){const t=c.findIndex(e=>e.id===s.id);t>=0&&(c[t]={...e,id:s.id},u.updated++,console.info("[LocalStorageDataManager] Updated achievement",{row:p+1,id:s.id}));continue}if(a){const t=e.id&&!o.has(e.id)?e.id:`achievement-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;c.push({...e,id:t}),u.added++,console.info("[LocalStorageDataManager] Added achievement",{row:p+1,id:t})}else u.skipped++,console.info("[LocalStorageDataManager] Skipped (addNew=false)",{row:p+1})}return s||(i.prerequisites=c,await this.saveUserProfile(i)),u}async addAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");if(!this.validateAchievement(t)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}const n=t.id||`achievement-${Date.now()}`,a={...t,id:n};return r.prerequisites=Array.isArray(r.prerequisites)?r.prerequisites:[],r.prerequisites.push(a),await this.saveUserProfile(r),a}async updateAchievement(e,t,r){const n=await this.getUserProfile(e);if(!n)throw new Error("Profile not found");const a=(n.prerequisites||[]).findIndex(e=>e.id===t);if(a<0)throw new Error("Achievement not found");const s={...r,id:t};if(!this.validateAchievement(s)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}return n.prerequisites[a]=s,await this.saveUserProfile(n),n.prerequisites[a]}async removeAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");r.prerequisites=(r.prerequisites||[]).filter(e=>e.id!==t),await this.saveUserProfile(r)}validateProfile(e){if(!e||"object"!=typeof e)return!1;if(!e.userId||"string"!=typeof e.userId)return!1;if("string"!=typeof e.displayName)return!1;if(!Array.isArray(e.unlockedMedals))return!1;if(!Array.isArray(e.prerequisites))return!1;if(!this._isValidDob(e.dateOfBirth))return!1;if(!e.sex||"string"!=typeof e.sex)return!1;if(!E.includes(e.sex))return!1;if(null!=e.features){if("object"!=typeof e.features)return!1;if("allowManualUnlock"in e.features&&"boolean"!=typeof e.features.allowManualUnlock)return!1;if("enforceCurrentYearForSustained"in e.features&&"boolean"!=typeof e.features.enforceCurrentYearForSustained)return!1}const t=this._computeAge(e.dateOfBirth);return!(t<8||t>100)}validateAchievement(e){const t=[];if(e&&"object"==typeof e){e.type&&"string"==typeof e.type||t.push("type missing or not a string"),("number"!=typeof e.year||Number.isNaN(e.year))&&t.push("year must be a finite number");const r=e.weaponGroup||"";if(["A","B","C","R"].includes(r)||t.push(`weaponGroup must be one of A/B/C/R (got "${r}")`),"precision_series"===e.type&&("number"!=typeof e.points||Number.isNaN(e.points)?t.push("points must be a number"):(e.points<0||e.points>50)&&t.push("points must be between 0 and 50")),"application_series"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}("number"!=typeof e.timeSeconds||!Number.isFinite(e.timeSeconds)||e.timeSeconds<=0)&&t.push("timeSeconds must be a positive number"),("number"!=typeof e.hits||!Number.isFinite(e.hits)||e.hits<0)&&t.push("hits must be a non-negative number")}if("competition_result"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}"number"==typeof e.score&&Number.isFinite(e.score)?e.score<0&&t.push("score must be >= 0"):t.push("score must be a number");const r=["national_whole_match","military_fast_match","ppc"],n=String(e.disciplineType||"").toLowerCase();if(r.includes(n)||t.push(`disciplineType must be one of ${r.join(", ")} (got "${n||"(empty)"}")`),"ppc"===n){const r=e.ppcClass;r&&""!==String(r).trim()||t.push('ppcClass is required when disciplineType is "ppc"')}}if("running_shooting_course"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}("number"!=typeof e.points||!Number.isFinite(e.points)||e.points<0)&&t.push("points must be a non-negative number")}}else t.push("achievement must be an object");const r=0===t.length;if(this._lastValidationReasons=t,!r)try{console.groupCollapsed("[LocalStorageDataManager] validateAchievement failed"),console.error("Reasons:",t),console.log("Achievement:",e),console.groupEnd()}catch{}return r}getStorageData(){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");try{const e=localStorage.getItem(this.storageKey);if(!e)return this.initializeStorage(),this.getStorageData();const t=JSON.parse(e);if(!t||"object"!=typeof t||!Array.isArray(t.profiles))throw new Error("Malformed storage root");return t}catch(e){throw console.error("Failed to read storage:",e),new Error("Storage data corrupted")}}saveStorageData(e){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(t){if(t&&("QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name||22===t.code))throw new Error("Storage quota exceeded");throw t}}_isValidDob(e){if(!e||"string"!=typeof e)return!1;if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const t=new Date(e);return!Number.isNaN(t.getTime())}_computeAge(e){if(!this._isValidDob(e))return NaN;const t=new Date(e),r=new Date;let n=r.getFullYear()-t.getFullYear();const a=r.getMonth()-t.getMonth();return(a<0||0===a&&r.getDate()<t.getDate())&&n--,n}_defaultDob(){return"2000-01-01"}_migrateToV2(e){const t={...e};return t.version="2.0",t.profiles=Array.isArray(e.profiles)?e.profiles.map(e=>{const t={...e};return delete t.weaponGroupPreference,this._isValidDob(t.dateOfBirth)||(t.dateOfBirth=this._defaultDob()),t.features?("boolean"!=typeof t.features.allowManualUnlock&&(t.features.allowManualUnlock=q.allowManualUnlock),"boolean"!=typeof t.features.enforceCurrentYearForSustained&&(t.features.enforceCurrentYearForSustained=q.enforceCurrentYearForSustained)):t.features={...q},t.lastModified=(new Date).toISOString(),t}):[],t}_hasStorage(){try{return"undefined"!=typeof localStorage}catch{return!1}}_generateUserId(){try{if("undefined"!=typeof crypto){if("function"==typeof crypto.randomUUID)return`user-${crypto.randomUUID()}`;if("function"==typeof crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e);return`user-${Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}`}}}catch{}return`user-${Date.now()}`}_ensureUniqueId(e){const t=this.getStorageData(),r=e&&"string"==typeof e&&e.trim()?e.trim():this._generateUserId();let n=r,a=1;for(;t.profiles.some(e=>e.userId===n);)n=`${r}-${a++}`;return n}async restoreProfile(e,{strategy:t="new-id"}={}){if(!e||"object"!=typeof e)throw new Error("Invalid profile");const r=(new Date).toISOString(),n={userId:String(e.userId||""),displayName:String(e.displayName||""),createdDate:e.createdDate||r,lastModified:r,dateOfBirth:e.dateOfBirth||"",sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:!!e.notifications,features:{...q,...e.features?{allowManualUnlock:!!e.features.allowManualUnlock,enforceCurrentYearForSustained:!!e.features.enforceCurrentYearForSustained}:{}}};if("new-id"===t)n.userId=this._ensureUniqueId(this._generateUserId());else{if("overwrite"!==t)throw new Error("Invalid restore strategy");if(!n.userId)throw new Error("userId is required for overwrite")}if(!this.validateProfile(n))throw new Error("Invalid profile structure");const a=this.getStorageData(),s=a.profiles.findIndex(e=>e.userId===n.userId);return s>=0?a.profiles[s]=n:a.profiles.push(n),this.saveStorageData(a),n}}async function U(){const e=null!==localStorage.getItem("medal-app-data");return await async function(){let e;try{e=new B,await e.init();const t=await e.getAllProfiles();return t&&t.length>0}catch{return!1}finally{try{e?.close?.()}catch{}}}()?"indexeddb":e?"localstorage":"none"}function V(){const[e,r]=t.useState(null),[n,a]=t.useState(!1),[s,i]=t.useState(null);return t.useEffect(()=>{let e=!1;return async function(){try{const n=function(){try{return!("undefined"==typeof indexedDB||!indexedDB)&&"function"==typeof indexedDB.open}catch{return!1}}(),s=await U();if(e)return;if("none"===s||"indexeddb"===s){if(n)try{const t=new B;await t.init(),e||r(t)}catch(t){console.error("IndexedDB initialization failed, falling back to localStorage:",t);const n=new O;e||r(n)}else{const t=new O;e||r(t)}return}if("localstorage"===s&&n){e||a(!0);const n=await async function(e){let t;try{e?.({stage:"loading",percent:0});const n=new O,a=await n.getAllProfiles();e?.({stage:"saving",percent:33}),t=new B,await t.init();for(let r=0;r<a.length;r++)await t.saveUserProfile(a[r]),e?.({stage:"saving",percent:33+(r+1)/a.length*34});if(await t.setMetadata("migration_complete",!0),await t.setMetadata("migration_date",(new Date).toISOString()),await t.setMetadata("migrated_from","localstorage"),e?.({stage:"verifying",percent:75}),(await t.getAllProfiles()).length!==a.length)throw new Error("Migration verification failed: profile count mismatch");try{localStorage.removeItem("medal-app-data"),await t.setMetadata("localstorage_cleaned",!0)}catch(r){console.warn("[migrationManager] Failed to clean up localStorage:",r)}return e?.({stage:"complete",percent:100}),{success:!0,profilesMigrated:a.length}}catch(n){return{success:!1,error:n.message}}finally{try{t?.close?.()}catch{}}}(t=>{e||i(t)});if(e)return;if(a(!1),n.success)try{const t=new B;await t.init(),e||r(t)}catch(t){console.error("IndexedDB initialization failed after migration, falling back to localStorage:",t);const n=new O;e||r(n)}else{console.error("Migration failed:",n.error);const t=new O;e||r(t)}}else{const t=new O;e||r(t)}}catch(n){if(console.error("Storage initialization failed, falling back to localStorage:",n),!e)try{const e=new O;r(e)}catch(s){console.error("Fatal: even localStorage fallback failed:",s),r(new O)}}}(),()=>{e=!0}},[]),{manager:e,migrating:n,migrationProgress:s}}const z="profile:dataChanged";function K(){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent(z))}const H="app:onboardingChoice",W="app:lastProfileId";function X(e){if("undefined"!=typeof window)try{e?window.localStorage.setItem(W,e):window.localStorage.removeItem(W)}catch{}}function J({children:e}){const{manager:n,migrating:a}=V(),[s,i]=t.useState(void 0),[l,o]=t.useState([]),[d,c]=t.useState(!1),[u,m]=t.useState(null),[p,h]=t.useState(!1),f=t.useCallback(async()=>{try{c(!0);const e=await n.getAllProfiles();o(e),m(null)}catch(e){m(e.message),console.error("Failed to load profiles:",e)}finally{c(!1)}},[n]),x=t.useCallback(e=>{try{window.localStorage.setItem(H,"guest")}catch(t){}i(function({sex:e}){return new $({userId:"guest",displayName:"Gästläge",dateOfBirth:"1975-01-02",sex:e,unlockedMedals:[],prerequisites:[],isGuest:!0})}({sex:e}))},[]);t.useEffect(()=>{if(!n||a)return;let e=!1;return(async()=>{try{c(!0);const r=await n.getAllProfiles();if(e)return;o(r);let a=null;const s=function(){if("undefined"==typeof window)return null;try{return new URL(window.location.href).searchParams.get("profile")||null}catch{return null}}();if(s&&r.some(e=>e.userId===s))a=r.find(e=>e.userId===s)||null,X(s);else{const e=function(){if("undefined"==typeof window)return null;try{return window.localStorage.getItem(W)}catch{return null}}();if(e&&r.some(t=>t.userId===e))a=r.find(t=>t.userId===e)||null;else if(r.length>0)a=[...r].sort((e,t)=>new Date(t.lastModified)-new Date(e.lastModified))[0];else try{"guest"===window.localStorage.getItem(H)&&(a=null)}catch(t){}}i(a??null),m(null)}catch(r){e||(m(r.message),console.error("Failed to bootstrap profiles:",r))}finally{e||(c(!1),h(!0))}})(),()=>{e=!0}},[n,a]);const b=t.useCallback(async(e,t,r)=>{try{c(!0);const a=new $({displayName:e,dateOfBirth:t,sex:r}),s=await n.saveUserProfile(a);return i(s),X(s.userId),await f(),s}catch(a){throw m(a.message),a}finally{c(!1)}},[n,f]),g=t.useCallback(async e=>{try{c(!0);const t=await n.getUserProfile(e);if(!t)throw new Error("Profile not found");i(t),X(t.userId),m(null)}catch(t){m(t.message)}finally{c(!1)}},[n]);t.useEffect(()=>{if(p&&s&&!s.isGuest)try{window.localStorage.removeItem(H)}catch(e){}},[s,p]);const y=t.useCallback(async e=>{try{c(!0);const t=await n.saveUserProfile(e);return i(t),X(t.userId),await f(),t}catch(t){throw m(t.message),t}finally{c(!1)}},[n,f]),v=t.useCallback(async e=>{try{c(!0),await n.deleteProfile(e),s?.userId===e&&(i(null),X(null)),await f()}catch(t){throw m(t.message),t}finally{c(!1)}},[n,s,f]),j=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(s.isGuest)return i(t=>({...t,prerequisites:[...t?.prerequisites||[],e],lastModified:(new Date).toISOString()})),K(),e;try{c(!0);const t=await n.addAchievement(s.userId,e),r=await n.getUserProfile(s.userId);return i(r),K(),t}catch(t){throw m(t.message),t}finally{c(!1)}},[s,n]),w=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(!e?.id)throw new Error("Achievement id is required");if(s.isGuest)return i(t=>{const r=Array.isArray(t?.prerequisites)?[...t.prerequisites]:[],n=r.findIndex(t=>t.id===e.id);return-1!==n&&(r[n]={...r[n],...e}),{...t,prerequisites:r,lastModified:(new Date).toISOString()}}),K(),e;try{c(!0);const t=await n.getUserProfile(s.userId),r=Array.isArray(t.prerequisites)?[...t.prerequisites]:[],a=r.findIndex(t=>t.id===e.id);if(-1===a)throw new Error("Achievement not found");r[a]={...r[a],...e};const l={...t,prerequisites:r,lastModified:(new Date).toISOString()},o=await n.saveUserProfile(l);return i(o),K(),o.prerequisites[a]}catch(t){throw m(t.message),t}finally{c(!1)}},[s,n]),N=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("Achievement id is required");if(s.isGuest)return i(t=>({...t,prerequisites:(t?.prerequisites||[]).filter(t=>t.id!==e),lastModified:(new Date).toISOString()})),K(),!0;try{c(!0);const t=await n.getUserProfile(s.userId),r=Array.isArray(t.prerequisites)?t.prerequisites.filter(t=>t.id!==e):[],a={...t,prerequisites:r,lastModified:(new Date).toISOString()},l=await n.saveUserProfile(a);return i(l),K(),!0}catch(t){throw m(t.message),t}finally{c(!1)}},[s,n]),k=t.useCallback(async(e,t)=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("medalId is required");if(s.isGuest){let r=!1;return i(n=>{const a=Array.isArray(n?.unlockedMedals)?[...n.unlockedMedals]:[];if(a.some(t=>t.medalId===e))return n;r=!0;const s={medalId:e,unlockedDate:t||(new Date).toISOString().slice(0,10)};return{...n,unlockedMedals:[...a,s],lastModified:(new Date).toISOString()}}),r&&K(),!0}try{c(!0);const r=await n.getUserProfile(s.userId),a=Array.isArray(r.unlockedMedals)?[...r.unlockedMedals]:[];if(a.some(t=>t.medalId===e))return!1;const l={medalId:e,unlockedDate:t||(new Date).toISOString().slice(0,10)},o={...r,unlockedMedals:[...a,l],lastModified:(new Date).toISOString()},d=await n.saveUserProfile(o);return i(d),K(),!0}catch(r){throw m(r.message),r}finally{c(!1)}},[s,n]),S=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("medalId is required");if(s.isGuest)return i(t=>({...t,unlockedMedals:(t?.unlockedMedals||[]).filter(t=>t.medalId!==e),lastModified:(new Date).toISOString()})),!0;try{c(!0);const t=await n.getUserProfile(s.userId),r=Array.isArray(t.unlockedMedals)?t.unlockedMedals:[],a=r.filter(t=>t.medalId!==e);if(a.length===r.length)return!1;const l={...t,unlockedMedals:a,lastModified:(new Date).toISOString()},o=await n.saveUserProfile(l);return i(o),!0}catch(t){throw m(t.message),t}finally{c(!1)}},[s,n]),C=t.useCallback(async(e,t)=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("Feature name is required");if(s.isGuest)return i(r=>({...r,features:{...r?.features||{},[e]:!!t},lastModified:(new Date).toISOString()})),m(null),s;try{c(!0);const r=await n.getUserProfile(s.userId),a={...r.features||{},[e]:!!t},l={...r,features:a,lastModified:(new Date).toISOString()},o=await n.saveUserProfile(l);return i(o),m(null),o}catch(r){throw m(r.message),r}finally{c(!1)}},[s,n]),M=t.useCallback(async(e,t={strategy:"new-id"})=>{try{c(!0);const r=Y(e),a=await n.restoreProfile(r.profile,t);return i(a),X(a.userId),await f(),m(null),a}catch(r){throw m(r.message),r}finally{c(!1)}},[n,f]),A=t.useCallback(async(e,t)=>{if(!s)throw new Error("No profile selected");if(s.isGuest)return t?.dryRun||i(t=>({...t,prerequisites:(Array.isArray(t?.prerequisites),[...e]),lastModified:(new Date).toISOString()})),m(null),{added:e?.length||0,updated:0,duplicates:0};try{c(!0);const r=await n.upsertAchievements(s.userId,e,t);if(!t?.dryRun){const e=await n.getUserProfile(s.userId);i(e),X(e.userId),await f()}return m(null),r}catch(r){throw m(r.message),r}finally{c(!1)}},[s,n,f]),T=t.useCallback(async(e,t="",r)=>{if(!s?.isGuest)return null;const a=new $({...s,userId:void 0,displayName:e||"Profil",dateOfBirth:t,sex:r,isGuest:!1}),l=await n.saveUserProfile(a);return i(l),X(l.userId),await f(),l},[s,n,f]),P=t.useCallback(async()=>{if(!s)return!1;const e={...s,unlockedMedals:[],prerequisites:[],lastModified:(new Date).toISOString()};if(s.isGuest)return i(e),!0;const t=await n.saveUserProfile(e);return i(t),await f(),!0},[s,n,f]),I={currentProfile:s,profiles:l,loading:d,hydrated:p,error:u,createProfile:b,selectProfile:g,updateProfile:y,deleteProfile:v,addAchievement:j,updateAchievement:w,removeAchievement:N,unlockMedal:k,lockMedal:S,setProfileFeature:C,restoreProfileFromBackup:M,upsertAchievements:A,startExplorerMode:x,convertGuestToSaved:T,resetCurrentProfileData:P};return r.jsx(F.Provider,{value:I,children:e})}const Z=t.createContext(null);function Q({lastBackupDate:e,lastDataChange:t,reminderFrequency:r,reminderDismissedUntil:n}){if(0===r)return!1;if(n){if(new Date(n)>new Date)return!1}if(!t)return!1;if(!e)return!0;const a=new Date(e),s=new Date(t),i=function(e,t){const r=t-e;return Math.floor(r/864e5)}(a,new Date);return s>a&&i>=r}function ee({children:e}){const{manager:n}=V(),[a,s]=t.useState(null),[i,l]=t.useState(null),[o,d]=t.useState(30),[c,u]=t.useState(null),[m,p]=t.useState(!0);t.useEffect(()=>{!async function(){if(n)try{const e=await n.getMetadata("lastBackupDate"),t=await n.getMetadata("lastDataChange"),r=await n.getMetadata("backupReminderFrequency"),a=await n.getMetadata("reminderDismissedUntil");s(e||null),l(t||null),d(r??30),u(a||null)}catch(e){console.error("Failed to load backup metadata:",e)}finally{p(!1)}}()},[n]);const h=t.useCallback(async()=>{const e=(new Date).toISOString();if(s(e),n)try{await n.setMetadata("lastBackupDate",e)}catch(t){console.error("Failed to save lastBackupDate:",t)}},[n]),f=t.useCallback(async()=>{const e=(new Date).toISOString();if(l(e),n)try{await n.setMetadata("lastDataChange",e)}catch(t){console.error("Failed to save lastDataChange:",t)}},[n]),x=t.useCallback(async e=>{if(d(e),n)try{await n.setMetadata("backupReminderFrequency",e)}catch(t){console.error("Failed to save backupReminderFrequency:",t)}},[n]),b=t.useCallback(async()=>{const e=function(e=new Date){const t=new Date(e);return t.setDate(t.getDate()+7),t.toISOString()}();if(u(e),n)try{await n.setMetadata("reminderDismissedUntil",e)}catch(t){console.error("Failed to save reminderDismissedUntil:",t)}},[n]);t.useEffect(()=>{const e=()=>{f()};return window.addEventListener(z,e),()=>window.removeEventListener(z,e)},[f]);const g=t.useMemo(()=>Q({lastBackupDate:a,lastDataChange:i,reminderFrequency:o,reminderDismissedUntil:c}),[a,i,o,c]),y={lastBackupDate:a,lastDataChange:i,reminderFrequency:o,reminderDismissedUntil:c,isLoading:m,shouldShowReminder:g,markBackupCreated:h,markDataChanged:f,updateReminderFrequency:x,dismissReminder:b};return r.jsx(Z.Provider,{value:y,children:e})}const te=t.createContext(null),re=new Map;class ne{constructor(e,t){this.medals=e,this.profile=t||{unlockedMedals:[],prerequisites:[]}}static registerCustomCriterion(e,t){if("string"!=typeof e||!e)throw new Error("custom_criterion name must be a non-empty string");if("function"!=typeof t)throw new Error("custom_criterion handler must be a function");re.set(e,t)}evaluateMedal(e,t={}){const r=this.medals.getMedalById(e);if(!r)throw new Error(`Medal not found: ${e}`);if("function"==typeof r.isPlaceholder&&r.isPlaceholder()||"placeholder"===r.status)return{medalId:e,status:"locked",reason:"placeholder",details:{message:"Placeholder medal"}};if(this.hasUnlockedMedal(e))return{medalId:e,status:"unlocked",unlockedDate:this.getUnlockedDate(e),details:{}};if(Array.isArray(r.prerequisites)){const n=r.prerequisites.filter(e=>"medal"===e?.type).filter(e=>{if(!this.hasUnlockedMedal(e.medalId))return!0;if("number"==typeof t.endYear){const r=this.getUnlockedYear(e.medalId);return!("number"==typeof r&&r<=t.endYear)}return!1});if(n.length)return{medalId:e,status:"locked",reason:"prerequisites_not_met",details:{prerequisites:{missingMedals:n.map(e=>e.medalId)}}}}const n=this.checkRequirements(r,t);if(!n.allMet)return{medalId:e,status:"available",reason:"requirements_not_met",details:n};const a=this.checkPrerequisites(r,n.unlockYear??t.endYear);return a.allMet?{medalId:e,status:"eligible",eligibleYear:n.unlockYear??null,details:{...n,prerequisites:a}}:{medalId:e,status:"locked",reason:"prerequisites_not_met",details:a}}hasUnlockedMedal(e){return this.profile.unlockedMedals?.some(t=>t.medalId===e)||!1}getUnlockedDate(e){const t=this.profile.unlockedMedals?.find(t=>t.medalId===e);return t?t.unlockedDate:null}checkPrerequisites(e,t){if(!e.prerequisites||0===e.prerequisites.length)return{allMet:!0,items:[],missingItems:[]};const r=[],n=[];return e.prerequisites.forEach(e=>{if("medal"===e.type){const a=this.getUnlockedYear(e.medalId),s=this.hasUnlockedMedal(e.medalId)&&("number"!=typeof t||"number"==typeof a&&a<=t),i={type:"medal",medalId:e.medalId,isMet:s,achieved:s?this.getUnlockedDate(e.medalId):null,description:e.description,yearOffset:e.yearOffset};if(r.push(i),s){if("number"==typeof e.yearOffset){const r=this.getUnlockedYear(e.medalId),a="number"==typeof t?t:this.getMostRecentAchievementYear()??(new Date).getFullYear(),s=null!==r&&a-r>=e.yearOffset,l={...i,isMet:s,offsetChecked:!0,plannedYear:a};s||n.push(l)}}else n.push(i)}else if("age_requirement"===e.type){const a=this.profile?.dateOfBirth;let s=null,i=!1;if(a){const r=new Date(a);if(!Number.isNaN(r.getTime())){const n="number"==typeof t?new Date(t,11,31):new Date;let a=n.getFullYear()-r.getFullYear();const l=n.getMonth()-r.getMonth();(l<0||0===l&&n.getDate()<r.getDate())&&(a-=1),s=a;const o="number"!=typeof e.minAge||s>=e.minAge,d="number"!=typeof e.maxAge||s<=e.maxAge;i=o&&d}}const l={type:"age_requirement",isMet:i,minAge:e.minAge,...null!=e.maxAge?{maxAge:e.maxAge}:{},...null!=s?{age:s}:{},description:e.description};r.push(l),i||n.push(l)}}),{allMet:0===n.length,items:r,missingItems:n}}getUnlockedYear(e){const t=this.profile.unlockedMedals?.find(t=>t.medalId===e);return t?t.year?t.year:t.unlockedDate?new Date(t.unlockedDate).getFullYear():null:null}getMostRecentAchievementYear(){const e=this.profile.prerequisites||[];return e.length?e.reduce((e,t)=>Math.max(e,t.year||e),0):null}getSameTypePrereqMedalIds(e){const t=e?.type;return t?(e?.prerequisites||[]).filter(e=>"medal"===e?.type).map(e=>e.medalId).filter(e=>{const r=this.medals.getMedalById(e);return r&&r.type===t}):[]}getEarliestCountingYearForMedal(e){const t=this.getSameTypePrereqMedalIds(e).map(e=>this.getUnlockedYear(e)).filter(e=>"number"==typeof e);return t.length?Math.max(...t)+1:null}getMinimalUnlockYearForSustained(e){if(!e)return null;const t=(e.requirements||[]).find(e=>"sustained_achievement"===e?.type);if(!t)return null;const r=Number.isFinite(t?.yearsOfAchievement)?t.yearsOfAchievement:1,n=this.getSameTypePrereqMedalIds(e).map(e=>this.getUnlockedYear(e)).filter(e=>"number"==typeof e);if(!n.length)return null;return Math.max(...n)+r}getAllAchievementYears(){const e=this.profile.prerequisites||[],t=new Set;for(const r of e){const e=Number(r.year);Number.isNaN(e)||t.add(e)}return Array.from(t).sort((e,t)=>e-t)}requirementsMetInYear(e,t,r={}){const n="string"==typeof e?this.medals.getMedalById(e):e;if(!n)return!1;return this.checkRequirements(n,{...r,endYear:t}).allMet}checkRequirements(e,t={}){const r=e.requirements;if(!r||Array.isArray(r)&&0===r.length)return{allMet:!0,items:[],unlockYear:null,tree:{node:"and",isMet:!0,children:[]}};const n=this.normalizeRequirementSpec(r),a=r=>this.evaluateReqNode(n,e,{...t,endYear:r});if("number"==typeof t.endYear){const e=a(t.endYear),r=!!e.isMet;return{allMet:r,items:this.flattenLeaves(e),unlockYear:r?t.endYear:null,tree:e}}const s=this.getCandidateYearsForTree();for(const l of s){const e=a(l);if(e.isMet)return{allMet:!0,items:this.flattenLeaves(e),unlockYear:l,tree:e}}const i=this.evaluateReqNode(n,e,t);return{allMet:!1,items:this.flattenLeaves(i),unlockYear:null,tree:i}}checkPrecisionSeriesRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type);if(null==r.endYear)return{type:"precision_series",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};let a=n;const s=e.timeWindowYears;if(1===s)a=n.filter(e=>e.year===r.endYear);else if("number"==typeof s&&s>1){const e=r.endYear-s+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);a=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else a=n.filter(e=>e.year===r.endYear);const i=this.filterByPrecisionSeriesThreshold(a,e),l=e.minAchievements??1,o={current:i.length,required:l},d=o.current>=l;return{type:"precision_series",index:t,isMet:d,progress:o,description:e.description,pointThresholds:{A:e.pointThresholds?.A?.min,B:e.pointThresholds?.B?.min,C:e.pointThresholds?.C?.min,R:e.pointThresholds?.R?.min},windowYear:d?r.endYear:null}}checkApplicationSeriesRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"application_series"===e.type);if(null==r.endYear)return{type:"application_series",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};let a=n;const s=e.timeWindowYears;if(1===s)a=n.filter(e=>e.year===r.endYear);else if("number"==typeof s&&s>1){const e=r.endYear-s+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);a=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else a=n.filter(e=>e.year===r.endYear);const i=a.filter(t=>{const r=t.weaponGroup||"A",n=e.thresholds?.[r];if(!n)return!1;const a="number"==typeof t.timeSeconds&&t.timeSeconds>0,s="number"==typeof t.hits&&t.hits>=0,i="number"!=typeof n.maxTimeSeconds||t.timeSeconds<=n.maxTimeSeconds,l="number"!=typeof n.minHits||t.hits>=n.minHits;return a&&s&&i&&l}),l=e.minAchievements??1,o={current:i.length,required:l},d=o.current>=l;return{type:"application_series",index:t,isMet:d,progress:o,description:e.description,windowYear:d?r.endYear:null}}checkRunningShootingCourseRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"running_shooting_course"===e.type),a=r&&"number"==typeof r.endYear?r.endYear:null;if(null==a)return{type:"running_shooting_course",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};const s=this.profile?.sex;if("male"!==s&&"female"!==s)throw new Error("Profile sex is required for running_shooting_course requirements");const i=this.getAgeAtYear(a);if(null==i)throw new Error("Profile dateOfBirth is required for running_shooting_course requirements");const l=(()=>{const t=Array.isArray(e.ageCategories)?e.ageCategories:[];return t.length&&t.find(e=>{const t="number"==typeof e.ageMin?e.ageMin:0,r="number"==typeof e.ageMax?e.ageMax:999;return i>=t&&i<=r})||null})(),o=(l?.maxPoints&&"object"==typeof l.maxPoints?l.maxPoints[s]:void 0)??(e?.maxPoints&&"object"==typeof e.maxPoints?e.maxPoints[s]:void 0);if(!Number.isFinite(o))throw new Error("running_shooting_course requirement is missing maxPoints for profile sex");let d=n;const c=e.timeWindowYears;if(1===c)d=n.filter(e=>e.year===a);else if("number"==typeof c&&c>1){const e=a-c+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);d=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=a)}else d=n.filter(e=>e.year===a);const u=d.filter(e=>"number"==typeof e.points&&Number.isFinite(e.points)&&e.points<=o),m=e.minAchievements??1,p={current:u.length,required:m},h=p.current>=m;return{type:"running_shooting_course",index:t,isMet:h,progress:p,description:e.description,windowYear:h?a:null,maxPoints:o,sex:s,age:i,...l?.name?{ageCategory:l.name}:{}}}filterByPrecisionSeriesThreshold(e,t){const r={A:t.pointThresholds?.A?.min??0,B:t.pointThresholds?.B?.min??0,C:t.pointThresholds?.C?.min??0,R:t.pointThresholds?.R?.min??0};return(e||[]).filter(e=>{const t=e.weaponGroup||"A",n=r[t];return"number"==typeof e.points&&e.points>=n})}groupBy(e,t){return(e||[]).reduce((e,r)=>{const n=t(r);return e[n]=e[n]||[],e[n].push(r),e},{})}normalizeRequirementSpec(e){return Array.isArray(e)?{op:"and",children:e.map(e=>this.normalizeRequirementSpec(e))}:e&&"object"==typeof e?Array.isArray(e.and)?{op:"and",children:e.and.map(e=>this.normalizeRequirementSpec(e))}:Array.isArray(e.or)?{op:"or",children:e.or.map(e=>this.normalizeRequirementSpec(e))}:{op:"leaf",req:e}:{op:"leaf",req:{}}}evaluateReqNode(e,t,r={}){if(!e)return{node:"leaf",isMet:!1,leaf:{type:"unknown",index:-1,isMet:!1}};if("and"===e.op){const n=e.children?.map(e=>this.evaluateReqNode(e,t,r))||[];return{node:"and",isMet:n.every(e=>e.isMet),children:n}}if("or"===e.op){const n=e.children?.map(e=>this.evaluateReqNode(e,t,r))||[];return{node:"or",isMet:n.some(e=>e.isMet),children:n}}const n=e.req||{};let a;switch(n.type){case"precision_series":a=this.checkPrecisionSeriesRequirement(n,-1,r);break;case"application_series":a=this.checkApplicationSeriesRequirement(n,-1,r);break;case"running_shooting_course":a=this.checkRunningShootingCourseRequirement(n,-1,r);break;case"sustained_achievement":a=this.checkSustainedAchievementRequirement(n,-1,t,r);break;case"cumulative_competition_score":a=this.checkCumulativeCompetitionScoreRequirement(n,-1,r);break;case"standard_medal":a=this.checkStandardMedalRequirement(n,-1,r);break;case"sustained_reference":a=this.checkSustainedReferenceRequirement(n,-1,t,r);break;case"custom_criterion":a=this.checkCustomCriterionRequirement(n,-1,r);break;case"shooting_round":a=this.checkShootingRoundRequirement(n,-1,r);break;case"speed_shooting_series":a=this.checkSpeedShootingSeriesRequirement(n,-1,r);break;case"competition_performance":a=this.checkCompetitionPerformanceRequirement(n,-1,r);break;case"air_pistol_precision":a=this.checkAirPistolPrecisionRequirement(n,-1,r);break;default:a={type:n.type,index:-1,isMet:!1,reason:"unsupported_requirement_type",description:n.description}}return{node:"leaf",isMet:!!a.isMet,leaf:a}}flattenLeaves(e,t=[]){if(!e)return t;if("leaf"===e.node)return t.push(e.leaf),t;for(const r of e.children||[])this.flattenLeaves(r,t);return t}getCandidateYearsForTree(){const e=new Set(this.getAllAchievementYears()),t=(new Date).getFullYear();return e.add(t),Array.from(e).sort((e,t)=>t-e)}getAgeAtYear(e){const t=this.profile?.dateOfBirth;if(!t)return null;const r=new Date(t);if(Number.isNaN(r.getTime()))return null;const n=new Date(e,11,31);let a=n.getFullYear()-r.getFullYear();const s=n.getMonth()-r.getMonth();return(s<0||0===s&&n.getDate()<r.getDate())&&(a-=1),a}resolveSustainedReferences(e,t,r){const n=e?.references??t?.references,a=e=>(e||[]).map(e=>"string"==typeof e?{medalId:e}:e).filter(e=>e&&e.medalId);if(Array.isArray(n)){const e=a(n);if(0===e.length)throw new Error("sustained_achievement.references must list at least one medalId");return e}if(n&&"object"==typeof n){const e=Array.isArray(n.when)?n.when:null;let t=null;if(e){const n=this.getAgeAtYear(r);for(const r of e){if(!r||"object"!=typeof r)continue;const e=r.if||{};let a=!0;if(e&&Object.prototype.hasOwnProperty.call(e,"age")){const t=e.age||{};null==n?a=!1:(null==t.gte||n>=t.gte||(a=!1),null==t.gt||n>t.gt||(a=!1),null==t.lte||n<=t.lte||(a=!1),null==t.lt||n<t.lt||(a=!1),null!=t.eq&&n!==t.eq&&(a=!1))}else a=!1;if(a){t=r.refs;break}}}if(!t&&n.otherwise&&(t=n.otherwise),t){const e=a(t);if(0===e.length)throw new Error("sustained_achievement.references rule must provide at least one medalId");return e}}else if(null!=n)throw new Error("Invalid sustained_achievement.references: expected array or object");return this.getSameTypePrereqMedalIds(t).map(e=>({medalId:e}))}checkSustainedReferenceRequirement(e,t,r,n={}){const a=n&&"number"==typeof n.endYear?n.endYear:null;if(null==a)return{type:"sustained_reference",index:t,isMet:!1,description:e.description,windowYear:null,reason:"end_year_required"};const s=this.resolveSustainedReferences(e,r,a);if(!Array.isArray(s)||0===s.length)throw new Error("sustained_reference.references must resolve to at least one medalId");const i=Number.isFinite(n.minStartYear)?{minStartYear:n.minStartYear}:{},l=s.every(e=>this.requirementsMetInYear(e.medalId,a,i));return{type:"sustained_reference",index:t,isMet:l,description:e.description,windowYear:l?a:null}}checkSustainedAchievementRequirement(e,t,r,n={}){const a=e.yearsOfAchievement??3,s=!0===this.profile?.features?.enforceCurrentYearForSustained,i=s?(new Date).getFullYear():n&&"number"==typeof n.endYear?n.endYear:(new Date).getFullYear();if(e&&e.perYear){const a=this.getEarliestCountingYearForMedal(r);let l=!0===e.mustIncludeCurrentYear;s&&(l=!0);let o=this.getAllAchievementYears();o.includes(i)||o.push(i),o=o.sort((e,t)=>e-t),"number"==typeof a&&(o=o.filter(e=>e>=a)),l&&(o=o.filter(e=>e<=i));const d=this.normalizeRequirementSpec(e.perYear),c="number"==typeof a?{minStartYear:a}:{},u=o.filter(e=>!!this.evaluateReqNode(d,r,{...n,endYear:e,...c}).isMet),m=new Set(u);let p,h,f=null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){let t=o;l&&o.includes(i)&&(t=[i]);let r=null,n=0;for(const a of t){let t=0;for(let r=a-e.timeWindowYears+1;r<=a;r++)m.has(r)&&t++;t>n&&(n=t,r=a)}p={current:n,required:e.yearsOfAchievement??1},h=n>=(e.yearsOfAchievement??1),f=h?r:null}else{const t=m.size;p={current:t,required:e.yearsOfAchievement??1},h=t>=(e.yearsOfAchievement??1),h&&l&&!m.has(i)&&(h=!1)}const x=h?f??i:i,b=this.evaluateReqNode(d,r,{...n,endYear:x,...c});return{type:"sustained_achievement",index:t,isMet:h,progress:p,description:e.description,windowYear:f,subtree:b,subtreeYear:x}}const l=this.resolveSustainedReferences(e,r,i),o=this.getEarliestCountingYearForMedal(r);let d,c,u=!0===e.mustIncludeCurrentYear||!0===r?.mustIncludeCurrentYear||l&&l.length>0;if(s&&(u=!0),l.length>0)d=this.getAllAchievementYears();else{const e=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type),t=this.groupBy(e,e=>e.year);d=Object.keys(t).map(e=>Number(e)).filter(e=>!Number.isNaN(e)).sort((e,t)=>e-t)}if("number"==typeof o&&(d=d.filter(e=>e>=o)),u&&(d=d.filter(e=>e<=i)),l.length>0){const e=e=>l.every(t=>this.requirementsMetInYear(t.medalId,e,"number"==typeof o?{minStartYear:o}:{}));c=new Set(d.filter(e))}else{const t=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type),r=this.groupBy(t,e=>e.year),n=e.minPointsPerYear??0,a=t=>(t||[]).some(t=>{const r=t.weaponGroup||"A",a=e.pointThresholds?.[r]?.min??n;return"number"==typeof t.points&&t.points>=a});c=new Set(d.filter(e=>a(r[e])))}let m,p,h=null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){let t=d;u&&d.includes(i)&&(t=[i]);let r=null,n=0;for(const a of t){let t=0;for(let r=a-e.timeWindowYears+1;r<=a;r++)c.has(r)&&t++;t>n&&(n=t,r=a)}m={current:n,required:a},p=n>=a,h=p?r:null}else{const e=c.size;m={current:e,required:a},p=e>=a,p&&u&&!c.has(i)&&(p=!1)}return{type:"sustained_achievement",index:t,isMet:p,progress:m,description:e.description,windowYear:h}}checkCustomCriterionRequirement(e,t,r={}){const n=r&&"number"==typeof r.endYear?r.endYear:null,a=re.get(e.name);if(!a)return{type:"custom_criterion",index:t,isMet:!1,description:e.description,reason:"unknown_custom_criterion"};try{const s=a({profile:this.profile,medalsDb:this.medals,endYear:n,minStartYear:Number.isFinite(r.minStartYear)?r.minStartYear:void 0,params:e.params??{}}),i=!(!s||!("object"==typeof s?s.isMet:s));return{type:"custom_criterion",index:t,isMet:i,description:e.description,windowYear:i&&null!=n?n:null}}catch(s){return{type:"custom_criterion",index:t,isMet:!1,description:e.description,error:s?.message}}}checkStandardMedalRequirement(e,t,r={}){let n=(this.profile.prerequisites||[]).filter(e=>"standard_medal"===e.type);e.disciplineType&&(n=n.filter(t=>t.disciplineType===e.disciplineType)),e.medalTier&&(n=n.filter(t=>t.medalType===e.medalTier));const a=r&&"number"==typeof r.endYear?r.endYear:null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){const t=null!=a?a:(new Date).getFullYear(),s=t-e.timeWindowYears+1,i=Math.max(s,Number.isFinite(r.minStartYear)?r.minStartYear:s);n=n.filter(e=>(e.year??0)>=i&&(e.year??0)<=t)}else null!=a&&(n=n.filter(e=>e.year===a));const s=e.minAchievements??1,i={current:n.length,required:s},l=i.current>=s;return{type:"standard_medal",index:t,isMet:l,progress:i,description:e.description,windowYear:l&&null!=a?a:null}}checkCumulativeCompetitionScoreRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"competition_result"===e.type),a=r&&"number"==typeof r.endYear?r.endYear:null;if(null==a)return{type:"cumulative_competition_score",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};const s=e.minCompetitions??1,i=(t=>{let a=(t=>{let r=(t||[]).filter(t=>t.disciplineType===e.disciplineType);return e.competitionType&&(r=r.filter(t=>t.competitionType===e.competitionType)),r})(n);if(null!=t)if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){const n=t-e.timeWindowYears+1,s=Math.max(n,Number.isFinite(r.minStartYear)?r.minStartYear:n);a=a.filter(e=>(e.year??0)>=s&&(e.year??0)<=t)}else a=a.filter(e=>e.year===t);let s=[];return s="ppc"===e.disciplineType?a.filter(t=>{const r=t.ppcClass,n=e.pointThreshold?.[r]?.min;return"number"==typeof t.score&&"number"==typeof n&&t.score>=n}):e.seriesBasedThresholds?a.filter(t=>{if(e.competitionType&&t.competitionType!==e.competitionType)return!1;const r=String(t.seriesCount||""),n=t.weaponGroup||"A",a=e.seriesBasedThresholds[r];if(!a)return!1;const s=a[n]?.min;return"number"==typeof t.score&&"number"==typeof s&&t.score>=s}):a.filter(t=>{const r=t.weaponGroup||"A",n=e.pointThresholds?.[r]?.min;return"number"==typeof t.score&&"number"==typeof n&&t.score>=n}),s})(a),l=i.length>=s;return{type:"cumulative_competition_score",index:t,isMet:l,progress:{current:i.length,required:s},description:e.description,windowYear:l?a:null}}checkShootingRoundRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"shooting_round"===e.type),a=r&&"number"==typeof r.endYear?r.endYear:null;if(null==a)return{type:"shooting_round",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};let s=n;const i=e.timeWindowYears;if(1===i)s=n.filter(e=>e.year===a);else if("number"==typeof i&&i>1){const e=a-i+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);s=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=a)}else s=n.filter(e=>e.year===a);const l=s.filter(t=>{const r=t.weaponGroup||"A",n=e.totalPointThresholds?.[r]?.min;return"number"==typeof t.totalPoints&&"number"==typeof n&&t.totalPoints>=n}),o=e.minAchievements??1,d={current:l.length,required:o},c=d.current>=o;return{type:"shooting_round",index:t,isMet:c,progress:d,description:e.description,windowYear:c?a:null,totalPointThresholds:e.totalPointThresholds}}checkSpeedShootingSeriesRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"speed_shooting_series"===e.type);if(null==r.endYear)return{type:"speed_shooting_series",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};let a=n;const s=e.timeWindowYears;if(1===s)a=n.filter(e=>e.year===r.endYear);else if("number"==typeof s&&s>1){const e=r.endYear-s+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);a=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else a=n.filter(e=>e.year===r.endYear);const i=this.filterBySpeedShootingThreshold(a,e),l=e.minAchievements??1,o={current:i.length,required:l},d=o.current>=l;return{type:"speed_shooting_series",index:t,isMet:d,progress:o,description:e.description,windowYear:d?r.endYear:null,pointThresholds:{A:e.pointThresholds?.A?.min,B:e.pointThresholds?.B?.min,C:e.pointThresholds?.C?.min,R:e.pointThresholds?.R?.min}}}checkCompetitionPerformanceRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"competition_performance"===e.type);if(null==r.endYear)return{type:"competition_performance",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};let a=n;const s=e.timeWindowYears;if(1===s)a=n.filter(e=>e.year===r.endYear);else if("number"==typeof s&&s>1){const e=r.endYear-s+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);a=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else a=n.filter(e=>e.year===r.endYear);const i=this.filterByCompetitionPerformanceThreshold(a,e),l=e.minCompetitions??e.minAchievements??1,o={current:i.length,required:l},d=o.current>=l;return{type:"competition_performance",index:t,isMet:d,progress:o,description:e.description,windowYear:d?r.endYear:null,disciplineType:e.disciplineType}}checkAirPistolPrecisionRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"air_pistol_precision"===e.type);if(null==r.endYear)return{type:"air_pistol_precision",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};let a=n;const s=e.timeWindowYears;if(1===s)a=n.filter(e=>e.year===r.endYear);else if("number"==typeof s&&s>1){const e=r.endYear-s+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);a=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else a=n.filter(e=>e.year===r.endYear);const i=this.filterByAirPistolThreshold(a,e),l=e.minSeries??e.minAchievements??1,o={current:i.length,required:l},d=o.current>=l;return{type:"air_pistol_precision",index:t,isMet:d,progress:o,description:e.description,windowYear:d?r.endYear:null,minPointsPerSeries:e.minPointsPerSeries}}filterByCompetitionPerformanceThreshold(e,t){return(e||[]).filter(e=>{if(t.disciplineType&&e.disciplineType!==t.disciplineType)return!1;if(t.maxPoints){const r=this.profile.sex||"male",n=t.maxPoints[r];return"number"==typeof n&&"number"==typeof e.points&&e.points<=n}if(t.pointThresholdPercent){const r=e.weaponGroup||"A",n=t.pointThresholdPercent[r]?.min??0;if("number"==typeof e.scorePercent)return e.scorePercent>=n;if("number"==typeof e.score&&"number"==typeof e.maxScore&&e.maxScore>0){return e.score/e.maxScore*100>=n}return!1}return!0})}filterByAirPistolThreshold(e,t){const r=t.minPointsPerSeries??0;return(e||[]).filter(e=>"number"==typeof e.points&&e.points>=r)}filterBySpeedShootingThreshold(e,t){const r={A:t.pointThresholds?.A?.min??0,B:t.pointThresholds?.B?.min??0,C:t.pointThresholds?.C?.min??0,R:t.pointThresholds?.R?.min??0};return(e||[]).filter(e=>{const t=e.weaponGroup||"A",n=r[t];return"number"==typeof e.points&&e.points>=n})}evaluateAllMedals(){const e=this.medals.getAllMedals(),t={unlocked:[],eligible:[],available:[],locked:[]};return e.forEach(e=>{const r=this.evaluateMedal(e.id);t[r.status].push(r)}),t}getEligibleYears(e){if(this.hasUnlockedMedal(e))return[];const t=this.getAllAchievementYears().sort((e,t)=>t-e),r=[];for(const n of t)try{const t=this.evaluateMedal(e,{endYear:n});t&&"eligible"===t.status&&r.push(n)}catch{}return r}}function ae(){const e=t.useContext(_);if(e===I)throw new Error("useMedalDatabase must be used within MedalProvider");return e}function se(){const e=t.useContext(F);if(!e)throw new Error("useProfile must be used within ProfileProvider");return e}function ie(){const{medalDatabase:e}=ae(),{currentProfile:r}=se();return t.useMemo(()=>{if(!e)return null;return new ne(e,r??{unlockedMedals:[],prerequisites:[]})},[e,r])}function le(){const e=ie();return t.useMemo(()=>e?e.evaluateAllMedals():{unlocked:[],eligible:[],available:[],locked:[]},[e])}function oe({children:e}){const t=ie(),n=le();return r.jsx(te.Provider,{value:{calculator:t,allStatuses:n},children:e})}const de=t.createContext(null);function ce({children:e}){const[n,a]=t.useState([]),[s,i]=t.useState(-1),l=t.useCallback(e=>{a(t=>{const r=t.slice(0,s+1);r.push(e);const n=r.length>200?r.slice(r.length-200):r;return i(n.length-1),n})},[s]),o=t.useCallback(()=>{let e=null;return i(t=>{const r=t>0?t-1:t;return e=r!==t?r:null,r}),e},[]),d=t.useCallback(()=>{let e=null;return i(t=>{const r=t<n.length-1?t+1:t;return e=r!==t?r:null,r}),e},[n.length]),c=s>0,u=s>=0&&s<n.length-1,m=t.useMemo(()=>({pushState:l,undo:o,redo:d,canUndo:c,canRedo:u,history:n,historyIndex:s}),[l,o,d,c,u,n,s]);return r.jsx(de.Provider,{value:m,children:e})}const ue={achievementEntry:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"Registrering av prestationer är under utveckling. Gränssnitt och beteende kan ändras."},historyTimeline:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"Historiköversikten är under utveckling. Funktioner kan saknas."},enforceCurrentYearSetting:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"Inställningen är under utveckling.",overlay:"inline"},csvImport:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"CSV-import/export är under utveckling. Gränssnittet kan ändras och vissa funktioner saknas."}},me=t.createContext(null);function pe(e){try{localStorage.setItem("ff:overrides",JSON.stringify(e||{}))}catch{}}function he({children:e}){const n=function(){const e="undefined"!=typeof window&&window.location&&window.location.hostname?window.location.hostname:"";return"localhost"===e||"127.0.0.1"===e?"development":"production"}(),[a,s]=t.useState(()=>"undefined"!=typeof window?function(){try{return JSON.parse(localStorage.getItem("ff:overrides")||"{}")}catch{return{}}}():{}),i=t.useContext(F),l=i?.currentProfile,o=i?.updateProfile,d=t.useMemo(()=>l?.features?.featureFlags||{},[l]),c=t.useMemo(()=>{const e="undefined"!=typeof window?function(){try{const e=new URLSearchParams(window.location.search).get("ff");return e?e.split(",").reduce((e,t)=>{const[r,n]=t.split(":");return r&&n&&(e[r.trim()]=n.trim()),e},{}):{}}catch{return{}}}():{},t={};for(const[r,a]of Object.entries(ue||{})){const e=a?.default||"off",s=a?.env?.[n]??e;t[r]=s}for(const[r,n]of Object.entries(a||{}))t[r]=n;for(const[r,n]of Object.entries(d||{}))t[r]=n;for(const[r,n]of Object.entries(e||{}))t[r]=n;return t},[n,a,d]),u=e=>{const t={...a||{},...e||{}};s(t),pe(t)},m={get:e=>c[e]||"off",enabled(e){const t=c[e]||"off";return"on"===t||"preview"===t},all:()=>({...c}),set(e,t){u({[e]:t})},setMany(e){u(e)},clear(e){const t={...a||{}};delete t[e],s(t),pe(t)},clearAll(){s({}),pe({})},async saveToProfile(e){if(!o||!l)return!1;const t={...l.features||{},featureFlags:{...e||{}}};return await o({...l,features:t}),!0},async clearProfileOverrides(){if(!o||!l)return!1;const e={...l.features||{}};return delete e.featureFlags,await o({...l,features:e}),!0}};return r.jsx(me.Provider,{value:m,children:e})}const fe=t.createContext(null),xe={version:"pr-143-3969dd3",number:"137",commit:"3969dd3",timeISO:"2026-01-10T05:49:38.144Z"},be="app:onboardingTour:seen:",ge="app:onboardingTour:manualStart",ye={medals:"v1","tree-view":"v1"};function ve(e="medals"){return`${e}-${ye[e]||"v1"}`}function je(e){try{return sessionStorage.setItem(ge,e),!0}catch{return!1}}const we={medals:[{id:"welcome",title:"Snabbguide",body:"Sök, filtrera och öppna detaljer för att se krav och status.",target:null},{id:"search",title:"Sök",body:"Skriv för att filtrera märken.",target:'[data-tour="medals-search"]'},{id:"chips",title:"Snabbfilter",body:"Tryck på en status för att filtrera snabbt.",target:'[data-tour="chip-unlocked"]'},{id:"filters",title:"Fler filter",body:"Öppna filterpanelen för fler val.",target:'[data-tour="open-filters"], [data-tour="filter-panel"]'},{id:"open",title:"Öppna ett märke",body:"Tryck på ett märke i listan för att se detaljer. Lämna guiden öppen och tryck sedan Nästa.",target:'[data-tour="medal-row-0"]',requiresTarget:!0,autoAdvanceToNextOn:'[data-tour="medal-detail-panel"]'},{id:"detail",title:"Detaljer",body:"När detaljvyn är öppen ser du krav, förhandskrav och status. Tryck Nästa för att avsluta.",target:'[data-tour="medal-detail-panel"]',requiresTarget:!0}],"tree-view":[{id:"welcome",title:"Välkommen till trädvyn",body:"Se alla märken i ett interaktivt träd med kopplingar och progression.",target:null},{id:"canvas",title:"Interaktiv canvas",body:"Dra för att panorera, nyp eller använd zoomknapparna för att zooma.",target:'[data-tour="tree-canvas"]'},{id:"zoom",title:"Zoomkontroller",body:"Använd dessa knappar för att zooma in, ut eller återställa vyn.",target:'[data-tour="zoom-controls"]'},{id:"legend",title:"Teckenförklaring",body:"Färgerna visar status: grönt för upplåsta, gult för uppnåeliga, grått för låsta.",target:'[data-tour="tree-legend"]'},{id:"actions",title:"Åtgärdsmeny",body:"Här hittar du fler alternativ: exportera, växla visualisering och öppna helskärm.",target:'[data-tour="tree-actions"]'},{id:"node",title:"Klicka på märken",body:"Tryck på ett märke i trädet för att se detaljer. Årsbrickor visar hur många år som krävs.",target:'[data-tour="tree-canvas"]'}]};function Ne({children:e}){const[n,a]=t.useState(!1),[s,i]=t.useState(0),[l,o]=t.useState("medals"),d=ve(l),c=we[l]||we.medals,u=t.useCallback((e="medals")=>{o(e),i(0),a(!0)},[]),m=t.useCallback(()=>{a(!1)},[]),p=t.useCallback(()=>{!function(e){try{e&&localStorage.setItem(be+e,"true")}catch{}}(d),a(!1)},[d]),h=t.useCallback(()=>{i(e=>e>=c.length-1?e:e+1)},[c.length]),f=t.useCallback(()=>{i(e=>Math.max(0,e-1))},[]),x=t.useCallback((e="medals")=>!function(e=ve()){try{return"true"===localStorage.getItem(be+e)}catch{return!1}}(ve(e)),[]),b=t.useMemo(()=>({open:n,stepIndex:s,steps:c,start:u,close:m,complete:p,next:h,back:f,canAutoStart:x,tourId:d,currentTourType:l}),[n,s,c,u,m,p,h,f,x,d,l]);return r.jsx(fe.Provider,{value:b,children:e})}function ke({id:e,title:n,open:a,onClose:s,swipeToDismiss:i=!0,children:l}){const o=t.useRef(null),d=t.useRef(null);t.useEffect(()=>{if(!a)return;d.current=document.activeElement;const e=o.current,t=e=>{"Escape"===e.key&&(e.stopPropagation(),s?.())},r=t=>{if("Tab"!==t.key)return;if(!e)return;const r=e.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])'),n=Array.from(r).filter(e=>!e.hasAttribute("disabled")&&"true"!==e.getAttribute("aria-hidden"));if(0===n.length)return;const a=n[0],s=n[n.length-1];t.shiftKey&&document.activeElement===a?(t.preventDefault(),s.focus()):t.shiftKey||document.activeElement!==s||(t.preventDefault(),a.focus())};document.addEventListener("keydown",t),e?.addEventListener("keydown",r);const n=setTimeout(()=>e?.focus(),0);return()=>{document.removeEventListener("keydown",t),e?.removeEventListener("keydown",r),clearTimeout(n),d.current&&"function"==typeof d.current.focus&&d.current.focus()}},[a,s]);const c=function({onSwipe:e,threshold:r=50,allowedDirections:n=["left","right","up","down"]}={}){const a=t.useRef({x:0,y:0,t:0}),s=t.useRef({x:0,y:0,t:0});return{onTouchStart:e=>{if(!e.touches||0===e.touches.length)return;const t=e.touches[0];a.current={x:t.clientX,y:t.clientY,t:Date.now()},s.current={x:t.clientX,y:t.clientY,t:Date.now()}},onTouchMove:e=>{if(!e.touches||0===e.touches.length)return;const t=e.touches[0];s.current={x:t.clientX,y:t.clientY,t:Date.now()}},onTouchEnd:()=>{const t=s.current.x-a.current.x,i=s.current.y-a.current.y,l=Math.abs(t),o=Math.abs(i);let d=null;l>o?l>=r&&(d=t>0?"right":"left"):o>=r&&(d=i>0?"down":"up"),d&&n.includes(d)&&e?.(d)}}}({onSwipe:e=>{!i||"down"!==e&&"right"!==e||s?.()}});return a?r.jsxs("div",{"aria-hidden":!a,className:"fixed inset-0 z-[80]",children:[r.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>s?.(),"aria-hidden":!0}),r.jsxs("div",{id:e,role:"dialog","aria-modal":"true","aria-labelledby":e?`${e}-title`:void 0,ref:o,tabIndex:-1,className:"absolute left-0 right-0 bottom-0 bg-bg-secondary text-foreground rounded-t-2xl shadow-2xl border-t border-border focus:outline-none",style:{transform:"translateY(0)",transition:"undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches?"none":"transform 200ms ease",maxHeight:"85dvh",WebkitOverflowScrolling:"touch"},...c,children:[r.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[r.jsx("h2",{id:e?`${e}-title`:void 0,className:"text-lg font-semibold",children:n}),r.jsx("button",{type:"button",className:"btn btn-muted h-11 w-11 inline-flex items-center justify-center",onClick:()=>s?.(),"aria-label":"Close",children:"✕"})]}),r.jsx("div",{className:"p-4 pb-[calc(env(safe-area-inset-bottom)+1rem)] overflow-auto",style:{maxHeight:"calc(85dvh - 56px)",overflowY:"auto",overscrollBehavior:"contain"},children:l})]})]}):null}function Se({name:e,className:t="w-4 h-4",...s}){const i=n[e]||a;return r.jsx(i,{"aria-hidden":"true",focusable:"false",className:t,...s})}function Ce({backup:e,onRestore:n,onCancel:a}){const{metadata:i,validation:l}=t.useMemo(()=>{const t=e.exportedAt||e.profile?.lastModified||e.profile?.createdDate,r=e.version||"1.0",n=e.profile?.prerequisites?.length||0,a=e.profile?.unlockedMedals?.length||0,s=function(e){const t=[];return e&&"object"==typeof e?"profile-backup"!==e.kind?{status:"error",warnings:["Inte en giltig säkerhetskopia"],canImport:!1}:e.profile&&"object"==typeof e.profile?(e.exportedAt||t.push("Datum för säkerhetskopia saknas"),e.version||t.push("Formatversion saknas"),e.version&&"1.0"!==e.version&&t.push(`Okänd formatversion: ${e.version}`),e.profile.displayName||t.push("Profilnamn saknas"),e.profile.sex||t.push("Kön saknas i profilen"),0===t.length?{status:"valid",warnings:[],canImport:!0}:{status:"warning",warnings:t,canImport:!0}):{status:"error",warnings:["Profil saknas i säkerhetskopian"],canImport:!1}:{status:"error",warnings:["Ogiltig fil"],canImport:!1}}(e);return{metadata:{date:t,version:r,achievementCount:n,medalCount:a},validation:s}},[e]),o=r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 bg-black/50 z-[2000]",onClick:a,"aria-hidden":"true"}),r.jsxs("div",{role:"dialog","aria-modal":"true","aria-labelledby":"restore-preview-title",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"min(90vw, 32rem)",maxHeight:"90vh",overflow:"auto",zIndex:2001},className:"\n          bg-bg-primary\n          border-2 border-border\n          rounded-xl shadow-2xl\n          p-6\n        ",children:[r.jsx("h2",{id:"restore-preview-title",className:"text-2xl font-bold text-foreground mb-6",children:"Återställ från säkerhetskopia"}),r.jsxs("div",{className:"\n            mb-6 p-4 rounded-lg\n            bg-yellow-50 dark:bg-yellow-950\n            border-2 border-yellow-400 dark:border-yellow-600\n          ",role:"alert",children:[r.jsx("p",{className:"font-semibold text-yellow-800 dark:text-yellow-200 mb-1",children:"⚠️ Detta kommer att ersätta dina nuvarande data"}),r.jsx("p",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:"Se till att du har en säkerhetskopia av dina nuvarande framsteg innan du återställer."})]}),l.warnings.length>0&&r.jsxs("div",{className:"mb-6 p-4 rounded-lg bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800",role:"status","aria-live":"polite",children:[r.jsxs("div",{className:"flex items-start gap-2 mb-2",children:[r.jsx(Se,{name:"AlertTriangle",className:"w-5 h-5 shrink-0 text-blue-600 dark:text-blue-400 mt-0.5","aria-hidden":"true"}),r.jsx("h3",{className:"font-semibold text-blue-800 dark:text-blue-200",children:"Varningar vid import"})]}),r.jsx("ul",{className:"text-sm text-blue-700 dark:text-blue-300 space-y-1 ml-7",children:l.warnings.map((e,t)=>r.jsxs("li",{children:["• ",e]},t))}),r.jsx("p",{className:"text-sm text-blue-700 dark:text-blue-300 mt-3 ml-7",children:"Du kan fortfarande importera säkerhetskopian."})]}),r.jsxs("div",{className:"mb-6 space-y-3",children:[r.jsx("h3",{className:"font-semibold text-foreground mb-3",children:"Information om säkerhetskopia"}),r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Skapad"}),r.jsx("p",{className:"font-semibold text-foreground",children:i.date?new Date(i.date).toLocaleDateString("sv-SE",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Okänt datum"})]}),r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Format"}),r.jsxs("p",{className:"font-semibold text-foreground",children:["v",i.version]})]}),r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Aktiviteter"}),r.jsx("p",{className:"font-semibold text-foreground",children:i.achievementCount})]}),r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Upplåsta märken"}),r.jsx("p",{className:"font-semibold text-foreground",children:i.medalCount})]})]})]}),r.jsxs("div",{className:"flex gap-3",children:[r.jsx("button",{onClick:a,className:"\n              flex-1 py-3 rounded-lg font-medium\n              bg-bg-secondary text-foreground\n              border-2 border-border\n              hover:bg-bg-tertiary\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-border\n            ",children:"Avbryt"}),r.jsx("button",{onClick:n,className:"\n              flex-1 py-3 rounded-lg font-medium\n              bg-primary text-primary-foreground\n              hover:bg-primary/90\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-primary\n            ",children:"Återställ nu"})]})]})]});return s.createPortal(o,document.body)}function Me({id:e="profile-import-dialog",open:n,onClose:a}){const{restoreProfileFromBackup:s}=se(),[i,l]=t.useState(""),[o,d]=t.useState("new-id"),[c,u]=t.useState(null),[m,p]=t.useState(!1),[h,f]=t.useState(!1),[x,b]=t.useState(null),[g,y]=t.useState(null),[v,j]=t.useState(!1),[w,N]=t.useState(null),k=t.useRef(null);if(t.useEffect(()=>{if(!i.trim())return void y(null);const e=function(e){if(!e||!e.trim())return{status:"error",message:"Ingen data angiven"};try{const t=JSON.parse(e);return t&&"object"==typeof t?"profile-backup"!==t.kind?{status:"error",message:"Inte en säkerhetskopia"}:t.profile?t.exportedAt&&t.version&&t.profile.displayName?{status:"valid",message:"Giltig säkerhetskopia"}:{status:"warning",message:"Säkerhetskopia kan importeras med varningar"}:{status:"error",message:"Profil saknas"}:{status:"error",message:"Ogiltig JSON-struktur"}}catch{return{status:"error",message:"Ogiltig JSON"}}}(i);y(e)},[i]),t.useEffect(()=>{n||(N(null),l(""),y(null),j(!1))},[n]),!n)return null;return r.jsxs("div",{className:"fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4",children:[r.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":`${e}-title`,id:e,className:"w-[min(92vw,32rem)] max-h-[85vh] overflow-auto rounded-xl bg-bg-secondary border border-border shadow-2xl",children:r.jsxs("form",{onSubmit:async e=>{e.preventDefault();try{if(p(!0),u(null),!i.trim())return u("Klistra in JSON eller välj en fil."),void p(!1);const e=Y(i);b(e),f(!0),p(!1)}catch(t){u(t.message||"Kunde inte läsa säkerhetskopian"),p(!1)}},className:"p-6 space-y-5",children:[r.jsx("h2",{id:`${e}-title`,className:"text-2xl font-bold text-text-primary",children:"Importera profil (säkerhetskopia)"}),c&&r.jsx("div",{className:"alert alert-error",role:"alert","aria-live":"assertive",children:c}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",children:"Välj säkerhetskopia"}),r.jsx("p",{id:`${e}-file-hint`,className:"text-xs text-muted-foreground",children:"JSON-filer (.json eller .txt) accepteras"}),r.jsx("input",{ref:k,id:`${e}-file`,type:"file",accept:".json,.txt,application/json",onChange:e=>{const t=e.target.files?.[0];if(!t)return;N(t.name);const r=new FileReader;r.onload=()=>l(String(r.result||"")),r.readAsText(t)},className:"sr-only",disabled:m,"aria-describedby":`${e}-file-hint`}),r.jsxs("button",{type:"button",onClick:()=>{k.current?.click()},disabled:m,"aria-describedby":`${e}-file-hint`,className:"\n                w-full min-h-[44px] px-4 py-2\n                bg-bg-secondary border-2 border-border rounded-lg\n                hover:bg-bg-tertiary hover:border-primary\n                focus-visible:outline-none focus-visible:ring-2\n                focus-visible:ring-primary focus-visible:ring-offset-2\n                transition-colors\n                flex items-center gap-3\n                disabled:opacity-50 disabled:cursor-not-allowed\n              ",children:[r.jsx(Se,{name:"Upload",className:"w-5 h-5 text-muted-foreground","aria-hidden":"true"}),r.jsx("span",{className:"flex-1 text-left text-sm",children:w||"Välj fil att återställa från..."}),w&&r.jsx(Se,{name:"CheckCircle",className:"w-5 h-5 text-green-600 dark:text-green-400","aria-hidden":"true"})]})]}),r.jsxs("button",{type:"button",onClick:()=>j(!v),className:"text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 transition-colors",disabled:m,children:[r.jsx(Se,{name:v?"ChevronDown":"ChevronRight",className:"w-4 h-4","aria-hidden":"true"}),r.jsx("span",{children:v?"Dölj avancerade alternativ":"Visa avancerade alternativ"})]}),v&&r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",htmlFor:`${e}-textarea`,children:"Klistra in JSON"}),r.jsx("textarea",{id:`${e}-textarea`,value:i,onChange:e=>l(e.target.value),className:"textarea min-h-[8rem]",placeholder:"Klistra in JSON-innehållet från din säkerhetskopia här...",disabled:m,"aria-describedby":g?`${e}-validation-status`:void 0}),g&&r.jsxs("div",{id:`${e}-validation-status`,role:"status","aria-live":"polite",className:`\n                  flex items-start gap-2 p-3 rounded-lg text-sm\n                  ${"valid"===g.status?"bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800":""}\n                  ${"warning"===g.status?"bg-yellow-50 dark:bg-yellow-950 border border-yellow-200 dark:border-yellow-800":""}\n                  ${"error"===g.status?"bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-800":""}\n                `,children:[r.jsx(Se,{name:"valid"===g.status?"CheckCircle":"warning"===g.status?"AlertTriangle":"XCircle",className:`\n                    w-5 h-5 shrink-0 mt-0.5\n                    ${"valid"===g.status?"text-green-600 dark:text-green-400":""}\n                    ${"warning"===g.status?"text-yellow-600 dark:text-yellow-400":""}\n                    ${"error"===g.status?"text-red-600 dark:text-red-400":""}\n                  `,"aria-hidden":"true"}),r.jsx("span",{className:`\n                    ${"valid"===g.status?"text-green-800 dark:text-green-200":""}\n                    ${"warning"===g.status?"text-yellow-800 dark:text-yellow-200":""}\n                    ${"error"===g.status?"text-red-800 dark:text-red-200":""}\n                  `,children:g.message})]})]}),r.jsxs("fieldset",{className:"space-y-2",children:[r.jsx("legend",{className:"block text-sm font-medium text-text-secondary",children:"Metod"}),r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsxs("label",{className:"inline-flex items-center gap-2",children:[r.jsx("input",{type:"radio",name:`${e}-strategy`,value:"new-id",checked:"new-id"===o,onChange:()=>d("new-id"),disabled:m}),r.jsx("span",{children:"Skapa ny profil"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2",children:[r.jsx("input",{type:"radio",name:`${e}-strategy`,value:"overwrite",checked:"overwrite"===o,onChange:()=>d("overwrite"),disabled:m}),r.jsx("span",{children:"Ersätt profil med samma ID"})]})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3 pt-2",children:[r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px] disabled:opacity-50 order-1 sm:order-2",disabled:m||!i.trim()||"error"===g?.status,"aria-describedby":"error"===g?.status?`${e}-validation-status`:void 0,children:"Förhandsgranska"}),r.jsx("button",{type:"button",onClick:a,className:"btn btn-secondary min-h-[44px] order-2 sm:order-1",disabled:m,children:"Avbryt"})]})]})}),h&&x&&r.jsx(Ce,{backup:x,onRestore:async()=>{try{p(!0),u(null),await s(i,{strategy:o}),l(""),f(!1),b(null),a?.()}catch(e){u(e.message||"Import misslyckades"),f(!1)}finally{p(!1)}},onCancel:()=>{f(!1),b(null)}})]})}function Ae({mode:e="picker",open:n=!1,onClose:a,id:s="profile-picker",forceCreate:i=!1,convertGuest:l=!1}){const{profiles:o,currentProfile:d,loading:c,createProfile:u,updateProfile:m,selectProfile:p,deleteProfile:h,convertGuestToSaved:f,startExplorerMode:x}=se(),[b,g]=t.useState(!1),[y,v]=t.useState("create"),[j,w]=t.useState(null),[N,k]=t.useState(""),[S,C]=t.useState(""),[M,A]=t.useState(""),[T,P]=t.useState(!1),I="picker"===e,_=I&&n&&i,D=_?"create":y,F=_?null:j,q=async e=>{if(confirm("Är du säker? Det går inte att ångra."))try{await h(e)}catch(t){console.error("Misslyckades ta bort profil:",t)}},E=e=>{if(!e)return null;const t=new Date(e);if(Number.isNaN(t.getTime()))return null;const r=new Date;let n=r.getFullYear()-t.getFullYear();const a=r.getMonth()-t.getMonth();return(a<0||0===a&&r.getDate()<t.getDate())&&n--,n},$=e=>"female"===e?"Kvinna":"male"===e?"Man":"—";return r.jsxs(r.Fragment,{children:[I?r.jsxs(ke,{id:s,title:"Välj profil",open:n,onClose:a,children:[o.length>0?r.jsx("div",{className:"space-y-2",children:o.map(e=>r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{onClick:()=>{p(e.userId),a?.()},className:"btn btn-muted flex-1 justify-start text-left",children:[e.displayName," (Ålder ",E(e.dateOfBirth)??"—"," • ",$(e.sex),")"]}),r.jsx("button",{onClick:()=>{v("edit"),w(e),k(e.displayName||""),C(e.dateOfBirth||""),A(e.sex||""),g(!0)},className:"btn btn-secondary",children:"Ändra"}),r.jsx("button",{onClick:()=>q(e.userId),className:"btn btn-danger",children:"Ta bort"})]},e.userId))}):r.jsx("p",{className:"text-text-secondary",children:"Inga profiler ännu."}),r.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[r.jsx("button",{onClick:()=>{v("create"),w(null),k(""),C(""),A(""),g(!0)},className:"btn btn-primary min-h-[44px]",children:"Skapa ny profil"}),r.jsx("button",{onClick:()=>P(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Importera profil"}),r.jsx("button",{onClick:()=>{v("guest"),w(null),k("Gästläge"),C("1975-01-02"),A(""),g(!0)},className:"btn btn-muted min-h-[44px]",children:"Fortsätt i gästläge"})]})]}):r.jsx("div",{children:d?r.jsxs("div",{className:"bg-bg-secondary border border-border ring-1 ring-primary/20 rounded-lg p-4 mb-4",children:[r.jsxs("p",{className:"text-text-primary font-semibold",children:["Profile: ",d.displayName]}),r.jsxs("p",{className:"text-text-secondary text-sm",children:["Ålder: ",E(d.dateOfBirth)??"—"]}),r.jsxs("p",{className:"text-text-secondary text-sm",children:["Kön: ",$(d.sex)]})]}):r.jsxs("div",{className:"bg-bg-secondary border border-border rounded-lg p-4 mb-4",children:[r.jsx("p",{className:"text-text-primary mb-3",children:"No profile selected"}),o.length>0&&r.jsx("div",{className:"space-y-2 mb-3",children:o.map(e=>r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{onClick:()=>p(e.userId),className:"btn btn-muted flex-1 justify-start text-left",children:[e.displayName," (Age ",E(e.dateOfBirth)??"—"," • ",$(e.sex),")"]}),r.jsx("button",{onClick:()=>{v("edit"),w(e),k(e.displayName||""),C(e.dateOfBirth||""),A(e.sex||""),g(!0)},className:"btn btn-secondary",children:"Ändra"}),r.jsx("button",{onClick:()=>q(e.userId),className:"btn btn-danger",children:"Ta bort"})]},e.userId))}),r.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[r.jsx("button",{onClick:()=>{v("create"),w(null),k(""),C(""),A(""),g(!0)},className:"btn btn-primary min-h-[44px]",children:"Skapa ny profil"}),r.jsx("button",{onClick:()=>P(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Importera profil"})]})]})}),r.jsx(Me,{id:"profile-import-dialog",open:T,onClose:()=>P(!1)}),(_||b)&&r.jsx("div",{className:"fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4",children:r.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":"create-profile-title",className:"w-[min(92vw,32rem)] max-h-[85vh] overflow-auto rounded-xl bg-bg-secondary border border-border shadow-2xl",children:r.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),N.trim()&&S&&M)try{"edit"===D&&F?await m({...j,displayName:N.trim(),dateOfBirth:S,sex:M}):l&&d?.isGuest?await f(N.trim(),S,M):await u(N.trim(),S,M),k(""),C(""),A(""),w(null),g(!1),a?.()}catch(t){console.error("Misslyckades spara profil:",t)}},className:"p-6 space-y-5",children:[r.jsx("h2",{id:"create-profile-title",className:"text-2xl font-bold text-text-primary",children:"edit"===D?"Ändra profil":"guest"===y?"Gästläge":"Skapa ny profil"}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",children:"Profile Name"}),r.jsx("input",{type:"text",value:N,onChange:e=>k(e.target.value),className:"input",placeholder:"Ditt namn",disabled:c||"guest"===y,required:!0})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",children:"Födelsedatum"}),r.jsx("input",{type:"date",value:S,onChange:e=>C(e.target.value),className:"input",disabled:c||"guest"===y,required:!0}),r.jsx("p",{className:"text-xs text-text-secondary",children:"Används för att beräkna åldersberoende krav enligt regelboken."})]}),r.jsxs("fieldset",{className:"space-y-2",children:[r.jsxs("legend",{className:"block text-sm font-medium text-text-secondary",children:["Kön (enligt regelboken) ",r.jsx("span",{"aria-hidden":"true",children:"*"})]}),r.jsx("p",{className:"text-xs text-text-secondary",children:"Används endast för att beräkna medaljkrav enligt regelboken."}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[r.jsxs("label",{className:"btn btn-muted justify-start text-left min-h-[44px]",children:[r.jsx("input",{type:"radio",name:"sex",value:"female",checked:"female"===M,onChange:e=>A(e.target.value),disabled:c,className:"mr-2",required:!0}),"Kvinna"]}),r.jsxs("label",{className:"btn btn-muted justify-start text-left min-h-[44px]",children:[r.jsx("input",{type:"radio",name:"sex",value:"male",checked:"male"===M,onChange:e=>A(e.target.value),disabled:c,className:"mr-2",required:!0}),"Man"]})]})]}),r.jsxs("div",{className:"flex items-center justify-end gap-3 pt-2",children:[r.jsx("button",{type:"submit",className:"btn btn-primary disabled:opacity-50",disabled:c||!M,children:"edit"===D?"Spara":"guest"===y?"Starta gästläge":l&&d?.isGuest?"Spara framsteg":"Skapa"}),r.jsx("button",{type:"button",onClick:()=>{g(!1),_&&a?.()},className:"btn btn-secondary",disabled:c,children:"Avbryt"})]}),"guest"===y&&r.jsx("div",{className:"pt-2",children:r.jsx("button",{type:"button",className:"btn btn-primary w-full min-h-[44px]",disabled:c||!M,onClick:async()=>{if(M)try{await x(M),g(!1),a?.()}catch(e){console.error(e)}},children:"Starta gästläge"})})]})})})]})}const Te=[{path:"/skill-tree",label:"Märkesträd"},{path:"/medals",label:"Alla märken"},{path:"/data",label:"Data"},{path:"/settings",label:"Inställningar"},{path:"/about",label:"Om"},{path:"/help",label:"Hjälp"}];function Pe(){const e=i(),n=l(),[a,s]=t.useState(null),d=a===e.pathname,{currentProfile:c}=se(),[u,m]=t.useState(!1),p=c?.displayName?c.displayName.trim().split(/\s+/).map(e=>e[0]).slice(0,2).join("").toUpperCase():null;t.useEffect(()=>{if(!d)return;const e=e=>{"Escape"===e.key&&s(null)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[d]);const h=e=>{e.preventDefault(),s(null),m(!1),n("/help")};return r.jsxs("header",{className:"bg-surface border-b border-border sticky top-0 z-50",children:[r.jsx("div",{className:"max-w-6xl mx-auto px-4",children:r.jsxs("div",{className:"py-2",children:[r.jsx("a",{href:"#main",className:"absolute -top-10 left-2 focus:top-2 focus:left-2 focus:z-[60] btn btn-primary",children:"Hoppa till innehåll"}),r.jsxs("div",{className:"flex items-center justify-between gap-2",children:[r.jsxs(o,{to:"/",onClick:()=>{s(null),m(!1)},className:"inline-flex items-center gap-2 text-2xl font-bold leading-tight break-words text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsx(Se,{name:"Award",className:"w-6 h-6 shrink-0"}),r.jsx("span",{children:"Skyttemärken"})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("button",{type:"button",onClick:()=>m(!0),className:"inline-flex items-center justify-center h-10 w-10 sm:h-11 sm:w-11 rounded-full btn btn-muted","aria-haspopup":"dialog","aria-controls":"profile-picker","aria-label":c?.displayName?`Aktiv profil: ${c.displayName}`:"Välj profil",title:c?.displayName||"Välj profil",children:p||"?"}),r.jsx("nav",{"aria-label":"Primary",className:"hidden sm:block",children:r.jsx("ul",{className:"flex gap-2",children:Te.map(t=>{const n=e.pathname===t.path,a="/help"===t.path;return r.jsx("li",{children:r.jsx(o,{to:t.path,onClick:a?h:()=>m(!1),className:"inline-flex items-center min-h-[44px] px-4 py-2 rounded transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary "+(n?"bg-primary text-primary-foreground":"text-muted-foreground hover:bg-surface"),"aria-current":n?"page":void 0,children:t.label})},t.path)})})}),r.jsx("button",{type:"button",onClick:()=>s(t=>t===e.pathname?null:e.pathname),className:"sm:hidden inline-flex items-center justify-center h-11 w-11 rounded-md btn btn-muted","aria-label":"Växla meny","aria-controls":"mobile-primary-nav","aria-expanded":d?"true":"false",children:r.jsx(Se,{name:"Menu",size:20,className:"shrink-0"})})]})]}),r.jsx("nav",{id:"mobile-primary-nav","aria-label":"Primary",className:(d?"mt-2":"hidden")+" sm:hidden",children:r.jsx("ul",{className:"grid grid-cols-2 gap-2",children:Te.map(t=>{const n=e.pathname===t.path,a="/help"===t.path;return r.jsx("li",{children:r.jsx(o,{to:t.path,onClick:a?h:()=>{s(null),m(!1)},className:"inline-flex items-center min-h-[44px] px-4 py-2 rounded transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary "+(n?"bg-primary text-primary-foreground":"text-muted-foreground hover:bg-surface"),"aria-current":n?"page":void 0,children:t.label})},t.path)})})})]})}),r.jsx(Ae,{id:"profile-picker",mode:"picker",open:u,onClose:()=>m(!1)})]})}const Ie="https://www.pistolskytteforbundet.se/",_e="https://github.com/mandakan/spsf-medal-explorer",De="https://buymeacoffee.com/thias",Fe="https://www.pistolskytteforbundet.se/om-pistolskytte/regler/skjuthandboken-och-sakb/",qe="Skyttemärken",Ee="Mathias A",$e="MIT",Ye={2024:20};function Le(e){const t=Object.entries(Ye).map(([e,t])=>[Number(e),t]).sort((e,t)=>e[0]-t[0]);let r=t[0]?.[1]??null;for(const[n,a]of t)e>=n&&(r=a);return r}const Re=Le((new Date).getFullYear());function Ge({className:e="w-5 h-5",...t}){return r.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:e,...t,children:r.jsx("path",{fill:"currentColor",d:"M12 .5a12 12 0 0 0-3.79 23.4c.6.11.82-.26.82-.58v-2.03c-3.34.73-4.04-1.61-4.04-1.61-.55-1.41-1.35-1.79-1.35-1.79-1.1-.75.08-.73.08-.73 1.22.09 1.86 1.25 1.86 1.25 1.08 1.85 2.83 1.31 3.52 1 .11-.79.42-1.31.76-1.61-2.66-.3-5.46-1.33-5.46-5.93 0-1.31.47-2.38 1.24-3.22-.13-.3-.54-1.52.12-3.17 0 0 1.01-.32 3.3 1.23.96-.27 1.98-.4 3-.4s2.04.13 3 .4c2.29-1.55 3.3-1.23 3.3-1.23.66 1.65.25 2.87.12 3.17.77.84 1.24 1.91 1.24 3.22 0 4.61-2.8 5.62-5.47 5.92.43.37.82 1.1.82 2.22v3.29c0 .32.22.69.83.58A12 12 0 0 0 12 .5Z"})})}function Be({className:e="w-5 h-5",...t}){return r.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:e,...t,children:r.jsx("path",{fill:"currentColor",d:"M3 7h13a3 3 0 0 1 3 3v1a4 4 0 0 1-3 3.87V16a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V7Zm16 3a1 1 0 0 0-1-1h-1v3.82A2 2 0 0 0 19 11v-1ZM5 18a2 2 0 0 0 2 2h5a2 2 0 0 0 2-2V9H5v9ZM10 2a1 1 0 0 1 1 1c0 .83-.5 1.25-.8 1.5-.2.17-.2.17-.2.5a1 1 0 0 1-2 0c0-1 .5-1.5.8-1.75.2-.17.2-.17.2-.5a1 1 0 0 1 1-1Zm4 0a1 1 0 0 1 1 1c0 .83-.5 1.25-.8 1.5-.2.17-.2.17-.2.5a1 1 0 0 1-2 0c0-1 .5-1.5.8-1.75.2-.17.2-.17.2-.5a1 1 0 0 1 1-1Z"})})}function Oe(){const e=(new Date).getFullYear(),t=Ee,n=$e,a=_e,s=De,i=`${"undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/"}LICENSE`;return r.jsx("footer",{role:"contentinfo",className:"w-full border-t border-border bg-bg-primary",children:r.jsx("div",{className:"max-w-6xl mx-auto px-4 py-6",children:r.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-4",children:[r.jsxs("p",{className:"text-sm text-text-secondary text-center md:text-left",children:["© ",e," ",t," •"," ",r.jsxs("a",{href:i,target:"_blank",rel:"noopener noreferrer",className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary",children:["Licensierad under ",n]})]}),r.jsxs("nav",{className:"flex items-center gap-2","aria-label":"Sidfotslänkar",children:[r.jsxs("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm min-h-[44px] text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary","aria-label":"Öppna GitHub-repositoriet",children:[r.jsx(Ge,{}),r.jsx("span",{children:"Källkod"})]}),r.jsxs("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm min-h-[44px] text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary","aria-label":"Köp mig en kaffe",children:[r.jsx(Be,{}),r.jsx("span",{children:"Köp en kaffe till mig"})]})]})]})})})}function Ue(){const e=t.useContext(Z);if(!e)throw new Error("useBackup must be used within BackupProvider");return e}function Ve(e=new Date){try{return new Date(e).toISOString()}catch{return(new Date).toISOString()}}function ze(e){return e?Array.isArray(e)?e:[e]:[]}async function Ke(e,{version:t="1.0"}={}){const r={kind:"profile-backup",version:t,exportedAt:Ve(),profile:{userId:e?.userId||"",displayName:e?.displayName||"",createdDate:e?.createdDate||Ve(),lastModified:e?.lastModified||Ve(),dateOfBirth:e?.dateOfBirth||"",sex:e?.sex||"",unlockedMedals:ze(e?.unlockedMedals),prerequisites:ze(e?.prerequisites),features:{allowManualUnlock:!!e?.features?.allowManualUnlock,enforceCurrentYearForSustained:!!e?.features?.enforceCurrentYearForSustained},notifications:!!e?.notifications}};return JSON.stringify(r,null,2)}function He(){const{shouldShowReminder:e,dismissReminder:n,markBackupCreated:a}=Ue(),{currentProfile:s}=se(),[i,l]=t.useState(!1);if(!e||!s)return null;return r.jsx("div",{role:"status","aria-live":"polite",className:"sticky top-0 z-[2000] bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-950 dark:to-orange-950 border-b-2 border-yellow-400 dark:border-yellow-600 px-4 py-3 shadow-sm",children:r.jsxs("div",{className:"max-w-6xl mx-auto flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4",children:[r.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[r.jsx(Se,{name:"AlertTriangle",className:"w-6 h-6 text-yellow-600 dark:text-yellow-400 shrink-0","aria-hidden":"true"}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("p",{className:"font-semibold text-color-text-primary",children:"Dags att säkerhetskopiera dina uppgifter"}),r.jsx("p",{className:"text-sm text-color-text-secondary mt-0.5",children:"Din data finns bara på den här enheten. Säkerhetskopiera regelbundet för att vara säker."})]})]}),r.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto sm:shrink-0",children:[r.jsxs("button",{onClick:async()=>{try{l(!0);const e=(new Date).toISOString().split("T")[0],t=await Ke(s,{version:"1.0"});!function(e,t,r="application/octet-stream"){if("undefined"==typeof window||"undefined"==typeof document)return;let n;if(e instanceof Blob)n=e;else if(e instanceof Uint8Array)n=new Blob([e],{type:r});else if("string"==typeof e)n=new Blob([e],{type:r+";charset=utf-8"});else{if(null==e)throw new Error("downloadFile: invalid data");n=new Blob([JSON.stringify(e,null,2)],{type:"application/json;charset=utf-8"})}const a=URL.createObjectURL(n),s=document.createElement("a");s.href=a,s.download=t,s.rel="noopener",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)}(t,`medal-backup-${e}.json`,"application/json"),await a().catch(e=>{console.error("Failed to mark backup as created:",e)})}catch(e){console.error("Backup error:",e)}finally{l(!1)}},disabled:i,className:"btn btn-primary flex-1 sm:flex-none min-h-[44px] px-4 py-2",children:[r.jsx(Se,{name:"Download",className:"w-4 h-4","aria-hidden":"true"}),i?"Säkerhetskopierar...":"Säkerhetskopiera nu"]}),r.jsx("button",{onClick:async()=>{await n()},"aria-label":"Påminn mig om 7 dagar",className:"btn btn-secondary min-h-[44px] px-4 py-2",children:"Senare"})]})]})})}function We(){return r.jsxs("div",{className:"min-h-screen bg-bg-primary",children:[r.jsx(He,{}),r.jsx(Pe,{}),r.jsx("div",{className:"max-w-6xl mx-auto px-4 py-8",children:r.jsx("main",{id:"main",children:r.jsx(d,{})})}),r.jsx(Oe,{})]})}function Xe({id:e="disclaimer-global",variant:n="info",text:a="OBS: Fristående app; ej godkänd av Svenska Pistolskytteförbundet. Vid skillnader gäller alltid senaste officiella regelbok.",linkUrl:s,linkLabel:i,dismissible:l=!0,className:o="",year:d=(new Date).getFullYear()}){const c=t.useMemo(()=>Le(d),[d]),u=t.useMemo(()=>i??(c?`Läs regelboken (v${c})`:"Läs regelboken"),[i,c]),m=t.useMemo(()=>`dismiss:${e}${c?`@${c}`:""}`,[e,c]),[p,h]=t.useState(!1);t.useEffect(()=>{h("1"===localStorage.getItem(m))},[m]);if(p)return null;const f="warning"===n?"border-review text-foreground":"border-border text-muted-foreground";return r.jsxs("div",{role:"status","aria-live":"polite",className:["relative flex items-center gap-2 rounded-md border px-3 py-2 text-sm bg-bg-secondary min-h-11",f,o].filter(Boolean).join(" "),children:[r.jsx("span",{"aria-hidden":"true",className:"warning"===n?"inline-block w-2 h-2 rounded-full bg-review":"inline-block w-2 h-2 rounded-full bg-primary opacity-60"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("span",{children:a}),s?r.jsx("a",{className:"underline underline-offset-2 ml-2 hover:opacity-80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded-sm",href:s,target:"_blank",rel:"noopener noreferrer","aria-label":"Öppna officiell regelbok i ny flik",children:u}):null]}),l?r.jsx("button",{type:"button",onClick:()=>{h(!0),localStorage.setItem(m,"1")},className:"ml-2 inline-flex items-center justify-center rounded h-11 w-11 md:h-6 md:w-6 hover:bg-bg-secondary/70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary","aria-label":"Stäng meddelande",children:r.jsx("span",{"aria-hidden":"true",children:"×"})}):null]})}function Je(){const{medalDatabase:e,loading:t}=ae();return r.jsxs("div",{className:"space-y-8",children:[r.jsxs("section",{className:"text-center mb-12",children:[r.jsx("h1",{className:"text-4xl font-bold text-foreground mb-4",children:"Skyttemärken"}),r.jsx("p",{className:"text-lg text-muted-foreground",children:"Dokumentera dina skyttemärken och medaljer med aktiviteter, utforska framtida märken och planera progression"})]}),r.jsx(Xe,{id:"disclaimer-home",variant:"info",linkUrl:Fe}),r.jsxs("section",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[r.jsxs(o,{to:"/skill-tree",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(Se,{name:"Target",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Märken"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Utforska märken i ett interaktivt träd"})]}),r.jsxs(o,{to:"/medals",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(Se,{name:"List",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Märkeslista"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Översikt över alla märken med filter och sökning"})]}),r.jsxs(o,{to:"/settings",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(Se,{name:"Settings",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Inställningar"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Hantera din profil"})]})]}),!t&&e&&r.jsxs("section",{className:"card p-6 shadow",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:"Status"}),r.jsxs("p",{className:"text-muted-foreground",children:[r.jsx(Se,{name:"CheckCircle",className:"inline w-4 h-4 align-text-bottom mr-1 text-muted-foreground"}),e.getAllMedals().length," märken laddade"]}),r.jsxs("p",{className:"mt-2 text-muted-foreground",children:["Version: ",r.jsx("code",{children:xe.version})," • Build: ",r.jsx("code",{children:xe.number})," • Commit: ",r.jsx("code",{children:xe.commit})]})]})]})}function Ze(e=1,r=.5,n=3,a={}){const[s,i]=t.useState(0),[l,o]=t.useState(0),[d,c]=t.useState(e),{getBounds:u=null,overscrollPx:m=48,contentPaddingPx:p={left:0,top:0,right:0,bottom:0}}=a,h=t.useRef(null),f=t.useRef(new Map),x=t.useRef({initialDistance:0,initialScale:e,lastCenter:null}),b=t.useRef({vx:0,vy:0,lastT:0,raf:0}),g=t.useRef({x:0,y:0,t:0}),y=t.useCallback(()=>{if("undefined"==typeof window||!window.matchMedia)return!1;try{return window.matchMedia("(prefers-reduced-motion: reduce)").matches}catch{return!1}},[]),v=t.useCallback(()=>{const e=b.current;e.raf&&(cancelAnimationFrame(e.raf),e.raf=0),e.vx=0,e.vy=0,e.lastT=0},[]),j=t.useRef({width:0,height:0}),w=t.useRef({x:0,y:0}),N=t.useRef(e);t.useEffect(()=>{N.current=d},[d]),t.useEffect(()=>{w.current={x:s,y:l}},[s,l]);const k=t.useCallback(e=>{const t=e?.currentTarget?.getBoundingClientRect?.();t&&(j.current={width:t.width,height:t.height})},[]),S=(e,t)=>t<=0||e<=0?0:e*t/(e+t),C=t.useCallback((e,t=j.current)=>{if(!a||!u||!t?.width)return null;const r=u(),n=Math.max(.001,e),s=t.width/n,i=t.height/n,l=(p?.left||0)/n,o=(p?.right||0)/n,d=(p?.top||0)/n,c=(p?.bottom||0)/n,m=s-(Math.max(0,r.maxX-r.minX)+l+o),h=i-(Math.max(0,r.maxY-r.minY)+d+c);return{minX:Math.min(0,m),maxX:Math.max(0,m),minY:Math.min(0,h),maxY:Math.max(0,h)}},[u,a,p]),M=t.useCallback((e,t,r,n=!1,a=j.current)=>{const s=C(r,a);if(!s)return[e,t];const{minX:i,maxX:l,minY:o,maxY:d}=s;if(n){return[Math.min(Math.max(e,i),l),Math.min(Math.max(t,o),d)]}const c=(m||0)/Math.max(.001,r);let u=e,p=t;return e<i?u=i-S(i-e,c):e>l&&(u=l+S(e-l,c)),t<o?p=o-S(o-t,c):t>d&&(p=d+S(t-d,c)),[u,p]},[C,m]),A=t.useCallback((e,t,r,n=!1,a)=>{const[s,l]=M(e,t,r,n,a);i(s),o(l),w.current={x:s,y:l}},[M]),T=t.useCallback((t,r,n)=>{if(!isFinite(t)||!isFinite(r))return;if(y())return;v();const a=b.current;a.vx=t,a.vy=r,a.lastT="undefined"!=typeof performance?performance.now():Date.now();const s=Math.max(.001,n??(N.current||e)),i=e=>{const t=a.lastT||e,r=Math.max(1,e-t);a.lastT=e;const n=Math.exp(-r/280);a.vx*=n,a.vy*=n;const l=w.current.x+a.vx*r,o=w.current.y+a.vy*r;if(A(l,o,s,!0),Math.hypot(a.vx,a.vy)<.001){v();const[e,t]=M(w.current.x,w.current.y,s,!0);return void A(e,t,s,!0)}a.raf=requestAnimationFrame(i)};a.raf=requestAnimationFrame(i)},[y,v,A,M,e]),P=t.useCallback((e,t,r,n=220)=>{if(y())return void A(e,t,r,!0);v();const a=b.current,s=w.current.x,i=w.current.y,l="undefined"!=typeof performance?performance.now():Date.now(),o=d=>{const c=Math.min(1,(d-l)/n),u=(m=c,1-Math.pow(1-m,3));var m;A(s+(e-s)*u,i+(t-i)*u,r,!0),c<1&&(a.raf=requestAnimationFrame(o))};a.raf=requestAnimationFrame(o)},[y,A,v]),I=t.useCallback((e,t)=>{e.preventDefault(),v(),k(e);const a=e.currentTarget,i=a?.getBoundingClientRect?.(),o=i?e.clientX-i.left:0,u=i?e.clientY-i.top:0,m=i?o-i.width/2:0,p=i?u-i.height/2:0,h=d,f=Math.pow(2,-e.deltaY/300),x=Math.max(r,Math.min(n,h*f)),b=Math.max(.001,t??h),g=Math.max(.001,b*(x/Math.max(.001,h))),y=m*(1/g-1/b),j=p*(1/g-1/b);c(x),A(s+y,l+j,g,!1,i)},[d,r,n,v,k,A,s,l]),_=t.useCallback(e=>{e.preventDefault(),v(),k(e),e.currentTarget?.setPointerCapture?.(e.pointerId),f.current.set(e.pointerId,{x:e.clientX,y:e.clientY});const t="undefined"!=typeof performance?performance.now():Date.now();if(g.current={x:e.clientX,y:e.clientY,t:t},1===f.current.size)h.current={x:e.clientX,y:e.clientY,panX:s,panY:l};else if(2===f.current.size){const e=Array.from(f.current.values()),t=e[1].x-e[0].x,r=e[1].y-e[0].y;x.current.initialDistance=Math.hypot(t,r),x.current.initialScale=d,x.current.lastCenter={x:(e[0].x+e[1].x)/2,y:(e[0].y+e[1].y)/2},b.current.vx=0,b.current.vy=0}},[s,l,d,v,k]),D=t.useCallback((e,t)=>{if(e.syntheticPan){v();const r=Math.max(.001,t??d),{dx:n,dy:a}=e.syntheticPan;return void A(s+n,l+a,r)}if(f.current.has(e.pointerId))if(e.preventDefault(),k(e),f.current.set(e.pointerId,{x:e.clientX,y:e.clientY}),2===f.current.size){const a=Array.from(f.current.values()),i=a[1].x-a[0].x,o=a[1].y-a[0].y,u=Math.hypot(i,o),m=u/(x.current.initialDistance||u),p=Math.max(r,Math.min(n,x.current.initialScale*m)),h=e.currentTarget,g=h?.getBoundingClientRect?.(),y=(a[0].x+a[1].x)/2,v=(a[0].y+a[1].y)/2,j=g?y-g.left:0,w=g?v-g.top:0,N=g?j-g.width/2:0,k=g?w-g.height/2:0,S=d,C=Math.max(.001,t??S),M=Math.max(.001,C*(p/Math.max(.001,S))),T=N*(1/M-1/C),P=k*(1/M-1/C);c(p),A(s+T,l+P,M,!1,g),b.current.vx=0,b.current.vy=0}else if(1===f.current.size&&h.current){const r=Math.max(.001,t??d),n="undefined"!=typeof performance?performance.now():Date.now(),a=g.current,s=Math.max(1,n-a.t),i=(e.clientX-h.current.x)/r,l=(e.clientY-h.current.y)/r,o=w.current.x,c=w.current.y;A(h.current.panX+i,h.current.panY+l,r);const u=(w.current.x-o)/s,m=(w.current.y-c)/s,p=b.current,f=.25;p.vx=(1-f)*p.vx+f*u,p.vy=(1-f)*p.vy+f*m,g.current={x:e.clientX,y:e.clientY,t:n}}},[d,r,n,v,A,k,s,l]),F=t.useCallback((e,t)=>{if(f.current.delete(e.pointerId),f.current.size<1){const e=b.current,r=Math.hypot(e.vx,e.vy),n=Math.max(.001,t??(N.current||d)),[a,s]=M(w.current.x,w.current.y,n,!0),i=(e,t)=>Math.abs(e-t)<1e-4;!i(a,w.current.x)||!i(s,w.current.y)?P(a,s,n):h.current&&r>.002?T(e.vx,e.vy,n):A(a,s,n,!0),h.current=null}f.current.size<2&&(x.current.initialDistance=0)},[T,M,A,d,P]),q=t.useCallback(()=>{v(),c(e),A(0,0,e,!0)},[e,v,A]),E=t.useCallback(e=>{const t=Math.max(r,Math.min(n,e));c(t);const{x:a,y:s}=w.current;A(a,s,t)},[r,n,A]);return{panX:s,panY:l,scale:d,setScaleAbsolute:E,handleWheel:I,handlePointerDown:_,handlePointerMove:D,handlePointerUp:F,resetView:q}}const Qe={review:"--color-review",placeholder:"--color-placeholder",locked:"--color-status-locked",available:"--color-status-available",eligible:"--color-status-eligible",unlocked:"--color-status-unlocked"};const et={review:"Search",placeholder:"CircleDashed",locked:"Lock",available:"CirclePlus",eligible:"CircleCheck",unlocked:"Trophy"},tt={Lock:x,CirclePlus:f,CircleCheck:h,Trophy:p,CircleDashed:m,Search:u,Circle:c};const rt=new Map;function nt(){rt.clear()}function at(e,t="color"){if(rt.has(`${t}:${e}`))return rt.get(`${t}:${e}`);if("undefined"==typeof document)return null;const r=document.createElement("span");r.style.position="absolute",r.style.opacity="0",r.style.pointerEvents="none",r.className=e,document.body.appendChild(r);const n=getComputedStyle(r)[t];return document.body.removeChild(r),rt.set(`${t}:${e}`,n),n}function st(e,t=[]){for(const r of t){const t=e.getPropertyValue(r)?.trim();if(t)return t}return null}function it(e){return e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName}function lt(e){const t="undefined"!=typeof document?document.documentElement:null;let r=null;try{"function"==typeof getComputedStyle&&it(e)?r=getComputedStyle(e):t&&"function"==typeof getComputedStyle&&(r=getComputedStyle(t))}catch{r=null}return{unlocked:r&&st(r,[Qe.unlocked])||"#22C55E",achievable:r&&st(r,["--color-success","--color-achievable"])||at("text-emerald-400")||"#20C997",available:r&&st(r,[Qe.available])||"#0EA5E9",eligible:r&&st(r,[Qe.eligible])||"#F59E0B",locked:r&&st(r,[Qe.locked])||"#6C757D",text:r&&st(r,["--color-text-primary","--color-foreground"])||at("text-text-primary")||at("text-slate-900")||"#111827",connection:r&&st(r,["--color-connection","--color-border-muted"])||at("text-slate-400")||"#94A3B8",border:r&&st(r,["--color-border"])||at("border-slate-500","borderTopColor")||"rgba(0,0,0,0.3)",accent:r&&st(r,["--color-primary"])||at("text-primary")||at("text-blue-500")||"#3B82F6",review:r&&st(r,[Qe.review])||"#8B5CF6",placeholder:r&&st(r,[Qe.placeholder])||"#94A3B8",surface:r&&st(r,["--color-bg-primary","--color-surface"])||"#FFFFFF"}}function ot(e){try{const t="function"==typeof getComputedStyle?getComputedStyle(it(e)?e:document.documentElement):null,r=t?.fontFamily;return r&&r.trim().length?r:"system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"}catch{return"system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"}}function dt(e,t,r,n=3,a="…"){if(!t)return[];const s=String(t).trim().split(/\s+/),i=[];let l="";for(let o=0;o<s.length;o++){const t=l?l+" "+s[o]:s[o];if(e.measureText(t).width<=r)l=t;else{if(i.length===n-1){let t=l||s[o];for(;e.measureText(t+a).width>r&&t.length>0;)t=t.slice(0,-1);return i.push(t+a),i}l&&i.push(l),l=s[o]}}return l&&i.push(l),i.slice(0,n)}function ct(e,t,r,n,a,s,i,l=!1){if(!(a instanceof C||a&&"object"==typeof a))throw new Error("drawMedalNode requires a Medal instance or a plain medal-like object");const o=lt(e?.canvas),d="function"==typeof a?.isPlaceholder?a.isPlaceholder():"placeholder"===a?.status,u=!d&&("function"==typeof a?.isUnderReview?a.isUnderReview():"under_review"===a?.status),m=s?.status||"locked",p=o[m],h=Math.max(i,.001);e.beginPath(),e.fillStyle=o.surface,e.arc(t,r,n,0,2*Math.PI),e.fill();const f=d?o.placeholder:p,x="function"==typeof e.save;if(x&&e.save(),d&&"function"==typeof e.setLineDash){const t=Math.max(1,2*h);e.setLineDash([t,1.5*t])}e.strokeStyle=f,e.lineWidth=3,e.beginPath(),e.arc(t,r,Math.max(1,n-1.5),0,2*Math.PI),e.stroke(),d&&"function"==typeof e.setLineDash&&e.setLineDash([]),x&&"function"==typeof e.restore&&e.restore();const b=tt[et[d?"placeholder":m]||"Circle"]||c,g=1.3*n/24;if("function"==typeof e?.save&&"function"==typeof e?.translate&&"function"==typeof e?.scale&&"function"==typeof e?.restore?(e.save(),e.translate(t,r),e.scale(g,g),e.translate(-12,-12),e.lineWidth=2,e.strokeStyle=f,e.lineCap="round",e.lineJoin="round",function(e,t){if(Array.isArray(t))for(const[r,n]of t)switch(r){case"path":{const t=n?.d;if(t&&"function"==typeof Path2D){const r=new Path2D(t);e.stroke(r)}break}case"line":{const{x1:t,y1:r,x2:a,y2:s}=n||{};[t,r,a,s].every(e=>"number"==typeof e)&&(e.beginPath(),e.moveTo(t,r),e.lineTo(a,s),e.stroke());break}case"polyline":case"polygon":{const t=(n?.points||"").trim();if(t){const n=t.split(/[\s,]+/).map(Number);if(n.length>=4){e.beginPath(),e.moveTo(n[0],n[1]);for(let t=2;t<n.length;t+=2)e.lineTo(n[t],n[t+1]);"polygon"===r&&e.closePath(),e.stroke()}}break}case"rect":{const{x:t=0,y:r=0,width:a=0,height:s=0,rx:i=0,ry:l=0}=n||{};e.beginPath(),(i||l)&&"function"==typeof e.roundRect?e.roundRect(t,r,a,s,i||l):e.rect(t,r,a,s),e.stroke();break}case"circle":{const{cx:t=0,cy:r=0,r:a=0}=n||{};e.beginPath(),e.arc(t,r,a,0,2*Math.PI),e.stroke();break}case"ellipse":{const{cx:t=0,cy:r=0,rx:a=0,ry:s=0}=n||{};"function"==typeof e.ellipse&&(e.beginPath(),e.ellipse(t,r,a,s,0,0,2*Math.PI),e.stroke());break}}}(e,b),e.restore()):(e.beginPath(),e.strokeStyle=f,e.lineWidth=Math.max(1,.15*n),e.arc(t,r,Math.max(2,.5*n),0,2*Math.PI),e.stroke()),u){const a=Math.max(3,.22*n),s=.7*n,i=.7*n;e.beginPath(),e.fillStyle=o.review,e.arc(t+s,r-i,a,0,2*Math.PI),e.fill(),e.beginPath(),e.strokeStyle=o.surface,e.lineWidth=Math.max(1,2*h),e.arc(t+s,r-i,a,0,2*Math.PI),e.stroke()}const y=("string"==typeof a?.name?a.name.trim():"")||"Medal";if((l||i>=.8)&&y){e.fillStyle=o.text,e.textAlign="center",e.textBaseline="top";const s=14,d=Math.round(1.3*s),c=ot(e.canvas);e.font=`${s}px ${c}`;const u=180,m=l||i>=1.3?3:2,p="string"==typeof a?.tierName?a.tierName.trim():"";let h;if(p){h=[(t=>{if(e.measureText(t).width<=u)return t;let r=t;for(;r.length&&e.measureText(r+"…").width>u;)r=r.slice(0,-1);return r.length?r+"…":t})(y),...dt(e,p,u,Math.max(0,m-1))]}else h=dt(e,y,u,m);const f=r+n+8,x=e.shadowColor,b=e.shadowBlur,g=e.shadowOffsetX,v=e.shadowOffsetY;e.shadowColor="rgba(0,0,0,0.2)",e.shadowBlur=2,e.shadowOffsetX=0,e.shadowOffsetY=1;for(let r=0;r<h.length;r++)e.fillText(h[r],t,f+r*d);e.shadowColor=x,e.shadowBlur=b,e.shadowOffsetX=g,e.shadowOffsetY=v}}function ut(){return{render:t.useCallback((e,t,r,n,a,s,i,l,o)=>{if(!r||!t||!n)return;const d=new Map((r.medals||[]).map(e=>[e.medalId,e]));r.connections?.forEach(t=>{const r=d.get(t.from),n=d.get(t.to);if(!r||!n)return;const l=(r.x+a)*i+e.canvas.width/2,o=(r.y+s)*i+e.canvas.height/2,c=(n.x+a)*i+e.canvas.width/2,u=(n.y+s)*i+e.canvas.height/2;!function(e,t,r,n,a,s="prerequisite",i,l){const o=lt(e?.canvas);e.strokeStyle=o.connection,e.lineWidth=2,e.beginPath(),e.moveTo(t,r),e.lineTo(n,a),e.stroke();const d=Math.atan2(a-r,n-t);e.beginPath(),e.moveTo(n,a),e.lineTo(n-10*Math.cos(d-Math.PI/6),a-10*Math.sin(d-Math.PI/6)),e.lineTo(n-10*Math.cos(d+Math.PI/6),a-10*Math.sin(d+Math.PI/6)),e.closePath(),e.fillStyle=o.connection,e.fill();const c=Math.abs(a-r)<5;if(l&&i>=.8&&!c){const s=lt(e?.canvas),i=n-t,o=a-r,d=Math.hypot(i,o)||1,c=12,u=(t+n)/2+-o/d*c,m=(r+a)/2+i/d*c,p=12,h=6,f=4,x=ot(e.canvas);e.font=`${p}px ${x}`;const b=(e.measureText(l)?.width||0)+2*h,g=p+2*f,y=u-b/2,v=m-g/2,j=6,w=e.globalAlpha;e.globalAlpha=.12,e.fillStyle=s.accent,e.beginPath(),"function"==typeof e.arcTo?(e.moveTo(y+j,v),e.arcTo(y+b,v,y+b,v+g,j),e.arcTo(y+b,v+g,y,v+g,j),e.arcTo(y,v+g,y,v,j),e.arcTo(y,v,y+b,v,j)):e.rect(y,v,b,g),e.closePath(),e.fill(),e.globalAlpha=w,e.strokeStyle=s.accent,e.lineWidth=1.5,e.beginPath(),"function"==typeof e.arcTo?(e.moveTo(y+j,v),e.arcTo(y+b,v,y+b,v+g,j),e.arcTo(y+b,v+g,y,v+g,j),e.arcTo(y,v+g,y,v,j),e.arcTo(y,v,y+b,v,j)):e.rect(y,v,b,g),e.closePath(),e.stroke(),e.fillStyle=s.text,e.textAlign="center",e.textBaseline="middle","function"==typeof e.fillText&&e.fillText(l,u,m)}}(e,l,o,c,u,t.type,i,t.label)}),Array.isArray(t)&&t.forEach(t=>{const r=d.get(t.id);if(!r)return;const c=(r.x+a)*i+e.canvas.width/2,u=(r.y+s)*i+e.canvas.height/2,m=r.radius*i,p=n.unlocked.find(e=>e.medalId===t.id)||n.eligible.find(e=>e.medalId===t.id)||n.available.find(e=>e.medalId===t.id)||{status:"locked"};if(l===t.id){const t=lt(e.canvas);e.strokeStyle=t.accent,e.lineWidth=Math.max(2,4/Math.max(i,.001)),e.beginPath(),e.arc(c,u,m+6,0,2*Math.PI),e.stroke()}const h=l===t.id||o===t.id;ct(e,c,u,m,t,p,i,h)})},[])}}function mt({status:e,className:t="w-4 h-4"}){const n=et[e]||"Circle",a=function(e){return Qe[e]||null}(e);return r.jsx(Se,{name:n,className:t,style:a?{color:`var(${a})`}:void 0,"aria-hidden":"true",focusable:"false"})}function pt({className:e="",id:t,variant:n="list"}){return r.jsxs("div",{id:t,className:["flex flex-wrap items-center gap-x-4 gap-y-2 text-xs text-muted-foreground w-full min-w-0",e].join(" "),children:[r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(mt,{status:"review"}),r.jsx("span",{children:"Under granskning"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(mt,{status:"placeholder"}),r.jsx("span",{children:"Platshållare"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(mt,{status:"locked"}),r.jsx("span",{children:"Låst"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(mt,{status:"available"}),r.jsx("span",{children:"Tillgänglig"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(mt,{status:"eligible"}),r.jsx("span",{children:"Kvalificerad"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(mt,{status:"unlocked"}),r.jsx("span",{children:"Upplåst"})]})]})}function ht({open:e,title:n="Bekräfta",description:a="",confirmLabel:i="OK",cancelLabel:l="Avbryt",onConfirm:o,onCancel:d,variant:c="danger",id:u="confirm-dialog"}){const m=t.useRef(null),p=t.useRef(null),h=t.useRef(null),f=`${u}-title`,x=`${u}-desc`;if(t.useEffect(()=>{if(!e)return;h.current=document.activeElement;const t=p.current;if(!t)return;const r=()=>t.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),n=r()[0];n?.focus();const a=e=>{if("Escape"===e.key)e.preventDefault(),d?.();else if("Tab"===e.key){const t=r();if(0===t.length)return;const n=t[0],a=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),a?.focus()):e.shiftKey||document.activeElement!==a||(e.preventDefault(),n?.focus())}},s=e=>{e.target===m.current&&d?.()};document.addEventListener("keydown",a);const i=m.current;return i?.addEventListener("pointerdown",s,{capture:!0}),()=>{document.removeEventListener("keydown",a),i?.removeEventListener("pointerdown",s,{capture:!0});const e=h.current;e&&"function"==typeof e.focus&&e.focus()}},[e,d]),!e)return null;const b="danger"===c?"btn btn-danger min-h-[44px]":"btn btn-primary min-h-[44px]",g=r.jsx("div",{ref:m,className:"fixed inset-0 z-[80] bg-black/40 backdrop-blur-[1px] flex items-end sm:items-center justify-center p-3 safe-bottom",children:r.jsxs("div",{ref:p,role:"dialog","aria-modal":"true","aria-labelledby":f,"aria-describedby":x,className:"w-full sm:w-[28rem] max-w-[92vw] rounded-lg border border-border bg-background shadow-xl p-4",children:[r.jsx("h2",{id:f,className:"text-base font-semibold mb-1 text-foreground",children:n}),a?r.jsx("p",{id:x,className:"text-sm text-muted-foreground mb-4",children:a}):null,r.jsxs("div",{className:"flex flex-row-reverse flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:b,onClick:o,children:i}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:d,children:l})]})]})});return"undefined"==typeof document?g:s.createPortal(g,document.body)}const ft="columns",xt=new Map;function bt(e){if(!e||"object"!=typeof e)throw new Error("registerLayout: def must be an object");const{id:t,generator:r}=e;if(!t||"string"!=typeof t)throw new Error("registerLayout: def.id must be a non-empty string");if("function"!=typeof r)throw new Error(`registerLayout: def.generator must be a function (id: ${t})`);if(xt.has(t))throw new Error(`registerLayout: layout id already registered: ${t}`);xt.set(t,e)}function gt(e){const t=new Map(e.map(e=>[e.id,e])),r={};e.forEach(e=>{r[e.type]||(r[e.type]=[]),r[e.type].push(e)});const n=Object.keys(r),a={medals:[],connections:[]};return n.forEach((e,n)=>{(r[e]||[]).forEach((e,r)=>{const s={medalId:e.id,type:e.type,x:200*n,y:140*r,radius:20,yearsRequired:0};a.medals.push(s);let i=0;const l=Array.isArray(e.requirements)&&e.requirements.find(e=>e&&"sustained_achievement"===e.type&&Number.isFinite(e.yearsOfAchievement))?.yearsOfAchievement||0;Array.isArray(e.prerequisites)&&e.prerequisites.forEach(r=>{if(r&&"medal"===r.type&&r.medalId){const n=t.get(r.medalId),s=n&&n.type===e.type;let o=0;Number.isFinite(r.yearOffset)&&r.yearOffset>0?o=r.yearOffset:s&&"number"==typeof l&&l>1&&(o=l),o>i&&(i=o),a.connections.push({from:r.medalId,to:e.id,type:"prerequisite"})}}),s.yearsRequired=i})}),function(e){const t=5,r=100;for(let n=0;n<t;n++)for(let t=0;t<e.medals.length;t++)for(let n=t+1;n<e.medals.length;n++){const a=e.medals[t],s=e.medals[n],i=s.x-a.x,l=s.y-a.y,o=Math.sqrt(i*i+l*l)||1,d=r/(o*o),c=i/o*d*.1,u=l/o*d*.1;a.x-=c,a.y-=u,s.x+=c,s.y+=u}return e}(a)}function yt(e){const t=Array.isArray(e?.requirements)?e.requirements:[];let r=0;for(const n of t){const e=n&&"sustained_achievement"===n.type&&Number.isFinite(n.yearsOfAchievement)?n.yearsOfAchievement:0;e>r&&(r=e)}return r}const vt={id:"timeline",label:"Tidslinje",description:"Lanes per typ. X visar minsta ackumulerade år mellan förkunskaper (yearOffset).",defaultOptions:{yearWidth:220,laneHeight:260,rowHeight:130,radius:22},generator:(e,t={})=>{const r={...vt.defaultOptions,...t||{}},n=r.yearWidth,a=r.laneHeight,s=r.rowHeight,i=r.radius,l=Array.isArray(e)?e:[],o=new Map(l.map(e=>[e.id,e])),d=new Map(l.map(e=>[e.id,yt(e)])),c=new Map,u=new Map,m=new Map,p=[],h=(e,t,r)=>(e.has(t)||e.set(t,r),e.get(t));for(const k of l)m.set(k.id,0),h(c,k.id,[]),h(u,k.id,[]);for(const k of l){const e=Array.isArray(k?.prerequisites)?k.prerequisites:[];for(const t of e){if(!t||"medal"!==t.type||!t.medalId)continue;if(!o.has(t.medalId))continue;const e=Number.isFinite(t.yearOffset)&&t.yearOffset>0?t.yearOffset:0;c.get(k.id).push({from:t.medalId,cost:e}),u.get(t.medalId).push(k.id),m.set(k.id,(m.get(k.id)||0)+1),p.push({from:t.medalId,to:k.id,type:"prerequisite",label:e>0?`${e} år`:void 0})}}const f=new Map(l.map(e=>[e.id,0])),x=new Map(l.map(e=>[e.id,0])),b=[];for(const k of l)0===(m.get(k.id)||0)&&(x.set(k.id,d.get(k.id)||0),b.push(k.id));for(;b.length;){const e=b.shift(),t=u.get(e)||[];for(const r of t){const t=(c.get(r)||[]).find(t=>t.from===e),n=t?.cost||0,a=(x.get(e)||0)+n;(f.get(r)||0)<a&&f.set(r,a),m.set(r,(m.get(r)||0)-1),0===(m.get(r)||0)&&(x.set(r,(f.get(r)||0)+(d.get(r)||0)),b.push(r))}}const g=(y=l.map(e=>e?.type||"unknown"),Array.from(new Set(y))).sort((e,t)=>String(e).localeCompare(String(t)));var y;const v=new Map(g.map((e,t)=>[e,t])),j=[],w=[],N=new Map;for(const k of l){const e=k?.type||"unknown";if(!N.has(e)){const t=k&&"string"==typeof k.typeName?k.typeName.trim():"";N.set(e,t.length?t:e)}}for(const k of g){const e=(v.get(k)||0)*a,t=N.get(k)??k;w.push({type:k,y:e,label:t});const r=l.filter(e=>(e?.type||"unknown")===k),o=new Map;for(const n of r){const e=x.get(n.id)||0;o.has(e)||o.set(e,[]),o.get(e).push(n)}const d=Array.from(o.keys()).sort((e,t)=>e-t);for(const a of d){const t=o.get(a)||[];t.sort((e,t)=>String(e.id).localeCompare(String(t.id)));for(let r=0;r<t.length;r++){const l=t[r],o=(c.get(l.id)||[]).reduce((e,t)=>Math.max(e,t.cost||0),0);j.push({medalId:l.id,type:l.type,x:a*n,y:e+r*s,radius:i,yearsRequired:o})}}}return{medals:j,connections:p,meta:{kind:"timeline",yearWidth:n,laneHeight:a,rowHeight:s,lanes:w}}}};bt({id:"columns",label:"Standard (kolumner)",description:"Grupperar märken efter typ i kolumner.",generator:e=>gt(e)}),bt(vt);const jt="skilltree:layoutPreset";function wt(){const[e,r]=t.useState(()=>function(){if("undefined"==typeof window)return null;try{const e=window.localStorage.getItem(jt);return e&&e.length?e:null}catch{return null}}()||ft);return{presetId:e,setPresetId:t.useCallback(e=>{const t=e||ft;r(t),function(e){if("undefined"!=typeof window)try{e&&window.localStorage.setItem(jt,e)}catch{}}(t)},[])}}function Nt(e){const{medalDatabase:r}=ae(),n=t.useMemo(()=>{return t=e||ft,xt.has(t)?xt.get(t):xt.get(ft)||null;var t},[e]),a=t.useMemo(()=>r?.getAllMedals?.()||[],[r]);return{layout:t.useMemo(()=>n&&a&&0!==a.length?n.generator(a,n.defaultOptions):null,[n,a]),preset:n}}function kt({laneLabels:e}){return e&&0!==e.length?r.jsx("div",{className:"pointer-events-none absolute inset-0",children:e.map(e=>r.jsxs("div",{role:"note","aria-label":`${e.line1} ${e.line2}`.replace("-",""),className:"absolute left-0 text-xs leading-tight font-medium text-text-primary bg-background/95 backdrop-blur-sm px-1.5 py-0.5 rounded-r border-r border-t border-b border-border/60 shadow-sm",style:{top:`${e.top}px`,transform:"translateY(-50%)",zIndex:5,maxWidth:"115px"},title:`${e.line1} ${e.line2}`.replace("-",""),children:[r.jsx("div",{className:"whitespace-nowrap",children:e.line1}),e.line2&&r.jsx("div",{className:"whitespace-nowrap",children:e.line2})]},e.id))}):null}function St({legendDescribedById:e}){const n=t.useRef(null),{medalDatabase:a}=ae(),s=le(),{render:o}=ut(),[d,c]=t.useState(null),[u,m]=t.useState(null),[p,h]=t.useState([]),[f,x]=t.useState([]),g=l(),y=i(),v=y.pathname.endsWith("/skill-tree/fullscreen"),j=t.useRef(null),{presetId:w,setPresetId:N}=wt(),{layout:k}=Nt(w),S=24,[C,M]=t.useState(!0),[A,T]=t.useState(C?52:0),[P,I]=t.useState({w:0,h:0}),_=t.useCallback(()=>{if(!k||!k.medals?.length)return{minX:0,minY:0,maxX:0,maxY:0};let e=1/0,t=1/0,r=-1/0,n=-1/0;for(let a=0;a<k.medals.length;a++){const s=k.medals[a],i=s.radius||20;s.x-i<e&&(e=s.x-i),s.y-i<t&&(t=s.y-i),s.x+i>r&&(r=s.x+i),s.y+i>n&&(n=s.y+i)}return{minX:e,minY:t,maxX:r,maxY:n}},[k]),D=t.useCallback((e,t=24,r=0)=>{if(!k||!e)return{baseScale:1,minX:0,minY:0};const n=e.width,a=e.height;if(!n||!a)return{baseScale:1,minX:0,minY:0};const s=k.medals||[];if(!s.length)return{baseScale:1,minX:0,minY:0};let i=1/0,l=1/0,o=-1/0,d=-1/0;for(let f=0;f<s.length;f++){const e=s[f],t=e.radius||20;e.x-t<i&&(i=e.x-t),e.y-t<l&&(l=e.y-t),e.x+t>o&&(o=e.x+t),e.y+t>d&&(d=e.y+t)}const c=Math.max(1,o-i),u=Math.max(1,d-l),m=(n-2*t)/c,p=(a-2*t-Math.max(0,r))/u,h="timeline"===k?.meta?.kind;return{baseScale:Math.max(.001,h?p:Math.min(m,p)),minX:i,minY:l}},[k]),F=1.2,q=b.useCallback(()=>"timeline"===k?.meta?.kind?{min:.2,max:1.5}:{min:.5,max:1.5},[k]),E=t.useCallback(()=>{const{min:e,max:t}=q(),r=P.w,n=P.h;if(!k||!r||!n)return{min:e,max:t};const a={width:r,height:n},{baseScale:s}=D(a,S,A),i=Math.max(.001,s),l=Math.max(.001,e/i);return{min:l,max:Math.max(l,t/i)}},[P,k,q,D,A]),{min:$,max:Y}=E(),L=b.useMemo(()=>{const e="timeline"===k?.meta?.kind;return{left:(e?120:80)+S,top:(e?40:S)+A,right:104,bottom:(e?100:56)+S}},[k,A]),{panX:R,panY:G,scale:B,setScaleAbsolute:O,handleWheel:U,handlePointerDown:V,handlePointerMove:z,handlePointerUp:K,resetView:H}=Ze(6,$,Y,{getBounds:_,overscrollPx:48,contentPaddingPx:L}),[W,X]=t.useState(!1),J=t.useRef(null),Z=t.useRef(null),Q=t.useRef(!1),ee=t.useRef({x:0,y:0}),te=t.useRef(B);t.useEffect(()=>{te.current=B},[B]);const[re,ne]=t.useState(!1),[ie,oe]=t.useState(!0),[de,ce]=t.useState(!1),ue=e||"skilltree-legend",me=t.useRef(null),pe=t.useRef(null),he=t.useRef(null),fe=t.useRef(null),xe=v?"fullscreen-actions-menu":"canvas-actions-menu",{currentProfile:be,startExplorerMode:ge,hydrated:ye,resetCurrentProfileData:ve}=se(),je=Boolean(be?.isGuest),we=!ye||void 0===be,[Ne,ke]=t.useState(!1),[Ce,Me]=t.useState(!1),[Te,Pe]=t.useState(!1),Ie=(()=>{try{return window.localStorage.getItem("app:onboardingChoice")}catch{return null}})(),_e=v&&!we&&!be&&!Ie&&!Ne,De=t.useCallback((e,t=24)=>{const{baseScale:r,minX:n,minY:a}=D(e,t,A),s=e?.width||0,i=e?.height||0,l=Math.max(.001,r*B),o=("timeline"===k?.meta?.kind?120:80)/l,d=Math.max(0,A)/l;return{effScale:l,effPanX:R+((t-s/2)/l-(n-o)),effPanY:G+((t-i/2)/l-(a-d)),baseScale:r}},[D,R,G,B,A,k]),Fe=t.useCallback((e,t=120)=>{if(!k||!e)return[];const r=e.width,n=e.height,a=k.medals||[],{effScale:s,effPanX:i,effPanY:l}=De(e),o=[];for(let d=0;d<a.length;d++){const e=a[d],c=(e.x+i)*s+r/2,u=(e.y+l)*s+n/2,m=(e.radius||20)*s;c+m>=-t&&c-m<=r+t&&u+m>=-t&&u-m<=n+t&&o.push(e)}return o},[k,De]),qe=t.useCallback(e=>{if(!e||!k)return[];if(!ie)return[];if("timeline"===k?.meta?.kind)return[];const{effScale:t,effPanX:r,effPanY:n}=De(e),a=e.width,i=e.height,l=Fe(e),o=[],c=e=>u===e||d===e||t>=.8,m=new Map;for(const s of k.medals||[])m.set(s.medalId,s);const p=Math.max(16,12),h=e=>({x:(e.x+r)*t+a/2,y:(e.y+n)*t+i/2,r:(e.radius||20)*t});for(const d of l){const e=d.yearsRequired||0;if(!e||!c(d.medalId))continue;const t=h(d);let r=t.x,n=t.y-(t.r+8+10);const a=(k.connections||[]).find(e=>e.to===d.medalId);if(a){const e=m.get(a.from);if(e){const a=h(e),s=t.x-a.x,i=t.y-a.y,l=Math.hypot(s,i)||1,o=-(i/l),d=s/l,c=r-a.x,u=n-a.y,m=Math.hypot(c,u)||1,p=a.r+Math.max(56,20)/2+6;if(m<p){const e=p-m;r+=o*e,n+=d*e}}}const i=r-t.x,l=n-t.y,u=Math.hypot(i,l)||1,f=t.r+p;if(u<f){const e=i/u,a=l/u;r=t.x+e*f,n=t.y+a*f}const x=s?.[d.medalId]?.status,b="achievable"===x||"unlocked"===x?"ready":"neutral",g=`${e} år`;o.push({id:d.medalId,left:r,top:n,text:g,variant:b,w:56,h:20})}return o},[k,De,Fe,u,d,s,ie]),Ee=t.useCallback(e=>{if(!e||!k)return[];if("timeline"!==k?.meta?.kind)return[];const{effScale:t,effPanY:r}=De(e),n=e.height,a=Array.isArray(k.meta.lanes)?k.meta.lanes:[],s=[];for(const i of a){const e=(i.y+r)*t+n/2;if(e<-50||e>n+50)continue;const a=String(i.label||i.type||"");let l=a,o="";const d=a.toLowerCase().lastIndexOf("märket");d>0&&(l=a.substring(0,d).trim()+"-",o=a.substring(d).trim()),s.push({id:i.type||`lane-${s.length}`,line1:l,line2:o,top:e})}return s},[k,De]),$e=t.useCallback(()=>{if(!n.current||!k||!a)return;const e=n.current,t=e.getContext("2d"),r=e.getBoundingClientRect();e.width===Math.floor(r.width)&&e.height===Math.floor(r.height)||(e.width=Math.floor(r.width),e.height=Math.floor(r.height),I({w:e.width,h:e.height}));const i=getComputedStyle(e).backgroundColor||"#fcfcf9";t.fillStyle=i,t.fillRect(0,0,e.width,e.height);const l=a.getAllMedals(),c=Fe(e),m=new Set(c.map(e=>e.medalId)),p=l.filter(e=>m.has(e.id)),{effScale:h,effPanX:f,effPanY:x}=De(e);if("timeline"===k?.meta?.kind){const r=lt(e)||{},n=e.width,a=e.height,s=-n/2/h-f,i=n/2/h-f,l=Number(k.meta.yearWidth)||220,o=Math.floor(s/l),d=Math.ceil(i/l),c=r.connection||"rgba(0,0,0,0.3)",u=r.text||"#111827",m=C?A+6:12;t.save(),t.lineWidth=1,t.strokeStyle=c,t.globalAlpha=.25;for(let e=Math.max(0,o);e<=d;e++){const r=(e*l+f)*h+n/2;t.beginPath(),t.moveTo(r,0),t.lineTo(r,a),t.stroke(),t.globalAlpha=.8,t.fillStyle=u,t.textAlign="center",t.textBaseline="top",t.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif",t.fillText(`${e} år`,r,m),t.globalAlpha=.25}t.restore()}o(t,p,k,s,f,x,h,d,u)},[Fe,De,k,a,s,d,o,u,A,C]),Ye=t.useCallback(()=>{const e=n.current;if(!e||!k)return;const{baseScale:t}=D(e,S,A),{min:r,max:a}=q(),s="timeline"===k?.meta?.kind?.9:.8,i=Math.min(a,Math.max(r,s))/Math.max(.001,t);H(),O(i)},[D,k,H,O,A,q]),Le=(e,t,r)=>Math.min(r,Math.max(t,e)),Re=t.useCallback(()=>{O(Le(te.current*F,$,Y))},[O,$,Y,F]),Ge=t.useCallback(()=>{O(Le(te.current/F,$,Y))},[O,$,Y,F]),Be=t.useCallback(()=>{M(e=>{const t=!e;return t||T(0),t})},[T,M]),Oe=t.useCallback(()=>{const e=y.state?.backgroundLocation;if(e&&"object"==typeof e){const t={pathname:e.pathname,search:e.search,hash:e.hash};return void g(t,{replace:!0,state:{...e.state||{},fromFullscreenClose:!0}})}if("string"==typeof e)return void g(e,{replace:!0,state:{fromFullscreenClose:!0}});const t=y.pathname.replace(/\/fullscreen$/,"");g(t||"/skill-tree",{replace:!0,state:{fromFullscreenClose:!0}})},[y,g]),Ue=t.useCallback(e=>{n.current=e},[]);t.useLayoutEffect(()=>{if(!C)return;const e=v?fe.current:he.current;if(!e)return;let t=requestAnimationFrame(()=>{const t=e.getBoundingClientRect();T(Math.max(0,Math.ceil(t.height)))});return()=>cancelAnimationFrame(t)},[C,v]),t.useEffect(()=>{let e=requestAnimationFrame($e);return()=>cancelAnimationFrame(e)},[$e]),t.useLayoutEffect(()=>{const e=n.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),a=Math.floor(t.height);r>0&&a>0&&(e.width!==r||e.height!==a)&&(e.width=r,e.height=a,I({w:r,h:a})),h(qe(e)),x(Ee(e))},[qe,Ee,R,G,B,u,d,k]),t.useEffect(()=>{Q.current||n.current&&k&&(Q.current=!0,Ye())},[k,Ye]),t.useEffect(()=>{const e=()=>{const e=n.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),a=Math.floor(t.height);if(r>0&&a>0&&(e.width!==r||e.height!==a)&&(e.width=r,e.height=a,I({w:r,h:a})),$e(),h(qe(e)),x(Ee(e)),C){const e=v?fe.current:he.current;if(e){const t=e.getBoundingClientRect();T(Math.max(0,Math.ceil(t.height)))}}};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[$e,qe,Ee,v,C]),t.useEffect(()=>{const e=n.current;if(!e)return;const t=t=>{const{effScale:r}=De(e);U(t,r)};return e.addEventListener("wheel",t,{passive:!1}),()=>{e.removeEventListener("wheel",t,{passive:!1})}},[De,U,v]),t.useEffect(()=>{if(!v)return;Z.current=document.activeElement;const e=document.documentElement,t=e.style.overflow;e.style.overflow="hidden",me.current?.focus?.();const r=e=>{if("Escape"!==e.key)return;if(re||de)return;const t=document.activeElement;j.current&&j.current.contains(t)&&Oe()};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r),e.style.overflow=t;const n=Z.current;n&&"function"==typeof n.focus&&n.focus()}},[v,re,de,Oe]),t.useEffect(()=>{if(!re)return;const e=e=>{const t=pe.current,r=me.current;t&&r&&(t.contains(e.target)||r.contains(e.target)||ne(!1))};return window.addEventListener("pointerdown",e,{capture:!0}),()=>window.removeEventListener("pointerdown",e,{capture:!0})},[re]),t.useEffect(()=>{n.current&&requestAnimationFrame(()=>{$e()})},[v,$e]),t.useEffect(()=>{const e=()=>{requestAnimationFrame(()=>{nt();const e=n.current;e&&($e(),h(qe(e)),x(Ee(e)))})},t="undefined"!=typeof window&&window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)"):null;t&&"function"==typeof t.addEventListener&&t.addEventListener("change",e);const r=new MutationObserver(t=>{for(const r of t)if("attributes"===r.type&&"class"===r.attributeName){e();break}});return"undefined"!=typeof document&&document.documentElement&&r.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>{t&&"function"==typeof t.removeEventListener&&t.removeEventListener("change",e),r.disconnect()}},[$e,qe,Ee]),t.useEffect(()=>{const e=()=>{requestAnimationFrame(()=>{const e=n.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),a=Math.floor(t.height);r>0&&a>0&&(e.width!==r||e.height!==a)&&(e.width=r,e.height=a,I({w:r,h:a})),nt(),$e(),h(qe(e)),x(Ee(e))})},t=t=>{e()},r=()=>{"undefined"!=typeof document&&"visible"===document.visibilityState&&e()},a=()=>{e()};return window.addEventListener("pageshow",t),document.addEventListener("visibilitychange",r),window.addEventListener("orientationchange",a),()=>{window.removeEventListener("pageshow",t),document.removeEventListener("visibilitychange",r),window.removeEventListener("orientationchange",a)}},[$e,qe,Ee]);const Ve=t.useCallback(e=>{const{effScale:t}=De(n.current),r=50/Math.max(t,.001);["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","+","=","-","0"].includes(e.key)&&e.preventDefault(),"ArrowLeft"===e.key?z({syntheticPan:{dx:-r,dy:0}},t):"ArrowRight"===e.key?z({syntheticPan:{dx:r,dy:0}},t):"ArrowUp"===e.key?z({syntheticPan:{dx:0,dy:-r}},t):"ArrowDown"===e.key?z({syntheticPan:{dx:0,dy:r}},t):"+"===e.key||"="===e.key?Re():"-"===e.key?Ge():"0"===e.key&&Ye()},[De,z,Ye,Re,Ge]),ze=e=>{X(!0);const t=n.current?.getBoundingClientRect();t&&(ee.current={x:e.clientX-t.left,y:e.clientY-t.top}),V(e)},Ke=e=>{if(W){const{effScale:t}=De(n.current);return z(e,t),void(n.current&&(n.current.style.cursor="grabbing"))}if(!n.current||!k)return;const t=n.current.getBoundingClientRect(),r=e.clientX-t.left,a=e.clientY-t.top,{effScale:s,effPanX:i,effPanY:l}=De(n.current),o=Fe(n.current);for(const d of o){const e=(d.x+i)*s+n.current.width/2,t=(d.y+l)*s+n.current.height/2,o=(d.radius||20)*s,c=Math.max(o,24),u=r-e,p=a-t;if(u*u+p*p<c*c)return m(d.medalId),void(n.current.style.cursor="pointer")}m(null),n.current.style.cursor="grab"},He=e=>{X(!1);const t=n.current,{effScale:r}=t?De(t):{effScale:te.current};K(e,r),m(null)},We=e=>{if(!n.current||!k)return;const t=n.current.getBoundingClientRect(),r=e.clientX-t.left,a=e.clientY-t.top,s=r-ee.current.x,i=a-ee.current.y;if(Math.sqrt(s*s+i*i)>5)return;const{effScale:l,effPanX:o,effPanY:d}=De(n.current),u=Fe(n.current);for(const m of u){const e=(m.x+o)*l+n.current.width/2,t=(m.y+d)*l+n.current.height/2,s=(m.radius||20)*l,i=Math.max(s,24),u=r-e,p=a-t;if(u*u+p*p<i*i)return c(m.medalId),void g(`/medals/${m.medalId}`,{state:{backgroundLocation:y}})}c(null)},Xe=e=>{if(!n.current||!k)return;const t=n.current.getBoundingClientRect(),r=e.clientX-t.left,a=e.clientY-t.top,s=r-ee.current.x,i=a-ee.current.y;if(Math.sqrt(s*s+i*i)>5)return;const{effScale:l,effPanX:o,effPanY:d}=De(n.current),u=Fe(n.current);for(const m of u){const e=(m.x+o)*l+n.current.width/2,t=(m.y+d)*l+n.current.height/2,s=(m.radius||20)*l,i=Math.max(s,24),u=r-e,p=a-t;if(u*u+p*p<i*i)return window.dispatchEvent(new CustomEvent("openAchievementForm",{detail:{medalId:m.medalId}})),c(m.medalId),void g(`/medals/${m.medalId}`,{state:{backgroundLocation:y}})}},Je=()=>{n.current&&function(e,t="skill-tree.png"){try{const r=document.createElement("a");r.href=e.toDataURL("image/png"),r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r)}catch(r){window.open(e.toDataURL("image/png"),"_blank")}}(n.current,`skill-tree-${(new Date).toISOString().split("T")[0]}.png`)};return a?r.jsxs("div",{className:"space-y-4",children:[r.jsx("div",{className:"card overflow-hidden overscroll-contain mt-2",role:"region","aria-label":"Trädvy canvas","aria-describedby":["skilltree-help",ue].filter(Boolean).join(" "),children:!v&&r.jsxs("div",{className:"relative",children:[r.jsx("canvas",{ref:Ue,"data-tour":"tree-canvas",role:"img","aria-label":"Interaktiv träd-vy-canvas","aria-describedby":["skilltree-help",C?ue:null,e].filter(Boolean).join(" "),"aria-keyshortcuts":"ArrowLeft ArrowRight ArrowUp ArrowDown = + - 0",tabIndex:0,onKeyDown:Ve,className:"w-full h-[60vh] sm:h-[600px] bg-background cursor-grab active:cursor-grabbing touch-none overscroll-contain select-none",onContextMenu:e=>e.preventDefault(),onPointerDown:ze,onPointerMove:Ke,onPointerUp:He,onPointerLeave:He,onPointerCancel:He,onClick:We,onDoubleClick:Xe}),r.jsx("div",{className:"pointer-events-none absolute inset-0",children:p.map(e=>r.jsxs(b.Fragment,{children:[r.jsx("span",{"aria-hidden":"true",style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,borderRadius:"9999px",background:"var(--color-background, #fff)",boxShadow:"0 0 0 3px var(--color-background, #fff)",zIndex:0}}),r.jsx("span",{role:"note","aria-label":`Kräver ${e.text}`,title:`Kräver ${e.text}`,className:["inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium shadow-sm","ready"===e.variant?"bg-primary text-white border-primary":"bg-primary/10 dark:bg-primary/20 text-foreground border-primary"].join(" "),style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,whiteSpace:"nowrap",zIndex:1},children:r.jsx("span",{"aria-hidden":"true",children:e.text})})]},e.id))}),r.jsx(kt,{laneLabels:f}),C&&r.jsx("div",{ref:he,"data-tour":"tree-legend",className:"absolute left-3 right-3 top-3 sm:left-4 sm:right-auto sm:top-4 z-[40] overflow-x-auto whitespace-nowrap rounded-md border border-border/60 bg-background/80 backdrop-blur-sm shadow-md px-3 py-1.5",style:{marginTop:"env(safe-area-inset-top)"},role:"note",id:ue,children:r.jsx(pt,{variant:"canvas"})}),r.jsx("div",{className:"absolute right-3 bottom-3 sm:right-4 sm:bottom-4 z-30",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"relative",children:[r.jsx("button",{type:"button",ref:me,"data-tour":"tree-actions","aria-haspopup":"menu","aria-controls":xe,"aria-expanded":re,onClick:()=>ne(e=>!e),className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Visa åtgärder","aria-label":"Visa åtgärder",children:r.jsx(Se,{name:"MoreVertical",className:"w-6 h-6"})}),re&&r.jsxs("div",{id:xe,ref:pe,role:"menu","aria-label":"Åtgärder",className:"absolute right-0 bottom-14 sm:bottom-16 w-56 rounded-md border border-border bg-background shadow-xl overflow-hidden",onKeyDown:e=>{if("Escape"===e.key)e.preventDefault(),ne(!1),me.current?.focus();else if("ArrowDown"===e.key||"ArrowUp"===e.key){const t=Array.from(e.currentTarget.querySelectorAll('[role="menuitem"]'));if(0===t.length)return;const r=t.indexOf(document.activeElement);let n=0;"ArrowDown"===e.key&&(n=r>=0?(r+1)%t.length:0),"ArrowUp"===e.key&&(n=r>=0?(r-1+t.length)%t.length:t.length-1),e.preventDefault(),t[n]?.focus()}},children:[r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),Ye()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Återställ vy"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),Je()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Exportera som PNG"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),Be()},"aria-pressed":C,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:C?"Dölj teckenförklaring":"Visa teckenförklaring"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),oe(e=>!e)},"aria-pressed":ie,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:ie?"Dölj årsbrickor":"Visa årsbrickor"}),r.jsxs("div",{role:"group","aria-label":"Visualisering",className:"border-t border-border/60",children:[r.jsx("button",{role:"menuitemradio","aria-checked":"columns"===w,type:"button",onClick:()=>{ne(!1),N("columns"),Ye()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Standard (kolumner)"}),r.jsx("button",{role:"menuitemradio","aria-checked":"timeline"===w,type:"button",onClick:()=>{ne(!1),N("timeline"),Ye()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Tidslinje"})]}),(!be||je)&&r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),Me(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Spara"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),ce(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visa hjälp"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),g("/skill-tree/fullscreen",{replace:!0,state:{backgroundLocation:y}})},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","aria-haspopup":"dialog","aria-controls":"skilltree-fullscreen",children:"Öppna helskärm"})]})]})}),r.jsx("div",{className:"absolute left-3 bottom-3 sm:left-4 sm:bottom-4 z-30",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"inline-flex flex-col gap-2","data-tour":"zoom-controls",children:[r.jsx("button",{type:"button","aria-label":"Zooma in",onClick:Re,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma in",children:r.jsx(Se,{name:"Plus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Zooma ut",onClick:Ge,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma ut",children:r.jsx(Se,{name:"Minus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Återställ vy",onClick:Ye,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Återställ vy",children:r.jsx(Se,{name:"RotateCcw",className:"w-6 h-6"})})]})}),r.jsx("p",{id:"skilltree-help",className:"sr-only",children:"💡 Dra för att panorera • Nyp för att zooma • Klicka på märken för detaljer"}),de&&r.jsx("div",{role:"dialog","aria-modal":"false","aria-labelledby":"skilltree-help-title",className:"absolute left-1/2 bottom-24 -translate-x-1/2 w-[min(92vw,28rem)] rounded-md border border-border bg-background text-foreground shadow-xl p-4 z-30",children:r.jsxs("div",{className:"flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsx("h3",{id:"skilltree-help-title",className:"text-sm font-semibold mb-1",children:"Hjälp"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Dra för att panorera • Nyp eller använd +/− för att zooma • 0 återställer vy • Klicka för detaljer"})]}),r.jsx("button",{type:"button","aria-label":"Stäng hjälp",className:"btn btn-muted min-h-[44px] px-3 py-2",onClick:()=>ce(!1),children:"Stäng"})]})})]})}),v&&r.jsxs("div",{id:"skilltree-fullscreen",ref:j,className:"fixed inset-0 z-50 bg-background overscroll-contain flex flex-col",role:"dialog","aria-modal":"true","aria-label":"Helskärms träd-vy",children:[r.jsx("h2",{className:"sr-only",children:"Märken"}),r.jsx("div",{className:"absolute right-3 bottom-3 sm:right-4 sm:bottom-4 z-[60]",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"relative",children:[r.jsx("button",{type:"button",ref:me,"data-tour":"tree-actions","aria-haspopup":"menu","aria-controls":xe,"aria-expanded":re,onClick:()=>ne(e=>!e),className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Visa åtgärder","aria-label":"Visa åtgärder",children:r.jsx(Se,{name:"MoreVertical",className:"w-6 h-6"})}),re&&r.jsxs("div",{id:xe,ref:pe,role:"menu","aria-label":"Åtgärder",className:"absolute right-0 bottom-14 sm:bottom-16 w-56 rounded-md border border-border bg-background shadow-xl overflow-hidden",onKeyDown:e=>{if("Escape"===e.key)e.preventDefault(),ne(!1),me.current?.focus();else if("ArrowDown"===e.key||"ArrowUp"===e.key){const t=Array.from(e.currentTarget.querySelectorAll('[role="menuitem"]'));if(0===t.length)return;const r=t.indexOf(document.activeElement);let n=0;"ArrowDown"===e.key&&(n=r>=0?(r+1)%t.length:0),"ArrowUp"===e.key&&(n=r>=0?(r-1+t.length)%t.length:t.length-1),e.preventDefault(),t[n]?.focus()}},children:[r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),Ye()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Återställ vy"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),Je()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Exportera som PNG"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),Be()},"aria-pressed":C,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:C?"Dölj teckenförklaring":"Visa teckenförklaring"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),oe(e=>!e)},"aria-pressed":ie,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:ie?"Dölj årsbrickor":"Visa årsbrickor"}),r.jsxs("div",{role:"group","aria-label":"Visualisering",className:"border-t border-border/60",children:[r.jsx("button",{role:"menuitemradio","aria-checked":"columns"===w,type:"button",onClick:()=>{ne(!1),N("columns"),Ye()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Standard (kolumner)"}),r.jsx("button",{role:"menuitemradio","aria-checked":"timeline"===w,type:"button",onClick:()=>{ne(!1),N("timeline"),Ye()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Tidslinje"})]}),(!be||je)&&r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),Me(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Spara framsteg"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ne(!1),ce(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visa hjälp"}),r.jsx("button",{role:"menuitem",type:"button",ref:J,onClick:()=>{ne(!1),Oe()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Stäng helskärm"})]})]})}),r.jsx("div",{className:"absolute left-3 bottom-3 sm:left-4 sm:bottom-4 z-[60]",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"inline-flex flex-col gap-2","data-tour":"zoom-controls",children:[r.jsx("button",{type:"button","aria-label":"Zooma in",onClick:Re,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma in",children:r.jsx(Se,{name:"Plus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Zooma ut",onClick:Ge,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma ut",children:r.jsx(Se,{name:"Minus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Återställ vy",onClick:Ye,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Återställ vy",children:r.jsx(Se,{name:"RotateCcw",className:"w-6 h-6"})})]})}),_e&&r.jsx("div",{role:"region","aria-label":"Onboarding",className:"absolute left-3 right-3 z-[50]",style:{marginTop:"env(safe-area-inset-top)",top:Math.max(12,A+12)},children:r.jsxs("div",{className:"rounded-md border border-border bg-background/80 backdrop-blur-sm shadow-md p-3",children:[r.jsx("p",{className:"text-sm text-foreground mb-2",children:"Spara dina framsteg?"}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:()=>{try{window.localStorage.setItem("app:onboardingChoice","saved")}catch{}ke(!0),Me(!0)},children:"Skapa profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>{try{window.localStorage.setItem("app:onboardingChoice","guest")}catch{}ke(!0),ge()},children:"Fortsätt som gäst"}),r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:()=>ke(!0),children:"Inte nu"})]})]})}),v&&je&&!_e&&r.jsxs("div",{className:"absolute left-1/2 -translate-x-1/2 z-[60] flex items-center gap-2",style:{bottom:"calc(env(safe-area-inset-bottom) + 16px)"},role:"group","aria-label":"Snabbåtgärder (gäst)",children:[r.jsx("button",{type:"button",onClick:()=>Pe(!0),className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 backdrop-blur-sm px-3 py-1.5 text-sm shadow-md min-h-[36px]","aria-label":"Återställ alla",title:"Återställ alla",children:"Återställ alla"}),r.jsx("button",{type:"button",onClick:()=>Me(!0),className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 backdrop-blur-sm px-3 py-1.5 text-sm shadow-md min-h-[36px]","aria-label":"Spara framsteg",title:"Spara framsteg",children:"Spara framsteg"})]}),r.jsx("div",{className:"flex-1",children:r.jsxs("div",{className:"relative h-full",children:[r.jsx("canvas",{ref:Ue,"data-tour":"tree-canvas",role:"img","aria-label":"Interaktiv träd-vy-canvas","aria-describedby":["skilltree-help-fs",C?"skilltree-legend-fs":null,e].filter(Boolean).join(" "),"aria-keyshortcuts":"ArrowLeft ArrowRight ArrowUp ArrowDown = + - 0",tabIndex:0,onKeyDown:Ve,className:"w-full h-full bg-background cursor-grab active:cursor-grabbing touch-none overscroll-contain select-none",onContextMenu:e=>e.preventDefault(),onPointerDown:ze,onPointerMove:Ke,onPointerUp:He,onPointerLeave:He,onPointerCancel:He,onClick:We,onDoubleClick:Xe}),C&&r.jsx("div",{ref:fe,"data-tour":"tree-legend",className:"absolute left-3 right-3 top-3 sm:left-4 sm:right-auto sm:top-4 z-[40] overflow-x-auto whitespace-nowrap rounded-md border border-border/60 bg-background/80 backdrop-blur-sm shadow-md px-3 py-1.5",style:{marginTop:"env(safe-area-inset-top)"},role:"note",id:"skilltree-legend-fs",children:r.jsx(pt,{variant:"canvas"})}),r.jsx("div",{className:"pointer-events-none absolute inset-0",children:p.map(e=>r.jsxs(b.Fragment,{children:[r.jsx("span",{"aria-hidden":"true",style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,borderRadius:"9999px",background:"var(--color-background, #fff)",boxShadow:"0 0 0 3px var(--color-background, #fff)",zIndex:0}}),r.jsx("span",{role:"note","aria-label":`Kräver ${e.text}`,title:`Kräver ${e.text}`,className:["inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium shadow-sm","ready"===e.variant?"bg-primary text-white border-primary":"bg-primary/10 dark:bg-primary/20 text-foreground border-primary"].join(" "),style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,whiteSpace:"nowrap",zIndex:1},children:r.jsx("span",{"aria-hidden":"true",children:e.text})})]},e.id))}),r.jsx(kt,{laneLabels:f})]})}),r.jsx("p",{id:"skilltree-help-fs",className:"sr-only",children:"💡 Dra för att panorera • Nyp för att zooma • Klicka på märken för detaljer"}),de&&r.jsx("div",{role:"dialog","aria-modal":"false","aria-labelledby":"skilltree-help-title-fs",className:"absolute left-1/2 bottom-24 -translate-x-1/2 w-[min(92vw,28rem)] rounded-md border border-border bg-background text-foreground shadow-xl p-4 z-[70]",children:r.jsxs("div",{className:"flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsx("h3",{id:"skilltree-help-title-fs",className:"text-sm font-semibold mb-1",children:"Hjälp"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Dra för att panorera • Nyp för att zooma • Klicka för detaljer"})]}),r.jsx("button",{type:"button","aria-label":"Stäng hjälp",className:"btn btn-muted min-h-[44px] px-3 py-2",onClick:()=>ce(!1),children:"Stäng"})]})})]}),r.jsx(ht,{id:"reset-confirm-skilltree",open:Te,onCancel:()=>Pe(!1),onConfirm:async()=>{Pe(!1),await ve()},title:"Återställa allt?",description:"Detta rensar alla tillfälliga framsteg (märken och förkunskaper) i gästläget. Denna åtgärd går inte att ångra.",confirmLabel:"Återställ",cancelLabel:"Avbryt",variant:"danger"}),r.jsx(Ae,{id:"save-progress-picker-canvas",mode:"picker",open:Ce,onClose:()=>Me(!1),forceCreate:!0,convertGuest:!0})]}):r.jsx("div",{className:"flex items-center justify-center h-96",role:"status","aria-live":"polite","aria-busy":"true",children:r.jsx("p",{className:"text-text-secondary",children:"Laddar märken..."})})}function Ct(e,t){try{return window.localStorage.setItem(e,t),!0}catch{return!1}}function Mt({idPrefix:e="default"}){const{resetCurrentProfileData:n}=se(),[a,s]=t.useState(!1),[i,l]=t.useState(!1);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"card p-4",role:"status","aria-live":"polite",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(Se,{name:"Compass",className:"w-6 h-6 shrink-0"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"mb-2 text-muted-foreground",children:"Gästläge: framsteg sparas tillfälligt."}),r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{type:"button",className:"btn btn-primary",onClick:()=>s(!0),children:[r.jsx(Se,{name:"Save",className:"w-4 h-4"}),"Spara"]}),r.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>l(!0),children:[r.jsx(Se,{name:"RotateCcw",className:"w-4 h-4"}),"Återställ"]})]})]})]})}),r.jsx(ht,{id:`reset-confirm-${e}`,open:i,onCancel:()=>l(!1),onConfirm:async()=>{l(!1),await n()},title:"Återställa allt?",description:"Detta rensar alla tillfälliga framsteg (märken och förkunskaper) i gästläget. Denna åtgärd går inte att ångra.",confirmLabel:"Återställ",cancelLabel:"Avbryt",variant:"danger"}),r.jsx(Ae,{id:`save-progress-picker-${e}`,mode:"picker",open:a,onClose:()=>s(!1),forceCreate:!0,convertGuest:!0})]})}function At({id:e="profile-picker-inline"}){const{currentProfile:n}=se(),[a,s]=t.useState(!1);return n?null:r.jsxs("div",{className:"card p-4",role:"region","aria-label":"Profil krävs",children:[r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("div",{"aria-hidden":"true",className:"text-xl leading-none",children:"👤"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"text-foreground mb-2",children:"Välj eller skapa en profil."}),r.jsx("button",{type:"button",onClick:()=>s(!0),className:"btn btn-primary min-h-[44px]","aria-haspopup":"dialog","aria-controls":e,children:"Profil"})]})]}),r.jsx(Ae,{id:e,mode:"picker",open:a,onClose:()=>s(!1)})]})}function Tt({idPrefix:e="default",onChooseGuest:t,onChooseSaved:n}){const a=`onboarding-title-${e}`;return r.jsxs("div",{className:"card p-4",role:"dialog","aria-modal":"true","aria-labelledby":a,children:[r.jsx("h2",{id:a,className:"section-title mb-2",children:"Hur vill du börja?"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Utforska märken direkt eller skapa en profil för att spara ditt arbete."}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsxs("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:t,children:[r.jsx(Se,{name:"Compass",className:"w-4 h-4"}),"Utforska utan att spara (Gästläge)"]}),r.jsxs("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:n,children:[r.jsx(Se,{name:"UserPlus",className:"w-4 h-4"}),"Skapa profil"]})]})]})}function Pt({idPrefix:e="default",promptId:n}){const{isProfileLoading:a,showOnboarding:s,isGuest:i,chooseGuest:l,chooseSaved:o}=function(){const{currentProfile:e,startExplorerMode:r,hydrated:n}=se(),[a,s]=t.useState(!1),i=t.useMemo(()=>{if("undefined"==typeof window)return null;try{return window.localStorage.getItem("app:onboardingChoice")}catch{return null}},[]),l=!n||void 0===e;return{isProfileLoading:l,showOnboarding:!(l||e||i||a),isGuest:Boolean(e?.isGuest),chooseGuest:t.useCallback(()=>{Ct("app:onboardingChoice","guest"),r()},[r]),chooseSaved:t.useCallback(()=>{Ct("app:onboardingChoice","saved"),s(!0)},[])}}();if(a)return null;if(s)return r.jsx(Tt,{idPrefix:e,onChooseGuest:l,onChooseSaved:o});if(i)return r.jsx(Mt,{idPrefix:e});const d=n||`profile-picker-${e}`;return r.jsx(At,{id:d})}function It(){const e=t.useContext(fe);if(!e)throw new Error("useOnboardingTour must be used within OnboardingTourProvider");return e}const _t="whatsnew:lastSeen";function Dt(){return xe?.version}function Ft(){try{return localStorage.getItem(_t)}catch{return null}}function qt(){if(xe?.env)return"production"===xe.env;try{const e="undefined"!=typeof window&&window.location&&window.location.hostname?window.location.hostname:"";return!!e&&!("localhost"===e||"127.0.0.1"===e)}catch{return!1}}function Et(){const{currentProfile:e,hydrated:n}=se(),a=!n||void 0===e,s=l(),o=i(),d=It();t.useEffect(()=>{if("undefined"==typeof window)return;const e=window.innerWidth<768,t="/skill-tree"===o.pathname,r=Boolean(o.state?.fromFullscreenClose);e&&t&&!r&&s("/skill-tree/fullscreen",{replace:!0,state:{backgroundLocation:o}})},[s,o]);const c=t.useCallback(()=>{d?.open||d.start("tree-view")},[d]);return t.useEffect(()=>{if(a)return;if(!("/skill-tree"===o.pathname||"/skill-tree/fullscreen"===o.pathname))return;if(d?.open)return;let e=null;try{e=sessionStorage.getItem(ge)}catch{e=null}if("tree-view"!==e)return;try{sessionStorage.removeItem(ge)}catch{}const t=setTimeout(()=>{c()},100);return()=>clearTimeout(t)},[a,o.pathname,d,c]),t.useEffect(()=>{if(a)return;if(!("/skill-tree"===o.pathname||"/skill-tree/fullscreen"===o.pathname))return;if(d?.open)return;try{if("tree-view"===sessionStorage.getItem(ge))return}catch{}if(!d?.canAutoStart?.("tree-view"))return;if(qt()){const e=Dt();if(Ft()!==e)return}const e=setTimeout(()=>{c()},100);return()=>clearTimeout(e)},[a,o.pathname,d,c]),a?null:r.jsxs("div",{className:"space-y-6",children:[r.jsx(Pt,{idPrefix:"skilltree",promptId:"profile-picker-skill-tree"}),r.jsx("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:r.jsxs("div",{className:"flex items-baseline gap-3 flex-wrap",children:[r.jsx("h1",{className:"text-3xl font-bold text-text-primary mb-1 sm:mb-0",children:"Trädvy"}),r.jsx("button",{type:"button",onClick:c,className:"text-sm underline hover:no-underline text-muted-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded",children:"Visa guide"})]})}),r.jsx(St,{})]})}const $t="medal-app-current-filters";function Yt(e){return(e||"").toString().toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g,"")}function Lt(e,t){return t?t.unlocked?.some(t=>t.medalId===e)?"unlocked":t.eligible?.some(t=>t.medalId===e)?"eligible":t.available?.some(t=>t.medalId===e)?"available":"locked":"locked"}function Rt({value:e,onChange:n,suggestions:a,onSuggestionSelect:s,placeholder:i="Search medals…",inputRef:l}){const[o,d]=t.useState(!1);return r.jsxs("div",{className:"relative",children:[r.jsxs("div",{className:"relative",children:[r.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground","aria-hidden":!0,children:"🔍"}),r.jsx("input",{type:"text",ref:l,value:e,onChange:e=>n?.(e.target.value),onFocus:()=>{(a||[]).length>0&&d(!0)},onBlur:()=>setTimeout(()=>d(!1),100),placeholder:i,className:"input pl-8 pr-12 min-h-[44px]","aria-label":"Search medals",role:"combobox","aria-autocomplete":"list","aria-expanded":o,"aria-controls":"search-suggestions","aria-haspopup":"listbox","data-tour":"medals-search"}),e?r.jsx("button",{type:"button",onClick:()=>n?.(""),className:"absolute right-2 top-1/2 -translate-y-1/2 btn btn-muted h-9 w-9","aria-label":"Clear search",children:"✕"}):null]}),o&&(a||[]).length>0&&r.jsx("div",{id:"search-suggestions",role:"listbox","aria-label":"Search suggestions",className:"absolute top-full left-0 right-0 mt-1 bg-bg-secondary border border-border rounded-lg shadow-lg z-10 text-foreground",children:a.map((e,t)=>r.jsx("button",{type:"button",role:"option",onClick:()=>(e=>{s?.(e),d(!1)})(e),className:"w-full text-left px-4 py-2 min-h-[44px] hover:bg-background border-b border-border last:border-b-0 text-sm",children:e},`${e}-${t}`))})]})}function Gt({filters:e,onFilterChange:t,medalTypes:n,tiers:a,hasActiveFilters:s,resultCount:i,onClearAll:l,sortBy:o,onSortChange:d}){return r.jsxs("div",{className:"card flex flex-col overflow-hidden max-h-[80dvh] sm:max-h-none","data-tour":"filter-panel",children:[r.jsxs("div",{className:"p-4 flex justify-between items-center",children:[r.jsx("h3",{className:"font-bold text-foreground",children:"Filter"}),s&&r.jsx("button",{type:"button",onClick:l,className:"btn btn-muted text-sm min-h-[44px]",children:"Återställ alla"})]}),r.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto overscroll-contain p-4 pt-0",children:r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[r.jsxs("div",{className:"col-span-2 md:col-span-3",children:[r.jsx("label",{htmlFor:"sortSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Sortering"}),r.jsxs("select",{id:"sortSelect",value:o||"name",onChange:e=>d?.(e.target.value),className:"select",children:[r.jsx("option",{value:"name",children:"Namn"}),r.jsx("option",{value:"type",children:"Typ"}),r.jsx("option",{value:"tier",children:"Valör"}),r.jsx("option",{value:"status",children:"Status"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"statusSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Status"}),r.jsxs("select",{id:"statusSelect",value:e.status||"",onChange:e=>t("status",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"unlocked",children:"Upplåst"}),r.jsx("option",{value:"eligible",children:"Kvalificerad"}),r.jsx("option",{value:"available",children:"Tillgänglig"}),r.jsx("option",{value:"locked",children:"Låst"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"tierSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Valör"}),r.jsxs("select",{id:"tierSelect",value:e.tier||"",onChange:e=>t("tier",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),a.map(e=>r.jsx("option",{value:e,children:e.charAt(0).toUpperCase()+e.slice(1).replace(/_/g," ")},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"typeSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Typ"}),r.jsxs("select",{id:"typeSelect",value:e.type||"",onChange:e=>t("type",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),n.map(e=>r.jsx("option",{value:e,children:e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"weaponGroupSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Vapengrupp"}),r.jsxs("select",{id:"weaponGroupSelect",value:e.weaponGroup||"",onChange:e=>t("weaponGroup",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"reviewStatusSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Granskningsstatus"}),r.jsxs("select",{id:"reviewStatusSelect",value:e.reviewState||"",onChange:e=>t("reviewState",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"reviewed",children:"Granskad"}),r.jsx("option",{value:"under_review",children:"Under granskning"})]})]})]})}),r.jsxs("div",{className:"px-4 pt-4 border-t border-border text-sm text-muted-foreground flex-none sm:pb-4 pb-[env(safe-area-inset-bottom)]","aria-live":"polite",children:[i," märke(n) matchar filtren"]})]})}function Bt({currentFilters:e,onApplyPreset:n}){const{presets:a,savePreset:s,deletePreset:i,reload:l}=function(){const e="medal-app-filter-presets",[r,n]=t.useState(()=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):[]}catch(t){return console.error("Failed to load presets:",t),[]}}),a=t.useCallback(()=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):[]}catch(t){return console.error("Failed to load presets:",t),[]}},[]),s=t.useCallback(()=>{n(a())},[a]);return{presets:r,savePreset:t.useCallback((t,r)=>{try{const s=[...a(),{name:t,filters:r,createdAt:(new Date).toISOString()}];localStorage.setItem(e,JSON.stringify(s)),n(s)}catch(s){console.error("Failed to save preset:",s)}},[a]),deletePreset:t.useCallback(t=>{try{const r=a();t>=0&&t<r.length&&(r.splice(t,1),localStorage.setItem(e,JSON.stringify(r)),n(r))}catch(r){console.error("Failed to delete preset:",r)}},[a]),reload:s}}(),[o,d]=t.useState("");return r.jsxs("div",{className:"card p-4",children:[r.jsx("h3",{className:"font-bold text-foreground mb-3",children:"Filter presets"}),r.jsx("div",{className:"mb-4",children:r.jsxs("div",{className:"flex gap-2",children:[r.jsx("input",{type:"text",value:o,onChange:e=>d(e.target.value),placeholder:"Preset-namn (tex, 'Mina Favoriter')",className:"input"}),r.jsx("button",{type:"button",onClick:()=>{o.trim()&&(s(o.trim(),e),d(""),l())},disabled:!o.trim(),className:"btn btn-primary text-sm disabled:opacity-50",children:"Spara"})]})}),a.length>0&&r.jsx("div",{className:"space-y-2",children:a.map((e,t)=>r.jsxs("div",{className:"flex justify-between items-center p-3 bg-background border border-border rounded",children:[r.jsx("button",{type:"button",onClick:()=>n?.(e.filters),className:"btn btn-muted text-sm flex-1 text-left",children:e.name}),r.jsx("button",{type:"button",onClick:()=>(e=>{i(e),l()})(t),className:"btn btn-muted text-sm","aria-label":`Ta bort preset ${e.name}`,children:"Ta bort"})]},`${e.name}-${t}`))})]})}function Ot({active:e,onClick:t,children:n,ariaLabel:a,dataTour:s}){return r.jsx("button",{type:"button",onClick:t,"aria-pressed":e?"true":"false","aria-label":a,"data-tour":s,className:["inline-flex items-center px-4 py-2 rounded-full border text-sm min-h-[44px] shrink-0","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",e?"bg-primary/10 text-primary border-primary dark:bg-primary/20":"bg-transparent text-text-secondary border-border hover:bg-bg-secondary"].join(" "),children:n})}function Ut({filters:e,onToggle:t,onOpenFilters:n,activeCount:a=0,controlsId:s,className:i=""}){const l=e.status||null;return r.jsxs("div",{className:["flex items-center gap-2 overflow-x-auto py-2 min-w-0",i].join(" "),role:"toolbar","aria-label":"Snabbfilter",children:[r.jsx(Ot,{active:"unlocked"===l,onClick:()=>t("status","unlocked"),ariaLabel:"Filtrera på Upplåst",dataTour:"chip-unlocked",children:"Upplåst"}),r.jsx(Ot,{active:"eligible"===l,onClick:()=>t("status","eligible"),ariaLabel:"Filtrera på Kvalificerad",children:"Kvalificerad"}),r.jsx(Ot,{active:"available"===l,onClick:()=>t("status","available"),ariaLabel:"Filtrera på Tillgänglig",children:"Tillgänglig"}),r.jsx(Ot,{active:"locked"===l,onClick:()=>t("status","locked"),ariaLabel:"Filtrera på Låst",children:"Låst"}),r.jsx("span",{className:"mx-2 h-5 w-px bg-border shrink-0 lg:hidden","aria-hidden":"true"}),r.jsx("button",{type:"button",onClick:n,"aria-haspopup":"dialog","aria-controls":s,"data-tour":"open-filters",className:"inline-flex items-center px-4 py-2 rounded-full border text-sm min-h-[44px] shrink-0 lg:hidden\n                   bg-background text-foreground border-border hover:bg-bg-secondary\n                   focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",children:a>0?`Filter (${a})`:"Filter"})]})}function Vt({data:e,index:t,style:n}){const{medals:a,onSelect:s,statusesById:i}=e,l=a[t],o="function"==typeof l?.isPlaceholder?l.isPlaceholder():"placeholder"===l?.status,d=!o&&("function"==typeof l?.isUnderReview?l.isUnderReview():"under_review"===l?.status),c=i?.[l.id],u=c?.status??"locked",m=o?"placeholder":u,p=!o&&"unlocked"===u,h=(()=>{if(!p)return null;const e=c?.unlockedDate;if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t.getFullYear()})(),f=l.displayName||l.name,x=o?`${f} • Plats­hållare`:`${f}${d?" • Under granskning":""}${p&&h?" • Upplåst "+h:""}`;return r.jsxs("div",{role:"listitem",tabIndex:0,onClick:()=>s?.(l),onKeyDown:e=>{"Enter"===e.key&&s?.(l)},className:["flex items-center gap-3 px-3 py-2 hover:bg-bg-secondary focus-visible:bg-bg-secondary cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary",o?"bg-placeholder-subtle border-l-2 border-placeholder":""].join(" "),style:n,"aria-label":x,"data-tour":0===t?"medal-row-0":void 0,children:[r.jsxs("div",{className:"relative w-10 h-10 flex items-center justify-center rounded bg-bg-secondary flex-shrink-0","aria-hidden":"true",children:[r.jsx(mt,{status:m,className:"w-2/3 h-2/3"}),!o&&d&&r.jsx("span",{className:"pill-flag pointer-events-none","aria-hidden":"true",children:r.jsx(mt,{status:"review",className:"w-2.5 h-2.5 text-white"})})]}),r.jsx("div",{className:"min-w-0",children:r.jsxs("div",{className:"font-medium text-text-primary flex items-start gap-x-2",children:[r.jsx("span",{className:"clamp-2 min-w-0",children:f}),o&&r.jsx("span",{className:"status-badge status--placeholder",children:"Plats­hållare"})]})})]})}function zt({height:e,itemCount:n,itemSize:a,width:s="100%",itemData:i,children:l}){const o=t.useRef(null),[d,c]=t.useState(0),u=n*a,m=Math.max(0,Math.floor(d/a)-4),p=Math.ceil(e/a)+8,h=Math.min(n,m+p),f=[];for(let t=m;t<h;t++){const e=l({index:t,style:{position:"absolute",top:t*a,height:a,width:"100%"},data:i});f.push(b.cloneElement(e,{key:t}))}return r.jsx("div",{ref:o,className:"relative overflow-y-auto",style:{height:e,width:s,WebkitOverflowScrolling:"touch"},onScroll:e=>{c(e.currentTarget.scrollTop)},role:"list","aria-label":"Medal list",children:r.jsx("div",{style:{height:u,position:"relative"},children:f})})}function Kt({medals:e,onSelect:n,height:a=800,itemSize:s=72,statusesById:i}){const l=t.useMemo(()=>({medals:e,onSelect:n,statusesById:i}),[e,n,i]),o=e?.length||0,d=t.useCallback(e=>r.jsx(Vt,{...e}),[]);return r.jsx("div",{className:"border border-border rounded-md overflow-hidden",children:r.jsx(zt,{height:a,itemCount:o,itemSize:s,width:"100%",itemData:l,children:d})})}function Ht(){const{medalDatabase:e}=ae(),n=l(),a=i(),s=le(),[o,d]=t.useState("name"),[c,u]=t.useState(!1),m=t.useRef(null),[p,h]=g(),{currentProfile:f,hydrated:x}=se(),b=!x||void 0===f,y=It(),[v,j]=t.useState(600);t.useEffect(()=>{const e=()=>j(Math.max(360,Math.round(.7*window.innerHeight)));return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const w=t.useMemo(()=>e?.getAllMedals()||[],[e]),{filters:N,setFilter:k,setFilters:S,clearAllFilters:C,hasActiveFilters:M}=function(e,r={}){const[n,a]=t.useState(()=>{try{const e=localStorage.getItem($t);return{status:null,tier:null,type:null,weaponGroup:null,search:"",...(e?JSON.parse(e):null)||{},...r}}catch{return{status:null,tier:null,type:null,weaponGroup:null,search:"",...r}}});t.useEffect(()=>{try{localStorage.setItem($t,JSON.stringify(n))}catch{}},[n]);const s=t.useMemo(()=>Array.isArray(e)?e.filter(e=>{if(n.tier&&e.tier!==n.tier)return!1;if(n.type&&e.type!==n.type)return!1;if(n.weaponGroup&&e.weaponGroup!==n.weaponGroup)return!1;if(n.search){const t=n.search.toLowerCase();if(!((e.displayName||"").toLowerCase().includes(t)||(e.name||"").toLowerCase().includes(t)||(e.type||"").toLowerCase().includes(t)))return!1}return!0}):[],[e,n]),i=t.useCallback((e,t)=>{a(r=>({...r,[e]:t}))},[]),l=t.useCallback(e=>{a(t=>({...t,...e||{}}))},[]),o=t.useCallback(()=>{a({status:null,tier:null,type:null,weaponGroup:null,search:""})},[]),d=t.useMemo(()=>Object.values(n).some(e=>null!==e&&""!==e),[n]);return{filters:n,filteredMedals:s,setFilter:i,setFilters:l,clearAllFilters:o,hasActiveFilters:d}}(w),{query:A,setQuery:T,suggestions:P}=function(e=[]){const[r,n]=t.useState(""),a=t.useMemo(()=>e.map(e=>({ref:e,haystack:Yt([e.displayName||e.name||"",e.type||e.medals_type||"",e.tier||"",e.id].filter(Boolean).join(" "))})),[e]),s=t.useMemo(()=>{const t=Yt(r).trim();return t?a.filter(e=>e.haystack.includes(t)).map(e=>e.ref):e},[a,r,e]),i=t.useMemo(()=>{if(!Yt(r).trim())return[];const e=new Set;for(const t of s.slice(0,10)){const r=t.displayName||t.name;r&&!e.has(r)&&e.add(r)}return Array.from(e)},[s,r]);return{query:r,setQuery:n,results:s,suggestions:i}}(w);t.useEffect(()=>{const e=e=>{if("/"===e.key&&!e.metaKey&&!e.ctrlKey&&!e.altKey){const t=(document.activeElement?.tagName||"").toLowerCase();"input"!==t&&"textarea"!==t&&(e.preventDefault(),m.current?.focus())}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),t.useEffect(()=>{const e=e=>{const t=p.get(e);return t&&t.length?t:null},t={status:e("status"),type:e("type"),tier:e("tier"),weaponGroup:e("weaponGroup"),reviewState:e("reviewState")},r=e("search")||"",n=e("sort")||"name",a=Object.fromEntries(Object.entries(t).filter(([,e])=>null!=e));Object.keys(a).length&&S(a),r&&(T(r),k("search",r)),d(n)},[]),t.useEffect(()=>{const e=new URLSearchParams;N.status&&e.set("status",N.status),N.type&&e.set("type",N.type),N.tier&&e.set("tier",N.tier),N.weaponGroup&&e.set("weaponGroup",N.weaponGroup),N.reviewState&&e.set("reviewState",N.reviewState),A&&e.set("search",A),o&&"name"!==o&&e.set("sort",o);e.toString()!==p.toString()&&h(e,{replace:!0})},[N,A,o,h,p]);const I=t.useMemo(()=>[...new Set(w.map(e=>e.type))].filter(Boolean),[w]),_=t.useMemo(()=>[...new Set(w.map(e=>e.tier))].filter(Boolean),[w]),D=t.useMemo(()=>Object.entries(N).reduce((e,[t,r])=>"search"!==t&&r?e+1:e,0),[N]),F=t.useCallback((e,t)=>{k(e,N[e]===t?null:t)},[N,k]),q=t.useMemo(()=>{const e=Object.create(null);if(!s)return e;const t=(t,r)=>{(t||[]).forEach(t=>{e[t.medalId]={...t,status:r}})};return t(s.locked,"locked"),t(s.available,"available"),t(s.eligible,"eligible"),t(s.unlocked,"unlocked"),e},[s]),E=t.useMemo(()=>{const e={...N,search:A},t=function(e,t,r={}){if(!Array.isArray(e))return[];const n=(r.search||"").toLowerCase();return e.filter(e=>{const a=Lt(e.id,t);if(r.status&&a!==r.status)return!1;if(r.tier&&e.tier!==r.tier)return!1;if(r.type&&e.type!==r.type)return!1;if(r.weaponGroup&&e.weaponGroup!==r.weaponGroup)return!1;const s=!0!==e.reviewed;return("reviewed"!==r.reviewState||!s)&&(!("under_review"===r.reviewState&&!s)&&!(n&&!((e.displayName||"").toLowerCase().includes(n)||(e.name||"").toLowerCase().includes(n)||(e.type||"").toLowerCase().includes(n))))})}(w,s,e);return function(e,t="name",r){const n=Array.isArray(e)?[...e]:[];switch(t){case"name":return n.sort((e,t)=>(e.displayName||"").localeCompare(t.displayName||""));case"type":return n.sort((e,t)=>(e.type||"").localeCompare(t.type||""));case"tier":{const e={bronze:0,silver:1,gold:2,star_1:3,star_2:4,star_3:5};return n.sort((t,r)=>(e[t.tier]??99)-(e[r.tier]??99))}case"status":{const e={unlocked:0,eligible:1,available:2,locked:3};return n.sort((t,n)=>(e[Lt(t.id,r)]??99)-(e[Lt(n.id,r)]??99))}default:return n}}(t,o,s)},[w,s,N,A,o]),$=t.useMemo(()=>E.some(e=>!0!==e.reviewed),[E]),Y=t.useCallback(()=>{if(y?.open)return;(M||""!==A||"name"!==o||c)&&(C(),T(""),k("search",""),d("name"),u(!1)),y.start("medals")},[y,M,A,o,c,C,T,k]);return t.useEffect(()=>{if(b)return;if("/medals"!==a.pathname)return;if(y?.open)return;let e=null;try{e=sessionStorage.getItem(ge)}catch{e=null}if("medals"===e){try{sessionStorage.removeItem(ge)}catch{}Y()}},[b,a.pathname,y,Y]),t.useEffect(()=>{if(!b&&"/medals"===a.pathname&&!y?.open){try{if("medals"===sessionStorage.getItem(ge))return}catch{}if(y?.canAutoStart?.()){if(qt()){const e=Dt();if(Ft()!==e)return}Y()}}},[b,a.pathname,y,Y]),b?null:e?r.jsxs("div",{className:"space-y-6",children:[r.jsx(Pt,{idPrefix:"medals-list",promptId:"profile-picker-medals-list"}),r.jsxs("div",{className:"flex flex-col lg:flex-row lg:justify-between lg:items-center gap-3",children:[r.jsxs("div",{className:"flex items-baseline gap-3 flex-wrap",children:[r.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Märken"}),r.jsx("button",{type:"button",onClick:Y,className:"text-sm underline hover:no-underline text-muted-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded",children:"Visa guide"})]}),r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsxs("div",{className:"text-sm text-muted-foreground","aria-live":"polite",children:[E.length," märken",M&&r.jsxs(r.Fragment,{children:[" · ",r.jsx("button",{type:"button",className:"underline hover:no-underline",onClick:C,children:"Rensa filter"})]}),$&&r.jsxs(r.Fragment,{children:[" · ",r.jsx("span",{className:"hidden lg:inline",role:"note","aria-label":"Teckenförklaring",children:r.jsx(pt,{})})]})]}),r.jsxs("select",{value:o,onChange:e=>d(e.target.value),className:"select hidden lg:block","aria-label":"Sortera",children:[r.jsx("option",{value:"name",children:"Sortera på namn"}),r.jsx("option",{value:"type",children:"Sortera på typ"}),r.jsx("option",{value:"tier",children:"Sortera på valör"}),r.jsx("option",{value:"status",children:"Sortera på status"})]})]})]}),r.jsx(Rt,{value:A,onChange:e=>{T(e),k("search",e)},suggestions:P,onSuggestionSelect:e=>{T(e),k("search",e)},inputRef:m,placeholder:"Sök märken... (klicka / för fokus)"}),r.jsx("div",{className:"flex items-center gap-2",children:r.jsx(Ut,{className:"flex-1 min-w-0",filters:N,onToggle:(e,t)=>F(e,t),onOpenFilters:()=>u(!0),activeCount:D,controlsId:"mobile-filters-sheet"})}),r.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[r.jsxs("div",{className:"hidden lg:block lg:col-span-1 space-y-4",children:[r.jsx(Gt,{filters:N,onFilterChange:k,medalTypes:I,tiers:_,hasActiveFilters:M,resultCount:E.length,onClearAll:C,sortBy:o,onSortChange:d}),r.jsx(Bt,{currentFilters:N,onApplyPreset:e=>S(e)})]}),r.jsx(ke,{id:"mobile-filters-sheet",title:"Filter",open:c,onClose:()=>u(!1),swipeToDismiss:!0,children:r.jsx(Gt,{filters:N,onFilterChange:k,medalTypes:I,tiers:_,hasActiveFilters:M,resultCount:E.length,onClearAll:()=>{C(),u(!1)},sortBy:o,onSortChange:d})}),r.jsx("div",{className:"lg:col-span-3",children:0===E.length?r.jsx("div",{className:"card p-6 text-center",children:r.jsx("p",{className:"text-muted-foreground",children:"Inga märken matchar dina filter"})}):r.jsx("div",{className:"border border-border rounded-md overflow-hidden",role:"region","aria-label":"Märkes-resultat",children:r.jsx(Kt,{medals:E,height:v,itemSize:60,onSelect:e=>n(`/medals/${e.id}`,{state:{backgroundLocation:a}}),statusesById:q})})})]}),$&&r.jsx("div",{className:"mt-4 lg:hidden",role:"note","aria-label":"Teckenförklaring",children:r.jsx(pt,{})})]}):r.jsx("div",{className:"text-muted-foreground",children:"Laddar märken..."})}function Wt(e){const r=t.useContext(me),n=r?.get(e)??"off";return{state:n,enabled:"on"===n||"preview"===n}}function Xt({feature:e,children:n,variant:a="auto"}){const s=ue?.[e]||{},i=s.title||"Feature i utveckling",l=s.message||`Den här funktionen (“${e}”) visas som förhandsvisning.`,o="auto"===a?s.overlay||"auto":a,d=t.useRef(null),[c,u]=t.useState(!1);t.useEffect(()=>{if("auto"!==o)return;const e=d.current;if(!e||"undefined"==typeof ResizeObserver)return;const t=new ResizeObserver(t=>{const r=t[0]?.contentRect||e.getBoundingClientRect();u(r.width<420||r.height<160)});return t.observe(e),()=>t.disconnect()},[o]);const m="auto"===o?c?"inline":"panel":o;return r.jsxs("div",{ref:d,className:"relative isolate",children:[r.jsx("div",{className:"pointer-events-none opacity-60 [filter:blur(2px)]","aria-hidden":"true",inert:"",children:n}),"panel"===m?r.jsx("div",{role:"note","aria-label":"Feature preview","aria-live":"polite",className:"absolute inset-0 z-10 grid place-items-center bg-black/40 backdrop-blur-sm",children:r.jsx("div",{className:"w-[min(92vw,36rem,calc(100%-1rem))] max-w-none mx-4 rounded-xl border border-border bg-bg-secondary/95 p-4 shadow-lg text-foreground",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(Se,{name:"FlaskConical",className:"w-5 h-5","aria-hidden":"true",style:{color:"var(--color-info)"}}),r.jsxs("div",{children:[r.jsx("div",{className:"font-semibold leading-5 text-balance",children:i}),r.jsx("div",{className:"mt-1 text-sm text-muted-foreground text-pretty break-words",children:l})]})]})})}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"absolute inset-0 z-10 bg-black/30 backdrop-blur-[1.5px]","aria-hidden":"true"}),r.jsx("div",{className:"absolute inset-0 z-20 grid place-items-center",children:r.jsx("div",{role:"note","aria-label":"Feature preview",className:"mx-2 w-[min(92vw,calc(100%-1rem),28rem)] rounded-lg border border-border bg-bg-secondary/95 p-3 shadow-md text-foreground",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(Se,{name:"FlaskConical",className:"w-4 h-4","aria-hidden":"true",style:{color:"var(--color-info)"}}),r.jsxs("p",{className:"text-sm leading-5 text-pretty break-words",children:[r.jsxs("span",{className:"font-semibold",children:[i,":"]})," ",r.jsx("span",{className:"text-muted-foreground",children:l})]})]})})})]})]})}function Jt({name:e,mode:t="preview",fallback:n=null,className:a,style:s,children:i}){const{state:l}=Wt(e);return"off"===l?n:"preview"===l?"hide"===t?n:r.jsx("div",{className:a,style:s,children:r.jsx(Xt,{feature:e,children:i})}):r.jsx("div",{className:a,style:s,children:i})}const Zt=(new Date).getFullYear();function Qt({open:e,onClose:n,initialRow:a,onSave:s,mode:i="batch",submitLabel:l,WG:o=["A","B","C","R"],DISCIPLINE_TYPES:d=["field","precision","military_fast"],COMP_TYPES:c=["national","regional/landsdels","crewmate/krets","championship","rikstavlingen","riks","nationell","landsdel","krets"],MEDAL_TYPES:u=["bronze","silver","gold"],APP_TIME_OPTIONS:m=[{value:60,label:"60, Brons"},{value:40,label:"40, Silver"},{value:17,label:"17, Guld A/R"},{value:15,label:"15, Guld B/C"}],COMP_DISCIPLINE_TYPES:p=["national_whole_match","military_fast_match","ppc","precision","field"],PPC_CLASS_SUGGESTIONS:h=["R1500","P1500","Open","SSA",'SR 4"','SR 2,75"',"Dist pistol","Dist revolver"]}){const f=t.useMemo(()=>e?JSON.stringify(a??{}):"closed",[e,a]);return r.jsx(ke,{id:"batch-row-editor",title:"Aktivitet",open:e,onClose:n,swipeToDismiss:!0,children:e?r.jsx(Jt,{name:"achievementEntry",children:r.jsx(er,{initialRow:a,onSave:s,onClose:n,mode:i,submitLabel:l,WG:o,DISCIPLINE_TYPES:d,COMP_TYPES:c,MEDAL_TYPES:u,APP_TIME_OPTIONS:m,COMP_DISCIPLINE_TYPES:p,PPC_CLASS_SUGGESTIONS:h},f)}):null})}function er({initialRow:e,onSave:n,onClose:a,mode:s="batch",submitLabel:i,WG:l,DISCIPLINE_TYPES:o,COMP_TYPES:d,MEDAL_TYPES:c,APP_TIME_OPTIONS:u,COMP_DISCIPLINE_TYPES:m,PPC_CLASS_SUGGESTIONS:p}){const[h,f]=t.useState(()=>e||{}),[x,b]=t.useState({}),g=!("competition_result"===h.type&&"ppc"===String(h.disciplineType||"").toLowerCase()),y=(e,t)=>f(r=>({...r,[e]:t})),v=t.useMemo(()=>e=>{const t=[],r={},n=Number(e.year);switch((!Number.isFinite(n)||n<1900||n>Zt)&&(t.push(`Året måste vara mellan 1900 och ${Zt}`),r.year=!0),l.includes(e.weaponGroup)||(t.push("Ogiltig grupp (A, B, C, R)"),r.weaponGroup=!0),e.type){case"precision_series":{const n=Number(e.points);(!Number.isFinite(n)||n<0||n>50)&&(t.push("Poäng måste vara 0-50"),r.points=!0);break}case"application_series":{const n=new Date(e.date);if(!e.date||Number.isNaN(n.getTime()))t.push("Ogiltigt datum"),r.date=!0;else{const e=new Date;e.setHours(0,0,0,0),n.setHours(0,0,0,0),n.getTime()>e.getTime()&&(t.push("Datum kan inte vara i framtiden"),r.date=!0)}const a=u.map(e=>e.value),s=Number(e.timeSeconds);Number.isFinite(s)&&a.includes(s)||(t.push("Välj giltig tid"),r.timeSeconds=!0);const i=Number(e.hits);(!Number.isFinite(i)||i<0)&&(t.push("Ange giltigt antal träffar"),r.hits=!0);break}case"shooting_round":{const n=Number(e.totalPoints);(!Number.isFinite(n)||n<0||n>150)&&(t.push("Totalpoäng måste vara 0-150"),r.totalPoints=!0);break}case"speed_shooting_series":{const n=Number(e.points);(!Number.isFinite(n)||n<0||n>50)&&(t.push("Poäng måste vara 0-50"),r.points=!0);break}case"competition_result":{const n=String(e.competitionType||"").toLowerCase(),a=String(e.disciplineType||"").toLowerCase(),s=Number(e.score);if(d.includes(n)||(t.push("Välj giltig tävlingstyp"),r.competitionType=!0),m.includes(a)||(t.push("Välj giltig gren"),r.disciplineType=!0),Number.isFinite(s)||(t.push("Poäng måste vara ett tal"),r.score=!0),"ppc"!==a||String(e.ppcClass||"").trim()||(t.push("Välj PPC-klass"),r.ppcClass=!0),null!=e.seriesCount&&""!==e.seriesCount){const n=Number(e.seriesCount);Number.isFinite(n)&&[6,7,10].includes(n)||(t.push("Antal serier måste vara 6, 7 eller 10"),r.seriesCount=!0)}break}case"competition_performance":{const n=String(e.disciplineType||"").toLowerCase();if(["field","precision","military_fast"].includes(n)||(t.push("Välj giltig gren (field, running, precision)"),r.disciplineType=!0),"running"===n||"skiing"===n){const n=Number(e.points);(!Number.isFinite(n)||n<0)&&(t.push("Poäng måste vara ett positivt tal"),r.points=!0)}else if("field"===n){const n=Number(e.score),a=Number(e.maxScore);(!Number.isFinite(n)||n<0)&&(t.push("Poäng måste vara ett positivt tal"),r.score=!0),(!Number.isFinite(a)||a<=0)&&(t.push("Max poäng måste vara större än 0"),r.maxScore=!0)}break}case"air_pistol_precision":{const n=Number(e.points);(!Number.isFinite(n)||n<0||n>100)&&(t.push("Poäng måste vara 0-100"),r.points=!0);break}case"running_shooting_course":{const n=Number(e.points);(!Number.isFinite(n)||n<0)&&(t.push("Poäng måste vara ett positivt tal"),r.points=!0);break}}return{errs:t,fields:r}},[l,d,u,m]),j=(e=!1)=>{const{errs:t,fields:r}=v(h);if(t.length)b({list:t,fields:r});else if(n?.(h,{addAnother:e}),e){const e={year:h.year,weaponGroup:h.weaponGroup,type:h.type,date:(new Date).toISOString().slice(0,10),timeSeconds:"",hits:"",points:"",totalPoints:"",competitionType:"",medalType:"",disciplineType:"",ppcClass:"",competitionName:"",weapon:"",score:"",seriesCount:"",teamName:"",position:"",participants:"",eventName:"",notes:""};f(e),b({})}else a?.()};return r.jsxs("form",{onSubmit:e=>{e.preventDefault(),j(!1)},className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{className:["grid gap-3",g?"grid-cols-2":"grid-cols-1"].join(" "),children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-year",className:"field-label mb-2",children:"År"}),r.jsx("input",{id:"br-year",type:"number",min:"1900",max:Zt,className:"input py-3",value:h.year??Zt,onChange:e=>y("year",Number(e.target.value)),"aria-invalid":x.fields?.year||void 0})]}),g&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-group",className:"field-label mb-2",children:"Grupp"}),r.jsx("select",{id:"br-group",className:"select py-3",value:h.weaponGroup??"A",onChange:e=>y("weaponGroup",e.target.value),"aria-invalid":x.fields?.weaponGroup||void 0,children:l.map(e=>r.jsx("option",{value:e,children:e},e))})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-type",className:"field-label mb-2",children:"Type"}),r.jsxs("select",{id:"br-type",className:"select py-3",value:h.type||"precision_series",onChange:e=>y("type",e.target.value),children:[r.jsx("option",{value:"precision_series",children:"Precisionsserier"}),r.jsx("option",{value:"application_series",children:"Tillämpningsserier"}),r.jsx("option",{value:"shooting_round",children:"Skjutomgång"}),r.jsx("option",{value:"speed_shooting_series",children:"Snabbskjutningsserier"}),r.jsx("option",{value:"standard_medal",children:"Standardmedalj"}),r.jsx("option",{value:"competition_result",children:"Tävlingsresultat"}),r.jsx("option",{value:"qualification_result",children:"Kvalificering"}),r.jsx("option",{value:"team_event",children:"Lag-eventt"}),r.jsx("option",{value:"event",children:"Event"}),r.jsx("option",{value:"custom",children:"Custom"})]})]}),"precision_series"===h.type&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-points",className:"field-label mb-2",children:"Poäng (0-50)"}),r.jsx("input",{id:"br-points",type:"number",min:"0",max:"50",className:"input py-3",value:h.points??"",onChange:e=>y("points",e.target.value),"aria-invalid":x.fields?.points||void 0})]}),"application_series"===h.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{id:"br-date",type:"date",className:"input py-3",value:h.date??(new Date).toISOString().slice(0,10),onChange:e=>y("date",e.target.value),"aria-invalid":x.fields?.date||void 0})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-time",className:"field-label mb-2",children:"Tid"}),r.jsxs("select",{id:"br-time",className:"select py-3",value:""===h.timeSeconds?"":Number(h.timeSeconds),onChange:e=>y("timeSeconds",""===e.target.value?"":Number(e.target.value)),"aria-invalid":x.fields?.timeSeconds||void 0,children:[r.jsx("option",{value:"",children:"Select time…"}),u.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-hits",className:"field-label mb-2",children:"Hits"}),r.jsx("input",{id:"br-hits",type:"number",min:"0",className:"input py-3",value:h.hits??"",onChange:e=>y("hits",e.target.value),"aria-invalid":x.fields?.hits||void 0})]})]}),"shooting_round"===h.type&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-totalpoints",className:"field-label mb-2",children:"Totalpoäng (0-150)"}),r.jsx("input",{id:"br-totalpoints",type:"number",min:"0",max:"150",className:"input py-3",value:h.totalPoints??"",onChange:e=>y("totalPoints",e.target.value),"aria-invalid":x.fields?.totalPoints||void 0}),r.jsx("p",{className:"text-xs text-text-tertiary mt-1",children:"Skjutomgång består av 3 serier (150s, 20s, 10s)"})]}),"speed_shooting_series"===h.type&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-speedpoints",className:"field-label mb-2",children:"Poäng (0-50)"}),r.jsx("input",{id:"br-speedpoints",type:"number",min:"0",max:"50",className:"input py-3",value:h.points??"",onChange:e=>y("points",e.target.value),"aria-invalid":x.fields?.points||void 0}),r.jsx("p",{className:"text-xs text-text-tertiary mt-1",children:"5-skottsserie mot snabbpistoltavla 25m (3 sek per skott)"})]}),"standard_medal"===h.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ctype",className:"field-label mb-2",children:"Gren"}),r.jsxs("select",{id:"br-ctype",className:"select py-3",value:h.disciplineType??"",onChange:e=>y("disciplineType",e.target.value),children:[r.jsx("option",{value:"",children:"Välj disciplin..."}),o.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-mtype",className:"field-label mb-2",children:"Medalj"}),r.jsxs("select",{id:"br-mtype",className:"select py-3",value:h.medalType??"",onChange:e=>y("medalType",e.target.value),children:[r.jsx("option",{value:"",children:"Välj medalj..."}),c.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-cname",className:"field-label mb-2",children:"Namn (valfritt)"}),r.jsx("input",{id:"br-cname",type:"text",className:"input py-3",value:h.competitionName??"",onChange:e=>y("competitionName",e.target.value)})]})]}),"competition_result"===h.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ctype",className:"field-label mb-2",children:"Tävlingstyp"}),r.jsxs("select",{id:"br-ctype",className:"select py-3",value:h.competitionType??"",onChange:e=>y("competitionType",e.target.value),"aria-invalid":x.fields?.competitionType||void 0,children:[r.jsx("option",{value:"",children:"Select type…"}),d.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-disc",className:"field-label mb-2",children:"Gren"}),r.jsxs("select",{id:"br-disc",className:"select py-3",value:h.disciplineType??"",onChange:e=>y("disciplineType",e.target.value),"aria-invalid":x.fields?.disciplineType||void 0,children:[r.jsx("option",{value:"",children:"Välj gren…"}),m.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),"ppc"===String(h.disciplineType||"")&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ppc",className:"field-label mb-2",children:"PPC-klass"}),r.jsx("input",{id:"br-ppc",type:"text",className:"input py-3",list:"ppc-classes",value:h.ppcClass??"",onChange:e=>y("ppcClass",e.target.value),placeholder:"t.ex. R1500","aria-invalid":x.fields?.ppcClass||void 0}),r.jsx("datalist",{id:"ppc-classes",children:p.map(e=>r.jsx("option",{value:e},e))})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-score",className:"field-label mb-2",children:"Poäng"}),r.jsx("input",{id:"br-score",type:"number",className:"input py-3",value:h.score??"",onChange:e=>y("score",e.target.value),"aria-invalid":x.fields?.score||void 0})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-series",className:"field-label mb-2",children:"Antal serier (valfritt)"}),r.jsxs("select",{id:"br-series",className:"select py-3",value:h.seriesCount??"",onChange:e=>y("seriesCount",""===e.target.value?"":Number(e.target.value)),"aria-invalid":x.fields?.seriesCount||void 0,children:[r.jsx("option",{value:"",children:"-"}),r.jsx("option",{value:"6",children:"6 serier"}),r.jsx("option",{value:"7",children:"7 serier"}),r.jsx("option",{value:"10",children:"10 serier"})]}),r.jsx("p",{className:"text-xs text-text-tertiary mt-1",children:"Används för Mästarmärket"})]}),r.jsxs("div",{className:"md:col-span-2",children:[r.jsx("label",{htmlFor:"br-cname",className:"field-label mb-2",children:"Namn (valfritt)"}),r.jsx("input",{id:"br-cname",type:"text",className:"input py-3",value:h.competitionName??"",onChange:e=>y("competitionName",e.target.value)})]})]}),"qualification_result"===h.type&&r.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-weapon",className:"field-label mb-2",children:"Vapen"}),r.jsx("input",{id:"br-weapon",type:"text",className:"input py-3",value:h.weapon??"",onChange:e=>y("weapon",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-score",className:"field-label mb-2",children:"Poäng"}),r.jsx("input",{id:"br-score",type:"number",className:"input py-3",value:h.score??"",onChange:e=>y("score",e.target.value)})]})]}),"team_event"===h.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-team",className:"field-label mb-2",children:"Lag"}),r.jsx("input",{id:"br-team",type:"text",className:"input py-3",value:h.teamName??"",onChange:e=>y("teamName",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-pos",className:"field-label mb-2",children:"Placering"}),r.jsx("input",{id:"br-pos",type:"number",min:"1",className:"input py-3",value:h.position??"",onChange:e=>y("position",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-part",className:"field-label mb-2",children:"Deltagare"}),r.jsx("input",{id:"br-part",type:"text",className:"input py-3",placeholder:"Anna, Björn, Carin",value:h.participants??"",onChange:e=>y("participants",e.target.value)})]})]}),("event"===h.type||"custom"===h.type)&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ename",className:"field-label mb-2",children:"Titel"}),r.jsx("input",{id:"br-ename",type:"text",className:"input py-3",value:h.eventName??"",onChange:e=>y("eventName",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-notes",className:"field-label mb-2",children:"Anteckningar (valfritt)"}),r.jsx("textarea",{id:"br-notes",className:"textarea py-3 resize-none",rows:3,value:h.notes??"",onChange:e=>y("notes",e.target.value)})]}),x.list?.length?r.jsx("div",{role:"alert",className:"alert alert-error text-sm",children:x.list.join(", ")}):null,"batch"===s?r.jsxs("div",{className:"flex gap-2 justify-end pt-2",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:a,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-muted",onClick:()=>j(!0),children:"Lägg till & lägg till en till"}),r.jsx("button",{type:"submit",className:"btn btn-primary",children:"Lägg till batch"})]}):r.jsxs("div",{className:"flex gap-2 justify-end pt-2",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:a,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary",children:i||"Spara"})]})]})}function tr({row:e,index:t,onEdit:n,onRemove:a}){const s=(()=>{switch(e.type){case"precision_series":return`Points: ${e.points??"—"}`;case"application_series":return`Time: ${e.timeSeconds??"—"} • Hits: ${e.hits??"—"}`;case"standard_medal":return`${e.disciplineType||"—"} • ${e.medalType||"—"}`;case"competition_result":return`${e.competitionType||"—"} • ${e.medalType||"—"}`;case"qualification_result":return`Weapon: ${e.weapon||"—"} • Score: ${e.score||"—"}`;case"team_event":return`Team: ${e.teamName||"—"} • Pos: ${e.position||"—"}`;default:return`${e.eventName||"—"}`}})();return r.jsxs("div",{className:"card p-4 flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsxs("div",{className:"font-medium text-foreground",children:[e.type.replace(/_/g," ")," • ",e.year," • Grupp ",e.weaponGroup]}),r.jsx("div",{className:"text-sm text-muted-foreground",children:s}),e.notes?r.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"Anteckningar"}):null]}),r.jsxs("div",{className:"flex gap-2 shrink-0",children:[r.jsx("button",{type:"button",onClick:()=>n?.(t),className:"btn btn-muted h-10 px-3","aria-label":`Ändra rad ${t+1}`,children:"Ändra"}),r.jsx("button",{type:"button",onClick:()=>a?.(t),className:"btn btn-muted h-10 px-3 text-red-600","aria-label":`Ta bort rad ${t+1}`,children:"Ta bort"})]})]})}const rr=["A","B","C","R"],nr=["national_whole_match","military_fast_match","ppc","precision","field"],ar=["rikstavlingen","riks","nationell","landsdel","krets"];function sr(e){const t=new Date(e);if(Number.isNaN(t.getTime()))return!0;const r=new Date;return r.setHours(0,0,0,0),t.setHours(0,0,0,0),t.getTime()>r.getTime()}function ir(e){const t=[];if(!e||"object"!=typeof e)return{valid:!1,errors:["Invalid achievement object"]};const{type:r,year:n,weaponGroup:a}=e;if(r&&"string"==typeof r||t.push("Invalid type"),("number"!=typeof n||Number.isNaN(n))&&t.push("Invalid year"),a&&rr.includes(a)||t.push("Invalid weapon group"),"precision_series"===r){const r=e.points;"number"!=typeof r||Number.isNaN(r)?t.push("Points required for precision series"):(r<0||r>50)&&t.push("Points must be between 0 and 50")}if("application_series"===r){const r=e.timeSeconds,n=e.hits;("number"!=typeof r||Number.isNaN(r)||r<=0)&&t.push("Time required for application series"),("number"!=typeof n||Number.isNaN(n)||n<0)&&t.push("Hits required for application series")}if("competition_result"===r){const r=e.score,n=String(e.disciplineType||"").toLowerCase();if(("number"!=typeof r||Number.isNaN(r)||r<0)&&t.push("Score required for competition result"),n&&nr.includes(n)||t.push("Discipline required for competition result"),"ppc"===n){const r=e.ppcClass;r&&""!==String(r).trim()||t.push("PPC class required for PPC discipline")}if(e.competitionType&&!ar.includes(e.competitionType)&&t.push("Invalid competition type"),null!=e.seriesCount){const r=Number(e.seriesCount);!Number.isNaN(r)&&[6,7,10].includes(r)||t.push("Series count must be 6, 7, or 10")}}if("running_shooting_course"===r||"skis_shooting_course"===r){const r=e.points;("number"!=typeof r||Number.isNaN(r)||r<0)&&t.push("Points required for running/skiing shooting course"),!e.date||Number.isNaN(new Date(e.date).getTime())?t.push("Date required for running/skiing shooting course"):sr(e.date)&&t.push("Date cannot be in the future")}if("shooting_round"===r){const r=e.totalPoints;("number"!=typeof r||Number.isNaN(r)||r<0)&&t.push("Total points required for shooting round"),r>150&&t.push("Total points cannot exceed 150")}if("speed_shooting_series"===r){const r=e.points;"number"!=typeof r||Number.isNaN(r)?t.push("Points required for speed shooting series"):(r<0||r>50)&&t.push("Points must be between 0 and 50")}if("air_pistol_precision"===r){const r=e.points;"number"!=typeof r||Number.isNaN(r)?t.push("Points required for air pistol precision"):(r<0||r>100)&&t.push("Points must be between 0 and 100")}if("competition_performance"===r){const r=String(e.disciplineType||"").toLowerCase();if(r&&["field","running","skiing"].includes(r)||t.push("Discipline type required for competition performance"),"field"===r){const r=e.scorePercent;("number"!=typeof r||Number.isNaN(r)||r<0||r>100)&&t.push("Score percent required for field competition (0-100)")}if("running"===r||"skiing"===r){const r=e.points;("number"!=typeof r||Number.isNaN(r)||r<0)&&t.push("Points required for running/skiing competition")}}if("standard_medal"===r){String(e.disciplineType||"").toLowerCase()||t.push("Discipline type required for standard medal");const r=String(e.medalType||"").toLowerCase();r&&["bronze","silver","gold"].includes(r)||t.push("Medal type (bronze/silver/gold) required for standard medal")}return{valid:0===t.length,errors:t}}class lr{constructor(e){this.id=e.id||`achievement-${Date.now()}`,this.type=e.type,this.medalId=e.medalId,this.date=e.date;const t="number"==typeof e.year&&Number.isFinite(e.year),r=this.date?new Date(this.date).getFullYear():void 0;this.year=t?e.year:Number.isFinite(r)?r:void 0,this.weaponGroup=e.weaponGroup||"A",this.points="number"==typeof e.points?e.points:null!=e.points&&""!==e.points?Number(e.points):void 0,this.disciplineType=e.disciplineType,this.competitionType=e.competitionType,this.medalType=e.medalType,this.ppcClass=e.ppcClass,this.competitionName=e.competitionName||"",this.notes=e.notes||"",this.score="number"==typeof e.score?e.score:null!=e.score&&""!==e.score?Number(e.score):void 0,this.weapon=e.weapon,this.teamName=e.teamName,this.position="number"==typeof e.position?e.position:null!=e.position&&""!==e.position?Number(e.position):void 0,this.participants=Array.isArray(e.participants)?e.participants:"string"==typeof e.participants?e.participants.split(",").map(e=>e.trim()).filter(Boolean):void 0,this.eventName=e.eventName,this.timeSeconds="number"==typeof e.timeSeconds?e.timeSeconds:null!=e.timeSeconds&&""!==e.timeSeconds?Number(e.timeSeconds):void 0,this.hits="number"==typeof e.hits?e.hits:null!=e.hits&&""!==e.hits?Number(e.hits):void 0,this.scorePercent="number"==typeof e.scorePercent?e.scorePercent:null!=e.scorePercent&&""!==e.scorePercent?Number(e.scorePercent):void 0,this.maxScore="number"==typeof e.maxScore?e.maxScore:null!=e.maxScore&&""!==e.maxScore?Number(e.maxScore):void 0,this.seriesName=e.seriesName,this.courseName=e.courseName}}function or(){const{currentProfile:e,addAchievement:r,updateAchievement:n,removeAchievement:a,unlockMedal:s}=se(),{pushState:i,undo:l,redo:o,canUndo:d,canRedo:c,history:u,historyIndex:m}=function(){const e=t.useContext(de);if(!e)throw new Error("useUndoRedo must be used within UndoRedoProvider");return e}(),p=t.useCallback(()=>(e?.prerequisites||[]).map(e=>({...e})),[e]),h=t.useCallback(()=>{i({type:"achievements",data:p()})},[i,p]),f=t.useCallback(async t=>{if(!e)return;const s=(e.prerequisites||[]).map(e=>({...e})),i=new Map(s.map(e=>[e.id,e])),l=new Map(t.map(e=>[e.id,e]));for(const e of s)if(!l.has(e.id)&&"function"==typeof a)try{await a(e.id)}catch{}for(const e of t)if(!i.has(e.id)&&"function"==typeof r)try{await r(new lr(e))}catch{}for(const e of t){const t=i.get(e.id);if(!t)continue;if(["type","year","weaponGroup","points","date","competitionName","notes","timeSeconds","hits"].some(r=>String(t[r]??"")!==String(e[r]??""))&&"function"==typeof n)try{await n(new lr(e))}catch{}}},[r,a,n,e]),x=t.useCallback(async(t=[])=>{if(!t.length||!e)return 0;let n=0;const a=[],s=e=>""===e||null==e?void 0:Number(e);for(let e=0;e<t.length;e++){const l=t[e],o=new lr({id:l.id,type:l.type,year:Number(l.year),weaponGroup:l.weaponGroup,date:l.date||(new Date).toISOString().slice(0,10),competitionName:l.competitionName||"",notes:l.notes||"",points:"precision_series"===l.type?s(l.points):void 0,disciplineType:"standard_medal"===l.type||"competition_result"===l.type?l.disciplineType||"":void 0,medalType:"standard_medal"===l.type?l.medalType||"":void 0,competitionType:"competition_result"===l.type?l.competitionType||"":void 0,ppcClass:"competition_result"===l.type?l.ppcClass||"":void 0,score:"competition_result"===l.type||"qualification_result"===l.type?s(l.score):void 0,weapon:"qualification_result"===l.type?l.weapon||"":void 0,teamName:"team_event"===l.type?l.teamName||"":void 0,position:"team_event"===l.type?s(l.position):void 0,participants:"team_event"===l.type?Array.isArray(l.participants)?l.participants:String(l.participants||"").split(",").map(e=>e.trim()).filter(Boolean):void 0,eventName:"event"===l.type||"custom"===l.type?l.eventName||"":void 0,timeSeconds:"application_series"===l.type?Number(l.timeSeconds):void 0,hits:"application_series"===l.type?""===l.hits||null==l.hits?void 0:Number(l.hits):void 0});if("function"==typeof r)try{await r(o),n++}catch(i){a.push({index:e,message:i?.message||"Failed to add achievement"}),console.error("addMany: add failed",{index:e+1,error:i,achievement:o})}}if(n>0)return h(),n;if(a.length>0){const e=a.map(e=>`Row ${e.index+1}: ${e.message}`).join(" | ");throw new Error(e)}return 0},[r,e,h]),b=t.useCallback(async t=>{if(!e)return!1;const r=t instanceof lr?t:new lr({...t,id:t?.id});if(!r?.id)return!1;try{return await n(r),h(),!0}catch(a){return console.error("updateAchievement failed",{error:a,payload:r}),!1}},[e,n,h]),g=t.useCallback(async t=>{if(!e||!t)return!1;let r=!1;if("function"==typeof a)try{await a(t),r=!0}catch(n){console.error("removeAchievement failed",{error:n,achievementId:t})}return r&&h(),r},[e,a,h]),y=t.useCallback(async()=>{const e=l();if(null==e)return!1;const t=u[e];return"achievements"===t?.type&&(await f(t.data),!0)},[l,u,f]),v=t.useCallback(async()=>{const e=o();if(null==e)return!1;const t=u[e];return"achievements"===t?.type&&(await f(t.data),!0)},[o,u,f]);t.useEffect(()=>{const e=e=>{(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey)&&("z"===e.key.toLowerCase()?(e.preventDefault(),y()):"y"===e.key.toLowerCase()&&(e.preventDefault(),v()))};return window.addEventListener("keydown",e,{passive:!1}),()=>window.removeEventListener("keydown",e)},[y,v]);const j=t.useCallback(async t=>{if(!e||!t)return!1;const n=t instanceof lr?t:new lr(t);if("function"!=typeof r)return!1;try{return await r(n),h(),!0}catch(a){return console.error("addAchievement failed",{error:a,achievement:n}),!1}},[e,r,h]),w=b,N=g;return{achievements:e?.prerequisites||[],addMany:x,addAchievement:j,updateAchievement:w,removeAchievement:N,unlockMedal:s,updateOne:b,removeOne:g,undoAchievements:y,redoAchievements:v,canUndo:d,canRedo:c,historyIndex:m}}const dr=["A","B","C","R"],cr=["national","regional/landsdels","crewmate/krets","championship"],ur=["field","precision","military_fast"],mr=["national_whole_match","military_fast_match","ppc"],pr=["R1500","P1500","Open","SSA",'SR 4"','SR 2,75"',"Dist pistol","Dist revolver"],hr=["bronze","silver","gold"],fr=[{value:60,label:"60, Brons"},{value:40,label:"40, Silver"},{value:17,label:"17, Guld A/R"},{value:15,label:"15, Guld B/C"}],xr=(new Date).getFullYear(),br=()=>({year:xr,weaponGroup:"A",type:"precision_series",date:(new Date).toISOString().slice(0,10),timeSeconds:"",hits:"",points:"",competitionType:"",medalType:"",disciplineType:"",competitionName:"",weapon:"",score:"",ppcClass:"",teamName:"",position:"",participants:"",eventName:"",notes:""});function gr(){const{addMany:e}=or(),[n,a]=t.useState([br()]),[s,i]=t.useState(!1),[l,o]=t.useState(-1),[d,c]=t.useState({}),[u,m]=t.useState(0),[p,h]=t.useState(!1),[f,x]=t.useState([]),b=(e,t,r)=>{const s=[...n];s[e]={...s[e],[t]:r},a(s)},g=e=>{o(e),i(!0)},y=e=>{a(n.filter((t,r)=>r!==e))};return r.jsx(Jt,{name:"achievementEntry",children:r.jsxs("div",{className:"card p-6",children:[r.jsx("h2",{className:"text-xl font-bold mb-2 text-text-primary",children:"Lägg till aktiviteter i batch"}),r.jsx("p",{id:"batch-type-help",className:"text-sm text-text-secondary mb-4",children:"Batcher stödjer precisionsserier och tillämpningsserier. För att lägga till övriga, logga dem på ett märkeskort."}),u>0&&r.jsx("div",{role:"status","aria-live":"polite",className:"alert alert-success mb-4",children:r.jsxs("p",{children:["✓ Lyckades lägga till ",u," aktivitet(er)"]})}),f.length>0&&r.jsxs("div",{role:"alert",className:"alert alert-warning mb-4",children:[r.jsx("p",{className:"font-medium mb-1",children:"Möjliga duplikat:"}),r.jsx("ul",{className:"list-disc list-inside text-muted-foreground text-sm",children:f.map((e,t)=>r.jsx("li",{children:e},t))})]}),d.form&&r.jsx("div",{role:"alert",className:"alert alert-error mb-4",children:r.jsx("p",{children:d.form})}),r.jsxs("div",{className:"sm:hidden space-y-3 mb-4",children:[n.map((e,t)=>r.jsx(tr,{row:e,index:t,onEdit:g,onRemove:y},t)),r.jsx("div",{className:"sticky bottom-0 safe-bottom pt-2 bg-transparent",children:r.jsx("button",{type:"button",onClick:()=>{o(-1),i(!0)},className:"btn btn-primary w-full min-h-[44px]","aria-label":"Add achievement",children:"+ Lägg till"})})]}),r.jsxs("form",{onSubmit:async t=>{t.preventDefault();const r={},s=[];if(n.forEach((e,t)=>{const n=[],a={},i=Number(e.year);switch((!Number.isFinite(i)||i<2e3||i>xr)&&(n.push(`Året måste vara mellan 2000 och ${xr}`),a.year=!0),dr.includes(e.weaponGroup)||(n.push("Ogiltig grupp (A, B, C, R)"),a.weaponGroup=!0),e.type){case"precision_series":{const t=Number(e.points);(!Number.isFinite(t)||t<0||t>50)&&(n.push("Poäng måste vara mellan 0-50"),a.points=!0);break}case"application_series":{const t=new Date(e.date);if(!e.date||Number.isNaN(t.getTime()))n.push("Ogiltigt datum"),a.date=!0;else{const e=new Date;e.setHours(0,0,0,0),t.setHours(0,0,0,0),t.getTime()>e.getTime()&&(n.push("Datum kan inte vara i framtiden"),a.date=!0)}const r=[60,40,17,15],s=Number(e.timeSeconds);Number.isFinite(s)&&r.includes(s)||(n.push("Välj giltig tid"),a.timeSeconds=!0);const i=Number(e.hits);(!Number.isFinite(i)||i<0)&&(n.push("Ange giltigt antal träffar"),a.hits=!0);break}case"competition_result":{const t=String(e.competitionType||"").toLowerCase(),r=String(e.disciplineType||"").toLowerCase(),s=Number(e.score);cr.includes(t)||(n.push("Välj giltig tävlingstyp"),a.competitionType=!0),mr.includes(r)||(n.push("Välj giltig gren"),a.disciplineType=!0),Number.isFinite(s)||(n.push("Poäng måste vara ett tal"),a.score=!0),"ppc"!==r||String(e.ppcClass||"").trim()||(n.push("Välj PPC-klass"),a.ppcClass=!0);break}}n.length?r[t]={list:n,fields:a}:s.push(e)}),Object.keys(r).length)return void c(r);const i=function(e){const t=new Set,r=[];return e.forEach(e=>{if(!e)return;if("application_series"===e.type)return;let n;n="precision_series"===e.type?`${e.year}-${e.type}-${e.weaponGroup}-${e.points}`:"competition_result"===e.type?`${e.year}-${e.type}-${e.weaponGroup}-${e.disciplineType||""}-${e.date||""}-${e.score??""}`:`${e.year}-${e.type}-${e.weaponGroup}`,t.has(n)&&r.push(n),t.add(n)}),r}(s.filter(e=>"precision_series"===e.type));x(i);try{h(!0);const t=await e(s);t>0?(m(t),a([br()]),c({}),setTimeout(()=>m(0),3e3)):c({form:"Inga aktiviteter blev tillagda. Granska din input."})}catch(l){c({form:l.message})}finally{h(!1)}},children:[r.jsx("div",{className:"hidden sm:block overflow-x-auto mb-4",children:r.jsxs("table",{className:"w-full text-sm text-foreground table-fixed",children:[r.jsxs("colgroup",{children:[r.jsx("col",{className:"w-[7rem]"}),r.jsx("col",{className:"w-[12rem]"}),r.jsx("col",{className:"w-[5rem]"}),r.jsx("col",{}),r.jsx("col",{className:"w-[7rem]"})]}),r.jsx("caption",{className:"sr-only",children:"Batch achievement input"}),r.jsx("thead",{children:r.jsxs("tr",{className:"border-b border-border bg-bg-secondary",children:[r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"År"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Typ"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Grupp"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Detaljer"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Åtgärd"})]})}),r.jsx("tbody",{children:n.map((e,t)=>{const a=d[t],s=a?.list||[],i=`row-${t}-errors`,l=!!a?.fields?.year,o=!!a?.fields?.weaponGroup,c=!!a?.fields?.points,u=!!a?.fields?.date,m=!!a?.fields?.timeSeconds,h=!!a?.fields?.hits;return r.jsxs("tr",{className:"border-b border-border hover:bg-bg-secondary/60",children:[r.jsx("td",{className:"px-3 py-2",children:r.jsx("input",{type:"number",min:"2000",max:(new Date).getFullYear(),value:e.year,onChange:e=>b(t,"year",e.target.value),className:"input w-full",disabled:p,"aria-label":`Year for row ${t+1}`,"aria-invalid":l||void 0,"aria-describedby":s.length?i:void 0})}),r.jsx("td",{className:"px-3 py-2",children:r.jsxs("select",{value:e.type,onChange:e=>b(t,"type",e.target.value),className:"select w-full",disabled:p,"aria-label":`Type for row ${t+1}`,"aria-describedby":"batch-type-help",children:[r.jsx("option",{value:"precision_series",children:"Precisionsserie"}),r.jsx("option",{value:"application_series",children:"Tillämpningsserie"}),r.jsx("option",{value:"standard_medal",children:"Standardmedalj"}),r.jsx("option",{value:"competition_result",children:"Tävlingsresultat"}),r.jsx("option",{value:"qualification_result",children:"Kvalificering"}),r.jsx("option",{value:"team_event",children:"Lag-Event"}),r.jsx("option",{value:"event",children:"Event"}),r.jsx("option",{value:"custom",children:"Custom"})]})}),r.jsx("td",{className:"px-3 py-2",children:"competition_result"!==e.type||"ppc"!==String(e.disciplineType||"").toLowerCase()?r.jsxs("select",{value:e.weaponGroup,onChange:e=>b(t,"weaponGroup",e.target.value),className:"select w-full",disabled:p,"aria-label":`Vapengrupp för rad ${t+1}`,"aria-invalid":o||void 0,"aria-describedby":s.length?i:void 0,children:[r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]}):r.jsx("span",{className:"text-muted-foreground text-xs",children:"—"})}),r.jsxs("td",{className:"px-3 py-2",children:["precision_series"===e.type?r.jsx("input",{type:"number",min:"0",max:"50",value:e.points,onChange:e=>b(t,"points",e.target.value),className:"input w-full",placeholder:"0-50",disabled:p,"aria-label":`Poäng för rad ${t+1}`,"aria-invalid":c||void 0,"aria-describedby":s.length?i:void 0}):"application_series"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"date",value:e.date,onChange:e=>b(t,"date",e.target.value),className:"input w-full",disabled:p,"aria-label":`Datum för rad ${t+1}`,"aria-invalid":u||void 0,"aria-describedby":s.length?i:void 0}),r.jsxs("select",{value:""===e.timeSeconds?"":Number(e.timeSeconds),onChange:e=>b(t,"timeSeconds",""===e.target.value?"":Number(e.target.value)),className:"select w-full",disabled:p,"aria-label":`Tid för rad ${t+1}`,"aria-invalid":m||void 0,"aria-describedby":s.length?i:void 0,children:[r.jsx("option",{value:"",children:"Select time…"}),fr.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]}),r.jsx("input",{type:"number",min:"0",step:"1",value:e.hits,onChange:e=>b(t,"hits",e.target.value),className:"input w-full",placeholder:"Hits",disabled:p,"aria-label":`Träffar för rad ${t+1}`,"aria-invalid":h||void 0,"aria-describedby":s.length?i:void 0})]}):"standard_medal"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsxs("select",{value:e.disciplineType,onChange:e=>b(t,"disciplineType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Tävlinggren för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj disciplin..."}),ur.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsxs("select",{value:e.medalType,onChange:e=>b(t,"medalType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Medaljtyp för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj medalj..."}),hr.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsx("input",{type:"text",value:e.competitionName,onChange:e=>b(t,"competitionName",e.target.value),className:"input w-full",placeholder:"Tävlingsnamn (valfritt)",disabled:p,"aria-label":`Tävlingsnamn för rad ${t+1}`})]}):"competition_result"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsxs("select",{value:e.competitionType,onChange:e=>b(t,"competitionType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Tävlingstyp för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Select type…"}),cr.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsxs("select",{value:e.disciplineType,onChange:e=>b(t,"disciplineType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Gren för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj gren…"}),mr.map(e=>r.jsx("option",{value:e,children:e},e))]}),"ppc"===String(e.disciplineType||"")&&r.jsxs(r.Fragment,{children:[r.jsx("input",{type:"text",value:e.ppcClass,onChange:e=>b(t,"ppcClass",e.target.value),className:"input w-full",list:`ppc-classes-row-${t}`,placeholder:"PPC-klass",disabled:p,"aria-label":`PPC-klass för rad ${t+1}`}),r.jsx("datalist",{id:`ppc-classes-row-${t}`,children:pr.map(e=>r.jsx("option",{value:e},e))})]}),r.jsx("input",{type:"number",value:e.score,onChange:e=>b(t,"score",e.target.value),className:"input w-full",placeholder:"Poäng",disabled:p,"aria-label":`Poäng för rad ${t+1}`}),r.jsx("input",{type:"text",value:e.competitionName,onChange:e=>b(t,"competitionName",e.target.value),className:"input w-full",placeholder:"Tävlingsnamn (valfritt)",disabled:p,"aria-label":`Tävlingsnamn för rad ${t+1}`})]}):"qualification_result"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"text",value:e.weapon,onChange:e=>b(t,"weapon",e.target.value),className:"input w-full",placeholder:"Weapon",disabled:p,"aria-label":`Vapen för rad ${t+1}`}),r.jsx("input",{type:"number",value:e.score,onChange:e=>b(t,"score",e.target.value),className:"input w-full",placeholder:"Score",disabled:p,"aria-label":`Poäng för rad ${t+1}`})]}):"team_event"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"text",value:e.teamName,onChange:e=>b(t,"teamName",e.target.value),className:"input w-full",placeholder:"Lagnamn",disabled:p,"aria-label":`Lagamn för rad ${t+1}`}),r.jsx("input",{type:"number",min:"1",value:e.position,onChange:e=>b(t,"position",e.target.value),className:"input w-full",placeholder:"Placering",disabled:p,"aria-label":`Placering för rad ${t+1}`}),r.jsx("input",{type:"text",value:e.participants,onChange:e=>b(t,"participants",e.target.value),className:"input w-full",placeholder:"Deltagare (komma-separerad)",disabled:p,"aria-label":`Deltagara för rad ${t+1}`})]}):r.jsx("input",{type:"text",value:e.eventName,onChange:e=>b(t,"eventName",e.target.value),className:"input w-full",placeholder:"Event-namn / detaljer",disabled:p,"aria-label":`Event-namn för rad ${t+1}`}),s.length>0&&r.jsx("div",{id:i,role:"alert",className:"text-danger text-xs mt-1",children:s.join(", ")})]}),r.jsx("td",{className:"px-3 py-2",children:n.length>1&&r.jsx("button",{type:"button",onClick:()=>y(t),className:"btn btn-danger",disabled:p,"aria-label":`Ta bort rad ${t+1}`,children:"Ta bort"})})]},t)})})]})}),r.jsx("div",{className:"sm:hidden sticky bottom-0 safe-bottom bg-bg-secondary/80 backdrop-blur p-3 border-t border-border",children:r.jsx("button",{type:"submit",className:"btn btn-primary w-full min-h-[44px]",disabled:p||0===n.length,children:p?"Lägger till...":"Lägg till alla aktiviteter"})}),r.jsxs("div",{className:"hidden sm:flex gap-2 mb-4",children:[r.jsx("button",{type:"button",onClick:()=>{a([...n,br()])},className:"btn btn-muted disabled:opacity-50",disabled:p,children:"+ Lägg till rad"}),r.jsx("button",{type:"submit",className:"btn btn-primary disabled:opacity-50",disabled:p||0===n.length,children:p?"Lägger till...":"Lägg till alla aktiviteter"})]})]}),r.jsx(Qt,{open:s,onClose:()=>{i(!1),o(-1)},initialRow:l>=0?n[l]:br(),onSave:(e,{addAnother:t}={})=>{a(l>=0?t=>t.map((t,r)=>r===l?e:t):t=>[...t,e]),t||(i(!1),o(-1))},WG:dr,COMP_TYPES:cr,MEDAL_TYPES:hr,APP_TIME_OPTIONS:fr,COMP_DISCIPLINE_TYPES:mr,PPC_CLASS_SUGGESTIONS:pr})]})})}const yr={precision_series:"Precisionsserier",application_series:"Tillämpningsserier",competition_result:"Tävlingsresultat",qualification_result:"Qualification",team_event:"Lag-event",event:"Event",custom:"Custom",special_achievement:"Special achievement",standard_medal:"Standardmedalj"};function vr(e){return yr[e]||e}function jr({achievement:e}){const{addAchievement:n,updateAchievement:a,removeAchievement:s}=or(),[i,l]=t.useState(!1),[o,d]=t.useState("add"),[c,u]=t.useState(null),m=(e,{id:t,medalId:r}={})=>{const n={id:t,medalId:r,type:e.type,year:Number(e.year),weaponGroup:e.weaponGroup,date:e.date,notes:e.notes||""};switch(e.type){case"precision_series":return{...n,points:""===e.points?void 0:Number(e.points??0),competitionName:e.competitionName||void 0};case"application_series":return{...n,timeSeconds:""===e.timeSeconds?void 0:Number(e.timeSeconds??0),hits:""===e.hits?void 0:Number(e.hits??0)};case"standard_medal":return{...n,disciplineType:e.disciplineType||"",competitionName:e.competitionName||"",medalType:e.medalType||""};case"competition_result":return{...n,score:""===e.score?void 0:Number(e.score??0),competitionName:e.competitionName||"",competitionType:e.competitionType||"",disciplineType:e.disciplineType||"",ppcClass:e.ppcClass||""};case"qualification_result":return{...n,weapon:e.weapon||"",score:""===e.score?void 0:Number(e.score??0)};case"team_event":return{...n,teamName:e.teamName||"",position:""===e.position?void 0:Number(e.position??0),participants:String(e.participants||"").split(",").map(e=>e.trim()).filter(Boolean)};default:return{...n,eventName:e.eventName||""}}},p=vr(e.type);return r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"card p-4 flex justify-between items-start",children:[r.jsxs("div",{children:[r.jsxs("div",{className:"flex gap-2 items-center mb-1",children:[r.jsx("span",{className:"font-semibold text-text-primary",children:p}),r.jsxs("span",{className:"text-xs px-2 py-1 rounded bg-bg-secondary text-text-secondary",children:["Grupp ",e.weaponGroup]})]}),r.jsxs("p",{className:"text-sm text-text-secondary",children:[(e.date||"").toString()," • ",e.points," points"]})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{onClick:()=>{var t;d("edit"),u({id:(t=e).id,type:t.type,year:t.year,weaponGroup:t.weaponGroup,date:t.date,points:t.points,timeSeconds:t.timeSeconds,hits:t.hits,competitionType:t.competitionType,disciplineType:t.disciplineType,ppcClass:t.ppcClass,competitionName:t.competitionName,weapon:t.weapon,score:t.score,teamName:t.teamName,position:t.position,participants:Array.isArray(t.participants)?t.participants.join(", "):t.participants||"",eventName:t.eventName,notes:t.notes}),l(!0)},className:"btn btn-muted text-sm","aria-label":`Ändra aktivitet ${e.id}`,children:"Ändra"}),r.jsx("button",{onClick:()=>{d("add");const t=(new Date).toISOString().slice(0,10);u({year:new Date(t).getFullYear(),weaponGroup:e.weaponGroup||"A",type:e.type||"precision_series",date:t,points:"",timeSeconds:"",hits:"",competitionType:"",disciplineType:"",ppcClass:"",competitionName:"",weapon:"",score:"",teamName:"",position:"",participants:"",eventName:"",notes:""}),l(!0)},className:"btn btn-primary text-sm","aria-label":`Logga ny aktivitet för märke ${e.medalId}`,children:"Logga"}),r.jsx("button",{onClick:async()=>{if(confirm("Delete this achievement?"))try{await s(e.id)}catch(t){console.error("Failed to delete:",t)}},className:"btn btn-muted text-red-600 text-sm","aria-label":`Ta bort aktivitet ${e.id}`,children:"Ta bort"})]})]}),r.jsx(Qt,{open:i,onClose:()=>l(!1),initialRow:c,onSave:async t=>{try{if("edit"===o){const r=m(t,{id:e.id,medalId:e.medalId});await a(r)}else{const r=m(t,{medalId:e.medalId});await n(r)}l(!1)}catch(r){console.error("Misslyckades att spara:",r)}},mode:"immediate",submitLabel:"edit"===o?"Spara":"Lägg till"})]})}function wr(e){const t=String(e??"");return t.includes(",")||t.includes('"')||t.includes("\n")?`"${t.replace(/"/g,'""')}"`:t}const Nr=["id","type","year","weaponGroup","points","date","timeSeconds","hits","competitionName","competitionType","disciplineType","ppcClass","weapon","score","teamName","position","eventName","notes","schema_version"];function kr(e=[],t="1"){return[Nr.join(","),...(e||[]).map(e=>Nr.map(r=>"schema_version"===r?t:e?.[r]??"").map(wr).join(","))].join("\n")}function Sr(e,t="achievements.csv"){if("undefined"==typeof document)return;const r=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(r),a=document.createElement("a");a.href=n,a.setAttribute("download",t),document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}function Cr(){const{currentProfile:e}=se(),[n,a]=t.useState(null),[s,i]=t.useState(null),[l,o]=t.useState(null),d=t.useMemo(()=>{if(!e?.prerequisites)return[];let t=[...e.prerequisites];return n&&(t=t.filter(e=>e.year===n)),s&&(t=t.filter(e=>e.type===s)),l&&(t=t.filter(e=>e.weaponGroup===l)),t.sort((e,t)=>new Date(t.date||"1970-01-01")-new Date(e.date||"1970-01-01"))},[e,n,s,l]),c=t.useMemo(()=>e?.prerequisites?[...new Set(e.prerequisites.map(e=>e.year))].sort((e,t)=>t-e):[],[e]);if(!e)return r.jsx("div",{className:"card p-4",children:r.jsx("p",{className:"text-foreground",children:"Välj en profil för att se aktiviteter"})});return r.jsx(Jt,{name:"historyTimeline",children:r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"card p-4",children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsx("h3",{className:"text-lg font-bold text-text-primary",children:"Filters"}),r.jsx("button",{onClick:()=>{Sr(kr(d),"aktivitet-historik.csv")},className:"btn btn-primary text-sm","aria-label":"Exporta aktiviteter som CSV",children:"Exporta CSV"})]}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Year"}),r.jsxs("select",{value:n||"",onChange:e=>a(e.target.value?parseInt(e.target.value):null),className:"select",children:[r.jsx("option",{value:"",children:"All Years"}),c.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Type"}),r.jsxs("select",{value:s||"",onChange:e=>i(e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"All typer"}),["precision_series","competition_result","standard_medal"].map(e=>r.jsx("option",{value:e,children:vr(e)},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Weapon Group"}),r.jsxs("select",{value:l||"",onChange:e=>o(e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla grupper"}),r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]})]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("h3",{className:"text-lg font-bold text-text-primary",children:[d.length," Aktivitet(er)"]}),0===d.length?r.jsx("div",{className:"card p-6 text-center",children:r.jsx("p",{className:"text-text-secondary",children:"Inga aktiviteter än"})}):r.jsx("div",{className:"space-y-3",children:d.map(e=>r.jsx(jr,{achievement:e},e.id))})]})]})})}const Mr=["locked","available","eligible","unlocked"],Ar={locked:{id:"locked",label:"Låst",description:"Förkrav ej uppfyllda.",icon:"Lock",className:"status-badge status--locked"},available:{id:"available",label:"Tillgänglig",description:"Medaljen är tillgänglig att påbörja.",icon:"Compass",className:"status-badge status--available"},eligible:{id:"eligible",label:"Kvalificerad",description:"Förkrav uppfyllda. Prestationskrav återstår.",icon:"BadgeCheck",className:"status-badge status--eligible"},unlocked:{id:"unlocked",label:"Upplåst",description:"Medaljen är erhållen.",icon:"Medal",className:"status-badge status--unlocked"}};function Tr(e){return Ar[e]||null}function Pr(){const{currentProfile:e}=se(),n=t.useMemo(()=>e?.prerequisites?function(e){if(!e||0===e.length)return{totalAchievements:0,avgPointsPerYear:0,bestYear:null,yearsActive:0,pointsByYear:{}};const t={};e.forEach(e=>{const r=e.year;null!=r&&(t[r]||(t[r]=0),t[r]+=Number(e.points||0))});const r=Object.keys(t).map(Number).sort((e,t)=>e-t),n=r.length>0?r.reduce((e,r)=>t[r]>(t[e]??-1/0)?r:e,r[0]):null,a=n?t[n]:0,s=e.reduce((e,t)=>e+Number(t.points||0),0),i=Math.max(1,r.length);return{totalAchievements:e.length,avgPointsPerYear:s/i,bestYear:n,bestYearPoints:a,yearsActive:r.length,pointsByYear:t}}(e.prerequisites):{totalAchievements:0,avgPointsPerYear:0,bestYear:null,yearsActive:0},[e]),a=le(),s=t.useMemo(()=>Mr.map(e=>{const t=Tr(e);return{key:e,label:t.label,icon:t.icon,count:Array.isArray(a?.[e])?a[e].length:0}}),[a]);return e?r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Totala Aktiviteter"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:n.totalAchievements})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Genomsnitt Poäng/År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:Number.isFinite(n.avgPointsPerYear)?n.avgPointsPerYear.toFixed(1):"0.0"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Bästa År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:n.bestYear||"-"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Aktiva År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:n.yearsActive})]}),s.map(({key:e,label:t,icon:n,count:a})=>r.jsxs("div",{className:"card p-4",children:[r.jsxs("p",{className:"text-sm text-muted-foreground font-semibold inline-flex items-center gap-2",children:[r.jsx(Se,{name:n,className:"w-4 h-4","aria-hidden":"true"}),r.jsx("span",{children:t})]}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:a})]},e))]}):null}const Ir=[{value:0,label:"Påminn mig aldrig",description:"Jag säkerhetskopierar manuellt"},{value:30,label:"Var 30:e dag",description:"Rekommenderas för de flesta användare"},{value:90,label:"Var 90:e dag",description:"För avancerade användare"}];function _r(){const{reminderFrequency:e,updateReminderFrequency:t,lastBackupDate:n}=Ue(),a=function(e,t="sv-SE"){return e?new Date(e).toLocaleString(t,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Aldrig"}(n);return r.jsxs("div",{className:"card p-6",children:[r.jsxs("div",{className:"mb-6",children:[r.jsx("h2",{className:"text-lg font-semibold text-color-text-primary mb-2",children:"Säkerhetskopieringspåminnelser"}),r.jsx("p",{className:"text-sm text-color-text-secondary",children:"Få påminnelser om att säkerhetskopiera dina uppgifter regelbundet"})]}),r.jsxs("fieldset",{className:"space-y-3 mb-6",children:[r.jsx("legend",{className:"sr-only",children:"Frekvens för säkerhetskopieringspåminnelser"}),Ir.map(n=>{const a=e===n.value;return r.jsx("div",{className:`\n                p-4 rounded-lg border-2 transition-colors cursor-pointer\n                ${a?"border-color-primary bg-blue-50 dark:bg-blue-950":"border-color-border bg-color-bg-secondary hover:border-color-primary/50"}\n              `,children:r.jsxs("label",{className:"flex items-start gap-3 cursor-pointer",children:[r.jsx("input",{type:"radio",name:"backup-frequency",value:n.value,checked:a,onChange:()=>{return e=n.value,void t(e);var e},className:"\n                    mt-1 w-5 h-5\n                    text-color-primary\n                    focus-visible:ring-2 focus-visible:ring-offset-2\n                    focus-visible:ring-color-primary\n                  "}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("p",{className:"font-medium text-color-text-primary",children:n.label}),r.jsx("p",{className:"text-sm text-color-text-secondary mt-1",children:n.description})]})]})},n.value)})]}),r.jsx("div",{className:"p-4 rounded-lg bg-color-bg-secondary border border-color-border mb-6",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(Se,{name:"Clock",className:"w-4 h-4 text-color-text-secondary","aria-hidden":"true"}),r.jsxs("p",{className:"text-sm text-color-text-secondary",children:["Senaste säkerhetskopia:"," ",r.jsx("span",{className:"font-medium text-color-text-primary",children:a})]})]})}),r.jsx("div",{className:"p-4 rounded-lg bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(Se,{name:"Lightbulb",className:"w-5 h-5 text-blue-600 dark:text-blue-400 shrink-0 mt-0.5","aria-hidden":"true"}),r.jsxs("div",{children:[r.jsx("h3",{className:"font-semibold text-color-text-primary mb-2",children:"Så håller du dina uppgifter säkra"}),r.jsxs("ul",{className:"text-sm text-color-text-secondary space-y-1",children:[r.jsx("li",{children:"• Din data finns bara på den här enheten"}),r.jsx("li",{children:"• Exportera regelbundet för att undvika att förlora framsteg"}),r.jsx("li",{children:"• Lagra säkerhetskopior i iCloud Drive, Google Drive eller USB"}),r.jsx("li",{children:"• Flera säkerhetskopior = extra säkerhet"})]})]})]})})]})}function Dr(){const{currentProfile:e,setProfileFeature:n}=se(),[a,s]=t.useState("add");return e?r.jsx(ce,{children:r.jsxs("div",{className:"space-y-8",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold text-text-primary mb-2",children:"Inställningar"}),r.jsxs("p",{className:"text-text-secondary",children:["Profile: ",r.jsx("span",{className:"font-semibold",children:e.displayName})]})]}),r.jsx(Pr,{}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"section-title mb-2",children:"Funktioner"}),r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("input",{id:"ft-manual-unlock",type:"checkbox",className:"h-5 w-5 mt-0.5",checked:!!e?.features?.allowManualUnlock,onChange:e=>n("allowManualUnlock",e.target.checked)}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"ft-manual-unlock",className:"field-label mb-1",children:"Tillåt manuell upplåsning av märken (förhandskrav gäller fortfarande)"}),r.jsx("p",{className:"field-hint",children:"Du kan låsa upp märken vilket år som helst utan att möta kraven för dem. Förhandskrav och årskrav gäller fortfarande."})]})]}),r.jsx(Jt,{name:"enforceCurrentYearSetting",children:r.jsxs("div",{className:"flex items-start gap-3 mt-3",children:[r.jsx("input",{id:"ft-enforce-current-year",type:"checkbox",className:"h-5 w-5 mt-0.5",checked:!!e?.features?.enforceCurrentYearForSustained,onChange:e=>n("enforceCurrentYearForSustained",e.target.checked)}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"ft-enforce-current-year",className:"field-label mb-1",children:"Kräv innevarande år för återkommande märken"}),r.jsx("p",{className:"field-hint",children:"Märken som kräver återkommande aktiviteter kan bara låsas upp innevarande kalenderår."})]})]})})]}),r.jsx(_r,{}),r.jsxs("div",{className:"flex gap-2 border-b border-border",role:"tablist","aria-label":"Inställnings-sektion",children:[r.jsx("button",{role:"tab","aria-selected":"add"===a,onClick:()=>s("add"),className:"px-4 py-2 font-medium border-b-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary "+("add"===a?"border-primary text-primary":"border-transparent text-text-secondary hover:text-text-primary"),children:"Lägg till aktiviteter"}),r.jsx("button",{role:"tab","aria-selected":"history"===a,onClick:()=>s("history"),className:"px-4 py-2 font-medium border-b-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary "+("history"===a?"border-primary text-primary":"border-transparent text-text-secondary hover:text-text-primary"),children:"Historik"})]}),"add"===a&&r.jsx(gr,{}),"history"===a&&r.jsx(Cr,{})]})}):r.jsx(At,{id:"profile-picker-settings"})}function Fr(){if("undefined"==typeof navigator||!navigator.share)return!1;const e=navigator.userAgent||"";if(!/Android|iPhone|iPad|iPod/.test(e))return!1;if(navigator.canShare)try{const e=new File(["test"],"test.txt",{type:"text/plain"});return navigator.canShare({files:[e]})}catch{return!1}return!0}function qr({blob:e,filename:n,onClose:a,onComplete:i}){const[l,o]=t.useState(null),{markBackupCreated:d}=Ue(),c=Fr(),u=function(){const e="undefined"!=typeof navigator?navigator.userAgent:"",t=/iPad|iPhone|iPod/.test(e),r=/Android/.test(e);return t?"Spara till iCloud Drive, Filer eller annan app":r?"Spara till Google Drive, Filer eller annan app":"Spara till molnlagring eller annan app"}(),m=t.useRef(a);t.useEffect(()=>{m.current=a},[a]),t.useEffect(()=>{const e=e=>{"Escape"===e.key&&m.current()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);const p=r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 bg-black/50 z-[2000]",onClick:a,"aria-hidden":"true"}),r.jsxs("div",{role:"dialog","aria-modal":"true","aria-labelledby":"share-backup-title",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"min(90vw, 28rem)",maxHeight:"90vh",overflow:"auto",zIndex:2001},className:"\n          bg-bg-primary\n          border-2 border-border\n          rounded-xl shadow-2xl\n          p-6\n        ",children:[r.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[r.jsx("div",{className:"\n              w-12 h-12 rounded-full\n              bg-green-500\n              flex items-center justify-center\n            ","aria-hidden":"true",children:r.jsx("svg",{className:"w-7 h-7 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),r.jsx("h2",{id:"share-backup-title",className:"text-2xl font-bold text-foreground",children:"Säkerhetskopia skapad"})]}),r.jsxs("div",{className:"\n            mb-4 p-4 rounded-lg\n            bg-bg-secondary\n            border border-border\n          ",children:[r.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Fil sparad som:"}),r.jsx("p",{className:"font-mono text-sm text-foreground break-all",children:n})]}),r.jsxs("div",{className:"\n            mb-6 p-4 rounded-lg\n            bg-blue-50 dark:bg-blue-950\n            border border-blue-200 dark:border-blue-800\n          ",children:[r.jsxs("p",{className:"font-semibold text-foreground mb-2",children:["💾 ",c?u:"Spara din säkerhetskopia"]}),r.jsx("p",{className:"text-sm text-muted-foreground",children:c?'Tryck "Dela till molnet" för att spara i din molnlagring':"Ladda ner och ladda upp till din föredragna molnlagring"})]}),l&&r.jsx("div",{className:"\n              mb-4 p-3 rounded-lg\n              bg-red-50 dark:bg-red-950\n              border border-red-200 dark:border-red-800\n              text-red-800 dark:text-red-200\n            ",role:"alert","aria-live":"assertive",children:r.jsxs("div",{className:"flex items-start gap-2",children:[r.jsx("svg",{className:"w-5 h-5 shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),r.jsx("p",{className:"text-sm",children:l})]})}),r.jsxs("div",{className:"space-y-2",children:[c&&r.jsxs("button",{onClick:async()=>{let t;try{t=await async function(e,t){if(!Fr())throw new Error("Fildelning stöds inte på den här enheten");const r=new File([e],t,{type:"text/plain"});try{return await navigator.share({files:[r]}),{success:!0}}catch(l){if(console.error("Share failed:",{name:l.name,message:l.message,error:l,fileType:r.type,fileSize:r.size,fileName:r.name}),"AbortError"===l.name)return{success:!1,cancelled:!0};throw new Error(`Delning misslyckades: ${l.name} - ${l.message}`)}}(e,n)}catch(r){return void o(r.message||"Delning misslyckades")}if(t.success)try{await d(),i&&i()}catch(r){o(r.message||"Kunde inte markera säkerhetskopia som skapad")}},className:"\n                w-full py-3 rounded-lg font-medium\n                bg-primary text-primary-foreground\n                hover:bg-primary/90\n                focus-visible:outline-none focus-visible:ring-2\n                focus-visible:ring-offset-2 focus-visible:ring-primary\n                flex items-center justify-center gap-2\n                min-h-[44px]\n              ",children:[r.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"})}),"Dela till molnet"]}),r.jsxs("button",{onClick:async()=>{try{const t=URL.createObjectURL(e),r=document.createElement("a");r.href=t,r.download=n,r.click(),URL.revokeObjectURL(t),await d(),i&&i()}catch(t){o(t.message||"Nedladdning misslyckades")}},className:"\n              w-full py-3 rounded-lg font-medium\n              bg-bg-secondary text-foreground\n              border-2 border-border\n              hover:bg-bg-tertiary\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-border\n              flex items-center justify-center gap-2\n              min-h-[44px]\n            ",children:[r.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Ladda ner till enhet"]}),r.jsx("button",{onClick:a,className:"\n              w-full py-2 text-muted-foreground\n              hover:text-foreground\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-border\n              rounded\n            ",children:"Stäng"})]})]})]});return s.createPortal(p,document.body)}function Er({profile:e}){const[n,a]=t.useState(!1),[s,i]=t.useState(!1),[l,o]=t.useState(null),[d,c]=t.useState(!1),[u,m]=t.useState(null),[p,h]=t.useState("");return r.jsxs("div",{children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-3",children:"Säkerhetskopiera profil"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Ladda ner en komplett säkerhetskopia av din profil som en JSON-fil. Innehåller alla dina aktiviteter och upplåsta märken."}),r.jsx("button",{onClick:async()=>{try{a(!0),o(null);const t=(new Date).toISOString().split("T")[0],r=await Ke(e,{version:"1.0"}),n=`medal-backup-${t}.txt`,s=new Blob([r],{type:"application/json;charset=utf-8"});m(s),h(n),c(!0)}catch(t){console.error("Backup-fel:",t),o(t.message||"Säkerhetskopieringen misslyckades")}finally{a(!1)}},disabled:n,className:"btn btn-primary w-full min-h-[44px]","aria-label":"Säkerhetskopiera profil",children:n?"Skapar säkerhetskopia...":"Säkerhetskopiera profil"}),s&&r.jsxs("div",{className:"alert alert-success mt-4 flex items-center gap-2",role:"status","aria-live":"polite",children:[r.jsx("span",{"aria-hidden":"true",children:"✓"}),r.jsx("span",{children:"Säkerhetskopieringen lyckades!"})]}),l&&r.jsxs("div",{className:"alert alert-error mt-4 flex items-center gap-2",role:"alert","aria-live":"assertive",children:[r.jsx("span",{"aria-hidden":"true",children:"✕"}),r.jsx("span",{children:l})]}),d&&u&&r.jsx(qr,{blob:u,filename:p,onClose:()=>c(!1),onComplete:()=>{c(!1),i(!0),setTimeout(()=>i(!1),3e3)}})]})}function $r({open:n,onClose:a,shareData:s}){const[i,l]=t.useState(null),[o,d]=t.useState(null),[c,u]=t.useState(!1);t.useEffect(()=>{n&&(async()=>{try{d(null);const t=await async function(t,r={}){const n="string"==typeof t?t:JSON.stringify(t);try{const t=await e(()=>import("./vendor-DKE9o5kA.js").then(e=>e.b),[]).catch(()=>null);if(t&&t.toDataURL)return await t.toDataURL(n,{errorCorrectionLevel:"M",width:r.width||256,margin:2})}catch{}return`data:text/plain;base64,${("undefined"!=typeof globalThis&&globalThis.Buffer&&"function"==typeof globalThis.Buffer.from?globalThis.Buffer.from(n,"utf8").toString("base64"):"function"==typeof btoa?btoa(unescape(encodeURIComponent(n))):"")||""}`}(s);l(t)}catch(t){d(t.message||"Misslyckades att skapa QR-kod")}})()},[n,s]);const m="string"==typeof s?s:s?.link||"";return n?r.jsx("div",{className:"\n        fixed inset-0 bg-black/50 flex items-center justify-center p-4\n      ",role:"dialog","aria-modal":"true","aria-label":"Share progress dialog",onClick:a,children:r.jsxs("div",{className:"w-full max-w-md p-6 rounded-lg bg-bg-secondary border border-border",onClick:e=>e.stopPropagation(),children:[r.jsx("h2",{className:"text-xl font-bold text-foreground mb-4",children:"Dela dina framsteg"}),o&&r.jsx("div",{className:"alert alert-error mb-4",role:"alert","aria-live":"assertive",children:o}),!o&&r.jsxs("div",{className:"flex flex-col items-center",children:[i?r.jsx("img",{src:i,alt:"QR code for sharing progress",className:"w-48 h-48"}):r.jsx("div",{className:"w-48 h-48 flex items-center justify-center border border-dashed border-border rounded",children:r.jsx("span",{className:"text-muted-foreground",children:"Skapar..."})}),r.jsx("div",{className:"w-full mt-4",children:r.jsxs("div",{className:"flex gap-2",children:[r.jsx("input",{type:"text",readOnly:!0,value:m,className:"input flex-1","aria-label":"Share link"}),r.jsx("button",{onClick:async()=>{try{if(!m)return;await navigator.clipboard.writeText(m),u(!0),setTimeout(()=>u(!1),2e3)}catch{d("Misslyckades att kopiera länk")}},className:"btn btn-primary min-w-[96px] min-h-[44px]","aria-label":"Copy share link",children:c?"Kopierad":"Kopiera"})]})})]}),r.jsx("div",{className:"mt-6 flex justify-end",children:r.jsx("button",{onClick:a,className:"btn btn-muted min-h-[44px]","aria-label":"Stäng delningsdialogen",children:"Stäng"})})]})}):null}function Yr(){return r.jsxs("div",{className:"\n        p-6 rounded-lg\n        bg-bg-secondary\n        border-2 border-border\n      ",role:"region","aria-labelledby":"restore-guide-title",children:[r.jsx("h3",{id:"restore-guide-title",className:"text-xl font-bold text-foreground mb-4",children:"📖 Så här återställer du från molnet"}),r.jsxs("ol",{className:"space-y-4 text-muted-foreground",children:[r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"1"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Ladda ner din säkerhetskopia"}),r.jsx("p",{className:"text-sm",children:"Hitta din säkerhetskopia i iCloud Drive, Google Drive, OneDrive eller var du sparade den. Ladda ner filen till den här enheten."})]})]}),r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"2"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Öppna den här appen"}),r.jsx("p",{className:"text-sm",children:"Navigera till Inställningar → Data & Säkerhetskopia (eller använd återställningsknappen ovan)."})]})]}),r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"3"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Välj din säkerhetskopia"}),r.jsxs("p",{className:"text-sm",children:['Klicka på "Återställ från säkerhetskopia" och välj den nedladdade filen (t.ex. ',r.jsx("code",{className:"text-xs bg-bg-tertiary px-1.5 py-0.5 rounded font-mono",children:"medal-backup-2026-01-06.json"}),")."]})]})]}),r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"4"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Bekräfta återställning"}),r.jsx("p",{className:"text-sm",children:'Granska förhandsgranskningen (datum, antal aktiviteter) och klicka "Återställ nu". Dina data återställs omedelbart.'})]})]})]}),r.jsxs("div",{className:"\n          mt-6 p-4 rounded-lg\n          bg-blue-50 dark:bg-blue-950\n          border border-blue-200 dark:border-blue-800\n        ",children:[r.jsx("p",{className:"text-sm font-semibold text-foreground mb-2",children:"💡 Proffsråd"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Håll flera säkerhetskopior på olika platser (molnlagring + USB-minne) för extra säkerhet. Säkerhetskopiera regelbundet för att undvika dataförlust."})]})]})}const Lr=["id","type","year","weaponGroup","points","date","timeSeconds","hits","competitionName","competitionType","disciplineType","ppcClass","weapon","score","teamName","position","eventName","notes","schema_version"];function Rr(e){const t=[];let r="",n=!1;for(let a=0;a<e.length;a++){const s=e[a];'"'===s?n&&'"'===e[a+1]?(r+='"',a++):n=!n:","!==s||n?r+=s:(t.push(r),r="")}return t.push(r),t.map(e=>e.trim())}function Gr(e){if(null==e||""===e)return;const t=String(e).replace(",","."),r=Number(t);return Number.isFinite(r)?r:void 0}function Br(e){return null==e?void 0:String(e).trim().toLowerCase()}function Or(e){const t={};for(const r of Object.keys(e)){const n=r.trim(),a=e[r];switch(n){case"type":t.type=Br(a);break;case"year":t.year=Gr(a);break;case"weaponGroup":t.weaponGroup=String(a||"A").trim().toUpperCase();break;case"points":t.points=Gr(a);break;case"timeSeconds":t.timeSeconds=Gr(a);break;case"hits":t.hits=Gr(a);break;case"score":t.score=Gr(a);break;case"position":t.position=Gr(a);break;case"competitionType":case"disciplineType":case"weapon":case"teamName":case"competitionName":case"eventName":case"notes":case"date":{const e="string"==typeof a?a.trim():a;t[n]="competitionType"===n||"disciplineType"===n||"weapon"===n?Br(e):e;break}case"ppcClass":t.ppcClass="string"==typeof a?a.trim():a;break;case"id":t.id=String(a||"").trim()||void 0}}return t}function Ur(e){const t=function(e=""){return String(e).replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n")}(e).filter(Boolean);if(!t.length)return{rows:[],errors:["Empty file"]};const r=Rr(t[0]).map(e=>e.trim()),n=r.filter(e=>!Lr.includes(e)),a=[],s=n.length?[`Okända rubriker: ${n.join(", ")}`]:[];for(let i=1;i<t.length;i++){const e=Rr(t[i]),n={};for(let t=0;t<r.length;t++)n[r[t]]=e[t]??"";a.push(Or(n))}return{rows:a,errors:s}}function Vr(e){return{id:e.id,type:e.type,year:e.year,weaponGroup:e.weaponGroup||"A",points:e.points,date:e.date,timeSeconds:e.timeSeconds,hits:e.hits,competitionName:e.competitionName,competitionType:e.competitionType,disciplineType:e.disciplineType,ppcClass:e.ppcClass,weapon:e.weapon,score:e.score,teamName:e.teamName,position:e.position,eventName:e.eventName,notes:e.notes}}function zr({profile:e,updateProfile:n,upsertAchievements:a}){const[s,i]=t.useState(!1),[l,o]=t.useState(null),[d,c]=t.useState(null),[u,m]=t.useState(null),[p,h]=t.useState({updateById:!0,matchNaturalKey:!1,addNew:!0}),f=t.useRef(null),[x,b]=t.useState(""),[g,y]=t.useState(null),v=t.useMemo(()=>Array.isArray(e?.prerequisites)?e.prerequisites:[],[e?.prerequisites]);return r.jsxs("div",{className:"card p-4 md:col-span-2",role:"region","aria-labelledby":"csv-title",children:[r.jsx("h2",{id:"csv-title",className:"text-lg font-semibold text-foreground mb-3",children:"CSV (Aktiviteter)"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Exportera, redigera och importera aktiviteter via CSV. För säkerhet körs en förhandsgranskning först."}),r.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[r.jsx("button",{onClick:function(){try{Sr(kr(v,"1"),"aktiviteter.csv"),o(null)}catch(e){o(e.message||"Export av CSV misslyckades")}},className:"btn btn-primary min-h-[44px]","aria-label":"Exportera aktiviteter som CSV",children:"Exportera aktiviteter (CSV)"}),r.jsx("button",{onClick:function(){try{Sr(function(e="1"){return[Nr.join(","),["","precision_series","2024","A","45","2024-05-20","","","","","","","","","","","","Exempelrad",e].map(wr).join(",")].join("\n")}("1"),"aktiviteter_mall.csv"),o(null)}catch(e){o(e.message||"Nedladdning av mall misslyckades")}},className:"btn btn-secondary min-h-[44px]","aria-label":"Ladda ned CSV-mall",children:"Ladda ned CSV-mall"})]}),r.jsxs("div",{className:"p-4 rounded-lg border border-border bg-bg-primary",role:"group","aria-labelledby":"csv-import-label",children:[r.jsx("div",{id:"csv-import-label",className:"field-label mb-2",children:"Importera från CSV"}),r.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:()=>f.current?.click(),children:"Välj CSV-fil"}),r.jsx("span",{className:"text-sm text-muted-foreground",children:x||"Ingen fil vald"}),r.jsx("input",{ref:f,type:"file",accept:".csv",className:"hidden",onChange:e=>e.target.files?.[0]&&async function(t){if(t){o(null),m(null),c(null),i(!0);try{const e=Ur(await t.text());if(e.errors?.length)return void o(e.errors.join("; "));const r=e.rows.map(Vr),n=await a(r,{...p,dryRun:!0});c({rows:r,result:n}),b(t.name)}catch(e){o(e.message||"Kunde inte läsa/validera CSV")}finally{i(!1)}}}(e.target.files[0])}),d&&r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:function(){o(null),c(null),m(null),b("")},children:"Rensa"})]}),r.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-3 gap-2",children:[r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:p.updateById,onChange:e=>h(t=>({...t,updateById:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Uppdatera via ID"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:p.matchNaturalKey,onChange:e=>h(t=>({...t,matchNaturalKey:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Matcha utan ID via nyckel (avancerat)"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:p.addNew,onChange:e=>h(t=>({...t,addNew:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Lägg till nya rader"})]})]})]}),s&&r.jsx("div",{className:"alert alert-info mt-3",role:"status","aria-live":"polite",children:"Bearbetar..."}),l&&r.jsx("div",{className:"alert alert-error mt-3",role:"alert","aria-live":"assertive",children:l}),d&&!l&&r.jsxs("div",{className:"mt-3",children:[r.jsx("div",{className:"alert alert-warning",role:"status","aria-live":"polite",children:"Förhandsgranskning: inga ändringar har gjorts än."}),r.jsxs("div",{className:"mt-2 text-sm text-muted-foreground",children:["Skulle importera: ",d.result.added," tillägg, ",d.result.updated," uppdateringar, ",d.result.skipped," överhoppade, ",d.result.failed," fel."]}),r.jsx("button",{onClick:async function(){if(d?.rows?.length){i(!0),o(null),m(null);try{y({userId:e.userId,prerequisites:Array.isArray(e.prerequisites)?[...e.prerequisites]:[]});const t=await a(d.rows,{...p,dryRun:!1});m(t),c(null)}catch(t){o(t.message||"Import av CSV misslyckades")}finally{i(!1)}}},disabled:s,className:"btn btn-primary w-full mt-3 min-h-[44px]",children:"Bekräfta import"})]}),u&&r.jsxs("div",{className:"mt-3",children:[r.jsxs("div",{className:"alert alert-success",role:"status","aria-live":"polite",children:["Import klar: ",u.added," tillagda, ",u.updated," uppdaterade, ",u.skipped," överhoppade, ",u.failed," fel."]}),r.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:async function(){try{if(!g)return;const t={...e,prerequisites:g.prerequisites,lastModified:(new Date).toISOString()};await n(t),y(null),m(null)}catch(t){o(t.message||"Ångra misslyckades")}},children:"Ångra import"})})]}),r.jsxs("details",{className:"mt-4",children:[r.jsx("summary",{className:"cursor-pointer text-sm text-foreground",children:"Hjälp: Kolumner och arbetsflöde"}),r.jsxs("div",{className:"mt-2 text-sm text-muted-foreground space-y-2",children:[r.jsxs("p",{children:["Arbetsflöde: 1) Exportera aktiviteter, 2) Redigera i kalkylark, 3) Importera CSV. Behåll kolumnen ",r.jsx("code",{children:"id"})," för att uppdatera rader; nya rader kan lämna ",r.jsx("code",{children:"id"})," tomt."]}),r.jsx("p",{children:"Tillåtna kolumner (valfria där det inte krävs): id, type, year, weaponGroup, points, date, timeSeconds, hits, competitionName, competitionType, medalType, disciplineType, weapon, score, teamName, position, eventName, notes, schema_version."}),r.jsx("p",{children:"Standardmatchning: Uppdatera via ID. Alternativt kan du matcha utan ID via naturlig nyckel (avancerat)."})]})]})]})}function Kr(){const{currentProfile:e,updateProfile:n,loading:a,error:s,upsertAchievements:i}=se(),[l,d]=t.useState(!1),[c,u]=t.useState(null),[m,p]=t.useState(null),[h,f]=t.useState(!1),x=t.useMemo(()=>!!e&&!a,[e,a]);return r.jsxs("div",{className:"max-w-6xl mx-auto p-4",children:[r.jsx("h1",{className:"section-title mb-4",children:"Data & Säkerhetskopia"}),(s||m)&&r.jsx("div",{className:"alert alert-error mb-4",role:"alert","aria-live":"assertive",children:s||m}),x?r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r.jsx("div",{className:"card md:row-span-2 p-4",children:r.jsx(Er,{profile:e})}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-3",children:"Återställ från säkerhetskopia"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Återställ en hel profil från en säkerhetskopia. Du kan skapa en ny profil eller ersätta en profil med samma ID."}),r.jsx("button",{onClick:()=>f(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Återställ från säkerhetskopia"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-3",children:"Dela profil"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Skapa en QR-kod som innehåller profilen för att dela eller göra backup."}),r.jsx("button",{onClick:async()=>{try{p(null);const t=await Ke(e,{version:"1.0"});u(t),d(!0)}catch(t){p(t.message||"Misslyckades med förberedelser för att dela data")}},className:"btn btn-primary min-h-[44px]","aria-label":"Öppna delningsdialog",children:"Dela via QR-kod"})]}),r.jsx(Jt,{name:"csvImport",className:"md:col-span-2",children:r.jsx(zr,{profile:e,updateProfile:n,upsertAchievements:i})})]}):r.jsxs("div",{className:"card p-6",children:[r.jsx("p",{className:"text-muted-foreground",children:"Välj eller skapa en profil för att säkerhetskopiera/återställa data."}),r.jsx("div",{className:"mt-4",children:r.jsx(o,{to:"/settings",className:"btn btn-primary min-h-[44px]",children:"Till Inställningar"})})]}),x&&r.jsx("div",{className:"mt-6",children:r.jsx(Yr,{})}),r.jsx($r,{open:l,onClose:()=>d(!1),shareData:c}),r.jsx(Me,{id:"profile-import-dialog",open:h,onClose:()=>f(!1)})]})}function Hr({open:e,onClose:n}){const a=t.useContext(me)??{get:()=>"off",enabled:()=>!1,all:()=>({}),set:()=>{},setMany:()=>{},clear:()=>{},clearAll:()=>{},saveToProfile:async()=>!1,clearProfileOverrides:async()=>!1},{currentProfile:i,hydrated:l}=se(),[o,d]=t.useState(!1),[c,u]=t.useState(""),[m,p]=t.useState(()=>a.all()),h=t.useMemo(()=>Object.keys(ue||a.all()||{}).map(e=>({name:e,state:m[e]??a.get(e)??"off",meta:ue?.[e]||{}})),[m,a]);if(!e)return null;const f="idkfa"===c,x="admin-flags-heading",b=r.jsx("div",{className:"fixed inset-0 z-50 grid place-items-center p-4 sm:p-6 bg-black/50",onClick:n,onKeyDown:e=>{"Escape"===e.key&&n?.(),!o&&"Enter"===e.key&&f&&d(!0)},role:"dialog","aria-modal":"true","aria-labelledby":x,children:r.jsx("div",{className:"card flex-none w-full max-w-[calc(100vw-2rem)] sm:max-w-[calc(100vw-3rem)] md:max-w-3xl min-w-[20rem] p-4 md:p-6 mx-auto overflow-auto max-h-[calc(100dvh-3rem)]",onClick:e=>e.stopPropagation(),children:o?r.jsxs(r.Fragment,{children:[r.jsx("h2",{id:x,className:"section-title mb-2",children:"Feature-flaggor"}),r.jsxs("div",{className:"space-y-3 max-h-[60vh] overflow-auto pr-1",children:[h.map(e=>r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-[minmax(0,1fr)_12rem] md:grid-cols-[minmax(0,1fr)_14rem] items-start sm:items-center gap-2 sm:gap-4",children:[r.jsxs("div",{className:"min-w-0",children:[r.jsx("div",{className:"font-medium",children:e.meta.title||e.name}),e.meta.message&&r.jsx("div",{className:"text-xs text-muted-foreground",children:e.meta.message})]}),r.jsx("label",{className:"sr-only",htmlFor:`flag-${e.name}`,children:e.meta.title||e.name}),r.jsxs("select",{id:`flag-${e.name}`,className:"select w-full",value:m[e.name]??"off",onChange:t=>p(r=>({...r,[e.name]:t.target.value})),children:[r.jsx("option",{value:"off",children:"Off"}),r.jsx("option",{value:"preview",children:"Preview"}),r.jsx("option",{value:"on",children:"On"})]})]},e.name)),0===h.length&&r.jsx("div",{className:"text-sm text-muted-foreground",children:"Inga flaggor hittades."})]}),r.jsxs("div",{className:"flex gap-2 justify-between mt-4 safe-bottom",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:async()=>{a.clearAll(),p({}),l&&i&&await(a.clearProfileOverrides?.()),n?.()},children:"Återställ till default"}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:n,children:"Stäng"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:async()=>{a.setMany(m),l&&i&&await(a.saveToProfile?.(m)),n?.()},children:"Spara"})]})]})]}):r.jsxs(r.Fragment,{children:[r.jsx("h2",{id:x,className:"section-title mb-2",children:"Admin-läge"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Ange lösenord för att hantera feature-gates."}),r.jsx("label",{className:"field-label sr-only",htmlFor:"admin-password",children:"Lösenord"}),r.jsx("input",{id:"admin-password",type:"password",className:"input mb-3",placeholder:"Lösenord",value:c,onChange:e=>u(e.target.value),autoFocus:!0}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:n,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>f&&d(!0),disabled:!f,children:"Fortsätt"})]})]})})});return s.createPortal(b,document.body)}function Wr(){const e="undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/",[n,a]=t.useState(!1),s=i(),o=l(),d=(()=>{const e=Dt();return Ft()!==e})();return r.jsxs("div",{className:"max-w-3xl mx-auto px-4 sm:px-6 py-6",children:[r.jsxs("article",{className:"prose prose-headings:text-foreground prose-p:text-foreground prose-a:text-primary dark:prose-invert max-w-none",children:[r.jsxs("header",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:qe}),r.jsx("p",{className:"mt-2 text-muted-foreground",children:"Spåra dina skyttemärken och medaljer enligt Svenska Pistolskytteförbundets regler"})]}),r.jsx(Xe,{id:"disclaimer-about",variant:"warning",text:"Fristående app. Regelboken gäller före appen.",linkUrl:Fe}),r.jsxs("section",{"aria-labelledby":"about-links",className:"mt-8",children:[r.jsx("h2",{id:"about-links",className:"text-2xl font-semibold",children:"Användbara länkar"}),r.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[r.jsx("li",{children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary inline-flex items-center min-h-[44px]",href:Ie,target:"_blank",rel:"noreferrer noopener",children:"SPSF"})}),r.jsx("li",{children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary inline-flex items-center min-h-[44px]",href:_e,target:"_blank",rel:"noreferrer noopener",children:"GitHub-projekt"})})]})]}),r.jsxs("section",{"aria-labelledby":"about-author",className:"mt-8",children:[r.jsx("h2",{id:"about-author",className:"text-2xl font-semibold",children:"Skapare"}),r.jsx("p",{className:"mt-2",children:Ee})]}),r.jsxs("section",{"aria-labelledby":"about-support",className:"mt-8",children:[r.jsx("h2",{id:"about-support",className:"text-2xl font-semibold",children:"Stötta projektet"}),r.jsx("p",{className:"mt-2",children:"Gillar du appen? Bjud utvecklaren på en kaffe."}),r.jsx("p",{className:"mt-2",children:r.jsx("a",{className:"inline-flex items-center rounded focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:De,target:"_blank",rel:"noreferrer noopener","aria-label":"Köp en kaffe (öppnas i ny flik)",children:r.jsx("img",{src:"https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png",alt:"Köp en kaffe",height:"48",className:"h-12",loading:"lazy"})})})]}),r.jsxs("section",{"aria-labelledby":"about-version",className:"mt-8",children:[r.jsxs("h2",{id:"about-version",className:"text-2xl font-semibold",children:[r.jsx("button",{type:"button",className:"inline p-0 m-0 bg-transparent decoration-dotted underline-offset-4 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",onClick:()=>a(!0),"aria-label":"Öppna admin",children:"Om"})," ","versionen"]}),r.jsxs("p",{className:"mt-2",children:["Den här versionen använder skjuthandboken upplaga: ",r.jsx("strong",{children:Re})," (2024)"]}),r.jsxs("p",{className:"mt-2 text-muted-foreground",children:["Version: ",r.jsx("code",{children:xe.version})," • Build: ",r.jsx("code",{children:xe.number})," • Commit: ",r.jsx("code",{children:xe.commit})]}),r.jsxs("p",{className:"mt-1 text-muted-foreground",children:["Byggtid: ",r.jsx("time",{dateTime:xe.timeISO,children:new Date(xe.timeISO).toLocaleString()})]}),r.jsx("div",{className:"mt-3",children:r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>o("/whats-new",{state:{backgroundLocation:s}}),"aria-label":"Visa vad som är nytt",children:d?"Visa nyheter (Ny)":"Visa nyheter"})})]}),r.jsxs("section",{"aria-labelledby":"about-license",className:"mt-8",children:[r.jsx("h2",{id:"about-license",className:"text-2xl font-semibold",children:"Licens"}),r.jsxs("p",{className:"mt-2",children:["Denna applikation är licensierad under ",r.jsx("strong",{children:$e}),". Se ",r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:`${e}LICENSE`,target:"_blank",rel:"noreferrer noopener",children:"LICENSE"})," för fullständig text."]})]})]}),r.jsx(Hr,{open:n,onClose:()=>a(!1)})]})}function Xr(){const e=l(),n=t.useCallback(()=>{je("medals"),e("/medals")},[e]),a=t.useCallback(()=>{je("tree-view"),e("/skill-tree")},[e]);return r.jsxs("div",{className:"space-y-8",children:[r.jsxs("section",{children:[r.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-foreground mb-3",children:"Hjälp & Guider"}),r.jsx("p",{className:"text-base sm:text-lg text-muted-foreground",children:"Välj en guide nedan för att lära dig hur du använder appen"})]}),r.jsxs("section",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[r.jsxs("article",{className:"card p-6 shadow",children:[r.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[r.jsx("div",{className:"p-3 rounded-lg bg-primary/10",children:r.jsx(Se,{name:"List",className:"w-6 h-6 text-primary","aria-hidden":"true"})}),r.jsxs("div",{className:"flex-1",children:[r.jsx("h2",{className:"text-xl font-bold text-foreground mb-1",children:"Märkeslista-guide"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Lär dig hur du söker, filtrerar och utforskar märken"})]})]}),r.jsxs("div",{className:"space-y-2 mb-5",children:[r.jsx("h3",{className:"text-sm font-semibold text-foreground",children:"Guiden visar dig:"}),r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1.5","aria-label":"Steg i märkeslista-guiden",children:[r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Se,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Hur du söker efter märken"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Se,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Använd snabbfilter för statusar"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Se,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Öppna och läs detaljerad information"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Se,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Filtrera efter ålder, kategori och mer"})]})]})]}),r.jsxs("button",{type:"button",onClick:n,className:"btn btn-primary w-full min-h-[44px] inline-flex items-center justify-center gap-2","aria-label":"Starta märkeslista-guide",children:[r.jsx(Se,{name:"PlayCircle",className:"w-5 h-5","aria-hidden":"true"}),r.jsx("span",{children:"Starta Guide"})]})]}),r.jsxs("article",{className:"card p-6 shadow",children:[r.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[r.jsx("div",{className:"p-3 rounded-lg bg-primary/10",children:r.jsx(Se,{name:"Target",className:"w-6 h-6 text-primary","aria-hidden":"true"})}),r.jsxs("div",{className:"flex-1",children:[r.jsx("h2",{className:"text-xl font-bold text-foreground mb-1",children:"Trädvy-guide"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Upptäck hur du navigerar det interaktiva märkesträdet"})]})]}),r.jsxs("div",{className:"space-y-2 mb-5",children:[r.jsx("h3",{className:"text-sm font-semibold text-foreground",children:"Guiden visar dig:"}),r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1.5","aria-label":"Steg i trädvy-guiden",children:[r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Se,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Hur du panorerar och zoomar i trädet"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Se,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Förstå färgkodning och status"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Se,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Klicka på märken för detaljer"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Se,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Använd zoomkontroller och helskärmsläge"})]})]})]}),r.jsxs("button",{type:"button",onClick:a,className:"btn btn-primary w-full min-h-[44px] inline-flex items-center justify-center gap-2","aria-label":"Starta trädvy-guide",children:[r.jsx(Se,{name:"PlayCircle",className:"w-5 h-5","aria-hidden":"true"}),r.jsx("span",{children:"Starta Guide"})]})]})]}),r.jsx("section",{className:"card p-6 shadow",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(Se,{name:"Info",className:"w-5 h-5 shrink-0 mt-0.5 text-muted-foreground","aria-hidden":"true"}),r.jsxs("div",{children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-2",children:"Kontextbaserad hjälp"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:'Du hittar också snabblänkar till guider direkt på sidorna där de är relevanta. Titta efter "Visa guide"-länkarna bredvid sidtitlarna på Märkeslista och Märkesträd.'})]})]})})]})}function Jr({medal:e,open:n,onClose:a,preferredYear:s=null}){const i=ie(),{currentProfile:l,unlockMedal:o}=se(),d=!!l?.features?.allowManualUnlock,[c,u]=t.useState(""),m=t.useMemo(()=>{if(!n||!i||!e?.id)return[];try{return i.getEligibleYears(e.id)||[]}catch{return[]}},[n,i,e]),p=t.useMemo(()=>{const e=l?.dateOfBirth;if(!e)return null;const t=new Date(e).getFullYear();return Number.isFinite(t)?t:null},[l]),h=(new Date).getFullYear(),f=t.useMemo(()=>{if(!i||!e)return null;try{return i.getEarliestCountingYearForMedal(e)}catch{return null}},[i,e]),x=t.useMemo(()=>{if(!i||!e)return null;try{return i.getMinimalUnlockYearForSustained(e)}catch{return null}},[i,e]),b=!!l?.features?.enforceCurrentYearForSustained,g=Array.isArray(e?.requirements)&&e.requirements.some(e=>"sustained_achievement"===e?.type),y=t.useCallback(()=>{if(!i||!e)return"";if(b&&g){if(d)return h;if(m?.includes(h))return h}if(!d)return m&&0!==m.length?Math.min(...m):"";const t=(()=>{const e=[];return"number"==typeof f&&e.push(f),"number"==typeof x&&e.push(x),e.length?Math.max(...e):null})(),r=Math.max(Number.isFinite(p)?p:-1/0,Number.isFinite(t)?t:-1/0);for(let n=Number.isFinite(r)?r:h;n<=h;n++)try{const t=i.checkPrerequisites(e,n);if(t?.allMet)return n}catch{}return b&&g?h:""},[d,i,e,m,f,x,p,h,b,g]),v=t.useMemo(()=>{if(!n)return"";if(null!=s&&Number.isFinite(s))return s;const e=y();return""!==e&&Number.isFinite(e)?e:""},[n,s,y]),j=d?""===c?v:c:null,w=d?""===j?"":Number(j):m.length<=1?m[0]??"":c||(m[0]??""),N=d&&(!Number.isFinite(w)||"number"!=typeof p||w<p||w>h),k=b&&g&&Number.isFinite(w)&&w!==h,S=(()=>{const e=[];return"number"==typeof f&&e.push(f),"number"==typeof x&&e.push(x),0===e.length?null:Math.max(...e)})(),C=d&&Number.isFinite(w)&&"number"==typeof S&&w<S,M=d?!N&&!k&&!C:""!==w,A=t.useMemo(()=>{if(!d)return!0;if(!i||!e?.id||!Number.isFinite(w))return!1;try{const t=i.checkPrerequisites(e,w);return!!t?.allMet}catch{return!1}},[d,i,e,w]),T=d?M&&A:m.length>0&&""!==w,P=async()=>{if(!T)return;const t=`${d?w:Number(w)}-12-31`;await o(e.id,t),a?.()};return r.jsx(ke,{id:"unlock-medal",title:`Lås upp ${e?.displayName||"medalj"}`,open:n,onClose:a,swipeToDismiss:!0,children:d?r.jsxs("form",{className:"space-y-4",onSubmit:e=>{e.preventDefault(),T&&P()},noValidate:!0,children:[r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"unlock-year",className:"field-label mb-2",children:["År","number"==typeof S&&r.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["(Tidigast: ",S,")"]})]}),r.jsx("input",{id:"unlock-year",type:"number",inputMode:"numeric",className:"input py-3 mb-2",min:p??void 0,max:h,list:"eligible-years",value:j,onChange:e=>{const t=e.target.value;u(""===t?"":Number(t))},"aria-invalid":(()=>{if(d&&""!==c&&Number.isFinite(w))return!!(N||k||C||M&&!A)||void 0})(),"aria-describedby":"unlock-year-hint"}),r.jsx("datalist",{id:"eligible-years",children:m.map(e=>r.jsx("option",{value:e},e))}),r.jsxs("p",{id:"unlock-year-hint",className:"field-hint mt-2",children:["Välj ett år mellan ",p," och ",h,". Vi stämmer av med förhandskraven för året."]}),(()=>{if(!d)return null;if(""===c||!Number.isFinite(w))return null;let e=null;return N?e=`Året måste vara mellan ${p} och ${h}.`:k?e="Det här märket kräver att innevarande år väljs.":C?e=`Tidigaste året du kan låsa upp märket är ${S}.`:A||(e=`Förhandskraven är inte mötta för ${w}.`),e?r.jsx("p",{className:"field-hint mt-2 text-danger",role:"status",children:e}):null})()]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:a,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px]",disabled:!T,children:"Lås upp"})]})]}):0===m.length?r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-text-secondary",children:"Inga giltiga år funna."}),r.jsx("div",{className:"flex justify-end",children:r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:a,children:"Stäng"})})]}):1===m.length?r.jsxs("div",{className:"space-y-4",children:[r.jsxs("p",{className:"text-sm",children:["Lås upp för: ",r.jsx("strong",{children:m[0]}),"?"]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:a,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:P,children:"Lås upp"})]})]}):r.jsxs("form",{className:"space-y-4",onSubmit:e=>{e.preventDefault(),""!==w&&P()},noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"unlock-year",className:"field-label mb-2",children:"År"}),r.jsx("select",{id:"unlock-year",className:"select py-3",value:w,onChange:e=>u(Number(e.target.value)),children:m.map(e=>r.jsx("option",{value:e,children:e},e))})]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:a,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px]",disabled:""===w,children:"Lås upp"})]})]})})}function Zr({medal:e,open:t,onClose:n,variant:a="confirm",blockingMedals:s=[],onConfirmRemove:i}){const l=`${e?`remove-medal-${e.id}`:"remove-medal"}-${a}`;return r.jsx(ke,{id:l,title:"confirm"===a?"Ta bort upplåsning":"Kan inte ta bort än",open:t,onClose:n,children:"confirm"===a?r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground",children:"Det här påverkar inte andra märken."}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{type:"button",onClick:n,className:"btn btn-muted flex-1 min-h-[44px]",children:"Avbryt"}),r.jsx("button",{type:"button",onClick:async()=>{const e=await(i?.());e?.ok&&n?.()},className:"btn btn-primary flex-1 min-h-[44px]",children:"Ta bort"})]})]}):r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground",children:"De här upplåsta märkena beror på detta:"}),r.jsx("ul",{className:"text-sm text-muted-foreground list-disc ml-5 space-y-1",children:s.map(e=>r.jsx("li",{className:"break-words",children:e.displayName||e.name},e.id))}),r.jsx("div",{className:"pt-1",children:r.jsx("button",{type:"button",onClick:n,className:"btn btn-muted w-full min-h-[44px]",children:"OK"})})]})})}function Qr({initialValues:e,validate:r,onSubmit:n}){const[a,s]=t.useState({...e||{}}),[i,l]=t.useState({}),o=t.useRef(null),d=t.useCallback(e=>{const{name:t,value:r,type:n}=e.target;let a=r;if("number"===n){const e=Number(r);a=Number.isFinite(e)?e:r}s(e=>({...e,[t]:a}))},[]),c=t.useCallback(e=>{if("function"==typeof r){return r(e)||{}}return{}},[r]),u=t.useCallback(async e=>{e?.preventDefault();const t=c(a);l(t),Object.keys(t).length>0||await(n?.(a))},[n,c,a]),m=t.useMemo(()=>({onTouchStart:e=>{const t=e.changedTouches?.[0];t&&(o.current={x:t.clientX,y:t.clientY,time:Date.now()})},onTouchEnd:()=>{o.current=null}}),[]);return{values:a,errors:i,handleChange:d,handleSubmit:u,validate:c,formProps:m,setValues:s,setErrors:l}}function en({onSubmit:e,loading:t}){const{values:n,errors:a,handleChange:s,handleSubmit:i}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],weaponGroup:"A",eventName:"",notes:""},validate:e=>{const t={};return e.date||(t.date="Datum krävs"),e.weaponGroup||(t.weaponGroup="Vapengrupp krävs"),t},onSubmit:e});return r.jsxs("form",{onSubmit:i,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"c-date",className:"field-label mb-2",children:"Date"}),r.jsx("input",{id:"c-date",type:"date",name:"date","aria-label":"Date","aria-invalid":Boolean(a.date),"aria-describedby":a.date?"c-error-date":void 0,value:n.date,onChange:s,className:"input py-3",required:!0}),a.date&&r.jsx("p",{id:"c-error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"c-weapon-group",className:"field-label mb-2",children:"Weapon Group"}),r.jsxs("select",{id:"c-weapon-group",name:"weaponGroup","aria-label":"Weapon group","aria-invalid":Boolean(a.weaponGroup),"aria-describedby":a.weaponGroup?"c-error-weaponGroup":void 0,value:n.weaponGroup,onChange:s,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"A",children:"Group A"}),r.jsx("option",{value:"B",children:"Group B"}),r.jsx("option",{value:"C",children:"Group C"}),r.jsx("option",{value:"R",children:"Group R"})]}),a.weaponGroup&&r.jsx("p",{id:"c-error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"c-name",className:"field-label mb-2",children:"Title (optional)"}),r.jsx("input",{id:"c-name",type:"text",name:"eventName","aria-label":"Title",value:n.eventName,onChange:s,className:"input py-3"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"c-notes",className:"field-label mb-2",children:"Notes"}),r.jsx("textarea",{id:"c-notes",name:"notes","aria-label":"Notes",value:n.notes,onChange:s,className:"textarea py-3 resize-none",rows:3})]}),r.jsx("button",{type:"submit",disabled:t,className:"btn btn-primary w-full py-3 disabled:opacity-50 disabled:cursor-not-allowed",children:t?"Saving...":"Log Achievement"})]})}function tn(e,t,r=20){if(!e)return null;return function e(n,a=0){if(!n)return null;if(a>=r)return null;if(Array.isArray(n)){for(const t of n){const r=e(t,a+1);if(r)return r}return null}if("object"!=typeof n)return null;if(n.type===t)return n;if(n.and&&Array.isArray(n.and))for(const t of n.and){const r=e(t,a+1);if(r)return r}if(n.or&&Array.isArray(n.or))for(const t of n.or){const r=e(t,a+1);if(r)return r}return null}(e)}function rn(e,t){const r=tn(e?.requirements,t);return r&&r.description||null}function nn({children:e,label:n="Valfria fält",defaultExpanded:a=!1}){const[s,i]=t.useState(a);return r.jsxs("div",{className:"border-t border-border pt-4",children:[r.jsxs("button",{type:"button",onClick:()=>i(!s),className:"\n          flex items-center justify-between w-full\n          text-left text-sm font-medium text-text-secondary\n          hover:text-text-primary transition-colors\n          focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary\n          rounded-md p-2 -m-2\n          min-h-[44px]\n        ","aria-expanded":s,"aria-controls":"optional-fields-content",children:[r.jsxs("span",{className:"flex items-center gap-2",children:[r.jsx(Se,{name:s?"ChevronDown":"ChevronRight",className:"w-4 h-4 transition-transform","aria-hidden":"true"}),n]}),r.jsx("span",{className:"text-xs text-text-tertiary",children:s?"Dölj":"Visa"})]}),s&&r.jsx("div",{id:"optional-fields-content",className:"mt-4 space-y-4 animate-fade-in",style:{animation:"slideDown 0.2s ease-out"},children:e}),r.jsx("style",{jsx:!0,children:"\n        @keyframes slideDown {\n          from {\n            opacity: 0;\n            transform: translateY(-8px);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0);\n          }\n        }\n      "})]})}function an({medal:e,onSubmit:n,onSubmitAndAddAnother:a,loading:s}){const i=t.useRef(null),{currentProfile:l}=se(),o=t.useMemo(()=>function(e,t=null,r=null){let n=null,a=null;if(r&&(n=tn(e?.requirements,r),n&&(a=r)),n||(n=tn(e?.requirements,"running_shooting_course"),n&&(a="running_shooting_course")),n||(n=tn(e?.requirements,"skis_shooting_course"),n&&(a="skis_shooting_course")),!n)return{maxPoints:null,achievementType:r||"running_shooting_course"};const s=t?.sex||"male";let i=n.maxPoints?.[s]??n.maxPoints?.male??null;if(t?.dateOfBirth&&n.ageCategories){const e=new Date(t.dateOfBirth).getFullYear(),r=(new Date).getFullYear()-e,a=n.ageCategories.find(e=>r>=(e.ageMin??0)&&r<=(e.ageMax??999));a?.maxPoints?.[s]&&(i=a.maxPoints[s])}return{maxPoints:i,achievementType:a}}(e,l),[e,l]),d=t.useMemo(()=>rn(e,o.achievementType)||rn(e,"running_shooting_course")||rn(e,"skis_shooting_course"),[e,o.achievementType]),{values:c,errors:u,handleChange:m,handleSubmit:p,validate:h,setErrors:f}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],points:o.maxPoints??"",courseName:"",notes:""},validate:e=>{const t={};e.date||(t.date="Datum krävs");const r=Number(e.points);return""===e.points||void 0===e.points?t.points="Poäng krävs":(!Number.isFinite(r)||r<0)&&(t.points="Poäng måste vara 0 eller högre"),t},onSubmit:e=>n({...e,achievementType:o.achievementType||"running_shooting_course"})});t.useEffect(()=>{const e=setTimeout(()=>{i.current?.focus()},100);return()=>clearTimeout(e)},[]);return r.jsxs("form",{onSubmit:p,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"running-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{ref:i,id:"running-date",type:"date",name:"date","aria-label":"Datum för terränglopp","aria-invalid":Boolean(u.date),"aria-describedby":u.date?"error-date":void 0,value:c.date,onChange:m,className:"input py-3",required:!0}),u.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:u.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"running-points",className:"field-label mb-2",children:"Totalpoäng (lägre är bättre)"}),r.jsx("input",{id:"running-points",type:"number",name:"points",inputMode:"numeric",min:"0",step:"1","aria-label":"Totalpoäng","aria-invalid":Boolean(u.points),"aria-describedby":u.points?"error-points":"hint-points",value:c.points,onChange:m,className:"input py-3",required:!0}),u.points?r.jsx("p",{id:"error-points",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:u.points}):r.jsxs("p",{id:"hint-points",className:"mt-1 text-sm text-text-secondary",children:[d||"Summa av löppoäng och skjutpoäng",o.maxPoints&&` (Max ${o.maxPoints} poäng krävs)`]})]}),r.jsxs(nn,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"running-course",className:"field-label mb-2",children:"Bana / Tävling"}),r.jsx("input",{id:"running-course",type:"text",name:"courseName","aria-label":"Bana eller tävlingsnamn",value:c.courseName,onChange:m,className:"input py-3",placeholder:"T.ex. Klubbmästerskap, DM Springskytte"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"running-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"running-notes",name:"notes","aria-label":"Anteckningar",value:c.notes,onChange:m,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, utrustning, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sparar..."]}):"Spara & Stäng"}),a&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=h(c);f(t),0===Object.keys(t).length&&a&&a({...c,achievementType:o.achievementType||"running_shooting_course"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})}const sn=[{value:"field",label:"Fält"},{value:"precision",label:"Precision"},{value:"national_whole_match",label:"Nationell hel match"},{value:"military_fast_match",label:"Militär snabbmatch"},{value:"ppc",label:"PPC"}],ln=[{value:"bronze",label:"Brons"},{value:"silver",label:"Silver"},{value:"gold",label:"Guld"}];function on({medal:e,medalType:t,formData:r}){const n=(a=r?.date,a||(new Date).toISOString().slice(0,10));var a;const s=Number(r?.year),i=Number.isFinite(s)?s:Number(String(n).slice(0,4)),l=String(r?.weaponGroup||"A").toUpperCase(),o=["A","B","C","R"].includes(l)?l:"A";let d=r?.achievementType||"custom";if(!r?.achievementType)if("running_shooting"===t)d="running_shooting_course";else if("competition"===t){d=Array.isArray(e?.requirements)&&e.requirements.some(e=>"precision_series"===(e?.type||"").toLowerCase())?"precision_series":"competition_result"}else d="qualification"===t?"qualification_result":"team_event"===t?"team_event":"event"===t?"event":"custom";const c={id:r?.id||`achievement-${crypto?.randomUUID?crypto.randomUUID():Date.now()}`,type:d,medalId:e?.id||e?.medalId||"",year:i,weaponGroup:o,date:n,notes:r?.notes||"",createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};switch(d){case"running_shooting_course":case"skis_shooting_course":return{...c,points:Number(r?.points??r?.score??0),courseName:r?.courseName||""};case"precision_series":case"speed_shooting_series":return{...c,points:Number(r?.points??r?.score??0),competitionName:r?.competitionName||""};case"application_series":return{...c,hits:Number(r?.hits??0),timeSeconds:Number(r?.timeSeconds??0),competitionName:r?.competitionName||""};case"standard_medal":return{...c,disciplineType:String(r?.disciplineType||"").toLowerCase(),medalType:String(r?.medalType??e?.tier??"").toLowerCase()};case"competition_result":return{...c,score:Number(r?.score??0),competitionName:r?.competitionName||"",competitionType:String(r?.competitionType||"").toLowerCase(),disciplineType:String(r?.disciplineType||"").toLowerCase(),ppcClass:r?.ppcClass||""};case"competition_performance":return{...c,points:Number(r?.points??r?.score??0),score:Number(r?.score??0),scorePercent:Number(r?.scorePercent??0),maxScore:Number(r?.maxScore??0),competitionName:r?.competitionName||"",disciplineType:String(r?.disciplineType||"").toLowerCase()};case"air_pistol_precision":return{...c,points:Number(r?.points??r?.score??0),seriesName:r?.seriesName||r?.competitionName||""};case"qualification_result":return{...c,weapon:r?.weapon||"",score:Number(r?.score??0)};case"team_event":return{...c,teamName:r?.teamName||"",position:Number(r?.position??0),participants:(r?.participants||"").split(",").map(e=>e.trim()).filter(Boolean)};default:return{...c,eventName:r?.eventName||""}}}const dn={competition:function({medal:e,onSubmit:t,loading:n}){const{values:a,errors:s,handleChange:i,handleSubmit:l}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],weaponGroup:"A",score:"",competitionName:"",notes:""},validate:e=>function(e){const t={};e.date?sr(e.date)&&(t.date="Date cannot be in the future"):t.date="Date is required",e.weaponGroup&&rr.includes(e.weaponGroup)||(t.weaponGroup="Select a valid weapon group");const r=String(e.disciplineType||"").toLowerCase();nr.includes(r)||(t.disciplineType="Select a valid discipline"),"ppc"===r&&(String(e.ppcClass||"").trim()||(t.ppcClass="PPC class is required for PPC discipline"));""===e.score||null==e.score||Number.isNaN(Number(e.score))?t.score="Enter a valid score/points":Number(e.score)<0&&(t.score="Score cannot be negative");return t}(e),onSubmit:t});return r.jsxs("form",{onSubmit:l,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"achievement-date",className:"field-label mb-2",children:"Date of Achievement"}),r.jsx("input",{id:"achievement-date",type:"date",name:"date","aria-label":"Achievement date","aria-invalid":Boolean(s.date),"aria-describedby":s.date?"error-date":void 0,value:a.date,onChange:i,className:"input py-3",required:!0}),s.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"weapon-group",className:"field-label mb-2",children:"Weapon Group"}),r.jsxs("select",{id:"weapon-group",name:"weaponGroup","aria-label":"Weapon group","aria-invalid":Boolean(s.weaponGroup),"aria-describedby":s.weaponGroup?"error-weaponGroup":void 0,value:a.weaponGroup,onChange:i,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"A",children:"Group A"}),r.jsx("option",{value:"B",children:"Group B"}),r.jsx("option",{value:"C",children:"Group C"}),r.jsx("option",{value:"R",children:"Group R"})]}),s.weaponGroup&&r.jsx("p",{id:"error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"achievement-score",className:"field-label mb-2",children:"Score / Points"}),r.jsx("input",{id:"achievement-score",type:"number",name:"score",inputMode:"decimal","aria-label":"Score or points","aria-invalid":Boolean(s.score),"aria-describedby":s.score?"error-score":void 0,value:a.score,onChange:i,className:"input py-3",required:!0}),s.score&&r.jsx("p",{id:"error-score",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.score})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-name",className:"field-label mb-2",children:"Competition (optional)"}),r.jsx("input",{id:"competition-name",type:"text",name:"competitionName","aria-label":"Competition name",value:a.competitionName,onChange:i,className:"input py-3"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"achievement-notes",className:"field-label mb-2",children:"Notes (optional)"}),r.jsx("textarea",{id:"achievement-notes",name:"notes","aria-label":"Notes",value:a.notes,onChange:i,className:"textarea py-3 resize-none",rows:3})]}),r.jsx("button",{type:"submit",disabled:n,className:"btn btn-primary w-full py-3 disabled:opacity-50 disabled:cursor-not-allowed",children:n?"Saving...":"Log Achievement"})]})},qualification:function({onSubmit:e,loading:t}){const{values:n,errors:a,handleChange:s,handleSubmit:i}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],weaponGroup:"A",weapon:"",score:"",notes:""},validate:e=>{const t={};e.date||(t.date="Date is required"),e.weaponGroup||(t.weaponGroup="Weapon group is required"),e.weapon?.trim()||(t.weapon="Weapon is required");const r=Number(e.score);return(!Number.isFinite(r)||r<0)&&(t.score="Enter a valid score"),t},onSubmit:e});return r.jsxs("form",{onSubmit:i,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"q-date",className:"field-label mb-2",children:"Date"}),r.jsx("input",{id:"q-date",type:"date",name:"date","aria-label":"Qualification date","aria-invalid":Boolean(a.date),"aria-describedby":a.date?"q-error-date":void 0,value:n.date,onChange:s,className:"input py-3",required:!0}),a.date&&r.jsx("p",{id:"q-error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"q-weapon-group",className:"field-label mb-2",children:"Weapon Group"}),r.jsxs("select",{id:"q-weapon-group",name:"weaponGroup","aria-label":"Weapon group","aria-invalid":Boolean(a.weaponGroup),"aria-describedby":a.weaponGroup?"q-error-weaponGroup":void 0,value:n.weaponGroup,onChange:s,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"A",children:"Group A"}),r.jsx("option",{value:"B",children:"Group B"}),r.jsx("option",{value:"C",children:"Group C"}),r.jsx("option",{value:"R",children:"Group R"})]}),a.weaponGroup&&r.jsx("p",{id:"q-error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"q-weapon",className:"field-label mb-2",children:"Weapon"}),r.jsx("input",{id:"q-weapon",type:"text",name:"weapon","aria-label":"Weapon","aria-invalid":Boolean(a.weapon),"aria-describedby":a.weapon?"q-error-weapon":void 0,value:n.weapon,onChange:s,className:"input py-3",required:!0}),a.weapon&&r.jsx("p",{id:"q-error-weapon",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.weapon})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"q-score",className:"field-label mb-2",children:"Score"}),r.jsx("input",{id:"q-score",type:"number",name:"score","aria-label":"Score","aria-invalid":Boolean(a.score),"aria-describedby":a.score?"q-error-score":void 0,value:n.score,onChange:s,className:"input py-3",required:!0}),a.score&&r.jsx("p",{id:"q-error-score",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.score})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"q-notes",className:"field-label mb-2",children:"Notes (optional)"}),r.jsx("textarea",{id:"q-notes",name:"notes","aria-label":"Notes",value:n.notes,onChange:s,className:"textarea py-3 resize-none",rows:3})]}),r.jsx("button",{type:"submit",disabled:t,className:"btn btn-primary w-full py-3 disabled:opacity-50 disabled:cursor-not-allowed",children:t?"Saving...":"Log Qualification"})]})},team_event:function({onSubmit:e,loading:t}){const{values:n,errors:a,handleChange:s,handleSubmit:i}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],weaponGroup:"A",teamName:"",position:"",participants:"",notes:""},validate:e=>{const t={};e.date||(t.date="Date is required"),e.weaponGroup||(t.weaponGroup="Weapon group is required"),e.teamName?.trim()||(t.teamName="Team name is required");const r=Number(e.position);return(!Number.isFinite(r)||r<1)&&(t.position="Enter a valid position (1 or higher)"),t},onSubmit:e});return r.jsxs("form",{onSubmit:i,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-date",className:"field-label mb-2",children:"Date"}),r.jsx("input",{id:"t-date",type:"date",name:"date","aria-label":"Team event date","aria-invalid":Boolean(a.date),"aria-describedby":a.date?"t-error-date":void 0,value:n.date,onChange:s,className:"input py-3",required:!0}),a.date&&r.jsx("p",{id:"t-error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-weapon-group",className:"field-label mb-2",children:"Weapon Group"}),r.jsxs("select",{id:"t-weapon-group",name:"weaponGroup","aria-label":"Weapon group","aria-invalid":Boolean(a.weaponGroup),"aria-describedby":a.weaponGroup?"t-error-weaponGroup":void 0,value:n.weaponGroup,onChange:s,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"A",children:"Group A"}),r.jsx("option",{value:"B",children:"Group B"}),r.jsx("option",{value:"C",children:"Group C"}),r.jsx("option",{value:"R",children:"Group R"})]}),a.weaponGroup&&r.jsx("p",{id:"t-error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-team",className:"field-label mb-2",children:"Team Name"}),r.jsx("input",{id:"t-team",type:"text",name:"teamName","aria-label":"Team name","aria-invalid":Boolean(a.teamName),"aria-describedby":a.teamName?"t-error-team":void 0,value:n.teamName,onChange:s,className:"input py-3",required:!0}),a.teamName&&r.jsx("p",{id:"t-error-team",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.teamName})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-position",className:"field-label mb-2",children:"Position (1-10)"}),r.jsx("input",{id:"t-position",type:"number",name:"position","aria-label":"Team position","aria-invalid":Boolean(a.position),"aria-describedby":a.position?"t-error-position":void 0,min:1,max:10,value:n.position,onChange:s,className:"input py-3",required:!0}),a.position&&r.jsx("p",{id:"t-error-position",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.position})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-participants",className:"field-label mb-2",children:"Participants (comma-separated)"}),r.jsx("input",{id:"t-participants",type:"text",name:"participants","aria-label":"Participants",value:n.participants,onChange:s,className:"input py-3",placeholder:"Anna, Björn, Carin"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-notes",className:"field-label mb-2",children:"Notes (optional)"}),r.jsx("textarea",{id:"t-notes",name:"notes","aria-label":"Notes",value:n.notes,onChange:s,className:"textarea py-3 resize-none",rows:3})]}),r.jsx("button",{type:"submit",disabled:t,className:"btn btn-primary w-full py-3 disabled:opacity-50 disabled:cursor-not-allowed",children:t?"Saving...":"Log Team Event"})]})},event:function({onSubmit:e,loading:t}){const{values:n,errors:a,handleChange:s,handleSubmit:i}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],weaponGroup:"A",eventName:"",notes:""},validate:e=>{const t={};return e.date||(t.date="Datum krävs"),e.weaponGroup||(t.weaponGroup="Vapengrupp krävs"),e.eventName?.trim()||(t.eventName="Händelsenamn krävs"),t},onSubmit:e});return r.jsxs("form",{onSubmit:i,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"e-date",className:"field-label mb-2",children:"Date"}),r.jsx("input",{id:"e-date",type:"date",name:"date","aria-label":"Event date","aria-invalid":Boolean(a.date),"aria-describedby":a.date?"e-error-date":void 0,value:n.date,onChange:s,className:"input py-3",required:!0}),a.date&&r.jsx("p",{id:"e-error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"e-weapon-group",className:"field-label mb-2",children:"Weapon Group"}),r.jsxs("select",{id:"e-weapon-group",name:"weaponGroup","aria-label":"Weapon group","aria-invalid":Boolean(a.weaponGroup),"aria-describedby":a.weaponGroup?"e-error-weaponGroup":void 0,value:n.weaponGroup,onChange:s,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"A",children:"Group A"}),r.jsx("option",{value:"B",children:"Group B"}),r.jsx("option",{value:"C",children:"Group C"}),r.jsx("option",{value:"R",children:"Group R"})]}),a.weaponGroup&&r.jsx("p",{id:"e-error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"e-name",className:"field-label mb-2",children:"Event Name"}),r.jsx("input",{id:"e-name",type:"text",name:"eventName","aria-label":"Event name","aria-invalid":Boolean(a.eventName),"aria-describedby":a.eventName?"e-error-name":void 0,value:n.eventName,onChange:s,className:"input py-3",required:!0}),a.eventName&&r.jsx("p",{id:"e-error-name",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:a.eventName})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"e-notes",className:"field-label mb-2",children:"Notes (optional)"}),r.jsx("textarea",{id:"e-notes",name:"notes","aria-label":"Notes",value:n.notes,onChange:s,className:"textarea py-3 resize-none",rows:3})]}),r.jsx("button",{type:"submit",disabled:t,className:"btn btn-primary w-full py-3 disabled:opacity-50 disabled:cursor-not-allowed",children:t?"Saving...":"Log Event"})]})},custom:en},cn={precision_series:function({medal:e,onSubmit:n,onSubmitAndAddAnother:a,loading:s}){const i=t.useRef(null),{currentProfile:l}=se(),o=t.useMemo(()=>function(e,t=null){const r=tn(e?.requirements,"precision_series");if(!r)return{weaponGroup:"A",points:""};const n="A";let a=r.pointThresholds?.[n]?.min;if(t?.dateOfBirth&&r.ageCategories){const e=new Date(t.dateOfBirth).getFullYear(),s=(new Date).getFullYear()-e,i=r.ageCategories.find(e=>s>=(e.ageMin??0)&&s<=(e.ageMax??999));i?.pointThresholds?.[n]?.min&&(a=i.pointThresholds[n].min)}return{weaponGroup:n,points:a??""}}(e,l),[e,l]),d=t.useMemo(()=>rn(e,"precision_series"),[e]),{values:c,errors:u,handleChange:m,handleSubmit:p,validate:h,setErrors:f}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],weaponGroup:o.weaponGroup,points:o.points,competitionName:"",notes:""},validate:e=>{const t={};e.date||(t.date="Datum krävs");const r=Number(e.points);return(!Number.isFinite(r)||r<0||r>50)&&(t.points="Poäng måste vara mellan 0-50"),t},onSubmit:e=>n({...e,achievementType:"precision_series"})});return t.useEffect(()=>{const e=setTimeout(()=>{i.current?.focus()},100);return()=>clearTimeout(e)},[]),r.jsxs("form",{onSubmit:p,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"precision-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{ref:i,id:"precision-date",type:"date",name:"date","aria-label":"Datum för precisionsserie","aria-invalid":Boolean(u.date),"aria-describedby":u.date?"error-date":void 0,value:c.date,onChange:m,className:"input py-3",required:!0}),u.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:u.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"precision-weapon-group",className:"field-label mb-2",children:"Vapengrupp"}),r.jsxs("select",{id:"precision-weapon-group",name:"weaponGroup","aria-label":"Vapengrupp","aria-invalid":Boolean(u.weaponGroup),"aria-describedby":u.weaponGroup?"error-weaponGroup":void 0,value:c.weaponGroup,onChange:m,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"A",children:"Grupp A"}),r.jsx("option",{value:"B",children:"Grupp B"}),r.jsx("option",{value:"C",children:"Grupp C"}),r.jsx("option",{value:"R",children:"Grupp R"})]}),u.weaponGroup&&r.jsx("p",{id:"error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:u.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"precision-points",className:"field-label mb-2",children:"Poäng (0-50)"}),r.jsx("input",{id:"precision-points",type:"number",name:"points",inputMode:"decimal",min:"0",max:"50",step:"0.1","aria-label":"Poäng i precisionsserie","aria-invalid":Boolean(u.points),"aria-describedby":u.points?"error-points":"hint-points",value:c.points,onChange:m,className:"input py-3",required:!0}),u.points?r.jsx("p",{id:"error-points",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:u.points}):r.jsxs("p",{id:"hint-points",className:"mt-1 text-sm text-text-secondary",children:[d||"Resultat från 5 skott på 25m pistoltavla",o.points&&` (Minst ${o.points} poäng krävs)`]})]}),r.jsxs(nn,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"precision-competition",className:"field-label mb-2",children:"Tävling / Bana"}),r.jsx("input",{id:"precision-competition",type:"text",name:"competitionName","aria-label":"Tävlingsnamn",value:c.competitionName,onChange:m,className:"input py-3",placeholder:"T.ex. Klubbmästerskap"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"precision-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"precision-notes",name:"notes","aria-label":"Anteckningar",value:c.notes,onChange:m,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, vapen använt, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sparar..."]}):"Spara & Stäng"}),a&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=h(c);f(t),0===Object.keys(t).length&&a&&a({...c,achievementType:"precision_series"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})},application_series:function({medal:e,onSubmit:n,onSubmitAndAddAnother:a,loading:s}){const i=t.useMemo(()=>function(e){const t=tn(e?.requirements,"application_series");if(!t)return{weaponGroup:"A",hits:"",timeSeconds:""};const r=t.thresholds?.A;return{weaponGroup:"A",hits:r?.minHits??"",timeSeconds:r?.maxTimeSeconds??""}}(e),[e]),l=t.useMemo(()=>rn(e,"application_series"),[e]),{values:o,errors:d,handleChange:c,handleSubmit:u,validate:m,setErrors:p}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],weaponGroup:i.weaponGroup,hits:i.hits,timeSeconds:i.timeSeconds,competitionName:"",notes:""},validate:e=>{const t={};e.date||(t.date="Datum krävs");const r=Number(e.hits);(!Number.isFinite(r)||r<0||r>6)&&(t.hits="Antal träffar måste vara mellan 0-6");const n=Number(e.timeSeconds);return(!Number.isFinite(n)||n<=0)&&(t.timeSeconds="Tid måste vara större än 0 sekunder"),t},onSubmit:e=>n({...e,achievementType:"application_series"})});return r.jsxs("form",{onSubmit:u,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{id:"application-date",type:"date",name:"date","aria-label":"Datum för tillämpningsserie","aria-invalid":Boolean(d.date),"aria-describedby":d.date?"error-date":void 0,value:o.date,onChange:c,className:"input py-3",required:!0}),d.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-weapon-group",className:"field-label mb-2",children:"Vapengrupp"}),r.jsxs("select",{id:"application-weapon-group",name:"weaponGroup","aria-label":"Vapengrupp","aria-invalid":Boolean(d.weaponGroup),"aria-describedby":d.weaponGroup?"error-weaponGroup":void 0,value:o.weaponGroup,onChange:c,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"A",children:"Grupp A"}),r.jsx("option",{value:"B",children:"Grupp B"}),r.jsx("option",{value:"C",children:"Grupp C"}),r.jsx("option",{value:"R",children:"Grupp R"})]}),d.weaponGroup&&r.jsx("p",{id:"error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-hits",className:"field-label mb-2",children:"Antal träffar (0-6)"}),r.jsx("input",{id:"application-hits",type:"number",name:"hits",inputMode:"numeric",min:"0",max:"6",step:"1","aria-label":"Antal träffar i tillämpningsserie","aria-invalid":Boolean(d.hits),"aria-describedby":d.hits?"error-hits":"hint-hits",value:o.hits,onChange:c,className:"input py-3",required:!0}),d.hits?r.jsx("p",{id:"error-hits",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.hits}):r.jsxs("p",{id:"hint-hits",className:"mt-1 text-sm text-text-secondary",children:[l||"6 skott på B100 (50m) eller 1/6 mål C30 (25m)",i.hits&&` (Minst ${i.hits} träffar krävs)`]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-time",className:"field-label mb-2",children:"Tid (sekunder)"}),r.jsx("input",{id:"application-time",type:"number",name:"timeSeconds",inputMode:"decimal",min:"0",step:"0.1","aria-label":"Tid i sekunder","aria-invalid":Boolean(d.timeSeconds),"aria-describedby":d.timeSeconds?"error-time":"hint-time",value:o.timeSeconds,onChange:c,className:"input py-3",required:!0,placeholder:"T.ex. 45.5"}),d.timeSeconds?r.jsx("p",{id:"error-time",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.timeSeconds}):r.jsxs("p",{id:"hint-time",className:"mt-1 text-sm text-text-secondary",children:["Skjuttid från första till sista skottet",i.timeSeconds&&` (Max ${i.timeSeconds}s krävs)`]})]}),r.jsxs(nn,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-competition",className:"field-label mb-2",children:"Tävling / Bana"}),r.jsx("input",{id:"application-competition",type:"text",name:"competitionName","aria-label":"Tävlingsnamn",value:o.competitionName,onChange:c,className:"input py-3",placeholder:"T.ex. Träning, Klubbmästerskap"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"application-notes",name:"notes","aria-label":"Anteckningar",value:o.notes,onChange:c,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, utgångsställning, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Stäng"}),a&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=m(o);p(t),0===Object.keys(t).length&&a&&a({...o,achievementType:"application_series"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})},speed_shooting_series:function({medal:e,onSubmit:n,onSubmitAndAddAnother:a,loading:s}){const i=t.useMemo(()=>function(e){const t=tn(e?.requirements,"speed_shooting_series");if(!t)return{weaponGroup:"A",points:""};const r=t.pointThresholds?.A?.min;return{weaponGroup:"A",points:r??""}}(e),[e]),l=t.useMemo(()=>rn(e,"speed_shooting_series"),[e]),{values:o,errors:d,handleChange:c,handleSubmit:u,validate:m,setErrors:p}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],weaponGroup:i.weaponGroup,points:i.points,competitionName:"",notes:""},validate:e=>{const t={};e.date||(t.date="Datum krävs");const r=Number(e.points);return(!Number.isFinite(r)||r<0||r>50)&&(t.points="Poäng måste vara mellan 0-50"),t},onSubmit:e=>n({...e,achievementType:"speed_shooting_series"})});return r.jsxs("form",{onSubmit:u,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"speed-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{id:"speed-date",type:"date",name:"date","aria-label":"Datum för duellserie","aria-invalid":Boolean(d.date),"aria-describedby":d.date?"error-date":void 0,value:o.date,onChange:c,className:"input py-3",required:!0}),d.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"speed-weapon-group",className:"field-label mb-2",children:"Vapengrupp"}),r.jsxs("select",{id:"speed-weapon-group",name:"weaponGroup","aria-label":"Vapengrupp","aria-invalid":Boolean(d.weaponGroup),"aria-describedby":d.weaponGroup?"error-weaponGroup":void 0,value:o.weaponGroup,onChange:c,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"A",children:"Grupp A"}),r.jsx("option",{value:"B",children:"Grupp B"}),r.jsx("option",{value:"C",children:"Grupp C"}),r.jsx("option",{value:"R",children:"Grupp R"})]}),d.weaponGroup&&r.jsx("p",{id:"error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"speed-points",className:"field-label mb-2",children:"Poäng (0-50)"}),r.jsx("input",{id:"speed-points",type:"number",name:"points",inputMode:"decimal",min:"0",max:"50",step:"0.1","aria-label":"Poäng i duellserie","aria-invalid":Boolean(d.points),"aria-describedby":d.points?"error-points":"hint-points",value:o.points,onChange:c,className:"input py-3",required:!0}),d.points?r.jsx("p",{id:"error-points",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.points}):r.jsxs("p",{id:"hint-points",className:"mt-1 text-sm text-text-secondary",children:[l||"Resultat från duellskjutning",i.points&&` (Minst ${i.points} poäng krävs)`]})]}),r.jsxs(nn,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"speed-competition",className:"field-label mb-2",children:"Tävling / Bana"}),r.jsx("input",{id:"speed-competition",type:"text",name:"competitionName","aria-label":"Tävlingsnamn",value:o.competitionName,onChange:c,className:"input py-3",placeholder:"T.ex. Elitmärkestävling"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"speed-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"speed-notes",name:"notes","aria-label":"Anteckningar",value:o.notes,onChange:c,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, vapen använt, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Stäng"}),a&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=m(o);p(t),0===Object.keys(t).length&&a&&a({...o,achievementType:"speed_shooting_series"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})},air_pistol_precision:function({medal:e,onSubmit:n,onSubmitAndAddAnother:a,loading:s}){const i=t.useRef(null),l=t.useMemo(()=>function(e){const t=tn(e?.requirements,"air_pistol_precision");return t?{minPointsPerSeries:t.minPointsPerSeries??null,minSeries:t.minSeries??5}:{minPointsPerSeries:null,minSeries:5}}(e),[e]),o=t.useMemo(()=>rn(e,"air_pistol_precision"),[e]),{values:d,errors:c,handleChange:u,handleSubmit:m,validate:p,setErrors:h}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],points:l.minPointsPerSeries??"",seriesName:"",notes:""},validate:e=>{const t={};e.date||(t.date="Datum krävs");const r=Number(e.points);return""===e.points||void 0===e.points?t.points="Poäng krävs":(!Number.isFinite(r)||r<0||r>100)&&(t.points="Poäng måste vara mellan 0-100"),t},onSubmit:e=>n({...e,achievementType:"air_pistol_precision"})});return t.useEffect(()=>{const e=setTimeout(()=>{i.current?.focus()},100);return()=>clearTimeout(e)},[]),r.jsxs("form",{onSubmit:m,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"airpistol-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{ref:i,id:"airpistol-date",type:"date",name:"date","aria-label":"Datum för luftpistolserie","aria-invalid":Boolean(c.date),"aria-describedby":c.date?"error-date":void 0,value:d.date,onChange:u,className:"input py-3",required:!0}),c.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:c.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"airpistol-points",className:"field-label mb-2",children:"Poäng (0-100)"}),r.jsx("input",{id:"airpistol-points",type:"number",name:"points",inputMode:"decimal",min:"0",max:"100",step:"1","aria-label":"Poäng i luftpistolserie","aria-invalid":Boolean(c.points),"aria-describedby":c.points?"error-points":"hint-points",value:d.points,onChange:u,className:"input py-3",required:!0}),c.points?r.jsx("p",{id:"error-points",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:c.points}):r.jsxs("p",{id:"hint-points",className:"mt-1 text-sm text-text-secondary",children:[o||"10 skott mot 10-ringad internationell luftpistoltavla",l.minPointsPerSeries&&` (Minst ${l.minPointsPerSeries} poäng krävs)`]})]}),r.jsxs(nn,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"airpistol-series",className:"field-label mb-2",children:"Serienamn"}),r.jsx("input",{id:"airpistol-series",type:"text",name:"seriesName","aria-label":"Serienamn",value:d.seriesName,onChange:u,className:"input py-3",placeholder:"T.ex. Serie 1, Klubbtävling"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"airpistol-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"airpistol-notes",name:"notes","aria-label":"Anteckningar",value:d.notes,onChange:u,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, pistol använd, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sparar..."]}):"Spara & Stäng"}),a&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=p(d);h(t),0===Object.keys(t).length&&a&&a({...d,achievementType:"air_pistol_precision"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})},competition_performance:function({medal:e,onSubmit:n,onSubmitAndAddAnother:a,loading:s}){const i=t.useRef(null),{currentProfile:l}=se(),o=t.useMemo(()=>function(e,t=null){const r=tn(e?.requirements,"competition_performance");if(!r)return{disciplineType:"",weaponGroup:"A",maxPoints:null,thresholds:null};const n=r.disciplineType||"",a=t?.sex||"male";let s=null;return r.maxPoints&&(s=r.maxPoints[a]??r.maxPoints.male??null),{disciplineType:n,weaponGroup:"A",maxPoints:s,thresholds:r.pointThresholdPercent||null}}(e,l),[e,l]),d=t.useMemo(()=>rn(e,"competition_performance"),[e]),c=Boolean(o.disciplineType),u=e=>"field"===e.disciplineType&&e.maxScore>0?Math.round(Number(e.score)/Number(e.maxScore)*100):0,{values:m,errors:p,handleChange:h,handleSubmit:f,validate:x,setErrors:b}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],disciplineType:o.disciplineType||"",weaponGroup:o.weaponGroup||"A",score:"",maxScore:"",points:o.maxPoints??"",competitionName:"",notes:""},validate:e=>{const t={};if(e.date||(t.date="Datum krävs"),e.disciplineType||(t.disciplineType="Disciplin krävs"),"field"===e.disciplineType){const r=Number(e.score),n=Number(e.maxScore);(""===e.score||!Number.isFinite(r)||r<0)&&(t.score="Uppnådd poäng krävs (0 eller högre)"),(""===e.maxScore||!Number.isFinite(n)||n<=0)&&(t.maxScore="Maxpoäng krävs (större än 0)"),r>n&&Number.isFinite(r)&&Number.isFinite(n)&&(t.score="Uppnådd poäng kan inte vara högre än maxpoäng")}else if("running"===e.disciplineType||"skiing"===e.disciplineType){const r=Number(e.points);(""===e.points||!Number.isFinite(r)||r<0)&&(t.points="Totalpoäng krävs (0 eller högre)")}return t},onSubmit:e=>{n({...e,scorePercent:u(e),achievementType:"competition_performance"})}});t.useEffect(()=>{const e=setTimeout(()=>{i.current?.focus()},100);return()=>clearTimeout(e)},[]);const g=t.useMemo(()=>{if("field"!==m.disciplineType)return null;const e=Number(m.score),t=Number(m.maxScore);return!Number.isFinite(e)||!Number.isFinite(t)||t<=0?null:Math.round(e/t*100)},[m.disciplineType,m.score,m.maxScore]),y=t.useMemo(()=>{if("field"!==m.disciplineType)return null;const e=o.thresholds?.[m.weaponGroup]?.min;return e?`Minst ${e}% krävs för grupp ${m.weaponGroup}`:null},[m.disciplineType,m.weaponGroup,o.thresholds]);return r.jsxs("form",{onSubmit:f,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{ref:i,id:"competition-date",type:"date",name:"date","aria-label":"Datum för tävling","aria-invalid":Boolean(p.date),"aria-describedby":p.date?"error-date":void 0,value:m.date,onChange:h,className:"input py-3",required:!0}),p.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:p.date})]}),!c&&r.jsxs("fieldset",{children:[r.jsx("legend",{className:"field-label mb-2",children:"Disciplin"}),r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsxs("label",{className:"flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-bg-secondary",children:[r.jsx("input",{type:"radio",name:"disciplineType",value:"field",checked:"field"===m.disciplineType,onChange:h,className:"w-5 h-5"}),r.jsx("span",{children:"Fältskytte"})]}),r.jsxs("label",{className:"flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-bg-secondary",children:[r.jsx("input",{type:"radio",name:"disciplineType",value:"running",checked:"running"===m.disciplineType,onChange:h,className:"w-5 h-5"}),r.jsx("span",{children:"Terränglöpning/springskytte"})]})]}),p.disciplineType&&r.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:p.disciplineType})]}),c&&r.jsxs("div",{className:"p-3 bg-bg-secondary rounded-lg",children:[r.jsx("span",{className:"text-sm text-text-secondary",children:"Disciplin: "}),r.jsx("span",{className:"font-medium",children:"field"===m.disciplineType?"Fältskytte":"Terränglöpning/springskytte"})]}),"field"===m.disciplineType&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-weapon-group",className:"field-label mb-2",children:"Vapengrupp"}),r.jsxs("select",{id:"competition-weapon-group",name:"weaponGroup","aria-label":"Vapengrupp",value:m.weaponGroup,onChange:h,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"A",children:"Grupp A"}),r.jsx("option",{value:"B",children:"Grupp B"}),r.jsx("option",{value:"C",children:"Grupp C"}),r.jsx("option",{value:"R",children:"Grupp R"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-score",className:"field-label mb-2",children:"Uppnådd poäng"}),r.jsx("input",{id:"competition-score",type:"number",name:"score",inputMode:"numeric",min:"0",step:"1","aria-label":"Uppnådd poäng","aria-invalid":Boolean(p.score),"aria-describedby":p.score?"error-score":"hint-score",value:m.score,onChange:h,className:"input py-3",required:!0}),p.score?r.jsx("p",{id:"error-score",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:p.score}):r.jsx("p",{id:"hint-score",className:"mt-1 text-sm text-text-secondary",children:y||"Antal träff/poäng du uppnådde"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-maxscore",className:"field-label mb-2",children:"Maxpoäng"}),r.jsx("input",{id:"competition-maxscore",type:"number",name:"maxScore",inputMode:"numeric",min:"1",step:"1","aria-label":"Maxpoäng","aria-invalid":Boolean(p.maxScore),"aria-describedby":p.maxScore?"error-maxScore":"hint-maxScore",value:m.maxScore,onChange:h,className:"input py-3",required:!0}),p.maxScore?r.jsx("p",{id:"error-maxScore",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:p.maxScore}):r.jsx("p",{id:"hint-maxScore",className:"mt-1 text-sm text-text-secondary",children:"Maximal möjlig poäng för tävlingen (t.ex. 60 för 10 stationer)"})]}),null!==g&&r.jsxs("div",{className:"p-3 bg-bg-secondary rounded-lg",children:[r.jsx("span",{className:"text-sm text-text-secondary",children:"Beräknad procent: "}),r.jsxs("span",{className:"font-medium text-lg",children:[g,"%"]}),y&&r.jsxs("span",{className:"text-sm text-text-secondary ml-2",children:["(",y,")"]})]})]}),("running"===m.disciplineType||"skiing"===m.disciplineType)&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-points",className:"field-label mb-2",children:"Totalpoäng (lägre är bättre)"}),r.jsx("input",{id:"competition-points",type:"number",name:"points",inputMode:"numeric",min:"0",step:"1","aria-label":"Totalpoäng","aria-invalid":Boolean(p.points),"aria-describedby":p.points?"error-points":"hint-points",value:m.points,onChange:h,className:"input py-3",required:!0}),p.points?r.jsx("p",{id:"error-points",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:p.points}):r.jsxs("p",{id:"hint-points",className:"mt-1 text-sm text-text-secondary",children:[d||"Summa av löppoäng och skjutpoäng",o.maxPoints&&` (Max ${o.maxPoints} poäng krävs)`]})]}),r.jsxs(nn,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-name",className:"field-label mb-2",children:"Tävlingsnamn"}),r.jsx("input",{id:"competition-name",type:"text",name:"competitionName","aria-label":"Tävlingsnamn",value:m.competitionName,onChange:h,className:"input py-3",placeholder:"T.ex. DM Fältskytte, Klubbmästerskap"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"competition-notes",name:"notes","aria-label":"Anteckningar",value:m.notes,onChange:h,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, vapen använt, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sparar..."]}):"Spara & Stäng"}),a&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=x(m);b(t),0===Object.keys(t).length&&a&&a({...m,scorePercent:u(m),achievementType:"competition_performance"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})},running_shooting_course:an,skis_shooting_course:an,standard_medal:function({medal:e,onSubmit:n,onSubmitAndAddAnother:a,loading:s}){const i=t.useRef(null),l=t.useMemo(()=>function(e){const t=tn(e?.requirements,"standard_medal");return t?{disciplineType:t.disciplineType||"",medalType:t.medalType||""}:{disciplineType:"",medalType:""}}(e),[e]),o=t.useMemo(()=>rn(e,"standard_medal"),[e]),d=Boolean(l.disciplineType),{values:c,errors:u,handleChange:m,handleSubmit:p,validate:h,setErrors:f}=Qr({initialValues:{date:(new Date).toISOString().split("T")[0],disciplineType:l.disciplineType||"",medalType:l.medalType||"",notes:""},validate:e=>{const t={};return e.date||(t.date="Datum krävs"),e.disciplineType||(t.disciplineType="Välj en disciplin"),e.medalType||(t.medalType="Välj medaljnivå"),t},onSubmit:e=>n({...e,achievementType:"standard_medal"})});return t.useEffect(()=>{const e=setTimeout(()=>{i.current?.focus()},100);return()=>clearTimeout(e)},[]),r.jsxs("form",{onSubmit:p,className:"space-y-4",noValidate:!0,children:[o&&r.jsx("p",{className:"text-sm text-text-secondary bg-bg-secondary p-3 rounded-lg",children:o}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"standard-medal-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{ref:i,id:"standard-medal-date",type:"date",name:"date","aria-label":"Datum för standardmedalj","aria-invalid":Boolean(u.date),"aria-describedby":u.date?"error-date":void 0,value:c.date,onChange:m,className:"input py-3",required:!0}),u.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:u.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"standard-medal-discipline",className:"field-label mb-2",children:"Disciplin"}),d?r.jsxs(r.Fragment,{children:[r.jsx("input",{type:"hidden",name:"disciplineType",value:c.disciplineType}),r.jsxs("div",{className:"input py-3 bg-bg-secondary text-text-secondary",children:[sn.find(e=>e.value===c.disciplineType)?.label||c.disciplineType,r.jsx("span",{className:"text-xs ml-2",children:"(bestämt av märkeskrav)"})]})]}):r.jsxs("select",{id:"standard-medal-discipline",name:"disciplineType","aria-label":"Välj disciplin","aria-invalid":Boolean(u.disciplineType),"aria-describedby":u.disciplineType?"error-discipline":void 0,value:c.disciplineType,onChange:m,className:"input py-3",required:!0,children:[r.jsx("option",{value:"",children:"Välj disciplin..."}),sn.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]}),u.disciplineType?r.jsx("p",{id:"error-discipline",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:u.disciplineType}):!d&&r.jsx("p",{className:"mt-1 text-sm text-text-secondary",children:"Vilken skyttedisciplin standardmedaljen gäller"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"standard-medal-type",className:"field-label mb-2",children:"Medaljnivå"}),r.jsxs("select",{id:"standard-medal-type",name:"medalType","aria-label":"Välj medaljnivå","aria-invalid":Boolean(u.medalType),"aria-describedby":u.medalType?"error-medal-type":void 0,value:c.medalType,onChange:m,className:"input py-3",required:!0,children:[r.jsx("option",{value:"",children:"Välj nivå..."}),ln.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]}),u.medalType?r.jsx("p",{id:"error-medal-type",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:u.medalType}):r.jsx("p",{className:"mt-1 text-sm text-text-secondary",children:"Vilken nivå på standardmedaljen du uppnått"})]}),r.jsx(nn,{label:"Valfria fält",children:r.jsxs("div",{children:[r.jsx("label",{htmlFor:"standard-medal-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"standard-medal-notes",name:"notes","aria-label":"Anteckningar",value:c.notes,onChange:m,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. tävlingsnamn, plats, etc."})]})}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sparar..."]}):"Spara & Stäng"}),a&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=h(c);f(t),0===Object.keys(t).length&&a&&a({...c,achievementType:"standard_medal"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})}},un={precision_series:"Precisionsserie",application_series:"Tillämpningsserie",speed_shooting_series:"Duellserie",competition_performance:"Tävlingsprestation",air_pistol_precision:"Luftpistolprecision",running_shooting_course:"Terränglopp med skytte",skis_shooting_course:"Skidlopp med skytte",standard_medal:"Standardmedalj"};function mn({medal:e,onSuccess:n,unlockMode:a=!1,compact:s=!1}){const{addAchievement:i,unlockMedal:l}=or(),[o,d]=t.useState(null),[c,u]=t.useState(!1),[m,p]=t.useState(0),[h,f]=t.useState(null),x=t.useMemo(()=>{if(a)return[];return function(e,t=20){if(!e)return[];const r=new Set;return function e(n,a=0){n&&"object"==typeof n&&(a>=t||(Array.isArray(n)?n.forEach(t=>e(t,a+1)):(n.type&&"string"==typeof n.type&&(["and","or","medal"].includes(n.type.toLowerCase())||r.add(n.type)),n.and&&Array.isArray(n.and)&&n.and.forEach(t=>e(t,a+1)),n.or&&Array.isArray(n.or)&&n.or.forEach(t=>e(t,a+1)))))}(e),Array.from(r)}(e?.requirements).filter(e=>cn[e])},[e,a]),b=t.useMemo(()=>function(e){if(!e||"object"!=typeof e)return"custom";const t=String(e.medals_type||e.category||"").toLowerCase(),r=String(e.type||"").toLowerCase(),n=String(e.displayName||e.name||"").toLowerCase(),a=String(e.tier||"").toLowerCase();if(r.includes("running")||r.includes("run")||/spring/.test(n)||/springskytte/.test(n))return"running_shooting";if("serie"===t||/series|serie/.test(r)||["gold","silver","bronze"].includes(a))return"competition";if("kvalificering"===t||/qual|kval/.test(r)||/qual|kval/.test(n))return"qualification";if(Boolean(e.team_medal)||/team|lag/.test(r)||/team|lag/.test(n))return"team_event";if(Boolean(e.event_only)||/event|cup|championship|mästerskap/.test(r)||/event|cup|championship|mästerskap/.test(n))return"event";const s=Array.isArray(e.requirements)?e.requirements:[];if(s.length){const e=s.map(e=>String(e?.type||"").toLowerCase());if(e.includes("running_shooting_course"))return"running_shooting";if(e.includes("precision_series"))return"competition";if(e.some(e=>e.includes("qualification")))return"qualification"}return"custom"}(e),[e]),g=a?"event":b,y=t.useMemo(()=>a?en:h&&cn[h]?cn[h]:1===x.length&&cn[x[0]]?cn[x[0]]:dn[b]||en,[a,h,x,b]),v=t.useMemo(()=>`achievement-logger-title-${e?.id||e?.medalId||"unknown"}`,[e]);return r.jsxs("div",{role:"region","aria-labelledby":v,className:s?"w-full":"card p-4 w-full",children:[!s&&r.jsxs("h2",{id:v,className:"section-title mb-4 break-words",children:[a?"Lås upp märke":"Logga Aktivitet",": ",e?.displayName||e?.name||e?.id]}),s&&r.jsxs("h2",{id:v,className:"sr-only",children:[a?"Lås upp märke":"Logga Aktivitet",": ",e?.displayName||e?.name||e?.id]}),o&&r.jsxs("div",{className:"\n            mb-4 p-3 rounded-lg\n            bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300\n            border border-red-200 dark:border-red-800\n            flex items-center gap-2\n          ",role:"alert","aria-live":"assertive",children:[r.jsx("span",{"aria-hidden":"true",children:"✕"}),r.jsx("span",{children:o})]}),x.length>1&&!h&&r.jsxs("div",{className:"space-y-3 mb-4 animate-fade-in",children:[!s&&r.jsx("p",{className:"text-sm text-text-secondary",children:"Detta märke kan tjänas genom olika typer av aktiviteter. Välj vilken typ du vill logga:"}),r.jsx("div",{className:"grid gap-2",children:x.map((e,t)=>r.jsx("button",{type:"button",onClick:()=>f(e),className:"btn btn-secondary py-3 min-h-[44px] text-left justify-start transform transition-all hover:scale-[1.02]",style:{animationDelay:50*t+"ms",animation:"slideInUp 0.2s ease-out forwards",opacity:0},children:un[e]||e},e))})]}),(x.length<=1||h)&&r.jsxs(r.Fragment,{children:[x.length>1&&h&&r.jsx("div",{className:"mb-4 rounded-lg "+(s?"p-2 bg-bg-secondary/50":"p-3 bg-bg-secondary border border-border"),children:r.jsxs("p",{className:"text-sm text-text-secondary flex items-center justify-between",children:[r.jsxs("span",{children:[r.jsx("span",{className:"font-medium text-text-primary",children:"Typ:"})," ",un[h]||h]}),r.jsx("button",{type:"button",onClick:()=>f(null),className:"text-xs text-primary hover:underline ml-2",children:"Byt typ"})]})}),r.jsx(y,{medal:e,onSubmit:async t=>{try{u(!0),d(null);const r=on({medal:e,medalType:g,formData:t}),s=ir(r);if(!s.valid)throw new Error(s.errors.join(" "));await i(r),a&&e?.id&&await l(e.id,r.date),n?.(r)}catch(r){d(r?.message||"Misslyckades att spara aktivitet")}finally{u(!1)}},onSubmitAndAddAnother:async t=>{try{u(!0),d(null);const r=on({medal:e,medalType:g,formData:t}),n=ir(r);if(!n.valid)throw new Error(n.errors.join(" "));await i(r),a&&e?.id&&await l(e.id,r.date),p(e=>e+1),d(null),x.length>1&&f(null)}catch(r){d(r?.message||"Misslyckades att spara aktivitet")}finally{u(!1)}},loading:c},m)]})]})}function pn({medal:e,open:t,onClose:n}){if(!t||!e)return null;const a=r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 bg-black/50 z-[3000]",onClick:n,"aria-hidden":"true"}),r.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":"achievement-entry-title",style:{position:"fixed",zIndex:3001,inset:0,display:"flex",alignItems:"flex-end"},className:"sm:items-center sm:justify-center",children:r.jsxs("div",{style:{width:"100%",maxWidth:"42rem",maxHeight:"90vh",overflow:"hidden"},className:"\n            bg-bg-primary rounded-t-xl sm:rounded-xl shadow-xl\n            flex flex-col\n            border-t border-border sm:border\n          ",children:[r.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border bg-bg-secondary",children:[r.jsx("h2",{id:"achievement-entry-title",className:"text-lg font-semibold text-text-primary",children:"Logga aktivitet"}),r.jsx("button",{type:"button",onClick:n,className:"shrink-0 inline-flex h-10 w-10 items-center justify-center rounded-md text-foreground hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","aria-label":"Stäng",children:r.jsx(Se,{name:"X",className:"w-5 h-5"})})]}),r.jsx("div",{className:"flex-1 overflow-y-auto overscroll-contain p-4 sm:p-6",children:r.jsx(mn,{medal:e,onSuccess:n,unlockMode:!1,compact:!0})})]})})]});return s.createPortal(a,document.body)}function hn(e){const{medalDatabase:r}=ae(),{currentProfile:n,lockMedal:a}=se(),s=t.useMemo(()=>function(e=[]){const t=new Map;for(const r of e){const e=Array.isArray(r?.prerequisites)?r.prerequisites:[];for(const n of e)n&&"medal"===n.type&&n.medalId&&(t.has(n.medalId)||t.set(n.medalId,new Set),t.get(n.medalId).add(r.id))}return t}(r?.getAllMedals?.()||[]),[r]),i=t.useMemo(()=>function(e,t){const r=new Set;if(!e||!t)return r;const n=[e];for(;n.length;){const e=n.shift(),a=t.get(e);if(a)for(const t of a)r.has(t)||(r.add(t),n.push(t))}return r}(e,s),[e,s]),l=t.useMemo(()=>new Set((n?.unlockedMedals||[]).map(e=>e.medalId)),[n]),o=t.useMemo(()=>Array.from(i).filter(e=>l.has(e)),[i,l]),d=0===o.length,c=t.useCallback(async()=>{if(!e)return{ok:!1};if(!d)return{ok:!1,blocking:o};return{ok:!!(await a(e))}},[e,d,o,a]);return{canRemove:d,blocking:o,tryRemove:c}}function fn({met:e}){return r.jsx(Se,{name:e?"CheckCircle2":"Circle",className:e?"w-4 h-4 text-foreground shrink-0":"w-4 h-4 text-muted-foreground shrink-0"})}function xn({id:e,label:t,met:n,summary:a,expanded:s,onToggle:i}){return r.jsxs("button",{type:"button",onClick:i,"aria-expanded":s,"aria-controls":e,className:["w-full text-left inline-flex items-center justify-between","px-2 py-2 rounded","hover:bg-bg-secondary","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","min-h-[44px]"].join(" "),children:[r.jsxs("span",{className:"inline-flex items-center gap-2",children:[r.jsx(fn,{met:n}),r.jsx("span",{className:"text-sm font-semibold text-foreground",children:t}),a?r.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",a,")"]}):null]}),r.jsx("span",{"aria-hidden":"true",className:"ml-2",children:s?"▼":"▶"})]})}function bn({leaf:e}){const t=e.description||e.type||"Krav",n=e.progress&&Number.isFinite(e.progress.current)&&Number.isFinite(e.progress.required)?`${e.progress.current}/${e.progress.required}`:null,a=null!=e.windowYear?e.windowYear:null!=e.subtreeYear?e.subtreeYear:null,s=null!=a?`• År ${a}`:null;return r.jsxs("div",{className:"px-2 py-1 flex items-start gap-2",children:[r.jsx(fn,{met:!!e.isMet}),r.jsxs("span",{className:(e.isMet?"text-foreground":"text-muted-foreground")+" flex-1 min-w-0",children:[t," ",s?r.jsx("span",{className:"text-xs text-muted-foreground",children:s}):null]}),n?r.jsx("span",{className:"ml-auto shrink-0 text-xs text-muted-foreground tabular-nums",children:n}):null]})}function gn(e=[]){const t=e.length;return{met:e.reduce((e,t)=>e+(t.isMet?1:0),0),total:t}}function yn({node:e,path:n="root",level:a=0,defaultExpanded:s=0===a}){const[i,l]=t.useState(s),o=`${n}-group`,d="and"===e?.node||"or"===e?.node;if(!e)return null;const c=a>0?"border-l border-border pl-3":"pl-0";if(d){const t=e.children||[];if(1===t.length)return r.jsx(yn,{node:t[0],path:n,level:a,defaultExpanded:s})}if(!d){const t=e.leaf||{isMet:!1,description:"Okänt krav"};if(t.subtree){const e=`${n}-leaf`,s=t.subtree,o=s&&("and"===s.node||"or"===s.node),d=Array.isArray(s?.children),u=o&&d&&1===s.children.length;if(!o||u)return r.jsx("li",{className:c,children:r.jsx(yn,{node:t.subtree,path:`${n}-sub`,level:a,defaultExpanded:a<1})});let m=null;const p="and"===s.node?"Alla följande":"Minst en av följande",h=t.description||p;if(d){const{met:e,total:r}=gn(s.children),n=`${e}/${r} uppfyllda`;m=t.description?`${p} • ${n}`:n}return r.jsxs("li",{className:c,children:[r.jsx(xn,{id:e,label:h,met:!!t.isMet,summary:m,expanded:i,onToggle:()=>l(e=>!e)}),i&&r.jsx("ul",{id:e,role:"group",className:"ml-2 list-none m-0 p-0",children:(Array.isArray(s.children)?s.children:[]).map((e,t)=>r.jsx(yn,{node:e,path:`${n}-sub-${t}`,level:a+1,defaultExpanded:a<1},`${n}-sub-${t}`))})]})}return r.jsx("li",{className:c,children:r.jsx(bn,{leaf:t})})}const u=e.children||[],{met:m,total:p}=gn(u),h="and"===e.node?"Alla följande":"Minst en av följande",f=`${m}/${p} uppfyllda`;return r.jsxs("li",{className:c,children:[r.jsx(xn,{id:o,label:h,met:!!e.isMet,summary:f,expanded:i,onToggle:()=>l(e=>!e)}),i&&r.jsx("ul",{id:o,role:"group",className:"ml-2 list-none m-0 p-0",children:u.map((e,t)=>r.jsx(yn,{node:e,path:`${n}-${t}`,level:a+1,defaultExpanded:a<1},`${n}-${t}`))})]})}function vn({tree:e,bare:n=!1}){const a=t.useMemo(()=>{let t=e||null;for(;t&&("and"===t.node||"or"===t.node)&&Array.isArray(t.children)&&1===t.children.length;)t=t.children[0];return t},[e]);if(!a)return null;const s="and"===a.node,i=r.jsx("ul",{className:"list-none m-0 p-0 text-sm text-muted-foreground space-y-1",children:s?(a.children||[]).map((e,t)=>r.jsx(yn,{node:e,path:`root-${t}`,level:0,defaultExpanded:!0},`root-${t}`)):r.jsx(yn,{node:a,level:0,defaultExpanded:!0})});return n?i:r.jsx("div",{className:"bg-background border border-border rounded p-3",role:"region","aria-label":"Krav",children:i})}function jn({id:e,title:n,summary:a,collapsible:s=!1,defaultOpen:i=!0,children:l}){const o=t.useId(),d=e?`${e}-body`:`${o}-body`,[c,u]=t.useState(i),m=s?"button":"div",p=s?{type:"button",onClick:()=>u(e=>!e),"aria-expanded":c,"aria-controls":d}:{};return r.jsxs("div",{className:"mb-4 bg-background border border-border rounded",children:[r.jsxs(m,{...p,className:"w-full text-left px-3 py-2 flex items-center justify-between hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded-t min-h-[44px]",children:[r.jsx("span",{className:"text-sm font-semibold text-foreground",children:n}),r.jsxs("span",{className:"inline-flex items-center gap-2 text-xs text-muted-foreground",children:[a?r.jsxs("span",{children:["(",a,")"]}):null,s?r.jsx("span",{"aria-hidden":"true",children:c?"▼":"▶"}):null]})]}),(!s||c)&&r.jsx("div",{id:d,className:"px-3 pb-3",children:l})]})}function wn({status:e,className:t="",id:n,...a}){const s=Tr(e);return s?r.jsxs("span",{id:n,className:`${s.className} ${t}`.trim(),title:s.description,"aria-label":`${s.label}. ${s.description}`,...a,children:[r.jsx(Se,{name:s.icon,className:"w-4 h-4"}),r.jsx("span",{children:s.label})]}):null}const Nn=t.lazy(()=>e(()=>import("./vendor-DKE9o5kA.js").then(e=>e.p),[]));function kn({medalId:e,onClose:n,onNavigateMedal:a}){const{medalDatabase:s}=ae(),o=le(),d=ie(),{currentProfile:c}=se(),u=!!c?.features?.allowManualUnlock,m=s?.getMedalById(e),[p,h]=t.useState(null),{state:f}=Wt("achievementEntry"),[x,b]=t.useState(!1),[g,v]=t.useState(!1),j=l(),w=i(),N=m?`medal-req-original-${m.id}`:void 0,k=m?`medal-unlock-targets-${m.id}`:void 0,{canRemove:S,blocking:C,tryRemove:M}=hn(e),[A,T]=t.useState(!1),[P,I]=t.useState(!1),_=t.useMemo(()=>o&&(o.unlocked.find(t=>t.medalId===e)||o.eligible.find(t=>t.medalId===e)||o.available.find(t=>t.medalId===e)||o.locked.find(t=>t.medalId===e))||null,[o,e]),D=t.useMemo(()=>"unlocked"!==_?.status?null:_?.unlockedDate||d?.getUnlockedDate?.(e)||null,[_,d,e]),F=t.useMemo(()=>{if(!D)return null;const e=new Date(D);return Number.isNaN(e.getTime())?null:e.getFullYear()},[D]),q=t.useMemo(()=>{if(!d||!e)return[];try{return d.getEligibleYears(e)||[]}catch{return[]}},[d,e]),E=t.useMemo(()=>{if(!d)return[];try{return d.getAllAchievementYears()||[]}catch{return[]}},[d]),$=(new Date).getFullYear(),Y=t.useMemo(()=>null!=F?F:null!=p?p:q.includes($)?$:q.length>0?Math.max(...q):$,[F,p,q,$]),L=t.useMemo(()=>{const e=new Set([$,...q]);return Array.from(e).sort((e,t)=>t-e)},[$,q]),R=t.useMemo(()=>{if(!m)return null;if("unlocked"===_?.status&&_?.details?.tree)return _.details.tree;try{return d?.checkRequirements?.(m,{endYear:Y})?.tree??null}catch{return null}},[d,m,_,Y]),G=t.useMemo(()=>{if(!R)return null;const e={met:0,total:0},t=r=>{if(r){if("leaf"===r.node)return e.total+=1,void(r.leaf?.isMet&&(e.met+=1));for(const e of r.children||[])t(e)}};return t(R),e},[R]),B=t.useMemo(()=>{if(!d||!m)return{allMet:!0,items:[],missingItems:[]};try{return d.checkPrerequisites(m)}catch{return{allMet:!0,items:[],missingItems:[]}}},[d,m]),O=t.useMemo(()=>{const e=new Set;for(const t of B.missingItems||[])t&&"medal"===t.type&&t.offsetChecked&&e.add(t.medalId);return e},[B]),U=t.useMemo(()=>(B.items||[]).map(e=>{if("medal"===e.type){const t=s?.getMedalById?.(e.medalId),r=O.has(e.medalId);return{...e,displayName:t?.displayName||t?.name||e.medalId,displayMet:e.isMet&&!r,gapFailed:r}}return e}),[B,O,s]),V=t.useMemo(()=>{const e=U||[],t=e.length;return{met:e.reduce((e,t)=>e+(t.displayMet?1:0),0),total:t}},[U]),z=!0===B?.allMet,K=m?`unlock-prereq-hint-${m.id}`:void 0,H=t.useMemo(()=>(C||[]).map(e=>s?.getMedalById(e)).filter(Boolean),[C,s]),W=t.useMemo(()=>(Array.isArray(m?.references)?m.references:[]).map(e=>{const t=s?.getMedalById?.(e.medalId);return t?{target:t,description:e.description||""}:null}).filter(Boolean),[m,s]),X=t.useMemo(()=>{if(!m||!s?.getAllMedals)return[];return s.getAllMedals().filter(e=>e?.id!==m.id&&Array.isArray(e?.prerequisites)&&e.prerequisites.some(e=>"medal"===e?.type&&e.medalId===m.id)).map(e=>({target:e}))},[m,s]),J=t.useRef(null),Z=t.useRef(null),Q=t.useRef(null),ee=`medal-detail-title-${e||"unknown"}`,te=!!m&&("function"==typeof m.isPlaceholder?m.isPlaceholder():"placeholder"===m.status),re=!(!m||te)&&("function"==typeof m.isUnderReview?m.isUnderReview():"under_review"===m.status),ne=m?.description?`medal-detail-desc-${e||"unknown"}`:null,oe=re&&m?`under-review-note-${m.id}`:null,de=te&&m?`placeholder-note-${m.id}`:null,ce=[ne,oe,de].filter(Boolean).join(" ")||void 0;if(t.useEffect(()=>{if(!m)return;Q.current="undefined"!=typeof document?document.activeElement:null;const e="undefined"!=typeof document?document.body:null,t=e?e.style.overflow:"";e&&(e.style.overflow="hidden");const r=Z.current;r&&(r.classList.remove("translate-y-full","sm:translate-x-full"),r.classList.add("translate-y-0","sm:translate-x-0"));const a=setTimeout(()=>{const e=Z.current?.querySelector(`#${ee}`);e&&e.focus?e.focus():Z.current?.focus()},0),s=e=>{"Escape"===e.key&&(e.preventDefault(),n?.())};return window.addEventListener("keydown",s),()=>{clearTimeout(a),window.removeEventListener("keydown",s),e&&(e.style.overflow=t);const r=Q.current;if(r&&"function"==typeof r.focus)try{r.focus()}catch{}}},[n,ee,m]),t.useEffect(()=>{if(!m)return;if("undefined"==typeof document)return;const t=document.title,r=m.displayName||m.name||String(e);try{document.title=`${r} - Detaljer`}catch{}return()=>{try{document.title=t}catch{}}},[m,e]),!m)return null;const ue={ul:e=>r.jsx("ul",{className:"list-disc pl-5 my-2 space-y-1",...e}),ol:e=>r.jsx("ol",{className:"list-decimal pl-5 my-2 space-y-1",...e}),li:e=>r.jsx("li",{className:"marker:text-muted-foreground",...e}),table:e=>r.jsx("div",{className:"my-2 overflow-x-auto",children:r.jsx("table",{className:"w-full text-sm border-collapse",...e})}),thead:e=>r.jsx("thead",{className:"bg-bg-secondary",...e}),th:e=>r.jsx("th",{className:"border border-border px-2 py-1 text-left font-semibold",...e}),td:e=>r.jsx("td",{className:"border border-border px-2 py-1 align-top",...e}),a:({href:e,children:t,...n})=>r.jsx("a",{href:e,className:"underline text-primary hover:text-primary-hover",target:"_blank",rel:"noopener noreferrer",...n,children:t}),code:e=>r.jsx("code",{className:"px-1 py-0.5 rounded bg-bg-secondary",...e})},me=e=>t=>{if(!!(0!==t.button||t.metaKey||t.ctrlKey||t.altKey||t.shiftKey))return;if(t.preventDefault(),"function"==typeof a)return void a(e);const r=w.state?.backgroundLocation;j(`/medals/${e}`,{state:r?{backgroundLocation:r}:void 0})};return r.jsxs("div",{ref:J,onClick:e=>{e.target===J.current&&n?.()},className:"fixed inset-0 z-50 bg-black/50",children:[r.jsx("div",{ref:Z,role:"dialog","data-tour":"medal-detail-panel","aria-modal":"true","aria-labelledby":ee,"aria-describedby":ce,tabIndex:-1,onKeyDown:e=>{if("Tab"!==e.key)return;const t=Z.current;if(!t)return;const r=t.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');if(0===r.length)return void e.preventDefault();const n=r[0],a=r[r.length-1],s=document.activeElement;e.shiftKey&&s===n?(e.preventDefault(),a.focus()):e.shiftKey||s!==a||(e.preventDefault(),n.focus())},className:["pointer-events-auto fixed","inset-x-0 bottom-0 w-full h-[90svh] max-h-[90vh]","sm:inset-y-0 sm:right-0 sm:left-auto sm:w-[32rem] sm:h-full","bg-bg-secondary shadow-2xl overflow-hidden","rounded-t-2xl sm:rounded-none sm:rounded-l-2xl","transform transition-transform duration-200 ease-out motion-reduce:transition-none","translate-y-full sm:translate-y-0 sm:translate-x-full","focus:outline-none"].join(" "),children:r.jsxs("div",{className:"flex h-full flex-col",children:[r.jsxs("div",{className:"sticky top-0 z-10 flex items-start justify-between gap-4 p-4 sm:p-6 bg-bg-secondary border-b border-border",children:[r.jsx("div",{className:"min-w-0",children:r.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[r.jsx("h2",{id:ee,"data-tour":"medal-detail-title",className:"text-xl sm:text-2xl font-bold text-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary break-words",tabIndex:-1,children:m.displayName}),r.jsx("div",{role:"status","aria-live":"polite",className:"mt-1 sm:mt-0",children:te?r.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-900 border border-indigo-300 dark:bg-indigo-900/30 dark:text-indigo-200 dark:border-indigo-700","aria-label":"Status: plats­hållare",children:[r.jsx(mt,{status:"placeholder",className:"w-3.5 h-3.5"}),"Plats­hållare"]}):r.jsx(wn,{status:_?.status||"locked"})}),re&&r.jsxs("span",{className:"mt-1 sm:mt-0 inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-900 border border-amber-300 dark:bg-amber-900/40 dark:text-amber-200 dark:border-amber-700","aria-label":"Status för regler: under granskning",children:[r.jsx(mt,{status:"review",className:"w-3.5 h-3.5"}),"Under granskning"]})]})}),r.jsx("button",{onClick:n,className:"shrink-0 inline-flex h-10 w-10 items-center justify-center rounded-md text-foreground hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary","aria-label":"Stäng medal-detaljer",title:"Stäng",children:r.jsx("span",{"aria-hidden":"true",children:"✕"})})]}),r.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto overscroll-contain p-4 sm:p-6",children:[r.jsx("div",{className:"mb-4",children:r.jsx(Xe,{id:"disclaimer-rules",variant:"warning",text:"Regelboken gäller före appens tolkning. Kontrollera alltid senaste officiella regelbok.",linkUrl:Fe})}),te&&r.jsxs(r.Fragment,{children:[r.jsx("p",{id:de,className:"sr-only",children:"Detta är ett platshållarmärke. Avsnitten nedan visar exempel på information som kommer att finnas här när märket publiceras."}),r.jsx(jn,{id:`placeholder-unlocked-${m.id}`,title:"Upplåst",collapsible:!1,children:r.jsx("p",{className:"text-sm text-muted-foreground",children:"Här visas normalt vilket år du låste upp märket."})}),r.jsx(jn,{id:`placeholder-prereq-${m.id}`,title:"Förhandskrav",collapsible:!1,children:r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[r.jsx("li",{children:"• Exempel: krav eller förkunskap 1"}),r.jsx("li",{children:"• Exempel: krav eller förkunskap 2"}),r.jsx("li",{children:"• Exempel: krav eller förkunskap 3"})]})}),r.jsx(jn,{id:`placeholder-req-${m.id}`,title:"Krav",collapsible:!1,children:r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[r.jsxs("li",{children:[r.jsx("span",{className:"text-foreground",children:"✓"})," Exempel: uppfyllt krav"]}),r.jsxs("li",{children:[r.jsx("span",{className:"text-muted-foreground",children:"○"})," Exempel: krav som återstår"]}),r.jsxs("li",{children:[r.jsx("span",{className:"text-muted-foreground",children:"○"})," Exempel: ytterligare krav"]})]})}),r.jsx(jn,{id:ne||`placeholder-desc-${m.id}`,title:"Beskrivning",collapsible:!1,children:r.jsx("p",{className:"text-muted-foreground break-words",children:"Beskrivning kommer att visas här när innehållet är klart."})}),r.jsx(jn,{id:N,title:"Visa ursprunglig kravtext",collapsible:!0,defaultOpen:!1,children:r.jsx("div",{className:"text-sm text-foreground break-words",children:r.jsx(t.Suspense,{fallback:null,children:r.jsx(Nn,{remarkPlugins:[y],components:ue,children:"Det här avsnittet visar vanligtvis den ursprungliga kravtexten från regelboken.\n\n- Exempelpunkt 1\n- Exempelpunkt 2\n- Exempelpunkt 3"})})})}),r.jsx(jn,{id:`placeholder-refs-${m.id}`,title:"Uppfyller också kraven för",collapsible:!1,children:r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:r.jsx("li",{children:"• Kommer snart"})})}),r.jsx(jn,{id:`placeholder-required-for-${m.id}`,title:"Detta märke krävs för",collapsible:!1,children:r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:r.jsx("li",{children:"• Kommer snart"})})})]}),!te&&null!=F&&r.jsx(jn,{id:`unlocked-${m.id}`,title:"Upplåst",collapsible:!1,children:r.jsx("div",{role:"status","aria-live":"polite",children:r.jsx("p",{className:"text-sm text-foreground",children:r.jsx("time",{dateTime:function(){try{return new Date(D).toISOString().slice(0,10)}catch{return String(D)}}(),children:F})})})}),!te&&U.length>0&&r.jsx(jn,{id:`prereq-${m.id}`,title:"Förhandskrav",summary:`${V.met}/${V.total} uppfyllda`,collapsible:!1,children:r.jsx("ul",{className:"list-none m-0 p-0 text-sm text-muted-foreground space-y-1",children:U.map((e,t)=>r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Se,{name:e.displayMet?"CheckCircle2":"Circle",className:e.displayMet?"w-4 h-4 text-foreground shrink-0":"w-4 h-4 text-muted-foreground shrink-0"}),r.jsx("span",{className:"sr-only",children:e.displayMet?"Uppfyllt":"Saknas"}),r.jsx("span",{className:"text-foreground flex-1 min-w-0 break-words",children:"medal"===e.type?e.displayName||e.medalId:e.description||e.type}),"medal"===e.type&&"number"==typeof e.yearOffset?r.jsxs("span",{className:e.gapFailed?"text-danger":"text-muted-foreground",children:["Kräver ",e.yearOffset," års gap"]}):null]},t))})}),re&&r.jsx("div",{id:`under-review-note-${m.id}`,className:"mb-4 alert alert-warning",children:"Reglerna för det här märket är under granskning och kan komma att ändras."}),!te&&m.description&&r.jsx("div",{className:"mb-4",children:r.jsx("p",{id:ne,className:"text-muted-foreground break-words",children:m.description})}),!te&&_?.details?.missingItems?.length>0&&r.jsxs("div",{className:"mb-4 bg-background border border-border rounded p-3",children:[r.jsx("p",{className:"text-sm font-semibold text-foreground mb-2",children:"Saknade förhandskrav:"}),r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:_.details.missingItems.map((e,t)=>r.jsxs("li",{className:"break-words",children:["• ",e.description]},t))})]}),!te&&R&&r.jsxs(r.Fragment,{children:["unlocked"!==_?.status&&L.length>1&&r.jsxs("div",{className:"mb-4",children:[r.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[r.jsx("label",{htmlFor:"year-selector",className:"text-sm font-medium text-foreground",children:"Visa framsteg för år:"}),r.jsx("button",{type:"button","aria-label":"Information om årsvisa krav",className:"inline-flex items-center justify-center w-5 h-5 rounded-full bg-bg-secondary hover:bg-background border border-border text-xs text-muted-foreground",title:"Kraven måste uppfyllas under samma kalenderår",children:r.jsx(Se,{name:"Info",className:"w-3.5 h-3.5"})})]}),r.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-thin",role:"group","aria-label":"Välj år",children:L.map(e=>{const t=e===Y,n=q.includes(e),a=e===$,s=E.includes(e);return r.jsx("button",{type:"button",onClick:()=>h(e),"aria-pressed":t,"aria-label":`År ${e}${a?" (nuvarande år)":""}${n?" (kvalificerad)":""}${s?" (har aktiviteter)":""}`,className:["shrink-0 px-4 py-2 rounded-lg text-sm font-medium transition-colors min-h-[44px]","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",t?n?"bg-green-100 text-green-900 border-2 border-green-500 dark:bg-green-900/30 dark:text-green-100 dark:border-green-600":a?"bg-primary text-primary-foreground border-2 border-primary":"bg-bg-secondary text-foreground border-2 border-primary":n?"bg-green-50 text-green-700 border border-green-300 hover:bg-green-100 dark:bg-green-900/20 dark:text-green-200 dark:border-green-800 dark:hover:bg-green-900/30":"bg-bg-secondary text-foreground border border-border hover:bg-background"].join(" "),children:r.jsxs("span",{className:"flex items-center gap-1.5",children:[e,n&&r.jsx(Se,{name:"CheckCircle2",className:"w-4 h-4","aria-hidden":"true"}),a&&!n&&r.jsx(Se,{name:"Circle",className:"w-3 h-3 fill-current","aria-hidden":"true"})]})},e)})}),r.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:[r.jsx(Se,{name:"CheckCircle2",className:"w-3 h-3 inline text-green-600 dark:text-green-400","aria-hidden":"true"})," = Kvalificerad för detta år"," • ",r.jsx(Se,{name:"Circle",className:"w-2.5 h-2.5 inline fill-current","aria-hidden":"true"})," = Nuvarande år"]})]}),r.jsx(jn,{id:`req-${m.id}`,title:"Krav",summary:G?`${G.met}/${G.total} uppfyllda${"unlocked"!==_?.status?` • ${Y}`:""}`:void 0,collapsible:!1,children:r.jsx(vn,{tree:R,bare:!0})})]}),!te&&m.requirementsOriginal&&r.jsx(jn,{id:N,title:"Visa ursprunglig kravtext",collapsible:!0,defaultOpen:!1,children:r.jsx("div",{className:"text-sm text-foreground break-words",children:r.jsx(t.Suspense,{fallback:null,children:r.jsx(Nn,{remarkPlugins:[y],components:ue,children:m.requirementsOriginal})})})}),!te&&W.length>0&&r.jsx(jn,{id:`refs-${m.id}`,title:"Uppfyller också kraven för",summary:`${W.length}`,collapsible:!0,defaultOpen:!1,children:r.jsx("ul",{className:"space-y-1",children:W.map(({target:e})=>r.jsx("li",{children:r.jsx("a",{href:`/medals/${e.id}`,onClick:me(e.id),className:"inline-flex items-center underline text-primary hover:text-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary px-2 py-2 rounded min-h-[44px]",children:e.displayName||e.name})},e.id))})}),!te&&X.length>0&&r.jsx(jn,{id:k,title:"Detta märke krävs för",summary:`${X.length}`,collapsible:!0,defaultOpen:!1,children:r.jsx("ul",{className:"space-y-1",children:X.map(({target:e})=>r.jsx("li",{children:r.jsx("a",{href:`/medals/${e.id}`,onClick:me(e.id),className:"inline-flex items-center underline text-primary hover:text-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary px-2 py-2 rounded min-h-[44px]",children:e.displayName||e.name})},e.id))})})]}),r.jsxs("div",{className:"flex flex-wrap gap-3 p-4 sm:p-6 border-t border-border pb-[calc(env(safe-area-inset-bottom)+1rem)]",children:[r.jsx("button",{onClick:n,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-background text-foreground hover:bg-bg-secondary ring-1 ring-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Stäng"}),c&&!te&&"locked"!==_?.status&&"off"!==f&&r.jsx("button",{type:"button",onClick:()=>v(!0),"aria-haspopup":"dialog",className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsx(Se,{name:"Plus",className:"w-5 h-5"}),"Logga aktivitet"]})}),"unlocked"===_?.status&&c&&!te&&r.jsxs("div",{className:"flex-1 flex items-center gap-2",children:[r.jsx("button",{type:"button",onClick:()=>{S?(I(!1),T(!0)):(T(!1),I(!0))},"aria-haspopup":"dialog","aria-expanded":A||P,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-background text-foreground hover:bg-bg-secondary ring-1 ring-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Ta bort upplåst"}),!S&&r.jsx("button",{type:"button",onClick:()=>I(!0),className:"text-sm text-muted-foreground underline","aria-label":"Why can’t I remove this medal?",children:"Varför kan jag inte?"})]}),c&&!te&&("eligible"===_?.status||u&&"unlocked"!==_?.status)&&r.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[r.jsx("button",{type:"button",onClick:()=>b(!0),"aria-haspopup":"dialog","aria-controls":"unlock-medal",disabled:!z,"aria-disabled":!z,"aria-describedby":z?void 0:K,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary-hover disabled:opacity-60 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Lås upp nu"}),!z&&r.jsx("p",{id:K,className:"text-xs text-muted-foreground",children:"Förhandskraven måste uppnåst innan märket kan låsas upp."})]})]})]})}),r.jsx(Jr,{medal:m,open:x,onClose:()=>b(!1),preferredYear:Y}),r.jsx(Zr,{medal:m,open:A,onClose:()=>T(!1),variant:"confirm",onConfirmRemove:M}),r.jsx(Zr,{medal:m,open:P,onClose:()=>I(!1),variant:"blocked",blockingMedals:H}),r.jsx(pn,{medal:m,open:g,onClose:()=>v(!1)})]})}function Sn({children:e}){const{currentProfile:t}=se(),n=l(),[a,s]=b.useState(!1),[i,o]=b.useState(!0);return t&&!t.isGuest?e:r.jsxs("div",{className:"p-6",children:[r.jsxs("div",{className:"card block p-6 w-full min-w-full max-w-xl mx-auto",role:"region","aria-labelledby":"profile-required-heading",children:[r.jsx("h2",{id:"profile-required-heading",className:"section-title mb-2",children:"Profil krävs för att fortsätta"}),r.jsxs("div",{className:"text-sm text-muted-foreground space-y-3 mb-4",children:[r.jsx("p",{children:"För att använda Inställningar och import/export behöver du en sparad profil."}),r.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[r.jsx("li",{children:"Spara dina framsteg och säkerhetskopiera data"}),r.jsx("li",{children:"Hantera inställningar per profil"}),r.jsx("li",{children:"Exportera och importera mellan enheter"})]}),t?.isGuest&&r.jsx("p",{children:"Du kan spara ditt nuvarande Gästläge som en profil och fortsätta utan att förlora något."})]}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",autoFocus:!0,onClick:()=>{o(!0),s(!0)},"aria-haspopup":"dialog","aria-controls":"save-progress-picker-guard",children:"Skapa profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>{o(!1),s(!0)},"aria-haspopup":"dialog","aria-controls":"save-progress-picker-guard",children:"Välj profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>n("/medals"),children:"Tillbaka till märken"})]})]}),r.jsx(Ae,{id:"save-progress-picker-guard",mode:"picker",open:a,onClose:()=>s(!1),forceCreate:i,convertGuest:!0})]})}const Cn=[{id:"0.9.5",date:"2026-01-08",title:"Fler märken och kön i profil",highlights:["Skidskyttemärken är tillagda för granskning","Mästarmärken är tillagda för granskning","Ett fåtal märken särskiljer kraven för män och kvinnor så profilen måste hålla den informationen","Interaktiv användarguide för trädvyn med stöd för mobil och helskärmsläge","Förenklad funktionalitet för backup och flytt av profildata"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.5"},{id:"0.9.4",date:"2026-01-04",title:"Buggfixar",highlights:["Mindre buggfixar"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.4"},{id:"0.9.3",date:"2026-01-03",title:"Användarguide",highlights:["Interaktiv användarguide för medaljlistan","Hänvisa till regelbok version 20 tillsvidare"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.3"},{id:"0.9.2",date:"2026-01-01",title:"Versionsnytt",highlights:["Versionsinformation med förändringslogg tillagd."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.2"},{id:"0.9.1",date:"2025-12-31",title:"Uppdateringar av märken för luftpistol",highlights:["Årsmärken för luftpistol korrigerade."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.1"},{id:"0.9.0",date:"2025-12-31",title:"Ny trädvy",highlights:["Ny trädvy för märken med tidslinje per märkestyp."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.0"}];function Mn(){const e=l(),n=i(),a=n.state?.backgroundLocation,s=Dt(),o=t.useMemo(()=>function(e){const t=[...Cn].sort((e,t)=>{const r=String(e.id).split(".").map(e=>parseInt(e,10)||0),n=String(t.id).split(".").map(e=>parseInt(e,10)||0);for(let a=0;a<3;a++)if(r[a]!==n[a])return n[a]-r[a];return 0});if(!e)return t;const r=t.findIndex(t=>t.id===e);return r<=0?t:t.slice(0,r)}(Ft()),[]),d=t.useRef(null),c=t.useRef(null),u=t.useCallback(()=>{if(function(e){try{e&&localStorage.setItem(_t,e)}catch{}}(s),a&&a.pathname){const t=`${a.pathname}${a.search||""}${a.hash||""}`;e(t,{replace:!0})}else e(-1)},[s,a,e]);t.useEffect(()=>{c.current=document.activeElement;const e=d.current;if(!e)return;const t=()=>e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),r=e=>{const r=t(),n=r[0],a=r[r.length-1];if("Escape"===e.key)e.preventDefault(),u();else if("Tab"===e.key){if(0===r.length)return;e.shiftKey&&document.activeElement===n?(e.preventDefault(),a?.focus()):e.shiftKey||document.activeElement!==a||(e.preventDefault(),n?.focus())}},n=t();return n[0]?.focus(),e.addEventListener("keydown",r),()=>{e.removeEventListener("keydown",r),c.current&&"function"==typeof c.current.focus&&c.current.focus()}},[u]);const m=o[0]?.link||null,p=o.length>1?`Det finns ${o.length} uppdateringar sedan du senast tittade.`:"Här är det senaste som är nytt i appen.";return r.jsxs("div",{className:"fixed inset-0 z-50",onMouseDown:e=>{e.target===e.currentTarget&&u()},"aria-hidden":!1,children:[r.jsx("div",{className:"absolute inset-0 bg-black/50"}),r.jsx("div",{ref:d,role:"dialog","aria-modal":"true","aria-labelledby":"whatsnew-title","aria-describedby":"whatsnew-desc",className:["card","fixed inset-x-0 bottom-0 w-full max-h-[85vh] rounded-t-2xl shadow-lg","md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2","md:w-[min(90vw,640px)] md:rounded-xl","outline-none"].join(" "),tabIndex:-1,children:r.jsxs("div",{className:"p-4 sm:p-6",children:[r.jsxs("header",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{children:[r.jsx("h2",{id:"whatsnew-title",className:"text-xl font-semibold",children:"Nyheter"}),r.jsx("p",{id:"whatsnew-desc",className:"mt-1 text-sm text-muted-foreground",children:p})]}),r.jsx("button",{type:"button",className:"btn btn-muted","aria-label":"Stäng nyheter",onClick:u,children:"Stäng"})]}),r.jsx("div",{className:"mt-4 space-y-3 overflow-y-auto pr-1",style:{maxHeight:"55vh"},children:o.map((e,t)=>r.jsxs("details",{className:"rounded-lg border border-border p-3",open:0===t,children:[r.jsxs("summary",{className:"cursor-pointer select-none font-medium",children:[e.title||"Uppdatering"," • ",e.date," • ",e.id]}),r.jsx("ul",{className:"mt-2 list-disc pl-5 space-y-1 text-sm",children:(e.highlights||[]).map((e,t)=>r.jsx("li",{children:e},t))}),e.link&&r.jsx("div",{className:"mt-2",children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:e.link,target:"_blank",rel:"noreferrer",children:"Läs mer"})})]},e.id))}),r.jsxs("div",{className:"mt-4 flex items-center justify-end gap-3 safe-bottom",children:[m&&r.jsx("a",{className:"btn btn-secondary",href:m,target:"_blank",rel:"noreferrer",children:"Läs mer"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:u,children:"Ok, visa appen"})]})]})})]})}function An(e,t,r){return Math.max(t,Math.min(r,e))}function Tn(e){if(!e)return null;try{return document.querySelector(e)}catch{return null}}function Pn(){const{open:e,stepIndex:n,steps:a,complete:s,next:i,back:l}=It(),o=a?.[n]||null,d=t.useRef(null),c=t.useRef(null),[u,m]=t.useState(null),[p,h]=t.useState(!1),f=t.useCallback(()=>{if(!e)return;if("undefined"==typeof document)return;const t=Tn(o?.target);if(!t)return m(null),void h(!1);h(!0);try{const e=t.getBoundingClientRect(),r=window.innerHeight;!(e.bottom>r/2)&&(e.top<0||e.bottom>r)&&t.scrollIntoView({block:"center",inline:"nearest",behavior:"smooth"})}catch{}const r=t.getBoundingClientRect();m({top:r.top,left:r.left,width:r.width,height:r.height,right:r.right,bottom:r.bottom})},[e,o?.target]),x=n>=(a?.length||1)-1,b=t.useMemo(()=>`tour-title-${o?.id||n}`,[o?.id,n]),g=t.useMemo(()=>`tour-desc-${o?.id||n}`,[o?.id,n]),y=t.useMemo(()=>`tour-hint-${o?.id||n}`,[o?.id,n]),v=t.useCallback(()=>{s()},[s]),j=t.useCallback(()=>{s()},[s]),w=!!o?.requiresTarget&&!p,N=t.useCallback(()=>{w||(x?s():i())},[w,x,s,i]),k=t.useCallback(()=>{if("undefined"!=typeof document&&"detail"===o?.id){const e=Tn('button[aria-label="Stäng medal-detaljer"]');e?.click?.()}l()},[l,o?.id]);if(t.useEffect(()=>{if(!e)return;if("undefined"==typeof document)return;c.current=document.activeElement;const t=d.current;if(!t)return;const r=()=>t.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),n=e=>{if("Escape"===e.key)return e.preventDefault(),void v();if("Tab"!==e.key)return;const t=r();if(!t.length)return void e.preventDefault();const n=t[0],a=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),a?.focus()):e.shiftKey||document.activeElement!==a||(e.preventDefault(),n?.focus())},a=r();return(a[0]||t)?.focus?.(),t.addEventListener("keydown",n),()=>{t.removeEventListener("keydown",n);const e=c.current;if(e&&"function"==typeof e.focus)try{e.focus()}catch{}}},[e,v]),t.useEffect(()=>{if(!e)return;if("undefined"==typeof window)return;const t=window.requestAnimationFrame(()=>f()),r=window.requestAnimationFrame(()=>f()),n=window.setTimeout(()=>f(),220);let a=0;const s=()=>{a||(a=window.requestAnimationFrame(()=>{a=0,f()}))},i=()=>s();window.addEventListener("resize",i);const l=Tn(o?.target),d=l?function(e){if("undefined"==typeof window||!e)return null;let t=e;for(;t&&t!==document.body;){const e=window.getComputedStyle(t).overflowY;if("auto"===e||"scroll"===e)return t;t=t.parentElement}return window}(l):null;return d&&d!==window?d.addEventListener("scroll",s,{passive:!0}):window.addEventListener("scroll",s,!0),()=>{window.cancelAnimationFrame(t),window.cancelAnimationFrame(r),window.clearTimeout(n),window.removeEventListener("resize",i),d&&d!==window?d.removeEventListener("scroll",s):window.removeEventListener("scroll",s,!0),a&&window.cancelAnimationFrame(a)}},[e,n,o?.target,f]),t.useEffect(()=>{if(!e)return;if(x)return;if("undefined"==typeof document)return;const t=o?.autoAdvanceToNextOn;if(!t)return;const r=()=>{Tn(t)&&i()};r();const n=new MutationObserver(()=>r());return n.observe(document.body,{childList:!0,subtree:!0}),()=>n.disconnect()},[e,x,o?.autoAdvanceToNextOn,i]),!e||!o)return null;const S=(()=>{if(!u)return!1;if("undefined"==typeof window)return!1;const e=window.innerHeight;return u.bottom>e/2})(),C=(()=>{if(!u)return null;if("undefined"==typeof window)return null;const e=window.innerWidth,t=window.innerHeight;if(e<768)return null;const r="detail"===o?.id;return{position:"fixed",top:An(r?u.top:u.bottom+10,12,t-12-220),left:An(r?u.left-10-360:u.left,12,e-12-360),width:360}})(),M=u?{position:"fixed",top:Math.max(0,u.top-8),left:Math.max(0,u.left-8),width:Math.max(0,u.width+16),height:Math.max(0,u.height+16),borderRadius:16,boxShadow:"0 0 0 9999px rgba(0,0,0,0.55)",pointerEvents:"none",zIndex:65}:null;return r.jsxs("div",{className:"fixed inset-0 z-[70] pointer-events-none","aria-hidden":!1,children:[M?r.jsx("div",{"aria-hidden":"true",style:M}):r.jsx("div",{className:"absolute inset-0 bg-black/50","aria-hidden":"true"}),r.jsx("div",{ref:d,role:"dialog","aria-modal":"true","aria-labelledby":b,"aria-describedby":w?`${g} ${y}`:g,tabIndex:-1,className:["card","pointer-events-auto","z-[70]",C?"rounded-xl shadow-lg":S?"fixed inset-x-0 top-0 w-full max-h-[85vh] rounded-b-2xl shadow-lg":"fixed inset-x-0 bottom-0 w-full max-h-[85vh] rounded-t-2xl shadow-lg",C?"":"md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[min(90vw,520px)] md:rounded-xl","outline-none"].join(" "),style:C||(S?{paddingTop:"env(safe-area-inset-top)"}:void 0),children:r.jsxs("div",{className:S?"p-4 sm:p-6 pt-2":"p-4 sm:p-6",children:[r.jsxs("header",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{className:"min-w-0",children:[r.jsx("h2",{id:b,className:"text-lg sm:text-xl font-semibold text-foreground",children:o.title}),r.jsx("p",{id:g,className:"mt-1 text-sm text-muted-foreground",children:o.body}),w&&r.jsx("p",{id:y,className:"mt-2 text-xs text-muted-foreground",children:"Öppna en medalj för att fortsätta."})]}),r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:v,"aria-label":"Avsluta guiden",children:"Stäng"})]}),r.jsxs("div",{className:"mt-4 flex items-center justify-between gap-3",children:[r.jsxs("div",{className:"text-xs text-muted-foreground","aria-live":"polite",children:["Steg ",n+1," av ",a.length]}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:j,children:"Hoppa över"})]}),r.jsxs("div",{className:"mt-4 flex items-center justify-end gap-2 safe-bottom",children:[r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:k,disabled:0===n,"aria-disabled":0===n,children:"Tillbaka"}),r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:N,disabled:w,"aria-disabled":w,children:x?"Klart":"Nästa"})]})]})})]})}function In(){const{id:e}=N(),t=l(),n=i(),a=n.state?.backgroundLocation;return r.jsx(kn,{medalId:e,onClose:()=>{if(a&&a.pathname){const e=`${a.pathname}${a.search||""}${a.hash||""}`;t(e,{replace:!0})}else t(-1)}})}function _n(){const e=i(),n=l(),a=e.state?.backgroundLocation,s=e.pathname.startsWith("/medals/"),o="/whats-new"===e.pathname,d=(s||o)&&a?a:e,c=t.useRef(!1);return t.useEffect(()=>{if(c.current)return;if(c.current=!0,!qt())return;const t=Dt();if(Ft()===t)return;const r=setTimeout(()=>{n("/whats-new",{replace:!0,state:{backgroundLocation:e}})},700);return()=>clearTimeout(r)},[e,n]),r.jsxs(r.Fragment,{children:[r.jsx(j,{location:d,children:r.jsxs(w,{path:"/",element:r.jsx(We,{}),children:[r.jsx(w,{index:!0,element:r.jsx(Je,{})}),r.jsx(w,{path:"skill-tree",element:r.jsx(Et,{})}),r.jsx(w,{path:"skill-tree/fullscreen",element:r.jsx(Et,{})}),r.jsx(w,{path:"medals",element:r.jsx(Ht,{})}),r.jsx(w,{path:"medals/:id",element:r.jsx(Ht,{})}),r.jsx(w,{path:"settings",element:r.jsx(Sn,{children:r.jsx(Dr,{})})}),r.jsx(w,{path:"data",element:r.jsx(Sn,{children:r.jsx(Kr,{})})}),r.jsx(w,{path:"about",element:r.jsx(Wr,{})}),r.jsx(w,{path:"help",element:r.jsx(Xr,{})}),r.jsx(w,{path:"whats-new",element:r.jsx(Mn,{})})]})}),s&&a&&r.jsx(j,{children:r.jsx(w,{path:"/medals/:id",element:r.jsx(In,{})})}),o&&a&&r.jsx(j,{children:r.jsx(w,{path:"/whats-new",element:r.jsx(Mn,{})})}),r.jsx(Pn,{})]})}function Dn(){const e="undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/";return t.useEffect(()=>{if("undefined"==typeof window||!("matchMedia"in window))return;const e=window.matchMedia("(prefers-color-scheme: dark)"),t=e=>{document.documentElement.classList.toggle("dark",e)};t(e.matches);const r=e=>t(e.matches);return e.addEventListener?.("change",r),()=>e.removeEventListener?.("change",r)},[]),r.jsx(D,{children:r.jsx(J,{children:r.jsx(ee,{children:r.jsx(he,{children:r.jsx(oe,{children:r.jsx(ce,{children:r.jsx(Ne,{children:r.jsx(v,{basename:e,children:r.jsx(_n,{})})})})})})})})})}k.createRoot(document.getElementById("root")).render(r.jsx(t.StrictMode,{children:r.jsx(Dn,{})})),function(){if("undefined"!=typeof window){if("serviceWorker"in navigator){const e="/spsf-medal-explorer/pr/143/service-worker.js",t="/spsf-medal-explorer/pr/143/";navigator.serviceWorker.register(e,{scope:t}).catch(()=>{})}window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),window.dispatchEvent(new CustomEvent("pwa:install-available"))})}}();export{P as m};
