import{_ as e,r as t,j as r,I as n,C as s,a,u as i,c as l,L as o,O as c,d,S as u,e as m,T as p,f,g as h,h as g,R as b,i as x,k as y,B as v,l as w,m as j,n as k,o as N}from"./vendor-D9hX5c7Y.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const S=new Set(["placeholder","under_review","reviewed"]);class C{constructor(e){var t;this.id=e.id,this.type=e.type,this.tier=e.tier,this.name=e.name,this.displayName=e.displayName,this.tierName=e.tierName,this.color=e.color,this.icon=e.icon,this.typeName=e.typeName??null,this.status=(t=e.status,S.has(t)?t:"placeholder"),this.prerequisites=e.prerequisites||[],this.requirements=e.requirements||[],this.unlocksFollowingMedals=e.unlocksFollowingMedals||[],this.description=e.description||"",this.requirementsOriginal=e.requirements_original||"",this.references=Array.isArray(e.references)?e.references:[],this.yearIntroduced=e.yearIntroduced,this.sortOrder=e.sortOrder}getFullName(){const e=this.tier?this.tier.charAt(0).toUpperCase()+this.tier.slice(1).replace("_"," "):"";return`${this.displayName}${e?` (${e})`:""}`}getColorClass(){return{"#FFD700":"text-medal-gold","#C0C0C0":"text-medal-silver","#CD7F32":"text-medal-bronze"}[this.color]||"text-foreground"}isPlaceholder(){return"placeholder"===this.status}isUnderReview(){return"under_review"===this.status}isReviewed(){return"reviewed"===this.status}}class M{constructor(e){this.medals=(e.medals||[]).map(e=>new C(e))}getMedalById(e){return this.medals.find(t=>t.id===e)}getMedalsByType(e){return this.medals.filter(t=>t.type===e)}getMedalsByTier(e){return this.medals.filter(t=>t.tier===e)}getAllMedals(){return[...this.medals]}}function A(e){return e?.id||e?.medalId}function I(e){const t=e?.medals||[],r=[],n=function(e=[]){const t=new Map;for(const r of e){const e=A(r);e&&t.set(e,r)}return t}(t);return t.forEach(e=>{(e.prerequisites||[]).forEach((t,s)=>{if("medal"===t?.type){const a=t.medalId;n.has(a)||r.push(`Medal ${A(e)} prerequisite #${s} references missing medalId: ${a}`)}})}),{ok:0===r.length,errors:r}}const D={medalDatabase:null,loading:!0,error:null},P=t.createContext(D);function T({children:n}){const[s,a]=t.useState(null),[i,l]=t.useState(!0),[o,c]=t.useState(null);return t.useEffect(()=>{let t=!1;return async function(r){l(!0);try{const n=r??await async function(){const t=await e(()=>import("./medals-BhuBhagp.js"),[]);return t.default||t}(),s=I(n);s.ok||console.warn("Medal dataset validation errors:",s.errors);const i=new M(n);t||(a(i),c(null))}catch(n){t||(c(`Failed to load medal database: ${n.message}`),console.error("Medal database error:",n))}finally{t||l(!1)}}(),()=>{t=!0}},[]),r.jsx(P.Provider,{value:{medalDatabase:s,loading:i,error:o},children:n})}const E=t.createContext(null),_={allowManualUnlock:!0,enforceCurrentYearForSustained:!1},F=["male","female"];class ${constructor(e){this.userId=e.userId||`user-${Date.now()}`,this.displayName=e.displayName||"",this.createdDate=e.createdDate||(new Date).toISOString(),this.lastModified=e.lastModified||(new Date).toISOString(),this.dateOfBirth=e.dateOfBirth||"",this.sex=e.sex,this.unlockedMedals=e.unlockedMedals||[],this.prerequisites=e.prerequisites||[],this.features={..._,...e.features||{}},this.isGuest=Boolean(e.isGuest)}touch(){this.lastModified=(new Date).toISOString()}}function q(e){let t;try{t="string"==typeof e?JSON.parse(e):e}catch{throw new Error("Invalid JSON")}if(!t||"profile-backup"!==t.kind||"1.0"!==t.version||!t.profile||"object"!=typeof t.profile)throw new Error("Invalid profile backup");const r=t.profile,n=Array.isArray(r.prerequisites)?r.prerequisites.map((e,t)=>({...e,id:e?.id||`achievement-${Date.now()}-${t}`})):[];return{kind:t.kind,version:t.version,exportedAt:t.exportedAt,profile:{userId:"string"==typeof r.userId?r.userId.trim():"",displayName:"string"==typeof r.displayName?r.displayName:"",createdDate:r.createdDate||(new Date).toISOString(),lastModified:r.lastModified||(new Date).toISOString(),dateOfBirth:"string"==typeof r.dateOfBirth?r.dateOfBirth:"",sex:"string"==typeof r.sex?r.sex.trim().toLowerCase():"",unlockedMedals:Array.isArray(r.unlockedMedals)?r.unlockedMedals:[],prerequisites:n,features:{allowManualUnlock:!(!r.features||!r.features.allowManualUnlock),enforceCurrentYearForSustained:!(!r.features||!r.features.enforceCurrentYearForSustained)},notifications:!!r.notifications}}}class L{async getUserProfile(){throw new Error("Not implemented")}async saveUserProfile(){throw new Error("Not implemented")}async getAllProfiles(){throw new Error("Not implemented")}async deleteProfile(){throw new Error("Not implemented")}async getAchievements(){throw new Error("Not implemented")}async addAchievement(){throw new Error("Not implemented")}async updateAchievement(){throw new Error("Not implemented")}async upsertAchievements(){throw new Error("Not implemented")}async removeAchievement(){throw new Error("Not implemented")}async exportData(){throw new Error("Not implemented")}async importData(){throw new Error("Not implemented")}}const Y="profiles",R="metadata";class O extends L{constructor(){super(),this.db=null,this.dbName=this._generateDBName(),this._lastValidationReasons=[]}_generateDBName(){return`medal-app-${window.location.pathname.split("/")[1]||"main"}`}async init(){return new Promise((e,t)=>{const r=indexedDB.open(this.dbName,1);r.onerror=()=>{t(new Error("IndexedDB open failed"))},r.onsuccess=t=>{this.db=t.target.result,e()},r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(Y)){const e=t.createObjectStore(Y,{keyPath:"userId"});e.createIndex("lastModified","lastModified",{unique:!1}),e.createIndex("createdDate","createdDate",{unique:!1})}t.objectStoreNames.contains(R)||t.createObjectStore(R,{keyPath:"key"})}})}async getUserProfile(e){return await this._transaction(Y,"readonly",t=>t.get(e))||null}async saveUserProfile(e){if(!this.validateProfile(e))throw new Error("Invalid profile structure");const t={allowManualUnlock:null!=e.features?.allowManualUnlock?!!e.features.allowManualUnlock:_.allowManualUnlock,enforceCurrentYearForSustained:null!=e.features?.enforceCurrentYearForSustained?!!e.features.enforceCurrentYearForSustained:_.enforceCurrentYearForSustained},r=(new Date).toISOString(),n=await this.getUserProfile(e.userId);let s;return s=n?{...n,...e,sex:e.sex,features:t,userId:n.userId,lastModified:r}:{userId:e.userId||new $(e).userId,displayName:e.displayName||"",createdDate:r,lastModified:r,dateOfBirth:e.dateOfBirth,sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:Boolean(e.notifications),features:t},await this._transaction(Y,"readwrite",e=>e.put(s)),s}async getAllProfiles(){return await this._transaction(Y,"readonly",e=>e.getAll())||[]}async deleteProfile(e){await this._transaction(Y,"readwrite",t=>t.delete(e))}_generateAchievementId(){try{if("undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID)return`achievement-${crypto.randomUUID()}`}catch{}return`achievement-${Date.now()}-${Math.random().toString(36).slice(2,11)}`}_ensureAchievementIds(e){let t=!1;return e.prerequisites=Array.isArray(e.prerequisites)?e.prerequisites:[],e.prerequisites.forEach(e=>{e.id||(e.id=this._generateAchievementId(),t=!0)}),t}async getAchievements(e){const t=await this.getUserProfile(e);if(!t)return[];return this._ensureAchievementIds(t)&&await this.saveUserProfile(t),t&&t.prerequisites||[]}buildNaturalKey(e){const t=[e.type,e.year,e.weaponGroup].map(e=>String(e??"").trim().toLowerCase()).join("|");switch(e.type){case"precision_series":return`${t}|${String(e.points??"").trim()}`;case"standard_medal":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.medalType||"").toLowerCase()}`;case"competition_result":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.ppcClass||"").toLowerCase()}|${String(e.date||"").toLowerCase()}|${String(e.score??"").trim()}`;case"qualification_result":return`${t}|${(e.weapon||"").toLowerCase()}|${String(e.score??"").trim()}`;case"team_event":return`${t}|${(e.teamName||"").toLowerCase()}|${String(e.position??"").trim()}`;case"event":return`${t}|${(e.eventName||"").toLowerCase()}`;case"running_shooting_course":return`${t}|${String(e.date||"").toLowerCase()}|${String(e.points??"").trim()}`;default:return null}}async upsertAchievements(e,t,{updateById:r=!0,matchNaturalKey:n=!1,addNew:s=!0,dryRun:a=!0}={}){if(!t||0===t.length)return{added:0,updated:0,skipped:0,failed:0,errors:[]};const i=await this.getUserProfile(e);if(!i)throw new Error("Profile not found");this._ensureAchievementIds(i);const l=Array.isArray(i.prerequisites)?i.prerequisites:[],o=new Map(l.map(e=>[e.id,e])),c=new Map;if(n)for(const p of l){const e=this.buildNaturalKey(p);e&&c.set(e,p)}const d=[...l],u={added:0,updated:0,skipped:0,failed:0,errors:[]};for(let p=0;p<(t||[]).length;p++){const e=t[p];try{if(!this.validateAchievement(e)){const t=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";false,u.failed++,u.errors.push({record:e,row:p+1,error:t});continue}}catch(m){u.failed++,u.errors.push({record:e,row:p+1,error:m?.message||"Validation failed"});continue}let a=null;if(r&&e.id&&o.has(e.id))a=o.get(e.id);else if(n){const t=this.buildNaturalKey(e);t&&c.has(t)&&(a=c.get(t))}if(a){const t=d.findIndex(e=>e.id===a.id);t>=0&&(d[t]={...e,id:a.id},u.updated++);continue}if(s){const t=e.id&&!o.has(e.id)?e.id:this._generateAchievementId();d.push({...e,id:t}),u.added++}else u.skipped++}return a||(i.prerequisites=d,await this.saveUserProfile(i)),u}async addAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");if(!this.validateAchievement(t)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}const n=t.id||this._generateAchievementId(),s={...t,id:n};return r.prerequisites=Array.isArray(r.prerequisites)?r.prerequisites:[],r.prerequisites.push(s),await this.saveUserProfile(r),s}async updateAchievement(e,t,r){const n=await this.getUserProfile(e);if(!n)throw new Error("Profile not found");const s=(n.prerequisites||[]).findIndex(e=>e.id===t);if(s<0)throw new Error("Achievement not found");const a={...r,id:t};if(!this.validateAchievement(a)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}return n.prerequisites[s]=a,await this.saveUserProfile(n),n.prerequisites[s]}async removeAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");r.prerequisites=(r.prerequisites||[]).filter(e=>e.id!==t),await this.saveUserProfile(r)}validateProfile(e){if(!e||"object"!=typeof e)return!1;if(!e.userId||"string"!=typeof e.userId)return!1;if("string"!=typeof e.displayName)return!1;if(!Array.isArray(e.unlockedMedals))return!1;if(!Array.isArray(e.prerequisites))return!1;if(!this._isValidDob(e.dateOfBirth))return!1;if(!e.sex||"string"!=typeof e.sex)return!1;if(!F.includes(e.sex))return!1;if(null!=e.features){if("object"!=typeof e.features)return!1;if("allowManualUnlock"in e.features&&"boolean"!=typeof e.features.allowManualUnlock)return!1;if("enforceCurrentYearForSustained"in e.features&&"boolean"!=typeof e.features.enforceCurrentYearForSustained)return!1}const t=this._computeAge(e.dateOfBirth);return!(t<8||t>100)}validateAchievement(e){const t=[];if(e&&"object"==typeof e){e.type&&"string"==typeof e.type||t.push("type missing or not a string"),("number"!=typeof e.year||Number.isNaN(e.year))&&t.push("year must be a finite number");const r=e.weaponGroup||"";if(["A","B","C","R"].includes(r)||t.push(`weaponGroup must be one of A/B/C/R (got "${r}")`),"precision_series"===e.type&&("number"!=typeof e.points||Number.isNaN(e.points)?t.push("points must be a number"):(e.points<0||e.points>50)&&t.push("points must be between 0 and 50")),"application_series"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}("number"!=typeof e.timeSeconds||!Number.isFinite(e.timeSeconds)||e.timeSeconds<=0)&&t.push("timeSeconds must be a positive number"),("number"!=typeof e.hits||!Number.isFinite(e.hits)||e.hits<0)&&t.push("hits must be a non-negative number")}if("competition_result"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}"number"==typeof e.score&&Number.isFinite(e.score)?e.score<0&&t.push("score must be >= 0"):t.push("score must be a number");const r=["national_whole_match","military_fast_match","ppc"],n=String(e.disciplineType||"").toLowerCase();if(r.includes(n)||t.push(`disciplineType must be one of ${r.join(", ")} (got "${n||"(empty)"}")`),"ppc"===n){const r=e.ppcClass;r&&""!==String(r).trim()||t.push('ppcClass is required when disciplineType is "ppc"')}}if("running_shooting_course"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}("number"!=typeof e.points||!Number.isFinite(e.points)||e.points<0)&&t.push("points must be a non-negative number")}}else t.push("achievement must be an object");const r=0===t.length;return this._lastValidationReasons=t,r}_isValidDob(e){if(!e||"string"!=typeof e)return!1;if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const t=new Date(e);if(Number.isNaN(t.getTime()))return!1;const[r,n,s]=e.split("-").map(Number);return t.getFullYear()===r&&t.getMonth()+1===n&&t.getDate()===s}_computeAge(e){if(!this._isValidDob(e))return NaN;const t=new Date(e),r=new Date;let n=r.getFullYear()-t.getFullYear();const s=r.getMonth()-t.getMonth();return(s<0||0===s&&r.getDate()<t.getDate())&&n--,n}_generateUserId(){try{if("undefined"!=typeof crypto){if("function"==typeof crypto.randomUUID)return`user-${crypto.randomUUID()}`;if("function"==typeof crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e);return`user-${Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}`}}}catch{}return`user-${Date.now()}`}async _ensureUniqueId(e){const t=e&&"string"==typeof e&&e.trim()?e.trim():this._generateUserId();let r=t,n=1;for(;await this.getUserProfile(r);)r=`${t}-${n++}`;return r}async restoreProfile(e,{strategy:t="new-id"}={}){if(!e||"object"!=typeof e)throw new Error("Invalid profile");const r=(new Date).toISOString(),n={userId:String(e.userId||""),displayName:String(e.displayName||""),createdDate:e.createdDate||r,lastModified:r,dateOfBirth:e.dateOfBirth||"",sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:!!e.notifications,features:{..._,...e.features?{allowManualUnlock:!!e.features.allowManualUnlock,enforceCurrentYearForSustained:!!e.features.enforceCurrentYearForSustained}:{}}};if("new-id"===t)n.userId=await this._ensureUniqueId(this._generateUserId());else{if("overwrite"!==t)throw new Error("Invalid restore strategy");if(!n.userId)throw new Error("userId is required for overwrite")}if(!this.validateProfile(n))throw new Error("Invalid profile structure");return await this.saveUserProfile(n),n}async getMetadata(e){const t=await this._transaction(R,"readonly",t=>t.get(e));return t?.value}async setMetadata(e,t){return this._transaction(R,"readwrite",r=>r.put({key:e,value:t}))}async _transaction(e,t,r){if(!this.db)throw new Error("Database not initialized. Call init() first.");return new Promise((n,s)=>{try{const a=this.db.transaction(e,t),i=a.objectStore(e),l=r(i);l.onsuccess=()=>n(l.result),l.onerror=()=>s(l.error),a.onerror=()=>s(a.error),a.onabort=()=>s(new Error("Transaction aborted"))}catch(a){s(a)}})}close(){this.db&&(this.db.close(),this.db=null)}}class U extends L{constructor(){super(),this.storageKey="medal-app-data",this.initializeStorage()}initializeStorage(){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");if(!localStorage.getItem(this.storageKey)){const e={version:"2.0",profiles:[],lastBackup:(new Date).toISOString()};return void localStorage.setItem(this.storageKey,JSON.stringify(e))}try{const e=localStorage.getItem(this.storageKey),t=e?JSON.parse(e):null;if(t&&"2.0"!==t.version){const e=this._migrateToV2(t);this.saveStorageData(e)}}catch{const e={version:"2.0",profiles:[],lastBackup:(new Date).toISOString()};localStorage.setItem(this.storageKey,JSON.stringify(e))}}async getUserProfile(e){return this.getStorageData().profiles.find(t=>t.userId===e)||null}async saveUserProfile(e){if(!this.validateProfile(e))throw new Error("Invalid profile structure");const t={allowManualUnlock:null!=e.features?.allowManualUnlock?!!e.features.allowManualUnlock:_.allowManualUnlock,enforceCurrentYearForSustained:null!=e.features?.enforceCurrentYearForSustained?!!e.features.enforceCurrentYearForSustained:_.enforceCurrentYearForSustained},r=this.getStorageData(),n=(new Date).toISOString();e.lastModified=n;const s=r.profiles.findIndex(t=>t.userId===e.userId);if(s>=0)r.profiles[s]={...r.profiles[s],...e,sex:e.sex,features:t,userId:r.profiles[s].userId};else{const s={userId:e.userId||new $(e).userId,displayName:e.displayName||"",createdDate:n,lastModified:n,dateOfBirth:e.dateOfBirth,sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:Boolean(e.notifications),features:t};r.profiles.push(s),e=s}return this.saveStorageData(r),e}async getAllProfiles(){return this.getStorageData().profiles}async deleteProfile(e){const t=this.getStorageData(),r=t.profiles.length;t.profiles=t.profiles.filter(t=>t.userId!==e),t.profiles.length!==r&&this.saveStorageData(t)}_ensureAchievementIds(e){let t=!1;return e.prerequisites=Array.isArray(e.prerequisites)?e.prerequisites:[],e.prerequisites.forEach((e,r)=>{e.id||(e.id=`achievement-${Date.now()}-${r}-${Math.random().toString(36).slice(2,8)}`,t=!0)}),t}async getAchievements(e){const t=await this.getUserProfile(e);if(!t)return[];return this._ensureAchievementIds(t)&&await this.saveUserProfile(t),t&&t.prerequisites||[]}buildNaturalKey(e){const t=[e.type,e.year,e.weaponGroup].map(e=>String(e??"").trim().toLowerCase()).join("|");switch(e.type){case"precision_series":return`${t}|${String(e.points??"").trim()}`;case"standard_medal":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.medalType||"").toLowerCase()}`;case"competition_result":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.ppcClass||"").toLowerCase()}|${String(e.date||"").toLowerCase()}|${String(e.score??"").trim()}`;case"qualification_result":return`${t}|${(e.weapon||"").toLowerCase()}|${String(e.score??"").trim()}`;case"team_event":return`${t}|${(e.teamName||"").toLowerCase()}|${String(e.position??"").trim()}`;case"event":return`${t}|${(e.eventName||"").toLowerCase()}`;case"running_shooting_course":return`${t}|${String(e.date||"").toLowerCase()}|${String(e.points??"").trim()}`;default:return null}}async upsertAchievements(e,t,{updateById:r=!0,matchNaturalKey:n=!1,addNew:s=!0,dryRun:a=!0}={}){const i=await this.getUserProfile(e);if(!i)throw new Error("Profile not found");this._ensureAchievementIds(i);const l=Array.isArray(i.prerequisites)?i.prerequisites:[],o=new Map(l.map(e=>[e.id,e])),c=new Map;if(n)for(const p of l){const e=this.buildNaturalKey(p);e&&c.set(e,p)}const d=[...l],u={added:0,updated:0,skipped:0,failed:0,errors:[]};for(let p=0;p<(t||[]).length;p++){const e=t[p];try{if(!this.validateAchievement(e)){const t=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";console.groupCollapsed(`[LocalStorageDataManager] Validation failed for row #${p+1}`),console.error("Reason:",t),console.log("Record:",e),console.groupEnd(),u.failed++,u.errors.push({record:e,row:p+1,error:t});continue}}catch(m){console.groupCollapsed(`[LocalStorageDataManager] Exception validating row #${p+1}`),console.error(m),console.log("Record:",e),console.groupEnd(),u.failed++,u.errors.push({record:e,row:p+1,error:m?.message||"Validation failed"});continue}let a=null;if(r&&e.id&&o.has(e.id))a=o.get(e.id),console.debug("[LocalStorageDataManager] Matched by id",{row:p+1,id:e.id});else if(n){const t=this.buildNaturalKey(e);t?c.has(t)?(console.debug("[LocalStorageDataManager] Matched by natural key",{row:p+1,key:t}),a=c.get(t)):console.debug("[LocalStorageDataManager] No match by natural key",{row:p+1,key:t}):console.debug("[LocalStorageDataManager] No natural key for record",{row:p+1})}if(a){const t=d.findIndex(e=>e.id===a.id);t>=0&&(d[t]={...e,id:a.id},u.updated++,console.info("[LocalStorageDataManager] Updated achievement",{row:p+1,id:a.id}));continue}if(s){const t=e.id&&!o.has(e.id)?e.id:`achievement-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;d.push({...e,id:t}),u.added++,console.info("[LocalStorageDataManager] Added achievement",{row:p+1,id:t})}else u.skipped++,console.info("[LocalStorageDataManager] Skipped (addNew=false)",{row:p+1})}return a||(i.prerequisites=d,await this.saveUserProfile(i)),u}async addAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");if(!this.validateAchievement(t)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}const n=t.id||`achievement-${Date.now()}`,s={...t,id:n};return r.prerequisites=Array.isArray(r.prerequisites)?r.prerequisites:[],r.prerequisites.push(s),await this.saveUserProfile(r),s}async updateAchievement(e,t,r){const n=await this.getUserProfile(e);if(!n)throw new Error("Profile not found");const s=(n.prerequisites||[]).findIndex(e=>e.id===t);if(s<0)throw new Error("Achievement not found");const a={...r,id:t};if(!this.validateAchievement(a)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}return n.prerequisites[s]=a,await this.saveUserProfile(n),n.prerequisites[s]}async removeAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");r.prerequisites=(r.prerequisites||[]).filter(e=>e.id!==t),await this.saveUserProfile(r)}validateProfile(e){if(!e||"object"!=typeof e)return!1;if(!e.userId||"string"!=typeof e.userId)return!1;if("string"!=typeof e.displayName)return!1;if(!Array.isArray(e.unlockedMedals))return!1;if(!Array.isArray(e.prerequisites))return!1;if(!this._isValidDob(e.dateOfBirth))return!1;if(!e.sex||"string"!=typeof e.sex)return!1;if(!F.includes(e.sex))return!1;if(null!=e.features){if("object"!=typeof e.features)return!1;if("allowManualUnlock"in e.features&&"boolean"!=typeof e.features.allowManualUnlock)return!1;if("enforceCurrentYearForSustained"in e.features&&"boolean"!=typeof e.features.enforceCurrentYearForSustained)return!1}const t=this._computeAge(e.dateOfBirth);return!(t<8||t>100)}validateAchievement(e){const t=[];if(e&&"object"==typeof e){e.type&&"string"==typeof e.type||t.push("type missing or not a string"),("number"!=typeof e.year||Number.isNaN(e.year))&&t.push("year must be a finite number");const r=e.weaponGroup||"";if(["A","B","C","R"].includes(r)||t.push(`weaponGroup must be one of A/B/C/R (got "${r}")`),"precision_series"===e.type&&("number"!=typeof e.points||Number.isNaN(e.points)?t.push("points must be a number"):(e.points<0||e.points>50)&&t.push("points must be between 0 and 50")),"application_series"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}("number"!=typeof e.timeSeconds||!Number.isFinite(e.timeSeconds)||e.timeSeconds<=0)&&t.push("timeSeconds must be a positive number"),("number"!=typeof e.hits||!Number.isFinite(e.hits)||e.hits<0)&&t.push("hits must be a non-negative number")}if("competition_result"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}"number"==typeof e.score&&Number.isFinite(e.score)?e.score<0&&t.push("score must be >= 0"):t.push("score must be a number");const r=["national_whole_match","military_fast_match","ppc"],n=String(e.disciplineType||"").toLowerCase();if(r.includes(n)||t.push(`disciplineType must be one of ${r.join(", ")} (got "${n||"(empty)"}")`),"ppc"===n){const r=e.ppcClass;r&&""!==String(r).trim()||t.push('ppcClass is required when disciplineType is "ppc"')}}if("running_shooting_course"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}("number"!=typeof e.points||!Number.isFinite(e.points)||e.points<0)&&t.push("points must be a non-negative number")}}else t.push("achievement must be an object");const r=0===t.length;if(this._lastValidationReasons=t,!r)try{console.groupCollapsed("[LocalStorageDataManager] validateAchievement failed"),console.error("Reasons:",t),console.log("Achievement:",e),console.groupEnd()}catch{}return r}getStorageData(){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");try{const e=localStorage.getItem(this.storageKey);if(!e)return this.initializeStorage(),this.getStorageData();const t=JSON.parse(e);if(!t||"object"!=typeof t||!Array.isArray(t.profiles))throw new Error("Malformed storage root");return t}catch(e){throw console.error("Failed to read storage:",e),new Error("Storage data corrupted")}}saveStorageData(e){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(t){if(t&&("QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name||22===t.code))throw new Error("Storage quota exceeded");throw t}}_isValidDob(e){if(!e||"string"!=typeof e)return!1;if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const t=new Date(e);return!Number.isNaN(t.getTime())}_computeAge(e){if(!this._isValidDob(e))return NaN;const t=new Date(e),r=new Date;let n=r.getFullYear()-t.getFullYear();const s=r.getMonth()-t.getMonth();return(s<0||0===s&&r.getDate()<t.getDate())&&n--,n}_defaultDob(){return"2000-01-01"}_migrateToV2(e){const t={...e};return t.version="2.0",t.profiles=Array.isArray(e.profiles)?e.profiles.map(e=>{const t={...e};return delete t.weaponGroupPreference,this._isValidDob(t.dateOfBirth)||(t.dateOfBirth=this._defaultDob()),t.features?("boolean"!=typeof t.features.allowManualUnlock&&(t.features.allowManualUnlock=_.allowManualUnlock),"boolean"!=typeof t.features.enforceCurrentYearForSustained&&(t.features.enforceCurrentYearForSustained=_.enforceCurrentYearForSustained)):t.features={..._},t.lastModified=(new Date).toISOString(),t}):[],t}_hasStorage(){try{return"undefined"!=typeof localStorage}catch{return!1}}_generateUserId(){try{if("undefined"!=typeof crypto){if("function"==typeof crypto.randomUUID)return`user-${crypto.randomUUID()}`;if("function"==typeof crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e);return`user-${Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}`}}}catch{}return`user-${Date.now()}`}_ensureUniqueId(e){const t=this.getStorageData(),r=e&&"string"==typeof e&&e.trim()?e.trim():this._generateUserId();let n=r,s=1;for(;t.profiles.some(e=>e.userId===n);)n=`${r}-${s++}`;return n}async restoreProfile(e,{strategy:t="new-id"}={}){if(!e||"object"!=typeof e)throw new Error("Invalid profile");const r=(new Date).toISOString(),n={userId:String(e.userId||""),displayName:String(e.displayName||""),createdDate:e.createdDate||r,lastModified:r,dateOfBirth:e.dateOfBirth||"",sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:!!e.notifications,features:{..._,...e.features?{allowManualUnlock:!!e.features.allowManualUnlock,enforceCurrentYearForSustained:!!e.features.enforceCurrentYearForSustained}:{}}};if("new-id"===t)n.userId=this._ensureUniqueId(this._generateUserId());else{if("overwrite"!==t)throw new Error("Invalid restore strategy");if(!n.userId)throw new Error("userId is required for overwrite")}if(!this.validateProfile(n))throw new Error("Invalid profile structure");const s=this.getStorageData(),a=s.profiles.findIndex(e=>e.userId===n.userId);return a>=0?s.profiles[a]=n:s.profiles.push(n),this.saveStorageData(s),n}}async function B(){const e=null!==localStorage.getItem("medal-app-data");return await async function(){let e;try{e=new O,await e.init();const t=await e.getAllProfiles();return t&&t.length>0}catch{return!1}finally{try{e?.close?.()}catch{}}}()?"indexeddb":e?"localstorage":"none"}function G(){const[e,r]=t.useState(null),[n,s]=t.useState(!1),[a,i]=t.useState(null);return t.useEffect(()=>{let e=!1;return async function(){try{const n=function(){try{return!("undefined"==typeof indexedDB||!indexedDB)&&"function"==typeof indexedDB.open}catch{return!1}}(),a=await B();if(e)return;if("none"===a||"indexeddb"===a){if(n)try{const t=new O;await t.init(),e||r(t)}catch(t){console.error("IndexedDB initialization failed, falling back to localStorage:",t);const n=new U;e||r(n)}else{const t=new U;e||r(t)}return}if("localstorage"===a&&n){e||s(!0);const n=await async function(e){let t;try{e?.({stage:"loading",percent:0});const n=new U,s=await n.getAllProfiles();e?.({stage:"saving",percent:33}),t=new O,await t.init();for(let r=0;r<s.length;r++)await t.saveUserProfile(s[r]),e?.({stage:"saving",percent:33+(r+1)/s.length*34});if(await t.setMetadata("migration_complete",!0),await t.setMetadata("migration_date",(new Date).toISOString()),await t.setMetadata("migrated_from","localstorage"),e?.({stage:"verifying",percent:75}),(await t.getAllProfiles()).length!==s.length)throw new Error("Migration verification failed: profile count mismatch");try{localStorage.removeItem("medal-app-data"),await t.setMetadata("localstorage_cleaned",!0)}catch(r){console.warn("[migrationManager] Failed to clean up localStorage:",r)}return e?.({stage:"complete",percent:100}),{success:!0,profilesMigrated:s.length}}catch(n){return{success:!1,error:n.message}}finally{try{t?.close?.()}catch{}}}(t=>{e||i(t)});if(e)return;if(s(!1),n.success)try{const t=new O;await t.init(),e||r(t)}catch(t){console.error("IndexedDB initialization failed after migration, falling back to localStorage:",t);const n=new U;e||r(n)}else{console.error("Migration failed:",n.error);const t=new U;e||r(t)}}else{const t=new U;e||r(t)}}catch(n){if(console.error("Storage initialization failed, falling back to localStorage:",n),!e)try{const e=new U;r(e)}catch(a){console.error("Fatal: even localStorage fallback failed:",a),r(new U)}}}(),()=>{e=!0}},[]),{manager:e,migrating:n,migrationProgress:a}}const V="profile:dataChanged";function z(){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent(V))}const K="app:onboardingChoice",H="app:lastProfileId";function W(e){if("undefined"!=typeof window)try{e?window.localStorage.setItem(H,e):window.localStorage.removeItem(H)}catch{}}function X({children:e}){const{manager:n,migrating:s}=G(),[a,i]=t.useState(void 0),[l,o]=t.useState([]),[c,d]=t.useState(!1),[u,m]=t.useState(null),[p,f]=t.useState(!1),h=t.useCallback(async()=>{try{d(!0);const e=await n.getAllProfiles();o(e),m(null)}catch(e){m(e.message),console.error("Failed to load profiles:",e)}finally{d(!1)}},[n]),g=t.useCallback(e=>{try{window.localStorage.setItem(K,"guest")}catch(t){}i(function({sex:e}){return new $({userId:"guest",displayName:"Gästläge",dateOfBirth:"1975-01-02",sex:e,unlockedMedals:[],prerequisites:[],isGuest:!0})}({sex:e}))},[]);t.useEffect(()=>{if(!n||s)return;let e=!1;return(async()=>{try{d(!0);const r=await n.getAllProfiles();if(e)return;o(r);let s=null;const a=function(){if("undefined"==typeof window)return null;try{return new URL(window.location.href).searchParams.get("profile")||null}catch{return null}}();if(a&&r.some(e=>e.userId===a))s=r.find(e=>e.userId===a)||null,W(a);else{const e=function(){if("undefined"==typeof window)return null;try{return window.localStorage.getItem(H)}catch{return null}}();if(e&&r.some(t=>t.userId===e))s=r.find(t=>t.userId===e)||null;else if(r.length>0)s=[...r].sort((e,t)=>new Date(t.lastModified)-new Date(e.lastModified))[0];else try{"guest"===window.localStorage.getItem(K)&&(s=null)}catch(t){}}i(s??null),m(null)}catch(r){e||(m(r.message),console.error("Failed to bootstrap profiles:",r))}finally{e||(d(!1),f(!0))}})(),()=>{e=!0}},[n,s]);const b=t.useCallback(async(e,t,r)=>{try{d(!0);const s=new $({displayName:e,dateOfBirth:t,sex:r}),a=await n.saveUserProfile(s);return i(a),W(a.userId),await h(),a}catch(s){throw m(s.message),s}finally{d(!1)}},[n,h]),x=t.useCallback(async e=>{try{d(!0);const t=await n.getUserProfile(e);if(!t)throw new Error("Profile not found");i(t),W(t.userId),m(null)}catch(t){m(t.message)}finally{d(!1)}},[n]);t.useEffect(()=>{if(p&&a&&!a.isGuest)try{window.localStorage.removeItem(K)}catch(e){}},[a,p]);const y=t.useCallback(async e=>{try{d(!0);const t=await n.saveUserProfile(e);return i(t),W(t.userId),await h(),t}catch(t){throw m(t.message),t}finally{d(!1)}},[n,h]),v=t.useCallback(async e=>{try{d(!0),await n.deleteProfile(e),a?.userId===e&&(i(null),W(null)),await h()}catch(t){throw m(t.message),t}finally{d(!1)}},[n,a,h]),w=t.useCallback(async e=>{if(!a)throw new Error("No profile selected");if(a.isGuest)return i(t=>({...t,prerequisites:[...t?.prerequisites||[],e],lastModified:(new Date).toISOString()})),z(),e;try{d(!0);const t=await n.addAchievement(a.userId,e),r=await n.getUserProfile(a.userId);return i(r),z(),t}catch(t){throw m(t.message),t}finally{d(!1)}},[a,n]),j=t.useCallback(async e=>{if(!a)throw new Error("No profile selected");if(!e?.id)throw new Error("Achievement id is required");if(a.isGuest)return i(t=>{const r=Array.isArray(t?.prerequisites)?[...t.prerequisites]:[],n=r.findIndex(t=>t.id===e.id);return-1!==n&&(r[n]={...r[n],...e}),{...t,prerequisites:r,lastModified:(new Date).toISOString()}}),z(),e;try{d(!0);const t=await n.getUserProfile(a.userId),r=Array.isArray(t.prerequisites)?[...t.prerequisites]:[],s=r.findIndex(t=>t.id===e.id);if(-1===s)throw new Error("Achievement not found");r[s]={...r[s],...e};const l={...t,prerequisites:r,lastModified:(new Date).toISOString()},o=await n.saveUserProfile(l);return i(o),z(),o.prerequisites[s]}catch(t){throw m(t.message),t}finally{d(!1)}},[a,n]),k=t.useCallback(async e=>{if(!a)throw new Error("No profile selected");if(!e)throw new Error("Achievement id is required");if(a.isGuest)return i(t=>({...t,prerequisites:(t?.prerequisites||[]).filter(t=>t.id!==e),lastModified:(new Date).toISOString()})),z(),!0;try{d(!0);const t=await n.getUserProfile(a.userId),r=Array.isArray(t.prerequisites)?t.prerequisites.filter(t=>t.id!==e):[],s={...t,prerequisites:r,lastModified:(new Date).toISOString()},l=await n.saveUserProfile(s);return i(l),z(),!0}catch(t){throw m(t.message),t}finally{d(!1)}},[a,n]),N=t.useCallback(async(e,t)=>{if(!a)throw new Error("No profile selected");if(!e)throw new Error("medalId is required");if(a.isGuest){let r=!1;return i(n=>{const s=Array.isArray(n?.unlockedMedals)?[...n.unlockedMedals]:[];if(s.some(t=>t.medalId===e))return n;r=!0;const a={medalId:e,unlockedDate:t||(new Date).toISOString().slice(0,10)};return{...n,unlockedMedals:[...s,a],lastModified:(new Date).toISOString()}}),r&&z(),!0}try{d(!0);const r=await n.getUserProfile(a.userId),s=Array.isArray(r.unlockedMedals)?[...r.unlockedMedals]:[];if(s.some(t=>t.medalId===e))return!1;const l={medalId:e,unlockedDate:t||(new Date).toISOString().slice(0,10)},o={...r,unlockedMedals:[...s,l],lastModified:(new Date).toISOString()},c=await n.saveUserProfile(o);return i(c),z(),!0}catch(r){throw m(r.message),r}finally{d(!1)}},[a,n]),S=t.useCallback(async e=>{if(!a)throw new Error("No profile selected");if(!e)throw new Error("medalId is required");if(a.isGuest)return i(t=>({...t,unlockedMedals:(t?.unlockedMedals||[]).filter(t=>t.medalId!==e),lastModified:(new Date).toISOString()})),!0;try{d(!0);const t=await n.getUserProfile(a.userId),r=Array.isArray(t.unlockedMedals)?t.unlockedMedals:[],s=r.filter(t=>t.medalId!==e);if(s.length===r.length)return!1;const l={...t,unlockedMedals:s,lastModified:(new Date).toISOString()},o=await n.saveUserProfile(l);return i(o),!0}catch(t){throw m(t.message),t}finally{d(!1)}},[a,n]),C=t.useCallback(async(e,t)=>{if(!a)throw new Error("No profile selected");if(!e)throw new Error("Feature name is required");if(a.isGuest)return i(r=>({...r,features:{...r?.features||{},[e]:!!t},lastModified:(new Date).toISOString()})),m(null),a;try{d(!0);const r=await n.getUserProfile(a.userId),s={...r.features||{},[e]:!!t},l={...r,features:s,lastModified:(new Date).toISOString()},o=await n.saveUserProfile(l);return i(o),m(null),o}catch(r){throw m(r.message),r}finally{d(!1)}},[a,n]),M=t.useCallback(async(e,t={strategy:"new-id"})=>{try{d(!0);const r=q(e),s=await n.restoreProfile(r.profile,t);return i(s),W(s.userId),await h(),m(null),s}catch(r){throw m(r.message),r}finally{d(!1)}},[n,h]),A=t.useCallback(async(e,t)=>{if(!a)throw new Error("No profile selected");if(a.isGuest)return t?.dryRun||i(t=>({...t,prerequisites:(Array.isArray(t?.prerequisites),[...e]),lastModified:(new Date).toISOString()})),m(null),{added:e?.length||0,updated:0,duplicates:0};try{d(!0);const r=await n.upsertAchievements(a.userId,e,t);if(!t?.dryRun){const e=await n.getUserProfile(a.userId);i(e),W(e.userId),await h()}return m(null),r}catch(r){throw m(r.message),r}finally{d(!1)}},[a,n,h]),I=t.useCallback(async(e,t="",r)=>{if(!a?.isGuest)return null;const s=new $({...a,userId:void 0,displayName:e||"Profil",dateOfBirth:t,sex:r,isGuest:!1}),l=await n.saveUserProfile(s);return i(l),W(l.userId),await h(),l},[a,n,h]),D=t.useCallback(async()=>{if(!a)return!1;const e={...a,unlockedMedals:[],prerequisites:[],lastModified:(new Date).toISOString()};if(a.isGuest)return i(e),!0;const t=await n.saveUserProfile(e);return i(t),await h(),!0},[a,n,h]),P={currentProfile:a,profiles:l,loading:c,hydrated:p,error:u,createProfile:b,selectProfile:x,updateProfile:y,deleteProfile:v,addAchievement:w,updateAchievement:j,removeAchievement:k,unlockMedal:N,lockMedal:S,setProfileFeature:C,restoreProfileFromBackup:M,upsertAchievements:A,startExplorerMode:g,convertGuestToSaved:I,resetCurrentProfileData:D};return r.jsx(E.Provider,{value:P,children:e})}const J=t.createContext(null);function Z({lastBackupDate:e,lastDataChange:t,reminderFrequency:r,reminderDismissedUntil:n}){if(0===r)return!1;if(n){if(new Date(n)>new Date)return!1}if(!t)return!1;if(!e)return!0;const s=new Date(e),a=new Date(t),i=function(e,t){const r=t-e;return Math.floor(r/864e5)}(s,new Date);return a>s&&i>=r}function Q({children:e}){const{manager:n}=G(),[s,a]=t.useState(null),[i,l]=t.useState(null),[o,c]=t.useState(30),[d,u]=t.useState(null),[m,p]=t.useState(!0);t.useEffect(()=>{!async function(){if(n)try{const e=await n.getMetadata("lastBackupDate"),t=await n.getMetadata("lastDataChange"),r=await n.getMetadata("backupReminderFrequency"),s=await n.getMetadata("reminderDismissedUntil");a(e||null),l(t||null),c(r??30),u(s||null)}catch(e){console.error("Failed to load backup metadata:",e)}finally{p(!1)}}()},[n]);const f=t.useCallback(async()=>{const e=(new Date).toISOString();if(a(e),n)try{await n.setMetadata("lastBackupDate",e)}catch(t){console.error("Failed to save lastBackupDate:",t)}},[n]),h=t.useCallback(async()=>{const e=(new Date).toISOString();if(l(e),n)try{await n.setMetadata("lastDataChange",e)}catch(t){console.error("Failed to save lastDataChange:",t)}},[n]),g=t.useCallback(async e=>{if(c(e),n)try{await n.setMetadata("backupReminderFrequency",e)}catch(t){console.error("Failed to save backupReminderFrequency:",t)}},[n]),b=t.useCallback(async()=>{const e=function(e=new Date){const t=new Date(e);return t.setDate(t.getDate()+7),t.toISOString()}();if(u(e),n)try{await n.setMetadata("reminderDismissedUntil",e)}catch(t){console.error("Failed to save reminderDismissedUntil:",t)}},[n]);t.useEffect(()=>{const e=()=>{h()};return window.addEventListener(V,e),()=>window.removeEventListener(V,e)},[h]);const x=t.useMemo(()=>Z({lastBackupDate:s,lastDataChange:i,reminderFrequency:o,reminderDismissedUntil:d}),[s,i,o,d]),y={lastBackupDate:s,lastDataChange:i,reminderFrequency:o,reminderDismissedUntil:d,isLoading:m,shouldShowReminder:x,markBackupCreated:f,markDataChanged:h,updateReminderFrequency:g,dismissReminder:b};return r.jsx(J.Provider,{value:y,children:e})}const ee=t.createContext(null),te=new Map;class re{constructor(e,t){this.medals=e,this.profile=t||{unlockedMedals:[],prerequisites:[]}}static registerCustomCriterion(e,t){if("string"!=typeof e||!e)throw new Error("custom_criterion name must be a non-empty string");if("function"!=typeof t)throw new Error("custom_criterion handler must be a function");te.set(e,t)}evaluateMedal(e,t={}){const r=this.medals.getMedalById(e);if(!r)throw new Error(`Medal not found: ${e}`);if("function"==typeof r.isPlaceholder&&r.isPlaceholder()||"placeholder"===r.status)return{medalId:e,status:"locked",reason:"placeholder",details:{message:"Placeholder medal"}};if(this.hasUnlockedMedal(e))return{medalId:e,status:"unlocked",unlockedDate:this.getUnlockedDate(e),details:{}};if(Array.isArray(r.prerequisites)){const n=r.prerequisites.filter(e=>"medal"===e?.type).filter(e=>{if(!this.hasUnlockedMedal(e.medalId))return!0;if("number"==typeof t.endYear){const r=this.getUnlockedYear(e.medalId);return!("number"==typeof r&&r<=t.endYear)}return!1});if(n.length)return{medalId:e,status:"locked",reason:"prerequisites_not_met",details:{prerequisites:{missingMedals:n.map(e=>e.medalId)}}}}const n=this.checkRequirements(r,t);if(!n.allMet)return{medalId:e,status:"available",reason:"requirements_not_met",details:n};const s=this.checkPrerequisites(r,n.unlockYear??t.endYear);return s.allMet?{medalId:e,status:"eligible",eligibleYear:n.unlockYear??null,details:{...n,prerequisites:s}}:{medalId:e,status:"locked",reason:"prerequisites_not_met",details:s}}hasUnlockedMedal(e){return this.profile.unlockedMedals?.some(t=>t.medalId===e)||!1}getUnlockedDate(e){const t=this.profile.unlockedMedals?.find(t=>t.medalId===e);return t?t.unlockedDate:null}checkPrerequisites(e,t){if(!e.prerequisites||0===e.prerequisites.length)return{allMet:!0,items:[],missingItems:[]};const r=[],n=[];return e.prerequisites.forEach(e=>{if("medal"===e.type){const s=this.getUnlockedYear(e.medalId),a=this.hasUnlockedMedal(e.medalId)&&("number"!=typeof t||"number"==typeof s&&s<=t),i={type:"medal",medalId:e.medalId,isMet:a,achieved:a?this.getUnlockedDate(e.medalId):null,description:e.description,yearOffset:e.yearOffset};if(r.push(i),a){if("number"==typeof e.yearOffset){const r=this.getUnlockedYear(e.medalId),s="number"==typeof t?t:this.getMostRecentAchievementYear()??(new Date).getFullYear(),a=null!==r&&s-r>=e.yearOffset,l={...i,isMet:a,offsetChecked:!0,plannedYear:s};a||n.push(l)}}else n.push(i)}else if("age_requirement"===e.type){const s=this.profile?.dateOfBirth;let a=null,i=!1;if(s){const r=new Date(s);if(!Number.isNaN(r.getTime())){const n="number"==typeof t?new Date(t,11,31):new Date;let s=n.getFullYear()-r.getFullYear();const l=n.getMonth()-r.getMonth();(l<0||0===l&&n.getDate()<r.getDate())&&(s-=1),a=s;const o="number"!=typeof e.minAge||a>=e.minAge,c="number"!=typeof e.maxAge||a<=e.maxAge;i=o&&c}}const l={type:"age_requirement",isMet:i,minAge:e.minAge,...null!=e.maxAge?{maxAge:e.maxAge}:{},...null!=a?{age:a}:{},description:e.description};r.push(l),i||n.push(l)}}),{allMet:0===n.length,items:r,missingItems:n}}getUnlockedYear(e){const t=this.profile.unlockedMedals?.find(t=>t.medalId===e);return t?t.year?t.year:t.unlockedDate?new Date(t.unlockedDate).getFullYear():null:null}getMostRecentAchievementYear(){const e=this.profile.prerequisites||[];return e.length?e.reduce((e,t)=>Math.max(e,t.year||e),0):null}getSameTypePrereqMedalIds(e){const t=e?.type;return t?(e?.prerequisites||[]).filter(e=>"medal"===e?.type).map(e=>e.medalId).filter(e=>{const r=this.medals.getMedalById(e);return r&&r.type===t}):[]}getEarliestCountingYearForMedal(e){const t=this.getSameTypePrereqMedalIds(e).map(e=>this.getUnlockedYear(e)).filter(e=>"number"==typeof e);return t.length?Math.max(...t)+1:null}getMinimalUnlockYearForSustained(e){if(!e)return null;const t=(e.requirements||[]).find(e=>"sustained_achievement"===e?.type);if(!t)return null;const r=Number.isFinite(t?.yearsOfAchievement)?t.yearsOfAchievement:1,n=this.getSameTypePrereqMedalIds(e).map(e=>this.getUnlockedYear(e)).filter(e=>"number"==typeof e);if(!n.length)return null;return Math.max(...n)+r}getAllAchievementYears(){const e=this.profile.prerequisites||[],t=new Set;for(const r of e){const e=Number(r.year);Number.isNaN(e)||t.add(e)}return Array.from(t).sort((e,t)=>e-t)}requirementsMetInYear(e,t,r={}){const n="string"==typeof e?this.medals.getMedalById(e):e;if(!n)return!1;return this.checkRequirements(n,{...r,endYear:t}).allMet}checkRequirements(e,t={}){const r=e.requirements;if(!r||Array.isArray(r)&&0===r.length)return{allMet:!0,items:[],unlockYear:null,tree:{node:"and",isMet:!0,children:[]}};const n=this.normalizeRequirementSpec(r),s=r=>this.evaluateReqNode(n,e,{...t,endYear:r});if("number"==typeof t.endYear){const e=s(t.endYear),r=!!e.isMet;return{allMet:r,items:this.flattenLeaves(e),unlockYear:r?t.endYear:null,tree:e}}const a=this.getCandidateYearsForTree();for(const l of a){const e=s(l);if(e.isMet)return{allMet:!0,items:this.flattenLeaves(e),unlockYear:l,tree:e}}const i=this.evaluateReqNode(n,e,t);return{allMet:!1,items:this.flattenLeaves(i),unlockYear:null,tree:i}}checkPrecisionSeriesRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type);if(null!=r.endYear){let s=n;const a=e.timeWindowYears;if(1===a)s=n.filter(e=>e.year===r.endYear);else if("number"==typeof a&&a>1){const e=r.endYear-a+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);s=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else s=n.filter(e=>e.year===r.endYear);const i=this.filterByPrecisionSeriesThreshold(s,e),l=e.minAchievements??1,o={current:i.length,required:l},c=o.current>=l;return{type:"precision_series",index:t,isMet:c,progress:o,description:e.description,pointThresholds:{A:e.pointThresholds?.A?.min,B:e.pointThresholds?.B?.min,C:e.pointThresholds?.C?.min,R:e.pointThresholds?.R?.min},windowYear:c?r.endYear:null}}const s=t=>this.filterByPrecisionSeriesThreshold(t,e);let a=[],i=null;if(1===e.timeWindowYears){const e=this.groupBy(n,e=>e.year);let t=null,r=[];Object.entries(e).forEach(([e,n])=>{const a=s(n);a.length>r.length&&(r=a,t=Number(e))}),a=r,i=t}else if("number"==typeof e.timeWindowYears&&e.timeWindowYears>1){const t=Array.from(new Set(n.map(e=>e.year).filter(e=>"number"==typeof e))).sort((e,t)=>e-t);let r=null,l=[];for(const a of t){const t=a-e.timeWindowYears+1,i=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=a),o=s(i);o.length>l.length&&(l=o,r=a)}a=l,i=r}else a=s(n);const l=e.minAchievements??1,o={current:a.length,required:l},c=o.current>=l;return{type:"precision_series",index:t,isMet:c,progress:o,description:e.description,pointThresholds:{A:e.pointThresholds?.A?.min,B:e.pointThresholds?.B?.min,C:e.pointThresholds?.C?.min,R:e.pointThresholds?.R?.min},windowYear:c?i:null}}checkApplicationSeriesRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"application_series"===e.type),s=t=>{const r=t.weaponGroup||"A",n=e.thresholds?.[r];if(!n)return!1;const s="number"==typeof t.timeSeconds&&t.timeSeconds>0,a="number"==typeof t.hits&&t.hits>=0,i="number"!=typeof n.maxTimeSeconds||t.timeSeconds<=n.maxTimeSeconds,l="number"!=typeof n.minHits||t.hits>=n.minHits;return s&&a&&i&&l};if(null!=r.endYear){let a=n;const i=e.timeWindowYears;if(1===i)a=n.filter(e=>e.year===r.endYear);else if("number"==typeof i&&i>1){const e=r.endYear-i+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);a=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else a=n.filter(e=>e.year===r.endYear);const l=a.filter(s),o=e.minAchievements??1,c={current:l.length,required:o},d=c.current>=o;return{type:"application_series",index:t,isMet:d,progress:c,description:e.description,windowYear:d?r.endYear:null}}let a=[],i=null;if(1===e.timeWindowYears){const e=this.groupBy(n,e=>e.year);let t=[],r=null;Object.entries(e).forEach(([e,n])=>{const a=n.filter(s);a.length>t.length&&(t=a,r=Number(e))}),a=t,i=r}else if("number"==typeof e.timeWindowYears&&e.timeWindowYears>1){const t=Array.from(new Set(n.map(e=>e.year).filter(e=>"number"==typeof e))).sort((e,t)=>e-t);let r=null,l=[];for(const a of t){const t=a-e.timeWindowYears+1,i=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=a).filter(s);i.length>l.length&&(l=i,r=a)}a=l,i=r}else a=n.filter(s);const l=e.minAchievements??1,o={current:a.length,required:l},c=o.current>=l;return{type:"application_series",index:t,isMet:c,progress:o,description:e.description,windowYear:c?i:null}}checkRunningShootingCourseRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"running_shooting_course"===e.type),s=r&&"number"==typeof r.endYear?r.endYear:null;if(null==s)return{type:"running_shooting_course",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};const a=this.profile?.sex;if("male"!==a&&"female"!==a)throw new Error("Profile sex is required for running_shooting_course requirements");const i=this.getAgeAtYear(s);if(null==i)throw new Error("Profile dateOfBirth is required for running_shooting_course requirements");const l=(()=>{const t=Array.isArray(e.ageCategories)?e.ageCategories:[];return t.length&&t.find(e=>{const t="number"==typeof e.ageMin?e.ageMin:0,r="number"==typeof e.ageMax?e.ageMax:999;return i>=t&&i<=r})||null})(),o=(l?.maxPoints&&"object"==typeof l.maxPoints?l.maxPoints[a]:void 0)??(e?.maxPoints&&"object"==typeof e.maxPoints?e.maxPoints[a]:void 0);if(!Number.isFinite(o))throw new Error("running_shooting_course requirement is missing maxPoints for profile sex");let c=n;const d=e.timeWindowYears;if(1===d)c=n.filter(e=>e.year===s);else if("number"==typeof d&&d>1){const e=s-d+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);c=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=s)}else c=n.filter(e=>e.year===s);const u=c.filter(e=>"number"==typeof e.points&&Number.isFinite(e.points)&&e.points<=o),m=e.minAchievements??1,p={current:u.length,required:m},f=p.current>=m;return{type:"running_shooting_course",index:t,isMet:f,progress:p,description:e.description,windowYear:f?s:null,maxPoints:o,sex:a,age:i,...l?.name?{ageCategory:l.name}:{}}}filterByPrecisionSeriesThreshold(e,t){const r={A:t.pointThresholds?.A?.min??0,B:t.pointThresholds?.B?.min??0,C:t.pointThresholds?.C?.min??0,R:t.pointThresholds?.R?.min??0};return(e||[]).filter(e=>{const t=e.weaponGroup||"A",n=r[t];return"number"==typeof e.points&&e.points>=n})}groupBy(e,t){return(e||[]).reduce((e,r)=>{const n=t(r);return e[n]=e[n]||[],e[n].push(r),e},{})}normalizeRequirementSpec(e){return Array.isArray(e)?{op:"and",children:e.map(e=>this.normalizeRequirementSpec(e))}:e&&"object"==typeof e?Array.isArray(e.and)?{op:"and",children:e.and.map(e=>this.normalizeRequirementSpec(e))}:Array.isArray(e.or)?{op:"or",children:e.or.map(e=>this.normalizeRequirementSpec(e))}:{op:"leaf",req:e}:{op:"leaf",req:{}}}evaluateReqNode(e,t,r={}){if(!e)return{node:"leaf",isMet:!1,leaf:{type:"unknown",index:-1,isMet:!1}};if("and"===e.op){const n=e.children?.map(e=>this.evaluateReqNode(e,t,r))||[];return{node:"and",isMet:n.every(e=>e.isMet),children:n}}if("or"===e.op){const n=e.children?.map(e=>this.evaluateReqNode(e,t,r))||[];return{node:"or",isMet:n.some(e=>e.isMet),children:n}}const n=e.req||{};let s;switch(n.type){case"precision_series":s=this.checkPrecisionSeriesRequirement(n,-1,r);break;case"application_series":s=this.checkApplicationSeriesRequirement(n,-1,r);break;case"running_shooting_course":s=this.checkRunningShootingCourseRequirement(n,-1,r);break;case"sustained_achievement":s=this.checkSustainedAchievementRequirement(n,-1,t,r);break;case"cumulative_competition_score":s=this.checkCumulativeCompetitionScoreRequirement(n,-1,r);break;case"standard_medal":s=this.checkStandardMedalRequirement(n,-1,r);break;case"sustained_reference":s=this.checkSustainedReferenceRequirement(n,-1,t,r);break;case"custom_criterion":s=this.checkCustomCriterionRequirement(n,-1,r);break;default:s={type:n.type,index:-1,isMet:!1,reason:"unsupported_requirement_type",description:n.description}}return{node:"leaf",isMet:!!s.isMet,leaf:s}}flattenLeaves(e,t=[]){if(!e)return t;if("leaf"===e.node)return t.push(e.leaf),t;for(const r of e.children||[])this.flattenLeaves(r,t);return t}getCandidateYearsForTree(){const e=new Set(this.getAllAchievementYears()),t=(new Date).getFullYear();return e.add(t),Array.from(e).sort((e,t)=>t-e)}getAgeAtYear(e){const t=this.profile?.dateOfBirth;if(!t)return null;const r=new Date(t);if(Number.isNaN(r.getTime()))return null;const n=new Date(e,11,31);let s=n.getFullYear()-r.getFullYear();const a=n.getMonth()-r.getMonth();return(a<0||0===a&&n.getDate()<r.getDate())&&(s-=1),s}resolveSustainedReferences(e,t,r){const n=e?.references??t?.references,s=e=>(e||[]).map(e=>"string"==typeof e?{medalId:e}:e).filter(e=>e&&e.medalId);if(Array.isArray(n)){const e=s(n);if(0===e.length)throw new Error("sustained_achievement.references must list at least one medalId");return e}if(n&&"object"==typeof n){const e=Array.isArray(n.when)?n.when:null;let t=null;if(e){const n=this.getAgeAtYear(r);for(const r of e){if(!r||"object"!=typeof r)continue;const e=r.if||{};let s=!0;if(e&&Object.prototype.hasOwnProperty.call(e,"age")){const t=e.age||{};null==n?s=!1:(null==t.gte||n>=t.gte||(s=!1),null==t.gt||n>t.gt||(s=!1),null==t.lte||n<=t.lte||(s=!1),null==t.lt||n<t.lt||(s=!1),null!=t.eq&&n!==t.eq&&(s=!1))}else s=!1;if(s){t=r.refs;break}}}if(!t&&n.otherwise&&(t=n.otherwise),t){const e=s(t);if(0===e.length)throw new Error("sustained_achievement.references rule must provide at least one medalId");return e}}else if(null!=n)throw new Error("Invalid sustained_achievement.references: expected array or object");return this.getSameTypePrereqMedalIds(t).map(e=>({medalId:e}))}checkSustainedReferenceRequirement(e,t,r,n={}){const s=n&&"number"==typeof n.endYear?n.endYear:null;if(null==s)return{type:"sustained_reference",index:t,isMet:!1,description:e.description,windowYear:null,reason:"end_year_required"};const a=this.resolveSustainedReferences(e,r,s);if(!Array.isArray(a)||0===a.length)throw new Error("sustained_reference.references must resolve to at least one medalId");const i=Number.isFinite(n.minStartYear)?{minStartYear:n.minStartYear}:{},l=a.every(e=>this.requirementsMetInYear(e.medalId,s,i));return{type:"sustained_reference",index:t,isMet:l,description:e.description,windowYear:l?s:null}}checkSustainedAchievementRequirement(e,t,r,n={}){const s=e.yearsOfAchievement??3,a=!0===this.profile?.features?.enforceCurrentYearForSustained,i=a?(new Date).getFullYear():n&&"number"==typeof n.endYear?n.endYear:(new Date).getFullYear();if(e&&e.perYear){const s=this.getEarliestCountingYearForMedal(r);let l=!0===e.mustIncludeCurrentYear;a&&(l=!0);let o=this.getAllAchievementYears();o.includes(i)||o.push(i),o=o.sort((e,t)=>e-t),"number"==typeof s&&(o=o.filter(e=>e>=s)),l&&(o=o.filter(e=>e<=i));const c=this.normalizeRequirementSpec(e.perYear),d="number"==typeof s?{minStartYear:s}:{},u=o.filter(e=>!!this.evaluateReqNode(c,r,{...n,endYear:e,...d}).isMet),m=new Set(u);let p,f,h=null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){let t=o;l&&o.includes(i)&&(t=[i]);let r=null,n=0;for(const s of t){let t=0;for(let r=s-e.timeWindowYears+1;r<=s;r++)m.has(r)&&t++;t>n&&(n=t,r=s)}p={current:n,required:e.yearsOfAchievement??1},f=n>=(e.yearsOfAchievement??1),h=f?r:null}else{const t=m.size;p={current:t,required:e.yearsOfAchievement??1},f=t>=(e.yearsOfAchievement??1),f&&l&&!m.has(i)&&(f=!1)}const g=f?h??i:i,b=this.evaluateReqNode(c,r,{...n,endYear:g,...d});return{type:"sustained_achievement",index:t,isMet:f,progress:p,description:e.description,windowYear:h,subtree:b,subtreeYear:g}}const l=this.resolveSustainedReferences(e,r,i),o=this.getEarliestCountingYearForMedal(r);let c,d,u=!0===e.mustIncludeCurrentYear||!0===r?.mustIncludeCurrentYear||l&&l.length>0;if(a&&(u=!0),l.length>0)c=this.getAllAchievementYears();else{const e=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type),t=this.groupBy(e,e=>e.year);c=Object.keys(t).map(e=>Number(e)).filter(e=>!Number.isNaN(e)).sort((e,t)=>e-t)}if("number"==typeof o&&(c=c.filter(e=>e>=o)),u&&(c=c.filter(e=>e<=i)),l.length>0){const e=e=>l.every(t=>this.requirementsMetInYear(t.medalId,e,"number"==typeof o?{minStartYear:o}:{}));d=new Set(c.filter(e))}else{const t=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type),r=this.groupBy(t,e=>e.year),n=e.minPointsPerYear??0,s=t=>(t||[]).some(t=>{const r=t.weaponGroup||"A",s=e.pointThresholds?.[r]?.min??n;return"number"==typeof t.points&&t.points>=s});d=new Set(c.filter(e=>s(r[e])))}let m,p,f=null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){let t=c;u&&c.includes(i)&&(t=[i]);let r=null,n=0;for(const s of t){let t=0;for(let r=s-e.timeWindowYears+1;r<=s;r++)d.has(r)&&t++;t>n&&(n=t,r=s)}m={current:n,required:s},p=n>=s,f=p?r:null}else{const e=d.size;m={current:e,required:s},p=e>=s,p&&u&&!d.has(i)&&(p=!1)}return{type:"sustained_achievement",index:t,isMet:p,progress:m,description:e.description,windowYear:f}}checkCustomCriterionRequirement(e,t,r={}){const n=r&&"number"==typeof r.endYear?r.endYear:null,s=te.get(e.name);if(!s)return{type:"custom_criterion",index:t,isMet:!1,description:e.description,reason:"unknown_custom_criterion"};try{const a=s({profile:this.profile,medalsDb:this.medals,endYear:n,minStartYear:Number.isFinite(r.minStartYear)?r.minStartYear:void 0,params:e.params??{}}),i=!(!a||!("object"==typeof a?a.isMet:a));return{type:"custom_criterion",index:t,isMet:i,description:e.description,windowYear:i&&null!=n?n:null}}catch(a){return{type:"custom_criterion",index:t,isMet:!1,description:e.description,error:a?.message}}}checkStandardMedalRequirement(e,t,r={}){let n=(this.profile.prerequisites||[]).filter(e=>"standard_medal"===e.type);e.disciplineType&&(n=n.filter(t=>t.disciplineType===e.disciplineType)),e.medalTier&&(n=n.filter(t=>t.medalType===e.medalTier));const s=r&&"number"==typeof r.endYear?r.endYear:null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){const t=null!=s?s:(new Date).getFullYear(),a=t-e.timeWindowYears+1,i=Math.max(a,Number.isFinite(r.minStartYear)?r.minStartYear:a);n=n.filter(e=>(e.year??0)>=i&&(e.year??0)<=t)}else null!=s&&(n=n.filter(e=>e.year===s));const a=e.minAchievements??1,i={current:n.length,required:a},l=i.current>=a;return{type:"standard_medal",index:t,isMet:l,progress:i,description:e.description,windowYear:l&&null!=s?s:null}}checkCumulativeCompetitionScoreRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"competition_result"===e.type),s=t=>{const r=e.disciplineType;return(t||[]).filter(e=>e.disciplineType===r)},a=t=>{let a=s(n);if(null!=t)if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){const n=t-e.timeWindowYears+1,s=Math.max(n,Number.isFinite(r.minStartYear)?r.minStartYear:n);a=a.filter(e=>(e.year??0)>=s&&(e.year??0)<=t)}else a=a.filter(e=>e.year===t);let i=[];return i="ppc"===e.disciplineType?a.filter(t=>{const r=t.ppcClass,n=e.pointThreshold?.[r]?.min;return"number"==typeof t.score&&"number"==typeof n&&t.score>=n}):a.filter(t=>{const r=t.weaponGroup||"A",n=e.pointThresholds?.[r]?.min;return"number"==typeof t.score&&"number"==typeof n&&t.score>=n}),i},i=r&&"number"==typeof r.endYear?r.endYear:null,l=e.minCompetitions??1;if(null!=i){const r=a(i),n=r.length>=l;return{type:"cumulative_competition_score",index:t,isMet:n,progress:{current:r.length,required:l},description:e.description,windowYear:n?i:null}}const o=Array.from(new Set(s(n).map(e=>e.year).filter(e=>"number"==typeof e))).sort((e,t)=>e-t);let c=null,d=0;for(const m of o){const e=a(m);e.length>d&&(d=e.length,c=m)}const u=d>=l;return{type:"cumulative_competition_score",index:t,isMet:u,progress:{current:d,required:l},description:e.description,windowYear:u?c:null}}evaluateAllMedals(){const e=this.medals.getAllMedals(),t={unlocked:[],eligible:[],available:[],locked:[]};return e.forEach(e=>{const r=this.evaluateMedal(e.id);t[r.status].push(r)}),t}getEligibleYears(e){if(this.hasUnlockedMedal(e))return[];const t=this.getAllAchievementYears().sort((e,t)=>t-e),r=[];for(const n of t)try{const t=this.evaluateMedal(e,{endYear:n});t&&"eligible"===t.status&&r.push(n)}catch{}return r}}function ne(){const e=t.useContext(P);if(e===D)throw new Error("useMedalDatabase must be used within MedalProvider");return e}function se(){const e=t.useContext(E);if(!e)throw new Error("useProfile must be used within ProfileProvider");return e}function ae(){const{medalDatabase:e}=ne(),{currentProfile:r}=se();return t.useMemo(()=>{if(!e)return null;return new re(e,r??{unlockedMedals:[],prerequisites:[]})},[e,r])}function ie(){const e=ae();return t.useMemo(()=>e?e.evaluateAllMedals():{unlocked:[],eligible:[],available:[],locked:[]},[e])}function le({children:e}){const t=ae(),n=ie();return r.jsx(ee.Provider,{value:{calculator:t,allStatuses:n},children:e})}const oe=t.createContext(null);function ce({children:e}){const[n,s]=t.useState([]),[a,i]=t.useState(-1),l=t.useCallback(e=>{s(t=>{const r=t.slice(0,a+1);r.push(e);const n=r.length>200?r.slice(r.length-200):r;return i(n.length-1),n})},[a]),o=t.useCallback(()=>{let e=null;return i(t=>{const r=t>0?t-1:t;return e=r!==t?r:null,r}),e},[]),c=t.useCallback(()=>{let e=null;return i(t=>{const r=t<n.length-1?t+1:t;return e=r!==t?r:null,r}),e},[n.length]),d=a>0,u=a>=0&&a<n.length-1,m=t.useMemo(()=>({pushState:l,undo:o,redo:c,canUndo:d,canRedo:u,history:n,historyIndex:a}),[l,o,c,d,u,n,a]);return r.jsx(oe.Provider,{value:m,children:e})}const de={achievementEntry:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"Registrering av prestationer är under utveckling. Gränssnitt och beteende kan ändras."},historyTimeline:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"Historiköversikten är under utveckling. Funktioner kan saknas."},enforceCurrentYearSetting:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"Inställningen är under utveckling.",overlay:"inline"},csvImport:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"CSV-import/export är under utveckling. Gränssnittet kan ändras och vissa funktioner saknas."}},ue=t.createContext(null);function me(e){try{localStorage.setItem("ff:overrides",JSON.stringify(e||{}))}catch{}}function pe({children:e}){const n=function(){const e="undefined"!=typeof window&&window.location&&window.location.hostname?window.location.hostname:"";return"localhost"===e||"127.0.0.1"===e?"development":"production"}(),[s,a]=t.useState(()=>"undefined"!=typeof window?function(){try{return JSON.parse(localStorage.getItem("ff:overrides")||"{}")}catch{return{}}}():{}),i=t.useContext(E),l=i?.currentProfile,o=i?.updateProfile,c=t.useMemo(()=>l?.features?.featureFlags||{},[l]),d=t.useMemo(()=>{const e="undefined"!=typeof window?function(){try{const e=new URLSearchParams(window.location.search).get("ff");return e?e.split(",").reduce((e,t)=>{const[r,n]=t.split(":");return r&&n&&(e[r.trim()]=n.trim()),e},{}):{}}catch{return{}}}():{},t={};for(const[r,s]of Object.entries(de||{})){const e=s?.default||"off",a=s?.env?.[n]??e;t[r]=a}for(const[r,n]of Object.entries(s||{}))t[r]=n;for(const[r,n]of Object.entries(c||{}))t[r]=n;for(const[r,n]of Object.entries(e||{}))t[r]=n;return t},[n,s,c]),u=e=>{const t={...s||{},...e||{}};a(t),me(t)},m={get:e=>d[e]||"off",enabled(e){const t=d[e]||"off";return"on"===t||"preview"===t},all:()=>({...d}),set(e,t){u({[e]:t})},setMany(e){u(e)},clear(e){const t={...s||{}};delete t[e],a(t),me(t)},clearAll(){a({}),me({})},async saveToProfile(e){if(!o||!l)return!1;const t={...l.features||{},featureFlags:{...e||{}}};return await o({...l,features:t}),!0},async clearProfileOverrides(){if(!o||!l)return!1;const e={...l.features||{}};return delete e.featureFlags,await o({...l,features:e}),!0}};return r.jsx(ue.Provider,{value:m,children:e})}const fe=t.createContext(null),he={version:"pr-132-af43b6f",number:"96",commit:"af43b6f",timeISO:"2026-01-07T14:17:18.339Z"},ge="app:onboardingTour:lastSeen",be="app:onboardingTour:manualStart",xe={medals:"v1","tree-view":"v1"};function ye(e="medals"){return`${e}-${xe[e]||"v1"}`}function ve(e=ye()){return function(){try{return localStorage.getItem(ge)}catch{return null}}()===e}function we(e){try{return sessionStorage.setItem(be,e),!0}catch{return!1}}const je={medals:[{id:"welcome",title:"Snabbguide",body:"Sök, filtrera och öppna detaljer för att se krav och status.",target:null},{id:"search",title:"Sök",body:"Skriv för att filtrera märken.",target:'[data-tour="medals-search"]'},{id:"chips",title:"Snabbfilter",body:"Tryck på en status för att filtrera snabbt.",target:'[data-tour="chip-unlocked"]'},{id:"filters",title:"Fler filter",body:"Öppna filterpanelen för fler val.",target:'[data-tour="open-filters"], [data-tour="filter-panel"]'},{id:"open",title:"Öppna ett märke",body:"Tryck på ett märke i listan för att se detaljer. Lämna guiden öppen och tryck sedan Nästa.",target:'[data-tour="medal-row-0"]',requiresTarget:!0,autoAdvanceToNextOn:'[data-tour="medal-detail-panel"]'},{id:"detail",title:"Detaljer",body:"När detaljvyn är öppen ser du krav, förhandskrav och status. Tryck Nästa för att avsluta.",target:'[data-tour="medal-detail-panel"]',requiresTarget:!0}],"tree-view":[{id:"welcome",title:"Välkommen till trädvyn",body:"Se alla märken i ett interaktivt träd med kopplingar och progression.",target:null},{id:"canvas",title:"Interaktiv canvas",body:"Dra för att panorera, nyp eller använd zoomknapparna för att zooma.",target:'[data-tour="tree-canvas"]'},{id:"zoom",title:"Zoomkontroller",body:"Använd dessa knappar för att zooma in, ut eller återställa vyn.",target:'[data-tour="zoom-controls"]'},{id:"legend",title:"Teckenförklaring",body:"Färgerna visar status: grönt för upplåsta, gult för uppnåeliga, grått för låsta.",target:'[data-tour="tree-legend"]'},{id:"actions",title:"Åtgärdsmeny",body:"Här hittar du fler alternativ: exportera, växla visualisering och öppna helskärm.",target:'[data-tour="tree-actions"]'},{id:"node",title:"Klicka på märken",body:"Tryck på ett märke i trädet för att se detaljer. Årsbrickor visar hur många år som krävs.",target:'[data-tour="tree-canvas"]'}]};function ke({children:e}){const[n,s]=t.useState(!1),[a,i]=t.useState(0),[l,o]=t.useState("medals"),c=ye(l),d=je[l]||je.medals,u=t.useCallback((e="medals")=>{o(e),i(0),s(!0)},[]),m=t.useCallback(()=>{s(!1)},[]),p=t.useCallback(()=>{!function(e){try{e&&localStorage.setItem(ge,e)}catch{}}(c),s(!1)},[c]),f=t.useCallback(()=>{i(e=>e>=d.length-1?e:e+1)},[d.length]),h=t.useCallback(()=>{i(e=>Math.max(0,e-1))},[]),g=t.useCallback((e="medals")=>!ve(ye(e)),[]),b=t.useMemo(()=>({open:n,stepIndex:a,steps:d,start:u,close:m,complete:p,next:f,back:h,canAutoStart:g,tourId:c,currentTourType:l}),[n,a,d,u,m,p,f,h,g,c,l]);return r.jsx(fe.Provider,{value:b,children:e})}function Ne({id:e,title:n,open:s,onClose:a,swipeToDismiss:i=!0,children:l}){const o=t.useRef(null),c=t.useRef(null);t.useEffect(()=>{if(!s)return;c.current=document.activeElement;const e=o.current,t=e=>{"Escape"===e.key&&(e.stopPropagation(),a?.())},r=t=>{if("Tab"!==t.key)return;if(!e)return;const r=e.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])'),n=Array.from(r).filter(e=>!e.hasAttribute("disabled")&&"true"!==e.getAttribute("aria-hidden"));if(0===n.length)return;const s=n[0],a=n[n.length-1];t.shiftKey&&document.activeElement===s?(t.preventDefault(),a.focus()):t.shiftKey||document.activeElement!==a||(t.preventDefault(),s.focus())};document.addEventListener("keydown",t),e?.addEventListener("keydown",r);const n=setTimeout(()=>e?.focus(),0);return()=>{document.removeEventListener("keydown",t),e?.removeEventListener("keydown",r),clearTimeout(n),c.current&&"function"==typeof c.current.focus&&c.current.focus()}},[s,a]);const d=function({onSwipe:e,threshold:r=50,allowedDirections:n=["left","right","up","down"]}={}){const s=t.useRef({x:0,y:0,t:0}),a=t.useRef({x:0,y:0,t:0});return{onTouchStart:e=>{if(!e.touches||0===e.touches.length)return;const t=e.touches[0];s.current={x:t.clientX,y:t.clientY,t:Date.now()},a.current={x:t.clientX,y:t.clientY,t:Date.now()}},onTouchMove:e=>{if(!e.touches||0===e.touches.length)return;const t=e.touches[0];a.current={x:t.clientX,y:t.clientY,t:Date.now()}},onTouchEnd:()=>{const t=a.current.x-s.current.x,i=a.current.y-s.current.y,l=Math.abs(t),o=Math.abs(i);let c=null;l>o?l>=r&&(c=t>0?"right":"left"):o>=r&&(c=i>0?"down":"up"),c&&n.includes(c)&&e?.(c)}}}({onSwipe:e=>{!i||"down"!==e&&"right"!==e||a?.()}});return s?r.jsxs("div",{"aria-hidden":!s,className:"fixed inset-0 z-[80]",children:[r.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>a?.(),"aria-hidden":!0}),r.jsxs("div",{id:e,role:"dialog","aria-modal":"true","aria-labelledby":e?`${e}-title`:void 0,ref:o,tabIndex:-1,className:"absolute left-0 right-0 bottom-0 bg-bg-secondary text-foreground rounded-t-2xl shadow-2xl border-t border-border focus:outline-none",style:{transform:"translateY(0)",transition:"undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches?"none":"transform 200ms ease",maxHeight:"85dvh",WebkitOverflowScrolling:"touch"},...d,children:[r.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[r.jsx("h2",{id:e?`${e}-title`:void 0,className:"text-lg font-semibold",children:n}),r.jsx("button",{type:"button",className:"btn btn-muted h-11 w-11 inline-flex items-center justify-center",onClick:()=>a?.(),"aria-label":"Close",children:"✕"})]}),r.jsx("div",{className:"p-4 pb-[calc(env(safe-area-inset-bottom)+1rem)] overflow-auto",style:{maxHeight:"calc(85dvh - 56px)",overflowY:"auto",overscrollBehavior:"contain"},children:l})]})]}):null}function Se({name:e,className:t="w-4 h-4",...a}){const i=n[e]||s;return r.jsx(i,{"aria-hidden":"true",focusable:"false",className:t,...a})}function Ce({backup:e,onRestore:n,onCancel:s}){const{metadata:i,validation:l}=t.useMemo(()=>{const t=e.exportedAt||e.profile?.lastModified||e.profile?.createdDate,r=e.version||"1.0",n=e.profile?.prerequisites?.length||0,s=e.profile?.unlockedMedals?.length||0,a=function(e){const t=[];return e&&"object"==typeof e?"profile-backup"!==e.kind?{status:"error",warnings:["Inte en giltig säkerhetskopia"],canImport:!1}:e.profile&&"object"==typeof e.profile?(e.exportedAt||t.push("Datum för säkerhetskopia saknas"),e.version||t.push("Formatversion saknas"),e.version&&"1.0"!==e.version&&t.push(`Okänd formatversion: ${e.version}`),e.profile.displayName||t.push("Profilnamn saknas"),e.profile.sex||t.push("Kön saknas i profilen"),0===t.length?{status:"valid",warnings:[],canImport:!0}:{status:"warning",warnings:t,canImport:!0}):{status:"error",warnings:["Profil saknas i säkerhetskopian"],canImport:!1}:{status:"error",warnings:["Ogiltig fil"],canImport:!1}}(e);return{metadata:{date:t,version:r,achievementCount:n,medalCount:s},validation:a}},[e]),o=r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 bg-black/50 z-[2000]",onClick:s,"aria-hidden":"true"}),r.jsxs("div",{role:"dialog","aria-modal":"true","aria-labelledby":"restore-preview-title",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"min(90vw, 32rem)",maxHeight:"90vh",overflow:"auto",zIndex:2001},className:"\n          bg-bg-primary\n          border-2 border-border\n          rounded-xl shadow-2xl\n          p-6\n        ",children:[r.jsx("h2",{id:"restore-preview-title",className:"text-2xl font-bold text-foreground mb-6",children:"Återställ från säkerhetskopia"}),r.jsxs("div",{className:"\n            mb-6 p-4 rounded-lg\n            bg-yellow-50 dark:bg-yellow-950\n            border-2 border-yellow-400 dark:border-yellow-600\n          ",role:"alert",children:[r.jsx("p",{className:"font-semibold text-yellow-800 dark:text-yellow-200 mb-1",children:"⚠️ Detta kommer att ersätta dina nuvarande data"}),r.jsx("p",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:"Se till att du har en säkerhetskopia av dina nuvarande framsteg innan du återställer."})]}),l.warnings.length>0&&r.jsxs("div",{className:"mb-6 p-4 rounded-lg bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800",role:"status","aria-live":"polite",children:[r.jsxs("div",{className:"flex items-start gap-2 mb-2",children:[r.jsx(Se,{name:"AlertTriangle",className:"w-5 h-5 shrink-0 text-blue-600 dark:text-blue-400 mt-0.5","aria-hidden":"true"}),r.jsx("h3",{className:"font-semibold text-blue-800 dark:text-blue-200",children:"Varningar vid import"})]}),r.jsx("ul",{className:"text-sm text-blue-700 dark:text-blue-300 space-y-1 ml-7",children:l.warnings.map((e,t)=>r.jsxs("li",{children:["• ",e]},t))}),r.jsx("p",{className:"text-sm text-blue-700 dark:text-blue-300 mt-3 ml-7",children:"Du kan fortfarande importera säkerhetskopian."})]}),r.jsxs("div",{className:"mb-6 space-y-3",children:[r.jsx("h3",{className:"font-semibold text-foreground mb-3",children:"Information om säkerhetskopia"}),r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Skapad"}),r.jsx("p",{className:"font-semibold text-foreground",children:i.date?new Date(i.date).toLocaleDateString("sv-SE",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Okänt datum"})]}),r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Format"}),r.jsxs("p",{className:"font-semibold text-foreground",children:["v",i.version]})]}),r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Aktiviteter"}),r.jsx("p",{className:"font-semibold text-foreground",children:i.achievementCount})]}),r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Upplåsta märken"}),r.jsx("p",{className:"font-semibold text-foreground",children:i.medalCount})]})]})]}),r.jsxs("div",{className:"flex gap-3",children:[r.jsx("button",{onClick:s,className:"\n              flex-1 py-3 rounded-lg font-medium\n              bg-bg-secondary text-foreground\n              border-2 border-border\n              hover:bg-bg-tertiary\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-border\n            ",children:"Avbryt"}),r.jsx("button",{onClick:n,className:"\n              flex-1 py-3 rounded-lg font-medium\n              bg-primary text-primary-foreground\n              hover:bg-primary/90\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-primary\n            ",children:"Återställ nu"})]})]})]});return a.createPortal(o,document.body)}function Me({id:e="profile-import-dialog",open:n,onClose:s}){const{restoreProfileFromBackup:a}=se(),[i,l]=t.useState(""),[o,c]=t.useState("new-id"),[d,u]=t.useState(null),[m,p]=t.useState(!1),[f,h]=t.useState(!1),[g,b]=t.useState(null),[x,y]=t.useState(null),[v,w]=t.useState(!1),[j,k]=t.useState(null),N=t.useRef(null);if(t.useEffect(()=>{if(!i.trim())return void y(null);const e=function(e){if(!e||!e.trim())return{status:"error",message:"Ingen data angiven"};try{const t=JSON.parse(e);return t&&"object"==typeof t?"profile-backup"!==t.kind?{status:"error",message:"Inte en säkerhetskopia"}:t.profile?t.exportedAt&&t.version&&t.profile.displayName?{status:"valid",message:"Giltig säkerhetskopia"}:{status:"warning",message:"Säkerhetskopia kan importeras med varningar"}:{status:"error",message:"Profil saknas"}:{status:"error",message:"Ogiltig JSON-struktur"}}catch{return{status:"error",message:"Ogiltig JSON"}}}(i);y(e)},[i]),t.useEffect(()=>{n||(k(null),l(""),y(null),w(!1))},[n]),!n)return null;return r.jsxs("div",{className:"fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4",children:[r.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":`${e}-title`,id:e,className:"w-[min(92vw,32rem)] max-h-[85vh] overflow-auto rounded-xl bg-bg-secondary border border-border shadow-2xl",children:r.jsxs("form",{onSubmit:async e=>{e.preventDefault();try{if(p(!0),u(null),!i.trim())return u("Klistra in JSON eller välj en fil."),void p(!1);const e=q(i);b(e),h(!0),p(!1)}catch(t){u(t.message||"Kunde inte läsa säkerhetskopian"),p(!1)}},className:"p-6 space-y-5",children:[r.jsx("h2",{id:`${e}-title`,className:"text-2xl font-bold text-text-primary",children:"Importera profil (säkerhetskopia)"}),d&&r.jsx("div",{className:"alert alert-error",role:"alert","aria-live":"assertive",children:d}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",children:"Välj säkerhetskopia"}),r.jsx("p",{id:`${e}-file-hint`,className:"text-xs text-muted-foreground",children:"Endast JSON-filer (.json) accepteras"}),r.jsx("input",{ref:N,id:`${e}-file`,type:"file",accept:".json,application/json",onChange:e=>{const t=e.target.files?.[0];if(!t)return;k(t.name);const r=new FileReader;r.onload=()=>l(String(r.result||"")),r.readAsText(t)},className:"sr-only",disabled:m,"aria-describedby":`${e}-file-hint`}),r.jsxs("button",{type:"button",onClick:()=>{N.current?.click()},disabled:m,"aria-describedby":`${e}-file-hint`,className:"\n                w-full min-h-[44px] px-4 py-2\n                bg-bg-secondary border-2 border-border rounded-lg\n                hover:bg-bg-tertiary hover:border-primary\n                focus-visible:outline-none focus-visible:ring-2\n                focus-visible:ring-primary focus-visible:ring-offset-2\n                transition-colors\n                flex items-center gap-3\n                disabled:opacity-50 disabled:cursor-not-allowed\n              ",children:[r.jsx(Se,{name:"Upload",className:"w-5 h-5 text-muted-foreground","aria-hidden":"true"}),r.jsx("span",{className:"flex-1 text-left text-sm",children:j||"Välj fil att återställa från..."}),j&&r.jsx(Se,{name:"CheckCircle",className:"w-5 h-5 text-green-600 dark:text-green-400","aria-hidden":"true"})]})]}),r.jsxs("button",{type:"button",onClick:()=>w(!v),className:"text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 transition-colors",disabled:m,children:[r.jsx(Se,{name:v?"ChevronDown":"ChevronRight",className:"w-4 h-4","aria-hidden":"true"}),r.jsx("span",{children:v?"Dölj avancerade alternativ":"Visa avancerade alternativ"})]}),v&&r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",htmlFor:`${e}-textarea`,children:"Klistra in JSON"}),r.jsx("textarea",{id:`${e}-textarea`,value:i,onChange:e=>l(e.target.value),className:"textarea min-h-[8rem]",placeholder:"Klistra in JSON-innehållet från din säkerhetskopia här...",disabled:m,"aria-describedby":x?`${e}-validation-status`:void 0}),x&&r.jsxs("div",{id:`${e}-validation-status`,role:"status","aria-live":"polite",className:`\n                  flex items-start gap-2 p-3 rounded-lg text-sm\n                  ${"valid"===x.status?"bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800":""}\n                  ${"warning"===x.status?"bg-yellow-50 dark:bg-yellow-950 border border-yellow-200 dark:border-yellow-800":""}\n                  ${"error"===x.status?"bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-800":""}\n                `,children:[r.jsx(Se,{name:"valid"===x.status?"CheckCircle":"warning"===x.status?"AlertTriangle":"XCircle",className:`\n                    w-5 h-5 shrink-0 mt-0.5\n                    ${"valid"===x.status?"text-green-600 dark:text-green-400":""}\n                    ${"warning"===x.status?"text-yellow-600 dark:text-yellow-400":""}\n                    ${"error"===x.status?"text-red-600 dark:text-red-400":""}\n                  `,"aria-hidden":"true"}),r.jsx("span",{className:`\n                    ${"valid"===x.status?"text-green-800 dark:text-green-200":""}\n                    ${"warning"===x.status?"text-yellow-800 dark:text-yellow-200":""}\n                    ${"error"===x.status?"text-red-800 dark:text-red-200":""}\n                  `,children:x.message})]})]}),r.jsxs("fieldset",{className:"space-y-2",children:[r.jsx("legend",{className:"block text-sm font-medium text-text-secondary",children:"Metod"}),r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsxs("label",{className:"inline-flex items-center gap-2",children:[r.jsx("input",{type:"radio",name:`${e}-strategy`,value:"new-id",checked:"new-id"===o,onChange:()=>c("new-id"),disabled:m}),r.jsx("span",{children:"Skapa ny profil"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2",children:[r.jsx("input",{type:"radio",name:`${e}-strategy`,value:"overwrite",checked:"overwrite"===o,onChange:()=>c("overwrite"),disabled:m}),r.jsx("span",{children:"Ersätt profil med samma ID"})]})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3 pt-2",children:[r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px] disabled:opacity-50 order-1 sm:order-2",disabled:m||!i.trim()||"error"===x?.status,"aria-describedby":"error"===x?.status?`${e}-validation-status`:void 0,children:"Förhandsgranska"}),r.jsx("button",{type:"button",onClick:s,className:"btn btn-secondary min-h-[44px] order-2 sm:order-1",disabled:m,children:"Avbryt"})]})]})}),f&&g&&r.jsx(Ce,{backup:g,onRestore:async()=>{try{p(!0),u(null),await a(i,{strategy:o}),l(""),h(!1),b(null),s?.()}catch(e){u(e.message||"Import misslyckades"),h(!1)}finally{p(!1)}},onCancel:()=>{h(!1),b(null)}})]})}function Ae({mode:e="picker",open:n=!1,onClose:s,id:a="profile-picker",forceCreate:i=!1,convertGuest:l=!1}){const{profiles:o,currentProfile:c,loading:d,createProfile:u,updateProfile:m,selectProfile:p,deleteProfile:f,convertGuestToSaved:h,startExplorerMode:g}=se(),[b,x]=t.useState(!1),[y,v]=t.useState("create"),[w,j]=t.useState(null),[k,N]=t.useState(""),[S,C]=t.useState(""),[M,A]=t.useState(""),[I,D]=t.useState(!1),P="picker"===e,T=P&&n&&i,E=T?"create":y,_=T?null:w,F=async e=>{if(confirm("Är du säker? Det går inte att ångra."))try{await f(e)}catch(t){console.error("Misslyckades ta bort profil:",t)}},$=e=>{if(!e)return null;const t=new Date(e);if(Number.isNaN(t.getTime()))return null;const r=new Date;let n=r.getFullYear()-t.getFullYear();const s=r.getMonth()-t.getMonth();return(s<0||0===s&&r.getDate()<t.getDate())&&n--,n},q=e=>"female"===e?"Kvinna":"male"===e?"Man":"—";return r.jsxs(r.Fragment,{children:[P?r.jsxs(Ne,{id:a,title:"Välj profil",open:n,onClose:s,children:[o.length>0?r.jsx("div",{className:"space-y-2",children:o.map(e=>r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{onClick:()=>{p(e.userId),s?.()},className:"btn btn-muted flex-1 justify-start text-left",children:[e.displayName," (Ålder ",$(e.dateOfBirth)??"—"," • ",q(e.sex),")"]}),r.jsx("button",{onClick:()=>{v("edit"),j(e),N(e.displayName||""),C(e.dateOfBirth||""),A(e.sex||""),x(!0)},className:"btn btn-secondary",children:"Ändra"}),r.jsx("button",{onClick:()=>F(e.userId),className:"btn btn-danger",children:"Ta bort"})]},e.userId))}):r.jsx("p",{className:"text-text-secondary",children:"Inga profiler ännu."}),r.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[r.jsx("button",{onClick:()=>{v("create"),j(null),N(""),C(""),A(""),x(!0)},className:"btn btn-primary min-h-[44px]",children:"Skapa ny profil"}),r.jsx("button",{onClick:()=>D(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Importera profil"}),r.jsx("button",{onClick:()=>{v("guest"),j(null),N("Gästläge"),C("1975-01-02"),A(""),x(!0)},className:"btn btn-muted min-h-[44px]",children:"Fortsätt i gästläge"})]})]}):r.jsx("div",{children:c?r.jsxs("div",{className:"bg-bg-secondary border border-border ring-1 ring-primary/20 rounded-lg p-4 mb-4",children:[r.jsxs("p",{className:"text-text-primary font-semibold",children:["Profile: ",c.displayName]}),r.jsxs("p",{className:"text-text-secondary text-sm",children:["Ålder: ",$(c.dateOfBirth)??"—"]}),r.jsxs("p",{className:"text-text-secondary text-sm",children:["Kön: ",q(c.sex)]})]}):r.jsxs("div",{className:"bg-bg-secondary border border-border rounded-lg p-4 mb-4",children:[r.jsx("p",{className:"text-text-primary mb-3",children:"No profile selected"}),o.length>0&&r.jsx("div",{className:"space-y-2 mb-3",children:o.map(e=>r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{onClick:()=>p(e.userId),className:"btn btn-muted flex-1 justify-start text-left",children:[e.displayName," (Age ",$(e.dateOfBirth)??"—"," • ",q(e.sex),")"]}),r.jsx("button",{onClick:()=>{v("edit"),j(e),N(e.displayName||""),C(e.dateOfBirth||""),A(e.sex||""),x(!0)},className:"btn btn-secondary",children:"Ändra"}),r.jsx("button",{onClick:()=>F(e.userId),className:"btn btn-danger",children:"Ta bort"})]},e.userId))}),r.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[r.jsx("button",{onClick:()=>{v("create"),j(null),N(""),C(""),A(""),x(!0)},className:"btn btn-primary min-h-[44px]",children:"Skapa ny profil"}),r.jsx("button",{onClick:()=>D(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Importera profil"})]})]})}),r.jsx(Me,{id:"profile-import-dialog",open:I,onClose:()=>D(!1)}),(T||b)&&r.jsx("div",{className:"fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4",children:r.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":"create-profile-title",className:"w-[min(92vw,32rem)] max-h-[85vh] overflow-auto rounded-xl bg-bg-secondary border border-border shadow-2xl",children:r.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),k.trim()&&S&&M)try{"edit"===E&&_?await m({...w,displayName:k.trim(),dateOfBirth:S,sex:M}):l&&c?.isGuest?await h(k.trim(),S,M):await u(k.trim(),S,M),N(""),C(""),A(""),j(null),x(!1),s?.()}catch(t){console.error("Misslyckades spara profil:",t)}},className:"p-6 space-y-5",children:[r.jsx("h2",{id:"create-profile-title",className:"text-2xl font-bold text-text-primary",children:"edit"===E?"Ändra profil":"guest"===y?"Gästläge":"Skapa ny profil"}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",children:"Profile Name"}),r.jsx("input",{type:"text",value:k,onChange:e=>N(e.target.value),className:"input",placeholder:"Ditt namn",disabled:d||"guest"===y,required:!0})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",children:"Födelsedatum"}),r.jsx("input",{type:"date",value:S,onChange:e=>C(e.target.value),className:"input",disabled:d||"guest"===y,required:!0}),r.jsx("p",{className:"text-xs text-text-secondary",children:"Används för att beräkna åldersberoende krav enligt regelboken."})]}),r.jsxs("fieldset",{className:"space-y-2",children:[r.jsxs("legend",{className:"block text-sm font-medium text-text-secondary",children:["Kön (enligt regelboken) ",r.jsx("span",{"aria-hidden":"true",children:"*"})]}),r.jsx("p",{className:"text-xs text-text-secondary",children:"Används endast för att beräkna medaljkrav enligt regelboken."}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[r.jsxs("label",{className:"btn btn-muted justify-start text-left min-h-[44px]",children:[r.jsx("input",{type:"radio",name:"sex",value:"female",checked:"female"===M,onChange:e=>A(e.target.value),disabled:d,className:"mr-2",required:!0}),"Kvinna"]}),r.jsxs("label",{className:"btn btn-muted justify-start text-left min-h-[44px]",children:[r.jsx("input",{type:"radio",name:"sex",value:"male",checked:"male"===M,onChange:e=>A(e.target.value),disabled:d,className:"mr-2",required:!0}),"Man"]})]})]}),r.jsxs("div",{className:"flex items-center justify-end gap-3 pt-2",children:[r.jsx("button",{type:"submit",className:"btn btn-primary disabled:opacity-50",disabled:d||!M,children:"edit"===E?"Spara":"guest"===y?"Starta gästläge":l&&c?.isGuest?"Spara framsteg":"Skapa"}),r.jsx("button",{type:"button",onClick:()=>{x(!1),T&&s?.()},className:"btn btn-secondary",disabled:d,children:"Avbryt"})]}),"guest"===y&&r.jsx("div",{className:"pt-2",children:r.jsx("button",{type:"button",className:"btn btn-primary w-full min-h-[44px]",disabled:d||!M,onClick:async()=>{if(M)try{await g(M),x(!1),s?.()}catch(e){console.error(e)}},children:"Starta gästläge"})})]})})})]})}function Ie(){const e=t.useContext(fe);if(!e)throw new Error("useOnboardingTour must be used within OnboardingTourProvider");return e}const De=[{path:"/skill-tree",label:"Märkesträd"},{path:"/medals",label:"Alla märken"},{path:"/data",label:"Data"},{path:"/settings",label:"Inställningar"},{path:"/about",label:"Om"}];function Pe(){const e=i(),n=l(),[s,a]=t.useState(null),c=s===e.pathname,{currentProfile:d}=se(),[u,m]=t.useState(!1),[p,f]=t.useState(!1),h=Ie(),g=d?.displayName?d.displayName.trim().split(/\s+/).map(e=>e[0]).slice(0,2).join("").toUpperCase():null;t.useEffect(()=>{if(!c)return;const e=e=>{"Escape"===e.key&&a(null)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[c]);const b=()=>{"/medals"===e.pathname?(f(!1),a(null),m(!1),h.start()):f(!0)};return r.jsxs("header",{className:"bg-surface border-b border-border sticky top-0 z-50",children:[r.jsx("div",{className:"max-w-6xl mx-auto px-4",children:r.jsxs("div",{className:"py-2",children:[r.jsx("a",{href:"#main",className:"absolute -top-10 left-2 focus:top-2 focus:left-2 focus:z-[60] btn btn-primary",children:"Hoppa till innehåll"}),r.jsxs("div",{className:"flex items-center justify-between gap-2",children:[r.jsxs(o,{to:"/",onClick:()=>{a(null),m(!1),f(!1)},className:"inline-flex items-center gap-2 text-2xl font-bold leading-tight break-words text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsx(Se,{name:"Award",className:"w-6 h-6 shrink-0"}),r.jsx("span",{children:"Skyttemärken"})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("button",{type:"button",onClick:b,className:"hidden sm:inline-flex items-center justify-center min-h-[44px] px-3 rounded-md btn btn-muted","aria-haspopup":"dialog","aria-controls":"guide-prompt",children:"Guide"}),r.jsx("button",{type:"button",onClick:()=>m(!0),className:"inline-flex items-center justify-center h-10 w-10 sm:h-11 sm:w-11 rounded-full btn btn-muted","aria-haspopup":"dialog","aria-controls":"profile-picker","aria-label":d?.displayName?`Aktiv profil: ${d.displayName}`:"Välj profil",title:d?.displayName||"Välj profil",children:g||"?"}),r.jsx("nav",{"aria-label":"Primary",className:"hidden sm:block",children:r.jsx("ul",{className:"flex gap-2",children:De.map(t=>{const n=e.pathname===t.path;return r.jsx("li",{children:r.jsx(o,{to:t.path,onClick:()=>m(!1),className:"inline-flex items-center min-h-[44px] px-4 py-2 rounded transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary "+(n?"bg-primary text-primary-foreground":"text-muted-foreground hover:bg-surface"),"aria-current":n?"page":void 0,children:t.label})},t.path)})})}),r.jsx("button",{type:"button",onClick:()=>a(t=>t===e.pathname?null:e.pathname),className:"sm:hidden inline-flex items-center justify-center h-11 w-11 rounded-md btn btn-muted","aria-label":"Växla meny","aria-controls":"mobile-primary-nav","aria-expanded":c?"true":"false",children:r.jsx(Se,{name:"Menu",size:20,className:"shrink-0"})})]})]}),r.jsx("nav",{id:"mobile-primary-nav","aria-label":"Primary",className:(c?"mt-2":"hidden")+" sm:hidden",children:r.jsxs("ul",{className:"grid grid-cols-2 gap-2",children:[r.jsx("li",{className:"col-span-2",children:r.jsx("button",{type:"button",onClick:b,className:"w-full inline-flex items-center justify-center min-h-[44px] px-4 py-2 rounded transition-colors btn btn-muted","aria-haspopup":"dialog","aria-controls":"guide-prompt",children:"Guide"})}),De.map(t=>{const n=e.pathname===t.path;return r.jsx("li",{children:r.jsx(o,{to:t.path,onClick:()=>{a(null),m(!1),f(!1)},className:"inline-flex items-center min-h-[44px] px-4 py-2 rounded transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary "+(n?"bg-primary text-primary-foreground":"text-muted-foreground hover:bg-surface"),"aria-current":n?"page":void 0,children:t.label})},t.path)})]})})]})}),r.jsx(Ae,{id:"profile-picker",mode:"picker",open:u,onClose:()=>m(!1)}),p&&r.jsx("div",{id:"guide-prompt",role:"dialog","aria-modal":"true","aria-labelledby":"guide-prompt-title",className:"fixed inset-0 z-[60] bg-black/50 flex items-end sm:items-center justify-center p-4",onMouseDown:e=>{e.target===e.currentTarget&&f(!1)},children:r.jsxs("div",{className:"card w-full sm:w-[min(520px,90vw)] rounded-t-2xl sm:rounded-xl p-4 sm:p-6",children:[r.jsx("h2",{id:"guide-prompt-title",className:"text-lg font-semibold text-foreground",children:"Starta guide"}),r.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Den här guiden finns i Märkeslistan."}),r.jsxs("div",{className:"mt-4 flex flex-col sm:flex-row gap-2 sm:justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>f(!1),children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:()=>{try{sessionStorage.setItem("app:onboardingTour:manualStart","medals")}catch{}f(!1),a(null),m(!1),n("/medals")},children:"Öppna Märkeslista"})]})]})})]})}const Te="https://www.pistolskytteforbundet.se/",Ee="https://github.com/mandakan/spsf-medal-explorer",_e="https://buymeacoffee.com/thias",Fe="https://www.pistolskytteforbundet.se/om-pistolskytte/regler/skjuthandboken-och-sakb/",$e="Skyttemärken",qe="Mathias A",Le="MIT",Ye={2024:20};function Re(e){const t=Object.entries(Ye).map(([e,t])=>[Number(e),t]).sort((e,t)=>e[0]-t[0]);let r=t[0]?.[1]??null;for(const[n,s]of t)e>=n&&(r=s);return r}const Oe=Re((new Date).getFullYear());function Ue({className:e="w-5 h-5",...t}){return r.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:e,...t,children:r.jsx("path",{fill:"currentColor",d:"M12 .5a12 12 0 0 0-3.79 23.4c.6.11.82-.26.82-.58v-2.03c-3.34.73-4.04-1.61-4.04-1.61-.55-1.41-1.35-1.79-1.35-1.79-1.1-.75.08-.73.08-.73 1.22.09 1.86 1.25 1.86 1.25 1.08 1.85 2.83 1.31 3.52 1 .11-.79.42-1.31.76-1.61-2.66-.3-5.46-1.33-5.46-5.93 0-1.31.47-2.38 1.24-3.22-.13-.3-.54-1.52.12-3.17 0 0 1.01-.32 3.3 1.23.96-.27 1.98-.4 3-.4s2.04.13 3 .4c2.29-1.55 3.3-1.23 3.3-1.23.66 1.65.25 2.87.12 3.17.77.84 1.24 1.91 1.24 3.22 0 4.61-2.8 5.62-5.47 5.92.43.37.82 1.1.82 2.22v3.29c0 .32.22.69.83.58A12 12 0 0 0 12 .5Z"})})}function Be({className:e="w-5 h-5",...t}){return r.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:e,...t,children:r.jsx("path",{fill:"currentColor",d:"M3 7h13a3 3 0 0 1 3 3v1a4 4 0 0 1-3 3.87V16a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V7Zm16 3a1 1 0 0 0-1-1h-1v3.82A2 2 0 0 0 19 11v-1ZM5 18a2 2 0 0 0 2 2h5a2 2 0 0 0 2-2V9H5v9ZM10 2a1 1 0 0 1 1 1c0 .83-.5 1.25-.8 1.5-.2.17-.2.17-.2.5a1 1 0 0 1-2 0c0-1 .5-1.5.8-1.75.2-.17.2-.17.2-.5a1 1 0 0 1 1-1Zm4 0a1 1 0 0 1 1 1c0 .83-.5 1.25-.8 1.5-.2.17-.2.17-.2.5a1 1 0 0 1-2 0c0-1 .5-1.5.8-1.75.2-.17.2-.17.2-.5a1 1 0 0 1 1-1Z"})})}function Ge(){const e=(new Date).getFullYear(),t=qe,n=Le,s=Ee,a=_e,i=`${"undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/"}LICENSE`;return r.jsx("footer",{role:"contentinfo",className:"w-full border-t border-border bg-bg-primary",children:r.jsx("div",{className:"max-w-6xl mx-auto px-4 py-6",children:r.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-4",children:[r.jsxs("p",{className:"text-sm text-text-secondary text-center md:text-left",children:["© ",e," ",t," •"," ",r.jsxs("a",{href:i,target:"_blank",rel:"noopener noreferrer",className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary",children:["Licensierad under ",n]})]}),r.jsxs("nav",{className:"flex items-center gap-2","aria-label":"Sidfotslänkar",children:[r.jsxs("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm min-h-[44px] text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary","aria-label":"Öppna GitHub-repositoriet",children:[r.jsx(Ue,{}),r.jsx("span",{children:"Källkod"})]}),r.jsxs("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm min-h-[44px] text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary","aria-label":"Köp mig en kaffe",children:[r.jsx(Be,{}),r.jsx("span",{children:"Köp en kaffe till mig"})]})]})]})})})}function Ve(){const e=t.useContext(J);if(!e)throw new Error("useBackup must be used within BackupProvider");return e}function ze(e=new Date){try{return new Date(e).toISOString()}catch{return(new Date).toISOString()}}function Ke(e){return e?Array.isArray(e)?e:[e]:[]}async function He(e,{version:t="1.0"}={}){const r={kind:"profile-backup",version:t,exportedAt:ze(),profile:{userId:e?.userId||"",displayName:e?.displayName||"",createdDate:e?.createdDate||ze(),lastModified:e?.lastModified||ze(),dateOfBirth:e?.dateOfBirth||"",sex:e?.sex||"",unlockedMedals:Ke(e?.unlockedMedals),prerequisites:Ke(e?.prerequisites),features:{allowManualUnlock:!!e?.features?.allowManualUnlock,enforceCurrentYearForSustained:!!e?.features?.enforceCurrentYearForSustained},notifications:!!e?.notifications}};return JSON.stringify(r,null,2)}function We(){const{shouldShowReminder:e,dismissReminder:n,markBackupCreated:s}=Ve(),{currentProfile:a}=se(),[i,l]=t.useState(!1);if(!e||!a)return null;return r.jsx("div",{role:"status","aria-live":"polite",className:"sticky top-0 z-[2000] bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-950 dark:to-orange-950 border-b-2 border-yellow-400 dark:border-yellow-600 px-4 py-3 shadow-sm",children:r.jsxs("div",{className:"max-w-6xl mx-auto flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4",children:[r.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[r.jsx(Se,{name:"AlertTriangle",className:"w-6 h-6 text-yellow-600 dark:text-yellow-400 shrink-0","aria-hidden":"true"}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("p",{className:"font-semibold text-color-text-primary",children:"Dags att säkerhetskopiera dina uppgifter"}),r.jsx("p",{className:"text-sm text-color-text-secondary mt-0.5",children:"Din data finns bara på den här enheten. Säkerhetskopiera regelbundet för att vara säker."})]})]}),r.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto sm:shrink-0",children:[r.jsxs("button",{onClick:async()=>{try{l(!0);const e=(new Date).toISOString().split("T")[0],t=await He(a,{version:"1.0"});!function(e,t,r="application/octet-stream"){if("undefined"==typeof window||"undefined"==typeof document)return;let n;if(e instanceof Blob)n=e;else if(e instanceof Uint8Array)n=new Blob([e],{type:r});else if("string"==typeof e)n=new Blob([e],{type:r+";charset=utf-8"});else{if(null==e)throw new Error("downloadFile: invalid data");n=new Blob([JSON.stringify(e,null,2)],{type:"application/json;charset=utf-8"})}const s=URL.createObjectURL(n),a=document.createElement("a");a.href=s,a.download=t,a.rel="noopener",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}(t,`medal-backup-${e}.json`,"application/json"),await s().catch(e=>{console.error("Failed to mark backup as created:",e)})}catch(e){console.error("Backup error:",e)}finally{l(!1)}},disabled:i,className:"btn btn-primary flex-1 sm:flex-none min-h-[44px] px-4 py-2",children:[r.jsx(Se,{name:"Download",className:"w-4 h-4","aria-hidden":"true"}),i?"Säkerhetskopierar...":"Säkerhetskopiera nu"]}),r.jsx("button",{onClick:async()=>{await n()},"aria-label":"Påminn mig om 7 dagar",className:"btn btn-secondary min-h-[44px] px-4 py-2",children:"Senare"})]})]})})}function Xe(){return r.jsxs("div",{className:"min-h-screen bg-bg-primary",children:[r.jsx(We,{}),r.jsx(Pe,{}),r.jsx("div",{className:"max-w-6xl mx-auto px-4 py-8",children:r.jsx("main",{id:"main",children:r.jsx(c,{})})}),r.jsx(Ge,{})]})}function Je({id:e="disclaimer-global",variant:n="info",text:s="OBS: Fristående app; ej godkänd av Svenska Pistolskytteförbundet. Vid skillnader gäller alltid senaste officiella regelbok.",linkUrl:a,linkLabel:i,dismissible:l=!0,className:o="",year:c=(new Date).getFullYear()}){const d=t.useMemo(()=>Re(c),[c]),u=t.useMemo(()=>i??(d?`Läs regelboken (v${d})`:"Läs regelboken"),[i,d]),m=t.useMemo(()=>`dismiss:${e}${d?`@${d}`:""}`,[e,d]),[p,f]=t.useState(!1);t.useEffect(()=>{f("1"===localStorage.getItem(m))},[m]);if(p)return null;const h="warning"===n?"border-review text-foreground":"border-border text-muted-foreground";return r.jsxs("div",{role:"status","aria-live":"polite",className:["relative flex items-center gap-2 rounded-md border px-3 py-2 text-sm bg-bg-secondary min-h-11",h,o].filter(Boolean).join(" "),children:[r.jsx("span",{"aria-hidden":"true",className:"warning"===n?"inline-block w-2 h-2 rounded-full bg-review":"inline-block w-2 h-2 rounded-full bg-primary opacity-60"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("span",{children:s}),a?r.jsx("a",{className:"underline underline-offset-2 ml-2 hover:opacity-80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded-sm",href:a,target:"_blank",rel:"noopener noreferrer","aria-label":"Öppna officiell regelbok i ny flik",children:u}):null]}),l?r.jsx("button",{type:"button",onClick:()=>{f(!0),localStorage.setItem(m,"1")},className:"ml-2 inline-flex items-center justify-center rounded h-11 w-11 md:h-6 md:w-6 hover:bg-bg-secondary/70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary","aria-label":"Stäng meddelande",children:r.jsx("span",{"aria-hidden":"true",children:"×"})}):null]})}function Ze(){const{medalDatabase:e,loading:n}=ne(),s=t.useCallback(()=>{we("medals")},[]),a=t.useCallback(()=>{we("tree-view")},[]);return r.jsxs("div",{className:"space-y-8",children:[r.jsxs("section",{className:"text-center mb-12",children:[r.jsx("h1",{className:"text-4xl font-bold text-foreground mb-4",children:"Skyttemärken"}),r.jsx("p",{className:"text-lg text-muted-foreground",children:"Dokumentera dina skyttemärken och medaljer med aktiviteter, utforska framtida märken och planera progression"}),r.jsxs("div",{className:"mt-6 flex justify-center gap-3 flex-wrap",children:[r.jsx(o,{to:"/medals",onClick:s,className:"btn btn-secondary min-h-[44px] inline-flex items-center justify-center",children:"Visa märkeslista-guide"}),r.jsx(o,{to:"/skill-tree",onClick:a,className:"btn btn-secondary min-h-[44px] inline-flex items-center justify-center",children:"Visa trädvy-guide"})]})]}),r.jsx(Je,{id:"disclaimer-home",variant:"info",linkUrl:Fe}),r.jsxs("section",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[r.jsxs(o,{to:"/skill-tree",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(Se,{name:"Target",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Märken"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Utforska märken i ett interaktivt träd"})]}),r.jsxs(o,{to:"/medals",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(Se,{name:"List",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Märkeslista"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Översikt över alla märken med filter och sökning"})]}),r.jsxs(o,{to:"/settings",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(Se,{name:"Settings",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Inställningar"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Hantera din profil"})]})]}),!n&&e&&r.jsxs("section",{className:"card p-6 shadow",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:"Status"}),r.jsxs("p",{className:"text-muted-foreground",children:[r.jsx(Se,{name:"CheckCircle",className:"inline w-4 h-4 align-text-bottom mr-1 text-muted-foreground"}),e.getAllMedals().length," märken laddade"]}),r.jsxs("p",{className:"mt-2 text-muted-foreground",children:["Version: ",r.jsx("code",{children:he.version})," • Build: ",r.jsx("code",{children:he.number})," • Commit: ",r.jsx("code",{children:he.commit})]})]})]})}function Qe(e=1,r=.5,n=3,s={}){const[a,i]=t.useState(0),[l,o]=t.useState(0),[c,d]=t.useState(e),{getBounds:u=null,overscrollPx:m=48,contentPaddingPx:p={left:0,top:0,right:0,bottom:0}}=s,f=t.useRef(null),h=t.useRef(new Map),g=t.useRef({initialDistance:0,initialScale:e,lastCenter:null}),b=t.useRef({vx:0,vy:0,lastT:0,raf:0}),x=t.useRef({x:0,y:0,t:0}),y=t.useCallback(()=>{if("undefined"==typeof window||!window.matchMedia)return!1;try{return window.matchMedia("(prefers-reduced-motion: reduce)").matches}catch{return!1}},[]),v=t.useCallback(()=>{const e=b.current;e.raf&&(cancelAnimationFrame(e.raf),e.raf=0),e.vx=0,e.vy=0,e.lastT=0},[]),w=t.useRef({width:0,height:0}),j=t.useRef({x:0,y:0}),k=t.useRef(e);t.useEffect(()=>{k.current=c},[c]),t.useEffect(()=>{j.current={x:a,y:l}},[a,l]);const N=t.useCallback(e=>{const t=e?.currentTarget?.getBoundingClientRect?.();t&&(w.current={width:t.width,height:t.height})},[]),S=(e,t)=>t<=0||e<=0?0:e*t/(e+t),C=t.useCallback((e,t=w.current)=>{if(!s||!u||!t?.width)return null;const r=u(),n=Math.max(.001,e),a=t.width/n,i=t.height/n,l=(p?.left||0)/n,o=(p?.right||0)/n,c=(p?.top||0)/n,d=(p?.bottom||0)/n,m=a-(Math.max(0,r.maxX-r.minX)+l+o),f=i-(Math.max(0,r.maxY-r.minY)+c+d);return{minX:Math.min(0,m),maxX:Math.max(0,m),minY:Math.min(0,f),maxY:Math.max(0,f)}},[u,s,p]),M=t.useCallback((e,t,r,n=!1,s=w.current)=>{const a=C(r,s);if(!a)return[e,t];const{minX:i,maxX:l,minY:o,maxY:c}=a;if(n){return[Math.min(Math.max(e,i),l),Math.min(Math.max(t,o),c)]}const d=(m||0)/Math.max(.001,r);let u=e,p=t;return e<i?u=i-S(i-e,d):e>l&&(u=l+S(e-l,d)),t<o?p=o-S(o-t,d):t>c&&(p=c+S(t-c,d)),[u,p]},[C,m]),A=t.useCallback((e,t,r,n=!1,s)=>{const[a,l]=M(e,t,r,n,s);i(a),o(l),j.current={x:a,y:l}},[M]),I=t.useCallback((t,r,n)=>{if(!isFinite(t)||!isFinite(r))return;if(y())return;v();const s=b.current;s.vx=t,s.vy=r,s.lastT="undefined"!=typeof performance?performance.now():Date.now();const a=Math.max(.001,n??(k.current||e)),i=e=>{const t=s.lastT||e,r=Math.max(1,e-t);s.lastT=e;const n=Math.exp(-r/280);s.vx*=n,s.vy*=n;const l=j.current.x+s.vx*r,o=j.current.y+s.vy*r;if(A(l,o,a,!0),Math.hypot(s.vx,s.vy)<.001){v();const[e,t]=M(j.current.x,j.current.y,a,!0);return void A(e,t,a,!0)}s.raf=requestAnimationFrame(i)};s.raf=requestAnimationFrame(i)},[y,v,A,M,e]),D=t.useCallback((e,t,r,n=220)=>{if(y())return void A(e,t,r,!0);v();const s=b.current,a=j.current.x,i=j.current.y,l="undefined"!=typeof performance?performance.now():Date.now(),o=c=>{const d=Math.min(1,(c-l)/n),u=(m=d,1-Math.pow(1-m,3));var m;A(a+(e-a)*u,i+(t-i)*u,r,!0),d<1&&(s.raf=requestAnimationFrame(o))};s.raf=requestAnimationFrame(o)},[y,A,v]),P=t.useCallback((e,t)=>{e.preventDefault(),v(),N(e);const s=e.currentTarget,i=s?.getBoundingClientRect?.(),o=i?e.clientX-i.left:0,u=i?e.clientY-i.top:0,m=i?o-i.width/2:0,p=i?u-i.height/2:0,f=c,h=Math.pow(2,-e.deltaY/300),g=Math.max(r,Math.min(n,f*h)),b=Math.max(.001,t??f),x=Math.max(.001,b*(g/Math.max(.001,f))),y=m*(1/x-1/b),w=p*(1/x-1/b);d(g),A(a+y,l+w,x,!1,i)},[c,r,n,v,N,A,a,l]),T=t.useCallback(e=>{e.preventDefault(),v(),N(e),e.currentTarget?.setPointerCapture?.(e.pointerId),h.current.set(e.pointerId,{x:e.clientX,y:e.clientY});const t="undefined"!=typeof performance?performance.now():Date.now();if(x.current={x:e.clientX,y:e.clientY,t:t},1===h.current.size)f.current={x:e.clientX,y:e.clientY,panX:a,panY:l};else if(2===h.current.size){const e=Array.from(h.current.values()),t=e[1].x-e[0].x,r=e[1].y-e[0].y;g.current.initialDistance=Math.hypot(t,r),g.current.initialScale=c,g.current.lastCenter={x:(e[0].x+e[1].x)/2,y:(e[0].y+e[1].y)/2},b.current.vx=0,b.current.vy=0}},[a,l,c,v,N]),E=t.useCallback((e,t)=>{if(e.syntheticPan){v();const r=Math.max(.001,t??c),{dx:n,dy:s}=e.syntheticPan;return void A(a+n,l+s,r)}if(h.current.has(e.pointerId))if(e.preventDefault(),N(e),h.current.set(e.pointerId,{x:e.clientX,y:e.clientY}),2===h.current.size){const s=Array.from(h.current.values()),i=s[1].x-s[0].x,o=s[1].y-s[0].y,u=Math.hypot(i,o),m=u/(g.current.initialDistance||u),p=Math.max(r,Math.min(n,g.current.initialScale*m)),f=e.currentTarget,x=f?.getBoundingClientRect?.(),y=(s[0].x+s[1].x)/2,v=(s[0].y+s[1].y)/2,w=x?y-x.left:0,j=x?v-x.top:0,k=x?w-x.width/2:0,N=x?j-x.height/2:0,S=c,C=Math.max(.001,t??S),M=Math.max(.001,C*(p/Math.max(.001,S))),I=k*(1/M-1/C),D=N*(1/M-1/C);d(p),A(a+I,l+D,M,!1,x),b.current.vx=0,b.current.vy=0}else if(1===h.current.size&&f.current){const r=Math.max(.001,t??c),n="undefined"!=typeof performance?performance.now():Date.now(),s=x.current,a=Math.max(1,n-s.t),i=(e.clientX-f.current.x)/r,l=(e.clientY-f.current.y)/r,o=j.current.x,d=j.current.y;A(f.current.panX+i,f.current.panY+l,r);const u=(j.current.x-o)/a,m=(j.current.y-d)/a,p=b.current,h=.25;p.vx=(1-h)*p.vx+h*u,p.vy=(1-h)*p.vy+h*m,x.current={x:e.clientX,y:e.clientY,t:n}}},[c,r,n,v,A,N,a,l]),_=t.useCallback((e,t)=>{if(h.current.delete(e.pointerId),h.current.size<1){const e=b.current,r=Math.hypot(e.vx,e.vy),n=Math.max(.001,t??(k.current||c)),[s,a]=M(j.current.x,j.current.y,n,!0),i=(e,t)=>Math.abs(e-t)<1e-4;!i(s,j.current.x)||!i(a,j.current.y)?D(s,a,n):f.current&&r>.002?I(e.vx,e.vy,n):A(s,a,n,!0),f.current=null}h.current.size<2&&(g.current.initialDistance=0)},[I,M,A,c,D]),F=t.useCallback(()=>{v(),d(e),A(0,0,e,!0)},[e,v,A]),$=t.useCallback(e=>{const t=Math.max(r,Math.min(n,e));d(t);const{x:s,y:a}=j.current;A(s,a,t)},[r,n,A]);return{panX:a,panY:l,scale:c,setScaleAbsolute:$,handleWheel:P,handlePointerDown:T,handlePointerMove:E,handlePointerUp:_,resetView:F}}const et={review:"--color-review",placeholder:"--color-placeholder",locked:"--color-status-locked",available:"--color-status-available",eligible:"--color-status-eligible",unlocked:"--color-status-unlocked"};const tt={review:"Search",placeholder:"CircleDashed",locked:"Lock",available:"CirclePlus",eligible:"CircleCheck",unlocked:"Trophy"},rt={Lock:g,CirclePlus:h,CircleCheck:f,Trophy:p,CircleDashed:m,Search:u,Circle:d};const nt=new Map;function st(){nt.clear()}function at(e,t="color"){if(nt.has(`${t}:${e}`))return nt.get(`${t}:${e}`);if("undefined"==typeof document)return null;const r=document.createElement("span");r.style.position="absolute",r.style.opacity="0",r.style.pointerEvents="none",r.className=e,document.body.appendChild(r);const n=getComputedStyle(r)[t];return document.body.removeChild(r),nt.set(`${t}:${e}`,n),n}function it(e,t=[]){for(const r of t){const t=e.getPropertyValue(r)?.trim();if(t)return t}return null}function lt(e){return e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName}function ot(e){const t="undefined"!=typeof document?document.documentElement:null;let r=null;try{"function"==typeof getComputedStyle&&lt(e)?r=getComputedStyle(e):t&&"function"==typeof getComputedStyle&&(r=getComputedStyle(t))}catch{r=null}return{unlocked:r&&it(r,[et.unlocked])||"#22C55E",achievable:r&&it(r,["--color-success","--color-achievable"])||at("text-emerald-400")||"#20C997",available:r&&it(r,[et.available])||"#0EA5E9",eligible:r&&it(r,[et.eligible])||"#F59E0B",locked:r&&it(r,[et.locked])||"#6C757D",text:r&&it(r,["--color-text-primary","--color-foreground"])||at("text-text-primary")||at("text-slate-900")||"#111827",connection:r&&it(r,["--color-connection","--color-border-muted"])||at("text-slate-400")||"#94A3B8",border:r&&it(r,["--color-border"])||at("border-slate-500","borderTopColor")||"rgba(0,0,0,0.3)",accent:r&&it(r,["--color-primary"])||at("text-primary")||at("text-blue-500")||"#3B82F6",review:r&&it(r,[et.review])||"#8B5CF6",placeholder:r&&it(r,[et.placeholder])||"#94A3B8",surface:r&&it(r,["--color-bg-primary","--color-surface"])||"#FFFFFF"}}function ct(e){try{const t="function"==typeof getComputedStyle?getComputedStyle(lt(e)?e:document.documentElement):null,r=t?.fontFamily;return r&&r.trim().length?r:"system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"}catch{return"system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"}}function dt(e,t,r,n=3,s="…"){if(!t)return[];const a=String(t).trim().split(/\s+/),i=[];let l="";for(let o=0;o<a.length;o++){const t=l?l+" "+a[o]:a[o];if(e.measureText(t).width<=r)l=t;else{if(i.length===n-1){let t=l||a[o];for(;e.measureText(t+s).width>r&&t.length>0;)t=t.slice(0,-1);return i.push(t+s),i}l&&i.push(l),l=a[o]}}return l&&i.push(l),i.slice(0,n)}function ut(e,t,r,n,s,a,i,l=!1){if(!(s instanceof C||s&&"object"==typeof s))throw new Error("drawMedalNode requires a Medal instance or a plain medal-like object");const o=ot(e?.canvas),c="function"==typeof s?.isPlaceholder?s.isPlaceholder():"placeholder"===s?.status,u=!c&&("function"==typeof s?.isUnderReview?s.isUnderReview():"under_review"===s?.status),m=a?.status||"locked",p=o[m],f=Math.max(i,.001);e.beginPath(),e.fillStyle=o.surface,e.arc(t,r,n,0,2*Math.PI),e.fill();const h=c?o.placeholder:p,g="function"==typeof e.save;if(g&&e.save(),c&&"function"==typeof e.setLineDash){const t=Math.max(1,2*f);e.setLineDash([t,1.5*t])}e.strokeStyle=h,e.lineWidth=3,e.beginPath(),e.arc(t,r,Math.max(1,n-1.5),0,2*Math.PI),e.stroke(),c&&"function"==typeof e.setLineDash&&e.setLineDash([]),g&&"function"==typeof e.restore&&e.restore();const b=rt[tt[c?"placeholder":m]||"Circle"]||d,x=1.3*n/24;if("function"==typeof e?.save&&"function"==typeof e?.translate&&"function"==typeof e?.scale&&"function"==typeof e?.restore?(e.save(),e.translate(t,r),e.scale(x,x),e.translate(-12,-12),e.lineWidth=2,e.strokeStyle=h,e.lineCap="round",e.lineJoin="round",function(e,t){if(Array.isArray(t))for(const[r,n]of t)switch(r){case"path":{const t=n?.d;if(t&&"function"==typeof Path2D){const r=new Path2D(t);e.stroke(r)}break}case"line":{const{x1:t,y1:r,x2:s,y2:a}=n||{};[t,r,s,a].every(e=>"number"==typeof e)&&(e.beginPath(),e.moveTo(t,r),e.lineTo(s,a),e.stroke());break}case"polyline":case"polygon":{const t=(n?.points||"").trim();if(t){const n=t.split(/[\s,]+/).map(Number);if(n.length>=4){e.beginPath(),e.moveTo(n[0],n[1]);for(let t=2;t<n.length;t+=2)e.lineTo(n[t],n[t+1]);"polygon"===r&&e.closePath(),e.stroke()}}break}case"rect":{const{x:t=0,y:r=0,width:s=0,height:a=0,rx:i=0,ry:l=0}=n||{};e.beginPath(),(i||l)&&"function"==typeof e.roundRect?e.roundRect(t,r,s,a,i||l):e.rect(t,r,s,a),e.stroke();break}case"circle":{const{cx:t=0,cy:r=0,r:s=0}=n||{};e.beginPath(),e.arc(t,r,s,0,2*Math.PI),e.stroke();break}case"ellipse":{const{cx:t=0,cy:r=0,rx:s=0,ry:a=0}=n||{};"function"==typeof e.ellipse&&(e.beginPath(),e.ellipse(t,r,s,a,0,0,2*Math.PI),e.stroke());break}}}(e,b),e.restore()):(e.beginPath(),e.strokeStyle=h,e.lineWidth=Math.max(1,.15*n),e.arc(t,r,Math.max(2,.5*n),0,2*Math.PI),e.stroke()),u){const s=Math.max(3,.22*n),a=.7*n,i=.7*n;e.beginPath(),e.fillStyle=o.review,e.arc(t+a,r-i,s,0,2*Math.PI),e.fill(),e.beginPath(),e.strokeStyle=o.surface,e.lineWidth=Math.max(1,2*f),e.arc(t+a,r-i,s,0,2*Math.PI),e.stroke()}const y=("string"==typeof s?.name?s.name.trim():"")||"Medal";if((l||i>=.8)&&y){e.fillStyle=o.text,e.textAlign="center",e.textBaseline="top";const a=14,c=Math.round(1.3*a),d=ct(e.canvas);e.font=`${a}px ${d}`;const u=180,m=l||i>=1.3?3:2,p="string"==typeof s?.tierName?s.tierName.trim():"";let f;if(p){f=[(t=>{if(e.measureText(t).width<=u)return t;let r=t;for(;r.length&&e.measureText(r+"…").width>u;)r=r.slice(0,-1);return r.length?r+"…":t})(y),...dt(e,p,u,Math.max(0,m-1))]}else f=dt(e,y,u,m);const h=r+n+8,g=e.shadowColor,b=e.shadowBlur,x=e.shadowOffsetX,v=e.shadowOffsetY;e.shadowColor="rgba(0,0,0,0.2)",e.shadowBlur=2,e.shadowOffsetX=0,e.shadowOffsetY=1;for(let r=0;r<f.length;r++)e.fillText(f[r],t,h+r*c);e.shadowColor=g,e.shadowBlur=b,e.shadowOffsetX=x,e.shadowOffsetY=v}}function mt(){return{render:t.useCallback((e,t,r,n,s,a,i,l,o)=>{if(!r||!t||!n)return;const c=new Map((r.medals||[]).map(e=>[e.medalId,e]));r.connections?.forEach(t=>{const r=c.get(t.from),n=c.get(t.to);if(!r||!n)return;const l=(r.x+s)*i+e.canvas.width/2,o=(r.y+a)*i+e.canvas.height/2,d=(n.x+s)*i+e.canvas.width/2,u=(n.y+a)*i+e.canvas.height/2;!function(e,t,r,n,s,a="prerequisite",i,l){const o=ot(e?.canvas);e.strokeStyle=o.connection,e.lineWidth=2,e.beginPath(),e.moveTo(t,r),e.lineTo(n,s),e.stroke();const c=Math.atan2(s-r,n-t);if(e.beginPath(),e.moveTo(n,s),e.lineTo(n-10*Math.cos(c-Math.PI/6),s-10*Math.sin(c-Math.PI/6)),e.lineTo(n-10*Math.cos(c+Math.PI/6),s-10*Math.sin(c+Math.PI/6)),e.closePath(),e.fillStyle=o.connection,e.fill(),l&&i>=.8){const a=ot(e?.canvas),i=n-t,o=s-r,c=Math.hypot(i,o)||1,d=12,u=(t+n)/2+-o/c*d,m=(r+s)/2+i/c*d,p=12,f=6,h=4,g=ct(e.canvas);e.font=`${p}px ${g}`;const b=(e.measureText(l)?.width||0)+2*f,x=p+2*h,y=u-b/2,v=m-x/2,w=6,j=e.globalAlpha;e.globalAlpha=.12,e.fillStyle=a.accent,e.beginPath(),"function"==typeof e.arcTo?(e.moveTo(y+w,v),e.arcTo(y+b,v,y+b,v+x,w),e.arcTo(y+b,v+x,y,v+x,w),e.arcTo(y,v+x,y,v,w),e.arcTo(y,v,y+b,v,w)):e.rect(y,v,b,x),e.closePath(),e.fill(),e.globalAlpha=j,e.strokeStyle=a.accent,e.lineWidth=1.5,e.beginPath(),"function"==typeof e.arcTo?(e.moveTo(y+w,v),e.arcTo(y+b,v,y+b,v+x,w),e.arcTo(y+b,v+x,y,v+x,w),e.arcTo(y,v+x,y,v,w),e.arcTo(y,v,y+b,v,w)):e.rect(y,v,b,x),e.closePath(),e.stroke(),e.fillStyle=a.text,e.textAlign="center",e.textBaseline="middle","function"==typeof e.fillText&&e.fillText(l,u,m)}}(e,l,o,d,u,t.type,i,t.label)}),Array.isArray(t)&&t.forEach(t=>{const r=c.get(t.id);if(!r)return;const d=(r.x+s)*i+e.canvas.width/2,u=(r.y+a)*i+e.canvas.height/2,m=r.radius*i,p=n.unlocked.find(e=>e.medalId===t.id)||n.eligible.find(e=>e.medalId===t.id)||n.available.find(e=>e.medalId===t.id)||{status:"locked"};if(l===t.id){const t=ot(e.canvas);e.strokeStyle=t.accent,e.lineWidth=Math.max(2,4/Math.max(i,.001)),e.beginPath(),e.arc(d,u,m+6,0,2*Math.PI),e.stroke()}const f=l===t.id||o===t.id;ut(e,d,u,m,t,p,i,f)})},[])}}function pt({status:e,className:t="w-4 h-4"}){const n=tt[e]||"Circle",s=function(e){return et[e]||null}(e);return r.jsx(Se,{name:n,className:t,style:s?{color:`var(${s})`}:void 0,"aria-hidden":"true",focusable:"false"})}function ft({className:e="",id:t,variant:n="list"}){return r.jsxs("div",{id:t,className:["flex flex-wrap items-center gap-x-4 gap-y-2 text-xs text-muted-foreground w-full min-w-0",e].join(" "),children:[r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"review"}),r.jsx("span",{children:"Under granskning"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"placeholder"}),r.jsx("span",{children:"Platshållare"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"locked"}),r.jsx("span",{children:"Låst"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"available"}),r.jsx("span",{children:"Tillgänglig"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"eligible"}),r.jsx("span",{children:"Kvalificerad"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"unlocked"}),r.jsx("span",{children:"Upplåst"})]})]})}function ht({open:e,title:n="Bekräfta",description:s="",confirmLabel:i="OK",cancelLabel:l="Avbryt",onConfirm:o,onCancel:c,variant:d="danger",id:u="confirm-dialog"}){const m=t.useRef(null),p=t.useRef(null),f=t.useRef(null),h=`${u}-title`,g=`${u}-desc`;if(t.useEffect(()=>{if(!e)return;f.current=document.activeElement;const t=p.current;if(!t)return;const r=()=>t.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),n=r()[0];n?.focus();const s=e=>{if("Escape"===e.key)e.preventDefault(),c?.();else if("Tab"===e.key){const t=r();if(0===t.length)return;const n=t[0],s=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),s?.focus()):e.shiftKey||document.activeElement!==s||(e.preventDefault(),n?.focus())}},a=e=>{e.target===m.current&&c?.()};document.addEventListener("keydown",s);const i=m.current;return i?.addEventListener("pointerdown",a,{capture:!0}),()=>{document.removeEventListener("keydown",s),i?.removeEventListener("pointerdown",a,{capture:!0});const e=f.current;e&&"function"==typeof e.focus&&e.focus()}},[e,c]),!e)return null;const b="danger"===d?"btn btn-danger min-h-[44px]":"btn btn-primary min-h-[44px]",x=r.jsx("div",{ref:m,className:"fixed inset-0 z-[80] bg-black/40 backdrop-blur-[1px] flex items-end sm:items-center justify-center p-3 safe-bottom",children:r.jsxs("div",{ref:p,role:"dialog","aria-modal":"true","aria-labelledby":h,"aria-describedby":g,className:"w-full sm:w-[28rem] max-w-[92vw] rounded-lg border border-border bg-background shadow-xl p-4",children:[r.jsx("h2",{id:h,className:"text-base font-semibold mb-1 text-foreground",children:n}),s?r.jsx("p",{id:g,className:"text-sm text-muted-foreground mb-4",children:s}):null,r.jsxs("div",{className:"flex flex-row-reverse flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:b,onClick:o,children:i}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:c,children:l})]})]})});return"undefined"==typeof document?x:a.createPortal(x,document.body)}const gt="columns",bt=new Map;function xt(e){if(!e||"object"!=typeof e)throw new Error("registerLayout: def must be an object");const{id:t,generator:r}=e;if(!t||"string"!=typeof t)throw new Error("registerLayout: def.id must be a non-empty string");if("function"!=typeof r)throw new Error(`registerLayout: def.generator must be a function (id: ${t})`);if(bt.has(t))throw new Error(`registerLayout: layout id already registered: ${t}`);bt.set(t,e)}function yt(e){const t=new Map(e.map(e=>[e.id,e])),r={};e.forEach(e=>{r[e.type]||(r[e.type]=[]),r[e.type].push(e)});const n=Object.keys(r),s={medals:[],connections:[]};return n.forEach((e,n)=>{(r[e]||[]).forEach((e,r)=>{const a={medalId:e.id,type:e.type,x:200*n,y:140*r,radius:20,yearsRequired:0};s.medals.push(a);let i=0;const l=Array.isArray(e.requirements)&&e.requirements.find(e=>e&&"sustained_achievement"===e.type&&Number.isFinite(e.yearsOfAchievement))?.yearsOfAchievement||0;Array.isArray(e.prerequisites)&&e.prerequisites.forEach(r=>{if(r&&"medal"===r.type&&r.medalId){const n=t.get(r.medalId),a=n&&n.type===e.type;let o=0;Number.isFinite(r.yearOffset)&&r.yearOffset>0?o=r.yearOffset:a&&"number"==typeof l&&l>1&&(o=l),o>i&&(i=o),s.connections.push({from:r.medalId,to:e.id,type:"prerequisite"})}}),a.yearsRequired=i})}),function(e){const t=5,r=100;for(let n=0;n<t;n++)for(let t=0;t<e.medals.length;t++)for(let n=t+1;n<e.medals.length;n++){const s=e.medals[t],a=e.medals[n],i=a.x-s.x,l=a.y-s.y,o=Math.sqrt(i*i+l*l)||1,c=r/(o*o),d=i/o*c*.1,u=l/o*c*.1;s.x-=d,s.y-=u,a.x+=d,a.y+=u}return e}(s)}function vt(e){const t=Array.isArray(e?.requirements)?e.requirements:[];let r=0;for(const n of t){const e=n&&"sustained_achievement"===n.type&&Number.isFinite(n.yearsOfAchievement)?n.yearsOfAchievement:0;e>r&&(r=e)}return r}const wt={id:"timeline",label:"Tidslinje",description:"Lanes per typ. X visar minsta ackumulerade år mellan förkunskaper (yearOffset).",defaultOptions:{yearWidth:220,laneHeight:260,rowHeight:130,radius:22},generator:(e,t={})=>{const r={...wt.defaultOptions,...t||{}},n=r.yearWidth,s=r.laneHeight,a=r.rowHeight,i=r.radius,l=Array.isArray(e)?e:[],o=new Map(l.map(e=>[e.id,e])),c=new Map(l.map(e=>[e.id,vt(e)])),d=new Map,u=new Map,m=new Map,p=[],f=(e,t,r)=>(e.has(t)||e.set(t,r),e.get(t));for(const N of l)m.set(N.id,0),f(d,N.id,[]),f(u,N.id,[]);for(const N of l){const e=Array.isArray(N?.prerequisites)?N.prerequisites:[];for(const t of e){if(!t||"medal"!==t.type||!t.medalId)continue;if(!o.has(t.medalId))continue;const e=Number.isFinite(t.yearOffset)&&t.yearOffset>0?t.yearOffset:0;d.get(N.id).push({from:t.medalId,cost:e}),u.get(t.medalId).push(N.id),m.set(N.id,(m.get(N.id)||0)+1),p.push({from:t.medalId,to:N.id,type:"prerequisite",label:e>0?`${e} år`:void 0})}}const h=new Map(l.map(e=>[e.id,0])),g=new Map(l.map(e=>[e.id,0])),b=[];for(const N of l)0===(m.get(N.id)||0)&&(g.set(N.id,c.get(N.id)||0),b.push(N.id));for(;b.length;){const e=b.shift(),t=u.get(e)||[];for(const r of t){const t=(d.get(r)||[]).find(t=>t.from===e),n=t?.cost||0,s=(g.get(e)||0)+n;(h.get(r)||0)<s&&h.set(r,s),m.set(r,(m.get(r)||0)-1),0===(m.get(r)||0)&&(g.set(r,(h.get(r)||0)+(c.get(r)||0)),b.push(r))}}const x=(y=l.map(e=>e?.type||"unknown"),Array.from(new Set(y))).sort((e,t)=>String(e).localeCompare(String(t)));var y;const v=new Map(x.map((e,t)=>[e,t])),w=[],j=[],k=new Map;for(const N of l){const e=N?.type||"unknown";if(!k.has(e)){const t=N&&"string"==typeof N.typeName?N.typeName.trim():"";k.set(e,t.length?t:e)}}for(const N of x){const e=(v.get(N)||0)*s,t=k.get(N)??N;j.push({type:N,y:e,label:t});const r=l.filter(e=>(e?.type||"unknown")===N),o=new Map;for(const n of r){const e=g.get(n.id)||0;o.has(e)||o.set(e,[]),o.get(e).push(n)}const c=Array.from(o.keys()).sort((e,t)=>e-t);for(const s of c){const t=o.get(s)||[];t.sort((e,t)=>String(e.id).localeCompare(String(t.id)));for(let r=0;r<t.length;r++){const l=t[r],o=(d.get(l.id)||[]).reduce((e,t)=>Math.max(e,t.cost||0),0);w.push({medalId:l.id,type:l.type,x:s*n,y:e+r*a,radius:i,yearsRequired:o})}}}return{medals:w,connections:p,meta:{kind:"timeline",yearWidth:n,laneHeight:s,rowHeight:a,lanes:j}}}};xt({id:"columns",label:"Standard (kolumner)",description:"Grupperar märken efter typ i kolumner.",generator:e=>yt(e)}),xt(wt);const jt="skilltree:layoutPreset";function kt(){const[e,r]=t.useState(()=>function(){if("undefined"==typeof window)return null;try{const e=window.localStorage.getItem(jt);return e&&e.length?e:null}catch{return null}}()||gt);return{presetId:e,setPresetId:t.useCallback(e=>{const t=e||gt;r(t),function(e){if("undefined"!=typeof window)try{e&&window.localStorage.setItem(jt,e)}catch{}}(t)},[])}}function Nt(e){const{medalDatabase:r}=ne(),n=t.useMemo(()=>{return t=e||gt,bt.has(t)?bt.get(t):bt.get(gt)||null;var t},[e]),s=t.useMemo(()=>r?.getAllMedals?.()||[],[r]);return{layout:t.useMemo(()=>n&&s&&0!==s.length?n.generator(s,n.defaultOptions):null,[n,s]),preset:n}}function St({legendDescribedById:e}){const n=t.useRef(null),{medalDatabase:s}=ne(),a=ie(),{render:o}=mt(),[c,d]=t.useState(null),[u,m]=t.useState(null),[p,f]=t.useState([]),h=l(),g=i(),x=g.pathname.endsWith("/skill-tree/fullscreen"),y=t.useRef(null),{presetId:v,setPresetId:w}=kt(),{layout:j}=Nt(v),k=24,[N,S]=t.useState(!0),[C,M]=t.useState(N?72:0),[A,I]=t.useState({w:0,h:0}),D=t.useCallback(()=>{if(!j||!j.medals?.length)return{minX:0,minY:0,maxX:0,maxY:0};let e=1/0,t=1/0,r=-1/0,n=-1/0;for(let s=0;s<j.medals.length;s++){const a=j.medals[s],i=a.radius||20;a.x-i<e&&(e=a.x-i),a.y-i<t&&(t=a.y-i),a.x+i>r&&(r=a.x+i),a.y+i>n&&(n=a.y+i)}return{minX:e,minY:t,maxX:r,maxY:n}},[j]),P=t.useCallback((e,t=24,r=0)=>{if(!j||!e)return{baseScale:1,minX:0,minY:0};const n=e.width,s=e.height;if(!n||!s)return{baseScale:1,minX:0,minY:0};const a=j.medals||[];if(!a.length)return{baseScale:1,minX:0,minY:0};let i=1/0,l=1/0,o=-1/0,c=-1/0;for(let h=0;h<a.length;h++){const e=a[h],t=e.radius||20;e.x-t<i&&(i=e.x-t),e.y-t<l&&(l=e.y-t),e.x+t>o&&(o=e.x+t),e.y+t>c&&(c=e.y+t)}const d=Math.max(1,o-i),u=Math.max(1,c-l),m=(n-2*t)/d,p=(s-2*t-Math.max(0,r))/u,f="timeline"===j?.meta?.kind;return{baseScale:Math.max(.001,f?p:Math.min(m,p)),minX:i,minY:l}},[j]),T=1.2,E=b.useCallback(()=>"timeline"===j?.meta?.kind?{min:.2,max:1.5}:{min:.5,max:1.5},[j]),_=t.useCallback(()=>{const{min:e,max:t}=E(),r=A.w,n=A.h;if(!j||!r||!n)return{min:e,max:t};const s={width:r,height:n},{baseScale:a}=P(s,k,C),i=Math.max(.001,a),l=Math.max(.001,e/i);return{min:l,max:Math.max(l,t/i)}},[A,j,E,P,C]),{min:F,max:$}=_(),{panX:q,panY:L,scale:Y,setScaleAbsolute:R,handleWheel:O,handlePointerDown:U,handlePointerMove:B,handlePointerUp:G,resetView:V}=Qe(6,F,$,{getBounds:D,overscrollPx:48,contentPaddingPx:{left:104,top:k+C,right:104,bottom:80}}),[z,K]=t.useState(!1),H=t.useRef(null),W=t.useRef(null),X=t.useRef(!1),J=t.useRef(Y);t.useEffect(()=>{J.current=Y},[Y]);const[Z,Q]=t.useState(!1),[ee,te]=t.useState(!0),[re,ae]=t.useState(!1),le=e||"skilltree-legend",oe=t.useRef(null),ce=t.useRef(null),de=t.useRef(null),ue=t.useRef(null),me=x?"fullscreen-actions-menu":"canvas-actions-menu",{currentProfile:pe,startExplorerMode:fe,hydrated:he,resetCurrentProfileData:ge}=se(),be=Boolean(pe?.isGuest),xe=!he||void 0===pe,[ye,ve]=t.useState(!1),[we,je]=t.useState(!1),[ke,Ne]=t.useState(!1),Ce=(()=>{try{return window.localStorage.getItem("app:onboardingChoice")}catch{return null}})(),Me=x&&!xe&&!pe&&!Ce&&!ye,Ie=t.useCallback((e,t=24)=>{const{baseScale:r,minX:n,minY:s}=P(e,t,C),a=e?.width||0,i=e?.height||0,l=Math.max(.001,r*Y),o=80/l,c=Math.max(0,C)/l;return{effScale:l,effPanX:q+((t-a/2)/l-(n-o)),effPanY:L+((t-i/2)/l-(s-c)),baseScale:r}},[P,q,L,Y,C]),De=t.useCallback((e,t=120)=>{if(!j||!e)return[];const r=e.width,n=e.height,s=j.medals||[],{effScale:a,effPanX:i,effPanY:l}=Ie(e),o=[];for(let c=0;c<s.length;c++){const e=s[c],d=(e.x+i)*a+r/2,u=(e.y+l)*a+n/2,m=(e.radius||20)*a;d+m>=-t&&d-m<=r+t&&u+m>=-t&&u-m<=n+t&&o.push(e)}return o},[j,Ie]),Pe=t.useCallback(e=>{if(!e||!j)return[];if(!ee)return[];const{effScale:t,effPanX:r,effPanY:n}=Ie(e),s=e.width,i=e.height,l=De(e),o=[],d=e=>u===e||c===e||t>=.8,m=new Map;for(const a of j.medals||[])m.set(a.medalId,a);const p=Math.max(16,12),f=e=>({x:(e.x+r)*t+s/2,y:(e.y+n)*t+i/2,r:(e.radius||20)*t});for(const c of l){const e=c.yearsRequired||0;if(!e||!d(c.medalId))continue;const t=f(c);let r=t.x,n=t.y-(t.r+8+10);const s=(j.connections||[]).find(e=>e.to===c.medalId);if(s){const e=m.get(s.from);if(e){const s=f(e),a=t.x-s.x,i=t.y-s.y,l=Math.hypot(a,i)||1,o=-(i/l),c=a/l,d=r-s.x,u=n-s.y,m=Math.hypot(d,u)||1,p=s.r+Math.max(56,20)/2+6;if(m<p){const e=p-m;r+=o*e,n+=c*e}}}const i=r-t.x,l=n-t.y,u=Math.hypot(i,l)||1,h=t.r+p;if(u<h){const e=i/u,s=l/u;r=t.x+e*h,n=t.y+s*h}const g=a?.[c.medalId]?.status,b="achievable"===g||"unlocked"===g?"ready":"neutral",x=`${e} år`;o.push({id:c.medalId,left:r,top:n,text:x,variant:b,w:56,h:20})}return o},[j,Ie,De,u,c,a,ee]),Te=t.useCallback(()=>{if(!n.current||!j||!s)return;const e=n.current,t=e.getContext("2d"),r=e.getBoundingClientRect();e.width===Math.floor(r.width)&&e.height===Math.floor(r.height)||(e.width=Math.floor(r.width),e.height=Math.floor(r.height),I({w:e.width,h:e.height}));const i=getComputedStyle(e).backgroundColor||"#fcfcf9";t.fillStyle=i,t.fillRect(0,0,e.width,e.height);const l=s.getAllMedals(),d=De(e),m=new Set(d.map(e=>e.medalId)),p=l.filter(e=>m.has(e.id)),{effScale:f,effPanX:h,effPanY:g}=Ie(e);if("timeline"===j?.meta?.kind){const r=ot(e)||{},n=e.width,s=e.height,a=-n/2/f-h,i=n/2/f-h,l=Number(j.meta.yearWidth)||220,o=Math.floor(a/l),c=Math.ceil(i/l),d=r.connection||"rgba(0,0,0,0.3)",u=r.text||"#111827",m=Math.max(12,N?C+12:12);t.save(),t.lineWidth=1,t.strokeStyle=d,t.globalAlpha=.25;for(let e=o;e<=c;e++){const r=(e*l+h)*f+n/2;t.beginPath(),t.moveTo(r,0),t.lineTo(r,s),t.stroke(),t.globalAlpha=.8,t.fillStyle=u,t.textAlign="center",t.textBaseline="top",t.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif",t.fillText(`${e} år`,r,m),t.globalAlpha=.25}t.restore();const p=Array.isArray(j.meta.lanes)?j.meta.lanes:[];if(p.length){t.save(),t.fillStyle=u,t.textAlign="left",t.textBaseline="middle",t.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif";for(const e of p){const r=(e.y+g)*f+s/2;r<-24||r>s+24||t.fillText(String(e.label||e.type||""),8,r)}t.restore()}}o(t,p,j,a,h,g,f,c,u)},[De,Ie,j,s,a,c,o,u,C,N]),Ee=t.useCallback(()=>{const e=n.current;if(!e||!j)return;const{baseScale:t}=P(e,k,C),{min:r,max:s}=E(),a="timeline"===j?.meta?.kind?.9:.8,i=Math.min(s,Math.max(r,a))/Math.max(.001,t);V(),R(i)},[P,j,V,R,C,E]),_e=(e,t,r)=>Math.min(r,Math.max(t,e)),Fe=t.useCallback(()=>{R(_e(J.current*T,F,$))},[R,F,$,T]),$e=t.useCallback(()=>{R(_e(J.current/T,F,$))},[R,F,$,T]),qe=t.useCallback(()=>{S(e=>{const t=!e;return t||M(0),t})},[M,S]),Le=t.useCallback(()=>{const e=g.state?.backgroundLocation;if(e&&"object"==typeof e){const t={pathname:e.pathname,search:e.search,hash:e.hash};return void h(t,{replace:!0,state:{...e.state||{},fromFullscreenClose:!0}})}if("string"==typeof e)return void h(e,{replace:!0,state:{fromFullscreenClose:!0}});const t=g.pathname.replace(/\/fullscreen$/,"");h(t||"/skill-tree",{replace:!0,state:{fromFullscreenClose:!0}})},[g,h]),Ye=t.useCallback(e=>{n.current=e},[]);t.useLayoutEffect(()=>{if(!N)return;const e=x?ue.current:de.current;if(!e)return;let t=requestAnimationFrame(()=>{const t=e.getBoundingClientRect();M(Math.max(0,Math.ceil(t.height)))});return()=>cancelAnimationFrame(t)},[N,x]),t.useEffect(()=>{let e=requestAnimationFrame(Te);return()=>cancelAnimationFrame(e)},[Te]),t.useLayoutEffect(()=>{const e=n.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),s=Math.floor(t.height);r>0&&s>0&&(e.width!==r||e.height!==s)&&(e.width=r,e.height=s,I({w:r,h:s})),f(Pe(e))},[Pe,q,L,Y,u,c,j]),t.useEffect(()=>{X.current||n.current&&j&&(X.current=!0,Ee())},[j,Ee]),t.useEffect(()=>{const e=()=>{const e=n.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),s=Math.floor(t.height);if(r>0&&s>0&&(e.width!==r||e.height!==s)&&(e.width=r,e.height=s,I({w:r,h:s})),Te(),f(Pe(e)),N){const e=x?ue.current:de.current;if(e){const t=e.getBoundingClientRect();M(Math.max(0,Math.ceil(t.height)))}}};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[Te,Pe,x,N]),t.useEffect(()=>{const e=n.current;if(!e)return;const t=t=>{const{effScale:r}=Ie(e);O(t,r)};return e.addEventListener("wheel",t,{passive:!1}),()=>{e.removeEventListener("wheel",t,{passive:!1})}},[Ie,O,x]),t.useEffect(()=>{if(!x)return;W.current=document.activeElement;const e=document.documentElement,t=e.style.overflow;e.style.overflow="hidden",oe.current?.focus?.();const r=e=>{if("Escape"!==e.key)return;if(Z||re)return;const t=document.activeElement;y.current&&y.current.contains(t)&&Le()};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r),e.style.overflow=t;const n=W.current;n&&"function"==typeof n.focus&&n.focus()}},[x,Z,re,Le]),t.useEffect(()=>{if(!Z)return;const e=e=>{const t=ce.current,r=oe.current;t&&r&&(t.contains(e.target)||r.contains(e.target)||Q(!1))};return window.addEventListener("pointerdown",e,{capture:!0}),()=>window.removeEventListener("pointerdown",e,{capture:!0})},[Z]),t.useEffect(()=>{n.current&&requestAnimationFrame(()=>{Te()})},[x,Te]),t.useEffect(()=>{const e=()=>{requestAnimationFrame(()=>{st();const e=n.current;e&&(Te(),f(Pe(e)))})},t="undefined"!=typeof window&&window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)"):null;t&&"function"==typeof t.addEventListener&&t.addEventListener("change",e);const r=new MutationObserver(t=>{for(const r of t)if("attributes"===r.type&&"class"===r.attributeName){e();break}});return"undefined"!=typeof document&&document.documentElement&&r.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>{t&&"function"==typeof t.removeEventListener&&t.removeEventListener("change",e),r.disconnect()}},[Te,Pe]),t.useEffect(()=>{const e=()=>{requestAnimationFrame(()=>{const e=n.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),s=Math.floor(t.height);r>0&&s>0&&(e.width!==r||e.height!==s)&&(e.width=r,e.height=s,I({w:r,h:s})),st(),Te(),f(Pe(e))})},t=t=>{e()},r=()=>{"undefined"!=typeof document&&"visible"===document.visibilityState&&e()},s=()=>{e()};return window.addEventListener("pageshow",t),document.addEventListener("visibilitychange",r),window.addEventListener("orientationchange",s),()=>{window.removeEventListener("pageshow",t),document.removeEventListener("visibilitychange",r),window.removeEventListener("orientationchange",s)}},[Te,Pe]);const Re=t.useCallback(e=>{const{effScale:t}=Ie(n.current),r=50/Math.max(t,.001);["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","+","=","-","0"].includes(e.key)&&e.preventDefault(),"ArrowLeft"===e.key?B({syntheticPan:{dx:-r,dy:0}},t):"ArrowRight"===e.key?B({syntheticPan:{dx:r,dy:0}},t):"ArrowUp"===e.key?B({syntheticPan:{dx:0,dy:-r}},t):"ArrowDown"===e.key?B({syntheticPan:{dx:0,dy:r}},t):"+"===e.key||"="===e.key?Fe():"-"===e.key?$e():"0"===e.key&&Ee()},[Ie,B,Ee,Fe,$e]),Oe=e=>{K(!0),U(e)},Ue=e=>{if(z){const{effScale:t}=Ie(n.current);return B(e,t),void(n.current&&(n.current.style.cursor="grabbing"))}if(!n.current||!j)return;const t=n.current.getBoundingClientRect(),r=e.clientX-t.left,s=e.clientY-t.top,{effScale:a,effPanX:i,effPanY:l}=Ie(n.current),o=De(n.current);for(const c of o){const e=(c.x+i)*a+n.current.width/2,t=(c.y+l)*a+n.current.height/2,o=(c.radius||20)*a,d=Math.max(o,24),u=r-e,p=s-t;if(u*u+p*p<d*d)return m(c.medalId),void(n.current.style.cursor="pointer")}m(null),n.current.style.cursor="grab"},Be=e=>{K(!1);const t=n.current,{effScale:r}=t?Ie(t):{effScale:J.current};G(e,r),m(null)},Ge=e=>{if(!n.current||!j)return;const t=n.current.getBoundingClientRect(),r=e.clientX-t.left,s=e.clientY-t.top,{effScale:a,effPanX:i,effPanY:l}=Ie(n.current),o=De(n.current);for(const c of o){const e=(c.x+i)*a+n.current.width/2,t=(c.y+l)*a+n.current.height/2,o=(c.radius||20)*a,u=Math.max(o,24),m=r-e,p=s-t;if(m*m+p*p<u*u)return d(c.medalId),void h(`/medals/${c.medalId}`,{state:{backgroundLocation:g}})}d(null)},Ve=e=>{if(!n.current||!j)return;const t=n.current.getBoundingClientRect(),r=e.clientX-t.left,s=e.clientY-t.top,{effScale:a,effPanX:i,effPanY:l}=Ie(n.current),o=De(n.current);for(const c of o){const e=(c.x+i)*a+n.current.width/2,t=(c.y+l)*a+n.current.height/2,o=(c.radius||20)*a,u=Math.max(o,24),m=r-e,p=s-t;if(m*m+p*p<u*u)return window.dispatchEvent(new CustomEvent("openAchievementForm",{detail:{medalId:c.medalId}})),d(c.medalId),void h(`/medals/${c.medalId}`,{state:{backgroundLocation:g}})}},ze=()=>{n.current&&function(e,t="skill-tree.png"){try{const r=document.createElement("a");r.href=e.toDataURL("image/png"),r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r)}catch(r){window.open(e.toDataURL("image/png"),"_blank")}}(n.current,`skill-tree-${(new Date).toISOString().split("T")[0]}.png`)};return s?r.jsxs("div",{className:"space-y-4",children:[r.jsx("div",{className:"card overflow-hidden overscroll-contain mt-2",role:"region","aria-label":"Trädvy canvas","aria-describedby":["skilltree-help",le].filter(Boolean).join(" "),children:!x&&r.jsxs("div",{className:"relative",children:[r.jsx("canvas",{ref:Ye,"data-tour":"tree-canvas",role:"img","aria-label":"Interaktiv träd-vy-canvas","aria-describedby":["skilltree-help",N?le:null,e].filter(Boolean).join(" "),"aria-keyshortcuts":"ArrowLeft ArrowRight ArrowUp ArrowDown = + - 0",tabIndex:0,onKeyDown:Re,className:"w-full h-[60vh] sm:h-[600px] bg-background cursor-grab active:cursor-grabbing touch-none overscroll-contain select-none",onContextMenu:e=>e.preventDefault(),onPointerDown:Oe,onPointerMove:Ue,onPointerUp:Be,onPointerLeave:Be,onPointerCancel:Be,onClick:Ge,onDoubleClick:Ve}),r.jsx("div",{className:"pointer-events-none absolute inset-0",children:p.map(e=>r.jsxs(b.Fragment,{children:[r.jsx("span",{"aria-hidden":"true",style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,borderRadius:"9999px",background:"var(--color-background, #fff)",boxShadow:"0 0 0 3px var(--color-background, #fff)",zIndex:0}}),r.jsx("span",{role:"note","aria-label":`Kräver ${e.text}`,title:`Kräver ${e.text}`,className:["inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium shadow-sm","ready"===e.variant?"bg-primary text-white border-primary":"bg-primary/10 dark:bg-primary/20 text-foreground border-primary"].join(" "),style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,whiteSpace:"nowrap",zIndex:1},children:r.jsx("span",{"aria-hidden":"true",children:e.text})})]},e.id))}),N&&r.jsx("div",{ref:de,"data-tour":"tree-legend",className:"absolute left-3 right-3 top-3 sm:left-4 sm:right-auto sm:top-4 z-[40] overflow-x-auto whitespace-nowrap rounded-md border border-border/60 bg-background/80 backdrop-blur-sm shadow-md px-3 py-1.5",style:{marginTop:"env(safe-area-inset-top)"},role:"note",id:le,children:r.jsx(ft,{variant:"canvas"})}),r.jsx("div",{className:"absolute right-3 bottom-3 sm:right-4 sm:bottom-4 z-30",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"relative",children:[r.jsx("button",{type:"button",ref:oe,"data-tour":"tree-actions","aria-haspopup":"menu","aria-controls":me,"aria-expanded":Z,onClick:()=>Q(e=>!e),className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Visa åtgärder","aria-label":"Visa åtgärder",children:r.jsx(Se,{name:"MoreVertical",className:"w-6 h-6"})}),Z&&r.jsxs("div",{id:me,ref:ce,role:"menu","aria-label":"Åtgärder",className:"absolute right-0 bottom-14 sm:bottom-16 w-56 rounded-md border border-border bg-background shadow-xl overflow-hidden",onKeyDown:e=>{if("Escape"===e.key)e.preventDefault(),Q(!1),oe.current?.focus();else if("ArrowDown"===e.key||"ArrowUp"===e.key){const t=Array.from(e.currentTarget.querySelectorAll('[role="menuitem"]'));if(0===t.length)return;const r=t.indexOf(document.activeElement);let n=0;"ArrowDown"===e.key&&(n=r>=0?(r+1)%t.length:0),"ArrowUp"===e.key&&(n=r>=0?(r-1+t.length)%t.length:t.length-1),e.preventDefault(),t[n]?.focus()}},children:[r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),Ee()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Återställ vy"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),ze()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Exportera som PNG"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),qe()},"aria-pressed":N,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:N?"Dölj teckenförklaring":"Visa teckenförklaring"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),te(e=>!e)},"aria-pressed":ee,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:ee?"Dölj årsbrickor":"Visa årsbrickor"}),r.jsxs("div",{role:"group","aria-label":"Visualisering",className:"border-t border-border/60",children:[r.jsx("button",{role:"menuitemradio","aria-checked":"columns"===v,type:"button",onClick:()=>{Q(!1),w("columns"),Ee()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Standard (kolumner)"}),r.jsx("button",{role:"menuitemradio","aria-checked":"timeline"===v,type:"button",onClick:()=>{Q(!1),w("timeline"),Ee()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Tidslinje"})]}),(!pe||be)&&r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),je(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Spara"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),ae(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visa hjälp"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),h("/skill-tree/fullscreen",{replace:!0,state:{backgroundLocation:g}})},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","aria-haspopup":"dialog","aria-controls":"skilltree-fullscreen",children:"Öppna helskärm"})]})]})}),r.jsx("div",{className:"absolute left-3 bottom-3 sm:left-4 sm:bottom-4 z-30",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"inline-flex flex-col gap-2","data-tour":"zoom-controls",children:[r.jsx("button",{type:"button","aria-label":"Zooma in",onClick:Fe,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma in",children:r.jsx(Se,{name:"Plus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Zooma ut",onClick:$e,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma ut",children:r.jsx(Se,{name:"Minus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Återställ vy",onClick:Ee,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Återställ vy",children:r.jsx(Se,{name:"RotateCcw",className:"w-6 h-6"})})]})}),r.jsx("p",{id:"skilltree-help",className:"sr-only",children:"💡 Dra för att panorera • Nyp för att zooma • Klicka på märken för detaljer"}),re&&r.jsx("div",{role:"dialog","aria-modal":"false","aria-labelledby":"skilltree-help-title",className:"absolute left-1/2 bottom-24 -translate-x-1/2 w-[min(92vw,28rem)] rounded-md border border-border bg-background text-foreground shadow-xl p-4 z-30",children:r.jsxs("div",{className:"flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsx("h3",{id:"skilltree-help-title",className:"text-sm font-semibold mb-1",children:"Hjälp"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Dra för att panorera • Nyp eller använd +/− för att zooma • 0 återställer vy • Klicka för detaljer"})]}),r.jsx("button",{type:"button","aria-label":"Stäng hjälp",className:"btn btn-muted min-h-[44px] px-3 py-2",onClick:()=>ae(!1),children:"Stäng"})]})})]})}),x&&r.jsxs("div",{id:"skilltree-fullscreen",ref:y,className:"fixed inset-0 z-50 bg-background overscroll-contain flex flex-col",role:"dialog","aria-modal":"true","aria-label":"Helskärms träd-vy",children:[r.jsx("h2",{className:"sr-only",children:"Märken"}),r.jsx("div",{className:"absolute right-3 bottom-3 sm:right-4 sm:bottom-4 z-[60]",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"relative",children:[r.jsx("button",{type:"button",ref:oe,"data-tour":"tree-actions","aria-haspopup":"menu","aria-controls":me,"aria-expanded":Z,onClick:()=>Q(e=>!e),className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Visa åtgärder","aria-label":"Visa åtgärder",children:r.jsx(Se,{name:"MoreVertical",className:"w-6 h-6"})}),Z&&r.jsxs("div",{id:me,ref:ce,role:"menu","aria-label":"Åtgärder",className:"absolute right-0 bottom-14 sm:bottom-16 w-56 rounded-md border border-border bg-background shadow-xl overflow-hidden",onKeyDown:e=>{if("Escape"===e.key)e.preventDefault(),Q(!1),oe.current?.focus();else if("ArrowDown"===e.key||"ArrowUp"===e.key){const t=Array.from(e.currentTarget.querySelectorAll('[role="menuitem"]'));if(0===t.length)return;const r=t.indexOf(document.activeElement);let n=0;"ArrowDown"===e.key&&(n=r>=0?(r+1)%t.length:0),"ArrowUp"===e.key&&(n=r>=0?(r-1+t.length)%t.length:t.length-1),e.preventDefault(),t[n]?.focus()}},children:[r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),Ee()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Återställ vy"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),ze()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Exportera som PNG"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),qe()},"aria-pressed":N,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:N?"Dölj teckenförklaring":"Visa teckenförklaring"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),te(e=>!e)},"aria-pressed":ee,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:ee?"Dölj årsbrickor":"Visa årsbrickor"}),r.jsxs("div",{role:"group","aria-label":"Visualisering",className:"border-t border-border/60",children:[r.jsx("button",{role:"menuitemradio","aria-checked":"columns"===v,type:"button",onClick:()=>{Q(!1),w("columns"),Ee()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Standard (kolumner)"}),r.jsx("button",{role:"menuitemradio","aria-checked":"timeline"===v,type:"button",onClick:()=>{Q(!1),w("timeline"),Ee()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Tidslinje"})]}),(!pe||be)&&r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),je(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Spara framsteg"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{Q(!1),ae(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visa hjälp"}),r.jsx("button",{role:"menuitem",type:"button",ref:H,onClick:()=>{Q(!1),Le()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Stäng helskärm"})]})]})}),r.jsx("div",{className:"absolute left-3 bottom-3 sm:left-4 sm:bottom-4 z-[60]",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"inline-flex flex-col gap-2","data-tour":"zoom-controls",children:[r.jsx("button",{type:"button","aria-label":"Zooma in",onClick:Fe,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma in",children:r.jsx(Se,{name:"Plus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Zooma ut",onClick:$e,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma ut",children:r.jsx(Se,{name:"Minus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Återställ vy",onClick:Ee,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Återställ vy",children:r.jsx(Se,{name:"RotateCcw",className:"w-6 h-6"})})]})}),Me&&r.jsx("div",{role:"region","aria-label":"Onboarding",className:"absolute left-3 right-3 z-[50]",style:{marginTop:"env(safe-area-inset-top)",top:Math.max(12,C+12)},children:r.jsxs("div",{className:"rounded-md border border-border bg-background/80 backdrop-blur-sm shadow-md p-3",children:[r.jsx("p",{className:"text-sm text-foreground mb-2",children:"Spara dina framsteg?"}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:()=>{try{window.localStorage.setItem("app:onboardingChoice","saved")}catch{}ve(!0),je(!0)},children:"Skapa profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>{try{window.localStorage.setItem("app:onboardingChoice","guest")}catch{}ve(!0),fe()},children:"Fortsätt som gäst"}),r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:()=>ve(!0),children:"Inte nu"})]})]})}),x&&be&&!Me&&r.jsxs("div",{className:"absolute left-1/2 -translate-x-1/2 z-[60] flex items-center gap-2",style:{bottom:"calc(env(safe-area-inset-bottom) + 16px)"},role:"group","aria-label":"Snabbåtgärder (gäst)",children:[r.jsx("button",{type:"button",onClick:()=>Ne(!0),className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 backdrop-blur-sm px-3 py-1.5 text-sm shadow-md min-h-[36px]","aria-label":"Återställ alla",title:"Återställ alla",children:"Återställ alla"}),r.jsx("button",{type:"button",onClick:()=>je(!0),className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 backdrop-blur-sm px-3 py-1.5 text-sm shadow-md min-h-[36px]","aria-label":"Spara framsteg",title:"Spara framsteg",children:"Spara framsteg"})]}),r.jsx("div",{className:"flex-1",children:r.jsxs("div",{className:"relative h-full",children:[r.jsx("canvas",{ref:Ye,"data-tour":"tree-canvas",role:"img","aria-label":"Interaktiv träd-vy-canvas","aria-describedby":["skilltree-help-fs",N?"skilltree-legend-fs":null,e].filter(Boolean).join(" "),"aria-keyshortcuts":"ArrowLeft ArrowRight ArrowUp ArrowDown = + - 0",tabIndex:0,onKeyDown:Re,className:"w-full h-full bg-background cursor-grab active:cursor-grabbing touch-none overscroll-contain select-none",onContextMenu:e=>e.preventDefault(),onPointerDown:Oe,onPointerMove:Ue,onPointerUp:Be,onPointerLeave:Be,onPointerCancel:Be,onClick:Ge,onDoubleClick:Ve}),N&&r.jsx("div",{ref:ue,"data-tour":"tree-legend",className:"absolute left-3 right-3 top-3 sm:left-4 sm:right-auto sm:top-4 z-[40] overflow-x-auto whitespace-nowrap rounded-md border border-border/60 bg-background/80 backdrop-blur-sm shadow-md px-3 py-1.5",style:{marginTop:"env(safe-area-inset-top)"},role:"note",id:"skilltree-legend-fs",children:r.jsx(ft,{variant:"canvas"})}),r.jsx("div",{className:"pointer-events-none absolute inset-0",children:p.map(e=>r.jsxs(b.Fragment,{children:[r.jsx("span",{"aria-hidden":"true",style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,borderRadius:"9999px",background:"var(--color-background, #fff)",boxShadow:"0 0 0 3px var(--color-background, #fff)",zIndex:0}}),r.jsx("span",{role:"note","aria-label":`Kräver ${e.text}`,title:`Kräver ${e.text}`,className:["inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium shadow-sm","ready"===e.variant?"bg-primary text-white border-primary":"bg-primary/10 dark:bg-primary/20 text-foreground border-primary"].join(" "),style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,whiteSpace:"nowrap",zIndex:1},children:r.jsx("span",{"aria-hidden":"true",children:e.text})})]},e.id))})]})}),r.jsx("p",{id:"skilltree-help-fs",className:"sr-only",children:"💡 Dra för att panorera • Nyp för att zooma • Klicka på märken för detaljer"}),re&&r.jsx("div",{role:"dialog","aria-modal":"false","aria-labelledby":"skilltree-help-title-fs",className:"absolute left-1/2 bottom-24 -translate-x-1/2 w-[min(92vw,28rem)] rounded-md border border-border bg-background text-foreground shadow-xl p-4 z-[70]",children:r.jsxs("div",{className:"flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsx("h3",{id:"skilltree-help-title-fs",className:"text-sm font-semibold mb-1",children:"Hjälp"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Dra för att panorera • Nyp för att zooma • Klicka för detaljer"})]}),r.jsx("button",{type:"button","aria-label":"Stäng hjälp",className:"btn btn-muted min-h-[44px] px-3 py-2",onClick:()=>ae(!1),children:"Stäng"})]})})]}),r.jsx(ht,{id:"reset-confirm-skilltree",open:ke,onCancel:()=>Ne(!1),onConfirm:async()=>{Ne(!1),await ge()},title:"Återställa allt?",description:"Detta rensar alla tillfälliga framsteg (märken och förkunskaper) i gästläget. Denna åtgärd går inte att ångra.",confirmLabel:"Återställ",cancelLabel:"Avbryt",variant:"danger"}),r.jsx(Ae,{id:"save-progress-picker-canvas",mode:"picker",open:we,onClose:()=>je(!1),forceCreate:!0,convertGuest:!0})]}):r.jsx("div",{className:"flex items-center justify-center h-96",role:"status","aria-live":"polite","aria-busy":"true",children:r.jsx("p",{className:"text-text-secondary",children:"Laddar märken..."})})}function Ct(e,t){try{return window.localStorage.setItem(e,t),!0}catch{return!1}}function Mt({idPrefix:e="default"}){const{resetCurrentProfileData:n}=se(),[s,a]=t.useState(!1),[i,l]=t.useState(!1);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"card p-4",role:"status","aria-live":"polite",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(Se,{name:"Compass",className:"w-6 h-6 shrink-0"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"mb-2 text-muted-foreground",children:"Gästläge: framsteg sparas tillfälligt."}),r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{type:"button",className:"btn btn-primary",onClick:()=>a(!0),children:[r.jsx(Se,{name:"Save",className:"w-4 h-4"}),"Spara"]}),r.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>l(!0),children:[r.jsx(Se,{name:"RotateCcw",className:"w-4 h-4"}),"Återställ"]})]})]})]})}),r.jsx(ht,{id:`reset-confirm-${e}`,open:i,onCancel:()=>l(!1),onConfirm:async()=>{l(!1),await n()},title:"Återställa allt?",description:"Detta rensar alla tillfälliga framsteg (märken och förkunskaper) i gästläget. Denna åtgärd går inte att ångra.",confirmLabel:"Återställ",cancelLabel:"Avbryt",variant:"danger"}),r.jsx(Ae,{id:`save-progress-picker-${e}`,mode:"picker",open:s,onClose:()=>a(!1),forceCreate:!0,convertGuest:!0})]})}function At({id:e="profile-picker-inline"}){const{currentProfile:n}=se(),[s,a]=t.useState(!1);return n?null:r.jsxs("div",{className:"card p-4",role:"region","aria-label":"Profil krävs",children:[r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("div",{"aria-hidden":"true",className:"text-xl leading-none",children:"👤"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"text-foreground mb-2",children:"Välj eller skapa en profil."}),r.jsx("button",{type:"button",onClick:()=>a(!0),className:"btn btn-primary min-h-[44px]","aria-haspopup":"dialog","aria-controls":e,children:"Profil"})]})]}),r.jsx(Ae,{id:e,mode:"picker",open:s,onClose:()=>a(!1)})]})}function It({idPrefix:e="default",onChooseGuest:t,onChooseSaved:n}){const s=`onboarding-title-${e}`;return r.jsxs("div",{className:"card p-4",role:"dialog","aria-modal":"true","aria-labelledby":s,children:[r.jsx("h2",{id:s,className:"section-title mb-2",children:"Hur vill du börja?"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Utforska märken direkt eller skapa en profil för att spara ditt arbete."}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsxs("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:t,children:[r.jsx(Se,{name:"Compass",className:"w-4 h-4"}),"Utforska utan att spara (Gästläge)"]}),r.jsxs("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:n,children:[r.jsx(Se,{name:"UserPlus",className:"w-4 h-4"}),"Skapa profil"]})]})]})}function Dt({idPrefix:e="default",promptId:n}){const{isProfileLoading:s,showOnboarding:a,isGuest:i,chooseGuest:l,chooseSaved:o}=function(){const{currentProfile:e,startExplorerMode:r,hydrated:n}=se(),[s,a]=t.useState(!1),i=t.useMemo(()=>{if("undefined"==typeof window)return null;try{return window.localStorage.getItem("app:onboardingChoice")}catch{return null}},[]),l=!n||void 0===e;return{isProfileLoading:l,showOnboarding:!(l||e||i||s),isGuest:Boolean(e?.isGuest),chooseGuest:t.useCallback(()=>{Ct("app:onboardingChoice","guest"),r()},[r]),chooseSaved:t.useCallback(()=>{Ct("app:onboardingChoice","saved"),a(!0)},[])}}();if(s)return null;if(a)return r.jsx(It,{idPrefix:e,onChooseGuest:l,onChooseSaved:o});if(i)return r.jsx(Mt,{idPrefix:e});const c=n||`profile-picker-${e}`;return r.jsx(At,{id:c})}const Pt="whatsnew:lastSeen";function Tt(){return he?.version}function Et(){try{return localStorage.getItem(Pt)}catch{return null}}function _t(){if(he?.env)return"production"===he.env;try{const e="undefined"!=typeof window&&window.location&&window.location.hostname?window.location.hostname:"";return!!e&&!("localhost"===e||"127.0.0.1"===e)}catch{return!1}}function Ft(){const{currentProfile:e,hydrated:n}=se(),s=!n||void 0===e,a=l(),o=i(),c=Ie();t.useEffect(()=>{if("undefined"==typeof window)return;const e=window.innerWidth<768,t="/skill-tree"===o.pathname,r=Boolean(o.state?.fromFullscreenClose);e&&t&&!r&&a("/skill-tree/fullscreen",{replace:!0,state:{backgroundLocation:o}})},[a,o]);const d=t.useCallback(()=>{c?.open||c.start("tree-view")},[c]);return t.useEffect(()=>{if(s)return;if(!("/skill-tree"===o.pathname||"/skill-tree/fullscreen"===o.pathname))return;if(c?.open)return;let e=null;try{e=sessionStorage.getItem(be)}catch{e=null}if("tree-view"!==e)return;try{sessionStorage.removeItem(be)}catch{}const t=setTimeout(()=>{d()},100);return()=>clearTimeout(t)},[s,o.pathname,c,d]),t.useEffect(()=>{if(s)return;if(!("/skill-tree"===o.pathname||"/skill-tree/fullscreen"===o.pathname))return;if(c?.open)return;try{if("tree-view"===sessionStorage.getItem(be))return}catch{}if(!c?.canAutoStart?.("tree-view"))return;if(_t()){const e=Tt();if(Et()!==e)return}const e=setTimeout(()=>{d()},100);return()=>clearTimeout(e)},[s,o.pathname,c,d]),s?null:r.jsxs("div",{className:"space-y-6",children:[r.jsx(Dt,{idPrefix:"skilltree",promptId:"profile-picker-skill-tree"}),r.jsx("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:r.jsxs("div",{className:"flex items-baseline gap-3 flex-wrap",children:[r.jsx("h1",{className:"text-3xl font-bold text-text-primary mb-1 sm:mb-0",children:"Trädvy"}),r.jsx("button",{type:"button",onClick:d,className:"text-sm underline hover:no-underline text-muted-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded",children:"Visa guide"})]})}),r.jsx(St,{})]})}const $t="medal-app-current-filters";function qt(e){return(e||"").toString().toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g,"")}function Lt(e,t){return t?t.unlocked?.some(t=>t.medalId===e)?"unlocked":t.eligible?.some(t=>t.medalId===e)?"eligible":t.available?.some(t=>t.medalId===e)?"available":"locked":"locked"}function Yt({value:e,onChange:n,suggestions:s,onSuggestionSelect:a,placeholder:i="Search medals…",inputRef:l}){const[o,c]=t.useState(!1);return r.jsxs("div",{className:"relative",children:[r.jsxs("div",{className:"relative",children:[r.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground","aria-hidden":!0,children:"🔍"}),r.jsx("input",{type:"text",ref:l,value:e,onChange:e=>n?.(e.target.value),onFocus:()=>{(s||[]).length>0&&c(!0)},onBlur:()=>setTimeout(()=>c(!1),100),placeholder:i,className:"input pl-8 pr-12 min-h-[44px]","aria-label":"Search medals",role:"combobox","aria-autocomplete":"list","aria-expanded":o,"aria-controls":"search-suggestions","aria-haspopup":"listbox","data-tour":"medals-search"}),e?r.jsx("button",{type:"button",onClick:()=>n?.(""),className:"absolute right-2 top-1/2 -translate-y-1/2 btn btn-muted h-9 w-9","aria-label":"Clear search",children:"✕"}):null]}),o&&(s||[]).length>0&&r.jsx("div",{id:"search-suggestions",role:"listbox","aria-label":"Search suggestions",className:"absolute top-full left-0 right-0 mt-1 bg-bg-secondary border border-border rounded-lg shadow-lg z-10 text-foreground",children:s.map((e,t)=>r.jsx("button",{type:"button",role:"option",onClick:()=>(e=>{a?.(e),c(!1)})(e),className:"w-full text-left px-4 py-2 min-h-[44px] hover:bg-background border-b border-border last:border-b-0 text-sm",children:e},`${e}-${t}`))})]})}function Rt({filters:e,onFilterChange:t,medalTypes:n,tiers:s,hasActiveFilters:a,resultCount:i,onClearAll:l,sortBy:o,onSortChange:c}){return r.jsxs("div",{className:"card flex flex-col overflow-hidden max-h-[80dvh] sm:max-h-none","data-tour":"filter-panel",children:[r.jsxs("div",{className:"p-4 flex justify-between items-center",children:[r.jsx("h3",{className:"font-bold text-foreground",children:"Filter"}),a&&r.jsx("button",{type:"button",onClick:l,className:"btn btn-muted text-sm min-h-[44px]",children:"Återställ alla"})]}),r.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto overscroll-contain p-4 pt-0",children:r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[r.jsxs("div",{className:"col-span-2 md:col-span-3",children:[r.jsx("label",{htmlFor:"sortSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Sortering"}),r.jsxs("select",{id:"sortSelect",value:o||"name",onChange:e=>c?.(e.target.value),className:"select",children:[r.jsx("option",{value:"name",children:"Namn"}),r.jsx("option",{value:"type",children:"Typ"}),r.jsx("option",{value:"tier",children:"Valör"}),r.jsx("option",{value:"status",children:"Status"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"statusSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Status"}),r.jsxs("select",{id:"statusSelect",value:e.status||"",onChange:e=>t("status",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"unlocked",children:"Upplåst"}),r.jsx("option",{value:"eligible",children:"Kvalificerad"}),r.jsx("option",{value:"available",children:"Tillgänglig"}),r.jsx("option",{value:"locked",children:"Låst"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"tierSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Valör"}),r.jsxs("select",{id:"tierSelect",value:e.tier||"",onChange:e=>t("tier",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),s.map(e=>r.jsx("option",{value:e,children:e.charAt(0).toUpperCase()+e.slice(1).replace(/_/g," ")},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"typeSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Typ"}),r.jsxs("select",{id:"typeSelect",value:e.type||"",onChange:e=>t("type",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),n.map(e=>r.jsx("option",{value:e,children:e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"weaponGroupSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Vapengrupp"}),r.jsxs("select",{id:"weaponGroupSelect",value:e.weaponGroup||"",onChange:e=>t("weaponGroup",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"reviewStatusSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Granskningsstatus"}),r.jsxs("select",{id:"reviewStatusSelect",value:e.reviewState||"",onChange:e=>t("reviewState",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"reviewed",children:"Granskad"}),r.jsx("option",{value:"under_review",children:"Under granskning"})]})]})]})}),r.jsxs("div",{className:"px-4 pt-4 border-t border-border text-sm text-muted-foreground flex-none sm:pb-4 pb-[env(safe-area-inset-bottom)]","aria-live":"polite",children:[i," märke(n) matchar filtren"]})]})}function Ot({currentFilters:e,onApplyPreset:n}){const{presets:s,savePreset:a,deletePreset:i,reload:l}=function(){const e="medal-app-filter-presets",[r,n]=t.useState(()=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):[]}catch(t){return console.error("Failed to load presets:",t),[]}}),s=t.useCallback(()=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):[]}catch(t){return console.error("Failed to load presets:",t),[]}},[]),a=t.useCallback(()=>{n(s())},[s]);return{presets:r,savePreset:t.useCallback((t,r)=>{try{const a=[...s(),{name:t,filters:r,createdAt:(new Date).toISOString()}];localStorage.setItem(e,JSON.stringify(a)),n(a)}catch(a){console.error("Failed to save preset:",a)}},[s]),deletePreset:t.useCallback(t=>{try{const r=s();t>=0&&t<r.length&&(r.splice(t,1),localStorage.setItem(e,JSON.stringify(r)),n(r))}catch(r){console.error("Failed to delete preset:",r)}},[s]),reload:a}}(),[o,c]=t.useState("");return r.jsxs("div",{className:"card p-4",children:[r.jsx("h3",{className:"font-bold text-foreground mb-3",children:"Filter presets"}),r.jsx("div",{className:"mb-4",children:r.jsxs("div",{className:"flex gap-2",children:[r.jsx("input",{type:"text",value:o,onChange:e=>c(e.target.value),placeholder:"Preset-namn (tex, 'Mina Favoriter')",className:"input"}),r.jsx("button",{type:"button",onClick:()=>{o.trim()&&(a(o.trim(),e),c(""),l())},disabled:!o.trim(),className:"btn btn-primary text-sm disabled:opacity-50",children:"Spara"})]})}),s.length>0&&r.jsx("div",{className:"space-y-2",children:s.map((e,t)=>r.jsxs("div",{className:"flex justify-between items-center p-3 bg-background border border-border rounded",children:[r.jsx("button",{type:"button",onClick:()=>n?.(e.filters),className:"btn btn-muted text-sm flex-1 text-left",children:e.name}),r.jsx("button",{type:"button",onClick:()=>(e=>{i(e),l()})(t),className:"btn btn-muted text-sm","aria-label":`Ta bort preset ${e.name}`,children:"Ta bort"})]},`${e.name}-${t}`))})]})}function Ut({active:e,onClick:t,children:n,ariaLabel:s,dataTour:a}){return r.jsx("button",{type:"button",onClick:t,"aria-pressed":e?"true":"false","aria-label":s,"data-tour":a,className:["inline-flex items-center px-4 py-2 rounded-full border text-sm min-h-[44px] shrink-0","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",e?"bg-primary/10 text-primary border-primary dark:bg-primary/20":"bg-transparent text-text-secondary border-border hover:bg-bg-secondary"].join(" "),children:n})}function Bt({filters:e,onToggle:t,onOpenFilters:n,activeCount:s=0,controlsId:a,className:i=""}){const l=e.status||null;return r.jsxs("div",{className:["flex items-center gap-2 overflow-x-auto py-2 min-w-0",i].join(" "),role:"toolbar","aria-label":"Snabbfilter",children:[r.jsx(Ut,{active:"unlocked"===l,onClick:()=>t("status","unlocked"),ariaLabel:"Filtrera på Upplåst",dataTour:"chip-unlocked",children:"Upplåst"}),r.jsx(Ut,{active:"eligible"===l,onClick:()=>t("status","eligible"),ariaLabel:"Filtrera på Kvalificerad",children:"Kvalificerad"}),r.jsx(Ut,{active:"available"===l,onClick:()=>t("status","available"),ariaLabel:"Filtrera på Tillgänglig",children:"Tillgänglig"}),r.jsx(Ut,{active:"locked"===l,onClick:()=>t("status","locked"),ariaLabel:"Filtrera på Låst",children:"Låst"}),r.jsx("span",{className:"mx-2 h-5 w-px bg-border shrink-0 lg:hidden","aria-hidden":"true"}),r.jsx("button",{type:"button",onClick:n,"aria-haspopup":"dialog","aria-controls":a,"data-tour":"open-filters",className:"inline-flex items-center px-4 py-2 rounded-full border text-sm min-h-[44px] shrink-0 lg:hidden\n                   bg-background text-foreground border-border hover:bg-bg-secondary\n                   focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",children:s>0?`Filter (${s})`:"Filter"})]})}function Gt({data:e,index:t,style:n}){const{medals:s,onSelect:a,statusesById:i}=e,l=s[t],o="function"==typeof l?.isPlaceholder?l.isPlaceholder():"placeholder"===l?.status,c=!o&&("function"==typeof l?.isUnderReview?l.isUnderReview():"under_review"===l?.status),d=i?.[l.id],u=d?.status??"locked",m=o?"placeholder":u,p=!o&&"unlocked"===u,f=(()=>{if(!p)return null;const e=d?.unlockedDate;if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t.getFullYear()})(),h=l.displayName||l.name,g=o?`${h} • Plats­hållare`:`${h}${c?" • Under granskning":""}${p&&f?" • Upplåst "+f:""}`;return r.jsxs("div",{role:"listitem",tabIndex:0,onClick:()=>a?.(l),onKeyDown:e=>{"Enter"===e.key&&a?.(l)},className:["flex items-center gap-3 px-3 py-2 hover:bg-bg-secondary focus-visible:bg-bg-secondary cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary",o?"bg-placeholder-subtle border-l-2 border-placeholder":""].join(" "),style:n,"aria-label":g,"data-tour":0===t?"medal-row-0":void 0,children:[r.jsxs("div",{className:"relative w-10 h-10 flex items-center justify-center rounded bg-bg-secondary flex-shrink-0","aria-hidden":"true",children:[r.jsx(pt,{status:m,className:"w-2/3 h-2/3"}),!o&&c&&r.jsx("span",{className:"pill-flag pointer-events-none","aria-hidden":"true",children:r.jsx(pt,{status:"review",className:"w-2.5 h-2.5 text-white"})})]}),r.jsx("div",{className:"min-w-0",children:r.jsxs("div",{className:"font-medium text-text-primary flex items-start gap-x-2",children:[r.jsx("span",{className:"clamp-2 min-w-0",children:h}),o&&r.jsx("span",{className:"status-badge status--placeholder",children:"Plats­hållare"})]})})]})}function Vt({height:e,itemCount:n,itemSize:s,width:a="100%",itemData:i,children:l}){const o=t.useRef(null),[c,d]=t.useState(0),u=n*s,m=Math.max(0,Math.floor(c/s)-4),p=Math.ceil(e/s)+8,f=Math.min(n,m+p),h=[];for(let t=m;t<f;t++){const e=l({index:t,style:{position:"absolute",top:t*s,height:s,width:"100%"},data:i});h.push(b.cloneElement(e,{key:t}))}return r.jsx("div",{ref:o,className:"relative overflow-y-auto",style:{height:e,width:a,WebkitOverflowScrolling:"touch"},onScroll:e=>{d(e.currentTarget.scrollTop)},role:"list","aria-label":"Medal list",children:r.jsx("div",{style:{height:u,position:"relative"},children:h})})}function zt({medals:e,onSelect:n,height:s=800,itemSize:a=72,statusesById:i}){const l=t.useMemo(()=>({medals:e,onSelect:n,statusesById:i}),[e,n,i]),o=e?.length||0,c=t.useCallback(e=>r.jsx(Gt,{...e}),[]);return r.jsx("div",{className:"border border-border rounded-md overflow-hidden",children:r.jsx(Vt,{height:s,itemCount:o,itemSize:a,width:"100%",itemData:l,children:c})})}function Kt(){const{medalDatabase:e}=ne(),n=l(),s=i(),a=ie(),[o,c]=t.useState("name"),[d,u]=t.useState(!1),m=t.useRef(null),[p,f]=x(),{currentProfile:h,hydrated:g}=se(),b=!g||void 0===h,y=Ie(),[v,w]=t.useState(600);t.useEffect(()=>{const e=()=>w(Math.max(360,Math.round(.7*window.innerHeight)));return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const j=t.useMemo(()=>e?.getAllMedals()||[],[e]),{filters:k,setFilter:N,setFilters:S,clearAllFilters:C,hasActiveFilters:M}=function(e,r={}){const[n,s]=t.useState(()=>{try{const e=localStorage.getItem($t);return{status:null,tier:null,type:null,weaponGroup:null,search:"",...(e?JSON.parse(e):null)||{},...r}}catch{return{status:null,tier:null,type:null,weaponGroup:null,search:"",...r}}});t.useEffect(()=>{try{localStorage.setItem($t,JSON.stringify(n))}catch{}},[n]);const a=t.useMemo(()=>Array.isArray(e)?e.filter(e=>{if(n.tier&&e.tier!==n.tier)return!1;if(n.type&&e.type!==n.type)return!1;if(n.weaponGroup&&e.weaponGroup!==n.weaponGroup)return!1;if(n.search){const t=n.search.toLowerCase();if(!((e.displayName||"").toLowerCase().includes(t)||(e.name||"").toLowerCase().includes(t)||(e.type||"").toLowerCase().includes(t)))return!1}return!0}):[],[e,n]),i=t.useCallback((e,t)=>{s(r=>({...r,[e]:t}))},[]),l=t.useCallback(e=>{s(t=>({...t,...e||{}}))},[]),o=t.useCallback(()=>{s({status:null,tier:null,type:null,weaponGroup:null,search:""})},[]),c=t.useMemo(()=>Object.values(n).some(e=>null!==e&&""!==e),[n]);return{filters:n,filteredMedals:a,setFilter:i,setFilters:l,clearAllFilters:o,hasActiveFilters:c}}(j),{query:A,setQuery:I,suggestions:D}=function(e=[]){const[r,n]=t.useState(""),s=t.useMemo(()=>e.map(e=>({ref:e,haystack:qt([e.displayName||e.name||"",e.type||e.medals_type||"",e.tier||"",e.id].filter(Boolean).join(" "))})),[e]),a=t.useMemo(()=>{const t=qt(r).trim();return t?s.filter(e=>e.haystack.includes(t)).map(e=>e.ref):e},[s,r,e]),i=t.useMemo(()=>{if(!qt(r).trim())return[];const e=new Set;for(const t of a.slice(0,10)){const r=t.displayName||t.name;r&&!e.has(r)&&e.add(r)}return Array.from(e)},[a,r]);return{query:r,setQuery:n,results:a,suggestions:i}}(j);t.useEffect(()=>{const e=e=>{if("/"===e.key&&!e.metaKey&&!e.ctrlKey&&!e.altKey){const t=(document.activeElement?.tagName||"").toLowerCase();"input"!==t&&"textarea"!==t&&(e.preventDefault(),m.current?.focus())}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),t.useEffect(()=>{const e=e=>{const t=p.get(e);return t&&t.length?t:null},t={status:e("status"),type:e("type"),tier:e("tier"),weaponGroup:e("weaponGroup"),reviewState:e("reviewState")},r=e("search")||"",n=e("sort")||"name",s=Object.fromEntries(Object.entries(t).filter(([,e])=>null!=e));Object.keys(s).length&&S(s),r&&(I(r),N("search",r)),c(n)},[]),t.useEffect(()=>{const e=new URLSearchParams;k.status&&e.set("status",k.status),k.type&&e.set("type",k.type),k.tier&&e.set("tier",k.tier),k.weaponGroup&&e.set("weaponGroup",k.weaponGroup),k.reviewState&&e.set("reviewState",k.reviewState),A&&e.set("search",A),o&&"name"!==o&&e.set("sort",o);e.toString()!==p.toString()&&f(e,{replace:!0})},[k,A,o,f,p]);const P=t.useMemo(()=>[...new Set(j.map(e=>e.type))].filter(Boolean),[j]),T=t.useMemo(()=>[...new Set(j.map(e=>e.tier))].filter(Boolean),[j]),E=t.useMemo(()=>Object.entries(k).reduce((e,[t,r])=>"search"!==t&&r?e+1:e,0),[k]),_=t.useCallback((e,t)=>{N(e,k[e]===t?null:t)},[k,N]),F=t.useMemo(()=>{const e=Object.create(null);if(!a)return e;const t=(t,r)=>{(t||[]).forEach(t=>{e[t.medalId]={...t,status:r}})};return t(a.locked,"locked"),t(a.available,"available"),t(a.eligible,"eligible"),t(a.unlocked,"unlocked"),e},[a]),$=t.useMemo(()=>{const e={...k,search:A},t=function(e,t,r={}){if(!Array.isArray(e))return[];const n=(r.search||"").toLowerCase();return e.filter(e=>{const s=Lt(e.id,t);if(r.status&&s!==r.status)return!1;if(r.tier&&e.tier!==r.tier)return!1;if(r.type&&e.type!==r.type)return!1;if(r.weaponGroup&&e.weaponGroup!==r.weaponGroup)return!1;const a=!0!==e.reviewed;return("reviewed"!==r.reviewState||!a)&&(!("under_review"===r.reviewState&&!a)&&!(n&&!((e.displayName||"").toLowerCase().includes(n)||(e.name||"").toLowerCase().includes(n)||(e.type||"").toLowerCase().includes(n))))})}(j,a,e);return function(e,t="name",r){const n=Array.isArray(e)?[...e]:[];switch(t){case"name":return n.sort((e,t)=>(e.displayName||"").localeCompare(t.displayName||""));case"type":return n.sort((e,t)=>(e.type||"").localeCompare(t.type||""));case"tier":{const e={bronze:0,silver:1,gold:2,star_1:3,star_2:4,star_3:5};return n.sort((t,r)=>(e[t.tier]??99)-(e[r.tier]??99))}case"status":{const e={unlocked:0,eligible:1,available:2,locked:3};return n.sort((t,n)=>(e[Lt(t.id,r)]??99)-(e[Lt(n.id,r)]??99))}default:return n}}(t,o,a)},[j,a,k,A,o]),q=t.useMemo(()=>$.some(e=>!0!==e.reviewed),[$]),L=t.useCallback(()=>{if(y?.open)return;(M||""!==A||"name"!==o||d)&&(C(),I(""),N("search",""),c("name"),u(!1)),y.start("medals")},[y,M,A,o,d,C,I,N]);return t.useEffect(()=>{if(b)return;if("/medals"!==s.pathname)return;if(y?.open)return;let e=null;try{e=sessionStorage.getItem(be)}catch{e=null}if("medals"===e){try{sessionStorage.removeItem(be)}catch{}L()}},[b,s.pathname,y,L]),t.useEffect(()=>{if(!b&&"/medals"===s.pathname&&!y?.open){try{if("medals"===sessionStorage.getItem(be))return}catch{}if(y?.canAutoStart?.()){if(_t()){const e=Tt();if(Et()!==e)return}L()}}},[b,s.pathname,y,L]),b?null:e?r.jsxs("div",{className:"space-y-6",children:[r.jsx(Dt,{idPrefix:"medals-list",promptId:"profile-picker-medals-list"}),r.jsxs("div",{className:"flex flex-col lg:flex-row lg:justify-between lg:items-center gap-3",children:[r.jsxs("div",{className:"flex items-baseline gap-3 flex-wrap",children:[r.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Märken"}),r.jsx("button",{type:"button",onClick:L,className:"text-sm underline hover:no-underline text-muted-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded",children:"Visa guide"})]}),r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsxs("div",{className:"text-sm text-muted-foreground","aria-live":"polite",children:[$.length," märken",M&&r.jsxs(r.Fragment,{children:[" · ",r.jsx("button",{type:"button",className:"underline hover:no-underline",onClick:C,children:"Rensa filter"})]}),q&&r.jsxs(r.Fragment,{children:[" · ",r.jsx("span",{className:"hidden lg:inline",role:"note","aria-label":"Teckenförklaring",children:r.jsx(ft,{})})]})]}),r.jsxs("select",{value:o,onChange:e=>c(e.target.value),className:"select hidden lg:block","aria-label":"Sortera",children:[r.jsx("option",{value:"name",children:"Sortera på namn"}),r.jsx("option",{value:"type",children:"Sortera på typ"}),r.jsx("option",{value:"tier",children:"Sortera på valör"}),r.jsx("option",{value:"status",children:"Sortera på status"})]})]})]}),r.jsx(Yt,{value:A,onChange:e=>{I(e),N("search",e)},suggestions:D,onSuggestionSelect:e=>{I(e),N("search",e)},inputRef:m,placeholder:"Sök märken... (klicka / för fokus)"}),r.jsx("div",{className:"flex items-center gap-2",children:r.jsx(Bt,{className:"flex-1 min-w-0",filters:k,onToggle:(e,t)=>_(e,t),onOpenFilters:()=>u(!0),activeCount:E,controlsId:"mobile-filters-sheet"})}),r.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[r.jsxs("div",{className:"hidden lg:block lg:col-span-1 space-y-4",children:[r.jsx(Rt,{filters:k,onFilterChange:N,medalTypes:P,tiers:T,hasActiveFilters:M,resultCount:$.length,onClearAll:C,sortBy:o,onSortChange:c}),r.jsx(Ot,{currentFilters:k,onApplyPreset:e=>S(e)})]}),r.jsx(Ne,{id:"mobile-filters-sheet",title:"Filter",open:d,onClose:()=>u(!1),swipeToDismiss:!0,children:r.jsx(Rt,{filters:k,onFilterChange:N,medalTypes:P,tiers:T,hasActiveFilters:M,resultCount:$.length,onClearAll:()=>{C(),u(!1)},sortBy:o,onSortChange:c})}),r.jsx("div",{className:"lg:col-span-3",children:0===$.length?r.jsx("div",{className:"card p-6 text-center",children:r.jsx("p",{className:"text-muted-foreground",children:"Inga märken matchar dina filter"})}):r.jsx("div",{className:"border border-border rounded-md overflow-hidden",role:"region","aria-label":"Märkes-resultat",children:r.jsx(zt,{medals:$,height:v,itemSize:60,onSelect:e=>n(`/medals/${e.id}`,{state:{backgroundLocation:s}}),statusesById:F})})})]}),q&&r.jsx("div",{className:"mt-4 lg:hidden",role:"note","aria-label":"Teckenförklaring",children:r.jsx(ft,{})})]}):r.jsx("div",{className:"text-muted-foreground",children:"Laddar märken..."})}function Ht({feature:e,children:n,variant:s="auto"}){const a=de?.[e]||{},i=a.title||"Feature i utveckling",l=a.message||`Den här funktionen (“${e}”) visas som förhandsvisning.`,o="auto"===s?a.overlay||"auto":s,c=t.useRef(null),[d,u]=t.useState(!1);t.useEffect(()=>{if("auto"!==o)return;const e=c.current;if(!e||"undefined"==typeof ResizeObserver)return;const t=new ResizeObserver(t=>{const r=t[0]?.contentRect||e.getBoundingClientRect();u(r.width<420||r.height<160)});return t.observe(e),()=>t.disconnect()},[o]);const m="auto"===o?d?"inline":"panel":o;return r.jsxs("div",{ref:c,className:"relative isolate",children:[r.jsx("div",{className:"pointer-events-none opacity-60 [filter:blur(2px)]","aria-hidden":"true",inert:"",children:n}),"panel"===m?r.jsx("div",{role:"note","aria-label":"Feature preview","aria-live":"polite",className:"absolute inset-0 z-10 grid place-items-center bg-black/40 backdrop-blur-sm",children:r.jsx("div",{className:"w-[min(92vw,36rem,calc(100%-1rem))] max-w-none mx-4 rounded-xl border border-border bg-bg-secondary/95 p-4 shadow-lg text-foreground",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(Se,{name:"FlaskConical",className:"w-5 h-5","aria-hidden":"true",style:{color:"var(--color-info)"}}),r.jsxs("div",{children:[r.jsx("div",{className:"font-semibold leading-5 text-balance",children:i}),r.jsx("div",{className:"mt-1 text-sm text-muted-foreground text-pretty break-words",children:l})]})]})})}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"absolute inset-0 z-10 bg-black/30 backdrop-blur-[1.5px]","aria-hidden":"true"}),r.jsx("div",{className:"absolute inset-0 z-20 grid place-items-center",children:r.jsx("div",{role:"note","aria-label":"Feature preview",className:"mx-2 w-[min(92vw,calc(100%-1rem),28rem)] rounded-lg border border-border bg-bg-secondary/95 p-3 shadow-md text-foreground",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(Se,{name:"FlaskConical",className:"w-4 h-4","aria-hidden":"true",style:{color:"var(--color-info)"}}),r.jsxs("p",{className:"text-sm leading-5 text-pretty break-words",children:[r.jsxs("span",{className:"font-semibold",children:[i,":"]})," ",r.jsx("span",{className:"text-muted-foreground",children:l})]})]})})})]})]})}function Wt({name:e,mode:n="preview",fallback:s=null,className:a,style:i,children:l}){const{state:o}=function(e){const r=t.useContext(ue),n=r?.get(e)??"off";return{state:n,enabled:"on"===n||"preview"===n}}(e);return"off"===o?s:"preview"===o?"hide"===n?s:r.jsx("div",{className:a,style:i,children:r.jsx(Ht,{feature:e,children:l})}):r.jsx("div",{className:a,style:i,children:l})}const Xt=(new Date).getFullYear();function Jt({open:e,onClose:n,initialRow:s,onSave:a,mode:i="batch",submitLabel:l,WG:o=["A","B","C","R"],DISCIPLINE_TYPES:c=["field","precision","military_fast"],COMP_TYPES:d=["national","regional/landsdels","crewmate/krets","championship"],MEDAL_TYPES:u=["bronze","silver","gold"],APP_TIME_OPTIONS:m=[{value:60,label:"60, Brons"},{value:40,label:"40, Silver"},{value:17,label:"17, Guld A/R"},{value:15,label:"15, Guld B/C"}],COMP_DISCIPLINE_TYPES:p=["national_whole_match","military_fast_match","ppc"],PPC_CLASS_SUGGESTIONS:f=["R1500","P1500","Open","SSA",'SR 4"','SR 2,75"',"Dist pistol","Dist revolver"]}){const h=t.useMemo(()=>e?JSON.stringify(s??{}):"closed",[e,s]);return r.jsx(Ne,{id:"batch-row-editor",title:"Aktivitet",open:e,onClose:n,swipeToDismiss:!0,children:e?r.jsx(Wt,{name:"achievementEntry",children:r.jsx(Zt,{initialRow:s,onSave:a,onClose:n,mode:i,submitLabel:l,WG:o,DISCIPLINE_TYPES:c,COMP_TYPES:d,MEDAL_TYPES:u,APP_TIME_OPTIONS:m,COMP_DISCIPLINE_TYPES:p,PPC_CLASS_SUGGESTIONS:f},h)}):null})}function Zt({initialRow:e,onSave:n,onClose:s,mode:a="batch",submitLabel:i,WG:l,DISCIPLINE_TYPES:o,COMP_TYPES:c,MEDAL_TYPES:d,APP_TIME_OPTIONS:u,COMP_DISCIPLINE_TYPES:m,PPC_CLASS_SUGGESTIONS:p}){const[f,h]=t.useState(()=>e||{}),[g,b]=t.useState({}),x=!("competition_result"===f.type&&"ppc"===String(f.disciplineType||"").toLowerCase()),y=(e,t)=>h(r=>({...r,[e]:t})),v=t.useMemo(()=>e=>{const t=[],r={},n=Number(e.year);switch((!Number.isFinite(n)||n<1900||n>Xt)&&(t.push(`Året måste vara mellan 1900 och ${Xt}`),r.year=!0),l.includes(e.weaponGroup)||(t.push("Ogiltig grupp (A, B, C, R)"),r.weaponGroup=!0),e.type){case"precision_series":{const n=Number(e.points);(!Number.isFinite(n)||n<0||n>50)&&(t.push("Poäng måste vara 0-50"),r.points=!0);break}case"application_series":{const n=new Date(e.date);if(!e.date||Number.isNaN(n.getTime()))t.push("Ogiltigt datum"),r.date=!0;else{const e=new Date;e.setHours(0,0,0,0),n.setHours(0,0,0,0),n.getTime()>e.getTime()&&(t.push("Datum kan inte vara i framtiden"),r.date=!0)}const s=u.map(e=>e.value),a=Number(e.timeSeconds);Number.isFinite(a)&&s.includes(a)||(t.push("Välj giltig tid"),r.timeSeconds=!0);const i=Number(e.hits);(!Number.isFinite(i)||i<0)&&(t.push("Ange giltigt antal träffar"),r.hits=!0);break}case"competition_result":{const n=String(e.competitionType||"").toLowerCase(),s=String(e.disciplineType||"").toLowerCase(),a=Number(e.score);c.includes(n)||(t.push("Välj giltig tävlingstyp"),r.competitionType=!0),m.includes(s)||(t.push("Välj giltig gren"),r.disciplineType=!0),Number.isFinite(a)||(t.push("Poäng måste vara ett tal"),r.score=!0),"ppc"!==s||String(e.ppcClass||"").trim()||(t.push("Välj PPC-klass"),r.ppcClass=!0);break}}return{errs:t,fields:r}},[l,c,u,m]),w=(e=!1)=>{const{errs:t,fields:r}=v(f);if(t.length)b({list:t,fields:r});else if(n?.(f,{addAnother:e}),e){const e={year:f.year,weaponGroup:f.weaponGroup,type:f.type,date:(new Date).toISOString().slice(0,10),timeSeconds:"",hits:"",points:"",competitionType:"",medalType:"",disciplineType:"",ppcClass:"",competitionName:"",weapon:"",score:"",teamName:"",position:"",participants:"",eventName:"",notes:""};h(e),b({})}else s?.()};return r.jsxs("form",{onSubmit:e=>{e.preventDefault(),w(!1)},className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{className:["grid gap-3",x?"grid-cols-2":"grid-cols-1"].join(" "),children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-year",className:"field-label mb-2",children:"År"}),r.jsx("input",{id:"br-year",type:"number",min:"1900",max:Xt,className:"input py-3",value:f.year??Xt,onChange:e=>y("year",Number(e.target.value)),"aria-invalid":g.fields?.year||void 0})]}),x&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-group",className:"field-label mb-2",children:"Grupp"}),r.jsx("select",{id:"br-group",className:"select py-3",value:f.weaponGroup??"A",onChange:e=>y("weaponGroup",e.target.value),"aria-invalid":g.fields?.weaponGroup||void 0,children:l.map(e=>r.jsx("option",{value:e,children:e},e))})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-type",className:"field-label mb-2",children:"Type"}),r.jsxs("select",{id:"br-type",className:"select py-3",value:f.type||"precision_series",onChange:e=>y("type",e.target.value),children:[r.jsx("option",{value:"precision_series",children:"Precisionsserier"}),r.jsx("option",{value:"application_series",children:"Tillämpningsserier"}),r.jsx("option",{value:"standard_medal",children:"Standardmedalj"}),r.jsx("option",{value:"competition_result",children:"Tävlingsresultat"}),r.jsx("option",{value:"qualification_result",children:"Kvalificering"}),r.jsx("option",{value:"team_event",children:"Lag-eventt"}),r.jsx("option",{value:"event",children:"Event"}),r.jsx("option",{value:"custom",children:"Custom"})]})]}),"precision_series"===f.type&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-points",className:"field-label mb-2",children:"Poäng (0-50)"}),r.jsx("input",{id:"br-points",type:"number",min:"0",max:"50",className:"input py-3",value:f.points??"",onChange:e=>y("points",e.target.value),"aria-invalid":g.fields?.points||void 0})]}),"application_series"===f.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{id:"br-date",type:"date",className:"input py-3",value:f.date??(new Date).toISOString().slice(0,10),onChange:e=>y("date",e.target.value),"aria-invalid":g.fields?.date||void 0})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-time",className:"field-label mb-2",children:"Tid"}),r.jsxs("select",{id:"br-time",className:"select py-3",value:""===f.timeSeconds?"":Number(f.timeSeconds),onChange:e=>y("timeSeconds",""===e.target.value?"":Number(e.target.value)),"aria-invalid":g.fields?.timeSeconds||void 0,children:[r.jsx("option",{value:"",children:"Select time…"}),u.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-hits",className:"field-label mb-2",children:"Hits"}),r.jsx("input",{id:"br-hits",type:"number",min:"0",className:"input py-3",value:f.hits??"",onChange:e=>y("hits",e.target.value),"aria-invalid":g.fields?.hits||void 0})]})]}),"standard_medal"===f.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ctype",className:"field-label mb-2",children:"Gren"}),r.jsxs("select",{id:"br-ctype",className:"select py-3",value:f.disciplineType??"",onChange:e=>y("disciplineType",e.target.value),children:[r.jsx("option",{value:"",children:"Välj disciplin..."}),o.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-mtype",className:"field-label mb-2",children:"Medalj"}),r.jsxs("select",{id:"br-mtype",className:"select py-3",value:f.medalType??"",onChange:e=>y("medalType",e.target.value),children:[r.jsx("option",{value:"",children:"Välj medalj..."}),d.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-cname",className:"field-label mb-2",children:"Namn (valfritt)"}),r.jsx("input",{id:"br-cname",type:"text",className:"input py-3",value:f.competitionName??"",onChange:e=>y("competitionName",e.target.value)})]})]}),"competition_result"===f.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ctype",className:"field-label mb-2",children:"Tävlingstyp"}),r.jsxs("select",{id:"br-ctype",className:"select py-3",value:f.competitionType??"",onChange:e=>y("competitionType",e.target.value),"aria-invalid":g.fields?.competitionType||void 0,children:[r.jsx("option",{value:"",children:"Select type…"}),c.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-disc",className:"field-label mb-2",children:"Gren"}),r.jsxs("select",{id:"br-disc",className:"select py-3",value:f.disciplineType??"",onChange:e=>y("disciplineType",e.target.value),"aria-invalid":g.fields?.disciplineType||void 0,children:[r.jsx("option",{value:"",children:"Välj gren…"}),m.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),"ppc"===String(f.disciplineType||"")&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ppc",className:"field-label mb-2",children:"PPC-klass"}),r.jsx("input",{id:"br-ppc",type:"text",className:"input py-3",list:"ppc-classes",value:f.ppcClass??"",onChange:e=>y("ppcClass",e.target.value),placeholder:"t.ex. R1500","aria-invalid":g.fields?.ppcClass||void 0}),r.jsx("datalist",{id:"ppc-classes",children:p.map(e=>r.jsx("option",{value:e},e))})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-score",className:"field-label mb-2",children:"Poäng"}),r.jsx("input",{id:"br-score",type:"number",className:"input py-3",value:f.score??"",onChange:e=>y("score",e.target.value),"aria-invalid":g.fields?.score||void 0})]}),r.jsxs("div",{className:"md:col-span-2",children:[r.jsx("label",{htmlFor:"br-cname",className:"field-label mb-2",children:"Namn (valfritt)"}),r.jsx("input",{id:"br-cname",type:"text",className:"input py-3",value:f.competitionName??"",onChange:e=>y("competitionName",e.target.value)})]})]}),"qualification_result"===f.type&&r.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-weapon",className:"field-label mb-2",children:"Vapen"}),r.jsx("input",{id:"br-weapon",type:"text",className:"input py-3",value:f.weapon??"",onChange:e=>y("weapon",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-score",className:"field-label mb-2",children:"Poäng"}),r.jsx("input",{id:"br-score",type:"number",className:"input py-3",value:f.score??"",onChange:e=>y("score",e.target.value)})]})]}),"team_event"===f.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-team",className:"field-label mb-2",children:"Lag"}),r.jsx("input",{id:"br-team",type:"text",className:"input py-3",value:f.teamName??"",onChange:e=>y("teamName",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-pos",className:"field-label mb-2",children:"Placering"}),r.jsx("input",{id:"br-pos",type:"number",min:"1",className:"input py-3",value:f.position??"",onChange:e=>y("position",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-part",className:"field-label mb-2",children:"Deltagare"}),r.jsx("input",{id:"br-part",type:"text",className:"input py-3",placeholder:"Anna, Björn, Carin",value:f.participants??"",onChange:e=>y("participants",e.target.value)})]})]}),("event"===f.type||"custom"===f.type)&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ename",className:"field-label mb-2",children:"Titel"}),r.jsx("input",{id:"br-ename",type:"text",className:"input py-3",value:f.eventName??"",onChange:e=>y("eventName",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-notes",className:"field-label mb-2",children:"Anteckningar (valfritt)"}),r.jsx("textarea",{id:"br-notes",className:"textarea py-3 resize-none",rows:3,value:f.notes??"",onChange:e=>y("notes",e.target.value)})]}),g.list?.length?r.jsx("div",{role:"alert",className:"alert alert-error text-sm",children:g.list.join(", ")}):null,"batch"===a?r.jsxs("div",{className:"flex gap-2 justify-end pt-2",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:s,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-muted",onClick:()=>w(!0),children:"Lägg till & lägg till en till"}),r.jsx("button",{type:"submit",className:"btn btn-primary",children:"Lägg till batch"})]}):r.jsxs("div",{className:"flex gap-2 justify-end pt-2",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:s,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary",children:i||"Spara"})]})]})}function Qt({row:e,index:t,onEdit:n,onRemove:s}){const a=(()=>{switch(e.type){case"precision_series":return`Points: ${e.points??"—"}`;case"application_series":return`Time: ${e.timeSeconds??"—"} • Hits: ${e.hits??"—"}`;case"standard_medal":return`${e.disciplineType||"—"} • ${e.medalType||"—"}`;case"competition_result":return`${e.competitionType||"—"} • ${e.medalType||"—"}`;case"qualification_result":return`Weapon: ${e.weapon||"—"} • Score: ${e.score||"—"}`;case"team_event":return`Team: ${e.teamName||"—"} • Pos: ${e.position||"—"}`;default:return`${e.eventName||"—"}`}})();return r.jsxs("div",{className:"card p-4 flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsxs("div",{className:"font-medium text-foreground",children:[e.type.replace(/_/g," ")," • ",e.year," • Grupp ",e.weaponGroup]}),r.jsx("div",{className:"text-sm text-muted-foreground",children:a}),e.notes?r.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"Anteckningar"}):null]}),r.jsxs("div",{className:"flex gap-2 shrink-0",children:[r.jsx("button",{type:"button",onClick:()=>n?.(t),className:"btn btn-muted h-10 px-3","aria-label":`Ändra rad ${t+1}`,children:"Ändra"}),r.jsx("button",{type:"button",onClick:()=>s?.(t),className:"btn btn-muted h-10 px-3 text-red-600","aria-label":`Ta bort rad ${t+1}`,children:"Ta bort"})]})]})}class er{constructor(e){this.id=e.id||`achievement-${Date.now()}`,this.type=e.type,this.medalId=e.medalId,this.date=e.date;const t="number"==typeof e.year&&Number.isFinite(e.year),r=this.date?new Date(this.date).getFullYear():void 0;this.year=t?e.year:Number.isFinite(r)?r:void 0,this.weaponGroup=e.weaponGroup||"A",this.points="number"==typeof e.points?e.points:null!=e.points&&""!==e.points?Number(e.points):void 0,this.disciplineType=e.disciplineType,this.competitionType=e.competitionType,this.medalType=e.medalType,this.ppcClass=e.ppcClass,this.competitionName=e.competitionName||"",this.notes=e.notes||"",this.score="number"==typeof e.score?e.score:null!=e.score&&""!==e.score?Number(e.score):void 0,this.weapon=e.weapon,this.teamName=e.teamName,this.position="number"==typeof e.position?e.position:null!=e.position&&""!==e.position?Number(e.position):void 0,this.participants=Array.isArray(e.participants)?e.participants:"string"==typeof e.participants?e.participants.split(",").map(e=>e.trim()).filter(Boolean):void 0,this.eventName=e.eventName,this.timeSeconds="number"==typeof e.timeSeconds?e.timeSeconds:null!=e.timeSeconds&&""!==e.timeSeconds?Number(e.timeSeconds):void 0,this.hits="number"==typeof e.hits?e.hits:null!=e.hits&&""!==e.hits?Number(e.hits):void 0}}function tr(){const{currentProfile:e,addAchievement:r,updateAchievement:n,removeAchievement:s,unlockMedal:a}=se(),{pushState:i,undo:l,redo:o,canUndo:c,canRedo:d,history:u,historyIndex:m}=function(){const e=t.useContext(oe);if(!e)throw new Error("useUndoRedo must be used within UndoRedoProvider");return e}(),p=t.useCallback(()=>(e?.prerequisites||[]).map(e=>({...e})),[e]),f=t.useCallback(()=>{i({type:"achievements",data:p()})},[i,p]),h=t.useCallback(async t=>{if(!e)return;const a=(e.prerequisites||[]).map(e=>({...e})),i=new Map(a.map(e=>[e.id,e])),l=new Map(t.map(e=>[e.id,e]));for(const e of a)if(!l.has(e.id)&&"function"==typeof s)try{await s(e.id)}catch{}for(const e of t)if(!i.has(e.id)&&"function"==typeof r)try{await r(new er(e))}catch{}for(const e of t){const t=i.get(e.id);if(!t)continue;if(["type","year","weaponGroup","points","date","competitionName","notes","timeSeconds","hits"].some(r=>String(t[r]??"")!==String(e[r]??""))&&"function"==typeof n)try{await n(new er(e))}catch{}}},[r,s,n,e]),g=t.useCallback(async(t=[])=>{if(!t.length||!e)return 0;let n=0;const s=[],a=e=>""===e||null==e?void 0:Number(e);for(let e=0;e<t.length;e++){const l=t[e],o=new er({id:l.id,type:l.type,year:Number(l.year),weaponGroup:l.weaponGroup,date:l.date||(new Date).toISOString().slice(0,10),competitionName:l.competitionName||"",notes:l.notes||"",points:"precision_series"===l.type?a(l.points):void 0,disciplineType:"standard_medal"===l.type||"competition_result"===l.type?l.disciplineType||"":void 0,medalType:"standard_medal"===l.type?l.medalType||"":void 0,competitionType:"competition_result"===l.type?l.competitionType||"":void 0,ppcClass:"competition_result"===l.type?l.ppcClass||"":void 0,score:"competition_result"===l.type||"qualification_result"===l.type?a(l.score):void 0,weapon:"qualification_result"===l.type?l.weapon||"":void 0,teamName:"team_event"===l.type?l.teamName||"":void 0,position:"team_event"===l.type?a(l.position):void 0,participants:"team_event"===l.type?Array.isArray(l.participants)?l.participants:String(l.participants||"").split(",").map(e=>e.trim()).filter(Boolean):void 0,eventName:"event"===l.type||"custom"===l.type?l.eventName||"":void 0,timeSeconds:"application_series"===l.type?Number(l.timeSeconds):void 0,hits:"application_series"===l.type?""===l.hits||null==l.hits?void 0:Number(l.hits):void 0});if("function"==typeof r)try{await r(o),n++}catch(i){s.push({index:e,message:i?.message||"Failed to add achievement"}),console.error("addMany: add failed",{index:e+1,error:i,achievement:o})}}if(n>0)return f(),n;if(s.length>0){const e=s.map(e=>`Row ${e.index+1}: ${e.message}`).join(" | ");throw new Error(e)}return 0},[r,e,f]),b=t.useCallback(async t=>{if(!e)return!1;const r=t instanceof er?t:new er({...t,id:t?.id});if(!r?.id)return!1;try{return await n(r),f(),!0}catch(s){return console.error("updateAchievement failed",{error:s,payload:r}),!1}},[e,n,f]),x=t.useCallback(async t=>{if(!e||!t)return!1;let r=!1;if("function"==typeof s)try{await s(t),r=!0}catch(n){console.error("removeAchievement failed",{error:n,achievementId:t})}return r&&f(),r},[e,s,f]),y=t.useCallback(async()=>{const e=l();if(null==e)return!1;const t=u[e];return"achievements"===t?.type&&(await h(t.data),!0)},[l,u,h]),v=t.useCallback(async()=>{const e=o();if(null==e)return!1;const t=u[e];return"achievements"===t?.type&&(await h(t.data),!0)},[o,u,h]);t.useEffect(()=>{const e=e=>{(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey)&&("z"===e.key.toLowerCase()?(e.preventDefault(),y()):"y"===e.key.toLowerCase()&&(e.preventDefault(),v()))};return window.addEventListener("keydown",e,{passive:!1}),()=>window.removeEventListener("keydown",e)},[y,v]);const w=t.useCallback(async t=>{if(!e||!t)return!1;const n=t instanceof er?t:new er(t);if("function"!=typeof r)return!1;try{return await r(n),f(),!0}catch(s){return console.error("addAchievement failed",{error:s,achievement:n}),!1}},[e,r,f]),j=b,k=x;return{achievements:e?.prerequisites||[],addMany:g,addAchievement:w,updateAchievement:j,removeAchievement:k,unlockMedal:a,updateOne:b,removeOne:x,undoAchievements:y,redoAchievements:v,canUndo:c,canRedo:d,historyIndex:m}}const rr=["A","B","C","R"],nr=["national","regional/landsdels","crewmate/krets","championship"],sr=["field","precision","military_fast"],ar=["national_whole_match","military_fast_match","ppc"],ir=["R1500","P1500","Open","SSA",'SR 4"','SR 2,75"',"Dist pistol","Dist revolver"],lr=["bronze","silver","gold"],or=[{value:60,label:"60, Brons"},{value:40,label:"40, Silver"},{value:17,label:"17, Guld A/R"},{value:15,label:"15, Guld B/C"}],cr=(new Date).getFullYear(),dr=()=>({year:cr,weaponGroup:"A",type:"precision_series",date:(new Date).toISOString().slice(0,10),timeSeconds:"",hits:"",points:"",competitionType:"",medalType:"",disciplineType:"",competitionName:"",weapon:"",score:"",ppcClass:"",teamName:"",position:"",participants:"",eventName:"",notes:""});function ur(){const{addMany:e}=tr(),[n,s]=t.useState([dr()]),[a,i]=t.useState(!1),[l,o]=t.useState(-1),[c,d]=t.useState({}),[u,m]=t.useState(0),[p,f]=t.useState(!1),[h,g]=t.useState([]),b=(e,t,r)=>{const a=[...n];a[e]={...a[e],[t]:r},s(a)},x=e=>{o(e),i(!0)},y=e=>{s(n.filter((t,r)=>r!==e))};return r.jsx(Wt,{name:"achievementEntry",children:r.jsxs("div",{className:"card p-6",children:[r.jsx("h2",{className:"text-xl font-bold mb-2 text-text-primary",children:"Lägg till aktiviteter i batch"}),r.jsx("p",{id:"batch-type-help",className:"text-sm text-text-secondary mb-4",children:"Batcher stödjer precisionsserier och tillämpningsserier. För att lägga till övriga, logga dem på ett märkeskort."}),u>0&&r.jsx("div",{role:"status","aria-live":"polite",className:"alert alert-success mb-4",children:r.jsxs("p",{children:["✓ Lyckades lägga till ",u," aktivitet(er)"]})}),h.length>0&&r.jsxs("div",{role:"alert",className:"alert alert-warning mb-4",children:[r.jsx("p",{className:"font-medium mb-1",children:"Möjliga duplikat:"}),r.jsx("ul",{className:"list-disc list-inside text-muted-foreground text-sm",children:h.map((e,t)=>r.jsx("li",{children:e},t))})]}),c.form&&r.jsx("div",{role:"alert",className:"alert alert-error mb-4",children:r.jsx("p",{children:c.form})}),r.jsxs("div",{className:"sm:hidden space-y-3 mb-4",children:[n.map((e,t)=>r.jsx(Qt,{row:e,index:t,onEdit:x,onRemove:y},t)),r.jsx("div",{className:"sticky bottom-0 safe-bottom pt-2 bg-transparent",children:r.jsx("button",{type:"button",onClick:()=>{o(-1),i(!0)},className:"btn btn-primary w-full min-h-[44px]","aria-label":"Add achievement",children:"+ Lägg till"})})]}),r.jsxs("form",{onSubmit:async t=>{t.preventDefault();const r={},a=[];if(n.forEach((e,t)=>{const n=[],s={},i=Number(e.year);switch((!Number.isFinite(i)||i<2e3||i>cr)&&(n.push(`Året måste vara mellan 2000 och ${cr}`),s.year=!0),rr.includes(e.weaponGroup)||(n.push("Ogiltig grupp (A, B, C, R)"),s.weaponGroup=!0),e.type){case"precision_series":{const t=Number(e.points);(!Number.isFinite(t)||t<0||t>50)&&(n.push("Poäng måste vara mellan 0-50"),s.points=!0);break}case"application_series":{const t=new Date(e.date);if(!e.date||Number.isNaN(t.getTime()))n.push("Ogiltigt datum"),s.date=!0;else{const e=new Date;e.setHours(0,0,0,0),t.setHours(0,0,0,0),t.getTime()>e.getTime()&&(n.push("Datum kan inte vara i framtiden"),s.date=!0)}const r=[60,40,17,15],a=Number(e.timeSeconds);Number.isFinite(a)&&r.includes(a)||(n.push("Välj giltig tid"),s.timeSeconds=!0);const i=Number(e.hits);(!Number.isFinite(i)||i<0)&&(n.push("Ange giltigt antal träffar"),s.hits=!0);break}case"competition_result":{const t=String(e.competitionType||"").toLowerCase(),r=String(e.disciplineType||"").toLowerCase(),a=Number(e.score);nr.includes(t)||(n.push("Välj giltig tävlingstyp"),s.competitionType=!0),ar.includes(r)||(n.push("Välj giltig gren"),s.disciplineType=!0),Number.isFinite(a)||(n.push("Poäng måste vara ett tal"),s.score=!0),"ppc"!==r||String(e.ppcClass||"").trim()||(n.push("Välj PPC-klass"),s.ppcClass=!0);break}}n.length?r[t]={list:n,fields:s}:a.push(e)}),Object.keys(r).length)return void d(r);const i=function(e){const t=new Set,r=[];return e.forEach(e=>{if(!e)return;if("application_series"===e.type)return;let n;n="precision_series"===e.type?`${e.year}-${e.type}-${e.weaponGroup}-${e.points}`:"competition_result"===e.type?`${e.year}-${e.type}-${e.weaponGroup}-${e.disciplineType||""}-${e.date||""}-${e.score??""}`:`${e.year}-${e.type}-${e.weaponGroup}`,t.has(n)&&r.push(n),t.add(n)}),r}(a.filter(e=>"precision_series"===e.type));g(i);try{f(!0);const t=await e(a);t>0?(m(t),s([dr()]),d({}),setTimeout(()=>m(0),3e3)):d({form:"Inga aktiviteter blev tillagda. Granska din input."})}catch(l){d({form:l.message})}finally{f(!1)}},children:[r.jsx("div",{className:"hidden sm:block overflow-x-auto mb-4",children:r.jsxs("table",{className:"w-full text-sm text-foreground table-fixed",children:[r.jsxs("colgroup",{children:[r.jsx("col",{className:"w-[7rem]"}),r.jsx("col",{className:"w-[12rem]"}),r.jsx("col",{className:"w-[5rem]"}),r.jsx("col",{}),r.jsx("col",{className:"w-[7rem]"})]}),r.jsx("caption",{className:"sr-only",children:"Batch achievement input"}),r.jsx("thead",{children:r.jsxs("tr",{className:"border-b border-border bg-bg-secondary",children:[r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"År"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Typ"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Grupp"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Detaljer"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Åtgärd"})]})}),r.jsx("tbody",{children:n.map((e,t)=>{const s=c[t],a=s?.list||[],i=`row-${t}-errors`,l=!!s?.fields?.year,o=!!s?.fields?.weaponGroup,d=!!s?.fields?.points,u=!!s?.fields?.date,m=!!s?.fields?.timeSeconds,f=!!s?.fields?.hits;return r.jsxs("tr",{className:"border-b border-border hover:bg-bg-secondary/60",children:[r.jsx("td",{className:"px-3 py-2",children:r.jsx("input",{type:"number",min:"2000",max:(new Date).getFullYear(),value:e.year,onChange:e=>b(t,"year",e.target.value),className:"input w-full",disabled:p,"aria-label":`Year for row ${t+1}`,"aria-invalid":l||void 0,"aria-describedby":a.length?i:void 0})}),r.jsx("td",{className:"px-3 py-2",children:r.jsxs("select",{value:e.type,onChange:e=>b(t,"type",e.target.value),className:"select w-full",disabled:p,"aria-label":`Type for row ${t+1}`,"aria-describedby":"batch-type-help",children:[r.jsx("option",{value:"precision_series",children:"Precisionsserie"}),r.jsx("option",{value:"application_series",children:"Tillämpningsserie"}),r.jsx("option",{value:"standard_medal",children:"Standardmedalj"}),r.jsx("option",{value:"competition_result",children:"Tävlingsresultat"}),r.jsx("option",{value:"qualification_result",children:"Kvalificering"}),r.jsx("option",{value:"team_event",children:"Lag-Event"}),r.jsx("option",{value:"event",children:"Event"}),r.jsx("option",{value:"custom",children:"Custom"})]})}),r.jsx("td",{className:"px-3 py-2",children:"competition_result"!==e.type||"ppc"!==String(e.disciplineType||"").toLowerCase()?r.jsxs("select",{value:e.weaponGroup,onChange:e=>b(t,"weaponGroup",e.target.value),className:"select w-full",disabled:p,"aria-label":`Vapengrupp för rad ${t+1}`,"aria-invalid":o||void 0,"aria-describedby":a.length?i:void 0,children:[r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]}):r.jsx("span",{className:"text-muted-foreground text-xs",children:"—"})}),r.jsxs("td",{className:"px-3 py-2",children:["precision_series"===e.type?r.jsx("input",{type:"number",min:"0",max:"50",value:e.points,onChange:e=>b(t,"points",e.target.value),className:"input w-full",placeholder:"0-50",disabled:p,"aria-label":`Poäng för rad ${t+1}`,"aria-invalid":d||void 0,"aria-describedby":a.length?i:void 0}):"application_series"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"date",value:e.date,onChange:e=>b(t,"date",e.target.value),className:"input w-full",disabled:p,"aria-label":`Datum för rad ${t+1}`,"aria-invalid":u||void 0,"aria-describedby":a.length?i:void 0}),r.jsxs("select",{value:""===e.timeSeconds?"":Number(e.timeSeconds),onChange:e=>b(t,"timeSeconds",""===e.target.value?"":Number(e.target.value)),className:"select w-full",disabled:p,"aria-label":`Tid för rad ${t+1}`,"aria-invalid":m||void 0,"aria-describedby":a.length?i:void 0,children:[r.jsx("option",{value:"",children:"Select time…"}),or.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]}),r.jsx("input",{type:"number",min:"0",step:"1",value:e.hits,onChange:e=>b(t,"hits",e.target.value),className:"input w-full",placeholder:"Hits",disabled:p,"aria-label":`Träffar för rad ${t+1}`,"aria-invalid":f||void 0,"aria-describedby":a.length?i:void 0})]}):"standard_medal"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsxs("select",{value:e.disciplineType,onChange:e=>b(t,"disciplineType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Tävlinggren för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj disciplin..."}),sr.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsxs("select",{value:e.medalType,onChange:e=>b(t,"medalType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Medaljtyp för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj medalj..."}),lr.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsx("input",{type:"text",value:e.competitionName,onChange:e=>b(t,"competitionName",e.target.value),className:"input w-full",placeholder:"Tävlingsnamn (valfritt)",disabled:p,"aria-label":`Tävlingsnamn för rad ${t+1}`})]}):"competition_result"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsxs("select",{value:e.competitionType,onChange:e=>b(t,"competitionType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Tävlingstyp för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Select type…"}),nr.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsxs("select",{value:e.disciplineType,onChange:e=>b(t,"disciplineType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Gren för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj gren…"}),ar.map(e=>r.jsx("option",{value:e,children:e},e))]}),"ppc"===String(e.disciplineType||"")&&r.jsxs(r.Fragment,{children:[r.jsx("input",{type:"text",value:e.ppcClass,onChange:e=>b(t,"ppcClass",e.target.value),className:"input w-full",list:`ppc-classes-row-${t}`,placeholder:"PPC-klass",disabled:p,"aria-label":`PPC-klass för rad ${t+1}`}),r.jsx("datalist",{id:`ppc-classes-row-${t}`,children:ir.map(e=>r.jsx("option",{value:e},e))})]}),r.jsx("input",{type:"number",value:e.score,onChange:e=>b(t,"score",e.target.value),className:"input w-full",placeholder:"Poäng",disabled:p,"aria-label":`Poäng för rad ${t+1}`}),r.jsx("input",{type:"text",value:e.competitionName,onChange:e=>b(t,"competitionName",e.target.value),className:"input w-full",placeholder:"Tävlingsnamn (valfritt)",disabled:p,"aria-label":`Tävlingsnamn för rad ${t+1}`})]}):"qualification_result"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"text",value:e.weapon,onChange:e=>b(t,"weapon",e.target.value),className:"input w-full",placeholder:"Weapon",disabled:p,"aria-label":`Vapen för rad ${t+1}`}),r.jsx("input",{type:"number",value:e.score,onChange:e=>b(t,"score",e.target.value),className:"input w-full",placeholder:"Score",disabled:p,"aria-label":`Poäng för rad ${t+1}`})]}):"team_event"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"text",value:e.teamName,onChange:e=>b(t,"teamName",e.target.value),className:"input w-full",placeholder:"Lagnamn",disabled:p,"aria-label":`Lagamn för rad ${t+1}`}),r.jsx("input",{type:"number",min:"1",value:e.position,onChange:e=>b(t,"position",e.target.value),className:"input w-full",placeholder:"Placering",disabled:p,"aria-label":`Placering för rad ${t+1}`}),r.jsx("input",{type:"text",value:e.participants,onChange:e=>b(t,"participants",e.target.value),className:"input w-full",placeholder:"Deltagare (komma-separerad)",disabled:p,"aria-label":`Deltagara för rad ${t+1}`})]}):r.jsx("input",{type:"text",value:e.eventName,onChange:e=>b(t,"eventName",e.target.value),className:"input w-full",placeholder:"Event-namn / detaljer",disabled:p,"aria-label":`Event-namn för rad ${t+1}`}),a.length>0&&r.jsx("div",{id:i,role:"alert",className:"text-danger text-xs mt-1",children:a.join(", ")})]}),r.jsx("td",{className:"px-3 py-2",children:n.length>1&&r.jsx("button",{type:"button",onClick:()=>y(t),className:"btn btn-danger",disabled:p,"aria-label":`Ta bort rad ${t+1}`,children:"Ta bort"})})]},t)})})]})}),r.jsx("div",{className:"sm:hidden sticky bottom-0 safe-bottom bg-bg-secondary/80 backdrop-blur p-3 border-t border-border",children:r.jsx("button",{type:"submit",className:"btn btn-primary w-full min-h-[44px]",disabled:p||0===n.length,children:p?"Lägger till...":"Lägg till alla aktiviteter"})}),r.jsxs("div",{className:"hidden sm:flex gap-2 mb-4",children:[r.jsx("button",{type:"button",onClick:()=>{s([...n,dr()])},className:"btn btn-muted disabled:opacity-50",disabled:p,children:"+ Lägg till rad"}),r.jsx("button",{type:"submit",className:"btn btn-primary disabled:opacity-50",disabled:p||0===n.length,children:p?"Lägger till...":"Lägg till alla aktiviteter"})]})]}),r.jsx(Jt,{open:a,onClose:()=>{i(!1),o(-1)},initialRow:l>=0?n[l]:dr(),onSave:(e,{addAnother:t}={})=>{s(l>=0?t=>t.map((t,r)=>r===l?e:t):t=>[...t,e]),t||(i(!1),o(-1))},WG:rr,COMP_TYPES:nr,MEDAL_TYPES:lr,APP_TIME_OPTIONS:or,COMP_DISCIPLINE_TYPES:ar,PPC_CLASS_SUGGESTIONS:ir})]})})}const mr={precision_series:"Precisionsserier",application_series:"Tillämpningsserier",competition_result:"Tävlingsresultat",qualification_result:"Qualification",team_event:"Lag-event",event:"Event",custom:"Custom",special_achievement:"Special achievement",standard_medal:"Standardmedalj"};function pr(e){return mr[e]||e}function fr({achievement:e}){const{addAchievement:n,updateAchievement:s,removeAchievement:a}=tr(),[i,l]=t.useState(!1),[o,c]=t.useState("add"),[d,u]=t.useState(null),m=(e,{id:t,medalId:r}={})=>{const n={id:t,medalId:r,type:e.type,year:Number(e.year),weaponGroup:e.weaponGroup,date:e.date,notes:e.notes||""};switch(e.type){case"precision_series":return{...n,points:""===e.points?void 0:Number(e.points??0),competitionName:e.competitionName||void 0};case"application_series":return{...n,timeSeconds:""===e.timeSeconds?void 0:Number(e.timeSeconds??0),hits:""===e.hits?void 0:Number(e.hits??0)};case"standard_medal":return{...n,disciplineType:e.disciplineType||"",competitionName:e.competitionName||"",medalType:e.medalType||""};case"competition_result":return{...n,score:""===e.score?void 0:Number(e.score??0),competitionName:e.competitionName||"",competitionType:e.competitionType||"",disciplineType:e.disciplineType||"",ppcClass:e.ppcClass||""};case"qualification_result":return{...n,weapon:e.weapon||"",score:""===e.score?void 0:Number(e.score??0)};case"team_event":return{...n,teamName:e.teamName||"",position:""===e.position?void 0:Number(e.position??0),participants:String(e.participants||"").split(",").map(e=>e.trim()).filter(Boolean)};default:return{...n,eventName:e.eventName||""}}},p=pr(e.type);return r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"card p-4 flex justify-between items-start",children:[r.jsxs("div",{children:[r.jsxs("div",{className:"flex gap-2 items-center mb-1",children:[r.jsx("span",{className:"font-semibold text-text-primary",children:p}),r.jsxs("span",{className:"text-xs px-2 py-1 rounded bg-bg-secondary text-text-secondary",children:["Grupp ",e.weaponGroup]})]}),r.jsxs("p",{className:"text-sm text-text-secondary",children:[(e.date||"").toString()," • ",e.points," points"]})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{onClick:()=>{var t;c("edit"),u({id:(t=e).id,type:t.type,year:t.year,weaponGroup:t.weaponGroup,date:t.date,points:t.points,timeSeconds:t.timeSeconds,hits:t.hits,competitionType:t.competitionType,disciplineType:t.disciplineType,ppcClass:t.ppcClass,competitionName:t.competitionName,weapon:t.weapon,score:t.score,teamName:t.teamName,position:t.position,participants:Array.isArray(t.participants)?t.participants.join(", "):t.participants||"",eventName:t.eventName,notes:t.notes}),l(!0)},className:"btn btn-muted text-sm","aria-label":`Ändra aktivitet ${e.id}`,children:"Ändra"}),r.jsx("button",{onClick:()=>{c("add");const t=(new Date).toISOString().slice(0,10);u({year:new Date(t).getFullYear(),weaponGroup:e.weaponGroup||"A",type:e.type||"precision_series",date:t,points:"",timeSeconds:"",hits:"",competitionType:"",disciplineType:"",ppcClass:"",competitionName:"",weapon:"",score:"",teamName:"",position:"",participants:"",eventName:"",notes:""}),l(!0)},className:"btn btn-primary text-sm","aria-label":`Logga ny aktivitet för märke ${e.medalId}`,children:"Logga"}),r.jsx("button",{onClick:async()=>{if(confirm("Delete this achievement?"))try{await a(e.id)}catch(t){console.error("Failed to delete:",t)}},className:"btn btn-muted text-red-600 text-sm","aria-label":`Ta bort aktivitet ${e.id}`,children:"Ta bort"})]})]}),r.jsx(Jt,{open:i,onClose:()=>l(!1),initialRow:d,onSave:async t=>{try{if("edit"===o){const r=m(t,{id:e.id,medalId:e.medalId});await s(r)}else{const r=m(t,{medalId:e.medalId});await n(r)}l(!1)}catch(r){console.error("Misslyckades att spara:",r)}},mode:"immediate",submitLabel:"edit"===o?"Spara":"Lägg till"})]})}function hr(e){const t=String(e??"");return t.includes(",")||t.includes('"')||t.includes("\n")?`"${t.replace(/"/g,'""')}"`:t}const gr=["id","type","year","weaponGroup","points","date","timeSeconds","hits","competitionName","competitionType","disciplineType","ppcClass","weapon","score","teamName","position","eventName","notes","schema_version"];function br(e=[],t="1"){return[gr.join(","),...(e||[]).map(e=>gr.map(r=>"schema_version"===r?t:e?.[r]??"").map(hr).join(","))].join("\n")}function xr(e,t="achievements.csv"){if("undefined"==typeof document)return;const r=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(r),s=document.createElement("a");s.href=n,s.setAttribute("download",t),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}function yr(){const{currentProfile:e}=se(),[n,s]=t.useState(null),[a,i]=t.useState(null),[l,o]=t.useState(null),c=t.useMemo(()=>{if(!e?.prerequisites)return[];let t=[...e.prerequisites];return n&&(t=t.filter(e=>e.year===n)),a&&(t=t.filter(e=>e.type===a)),l&&(t=t.filter(e=>e.weaponGroup===l)),t.sort((e,t)=>new Date(t.date||"1970-01-01")-new Date(e.date||"1970-01-01"))},[e,n,a,l]),d=t.useMemo(()=>e?.prerequisites?[...new Set(e.prerequisites.map(e=>e.year))].sort((e,t)=>t-e):[],[e]);if(!e)return r.jsx("div",{className:"card p-4",children:r.jsx("p",{className:"text-foreground",children:"Välj en profil för att se aktiviteter"})});return r.jsx(Wt,{name:"historyTimeline",children:r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"card p-4",children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsx("h3",{className:"text-lg font-bold text-text-primary",children:"Filters"}),r.jsx("button",{onClick:()=>{xr(br(c),"aktivitet-historik.csv")},className:"btn btn-primary text-sm","aria-label":"Exporta aktiviteter som CSV",children:"Exporta CSV"})]}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Year"}),r.jsxs("select",{value:n||"",onChange:e=>s(e.target.value?parseInt(e.target.value):null),className:"select",children:[r.jsx("option",{value:"",children:"All Years"}),d.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Type"}),r.jsxs("select",{value:a||"",onChange:e=>i(e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"All typer"}),["precision_series","competition_result","standard_medal"].map(e=>r.jsx("option",{value:e,children:pr(e)},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Weapon Group"}),r.jsxs("select",{value:l||"",onChange:e=>o(e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla grupper"}),r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]})]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("h3",{className:"text-lg font-bold text-text-primary",children:[c.length," Aktivitet(er)"]}),0===c.length?r.jsx("div",{className:"card p-6 text-center",children:r.jsx("p",{className:"text-text-secondary",children:"Inga aktiviteter än"})}):r.jsx("div",{className:"space-y-3",children:c.map(e=>r.jsx(fr,{achievement:e},e.id))})]})]})})}const vr=["locked","available","eligible","unlocked"],wr={locked:{id:"locked",label:"Låst",description:"Förkrav ej uppfyllda.",icon:"Lock",className:"status-badge status--locked"},available:{id:"available",label:"Tillgänglig",description:"Medaljen är tillgänglig att påbörja.",icon:"Compass",className:"status-badge status--available"},eligible:{id:"eligible",label:"Kvalificerad",description:"Förkrav uppfyllda. Prestationskrav återstår.",icon:"BadgeCheck",className:"status-badge status--eligible"},unlocked:{id:"unlocked",label:"Upplåst",description:"Medaljen är erhållen.",icon:"Medal",className:"status-badge status--unlocked"}};function jr(e){return wr[e]||null}function kr(){const{currentProfile:e}=se(),n=t.useMemo(()=>e?.prerequisites?function(e){if(!e||0===e.length)return{totalAchievements:0,avgPointsPerYear:0,bestYear:null,yearsActive:0,pointsByYear:{}};const t={};e.forEach(e=>{const r=e.year;null!=r&&(t[r]||(t[r]=0),t[r]+=Number(e.points||0))});const r=Object.keys(t).map(Number).sort((e,t)=>e-t),n=r.length>0?r.reduce((e,r)=>t[r]>(t[e]??-1/0)?r:e,r[0]):null,s=n?t[n]:0,a=e.reduce((e,t)=>e+Number(t.points||0),0),i=Math.max(1,r.length);return{totalAchievements:e.length,avgPointsPerYear:a/i,bestYear:n,bestYearPoints:s,yearsActive:r.length,pointsByYear:t}}(e.prerequisites):{totalAchievements:0,avgPointsPerYear:0,bestYear:null,yearsActive:0},[e]),s=ie(),a=t.useMemo(()=>vr.map(e=>{const t=jr(e);return{key:e,label:t.label,icon:t.icon,count:Array.isArray(s?.[e])?s[e].length:0}}),[s]);return e?r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Totala Aktiviteter"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:n.totalAchievements})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Genomsnitt Poäng/År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:Number.isFinite(n.avgPointsPerYear)?n.avgPointsPerYear.toFixed(1):"0.0"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Bästa År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:n.bestYear||"-"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Aktiva År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:n.yearsActive})]}),a.map(({key:e,label:t,icon:n,count:s})=>r.jsxs("div",{className:"card p-4",children:[r.jsxs("p",{className:"text-sm text-muted-foreground font-semibold inline-flex items-center gap-2",children:[r.jsx(Se,{name:n,className:"w-4 h-4","aria-hidden":"true"}),r.jsx("span",{children:t})]}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:s})]},e))]}):null}const Nr=[{value:0,label:"Påminn mig aldrig",description:"Jag säkerhetskopierar manuellt"},{value:30,label:"Var 30:e dag",description:"Rekommenderas för de flesta användare"},{value:90,label:"Var 90:e dag",description:"För avancerade användare"}];function Sr(){const{reminderFrequency:e,updateReminderFrequency:t,lastBackupDate:n}=Ve(),s=function(e,t="sv-SE"){return e?new Date(e).toLocaleString(t,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Aldrig"}(n);return r.jsxs("div",{className:"card p-6",children:[r.jsxs("div",{className:"mb-6",children:[r.jsx("h2",{className:"text-lg font-semibold text-color-text-primary mb-2",children:"Säkerhetskopieringspåminnelser"}),r.jsx("p",{className:"text-sm text-color-text-secondary",children:"Få påminnelser om att säkerhetskopiera dina uppgifter regelbundet"})]}),r.jsxs("fieldset",{className:"space-y-3 mb-6",children:[r.jsx("legend",{className:"sr-only",children:"Frekvens för säkerhetskopieringspåminnelser"}),Nr.map(n=>{const s=e===n.value;return r.jsx("div",{className:`\n                p-4 rounded-lg border-2 transition-colors cursor-pointer\n                ${s?"border-color-primary bg-blue-50 dark:bg-blue-950":"border-color-border bg-color-bg-secondary hover:border-color-primary/50"}\n              `,children:r.jsxs("label",{className:"flex items-start gap-3 cursor-pointer",children:[r.jsx("input",{type:"radio",name:"backup-frequency",value:n.value,checked:s,onChange:()=>{return e=n.value,void t(e);var e},className:"\n                    mt-1 w-5 h-5\n                    text-color-primary\n                    focus-visible:ring-2 focus-visible:ring-offset-2\n                    focus-visible:ring-color-primary\n                  "}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("p",{className:"font-medium text-color-text-primary",children:n.label}),r.jsx("p",{className:"text-sm text-color-text-secondary mt-1",children:n.description})]})]})},n.value)})]}),r.jsx("div",{className:"p-4 rounded-lg bg-color-bg-secondary border border-color-border mb-6",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(Se,{name:"Clock",className:"w-4 h-4 text-color-text-secondary","aria-hidden":"true"}),r.jsxs("p",{className:"text-sm text-color-text-secondary",children:["Senaste säkerhetskopia:"," ",r.jsx("span",{className:"font-medium text-color-text-primary",children:s})]})]})}),r.jsx("div",{className:"p-4 rounded-lg bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(Se,{name:"Lightbulb",className:"w-5 h-5 text-blue-600 dark:text-blue-400 shrink-0 mt-0.5","aria-hidden":"true"}),r.jsxs("div",{children:[r.jsx("h3",{className:"font-semibold text-color-text-primary mb-2",children:"Så håller du dina uppgifter säkra"}),r.jsxs("ul",{className:"text-sm text-color-text-secondary space-y-1",children:[r.jsx("li",{children:"• Din data finns bara på den här enheten"}),r.jsx("li",{children:"• Exportera regelbundet för att undvika att förlora framsteg"}),r.jsx("li",{children:"• Lagra säkerhetskopior i iCloud Drive, Google Drive eller USB"}),r.jsx("li",{children:"• Flera säkerhetskopior = extra säkerhet"})]})]})]})})]})}function Cr(){const{currentProfile:e,setProfileFeature:n}=se(),[s,a]=t.useState("add");return e?r.jsx(ce,{children:r.jsxs("div",{className:"space-y-8",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold text-text-primary mb-2",children:"Inställningar"}),r.jsxs("p",{className:"text-text-secondary",children:["Profile: ",r.jsx("span",{className:"font-semibold",children:e.displayName})]})]}),r.jsx(kr,{}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"section-title mb-2",children:"Funktioner"}),r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("input",{id:"ft-manual-unlock",type:"checkbox",className:"h-5 w-5 mt-0.5",checked:!!e?.features?.allowManualUnlock,onChange:e=>n("allowManualUnlock",e.target.checked)}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"ft-manual-unlock",className:"field-label mb-1",children:"Tillåt manuell upplåsning av märken (förhandskrav gäller fortfarande)"}),r.jsx("p",{className:"field-hint",children:"Du kan låsa upp märken vilket år som helst utan att möta kraven för dem. Förhandskrav och årskrav gäller fortfarande."})]})]}),r.jsx(Wt,{name:"enforceCurrentYearSetting",children:r.jsxs("div",{className:"flex items-start gap-3 mt-3",children:[r.jsx("input",{id:"ft-enforce-current-year",type:"checkbox",className:"h-5 w-5 mt-0.5",checked:!!e?.features?.enforceCurrentYearForSustained,onChange:e=>n("enforceCurrentYearForSustained",e.target.checked)}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"ft-enforce-current-year",className:"field-label mb-1",children:"Kräv innevarande år för återkommande märken"}),r.jsx("p",{className:"field-hint",children:"Märken som kräver återkommande aktiviteter kan bara låsas upp innevarande kalenderår."})]})]})})]}),r.jsx(Sr,{}),r.jsxs("div",{className:"flex gap-2 border-b border-border",role:"tablist","aria-label":"Inställnings-sektion",children:[r.jsx("button",{role:"tab","aria-selected":"add"===s,onClick:()=>a("add"),className:"px-4 py-2 font-medium border-b-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary "+("add"===s?"border-primary text-primary":"border-transparent text-text-secondary hover:text-text-primary"),children:"Lägg till aktiviteter"}),r.jsx("button",{role:"tab","aria-selected":"history"===s,onClick:()=>a("history"),className:"px-4 py-2 font-medium border-b-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary "+("history"===s?"border-primary text-primary":"border-transparent text-text-secondary hover:text-text-primary"),children:"Historik"})]}),"add"===s&&r.jsx(ur,{}),"history"===s&&r.jsx(yr,{})]})}):r.jsx(At,{id:"profile-picker-settings"})}function Mr(){if("undefined"==typeof navigator||!navigator.share)return!1;if(!navigator.canShare)return!1;try{const e=new File(["test"],"test.txt",{type:"text/plain"});return navigator.canShare({files:[e]})}catch{return!1}}function Ar({blob:e,filename:n,onClose:s,onComplete:i}){const[l,o]=t.useState(!1),[c,d]=t.useState(null),{markBackupCreated:u}=Ve(),m=Mr(),p=function(){const e="undefined"!=typeof navigator?navigator.userAgent:"",t=/iPad|iPhone|iPod/.test(e),r=/Android/.test(e);return t?"Spara till iCloud Drive, Filer eller annan app":r?"Spara till Google Drive, Filer eller annan app":"Spara till molnlagring eller annan app"}(),f=t.useRef(s);t.useEffect(()=>{f.current=s},[s]),t.useEffect(()=>{const e=e=>{"Escape"===e.key&&f.current()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);const h=r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 bg-black/50 z-[2000]",onClick:s,"aria-hidden":"true"}),r.jsxs("div",{role:"dialog","aria-modal":"true","aria-labelledby":"share-backup-title",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"min(90vw, 28rem)",maxHeight:"90vh",overflow:"auto",zIndex:2001},className:"\n          bg-bg-primary\n          border-2 border-border\n          rounded-xl shadow-2xl\n          p-6\n        ",children:[r.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[r.jsx("div",{className:"\n              w-12 h-12 rounded-full\n              bg-green-500\n              flex items-center justify-center\n            ","aria-hidden":"true",children:r.jsx("svg",{className:"w-7 h-7 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),r.jsx("h2",{id:"share-backup-title",className:"text-2xl font-bold text-foreground",children:"Säkerhetskopia skapad"})]}),r.jsxs("div",{className:"\n            mb-4 p-4 rounded-lg\n            bg-bg-secondary\n            border border-border\n          ",children:[r.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Fil sparad som:"}),r.jsx("p",{className:"font-mono text-sm text-foreground break-all",children:n})]}),r.jsxs("div",{className:"\n            mb-6 p-4 rounded-lg\n            bg-blue-50 dark:bg-blue-950\n            border border-blue-200 dark:border-blue-800\n          ",children:[r.jsxs("p",{className:"font-semibold text-foreground mb-2",children:["💾 ",m?p:"Spara din säkerhetskopia"]}),r.jsx("p",{className:"text-sm text-muted-foreground",children:m?'Tryck "Dela till molnet" för att spara i din molnlagring':"Ladda ner och ladda upp till din föredragna molnlagring"})]}),c&&r.jsx("div",{className:"\n              mb-4 p-3 rounded-lg\n              bg-red-50 dark:bg-red-950\n              border border-red-200 dark:border-red-800\n              text-red-800 dark:text-red-200\n            ",role:"alert","aria-live":"assertive",children:r.jsxs("div",{className:"flex items-start gap-2",children:[r.jsx("svg",{className:"w-5 h-5 shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),r.jsx("p",{className:"text-sm",children:c})]})}),r.jsxs("div",{className:"space-y-2",children:[m&&r.jsxs("button",{onClick:async()=>{try{o(!0),d(null);const t=await async function(e,t,r="Säkerhetskopia"){if(!Mr())throw new Error("Fildelning stöds inte på den här enheten");const n=new File([e],t,{type:e.type||"application/json"});try{return await navigator.share({files:[n],title:r,text:"Säkerhetskopia av mina märkesframsteg"}),{success:!0}}catch(c){if("AbortError"===c.name)return{success:!1,cancelled:!0};throw c}}(e,n,"Säkerhetskopia");t.success?(await u(),i&&i()):t.cancelled}catch(t){d(t.message||"Delning misslyckades")}finally{o(!1)}},disabled:l,className:"\n                w-full py-3 rounded-lg font-medium\n                bg-primary text-primary-foreground\n                hover:bg-primary/90\n                disabled:opacity-50 disabled:cursor-not-allowed\n                focus-visible:outline-none focus-visible:ring-2\n                focus-visible:ring-offset-2 focus-visible:ring-primary\n                flex items-center justify-center gap-2\n                min-h-[44px]\n              ",children:[r.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"})}),l?"Delar...":"Dela till molnet"]}),r.jsxs("button",{onClick:async()=>{try{const t=URL.createObjectURL(e),r=document.createElement("a");r.href=t,r.download=n,r.click(),URL.revokeObjectURL(t),await u(),i&&i()}catch(t){d(t.message||"Nedladdning misslyckades")}},className:"\n              w-full py-3 rounded-lg font-medium\n              bg-bg-secondary text-foreground\n              border-2 border-border\n              hover:bg-bg-tertiary\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-border\n              flex items-center justify-center gap-2\n              min-h-[44px]\n            ",children:[r.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Ladda ner till enhet"]}),r.jsx("button",{onClick:s,className:"\n              w-full py-2 text-muted-foreground\n              hover:text-foreground\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-border\n              rounded\n            ",children:"Stäng"})]})]})]});return a.createPortal(h,document.body)}function Ir({profile:e}){const[n,s]=t.useState(!1),[a,i]=t.useState(!1),[l,o]=t.useState(null),[c,d]=t.useState(!1),[u,m]=t.useState(null),[p,f]=t.useState("");return r.jsxs("div",{children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-3",children:"Säkerhetskopiera profil"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Ladda ner en komplett säkerhetskopia av din profil som en JSON-fil. Innehåller alla dina aktiviteter och upplåsta märken."}),r.jsx("button",{onClick:async()=>{try{s(!0),o(null);const t=(new Date).toISOString().split("T")[0],r=await He(e,{version:"1.0"}),n=`medal-backup-${t}.json`,a=new Blob([r],{type:"application/json;charset=utf-8"});m(a),f(n),d(!0)}catch(t){console.error("Backup-fel:",t),o(t.message||"Säkerhetskopieringen misslyckades")}finally{s(!1)}},disabled:n,className:"btn btn-primary w-full min-h-[44px]","aria-label":"Säkerhetskopiera profil",children:n?"Skapar säkerhetskopia...":"Säkerhetskopiera profil"}),a&&r.jsxs("div",{className:"alert alert-success mt-4 flex items-center gap-2",role:"status","aria-live":"polite",children:[r.jsx("span",{"aria-hidden":"true",children:"✓"}),r.jsx("span",{children:"Säkerhetskopieringen lyckades!"})]}),l&&r.jsxs("div",{className:"alert alert-error mt-4 flex items-center gap-2",role:"alert","aria-live":"assertive",children:[r.jsx("span",{"aria-hidden":"true",children:"✕"}),r.jsx("span",{children:l})]}),c&&u&&r.jsx(Ar,{blob:u,filename:p,onClose:()=>d(!1),onComplete:()=>{d(!1),i(!0),setTimeout(()=>i(!1),3e3)}})]})}function Dr({open:n,onClose:s,shareData:a}){const[i,l]=t.useState(null),[o,c]=t.useState(null),[d,u]=t.useState(!1);t.useEffect(()=>{n&&(async()=>{try{c(null);const t=await async function(t,r={}){const n="string"==typeof t?t:JSON.stringify(t);try{const t=await e(()=>import("./vendor-D9hX5c7Y.js").then(e=>e.b),[]).catch(()=>null);if(t&&t.toDataURL)return await t.toDataURL(n,{errorCorrectionLevel:"M",width:r.width||256,margin:2})}catch{}return`data:text/plain;base64,${("undefined"!=typeof globalThis&&globalThis.Buffer&&"function"==typeof globalThis.Buffer.from?globalThis.Buffer.from(n,"utf8").toString("base64"):"function"==typeof btoa?btoa(unescape(encodeURIComponent(n))):"")||""}`}(a);l(t)}catch(t){c(t.message||"Misslyckades att skapa QR-kod")}})()},[n,a]);const m="string"==typeof a?a:a?.link||"";return n?r.jsx("div",{className:"\n        fixed inset-0 bg-black/50 flex items-center justify-center p-4\n      ",role:"dialog","aria-modal":"true","aria-label":"Share progress dialog",onClick:s,children:r.jsxs("div",{className:"w-full max-w-md p-6 rounded-lg bg-bg-secondary border border-border",onClick:e=>e.stopPropagation(),children:[r.jsx("h2",{className:"text-xl font-bold text-foreground mb-4",children:"Dela dina framsteg"}),o&&r.jsx("div",{className:"alert alert-error mb-4",role:"alert","aria-live":"assertive",children:o}),!o&&r.jsxs("div",{className:"flex flex-col items-center",children:[i?r.jsx("img",{src:i,alt:"QR code for sharing progress",className:"w-48 h-48"}):r.jsx("div",{className:"w-48 h-48 flex items-center justify-center border border-dashed border-border rounded",children:r.jsx("span",{className:"text-muted-foreground",children:"Skapar..."})}),r.jsx("div",{className:"w-full mt-4",children:r.jsxs("div",{className:"flex gap-2",children:[r.jsx("input",{type:"text",readOnly:!0,value:m,className:"input flex-1","aria-label":"Share link"}),r.jsx("button",{onClick:async()=>{try{if(!m)return;await navigator.clipboard.writeText(m),u(!0),setTimeout(()=>u(!1),2e3)}catch{c("Misslyckades att kopiera länk")}},className:"btn btn-primary min-w-[96px] min-h-[44px]","aria-label":"Copy share link",children:d?"Kopierad":"Kopiera"})]})})]}),r.jsx("div",{className:"mt-6 flex justify-end",children:r.jsx("button",{onClick:s,className:"btn btn-muted min-h-[44px]","aria-label":"Stäng delningsdialogen",children:"Stäng"})})]})}):null}function Pr(){return r.jsxs("div",{className:"\n        p-6 rounded-lg\n        bg-bg-secondary\n        border-2 border-border\n      ",role:"region","aria-labelledby":"restore-guide-title",children:[r.jsx("h3",{id:"restore-guide-title",className:"text-xl font-bold text-foreground mb-4",children:"📖 Så här återställer du från molnet"}),r.jsxs("ol",{className:"space-y-4 text-muted-foreground",children:[r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"1"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Ladda ner din säkerhetskopia"}),r.jsx("p",{className:"text-sm",children:"Hitta din säkerhetskopia i iCloud Drive, Google Drive, OneDrive eller var du sparade den. Ladda ner filen till den här enheten."})]})]}),r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"2"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Öppna den här appen"}),r.jsx("p",{className:"text-sm",children:"Navigera till Inställningar → Data & Säkerhetskopia (eller använd återställningsknappen ovan)."})]})]}),r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"3"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Välj din säkerhetskopia"}),r.jsxs("p",{className:"text-sm",children:['Klicka på "Återställ från säkerhetskopia" och välj den nedladdade filen (t.ex. ',r.jsx("code",{className:"text-xs bg-bg-tertiary px-1.5 py-0.5 rounded font-mono",children:"medal-backup-2026-01-06.json"}),")."]})]})]}),r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"4"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Bekräfta återställning"}),r.jsx("p",{className:"text-sm",children:'Granska förhandsgranskningen (datum, antal aktiviteter) och klicka "Återställ nu". Dina data återställs omedelbart.'})]})]})]}),r.jsxs("div",{className:"\n          mt-6 p-4 rounded-lg\n          bg-blue-50 dark:bg-blue-950\n          border border-blue-200 dark:border-blue-800\n        ",children:[r.jsx("p",{className:"text-sm font-semibold text-foreground mb-2",children:"💡 Proffsråd"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Håll flera säkerhetskopior på olika platser (molnlagring + USB-minne) för extra säkerhet. Säkerhetskopiera regelbundet för att undvika dataförlust."})]})]})}const Tr=["id","type","year","weaponGroup","points","date","timeSeconds","hits","competitionName","competitionType","disciplineType","ppcClass","weapon","score","teamName","position","eventName","notes","schema_version"];function Er(e){const t=[];let r="",n=!1;for(let s=0;s<e.length;s++){const a=e[s];'"'===a?n&&'"'===e[s+1]?(r+='"',s++):n=!n:","!==a||n?r+=a:(t.push(r),r="")}return t.push(r),t.map(e=>e.trim())}function _r(e){if(null==e||""===e)return;const t=String(e).replace(",","."),r=Number(t);return Number.isFinite(r)?r:void 0}function Fr(e){return null==e?void 0:String(e).trim().toLowerCase()}function $r(e){const t={};for(const r of Object.keys(e)){const n=r.trim(),s=e[r];switch(n){case"type":t.type=Fr(s);break;case"year":t.year=_r(s);break;case"weaponGroup":t.weaponGroup=String(s||"A").trim().toUpperCase();break;case"points":t.points=_r(s);break;case"timeSeconds":t.timeSeconds=_r(s);break;case"hits":t.hits=_r(s);break;case"score":t.score=_r(s);break;case"position":t.position=_r(s);break;case"competitionType":case"disciplineType":case"weapon":case"teamName":case"competitionName":case"eventName":case"notes":case"date":{const e="string"==typeof s?s.trim():s;t[n]="competitionType"===n||"disciplineType"===n||"weapon"===n?Fr(e):e;break}case"ppcClass":t.ppcClass="string"==typeof s?s.trim():s;break;case"id":t.id=String(s||"").trim()||void 0}}return t}function qr(e){const t=function(e=""){return String(e).replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n")}(e).filter(Boolean);if(!t.length)return{rows:[],errors:["Empty file"]};const r=Er(t[0]).map(e=>e.trim()),n=r.filter(e=>!Tr.includes(e)),s=[],a=n.length?[`Okända rubriker: ${n.join(", ")}`]:[];for(let i=1;i<t.length;i++){const e=Er(t[i]),n={};for(let t=0;t<r.length;t++)n[r[t]]=e[t]??"";s.push($r(n))}return{rows:s,errors:a}}function Lr(e){return{id:e.id,type:e.type,year:e.year,weaponGroup:e.weaponGroup||"A",points:e.points,date:e.date,timeSeconds:e.timeSeconds,hits:e.hits,competitionName:e.competitionName,competitionType:e.competitionType,disciplineType:e.disciplineType,ppcClass:e.ppcClass,weapon:e.weapon,score:e.score,teamName:e.teamName,position:e.position,eventName:e.eventName,notes:e.notes}}function Yr({profile:e,updateProfile:n,upsertAchievements:s}){const[a,i]=t.useState(!1),[l,o]=t.useState(null),[c,d]=t.useState(null),[u,m]=t.useState(null),[p,f]=t.useState({updateById:!0,matchNaturalKey:!1,addNew:!0}),h=t.useRef(null),[g,b]=t.useState(""),[x,y]=t.useState(null),v=t.useMemo(()=>Array.isArray(e?.prerequisites)?e.prerequisites:[],[e?.prerequisites]);return r.jsxs("div",{className:"card p-4 md:col-span-2",role:"region","aria-labelledby":"csv-title",children:[r.jsx("h2",{id:"csv-title",className:"text-lg font-semibold text-foreground mb-3",children:"CSV (Aktiviteter)"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Exportera, redigera och importera aktiviteter via CSV. För säkerhet körs en förhandsgranskning först."}),r.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[r.jsx("button",{onClick:function(){try{xr(br(v,"1"),"aktiviteter.csv"),o(null)}catch(e){o(e.message||"Export av CSV misslyckades")}},className:"btn btn-primary min-h-[44px]","aria-label":"Exportera aktiviteter som CSV",children:"Exportera aktiviteter (CSV)"}),r.jsx("button",{onClick:function(){try{xr(function(e="1"){return[gr.join(","),["","precision_series","2024","A","45","2024-05-20","","","","","","","","","","","","Exempelrad",e].map(hr).join(",")].join("\n")}("1"),"aktiviteter_mall.csv"),o(null)}catch(e){o(e.message||"Nedladdning av mall misslyckades")}},className:"btn btn-secondary min-h-[44px]","aria-label":"Ladda ned CSV-mall",children:"Ladda ned CSV-mall"})]}),r.jsxs("div",{className:"p-4 rounded-lg border border-border bg-bg-primary",role:"group","aria-labelledby":"csv-import-label",children:[r.jsx("div",{id:"csv-import-label",className:"field-label mb-2",children:"Importera från CSV"}),r.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:()=>h.current?.click(),children:"Välj CSV-fil"}),r.jsx("span",{className:"text-sm text-muted-foreground",children:g||"Ingen fil vald"}),r.jsx("input",{ref:h,type:"file",accept:".csv",className:"hidden",onChange:e=>e.target.files?.[0]&&async function(t){if(t){o(null),m(null),d(null),i(!0);try{const e=qr(await t.text());if(e.errors?.length)return void o(e.errors.join("; "));const r=e.rows.map(Lr),n=await s(r,{...p,dryRun:!0});d({rows:r,result:n}),b(t.name)}catch(e){o(e.message||"Kunde inte läsa/validera CSV")}finally{i(!1)}}}(e.target.files[0])}),c&&r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:function(){o(null),d(null),m(null),b("")},children:"Rensa"})]}),r.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-3 gap-2",children:[r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:p.updateById,onChange:e=>f(t=>({...t,updateById:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Uppdatera via ID"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:p.matchNaturalKey,onChange:e=>f(t=>({...t,matchNaturalKey:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Matcha utan ID via nyckel (avancerat)"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:p.addNew,onChange:e=>f(t=>({...t,addNew:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Lägg till nya rader"})]})]})]}),a&&r.jsx("div",{className:"alert alert-info mt-3",role:"status","aria-live":"polite",children:"Bearbetar..."}),l&&r.jsx("div",{className:"alert alert-error mt-3",role:"alert","aria-live":"assertive",children:l}),c&&!l&&r.jsxs("div",{className:"mt-3",children:[r.jsx("div",{className:"alert alert-warning",role:"status","aria-live":"polite",children:"Förhandsgranskning: inga ändringar har gjorts än."}),r.jsxs("div",{className:"mt-2 text-sm text-muted-foreground",children:["Skulle importera: ",c.result.added," tillägg, ",c.result.updated," uppdateringar, ",c.result.skipped," överhoppade, ",c.result.failed," fel."]}),r.jsx("button",{onClick:async function(){if(c?.rows?.length){i(!0),o(null),m(null);try{y({userId:e.userId,prerequisites:Array.isArray(e.prerequisites)?[...e.prerequisites]:[]});const t=await s(c.rows,{...p,dryRun:!1});m(t),d(null)}catch(t){o(t.message||"Import av CSV misslyckades")}finally{i(!1)}}},disabled:a,className:"btn btn-primary w-full mt-3 min-h-[44px]",children:"Bekräfta import"})]}),u&&r.jsxs("div",{className:"mt-3",children:[r.jsxs("div",{className:"alert alert-success",role:"status","aria-live":"polite",children:["Import klar: ",u.added," tillagda, ",u.updated," uppdaterade, ",u.skipped," överhoppade, ",u.failed," fel."]}),r.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:async function(){try{if(!x)return;const t={...e,prerequisites:x.prerequisites,lastModified:(new Date).toISOString()};await n(t),y(null),m(null)}catch(t){o(t.message||"Ångra misslyckades")}},children:"Ångra import"})})]}),r.jsxs("details",{className:"mt-4",children:[r.jsx("summary",{className:"cursor-pointer text-sm text-foreground",children:"Hjälp: Kolumner och arbetsflöde"}),r.jsxs("div",{className:"mt-2 text-sm text-muted-foreground space-y-2",children:[r.jsxs("p",{children:["Arbetsflöde: 1) Exportera aktiviteter, 2) Redigera i kalkylark, 3) Importera CSV. Behåll kolumnen ",r.jsx("code",{children:"id"})," för att uppdatera rader; nya rader kan lämna ",r.jsx("code",{children:"id"})," tomt."]}),r.jsx("p",{children:"Tillåtna kolumner (valfria där det inte krävs): id, type, year, weaponGroup, points, date, timeSeconds, hits, competitionName, competitionType, medalType, disciplineType, weapon, score, teamName, position, eventName, notes, schema_version."}),r.jsx("p",{children:"Standardmatchning: Uppdatera via ID. Alternativt kan du matcha utan ID via naturlig nyckel (avancerat)."})]})]})]})}function Rr(){const{currentProfile:e,updateProfile:n,loading:s,error:a,upsertAchievements:i}=se(),[l,c]=t.useState(!1),[d,u]=t.useState(null),[m,p]=t.useState(null),[f,h]=t.useState(!1),g=t.useMemo(()=>!!e&&!s,[e,s]);return r.jsxs("div",{className:"max-w-6xl mx-auto p-4",children:[r.jsx("h1",{className:"section-title mb-4",children:"Data & Säkerhetskopia"}),(a||m)&&r.jsx("div",{className:"alert alert-error mb-4",role:"alert","aria-live":"assertive",children:a||m}),g?r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r.jsx("div",{className:"card md:row-span-2 p-4",children:r.jsx(Ir,{profile:e})}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-3",children:"Återställ från säkerhetskopia"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Återställ en hel profil från en säkerhetskopia. Du kan skapa en ny profil eller ersätta en profil med samma ID."}),r.jsx("button",{onClick:()=>h(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Återställ från säkerhetskopia"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-3",children:"Dela profil"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Skapa en QR-kod som innehåller profilen för att dela eller göra backup."}),r.jsx("button",{onClick:async()=>{try{p(null);const t=await He(e,{version:"1.0"});u(t),c(!0)}catch(t){p(t.message||"Misslyckades med förberedelser för att dela data")}},className:"btn btn-primary min-h-[44px]","aria-label":"Öppna delningsdialog",children:"Dela via QR-kod"})]}),r.jsx(Wt,{name:"csvImport",className:"md:col-span-2",children:r.jsx(Yr,{profile:e,updateProfile:n,upsertAchievements:i})})]}):r.jsxs("div",{className:"card p-6",children:[r.jsx("p",{className:"text-muted-foreground",children:"Välj eller skapa en profil för att säkerhetskopiera/återställa data."}),r.jsx("div",{className:"mt-4",children:r.jsx(o,{to:"/settings",className:"btn btn-primary min-h-[44px]",children:"Till Inställningar"})})]}),g&&r.jsx("div",{className:"mt-6",children:r.jsx(Pr,{})}),r.jsx(Dr,{open:l,onClose:()=>c(!1),shareData:d}),r.jsx(Me,{id:"profile-import-dialog",open:f,onClose:()=>h(!1)})]})}function Or({open:e,onClose:n}){const s=t.useContext(ue)??{get:()=>"off",enabled:()=>!1,all:()=>({}),set:()=>{},setMany:()=>{},clear:()=>{},clearAll:()=>{},saveToProfile:async()=>!1,clearProfileOverrides:async()=>!1},{currentProfile:i,hydrated:l}=se(),[o,c]=t.useState(!1),[d,u]=t.useState(""),[m,p]=t.useState(()=>s.all()),f=t.useMemo(()=>Object.keys(de||s.all()||{}).map(e=>({name:e,state:m[e]??s.get(e)??"off",meta:de?.[e]||{}})),[m,s]);if(!e)return null;const h="idkfa"===d,g="admin-flags-heading",b=r.jsx("div",{className:"fixed inset-0 z-50 grid place-items-center p-4 sm:p-6 bg-black/50",onClick:n,onKeyDown:e=>{"Escape"===e.key&&n?.(),!o&&"Enter"===e.key&&h&&c(!0)},role:"dialog","aria-modal":"true","aria-labelledby":g,children:r.jsx("div",{className:"card flex-none w-full max-w-[calc(100vw-2rem)] sm:max-w-[calc(100vw-3rem)] md:max-w-3xl min-w-[20rem] p-4 md:p-6 mx-auto overflow-auto max-h-[calc(100dvh-3rem)]",onClick:e=>e.stopPropagation(),children:o?r.jsxs(r.Fragment,{children:[r.jsx("h2",{id:g,className:"section-title mb-2",children:"Feature-flaggor"}),r.jsxs("div",{className:"space-y-3 max-h-[60vh] overflow-auto pr-1",children:[f.map(e=>r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-[minmax(0,1fr)_12rem] md:grid-cols-[minmax(0,1fr)_14rem] items-start sm:items-center gap-2 sm:gap-4",children:[r.jsxs("div",{className:"min-w-0",children:[r.jsx("div",{className:"font-medium",children:e.meta.title||e.name}),e.meta.message&&r.jsx("div",{className:"text-xs text-muted-foreground",children:e.meta.message})]}),r.jsx("label",{className:"sr-only",htmlFor:`flag-${e.name}`,children:e.meta.title||e.name}),r.jsxs("select",{id:`flag-${e.name}`,className:"select w-full",value:m[e.name]??"off",onChange:t=>p(r=>({...r,[e.name]:t.target.value})),children:[r.jsx("option",{value:"off",children:"Off"}),r.jsx("option",{value:"preview",children:"Preview"}),r.jsx("option",{value:"on",children:"On"})]})]},e.name)),0===f.length&&r.jsx("div",{className:"text-sm text-muted-foreground",children:"Inga flaggor hittades."})]}),r.jsxs("div",{className:"flex gap-2 justify-between mt-4 safe-bottom",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:async()=>{s.clearAll(),p({}),l&&i&&await(s.clearProfileOverrides?.()),n?.()},children:"Återställ till default"}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:n,children:"Stäng"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:async()=>{s.setMany(m),l&&i&&await(s.saveToProfile?.(m)),n?.()},children:"Spara"})]})]})]}):r.jsxs(r.Fragment,{children:[r.jsx("h2",{id:g,className:"section-title mb-2",children:"Admin-läge"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Ange lösenord för att hantera feature-gates."}),r.jsx("label",{className:"field-label sr-only",htmlFor:"admin-password",children:"Lösenord"}),r.jsx("input",{id:"admin-password",type:"password",className:"input mb-3",placeholder:"Lösenord",value:d,onChange:e=>u(e.target.value),autoFocus:!0}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:n,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>h&&c(!0),disabled:!h,children:"Fortsätt"})]})]})})});return a.createPortal(b,document.body)}const Ur=[{id:"0.9.5",date:"2026-01-04",title:"Fler märken och kön i profil",highlights:["Skidskyttemärken är tillagda för granskning","Ett fåtal märken särskiljer kraven för män och kvinnor så profilen måste hålla den informationen","Interaktiv användarguide för trädvyn med stöd för mobil och helskärmsläge"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.5"},{id:"0.9.4",date:"2026-01-04",title:"Buggfixar",highlights:["Mindre buggfixar"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.4"},{id:"0.9.3",date:"2026-01-03",title:"Användarguide",highlights:["Interaktiv användarguide för medaljlistan","Hänvisa till regelbok version 20 tillsvidare"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.3"},{id:"0.9.2",date:"2026-01-01",title:"Versionsnytt",highlights:["Versionsinformation med förändringslogg tillagd."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.2"},{id:"0.9.1",date:"2025-12-31",title:"Uppdateringar av märken för luftpistol",highlights:["Årsmärken för luftpistol korrigerade."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.1"},{id:"0.9.0",date:"2025-12-31",title:"Ny trädvy",highlights:["Ny trädvy för märken med tidslinje per märkestyp."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.0"}];function Br(){const e="undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/",[n,s]=t.useState(!1),a=i(),o=l(),c=(()=>{const e=Tt();return Et()!==e})();return r.jsxs("div",{className:"max-w-3xl mx-auto px-4 sm:px-6 py-6",children:[r.jsxs("article",{className:"prose prose-headings:text-foreground prose-p:text-foreground prose-a:text-primary dark:prose-invert max-w-none",children:[r.jsxs("header",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:$e}),r.jsx("p",{className:"mt-2 text-muted-foreground",children:"Spåra dina skyttemärken och medaljer enligt Svenska Pistolskytteförbundets regler"})]}),r.jsx(Je,{id:"disclaimer-about",variant:"warning",text:"Fristående app. Regelboken gäller före appen.",linkUrl:Fe}),r.jsxs("section",{"aria-labelledby":"about-links",className:"mt-8",children:[r.jsx("h2",{id:"about-links",className:"text-2xl font-semibold",children:"Användbara länkar"}),r.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[r.jsx("li",{children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary inline-flex items-center min-h-[44px]",href:Te,target:"_blank",rel:"noreferrer noopener",children:"SPSF"})}),r.jsx("li",{children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary inline-flex items-center min-h-[44px]",href:Ee,target:"_blank",rel:"noreferrer noopener",children:"GitHub-projekt"})})]})]}),r.jsxs("section",{"aria-labelledby":"about-author",className:"mt-8",children:[r.jsx("h2",{id:"about-author",className:"text-2xl font-semibold",children:"Skapare"}),r.jsx("p",{className:"mt-2",children:qe})]}),r.jsxs("section",{"aria-labelledby":"about-support",className:"mt-8",children:[r.jsx("h2",{id:"about-support",className:"text-2xl font-semibold",children:"Stötta projektet"}),r.jsx("p",{className:"mt-2",children:"Gillar du appen? Bjud utvecklaren på en kaffe."}),r.jsx("p",{className:"mt-2",children:r.jsx("a",{className:"inline-flex items-center rounded focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:_e,target:"_blank",rel:"noreferrer noopener","aria-label":"Köp en kaffe (öppnas i ny flik)",children:r.jsx("img",{src:"https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png",alt:"Köp en kaffe",height:"48",className:"h-12",loading:"lazy"})})})]}),r.jsxs("section",{"aria-labelledby":"about-version",className:"mt-8",children:[r.jsxs("h2",{id:"about-version",className:"text-2xl font-semibold",children:[r.jsx("button",{type:"button",className:"inline p-0 m-0 bg-transparent decoration-dotted underline-offset-4 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",onClick:()=>s(!0),"aria-label":"Öppna admin",children:"Om"})," ","versionen"]}),r.jsxs("p",{className:"mt-2",children:["Den här versionen använder skjuthandboken upplaga: ",r.jsx("strong",{children:Oe})," (2024)"]}),r.jsxs("p",{className:"mt-2 text-muted-foreground",children:["Version: ",r.jsx("code",{children:he.version})," • Build: ",r.jsx("code",{children:he.number})," • Commit: ",r.jsx("code",{children:he.commit})]}),r.jsxs("p",{className:"mt-1 text-muted-foreground",children:["Byggtid: ",r.jsx("time",{dateTime:he.timeISO,children:new Date(he.timeISO).toLocaleString()})]}),r.jsx("div",{className:"mt-3",children:r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>o("/whats-new",{state:{backgroundLocation:a}}),"aria-label":"Visa vad som är nytt",children:c?"Visa nyheter (Ny)":"Visa nyheter"})})]}),r.jsxs("section",{"aria-labelledby":"about-whatsnew",className:"mt-8",children:[r.jsx("h2",{id:"about-whatsnew",className:"text-2xl font-semibold",children:"Versionsnytt"}),r.jsx("p",{className:"mt-2 text-muted-foreground",children:"Kort sammanfattning av senaste ändringarna. Öppna modalen för en fokuserad vy."}),r.jsx("div",{className:"mt-3 space-y-3",children:Ur.map(e=>r.jsxs("article",{className:"rounded-lg border border-border p-3",children:[r.jsxs("h3",{className:"text-base font-semibold",children:[e.title||"Uppdatering"," • ",e.date," • ",e.id]}),r.jsx("ul",{className:"mt-2 list-disc pl-5 space-y-1 text-sm",children:(e.highlights||[]).map((e,t)=>r.jsx("li",{children:e},t))}),e.link&&r.jsx("p",{className:"mt-2",children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:e.link,target:"_blank",rel:"noreferrer noopener",children:"Läs mer"})})]},e.id))})]}),r.jsxs("section",{"aria-labelledby":"about-license",className:"mt-8",children:[r.jsx("h2",{id:"about-license",className:"text-2xl font-semibold",children:"Licens"}),r.jsxs("p",{className:"mt-2",children:["Denna applikation är licensierad under ",r.jsx("strong",{children:Le}),". Se ",r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:`${e}LICENSE`,target:"_blank",rel:"noreferrer noopener",children:"LICENSE"})," för fullständig text."]})]})]}),r.jsx(Or,{open:n,onClose:()=>s(!1)})]})}function Gr({medal:e,open:n,onClose:s}){const a=ae(),{currentProfile:i,unlockMedal:l}=se(),o=!!i?.features?.allowManualUnlock,[c,d]=t.useState(""),u=t.useMemo(()=>{if(!n||!a||!e?.id)return[];try{return a.getEligibleYears(e.id)||[]}catch{return[]}},[n,a,e]),m=t.useMemo(()=>{const e=i?.dateOfBirth;if(!e)return null;const t=new Date(e).getFullYear();return Number.isFinite(t)?t:null},[i]),p=(new Date).getFullYear(),f=t.useMemo(()=>{if(!a||!e)return null;try{return a.getEarliestCountingYearForMedal(e)}catch{return null}},[a,e]),h=t.useMemo(()=>{if(!a||!e)return null;try{return a.getMinimalUnlockYearForSustained(e)}catch{return null}},[a,e]),g=!!i?.features?.enforceCurrentYearForSustained,b=Array.isArray(e?.requirements)&&e.requirements.some(e=>"sustained_achievement"===e?.type),x=t.useCallback(()=>{if(!a||!e)return"";if(g&&b){if(o)return p;if(u?.includes(p))return p}if(!o)return u&&0!==u.length?Math.min(...u):"";const t=(()=>{const e=[];return"number"==typeof f&&e.push(f),"number"==typeof h&&e.push(h),e.length?Math.max(...e):null})(),r=Math.max(Number.isFinite(m)?m:-1/0,Number.isFinite(t)?t:-1/0);for(let n=Number.isFinite(r)?r:p;n<=p;n++)try{const t=a.checkPrerequisites(e,n);if(t?.allMet)return n}catch{}return g&&b?p:""},[o,a,e,u,f,h,m,p,g,b]),y=t.useMemo(()=>{if(!n)return"";const e=x();return""!==e&&Number.isFinite(e)?e:""},[n,x]),v=o?""===c?y:c:null,w=o?""===v?"":Number(v):u.length<=1?u[0]??"":c||(u[0]??""),j=o&&(!Number.isFinite(w)||"number"!=typeof m||w<m||w>p),k=g&&b&&Number.isFinite(w)&&w!==p,N=(()=>{const e=[];return"number"==typeof f&&e.push(f),"number"==typeof h&&e.push(h),0===e.length?null:Math.max(...e)})(),S=o&&Number.isFinite(w)&&"number"==typeof N&&w<N,C=o?!j&&!k&&!S:""!==w,M=t.useMemo(()=>{if(!o)return!0;if(!a||!e?.id||!Number.isFinite(w))return!1;try{const t=a.checkPrerequisites(e,w);return!!t?.allMet}catch{return!1}},[o,a,e,w]),A=o?C&&M:u.length>0&&""!==w,I=async()=>{if(!A)return;const t=`${o?w:Number(w)}-12-31`;await l(e.id,t),s?.()};return r.jsx(Ne,{id:"unlock-medal",title:`Lås upp ${e?.displayName||"medalj"}`,open:n,onClose:s,swipeToDismiss:!0,children:o?r.jsxs("form",{className:"space-y-4",onSubmit:e=>{e.preventDefault(),A&&I()},noValidate:!0,children:[r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"unlock-year",className:"field-label mb-2",children:["År","number"==typeof N&&r.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["(Tidigast: ",N,")"]})]}),r.jsx("input",{id:"unlock-year",type:"number",inputMode:"numeric",className:"input py-3 mb-2",min:m??void 0,max:p,list:"eligible-years",value:v,onChange:e=>{const t=e.target.value;d(""===t?"":Number(t))},"aria-invalid":(()=>{if(o&&""!==c&&Number.isFinite(w))return!!(j||k||S||C&&!M)||void 0})(),"aria-describedby":"unlock-year-hint"}),r.jsx("datalist",{id:"eligible-years",children:u.map(e=>r.jsx("option",{value:e},e))}),r.jsxs("p",{id:"unlock-year-hint",className:"field-hint mt-2",children:["Välj ett år mellan ",m," och ",p,". Vi stämmer av med förhandskraven för året."]}),(()=>{if(!o)return null;if(""===c||!Number.isFinite(w))return null;let e=null;return j?e=`Året måste vara mellan ${m} och ${p}.`:k?e="Det här märket kräver att innevarande år väljs.":S?e=`Tidigaste året du kan låsa upp märket är ${N}.`:M||(e=`Förhandskraven är inte mötta för ${w}.`),e?r.jsx("p",{className:"field-hint mt-2 text-danger",role:"status",children:e}):null})()]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:s,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px]",disabled:!A,children:"Lås upp"})]})]}):0===u.length?r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-text-secondary",children:"Inga giltiga år funna."}),r.jsx("div",{className:"flex justify-end",children:r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:s,children:"Stäng"})})]}):1===u.length?r.jsxs("div",{className:"space-y-4",children:[r.jsxs("p",{className:"text-sm",children:["Lås upp för: ",r.jsx("strong",{children:u[0]}),"?"]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:s,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:I,children:"Lås upp"})]})]}):r.jsxs("form",{className:"space-y-4",onSubmit:e=>{e.preventDefault(),""!==w&&I()},noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"unlock-year",className:"field-label mb-2",children:"År"}),r.jsx("select",{id:"unlock-year",className:"select py-3",value:w,onChange:e=>d(Number(e.target.value)),children:u.map(e=>r.jsx("option",{value:e,children:e},e))})]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:s,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px]",disabled:""===w,children:"Lås upp"})]})]})})}function Vr({medal:e,open:t,onClose:n,variant:s="confirm",blockingMedals:a=[],onConfirmRemove:i}){const l=`${e?`remove-medal-${e.id}`:"remove-medal"}-${s}`;return r.jsx(Ne,{id:l,title:"confirm"===s?"Ta bort upplåsning":"Kan inte ta bort än",open:t,onClose:n,children:"confirm"===s?r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground",children:"Det här påverkar inte andra märken."}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{type:"button",onClick:n,className:"btn btn-muted flex-1 min-h-[44px]",children:"Avbryt"}),r.jsx("button",{type:"button",onClick:async()=>{const e=await(i?.());e?.ok&&n?.()},className:"btn btn-primary flex-1 min-h-[44px]",children:"Ta bort"})]})]}):r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground",children:"De här upplåsta märkena beror på detta:"}),r.jsx("ul",{className:"text-sm text-muted-foreground list-disc ml-5 space-y-1",children:a.map(e=>r.jsx("li",{className:"break-words",children:e.displayName||e.name},e.id))}),r.jsx("div",{className:"pt-1",children:r.jsx("button",{type:"button",onClick:n,className:"btn btn-muted w-full min-h-[44px]",children:"OK"})})]})})}function zr(e){const{medalDatabase:r}=ne(),{currentProfile:n,lockMedal:s}=se(),a=t.useMemo(()=>function(e=[]){const t=new Map;for(const r of e){const e=Array.isArray(r?.prerequisites)?r.prerequisites:[];for(const n of e)n&&"medal"===n.type&&n.medalId&&(t.has(n.medalId)||t.set(n.medalId,new Set),t.get(n.medalId).add(r.id))}return t}(r?.getAllMedals?.()||[]),[r]),i=t.useMemo(()=>function(e,t){const r=new Set;if(!e||!t)return r;const n=[e];for(;n.length;){const e=n.shift(),s=t.get(e);if(s)for(const t of s)r.has(t)||(r.add(t),n.push(t))}return r}(e,a),[e,a]),l=t.useMemo(()=>new Set((n?.unlockedMedals||[]).map(e=>e.medalId)),[n]),o=t.useMemo(()=>Array.from(i).filter(e=>l.has(e)),[i,l]),c=0===o.length,d=t.useCallback(async()=>{if(!e)return{ok:!1};if(!c)return{ok:!1,blocking:o};return{ok:!!(await s(e))}},[e,c,o,s]);return{canRemove:c,blocking:o,tryRemove:d}}function Kr({met:e}){return r.jsx(Se,{name:e?"CheckCircle2":"Circle",className:e?"w-4 h-4 text-foreground shrink-0":"w-4 h-4 text-muted-foreground shrink-0"})}function Hr({id:e,label:t,met:n,summary:s,expanded:a,onToggle:i}){return r.jsxs("button",{type:"button",onClick:i,"aria-expanded":a,"aria-controls":e,className:["w-full text-left inline-flex items-center justify-between","px-2 py-2 rounded","hover:bg-bg-secondary","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","min-h-[44px]"].join(" "),children:[r.jsxs("span",{className:"inline-flex items-center gap-2",children:[r.jsx(Kr,{met:n}),r.jsx("span",{className:"text-sm font-semibold text-foreground",children:t}),s?r.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",s,")"]}):null]}),r.jsx("span",{"aria-hidden":"true",className:"ml-2",children:a?"▼":"▶"})]})}function Wr({leaf:e}){const t=e.description||e.type||"Krav",n=e.progress&&Number.isFinite(e.progress.current)&&Number.isFinite(e.progress.required)?`${e.progress.current}/${e.progress.required}`:null,s=null!=e.windowYear?e.windowYear:null!=e.subtreeYear?e.subtreeYear:null,a=null!=s?`• År ${s}`:null;return r.jsxs("div",{className:"px-2 py-1 flex items-start gap-2",children:[r.jsx(Kr,{met:!!e.isMet}),r.jsxs("span",{className:(e.isMet?"text-foreground":"text-muted-foreground")+" flex-1 min-w-0",children:[t," ",a?r.jsx("span",{className:"text-xs text-muted-foreground",children:a}):null]}),n?r.jsx("span",{className:"ml-auto shrink-0 text-xs text-muted-foreground tabular-nums",children:n}):null]})}function Xr(e=[]){const t=e.length;return{met:e.reduce((e,t)=>e+(t.isMet?1:0),0),total:t}}function Jr({node:e,path:n="root",level:s=0,defaultExpanded:a=0===s}){const[i,l]=t.useState(a),o=`${n}-group`,c="and"===e?.node||"or"===e?.node;if(!e)return null;const d=s>0?"border-l border-border pl-3":"pl-0";if(c){const t=e.children||[];if(1===t.length)return r.jsx(Jr,{node:t[0],path:n,level:s,defaultExpanded:a})}if(!c){const t=e.leaf||{isMet:!1,description:"Okänt krav"};if(t.subtree){const e=`${n}-leaf`,a=t.subtree,o=a&&("and"===a.node||"or"===a.node),c=Array.isArray(a?.children),u=o&&c&&1===a.children.length;if(!o||u)return r.jsx("li",{className:d,children:r.jsx(Jr,{node:t.subtree,path:`${n}-sub`,level:s,defaultExpanded:s<1})});let m=null;const p="and"===a.node?"Alla följande":"Minst en av följande",f=t.description||p;if(c){const{met:e,total:r}=Xr(a.children),n=`${e}/${r} uppfyllda`;m=t.description?`${p} • ${n}`:n}return r.jsxs("li",{className:d,children:[r.jsx(Hr,{id:e,label:f,met:!!t.isMet,summary:m,expanded:i,onToggle:()=>l(e=>!e)}),i&&r.jsx("ul",{id:e,role:"group",className:"ml-2 list-none m-0 p-0",children:(Array.isArray(a.children)?a.children:[]).map((e,t)=>r.jsx(Jr,{node:e,path:`${n}-sub-${t}`,level:s+1,defaultExpanded:s<1},`${n}-sub-${t}`))})]})}return r.jsx("li",{className:d,children:r.jsx(Wr,{leaf:t})})}const u=e.children||[],{met:m,total:p}=Xr(u),f="and"===e.node?"Alla följande":"Minst en av följande",h=`${m}/${p} uppfyllda`;return r.jsxs("li",{className:d,children:[r.jsx(Hr,{id:o,label:f,met:!!e.isMet,summary:h,expanded:i,onToggle:()=>l(e=>!e)}),i&&r.jsx("ul",{id:o,role:"group",className:"ml-2 list-none m-0 p-0",children:u.map((e,t)=>r.jsx(Jr,{node:e,path:`${n}-${t}`,level:s+1,defaultExpanded:s<1},`${n}-${t}`))})]})}function Zr({tree:e,bare:n=!1}){const s=t.useMemo(()=>{let t=e||null;for(;t&&("and"===t.node||"or"===t.node)&&Array.isArray(t.children)&&1===t.children.length;)t=t.children[0];return t},[e]);if(!s)return null;const a="and"===s.node,i=r.jsx("ul",{className:"list-none m-0 p-0 text-sm text-muted-foreground space-y-1",children:a?(s.children||[]).map((e,t)=>r.jsx(Jr,{node:e,path:`root-${t}`,level:0,defaultExpanded:!0},`root-${t}`)):r.jsx(Jr,{node:s,level:0,defaultExpanded:!0})});return n?i:r.jsx("div",{className:"bg-background border border-border rounded p-3",role:"region","aria-label":"Krav",children:i})}function Qr({id:e,title:n,summary:s,collapsible:a=!1,defaultOpen:i=!0,children:l}){const o=t.useId(),c=e?`${e}-body`:`${o}-body`,[d,u]=t.useState(i),m=a?"button":"div",p=a?{type:"button",onClick:()=>u(e=>!e),"aria-expanded":d,"aria-controls":c}:{};return r.jsxs("div",{className:"mb-4 bg-background border border-border rounded",children:[r.jsxs(m,{...p,className:"w-full text-left px-3 py-2 flex items-center justify-between hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded-t min-h-[44px]",children:[r.jsx("span",{className:"text-sm font-semibold text-foreground",children:n}),r.jsxs("span",{className:"inline-flex items-center gap-2 text-xs text-muted-foreground",children:[s?r.jsxs("span",{children:["(",s,")"]}):null,a?r.jsx("span",{"aria-hidden":"true",children:d?"▼":"▶"}):null]})]}),(!a||d)&&r.jsx("div",{id:c,className:"px-3 pb-3",children:l})]})}function en({status:e,className:t="",id:n,...s}){const a=jr(e);return a?r.jsxs("span",{id:n,className:`${a.className} ${t}`.trim(),title:a.description,"aria-label":`${a.label}. ${a.description}`,...s,children:[r.jsx(Se,{name:a.icon,className:"w-4 h-4"}),r.jsx("span",{children:a.label})]}):null}const tn=t.lazy(()=>e(()=>import("./vendor-D9hX5c7Y.js").then(e=>e.p),[]));function rn({medalId:e,onClose:n,onNavigateMedal:s}){const{medalDatabase:a}=ne(),o=ie(),c=ae(),{currentProfile:d}=se(),u=!!d?.features?.allowManualUnlock,m=a?.getMedalById(e),[p,f]=t.useState(!1),h=l(),g=i(),b=m?`medal-req-original-${m.id}`:void 0,x=m?`medal-unlock-targets-${m.id}`:void 0,{canRemove:v,blocking:w,tryRemove:j}=zr(e),[k,N]=t.useState(!1),[S,C]=t.useState(!1),M=t.useMemo(()=>o&&(o.unlocked.find(t=>t.medalId===e)||o.eligible.find(t=>t.medalId===e)||o.available.find(t=>t.medalId===e)||o.locked.find(t=>t.medalId===e))||null,[o,e]),A=t.useMemo(()=>"unlocked"!==M?.status?null:M?.unlockedDate||c?.getUnlockedDate?.(e)||null,[M,c,e]),I=t.useMemo(()=>{if(!A)return null;const e=new Date(A);return Number.isNaN(e.getTime())?null:e.getFullYear()},[A]),D=t.useMemo(()=>{if(!m)return null;const e=M?.details?.tree;if(e)return e;try{return c?.checkRequirements?.(m)?.tree??null}catch{return null}},[c,m,M]),P=t.useMemo(()=>{if(!D)return null;const e={met:0,total:0},t=r=>{if(r){if("leaf"===r.node)return e.total+=1,void(r.leaf?.isMet&&(e.met+=1));for(const e of r.children||[])t(e)}};return t(D),e},[D]),T=t.useMemo(()=>{if(!c||!m)return{allMet:!0,items:[],missingItems:[]};try{return c.checkPrerequisites(m)}catch{return{allMet:!0,items:[],missingItems:[]}}},[c,m]),E=t.useMemo(()=>{const e=new Set;for(const t of T.missingItems||[])t&&"medal"===t.type&&t.offsetChecked&&e.add(t.medalId);return e},[T]),_=t.useMemo(()=>(T.items||[]).map(e=>{if("medal"===e.type){const t=a?.getMedalById?.(e.medalId),r=E.has(e.medalId);return{...e,displayName:t?.displayName||t?.name||e.medalId,displayMet:e.isMet&&!r,gapFailed:r}}return e}),[T,E,a]),F=t.useMemo(()=>{const e=_||[],t=e.length;return{met:e.reduce((e,t)=>e+(t.displayMet?1:0),0),total:t}},[_]),$=!0===T?.allMet,q=m?`unlock-prereq-hint-${m.id}`:void 0,L=t.useMemo(()=>(w||[]).map(e=>a?.getMedalById(e)).filter(Boolean),[w,a]),Y=t.useMemo(()=>(Array.isArray(m?.references)?m.references:[]).map(e=>{const t=a?.getMedalById?.(e.medalId);return t?{target:t,description:e.description||""}:null}).filter(Boolean),[m,a]),R=t.useMemo(()=>{if(!m||!a?.getAllMedals)return[];return a.getAllMedals().filter(e=>e?.id!==m.id&&Array.isArray(e?.prerequisites)&&e.prerequisites.some(e=>"medal"===e?.type&&e.medalId===m.id)).map(e=>({target:e}))},[m,a]),O=t.useRef(null),U=t.useRef(null),B=t.useRef(null),G=`medal-detail-title-${e||"unknown"}`,V=!!m&&("function"==typeof m.isPlaceholder?m.isPlaceholder():"placeholder"===m.status),z=!(!m||V)&&("function"==typeof m.isUnderReview?m.isUnderReview():"under_review"===m.status),K=m?.description?`medal-detail-desc-${e||"unknown"}`:null,H=z&&m?`under-review-note-${m.id}`:null,W=V&&m?`placeholder-note-${m.id}`:null,X=[K,H,W].filter(Boolean).join(" ")||void 0;if(t.useEffect(()=>{if(!m)return;B.current="undefined"!=typeof document?document.activeElement:null;const e="undefined"!=typeof document?document.body:null,t=e?e.style.overflow:"";e&&(e.style.overflow="hidden");const r=U.current;r&&(r.classList.remove("translate-y-full","sm:translate-x-full"),r.classList.add("translate-y-0","sm:translate-x-0"));const s=setTimeout(()=>{const e=U.current?.querySelector(`#${G}`);e&&e.focus?e.focus():U.current?.focus()},0),a=e=>{"Escape"===e.key&&(e.preventDefault(),n?.())};return window.addEventListener("keydown",a),()=>{clearTimeout(s),window.removeEventListener("keydown",a),e&&(e.style.overflow=t);const r=B.current;if(r&&"function"==typeof r.focus)try{r.focus()}catch{}}},[n,G,m]),t.useEffect(()=>{if(!m)return;if("undefined"==typeof document)return;const t=document.title,r=m.displayName||m.name||String(e);try{document.title=`${r} - Detaljer`}catch{}return()=>{try{document.title=t}catch{}}},[m,e]),!m)return null;const J={ul:e=>r.jsx("ul",{className:"list-disc pl-5 my-2 space-y-1",...e}),ol:e=>r.jsx("ol",{className:"list-decimal pl-5 my-2 space-y-1",...e}),li:e=>r.jsx("li",{className:"marker:text-muted-foreground",...e}),table:e=>r.jsx("div",{className:"my-2 overflow-x-auto",children:r.jsx("table",{className:"w-full text-sm border-collapse",...e})}),thead:e=>r.jsx("thead",{className:"bg-bg-secondary",...e}),th:e=>r.jsx("th",{className:"border border-border px-2 py-1 text-left font-semibold",...e}),td:e=>r.jsx("td",{className:"border border-border px-2 py-1 align-top",...e}),a:({href:e,children:t,...n})=>r.jsx("a",{href:e,className:"underline text-primary hover:text-primary-hover",target:"_blank",rel:"noopener noreferrer",...n,children:t}),code:e=>r.jsx("code",{className:"px-1 py-0.5 rounded bg-bg-secondary",...e})},Z=e=>t=>{if(!!(0!==t.button||t.metaKey||t.ctrlKey||t.altKey||t.shiftKey))return;if(t.preventDefault(),"function"==typeof s)return void s(e);const r=g.state?.backgroundLocation;h(`/medals/${e}`,{state:r?{backgroundLocation:r}:void 0})};return r.jsxs("div",{ref:O,onClick:e=>{e.target===O.current&&n?.()},className:"fixed inset-0 z-50 bg-black/50",children:[r.jsx("div",{ref:U,role:"dialog","data-tour":"medal-detail-panel","aria-modal":"true","aria-labelledby":G,"aria-describedby":X,tabIndex:-1,onKeyDown:e=>{if("Tab"!==e.key)return;const t=U.current;if(!t)return;const r=t.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');if(0===r.length)return void e.preventDefault();const n=r[0],s=r[r.length-1],a=document.activeElement;e.shiftKey&&a===n?(e.preventDefault(),s.focus()):e.shiftKey||a!==s||(e.preventDefault(),n.focus())},className:["pointer-events-auto fixed","inset-x-0 bottom-0 w-full h-[90svh] max-h-[90vh]","sm:inset-y-0 sm:right-0 sm:left-auto sm:w-[32rem] sm:h-full","bg-bg-secondary shadow-2xl overflow-hidden","rounded-t-2xl sm:rounded-none sm:rounded-l-2xl","transform transition-transform duration-200 ease-out motion-reduce:transition-none","translate-y-full sm:translate-y-0 sm:translate-x-full","focus:outline-none"].join(" "),children:r.jsxs("div",{className:"flex h-full flex-col",children:[r.jsxs("div",{className:"sticky top-0 z-10 flex items-start justify-between gap-4 p-4 sm:p-6 bg-bg-secondary border-b border-border",children:[r.jsx("div",{className:"min-w-0",children:r.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[r.jsx("h2",{id:G,"data-tour":"medal-detail-title",className:"text-xl sm:text-2xl font-bold text-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary break-words",tabIndex:-1,children:m.displayName}),r.jsx("div",{role:"status","aria-live":"polite",className:"mt-1 sm:mt-0",children:V?r.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-900 border border-indigo-300 dark:bg-indigo-900/30 dark:text-indigo-200 dark:border-indigo-700","aria-label":"Status: plats­hållare",children:[r.jsx(pt,{status:"placeholder",className:"w-3.5 h-3.5"}),"Plats­hållare"]}):r.jsx(en,{status:M?.status||"locked"})}),z&&r.jsxs("span",{className:"mt-1 sm:mt-0 inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-900 border border-amber-300 dark:bg-amber-900/40 dark:text-amber-200 dark:border-amber-700","aria-label":"Status för regler: under granskning",children:[r.jsx(pt,{status:"review",className:"w-3.5 h-3.5"}),"Under granskning"]})]})}),r.jsx("button",{onClick:n,className:"shrink-0 inline-flex h-10 w-10 items-center justify-center rounded-md text-foreground hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary","aria-label":"Stäng medal-detaljer",title:"Stäng",children:r.jsx("span",{"aria-hidden":"true",children:"✕"})})]}),r.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto overscroll-contain p-4 sm:p-6",children:[r.jsx("div",{className:"mb-4",children:r.jsx(Je,{id:"disclaimer-rules",variant:"warning",text:"Regelboken gäller före appens tolkning. Kontrollera alltid senaste officiella regelbok.",linkUrl:Fe})}),V&&r.jsxs(r.Fragment,{children:[r.jsx("p",{id:W,className:"sr-only",children:"Detta är ett platshållarmärke. Avsnitten nedan visar exempel på information som kommer att finnas här när märket publiceras."}),r.jsx(Qr,{id:`placeholder-unlocked-${m.id}`,title:"Upplåst",collapsible:!1,children:r.jsx("p",{className:"text-sm text-muted-foreground",children:"Här visas normalt vilket år du låste upp märket."})}),r.jsx(Qr,{id:`placeholder-prereq-${m.id}`,title:"Förhandskrav",collapsible:!1,children:r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[r.jsx("li",{children:"• Exempel: krav eller förkunskap 1"}),r.jsx("li",{children:"• Exempel: krav eller förkunskap 2"}),r.jsx("li",{children:"• Exempel: krav eller förkunskap 3"})]})}),r.jsx(Qr,{id:`placeholder-req-${m.id}`,title:"Krav",collapsible:!1,children:r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[r.jsxs("li",{children:[r.jsx("span",{className:"text-foreground",children:"✓"})," Exempel: uppfyllt krav"]}),r.jsxs("li",{children:[r.jsx("span",{className:"text-muted-foreground",children:"○"})," Exempel: krav som återstår"]}),r.jsxs("li",{children:[r.jsx("span",{className:"text-muted-foreground",children:"○"})," Exempel: ytterligare krav"]})]})}),r.jsx(Qr,{id:K||`placeholder-desc-${m.id}`,title:"Beskrivning",collapsible:!1,children:r.jsx("p",{className:"text-muted-foreground break-words",children:"Beskrivning kommer att visas här när innehållet är klart."})}),r.jsx(Qr,{id:b,title:"Visa ursprunglig kravtext",collapsible:!0,defaultOpen:!1,children:r.jsx("div",{className:"text-sm text-foreground break-words",children:r.jsx(t.Suspense,{fallback:null,children:r.jsx(tn,{remarkPlugins:[y],components:J,children:"Det här avsnittet visar vanligtvis den ursprungliga kravtexten från regelboken.\n\n- Exempelpunkt 1\n- Exempelpunkt 2\n- Exempelpunkt 3"})})})}),r.jsx(Qr,{id:`placeholder-refs-${m.id}`,title:"Uppfyller också kraven för",collapsible:!1,children:r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:r.jsx("li",{children:"• Kommer snart"})})}),r.jsx(Qr,{id:`placeholder-required-for-${m.id}`,title:"Detta märke krävs för",collapsible:!1,children:r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:r.jsx("li",{children:"• Kommer snart"})})})]}),!V&&null!=I&&r.jsx(Qr,{id:`unlocked-${m.id}`,title:"Upplåst",collapsible:!1,children:r.jsx("div",{role:"status","aria-live":"polite",children:r.jsx("p",{className:"text-sm text-foreground",children:r.jsx("time",{dateTime:function(){try{return new Date(A).toISOString().slice(0,10)}catch{return String(A)}}(),children:I})})})}),!V&&_.length>0&&r.jsx(Qr,{id:`prereq-${m.id}`,title:"Förhandskrav",summary:`${F.met}/${F.total} uppfyllda`,collapsible:!1,children:r.jsx("ul",{className:"list-none m-0 p-0 text-sm text-muted-foreground space-y-1",children:_.map((e,t)=>r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Se,{name:e.displayMet?"CheckCircle2":"Circle",className:e.displayMet?"w-4 h-4 text-foreground shrink-0":"w-4 h-4 text-muted-foreground shrink-0"}),r.jsx("span",{className:"sr-only",children:e.displayMet?"Uppfyllt":"Saknas"}),r.jsx("span",{className:"text-foreground flex-1 min-w-0 break-words",children:"medal"===e.type?e.displayName||e.medalId:e.description||e.type}),"medal"===e.type&&"number"==typeof e.yearOffset?r.jsxs("span",{className:e.gapFailed?"text-danger":"text-muted-foreground",children:["Kräver ",e.yearOffset," års gap"]}):null]},t))})}),z&&r.jsx("div",{id:`under-review-note-${m.id}`,className:"mb-4 alert alert-warning",children:"Reglerna för det här märket är under granskning och kan komma att ändras."}),!V&&m.description&&r.jsx("div",{className:"mb-4",children:r.jsx("p",{id:K,className:"text-muted-foreground break-words",children:m.description})}),!V&&M?.details?.missingItems?.length>0&&r.jsxs("div",{className:"mb-4 bg-background border border-border rounded p-3",children:[r.jsx("p",{className:"text-sm font-semibold text-foreground mb-2",children:"Saknade förhandskrav:"}),r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:M.details.missingItems.map((e,t)=>r.jsxs("li",{className:"break-words",children:["• ",e.description]},t))})]}),!V&&D&&r.jsx(Qr,{id:`req-${m.id}`,title:"Krav",summary:P?`${P.met}/${P.total} uppfyllda`:void 0,collapsible:!1,children:r.jsx(Zr,{tree:D,bare:!0})}),!V&&m.requirementsOriginal&&r.jsx(Qr,{id:b,title:"Visa ursprunglig kravtext",collapsible:!0,defaultOpen:!1,children:r.jsx("div",{className:"text-sm text-foreground break-words",children:r.jsx(t.Suspense,{fallback:null,children:r.jsx(tn,{remarkPlugins:[y],components:J,children:m.requirementsOriginal})})})}),!V&&Y.length>0&&r.jsx(Qr,{id:`refs-${m.id}`,title:"Uppfyller också kraven för",summary:`${Y.length}`,collapsible:!0,defaultOpen:!1,children:r.jsx("ul",{className:"space-y-1",children:Y.map(({target:e})=>r.jsx("li",{children:r.jsx("a",{href:`/medals/${e.id}`,onClick:Z(e.id),className:"inline-flex items-center underline text-primary hover:text-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary px-2 py-2 rounded min-h-[44px]",children:e.displayName||e.name})},e.id))})}),!V&&R.length>0&&r.jsx(Qr,{id:x,title:"Detta märke krävs för",summary:`${R.length}`,collapsible:!0,defaultOpen:!1,children:r.jsx("ul",{className:"space-y-1",children:R.map(({target:e})=>r.jsx("li",{children:r.jsx("a",{href:`/medals/${e.id}`,onClick:Z(e.id),className:"inline-flex items-center underline text-primary hover:text-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary px-2 py-2 rounded min-h-[44px]",children:e.displayName||e.name})},e.id))})})]}),r.jsxs("div",{className:"flex gap-3 p-4 sm:p-6 border-t border-border pb-[calc(env(safe-area-inset-bottom)+1rem)]",children:[r.jsx("button",{onClick:n,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-background text-foreground hover:bg-bg-secondary ring-1 ring-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Stäng"}),"unlocked"===M?.status&&d&&!V&&r.jsxs("div",{className:"flex-1 flex items-center gap-2",children:[r.jsx("button",{type:"button",onClick:()=>{v?(C(!1),N(!0)):(N(!1),C(!0))},"aria-haspopup":"dialog","aria-expanded":k||S,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-background text-foreground hover:bg-bg-secondary ring-1 ring-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Ta bort upplåst"}),!v&&r.jsx("button",{type:"button",onClick:()=>C(!0),className:"text-sm text-muted-foreground underline","aria-label":"Why can’t I remove this medal?",children:"Varför kan jag inte?"})]}),d&&!V&&("eligible"===M?.status||u&&"unlocked"!==M?.status)&&r.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[r.jsx("button",{type:"button",onClick:()=>f(!0),"aria-haspopup":"dialog","aria-controls":"unlock-medal",disabled:!$,"aria-disabled":!$,"aria-describedby":$?void 0:q,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary-hover disabled:opacity-60 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Lås upp nu"}),!$&&r.jsx("p",{id:q,className:"text-xs text-muted-foreground",children:"Förhandskraven måste uppnåst innan märket kan låsas upp."})]})]})]})}),r.jsx(Gr,{medal:m,open:p,onClose:()=>f(!1)}),r.jsx(Vr,{medal:m,open:k,onClose:()=>N(!1),variant:"confirm",onConfirmRemove:j}),r.jsx(Vr,{medal:m,open:S,onClose:()=>C(!1),variant:"blocked",blockingMedals:L})]})}function nn({children:e}){const{currentProfile:t}=se(),n=l(),[s,a]=b.useState(!1),[i,o]=b.useState(!0);return t&&!t.isGuest?e:r.jsxs("div",{className:"p-6",children:[r.jsxs("div",{className:"card block p-6 w-full min-w-full max-w-xl mx-auto",role:"region","aria-labelledby":"profile-required-heading",children:[r.jsx("h2",{id:"profile-required-heading",className:"section-title mb-2",children:"Profil krävs för att fortsätta"}),r.jsxs("div",{className:"text-sm text-muted-foreground space-y-3 mb-4",children:[r.jsx("p",{children:"För att använda Inställningar och import/export behöver du en sparad profil."}),r.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[r.jsx("li",{children:"Spara dina framsteg och säkerhetskopiera data"}),r.jsx("li",{children:"Hantera inställningar per profil"}),r.jsx("li",{children:"Exportera och importera mellan enheter"})]}),t?.isGuest&&r.jsx("p",{children:"Du kan spara ditt nuvarande Gästläge som en profil och fortsätta utan att förlora något."})]}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",autoFocus:!0,onClick:()=>{o(!0),a(!0)},"aria-haspopup":"dialog","aria-controls":"save-progress-picker-guard",children:"Skapa profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>{o(!1),a(!0)},"aria-haspopup":"dialog","aria-controls":"save-progress-picker-guard",children:"Välj profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>n("/medals"),children:"Tillbaka till märken"})]})]}),r.jsx(Ae,{id:"save-progress-picker-guard",mode:"picker",open:s,onClose:()=>a(!1),forceCreate:i,convertGuest:!0})]})}function sn(){const e=l(),n=i(),s=n.state?.backgroundLocation,a=Tt(),o=t.useMemo(()=>function(e){const t=[...Ur].sort((e,t)=>{const r=String(e.id).split(".").map(e=>parseInt(e,10)||0),n=String(t.id).split(".").map(e=>parseInt(e,10)||0);for(let s=0;s<3;s++)if(r[s]!==n[s])return n[s]-r[s];return 0});if(!e)return t;const r=t.findIndex(t=>t.id===e);return r<=0?t:t.slice(0,r)}(Et()),[]),c=t.useRef(null),d=t.useRef(null),u=t.useCallback(()=>{if(function(e){try{e&&localStorage.setItem(Pt,e)}catch{}}(a),s&&s.pathname){const t=`${s.pathname}${s.search||""}${s.hash||""}`;e(t,{replace:!0})}else e(-1)},[a,s,e]);t.useEffect(()=>{d.current=document.activeElement;const e=c.current;if(!e)return;const t=()=>e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),r=e=>{const r=t(),n=r[0],s=r[r.length-1];if("Escape"===e.key)e.preventDefault(),u();else if("Tab"===e.key){if(0===r.length)return;e.shiftKey&&document.activeElement===n?(e.preventDefault(),s?.focus()):e.shiftKey||document.activeElement!==s||(e.preventDefault(),n?.focus())}},n=t();return n[0]?.focus(),e.addEventListener("keydown",r),()=>{e.removeEventListener("keydown",r),d.current&&"function"==typeof d.current.focus&&d.current.focus()}},[u]);const m=o[0]?.link||null,p=o.length>1?`Det finns ${o.length} uppdateringar sedan du senast tittade.`:"Här är det senaste som är nytt i appen.";return r.jsxs("div",{className:"fixed inset-0 z-50",onMouseDown:e=>{e.target===e.currentTarget&&u()},"aria-hidden":!1,children:[r.jsx("div",{className:"absolute inset-0 bg-black/50"}),r.jsx("div",{ref:c,role:"dialog","aria-modal":"true","aria-labelledby":"whatsnew-title","aria-describedby":"whatsnew-desc",className:["card","fixed inset-x-0 bottom-0 w-full max-h-[85vh] rounded-t-2xl shadow-lg","md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2","md:w-[min(90vw,640px)] md:rounded-xl","outline-none"].join(" "),tabIndex:-1,children:r.jsxs("div",{className:"p-4 sm:p-6",children:[r.jsxs("header",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{children:[r.jsx("h2",{id:"whatsnew-title",className:"text-xl font-semibold",children:"Nyheter"}),r.jsx("p",{id:"whatsnew-desc",className:"mt-1 text-sm text-muted-foreground",children:p})]}),r.jsx("button",{type:"button",className:"btn btn-muted","aria-label":"Stäng nyheter",onClick:u,children:"Stäng"})]}),r.jsx("div",{className:"mt-4 space-y-3 overflow-y-auto pr-1",style:{maxHeight:"55vh"},children:o.map((e,t)=>r.jsxs("details",{className:"rounded-lg border border-border p-3",open:0===t,children:[r.jsxs("summary",{className:"cursor-pointer select-none font-medium",children:[e.title||"Uppdatering"," • ",e.date," • ",e.id]}),r.jsx("ul",{className:"mt-2 list-disc pl-5 space-y-1 text-sm",children:(e.highlights||[]).map((e,t)=>r.jsx("li",{children:e},t))}),e.link&&r.jsx("div",{className:"mt-2",children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:e.link,target:"_blank",rel:"noreferrer",children:"Läs mer"})})]},e.id))}),r.jsxs("div",{className:"mt-4 flex items-center justify-end gap-3 safe-bottom",children:[m&&r.jsx("a",{className:"btn btn-secondary",href:m,target:"_blank",rel:"noreferrer",children:"Läs mer"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:u,children:"Ok, visa appen"})]})]})})]})}function an(e,t,r){return Math.max(t,Math.min(r,e))}function ln(e){if(!e)return null;try{return document.querySelector(e)}catch{return null}}function on(){const{open:e,stepIndex:n,steps:s,complete:a,next:i,back:l}=Ie(),o=s?.[n]||null,c=t.useRef(null),d=t.useRef(null),[u,m]=t.useState(null),[p,f]=t.useState(!1),h=t.useCallback(()=>{if(!e)return;if("undefined"==typeof document)return;const t=ln(o?.target);if(!t)return m(null),void f(!1);f(!0);try{const e=t.getBoundingClientRect(),r=window.innerHeight;!(e.bottom>r/2)&&(e.top<0||e.bottom>r)&&t.scrollIntoView({block:"center",inline:"nearest",behavior:"smooth"})}catch{}const r=t.getBoundingClientRect();m({top:r.top,left:r.left,width:r.width,height:r.height,right:r.right,bottom:r.bottom})},[e,o?.target]),g=n>=(s?.length||1)-1,b=t.useMemo(()=>`tour-title-${o?.id||n}`,[o?.id,n]),x=t.useMemo(()=>`tour-desc-${o?.id||n}`,[o?.id,n]),y=t.useMemo(()=>`tour-hint-${o?.id||n}`,[o?.id,n]),v=t.useCallback(()=>{a()},[a]),w=t.useCallback(()=>{a()},[a]),j=!!o?.requiresTarget&&!p,k=t.useCallback(()=>{j||(g?a():i())},[j,g,a,i]),N=t.useCallback(()=>{if("undefined"!=typeof document&&"detail"===o?.id){const e=ln('button[aria-label="Stäng medal-detaljer"]');e?.click?.()}l()},[l,o?.id]);if(t.useEffect(()=>{if(!e)return;if("undefined"==typeof document)return;d.current=document.activeElement;const t=c.current;if(!t)return;const r=()=>t.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),n=e=>{if("Escape"===e.key)return e.preventDefault(),void v();if("Tab"!==e.key)return;const t=r();if(!t.length)return void e.preventDefault();const n=t[0],s=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),s?.focus()):e.shiftKey||document.activeElement!==s||(e.preventDefault(),n?.focus())},s=r();return(s[0]||t)?.focus?.(),t.addEventListener("keydown",n),()=>{t.removeEventListener("keydown",n);const e=d.current;if(e&&"function"==typeof e.focus)try{e.focus()}catch{}}},[e,v]),t.useEffect(()=>{if(!e)return;if("undefined"==typeof window)return;const t=window.requestAnimationFrame(()=>h()),r=window.requestAnimationFrame(()=>h()),n=window.setTimeout(()=>h(),220);let s=0;const a=()=>{s||(s=window.requestAnimationFrame(()=>{s=0,h()}))},i=()=>a();window.addEventListener("resize",i);const l=ln(o?.target),c=l?function(e){if("undefined"==typeof window||!e)return null;let t=e;for(;t&&t!==document.body;){const e=window.getComputedStyle(t).overflowY;if("auto"===e||"scroll"===e)return t;t=t.parentElement}return window}(l):null;return c&&c!==window?c.addEventListener("scroll",a,{passive:!0}):window.addEventListener("scroll",a,!0),()=>{window.cancelAnimationFrame(t),window.cancelAnimationFrame(r),window.clearTimeout(n),window.removeEventListener("resize",i),c&&c!==window?c.removeEventListener("scroll",a):window.removeEventListener("scroll",a,!0),s&&window.cancelAnimationFrame(s)}},[e,n,o?.target,h]),t.useEffect(()=>{if(!e)return;if(g)return;if("undefined"==typeof document)return;const t=o?.autoAdvanceToNextOn;if(!t)return;const r=()=>{ln(t)&&i()};r();const n=new MutationObserver(()=>r());return n.observe(document.body,{childList:!0,subtree:!0}),()=>n.disconnect()},[e,g,o?.autoAdvanceToNextOn,i]),!e||!o)return null;const S=(()=>{if(!u)return!1;if("undefined"==typeof window)return!1;const e=window.innerHeight;return u.bottom>e/2})(),C=(()=>{if(!u)return null;if("undefined"==typeof window)return null;const e=window.innerWidth,t=window.innerHeight;if(e<768)return null;const r="detail"===o?.id;return{position:"fixed",top:an(r?u.top:u.bottom+10,12,t-12-220),left:an(r?u.left-10-360:u.left,12,e-12-360),width:360}})(),M=u?{position:"fixed",top:Math.max(0,u.top-8),left:Math.max(0,u.left-8),width:Math.max(0,u.width+16),height:Math.max(0,u.height+16),borderRadius:16,boxShadow:"0 0 0 9999px rgba(0,0,0,0.55)",pointerEvents:"none",zIndex:65}:null;return r.jsxs("div",{className:"fixed inset-0 z-[70] pointer-events-none","aria-hidden":!1,children:[M?r.jsx("div",{"aria-hidden":"true",style:M}):r.jsx("div",{className:"absolute inset-0 bg-black/50","aria-hidden":"true"}),r.jsx("div",{ref:c,role:"dialog","aria-modal":"true","aria-labelledby":b,"aria-describedby":j?`${x} ${y}`:x,tabIndex:-1,className:["card","pointer-events-auto","z-[70]",C?"rounded-xl shadow-lg":S?"fixed inset-x-0 top-0 w-full max-h-[85vh] rounded-b-2xl shadow-lg":"fixed inset-x-0 bottom-0 w-full max-h-[85vh] rounded-t-2xl shadow-lg",C?"":"md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[min(90vw,520px)] md:rounded-xl","outline-none"].join(" "),style:C||(S?{paddingTop:"env(safe-area-inset-top)"}:void 0),children:r.jsxs("div",{className:S?"p-4 sm:p-6 pt-2":"p-4 sm:p-6",children:[r.jsxs("header",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{className:"min-w-0",children:[r.jsx("h2",{id:b,className:"text-lg sm:text-xl font-semibold text-foreground",children:o.title}),r.jsx("p",{id:x,className:"mt-1 text-sm text-muted-foreground",children:o.body}),j&&r.jsx("p",{id:y,className:"mt-2 text-xs text-muted-foreground",children:"Öppna en medalj för att fortsätta."})]}),r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:v,"aria-label":"Avsluta guiden",children:"Stäng"})]}),r.jsxs("div",{className:"mt-4 flex items-center justify-between gap-3",children:[r.jsxs("div",{className:"text-xs text-muted-foreground","aria-live":"polite",children:["Steg ",n+1," av ",s.length]}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:w,children:"Hoppa över"})]}),r.jsxs("div",{className:"mt-4 flex items-center justify-end gap-2 safe-bottom",children:[r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:N,disabled:0===n,"aria-disabled":0===n,children:"Tillbaka"}),r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:k,disabled:j,"aria-disabled":j,children:g?"Klart":"Nästa"})]})]})})]})}function cn(){const{id:e}=k(),t=l(),n=i(),s=n.state?.backgroundLocation;return r.jsx(rn,{medalId:e,onClose:()=>{if(s&&s.pathname){const e=`${s.pathname}${s.search||""}${s.hash||""}`;t(e,{replace:!0})}else t(-1)}})}function dn(){const e=i(),n=l(),s=e.state?.backgroundLocation,a=e.pathname.startsWith("/medals/"),o="/whats-new"===e.pathname,c=(a||o)&&s?s:e,d=t.useRef(!1);return t.useEffect(()=>{if(d.current)return;if(d.current=!0,!_t())return;const t=Tt();if(Et()===t)return;const r=setTimeout(()=>{n("/whats-new",{replace:!0,state:{backgroundLocation:e}})},700);return()=>clearTimeout(r)},[e,n]),r.jsxs(r.Fragment,{children:[r.jsx(w,{location:c,children:r.jsxs(j,{path:"/",element:r.jsx(Xe,{}),children:[r.jsx(j,{index:!0,element:r.jsx(Ze,{})}),r.jsx(j,{path:"skill-tree",element:r.jsx(Ft,{})}),r.jsx(j,{path:"skill-tree/fullscreen",element:r.jsx(Ft,{})}),r.jsx(j,{path:"medals",element:r.jsx(Kt,{})}),r.jsx(j,{path:"medals/:id",element:r.jsx(Kt,{})}),r.jsx(j,{path:"settings",element:r.jsx(nn,{children:r.jsx(Cr,{})})}),r.jsx(j,{path:"data",element:r.jsx(nn,{children:r.jsx(Rr,{})})}),r.jsx(j,{path:"about",element:r.jsx(Br,{})}),r.jsx(j,{path:"whats-new",element:r.jsx(sn,{})})]})}),a&&s&&r.jsx(w,{children:r.jsx(j,{path:"/medals/:id",element:r.jsx(cn,{})})}),o&&s&&r.jsx(w,{children:r.jsx(j,{path:"/whats-new",element:r.jsx(sn,{})})}),r.jsx(on,{})]})}function un(){const e="undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/";return t.useEffect(()=>{if("undefined"==typeof window||!("matchMedia"in window))return;const e=window.matchMedia("(prefers-color-scheme: dark)"),t=e=>{document.documentElement.classList.toggle("dark",e)};t(e.matches);const r=e=>t(e.matches);return e.addEventListener?.("change",r),()=>e.removeEventListener?.("change",r)},[]),r.jsx(T,{children:r.jsx(X,{children:r.jsx(Q,{children:r.jsx(pe,{children:r.jsx(le,{children:r.jsx(ce,{children:r.jsx(ke,{children:r.jsx(v,{basename:e,children:r.jsx(dn,{})})})})})})})})})}N.createRoot(document.getElementById("root")).render(r.jsx(t.StrictMode,{children:r.jsx(un,{})})),function(){if("undefined"!=typeof window){if("serviceWorker"in navigator){const e="/spsf-medal-explorer/pr/132/service-worker.js",t="/spsf-medal-explorer/pr/132/";navigator.serviceWorker.register(e,{scope:t}).catch(()=>{})}window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),window.dispatchEvent(new CustomEvent("pwa:install-available"))})}}();
