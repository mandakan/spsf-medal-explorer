const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/medalLoader.vite-B0twhu6l.js","assets/vendor-BbIsC1Kr.js"])))=>i.map(i=>d[i]);
import{_ as e,r as t,j as r,I as a,C as n,a as s,u as i,c as l,L as o,O as d,d as c,S as u,e as m,T as p,f as h,g as f,h as x,R as g,i as b,k as y,B as v,l as j,m as w,n as N,o as k}from"./vendor-BbIsC1Kr.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const S=new Set(["placeholder","under_review","reviewed"]);class C{constructor(e){var t;this.id=e.id,this.type=e.type,this.tier=e.tier,this.name=e.name,this.displayName=e.displayName,this.tierName=e.tierName,this.color=e.color,this.icon=e.icon,this.typeName=e.typeName??null,this.status=(t=e.status,S.has(t)?t:"placeholder"),this.prerequisites=e.prerequisites||[],this.requirements=e.requirements||[],this.unlocksFollowingMedals=e.unlocksFollowingMedals||[],this.description=e.description||"",this.requirementsOriginal=e.requirements_original||"",this.references=Array.isArray(e.references)?e.references:[],this.yearIntroduced=e.yearIntroduced,this.sortOrder=e.sortOrder}getFullName(){const e=this.tier?this.tier.charAt(0).toUpperCase()+this.tier.slice(1).replace("_"," "):"";return`${this.displayName}${e?` (${e})`:""}`}getColorClass(){return{"#FFD700":"text-medal-gold","#C0C0C0":"text-medal-silver","#CD7F32":"text-medal-bronze"}[this.color]||"text-foreground"}isPlaceholder(){return"placeholder"===this.status}isUnderReview(){return"under_review"===this.status}isReviewed(){return"reviewed"===this.status}}class M{constructor(e){this.medals=(e.medals||[]).map(e=>new C(e))}getMedalById(e){return this.medals.find(t=>t.id===e)}getMedalsByType(e){return this.medals.filter(t=>t.type===e)}getMedalsByTier(e){return this.medals.filter(t=>t.tier===e)}getAllMedals(){return[...this.medals]}}function A(e){return e?.id||e?.medalId}function T(e){const t=e?.medals||[],r=[],a=function(e=[]){const t=new Map;for(const r of e){const e=A(r);e&&t.set(e,r)}return t}(t);return t.forEach(e=>{(e.prerequisites||[]).forEach((t,n)=>{if("medal"===t?.type){const s=t.medalId;a.has(s)||r.push(`Medal ${A(e)} prerequisite #${n} references missing medalId: ${s}`)}})}),{ok:0===r.length,errors:r}}function _(e){const t=[],r=new Set;for(const{path:a,data:n}of e){if(!n.type||!Array.isArray(n.medals))throw new Error(`Invalid medal file structure in ${a}: missing 'type' or 'medals' array`);if(r.has(n.type))throw new Error(`Duplicate medal type '${n.type}' found in ${a}`);r.add(n.type);for(const e of n.medals)if(e.type!==n.type)throw new Error(`Medal ${e.id} in ${a} has type '${e.type}' but file is for '${n.type}'`);t.push(...n.medals)}return{version:"1.0",medals:t}}const P={medalDatabase:null,loading:!0,error:null},I=t.createContext(P);function D({children:a}){const[n,s]=t.useState(null),[i,l]=t.useState(!0),[o,d]=t.useState(null);return t.useEffect(()=>{let t=!1;return async function(r){l(!0);try{const a=r??await async function(){const{loadAllMedalFiles:t,mergeAndValidateMedalFiles:r}=await e(async()=>{const{loadAllMedalFiles:e,mergeAndValidateMedalFiles:t}=await import("./medalLoader.vite-B0twhu6l.js");return{loadAllMedalFiles:e,mergeAndValidateMedalFiles:t}},__vite__mapDeps([0,1]));return r(await t())}(),n=T(a);n.ok||console.warn("Medal dataset validation errors:",n.errors);const i=new M(a);t||(s(i),d(null))}catch(a){t||(d(`Failed to load medal database: ${a.message}`),console.error("Medal database error:",a))}finally{t||l(!1)}}(),()=>{t=!0}},[]),r.jsx(I.Provider,{value:{medalDatabase:n,loading:i,error:o},children:a})}const F=t.createContext(null),q={allowManualUnlock:!0,enforceCurrentYearForSustained:!1},E=["male","female"];class ${constructor(e){this.userId=e.userId||`user-${Date.now()}`,this.displayName=e.displayName||"",this.createdDate=e.createdDate||(new Date).toISOString(),this.lastModified=e.lastModified||(new Date).toISOString(),this.dateOfBirth=e.dateOfBirth||"",this.sex=e.sex,this.unlockedMedals=e.unlockedMedals||[],this.prerequisites=e.prerequisites||[],this.features={...q,...e.features||{}},this.isGuest=Boolean(e.isGuest)}touch(){this.lastModified=(new Date).toISOString()}}function G(e){let t;try{t="string"==typeof e?JSON.parse(e):e}catch{throw new Error("Invalid JSON")}if(!t||"profile-backup"!==t.kind||"1.0"!==t.version||!t.profile||"object"!=typeof t.profile)throw new Error("Invalid profile backup");const r=t.profile,a=Array.isArray(r.prerequisites)?r.prerequisites.map((e,t)=>({...e,id:e?.id||`achievement-${Date.now()}-${t}`})):[];return{kind:t.kind,version:t.version,exportedAt:t.exportedAt,profile:{userId:"string"==typeof r.userId?r.userId.trim():"",displayName:"string"==typeof r.displayName?r.displayName:"",createdDate:r.createdDate||(new Date).toISOString(),lastModified:r.lastModified||(new Date).toISOString(),dateOfBirth:"string"==typeof r.dateOfBirth?r.dateOfBirth:"",sex:"string"==typeof r.sex?r.sex.trim().toLowerCase():"",unlockedMedals:Array.isArray(r.unlockedMedals)?r.unlockedMedals:[],prerequisites:a,features:{allowManualUnlock:!(!r.features||!r.features.allowManualUnlock),enforceCurrentYearForSustained:!(!r.features||!r.features.enforceCurrentYearForSustained)},notifications:!!r.notifications}}}class B{async getUserProfile(){throw new Error("Not implemented")}async saveUserProfile(){throw new Error("Not implemented")}async getAllProfiles(){throw new Error("Not implemented")}async deleteProfile(){throw new Error("Not implemented")}async getAchievements(){throw new Error("Not implemented")}async addAchievement(){throw new Error("Not implemented")}async updateAchievement(){throw new Error("Not implemented")}async upsertAchievements(){throw new Error("Not implemented")}async removeAchievement(){throw new Error("Not implemented")}async exportData(){throw new Error("Not implemented")}async importData(){throw new Error("Not implemented")}}const L="profiles",Y="metadata";class R extends B{constructor(){super(),this.db=null,this.dbName=this._generateDBName(),this._lastValidationReasons=[]}_generateDBName(){return`medal-app-${window.location.pathname.split("/")[1]||"main"}`}async init(){return new Promise((e,t)=>{const r=indexedDB.open(this.dbName,1);r.onerror=()=>{t(new Error("IndexedDB open failed"))},r.onsuccess=t=>{this.db=t.target.result,e()},r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(L)){const e=t.createObjectStore(L,{keyPath:"userId"});e.createIndex("lastModified","lastModified",{unique:!1}),e.createIndex("createdDate","createdDate",{unique:!1})}t.objectStoreNames.contains(Y)||t.createObjectStore(Y,{keyPath:"key"})}})}async getUserProfile(e){return await this._transaction(L,"readonly",t=>t.get(e))||null}async saveUserProfile(e){const t=this.validateProfile(e);if(!t.valid)throw new Error(`Ogiltig profil: ${t.errors.join(", ")}`);const r={allowManualUnlock:null!=e.features?.allowManualUnlock?!!e.features.allowManualUnlock:q.allowManualUnlock,enforceCurrentYearForSustained:null!=e.features?.enforceCurrentYearForSustained?!!e.features.enforceCurrentYearForSustained:q.enforceCurrentYearForSustained},a=(new Date).toISOString(),n=await this.getUserProfile(e.userId);let s;return s=n?{...n,...e,sex:e.sex,features:r,userId:n.userId,lastModified:a}:{userId:e.userId||new $(e).userId,displayName:e.displayName||"",createdDate:a,lastModified:a,dateOfBirth:e.dateOfBirth,sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:Boolean(e.notifications),features:r},await this._transaction(L,"readwrite",e=>e.put(s)),s}async getAllProfiles(){return await this._transaction(L,"readonly",e=>e.getAll())||[]}async deleteProfile(e){await this._transaction(L,"readwrite",t=>t.delete(e))}_generateAchievementId(){try{if("undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID)return`achievement-${crypto.randomUUID()}`}catch{}return`achievement-${Date.now()}-${Math.random().toString(36).slice(2,11)}`}_ensureAchievementIds(e){let t=!1;return e.prerequisites=Array.isArray(e.prerequisites)?e.prerequisites:[],e.prerequisites.forEach(e=>{e.id||(e.id=this._generateAchievementId(),t=!0)}),t}async getAchievements(e){const t=await this.getUserProfile(e);if(!t)return[];return this._ensureAchievementIds(t)&&await this.saveUserProfile(t),t&&t.prerequisites||[]}buildNaturalKey(e){const t=[e.type,e.year,e.weaponGroup].map(e=>String(e??"").trim().toLowerCase()).join("|");switch(e.type){case"precision_series":return`${t}|${String(e.points??"").trim()}`;case"standard_medal":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.medalType||"").toLowerCase()}`;case"competition_result":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.ppcClass||"").toLowerCase()}|${String(e.date||"").toLowerCase()}|${String(e.score??"").trim()}`;case"qualification_result":return`${t}|${(e.weapon||"").toLowerCase()}|${String(e.score??"").trim()}`;case"team_event":return`${t}|${(e.teamName||"").toLowerCase()}|${String(e.position??"").trim()}`;case"event":return`${t}|${(e.eventName||"").toLowerCase()}`;case"running_shooting_course":return`${t}|${String(e.date||"").toLowerCase()}|${String(e.points??"").trim()}`;default:return null}}async upsertAchievements(e,t,{updateById:r=!0,matchNaturalKey:a=!1,addNew:n=!0,dryRun:s=!0}={}){if(!t||0===t.length)return{added:0,updated:0,skipped:0,failed:0,errors:[]};const i=await this.getUserProfile(e);if(!i)throw new Error("Profile not found");this._ensureAchievementIds(i);const l=Array.isArray(i.prerequisites)?i.prerequisites:[],o=new Map(l.map(e=>[e.id,e])),d=new Map;if(a)for(const p of l){const e=this.buildNaturalKey(p);e&&d.set(e,p)}const c=[...l],u={added:0,updated:0,skipped:0,failed:0,errors:[]};for(let p=0;p<(t||[]).length;p++){const e=t[p];try{if(!this.validateAchievement(e)){const t=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";false,u.failed++,u.errors.push({record:e,row:p+1,error:t});continue}}catch(m){u.failed++,u.errors.push({record:e,row:p+1,error:m?.message||"Validation failed"});continue}let s=null,i=null;if(r&&e.id&&o.has(e.id))s=o.get(e.id);else if(a){const t=this.buildNaturalKey(e);t&&d.has(t)&&(s=d.get(t),i=t)}if(s){const t=c.findIndex(e=>e.id===s.id);t>=0&&(c[t]={...e,id:s.id},u.updated++,i&&d.delete(i),o.delete(s.id));continue}if(n){const t=e.id&&!o.has(e.id)?e.id:this._generateAchievementId();c.push({...e,id:t}),u.added++}else u.skipped++}return s||(i.prerequisites=c,await this.saveUserProfile(i)),u}async addAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");if(!this.validateAchievement(t)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}const a=t.id||this._generateAchievementId(),n={...t,id:a};return r.prerequisites=Array.isArray(r.prerequisites)?r.prerequisites:[],r.prerequisites.push(n),await this.saveUserProfile(r),n}async updateAchievement(e,t,r){const a=await this.getUserProfile(e);if(!a)throw new Error("Profile not found");const n=(a.prerequisites||[]).findIndex(e=>e.id===t);if(n<0)throw new Error("Achievement not found");const s={...r,id:t};if(!this.validateAchievement(s)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}return a.prerequisites[n]=s,await this.saveUserProfile(a),a.prerequisites[n]}async removeAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");r.prerequisites=(r.prerequisites||[]).filter(e=>e.id!==t),await this.saveUserProfile(r)}validateProfile(e){const t=[];if(!e||"object"!=typeof e)return{valid:!1,errors:["Profilen är ogiltig"]};if(e.userId&&"string"==typeof e.userId||t.push("Användar-ID saknas eller är ogiltigt"),"string"!=typeof e.displayName&&t.push("Profilnamn saknas"),Array.isArray(e.unlockedMedals)||t.push("Upplåsta medaljer måste vara en lista"),Array.isArray(e.prerequisites)||t.push("Förutsättningar måste vara en lista"),this._isValidDob(e.dateOfBirth)||t.push("Ogiltigt födelsedatum (måste vara ÅÅÅÅ-MM-DD)"),e.sex&&"string"==typeof e.sex?E.includes(e.sex)||t.push('Ogiltigt kön (måste vara "male" eller "female")'):t.push("Kön saknas"),null!=e.features&&("object"!=typeof e.features?t.push("Funktioner måste vara ett objekt"):("allowManualUnlock"in e.features&&"boolean"!=typeof e.features.allowManualUnlock&&t.push("allowManualUnlock måste vara sant eller falskt"),"enforceCurrentYearForSustained"in e.features&&"boolean"!=typeof e.features.enforceCurrentYearForSustained&&t.push("enforceCurrentYearForSustained måste vara sant eller falskt"))),this._isValidDob(e.dateOfBirth)){const r=this._computeAge(e.dateOfBirth);r<8?t.push(`Åldern måste vara minst 8 år (beräknad ålder: ${r})`):r>100&&t.push(`Åldern får inte överstiga 100 år (beräknad ålder: ${r})`)}return{valid:0===t.length,errors:t}}validateAchievement(e){const t=[];if(e&&"object"==typeof e){e.type&&"string"==typeof e.type||t.push("Typ saknas eller är ogiltig"),("number"!=typeof e.year||Number.isNaN(e.year))&&t.push("År måste vara ett tal");const r=e.weaponGroup||"";if(["A","B","C","R"].includes(r)||t.push(`Vapengrupp måste vara A, B, C eller R (fick "${r}")`),"precision_series"===e.type&&("number"!=typeof e.points||Number.isNaN(e.points)?t.push("Poäng måste vara ett tal"):(e.points<0||e.points>50)&&t.push("Poäng måste vara mellan 0 och 50")),"application_series"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("Datum måste vara ett giltigt ISO-datum (ÅÅÅÅ-MM-DD)");else{const r=new Date(e.date),a=new Date;a.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>a.getTime()&&t.push("Datum får inte vara i framtiden")}("number"!=typeof e.timeSeconds||!Number.isFinite(e.timeSeconds)||e.timeSeconds<=0)&&t.push("Tid (sekunder) måste vara ett positivt tal"),("number"!=typeof e.hits||!Number.isFinite(e.hits)||e.hits<0)&&t.push("Träffar måste vara ett icke-negativt tal")}if("competition_result"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("Datum måste vara ett giltigt ISO-datum (ÅÅÅÅ-MM-DD)");else{const r=new Date(e.date),a=new Date;a.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>a.getTime()&&t.push("Datum får inte vara i framtiden")}"number"==typeof e.score&&Number.isFinite(e.score)?e.score<0&&t.push("Resultat måste vara >= 0"):t.push("Resultat måste vara ett tal");const r=["national_whole_match","military_fast_match","ppc"],a=String(e.disciplineType||"").toLowerCase();if(r.includes(a)||t.push(`Disciplin måste vara national_whole_match, military_fast_match eller ppc (fick "${a||"(tom)"}")`),"ppc"===a){const r=e.ppcClass;r&&""!==String(r).trim()||t.push('PPC-klass krävs när disciplin är "ppc"')}}if("running_shooting_course"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("Datum måste vara ett giltigt ISO-datum (ÅÅÅÅ-MM-DD)");else{const r=new Date(e.date),a=new Date;a.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>a.getTime()&&t.push("Datum får inte vara i framtiden")}("number"!=typeof e.points||!Number.isFinite(e.points)||e.points<0)&&t.push("Poäng måste vara ett icke-negativt tal")}}else t.push("Aktiviteten måste vara ett objekt");const r=0===t.length;return this._lastValidationReasons=t,r}_isValidDob(e){if(!e||"string"!=typeof e)return!1;if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const t=new Date(e);if(Number.isNaN(t.getTime()))return!1;const[r,a,n]=e.split("-").map(Number);return t.getFullYear()===r&&t.getMonth()+1===a&&t.getDate()===n}_computeAge(e){if(!this._isValidDob(e))return NaN;const t=new Date(e),r=new Date;let a=r.getFullYear()-t.getFullYear();const n=r.getMonth()-t.getMonth();return(n<0||0===n&&r.getDate()<t.getDate())&&a--,a}_generateUserId(){try{if("undefined"!=typeof crypto){if("function"==typeof crypto.randomUUID)return`user-${crypto.randomUUID()}`;if("function"==typeof crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e);return`user-${Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}`}}}catch{}return`user-${Date.now()}`}async _ensureUniqueId(e){const t=e&&"string"==typeof e&&e.trim()?e.trim():this._generateUserId();let r=t,a=1;for(;await this.getUserProfile(r);)r=`${t}-${a++}`;return r}async restoreProfile(e,{strategy:t="new-id"}={}){if(!e||"object"!=typeof e)throw new Error("Invalid profile");const r=(new Date).toISOString(),a={userId:String(e.userId||""),displayName:String(e.displayName||""),createdDate:e.createdDate||r,lastModified:r,dateOfBirth:e.dateOfBirth||"",sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:!!e.notifications,features:{...q,...e.features?{allowManualUnlock:!!e.features.allowManualUnlock,enforceCurrentYearForSustained:!!e.features.enforceCurrentYearForSustained}:{}}};if("new-id"===t)a.userId=await this._ensureUniqueId(this._generateUserId());else{if("overwrite"!==t)throw new Error("Invalid restore strategy");if(!a.userId)throw new Error("userId is required for overwrite")}const n=this.validateProfile(a);if(!n.valid)throw new Error(`Ogiltig profil: ${n.errors.join(", ")}`);return await this.saveUserProfile(a),a}async getMetadata(e){const t=await this._transaction(Y,"readonly",t=>t.get(e));return t?.value}async setMetadata(e,t){return this._transaction(Y,"readwrite",r=>r.put({key:e,value:t}))}async _transaction(e,t,r){if(!this.db)throw new Error("Database not initialized. Call init() first.");return new Promise((a,n)=>{try{const s=this.db.transaction(e,t),i=s.objectStore(e),l=r(i);l.onsuccess=()=>a(l.result),l.onerror=()=>n(l.error),s.onerror=()=>n(s.error),s.onabort=()=>n(new Error("Transaction aborted"))}catch(s){n(s)}})}close(){this.db&&(this.db.close(),this.db=null)}}class O extends B{constructor(){super(),this.storageKey="medal-app-data",this.initializeStorage()}initializeStorage(){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");if(!localStorage.getItem(this.storageKey)){const e={version:"2.0",profiles:[],lastBackup:(new Date).toISOString()};return void localStorage.setItem(this.storageKey,JSON.stringify(e))}try{const e=localStorage.getItem(this.storageKey),t=e?JSON.parse(e):null;if(t&&"2.0"!==t.version){const e=this._migrateToV2(t);this.saveStorageData(e)}}catch{const e={version:"2.0",profiles:[],lastBackup:(new Date).toISOString()};localStorage.setItem(this.storageKey,JSON.stringify(e))}}async getUserProfile(e){return this.getStorageData().profiles.find(t=>t.userId===e)||null}async saveUserProfile(e){const t=this.validateProfile(e);if(!t.valid)throw new Error(`Ogiltig profil: ${t.errors.join(", ")}`);const r={allowManualUnlock:null!=e.features?.allowManualUnlock?!!e.features.allowManualUnlock:q.allowManualUnlock,enforceCurrentYearForSustained:null!=e.features?.enforceCurrentYearForSustained?!!e.features.enforceCurrentYearForSustained:q.enforceCurrentYearForSustained},a=this.getStorageData(),n=(new Date).toISOString();e.lastModified=n;const s=a.profiles.findIndex(t=>t.userId===e.userId);if(s>=0)a.profiles[s]={...a.profiles[s],...e,sex:e.sex,features:r,userId:a.profiles[s].userId};else{const t={userId:e.userId||new $(e).userId,displayName:e.displayName||"",createdDate:n,lastModified:n,dateOfBirth:e.dateOfBirth,sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:Boolean(e.notifications),features:r};a.profiles.push(t),e=t}return this.saveStorageData(a),e}async getAllProfiles(){return this.getStorageData().profiles}async deleteProfile(e){const t=this.getStorageData(),r=t.profiles.length;t.profiles=t.profiles.filter(t=>t.userId!==e),t.profiles.length!==r&&this.saveStorageData(t)}_ensureAchievementIds(e){let t=!1;return e.prerequisites=Array.isArray(e.prerequisites)?e.prerequisites:[],e.prerequisites.forEach((e,r)=>{e.id||(e.id=`achievement-${Date.now()}-${r}-${Math.random().toString(36).slice(2,8)}`,t=!0)}),t}async getAchievements(e){const t=await this.getUserProfile(e);if(!t)return[];return this._ensureAchievementIds(t)&&await this.saveUserProfile(t),t&&t.prerequisites||[]}buildNaturalKey(e){const t=[e.type,e.year,e.weaponGroup].map(e=>String(e??"").trim().toLowerCase()).join("|");switch(e.type){case"precision_series":return`${t}|${String(e.points??"").trim()}`;case"standard_medal":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.medalType||"").toLowerCase()}`;case"competition_result":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.ppcClass||"").toLowerCase()}|${String(e.date||"").toLowerCase()}|${String(e.score??"").trim()}`;case"qualification_result":return`${t}|${(e.weapon||"").toLowerCase()}|${String(e.score??"").trim()}`;case"team_event":return`${t}|${(e.teamName||"").toLowerCase()}|${String(e.position??"").trim()}`;case"event":return`${t}|${(e.eventName||"").toLowerCase()}`;case"running_shooting_course":return`${t}|${String(e.date||"").toLowerCase()}|${String(e.points??"").trim()}`;default:return null}}async upsertAchievements(e,t,{updateById:r=!0,matchNaturalKey:a=!1,addNew:n=!0,dryRun:s=!0}={}){const i=await this.getUserProfile(e);if(!i)throw new Error("Profile not found");this._ensureAchievementIds(i);const l=Array.isArray(i.prerequisites)?i.prerequisites:[],o=new Map(l.map(e=>[e.id,e])),d=new Map;if(a)for(const p of l){const e=this.buildNaturalKey(p);e&&d.set(e,p)}const c=[...l],u={added:0,updated:0,skipped:0,failed:0,errors:[]};for(let p=0;p<(t||[]).length;p++){const e=t[p];try{if(!this.validateAchievement(e)){const t=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";console.groupCollapsed(`[LocalStorageDataManager] Validation failed for row #${p+1}`),console.error("Reason:",t),console.log("Record:",e),console.groupEnd(),u.failed++,u.errors.push({record:e,row:p+1,error:t});continue}}catch(m){console.groupCollapsed(`[LocalStorageDataManager] Exception validating row #${p+1}`),console.error(m),console.log("Record:",e),console.groupEnd(),u.failed++,u.errors.push({record:e,row:p+1,error:m?.message||"Validation failed"});continue}let s=null;if(r&&e.id&&o.has(e.id))s=o.get(e.id),console.debug("[LocalStorageDataManager] Matched by id",{row:p+1,id:e.id});else if(a){const t=this.buildNaturalKey(e);t?d.has(t)?(console.debug("[LocalStorageDataManager] Matched by natural key",{row:p+1,key:t}),s=d.get(t)):console.debug("[LocalStorageDataManager] No match by natural key",{row:p+1,key:t}):console.debug("[LocalStorageDataManager] No natural key for record",{row:p+1})}if(s){const t=c.findIndex(e=>e.id===s.id);t>=0&&(c[t]={...e,id:s.id},u.updated++,console.info("[LocalStorageDataManager] Updated achievement",{row:p+1,id:s.id}));continue}if(n){const t=e.id&&!o.has(e.id)?e.id:`achievement-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;c.push({...e,id:t}),u.added++,console.info("[LocalStorageDataManager] Added achievement",{row:p+1,id:t})}else u.skipped++,console.info("[LocalStorageDataManager] Skipped (addNew=false)",{row:p+1})}return s||(i.prerequisites=c,await this.saveUserProfile(i)),u}async addAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");if(!this.validateAchievement(t)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}const a=t.id||`achievement-${Date.now()}`,n={...t,id:a};return r.prerequisites=Array.isArray(r.prerequisites)?r.prerequisites:[],r.prerequisites.push(n),await this.saveUserProfile(r),n}async updateAchievement(e,t,r){const a=await this.getUserProfile(e);if(!a)throw new Error("Profile not found");const n=(a.prerequisites||[]).findIndex(e=>e.id===t);if(n<0)throw new Error("Achievement not found");const s={...r,id:t};if(!this.validateAchievement(s)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}return a.prerequisites[n]=s,await this.saveUserProfile(a),a.prerequisites[n]}async removeAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");r.prerequisites=(r.prerequisites||[]).filter(e=>e.id!==t),await this.saveUserProfile(r)}validateProfile(e){const t=[];if(!e||"object"!=typeof e)return{valid:!1,errors:["Profilen är ogiltig"]};if(e.userId&&"string"==typeof e.userId||t.push("Användar-ID saknas eller är ogiltigt"),"string"!=typeof e.displayName&&t.push("Profilnamn saknas"),Array.isArray(e.unlockedMedals)||t.push("Upplåsta medaljer måste vara en lista"),Array.isArray(e.prerequisites)||t.push("Förutsättningar måste vara en lista"),this._isValidDob(e.dateOfBirth)||t.push("Ogiltigt födelsedatum (måste vara ÅÅÅÅ-MM-DD)"),e.sex&&"string"==typeof e.sex?E.includes(e.sex)||t.push('Ogiltigt kön (måste vara "male" eller "female")'):t.push("Kön saknas"),null!=e.features&&("object"!=typeof e.features?t.push("Funktioner måste vara ett objekt"):("allowManualUnlock"in e.features&&"boolean"!=typeof e.features.allowManualUnlock&&t.push("allowManualUnlock måste vara sant eller falskt"),"enforceCurrentYearForSustained"in e.features&&"boolean"!=typeof e.features.enforceCurrentYearForSustained&&t.push("enforceCurrentYearForSustained måste vara sant eller falskt"))),this._isValidDob(e.dateOfBirth)){const r=this._computeAge(e.dateOfBirth);r<8?t.push(`Åldern måste vara minst 8 år (beräknad ålder: ${r})`):r>100&&t.push(`Åldern får inte överstiga 100 år (beräknad ålder: ${r})`)}return{valid:0===t.length,errors:t}}validateAchievement(e){const t=[];if(e&&"object"==typeof e){e.type&&"string"==typeof e.type||t.push("Typ saknas eller är ogiltig"),("number"!=typeof e.year||Number.isNaN(e.year))&&t.push("År måste vara ett tal");const r=e.weaponGroup||"";if(["A","B","C","R"].includes(r)||t.push(`Vapengrupp måste vara A, B, C eller R (fick "${r}")`),"precision_series"===e.type&&("number"!=typeof e.points||Number.isNaN(e.points)?t.push("Poäng måste vara ett tal"):(e.points<0||e.points>50)&&t.push("Poäng måste vara mellan 0 och 50")),"application_series"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("Datum måste vara ett giltigt ISO-datum (ÅÅÅÅ-MM-DD)");else{const r=new Date(e.date),a=new Date;a.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>a.getTime()&&t.push("Datum får inte vara i framtiden")}("number"!=typeof e.timeSeconds||!Number.isFinite(e.timeSeconds)||e.timeSeconds<=0)&&t.push("Tid (sekunder) måste vara ett positivt tal"),("number"!=typeof e.hits||!Number.isFinite(e.hits)||e.hits<0)&&t.push("Träffar måste vara ett icke-negativt tal")}if("competition_result"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("Datum måste vara ett giltigt ISO-datum (ÅÅÅÅ-MM-DD)");else{const r=new Date(e.date),a=new Date;a.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>a.getTime()&&t.push("Datum får inte vara i framtiden")}"number"==typeof e.score&&Number.isFinite(e.score)?e.score<0&&t.push("Resultat måste vara >= 0"):t.push("Resultat måste vara ett tal");const r=["national_whole_match","military_fast_match","ppc"],a=String(e.disciplineType||"").toLowerCase();if(r.includes(a)||t.push(`Disciplin måste vara national_whole_match, military_fast_match eller ppc (fick "${a||"(tom)"}")`),"ppc"===a){const r=e.ppcClass;r&&""!==String(r).trim()||t.push('PPC-klass krävs när disciplin är "ppc"')}}if("running_shooting_course"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("Datum måste vara ett giltigt ISO-datum (ÅÅÅÅ-MM-DD)");else{const r=new Date(e.date),a=new Date;a.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>a.getTime()&&t.push("Datum får inte vara i framtiden")}("number"!=typeof e.points||!Number.isFinite(e.points)||e.points<0)&&t.push("Poäng måste vara ett icke-negativt tal")}}else t.push("Aktiviteten måste vara ett objekt");const r=0===t.length;if(this._lastValidationReasons=t,!r)try{console.groupCollapsed("[LocalStorageDataManager] validateAchievement failed"),console.error("Reasons:",t),console.log("Achievement:",e),console.groupEnd()}catch{}return r}getStorageData(){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");try{const e=localStorage.getItem(this.storageKey);if(!e)return this.initializeStorage(),this.getStorageData();const t=JSON.parse(e);if(!t||"object"!=typeof t||!Array.isArray(t.profiles))throw new Error("Malformed storage root");return t}catch(e){throw console.error("Failed to read storage:",e),new Error("Storage data corrupted")}}saveStorageData(e){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(t){if(t&&("QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name||22===t.code))throw new Error("Storage quota exceeded");throw t}}_isValidDob(e){if(!e||"string"!=typeof e)return!1;if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const t=new Date(e);return!Number.isNaN(t.getTime())}_computeAge(e){if(!this._isValidDob(e))return NaN;const t=new Date(e),r=new Date;let a=r.getFullYear()-t.getFullYear();const n=r.getMonth()-t.getMonth();return(n<0||0===n&&r.getDate()<t.getDate())&&a--,a}_defaultDob(){return"2000-01-01"}_migrateToV2(e){const t={...e};return t.version="2.0",t.profiles=Array.isArray(e.profiles)?e.profiles.map(e=>{const t={...e};return delete t.weaponGroupPreference,this._isValidDob(t.dateOfBirth)||(t.dateOfBirth=this._defaultDob()),t.features?("boolean"!=typeof t.features.allowManualUnlock&&(t.features.allowManualUnlock=q.allowManualUnlock),"boolean"!=typeof t.features.enforceCurrentYearForSustained&&(t.features.enforceCurrentYearForSustained=q.enforceCurrentYearForSustained)):t.features={...q},t.lastModified=(new Date).toISOString(),t}):[],t}_hasStorage(){try{return"undefined"!=typeof localStorage}catch{return!1}}_generateUserId(){try{if("undefined"!=typeof crypto){if("function"==typeof crypto.randomUUID)return`user-${crypto.randomUUID()}`;if("function"==typeof crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e);return`user-${Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}`}}}catch{}return`user-${Date.now()}`}_ensureUniqueId(e){const t=this.getStorageData(),r=e&&"string"==typeof e&&e.trim()?e.trim():this._generateUserId();let a=r,n=1;for(;t.profiles.some(e=>e.userId===a);)a=`${r}-${n++}`;return a}async restoreProfile(e,{strategy:t="new-id"}={}){if(!e||"object"!=typeof e)throw new Error("Invalid profile");const r=(new Date).toISOString(),a={userId:String(e.userId||""),displayName:String(e.displayName||""),createdDate:e.createdDate||r,lastModified:r,dateOfBirth:e.dateOfBirth||"",sex:e.sex,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:!!e.notifications,features:{...q,...e.features?{allowManualUnlock:!!e.features.allowManualUnlock,enforceCurrentYearForSustained:!!e.features.enforceCurrentYearForSustained}:{}}};if("new-id"===t)a.userId=this._ensureUniqueId(this._generateUserId());else{if("overwrite"!==t)throw new Error("Invalid restore strategy");if(!a.userId)throw new Error("userId is required for overwrite")}const n=this.validateProfile(a);if(!n.valid)throw new Error(`Ogiltig profil: ${n.errors.join(", ")}`);const s=this.getStorageData(),i=s.profiles.findIndex(e=>e.userId===a.userId);return i>=0?s.profiles[i]=a:s.profiles.push(a),this.saveStorageData(s),a}}async function V(){const e=null!==localStorage.getItem("medal-app-data");return await async function(){let e;try{e=new R,await e.init();const t=await e.getAllProfiles();return t&&t.length>0}catch{return!1}finally{try{e?.close?.()}catch{}}}()?"indexeddb":e?"localstorage":"none"}function U(){const[e,r]=t.useState(null),[a,n]=t.useState(!1),[s,i]=t.useState(null);return t.useEffect(()=>{let e=!1;return async function(){try{const a=function(){try{return!("undefined"==typeof indexedDB||!indexedDB)&&"function"==typeof indexedDB.open}catch{return!1}}(),s=await V();if(e)return;if("none"===s||"indexeddb"===s){if(a)try{const t=new R;await t.init(),e||r(t)}catch(t){console.error("IndexedDB initialization failed, falling back to localStorage:",t);const a=new O;e||r(a)}else{const t=new O;e||r(t)}return}if("localstorage"===s&&a){e||n(!0);const a=await async function(e){let t;try{e?.({stage:"loading",percent:0});const a=new O,n=await a.getAllProfiles();e?.({stage:"saving",percent:33}),t=new R,await t.init();for(let r=0;r<n.length;r++)await t.saveUserProfile(n[r]),e?.({stage:"saving",percent:33+(r+1)/n.length*34});if(await t.setMetadata("migration_complete",!0),await t.setMetadata("migration_date",(new Date).toISOString()),await t.setMetadata("migrated_from","localstorage"),e?.({stage:"verifying",percent:75}),(await t.getAllProfiles()).length!==n.length)throw new Error("Migration verification failed: profile count mismatch");try{localStorage.removeItem("medal-app-data"),await t.setMetadata("localstorage_cleaned",!0)}catch(r){console.warn("[migrationManager] Failed to clean up localStorage:",r)}return e?.({stage:"complete",percent:100}),{success:!0,profilesMigrated:n.length}}catch(a){return{success:!1,error:a.message}}finally{try{t?.close?.()}catch{}}}(t=>{e||i(t)});if(e)return;if(n(!1),a.success)try{const t=new R;await t.init(),e||r(t)}catch(t){console.error("IndexedDB initialization failed after migration, falling back to localStorage:",t);const a=new O;e||r(a)}else{console.error("Migration failed:",a.error);const t=new O;e||r(t)}}else{const t=new O;e||r(t)}}catch(a){if(console.error("Storage initialization failed, falling back to localStorage:",a),!e)try{const e=new O;r(e)}catch(s){console.error("Fatal: even localStorage fallback failed:",s),r(new O)}}}(),()=>{e=!0}},[]),{manager:e,migrating:a,migrationProgress:s}}const z="profile:dataChanged";function K(){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent(z))}const H="app:onboardingChoice",W="app:lastProfileId";function X(e){if("undefined"!=typeof window)try{e?window.localStorage.setItem(W,e):window.localStorage.removeItem(W)}catch{}}function J({sex:e}){return new $({userId:"guest",displayName:"Gästläge",dateOfBirth:"1975-01-02",sex:e,unlockedMedals:[],prerequisites:[],isGuest:!0,features:{allowManualUnlock:!0,enforceCurrentYearForSustained:!1}})}function Z({children:e}){const{manager:a,migrating:n}=U(),[s,i]=t.useState(void 0),[l,o]=t.useState([]),[d,c]=t.useState(!1),[u,m]=t.useState(null),[p,h]=t.useState(!1),f=t.useCallback(async()=>{try{c(!0);const e=await a.getAllProfiles();o(e),m(null)}catch(e){m(e.message),console.error("Failed to load profiles:",e)}finally{c(!1)}},[a]),x=t.useCallback((e="male")=>{try{window.localStorage.setItem(H,"guest")}catch(t){}i(J({sex:e}))},[]);t.useEffect(()=>{if(!a||n)return;let e=!1;return(async()=>{try{c(!0);const r=await a.getAllProfiles();if(e)return;o(r);let n=null;const s=function(){if("undefined"==typeof window)return null;try{return new URL(window.location.href).searchParams.get("profile")||null}catch{return null}}();if(s&&r.some(e=>e.userId===s))n=r.find(e=>e.userId===s)||null,X(s);else{const e=function(){if("undefined"==typeof window)return null;try{return window.localStorage.getItem(W)}catch{return null}}();if(e&&r.some(t=>t.userId===e))n=r.find(t=>t.userId===e)||null;else if(r.length>0)n=[...r].sort((e,t)=>new Date(t.lastModified)-new Date(e.lastModified))[0];else try{"guest"===window.localStorage.getItem(H)&&(n=J({sex:"male"}))}catch(t){}}i(n??null),m(null)}catch(r){e||(m(r.message),console.error("Failed to bootstrap profiles:",r))}finally{e||(c(!1),h(!0))}})(),()=>{e=!0}},[a,n]);const g=t.useCallback(async(e,t,r)=>{try{c(!0);const n=new $({displayName:e,dateOfBirth:t,sex:r}),s=await a.saveUserProfile(n);return i(s),X(s.userId),await f(),s}catch(n){throw m(n.message),n}finally{c(!1)}},[a,f]),b=t.useCallback(async e=>{try{c(!0);const t=await a.getUserProfile(e);if(!t)throw new Error("Profile not found");i(t),X(t.userId),m(null)}catch(t){m(t.message)}finally{c(!1)}},[a]);t.useEffect(()=>{if(p&&s&&!s.isGuest)try{window.localStorage.removeItem(H)}catch(e){}},[s,p]);const y=t.useCallback(async e=>{try{c(!0);const t=await a.saveUserProfile(e);return i(t),X(t.userId),await f(),t}catch(t){throw m(t.message),t}finally{c(!1)}},[a,f]),v=t.useCallback(async e=>{try{c(!0),await a.deleteProfile(e),s?.userId===e&&(i(null),X(null)),await f()}catch(t){throw m(t.message),t}finally{c(!1)}},[a,s,f]),j=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(s.isGuest)return i(t=>({...t,prerequisites:[...t?.prerequisites||[],e],lastModified:(new Date).toISOString()})),K(),e;try{c(!0);const t=await a.addAchievement(s.userId,e),r=await a.getUserProfile(s.userId);return i(r),K(),t}catch(t){throw m(t.message),t}finally{c(!1)}},[s,a]),w=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(!e?.id)throw new Error("Achievement id is required");if(s.isGuest)return i(t=>{const r=Array.isArray(t?.prerequisites)?[...t.prerequisites]:[],a=r.findIndex(t=>t.id===e.id);return-1!==a&&(r[a]={...r[a],...e}),{...t,prerequisites:r,lastModified:(new Date).toISOString()}}),K(),e;try{c(!0);const t=await a.getUserProfile(s.userId),r=Array.isArray(t.prerequisites)?[...t.prerequisites]:[],n=r.findIndex(t=>t.id===e.id);if(-1===n)throw new Error("Achievement not found");r[n]={...r[n],...e};const l={...t,prerequisites:r,lastModified:(new Date).toISOString()},o=await a.saveUserProfile(l);return i(o),K(),o.prerequisites[n]}catch(t){throw m(t.message),t}finally{c(!1)}},[s,a]),N=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("Achievement id is required");if(s.isGuest)return i(t=>({...t,prerequisites:(t?.prerequisites||[]).filter(t=>t.id!==e),lastModified:(new Date).toISOString()})),K(),!0;try{c(!0);const t=await a.getUserProfile(s.userId),r=Array.isArray(t.prerequisites)?t.prerequisites.filter(t=>t.id!==e):[],n={...t,prerequisites:r,lastModified:(new Date).toISOString()},l=await a.saveUserProfile(n);return i(l),K(),!0}catch(t){throw m(t.message),t}finally{c(!1)}},[s,a]),k=t.useCallback(async(e,t,r=[])=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("medalId is required");if(s.isGuest){let a=!1;return i(n=>{const s=Array.isArray(n?.unlockedMedals)?[...n.unlockedMedals]:[];if(s.some(t=>t.medalId===e))return n;a=!0;const i={medalId:e,unlockedDate:t||(new Date).toISOString().slice(0,10),achievementIds:Array.isArray(r)?r:[]};return{...n,unlockedMedals:[...s,i],lastModified:(new Date).toISOString()}}),a&&K(),!0}try{c(!0);const n=await a.getUserProfile(s.userId),l=Array.isArray(n.unlockedMedals)?[...n.unlockedMedals]:[];if(l.some(t=>t.medalId===e))return!1;const o={medalId:e,unlockedDate:t||(new Date).toISOString().slice(0,10),achievementIds:Array.isArray(r)?r:[]},d={...n,unlockedMedals:[...l,o],lastModified:(new Date).toISOString()},u=await a.saveUserProfile(d);return i(u),K(),!0}catch(n){throw m(n.message),n}finally{c(!1)}},[s,a]),S=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("medalId is required");if(s.isGuest)return i(t=>({...t,unlockedMedals:(t?.unlockedMedals||[]).filter(t=>t.medalId!==e),lastModified:(new Date).toISOString()})),!0;try{c(!0);const t=await a.getUserProfile(s.userId),r=Array.isArray(t.unlockedMedals)?t.unlockedMedals:[],n=r.filter(t=>t.medalId!==e);if(n.length===r.length)return!1;const l={...t,unlockedMedals:n,lastModified:(new Date).toISOString()},o=await a.saveUserProfile(l);return i(o),!0}catch(t){throw m(t.message),t}finally{c(!1)}},[s,a]),C=t.useCallback(async(e,t)=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("Feature name is required");if(s.isGuest)return i(r=>({...r,features:{...r?.features||{},[e]:!!t},lastModified:(new Date).toISOString()})),m(null),s;try{c(!0);const r=await a.getUserProfile(s.userId),n={...r.features||{},[e]:!!t},l={...r,features:n,lastModified:(new Date).toISOString()},o=await a.saveUserProfile(l);return i(o),m(null),o}catch(r){throw m(r.message),r}finally{c(!1)}},[s,a]),M=t.useCallback(async(e,t={strategy:"new-id"})=>{try{c(!0);const r=G(e),n=await a.restoreProfile(r.profile,t);return i(n),X(n.userId),await f(),m(null),n}catch(r){throw m(r.message),r}finally{c(!1)}},[a,f]),A=t.useCallback(async(e,t)=>{if(!s)throw new Error("No profile selected");if(s.isGuest)return t?.dryRun||i(t=>({...t,prerequisites:(Array.isArray(t?.prerequisites),[...e]),lastModified:(new Date).toISOString()})),m(null),{added:e?.length||0,updated:0,duplicates:0};try{c(!0);const r=await a.upsertAchievements(s.userId,e,t);if(!t?.dryRun){const e=await a.getUserProfile(s.userId);i(e),X(e.userId),await f()}return m(null),r}catch(r){throw m(r.message),r}finally{c(!1)}},[s,a,f]),T=t.useCallback(async(e,t="",r)=>{if(!s?.isGuest)return null;const n=new $({...s,userId:void 0,displayName:e||"Profil",dateOfBirth:t,sex:r,isGuest:!1}),l=await a.saveUserProfile(n);return i(l),X(l.userId),await f(),l},[s,a,f]),_=t.useCallback(async()=>{if(!s)return!1;const e={...s,unlockedMedals:[],prerequisites:[],lastModified:(new Date).toISOString()};if(s.isGuest)return i(e),!0;const t=await a.saveUserProfile(e);return i(t),await f(),!0},[s,a,f]),P={currentProfile:s,profiles:l,loading:d,hydrated:p,error:u,createProfile:g,selectProfile:b,updateProfile:y,deleteProfile:v,addAchievement:j,updateAchievement:w,removeAchievement:N,unlockMedal:k,lockMedal:S,setProfileFeature:C,restoreProfileFromBackup:M,upsertAchievements:A,startExplorerMode:x,convertGuestToSaved:T,resetCurrentProfileData:_};return r.jsx(F.Provider,{value:P,children:e})}const Q=t.createContext(null);function ee({lastBackupDate:e,lastDataChange:t,reminderFrequency:r,reminderDismissedUntil:a}){if(0===r)return!1;if(a){if(new Date(a)>new Date)return!1}if(!t)return!1;if(!e)return!0;const n=new Date(e),s=new Date(t),i=function(e,t){const r=t-e;return Math.floor(r/864e5)}(n,new Date);return s>n&&i>=r}function te({children:e}){const{manager:a}=U(),[n,s]=t.useState(null),[i,l]=t.useState(null),[o,d]=t.useState(30),[c,u]=t.useState(null),[m,p]=t.useState(!0);t.useEffect(()=>{!async function(){if(a)try{const e=await a.getMetadata("lastBackupDate"),t=await a.getMetadata("lastDataChange"),r=await a.getMetadata("backupReminderFrequency"),n=await a.getMetadata("reminderDismissedUntil");s(e||null),l(t||null),d(r??30),u(n||null)}catch(e){console.error("Failed to load backup metadata:",e)}finally{p(!1)}}()},[a]);const h=t.useCallback(async()=>{const e=(new Date).toISOString();if(s(e),a)try{await a.setMetadata("lastBackupDate",e)}catch(t){console.error("Failed to save lastBackupDate:",t)}},[a]),f=t.useCallback(async()=>{const e=(new Date).toISOString();if(l(e),a)try{await a.setMetadata("lastDataChange",e)}catch(t){console.error("Failed to save lastDataChange:",t)}},[a]),x=t.useCallback(async e=>{if(d(e),a)try{await a.setMetadata("backupReminderFrequency",e)}catch(t){console.error("Failed to save backupReminderFrequency:",t)}},[a]),g=t.useCallback(async()=>{const e=function(e=new Date){const t=new Date(e);return t.setDate(t.getDate()+7),t.toISOString()}();if(u(e),a)try{await a.setMetadata("reminderDismissedUntil",e)}catch(t){console.error("Failed to save reminderDismissedUntil:",t)}},[a]);t.useEffect(()=>{const e=()=>{f()};return window.addEventListener(z,e),()=>window.removeEventListener(z,e)},[f]);const b=t.useMemo(()=>ee({lastBackupDate:n,lastDataChange:i,reminderFrequency:o,reminderDismissedUntil:c}),[n,i,o,c]),y={lastBackupDate:n,lastDataChange:i,reminderFrequency:o,reminderDismissedUntil:c,isLoading:m,shouldShowReminder:b,markBackupCreated:h,markDataChanged:f,updateReminderFrequency:x,dismissReminder:g};return r.jsx(Q.Provider,{value:y,children:e})}const re=t.createContext(null),ae=new Map;class ne{constructor(e,t){this.medals=e,this.profile=t||{unlockedMedals:[],prerequisites:[]}}static registerCustomCriterion(e,t){if("string"!=typeof e||!e)throw new Error("custom_criterion name must be a non-empty string");if("function"!=typeof t)throw new Error("custom_criterion handler must be a function");ae.set(e,t)}evaluateMedal(e,t={}){const r=this.medals.getMedalById(e);if(!r)throw new Error(`Medal not found: ${e}`);if("function"==typeof r.isPlaceholder&&r.isPlaceholder()||"placeholder"===r.status)return{medalId:e,status:"locked",reason:"placeholder",details:{message:"Placeholder medal"}};if(this.hasUnlockedMedal(e))return{medalId:e,status:"unlocked",unlockedDate:this.getUnlockedDate(e),details:{}};if(Array.isArray(r.prerequisites)){const a=r.prerequisites.filter(e=>"medal"===e?.type).filter(e=>{if(!this.hasUnlockedMedal(e.medalId))return!0;if("number"==typeof t.endYear){const r=this.getUnlockedYear(e.medalId);return!("number"==typeof r&&r<=t.endYear)}return!1});if(a.length)return{medalId:e,status:"locked",reason:"prerequisites_not_met",details:{prerequisites:{missingMedals:a.map(e=>e.medalId)}}}}const a=this.checkRequirements(r,t);if(!a.allMet)return{medalId:e,status:"available",reason:"requirements_not_met",details:a};const n=this.checkPrerequisites(r,a.unlockYear??t.endYear);return n.allMet?{medalId:e,status:"eligible",eligibleYear:a.unlockYear??null,details:{...a,prerequisites:n}}:{medalId:e,status:"locked",reason:"prerequisites_not_met",details:n}}hasUnlockedMedal(e){return this.profile.unlockedMedals?.some(t=>t.medalId===e)||!1}getUnlockedDate(e){const t=this.profile.unlockedMedals?.find(t=>t.medalId===e);return t?t.unlockedDate:null}checkPrerequisites(e,t){if(!e.prerequisites||0===e.prerequisites.length)return{allMet:!0,items:[],missingItems:[]};const r=[],a=[];return e.prerequisites.forEach(e=>{if("medal"===e.type){const n=this.getUnlockedYear(e.medalId),s=this.hasUnlockedMedal(e.medalId)&&("number"!=typeof t||"number"==typeof n&&n<=t),i={type:"medal",medalId:e.medalId,isMet:s,achieved:s?this.getUnlockedDate(e.medalId):null,description:e.description,yearOffset:e.yearOffset};if(r.push(i),s){if("number"==typeof e.yearOffset){const r=this.getUnlockedYear(e.medalId),n="number"==typeof t?t:this.getMostRecentAchievementYear()??(new Date).getFullYear(),s=null!==r&&n-r>=e.yearOffset,l={...i,isMet:s,offsetChecked:!0,plannedYear:n};s||a.push(l)}}else a.push(i)}else if("age_requirement"===e.type){const n=this.profile?.dateOfBirth;let s=null,i=!1;if(n){const r=new Date(n);if(!Number.isNaN(r.getTime())){const a="number"==typeof t?new Date(t,11,31):new Date;let n=a.getFullYear()-r.getFullYear();const l=a.getMonth()-r.getMonth();(l<0||0===l&&a.getDate()<r.getDate())&&(n-=1),s=n;const o="number"!=typeof e.minAge||s>=e.minAge,d="number"!=typeof e.maxAge||s<=e.maxAge;i=o&&d}}const l={type:"age_requirement",isMet:i,minAge:e.minAge,...null!=e.maxAge?{maxAge:e.maxAge}:{},...null!=s?{age:s}:{},description:e.description};r.push(l),i||a.push(l)}}),{allMet:0===a.length,items:r,missingItems:a}}getUnlockedYear(e){const t=this.profile.unlockedMedals?.find(t=>t.medalId===e);return t?t.year?t.year:t.unlockedDate?new Date(t.unlockedDate).getFullYear():null:null}getMostRecentAchievementYear(){const e=this.profile.prerequisites||[];return e.length?e.reduce((e,t)=>Math.max(e,t.year||e),0):null}getSameTypePrereqMedalIds(e){const t=e?.type;return t?(e?.prerequisites||[]).filter(e=>"medal"===e?.type).map(e=>e.medalId).filter(e=>{const r=this.medals.getMedalById(e);return r&&r.type===t}):[]}getEarliestCountingYearForMedal(e){const t=this.getSameTypePrereqMedalIds(e).map(e=>this.getUnlockedYear(e)).filter(e=>"number"==typeof e);return t.length?Math.max(...t)+1:null}getMinimalUnlockYearForSustained(e){if(!e)return null;const t=(e.requirements||[]).find(e=>"sustained_achievement"===e?.type);if(!t)return null;const r=Number.isFinite(t?.yearsOfAchievement)?t.yearsOfAchievement:1,a=this.getSameTypePrereqMedalIds(e).map(e=>this.getUnlockedYear(e)).filter(e=>"number"==typeof e);if(!a.length)return null;return Math.max(...a)+r}getAllAchievementYears(){const e=this.profile.prerequisites||[],t=new Set;for(const r of e){const e=Number(r.year);Number.isNaN(e)||t.add(e)}return Array.from(t).sort((e,t)=>e-t)}requirementsMetInYear(e,t,r={}){const a="string"==typeof e?this.medals.getMedalById(e):e;if(!a)return!1;return this.checkRequirements(a,{...r,endYear:t}).allMet}checkRequirements(e,t={}){const r=e.requirements;if(!r||Array.isArray(r)&&0===r.length)return{allMet:!0,items:[],unlockYear:null,tree:{node:"and",isMet:!0,children:[]}};const a=this.normalizeRequirementSpec(r),n=r=>this.evaluateReqNode(a,e,{...t,endYear:r});if("number"==typeof t.endYear){const e=n(t.endYear),r=!!e.isMet;return{allMet:r,items:this.flattenLeaves(e),unlockYear:r?t.endYear:null,tree:e}}const s=this.getCandidateYearsForTree();for(const l of s){const e=n(l);if(e.isMet)return{allMet:!0,items:this.flattenLeaves(e),unlockYear:l,tree:e}}const i=this.evaluateReqNode(a,e,t);return{allMet:!1,items:this.flattenLeaves(i),unlockYear:null,tree:i}}checkPrecisionSeriesRequirement(e,t,r={}){const a=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type);if(null==r.endYear)return{type:"precision_series",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};let n=a;const s=e.timeWindowYears;if(1===s)n=a.filter(e=>e.year===r.endYear);else if("number"==typeof s&&s>1){const e=r.endYear-s+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);n=a.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else n=a.filter(e=>e.year===r.endYear);const i=this.getAgeAtYear(r.endYear),{thresholds:l,matchedCategory:o}=this.resolveAgeBasedPrecisionThresholdsWithCategory(e,i),d=this.filterByPrecisionSeriesThreshold(n,{pointThresholds:l}),c=e.minAchievements??1,u={current:d.length,required:c},m=u.current>=c,p=Array.isArray(e.ageCategories)&&e.ageCategories.length>0;return{type:"precision_series",index:t,isMet:m,progress:u,description:e.description,pointThresholds:{A:l?.A?.min,B:l?.B?.min,C:l?.C?.min,R:l?.R?.min},windowYear:m?r.endYear:null,matchingAchievementIds:d.slice(0,c).map(e=>e.id).filter(Boolean),...null!=i?{age:i}:{},...p?{ageCategories:e.ageCategories,matchedAgeCategory:o?.name||null}:{}}}resolveAgeBasedPrecisionThresholds(e,t){return this.resolveAgeBasedPrecisionThresholdsWithCategory(e,t).thresholds}resolveAgeBasedPrecisionThresholdsWithCategory(e,t){if(!Array.isArray(e.ageCategories)||0===e.ageCategories.length||null==t)return{thresholds:e.pointThresholds||{},matchedCategory:null};const r=e.ageCategories.find(e=>{const r="number"==typeof e.ageMin?e.ageMin:0,a="number"==typeof e.ageMax?e.ageMax:999;return t>=r&&t<=a});return{thresholds:r?.pointThresholds||e.pointThresholds||{},matchedCategory:r||null}}checkApplicationSeriesRequirement(e,t,r={}){const a=(this.profile.prerequisites||[]).filter(e=>"application_series"===e.type);if(null==r.endYear)return{type:"application_series",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};const n=this.getAgeAtYear(r.endYear),{thresholds:s,matchedCategory:i}=this.resolveAgeBasedApplicationThresholdsWithCategory(e,n);let l=a;const o=e.timeWindowYears;if(1===o)l=a.filter(e=>e.year===r.endYear);else if("number"==typeof o&&o>1){const e=r.endYear-o+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);l=a.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else l=a.filter(e=>e.year===r.endYear);const d=l.filter(e=>{const t=e.weaponGroup||"A",r=s?.[t];if(!r)return!1;const a="number"==typeof e.timeSeconds&&e.timeSeconds>0,n="number"==typeof e.hits&&e.hits>=0,i="number"!=typeof r.maxTimeSeconds||e.timeSeconds<=r.maxTimeSeconds,l="number"!=typeof r.minHits||e.hits>=r.minHits;return a&&n&&i&&l}),c=e.minAchievements??1,u={current:d.length,required:c},m=u.current>=c,p=Array.isArray(e.ageCategories)&&e.ageCategories.length>0;return{type:"application_series",index:t,isMet:m,progress:u,description:e.description,windowYear:m?r.endYear:null,matchingAchievementIds:d.slice(0,c).map(e=>e.id).filter(Boolean),...null!=n?{age:n}:{},...p?{ageCategories:e.ageCategories,matchedAgeCategory:i?.name||null}:{}}}resolveAgeBasedApplicationThresholds(e,t){return this.resolveAgeBasedApplicationThresholdsWithCategory(e,t).thresholds}resolveAgeBasedApplicationThresholdsWithCategory(e,t){if(!Array.isArray(e.ageCategories)||0===e.ageCategories.length||null==t)return{thresholds:e.thresholds||{},matchedCategory:null};const r=e.ageCategories.find(e=>{const r="number"==typeof e.ageMin?e.ageMin:0,a="number"==typeof e.ageMax?e.ageMax:999;return t>=r&&t<=a});return{thresholds:r?.thresholds||e.thresholds||{},matchedCategory:r||null}}checkRunningShootingCourseRequirement(e,t,r={}){const a=(this.profile.prerequisites||[]).filter(e=>"running_shooting_course"===e.type),n=r&&"number"==typeof r.endYear?r.endYear:null;if(null==n)return{type:"running_shooting_course",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};const s=this.profile?.sex;if("male"!==s&&"female"!==s)throw new Error("Profile sex is required for running_shooting_course requirements");const i=this.getAgeAtYear(n);if(null==i)throw new Error("Profile dateOfBirth is required for running_shooting_course requirements");const l=(()=>{const t=Array.isArray(e.ageCategories)?e.ageCategories:[];return t.length&&t.find(e=>{const t="number"==typeof e.ageMin?e.ageMin:0,r="number"==typeof e.ageMax?e.ageMax:999;return i>=t&&i<=r})||null})(),o=(l?.maxPoints&&"object"==typeof l.maxPoints?l.maxPoints[s]:void 0)??(e?.maxPoints&&"object"==typeof e.maxPoints?e.maxPoints[s]:void 0);if(!Number.isFinite(o))throw new Error("running_shooting_course requirement is missing maxPoints for profile sex");let d=a;const c=e.timeWindowYears;if(1===c)d=a.filter(e=>e.year===n);else if("number"==typeof c&&c>1){const e=n-c+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);d=a.filter(e=>(e.year??0)>=t&&(e.year??0)<=n)}else d=a.filter(e=>e.year===n);const u=d.filter(e=>"number"==typeof e.points&&Number.isFinite(e.points)&&e.points<=o),m=e.minAchievements??1,p={current:u.length,required:m},h=p.current>=m;return{type:"running_shooting_course",index:t,isMet:h,progress:p,description:e.description,windowYear:h?n:null,maxPoints:o,sex:s,age:i,...l?.name?{ageCategory:l.name}:{},matchingAchievementIds:u.slice(0,m).map(e=>e.id).filter(Boolean)}}filterByPrecisionSeriesThreshold(e,t){const r={A:t.pointThresholds?.A?.min??0,B:t.pointThresholds?.B?.min??0,C:t.pointThresholds?.C?.min??0,R:t.pointThresholds?.R?.min??0};return(e||[]).filter(e=>{const t=e.weaponGroup||"A",a=r[t];return"number"==typeof e.points&&e.points>=a})}groupBy(e,t){return(e||[]).reduce((e,r)=>{const a=t(r);return e[a]=e[a]||[],e[a].push(r),e},{})}normalizeRequirementSpec(e){if(Array.isArray(e))return{op:"and",children:e.map(e=>this.normalizeRequirementSpec(e))};if(e&&"object"==typeof e){if(Array.isArray(e.and)){const t={op:"and",children:e.and.map(e=>this.normalizeRequirementSpec(e))};return e.description&&(t.description=e.description),t}if(Array.isArray(e.or)){const t={op:"or",children:e.or.map(e=>this.normalizeRequirementSpec(e))};return e.description&&(t.description=e.description),t}return{op:"leaf",req:e}}return{op:"leaf",req:{}}}evaluateReqNode(e,t,r={}){if(!e)return{node:"leaf",isMet:!1,leaf:{type:"unknown",index:-1,isMet:!1}};if("and"===e.op){const a=e.children?.map(e=>this.evaluateReqNode(e,t,r))||[],n={node:"and",isMet:a.every(e=>e.isMet),children:a};return e.description&&(n.description=e.description),n}if("or"===e.op){const a=e.children?.map(e=>this.evaluateReqNode(e,t,r))||[],n={node:"or",isMet:a.some(e=>e.isMet),children:a};return e.description&&(n.description=e.description),n}const a=e.req||{};let n;switch(a.type){case"precision_series":n=this.checkPrecisionSeriesRequirement(a,-1,r);break;case"application_series":n=this.checkApplicationSeriesRequirement(a,-1,r);break;case"running_shooting_course":n=this.checkRunningShootingCourseRequirement(a,-1,r);break;case"sustained_achievement":n=this.checkSustainedAchievementRequirement(a,-1,t,r);break;case"cumulative_competition_score":n=this.checkCumulativeCompetitionScoreRequirement(a,-1,r);break;case"standard_medal":n=this.checkStandardMedalRequirement(a,-1,r);break;case"sustained_reference":n=this.checkSustainedReferenceRequirement(a,-1,t,r);break;case"custom_criterion":n=this.checkCustomCriterionRequirement(a,-1,r);break;case"shooting_round":n=this.checkShootingRoundRequirement(a,-1,r);break;case"speed_shooting_series":n=this.checkSpeedShootingSeriesRequirement(a,-1,r);break;case"competition_performance":n=this.checkCompetitionPerformanceRequirement(a,-1,r);break;case"air_pistol_precision":n=this.checkAirPistolPrecisionRequirement(a,-1,r);break;default:n={type:a.type,index:-1,isMet:!1,reason:"unsupported_requirement_type",description:a.description}}return{node:"leaf",isMet:!!n.isMet,leaf:n}}flattenLeaves(e,t=[]){if(!e)return t;if("leaf"===e.node)return t.push(e.leaf),t;for(const r of e.children||[])this.flattenLeaves(r,t);return t}getContributingAchievements(e,t){const r=this.medals.getMedalById(e);if(!r)return[];try{const e=this.checkRequirements(r,{endYear:t});if(!e.allMet)return[];const a=new Set,n=e=>{if(e){if("leaf"===e.node&&e.leaf?.isMet){const t=e.leaf.matchingAchievementIds||[];for(const e of t)e&&a.add(e)}for(const t of e.children||[])n(t)}};return n(e.tree),Array.from(a)}catch{return[]}}getCandidateYearsForTree(){const e=new Set(this.getAllAchievementYears()),t=(new Date).getFullYear();return e.add(t),Array.from(e).sort((e,t)=>t-e)}getAgeAtYear(e){const t=this.profile?.dateOfBirth;if(!t)return null;const r=new Date(t);if(Number.isNaN(r.getTime()))return null;const a=new Date(e,11,31);let n=a.getFullYear()-r.getFullYear();const s=a.getMonth()-r.getMonth();return(s<0||0===s&&a.getDate()<r.getDate())&&(n-=1),n}resolveSustainedReferences(e,t,r){const a=e?.references??t?.references,n=e=>(e||[]).map(e=>"string"==typeof e?{medalId:e}:e).filter(e=>e&&e.medalId);if(Array.isArray(a)){const e=n(a);if(0===e.length)throw new Error("sustained_achievement.references must list at least one medalId");return e}if(a&&"object"==typeof a){const e=Array.isArray(a.when)?a.when:null;let t=null;if(e){const a=this.getAgeAtYear(r);for(const r of e){if(!r||"object"!=typeof r)continue;const e=r.if||{};let n=!0;if(e&&Object.prototype.hasOwnProperty.call(e,"age")){const t=e.age||{};null==a?n=!1:(null==t.gte||a>=t.gte||(n=!1),null==t.gt||a>t.gt||(n=!1),null==t.lte||a<=t.lte||(n=!1),null==t.lt||a<t.lt||(n=!1),null!=t.eq&&a!==t.eq&&(n=!1))}else n=!1;if(n){t=r.refs;break}}}if(!t&&a.otherwise&&(t=a.otherwise),t){const e=n(t);if(0===e.length)throw new Error("sustained_achievement.references rule must provide at least one medalId");return e}}else if(null!=a)throw new Error("Invalid sustained_achievement.references: expected array or object");return this.getSameTypePrereqMedalIds(t).map(e=>({medalId:e}))}checkSustainedReferenceRequirement(e,t,r,a={}){const n=a&&"number"==typeof a.endYear?a.endYear:null;if(null==n)return{type:"sustained_reference",index:t,isMet:!1,description:e.description,windowYear:null,reason:"end_year_required"};const s=this.resolveSustainedReferences(e,r,n);if(!Array.isArray(s)||0===s.length)throw new Error("sustained_reference.references must resolve to at least one medalId");const i=Number.isFinite(a.minStartYear)?{minStartYear:a.minStartYear}:{},l=s.every(e=>this.requirementsMetInYear(e.medalId,n,i));return{type:"sustained_reference",index:t,isMet:l,description:e.description,windowYear:l?n:null}}checkSustainedAchievementRequirement(e,t,r,a={}){const n=e.yearsOfAchievement??3,s=!0===this.profile?.features?.enforceCurrentYearForSustained,i=s?(new Date).getFullYear():a&&"number"==typeof a.endYear?a.endYear:(new Date).getFullYear();if(e&&e.perYear){const n=this.getEarliestCountingYearForMedal(r);let l=!0===e.mustIncludeCurrentYear;s&&(l=!0);let o=this.getAllAchievementYears();o.includes(i)||o.push(i),o=o.sort((e,t)=>e-t),"number"==typeof n&&(o=o.filter(e=>e>=n)),l&&(o=o.filter(e=>e<=i));const d=this.normalizeRequirementSpec(e.perYear),c="number"==typeof n?{minStartYear:n}:{},u=o.filter(e=>!!this.evaluateReqNode(d,r,{...a,endYear:e,...c}).isMet),m=new Set(u);let p,h,f=null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){let t=o;l&&o.includes(i)&&(t=[i]);let r=null,a=0;for(const n of t){let t=0;for(let r=n-e.timeWindowYears+1;r<=n;r++)m.has(r)&&t++;t>a&&(a=t,r=n)}p={current:a,required:e.yearsOfAchievement??1},h=a>=(e.yearsOfAchievement??1),f=h?r:null}else{const t=m.size;p={current:t,required:e.yearsOfAchievement??1},h=t>=(e.yearsOfAchievement??1),h&&l&&!m.has(i)&&(h=!1)}const x=h?f??i:i,g=this.evaluateReqNode(d,r,{...a,endYear:x,...c});return{type:"sustained_achievement",index:t,isMet:h,progress:p,description:e.description,windowYear:f,subtree:g,subtreeYear:x}}const l=this.resolveSustainedReferences(e,r,i),o=this.getEarliestCountingYearForMedal(r);let d,c,u=!0===e.mustIncludeCurrentYear||!0===r?.mustIncludeCurrentYear||l&&l.length>0;if(s&&(u=!0),l.length>0)d=this.getAllAchievementYears();else{const e=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type),t=this.groupBy(e,e=>e.year);d=Object.keys(t).map(e=>Number(e)).filter(e=>!Number.isNaN(e)).sort((e,t)=>e-t)}if("number"==typeof o&&(d=d.filter(e=>e>=o)),u&&(d=d.filter(e=>e<=i)),l.length>0){const e=e=>l.every(t=>this.requirementsMetInYear(t.medalId,e,"number"==typeof o?{minStartYear:o}:{}));c=new Set(d.filter(e))}else{const t=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type),r=this.groupBy(t,e=>e.year),a=e.minPointsPerYear??0,n=t=>(t||[]).some(t=>{const r=t.weaponGroup||"A",n=e.pointThresholds?.[r]?.min??a;return"number"==typeof t.points&&t.points>=n});c=new Set(d.filter(e=>n(r[e])))}let m,p,h=null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){let t=d;u&&d.includes(i)&&(t=[i]);let r=null,a=0;for(const n of t){let t=0;for(let r=n-e.timeWindowYears+1;r<=n;r++)c.has(r)&&t++;t>a&&(a=t,r=n)}m={current:a,required:n},p=a>=n,h=p?r:null}else{const e=c.size;m={current:e,required:n},p=e>=n,p&&u&&!c.has(i)&&(p=!1)}return{type:"sustained_achievement",index:t,isMet:p,progress:m,description:e.description,windowYear:h}}checkCustomCriterionRequirement(e,t,r={}){const a=r&&"number"==typeof r.endYear?r.endYear:null,n=ae.get(e.name);if(!n)return{type:"custom_criterion",index:t,isMet:!1,description:e.description,reason:"unknown_custom_criterion"};try{const s=n({profile:this.profile,medalsDb:this.medals,endYear:a,minStartYear:Number.isFinite(r.minStartYear)?r.minStartYear:void 0,params:e.params??{}}),i=!(!s||!("object"==typeof s?s.isMet:s));return{type:"custom_criterion",index:t,isMet:i,description:e.description,windowYear:i&&null!=a?a:null}}catch(s){return{type:"custom_criterion",index:t,isMet:!1,description:e.description,error:s?.message}}}checkStandardMedalRequirement(e,t,r={}){let a=(this.profile.prerequisites||[]).filter(e=>"standard_medal"===e.type);e.disciplineType&&(a=a.filter(t=>t.disciplineType===e.disciplineType)),e.medalTier&&(a=a.filter(t=>t.medalType===e.medalTier));const n=r&&"number"==typeof r.endYear?r.endYear:null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){const t=null!=n?n:(new Date).getFullYear(),s=t-e.timeWindowYears+1,i=Math.max(s,Number.isFinite(r.minStartYear)?r.minStartYear:s);a=a.filter(e=>(e.year??0)>=i&&(e.year??0)<=t)}else null!=n&&(a=a.filter(e=>e.year===n));const s=e.minAchievements??1,i={current:a.length,required:s},l=i.current>=s;return{type:"standard_medal",index:t,isMet:l,progress:i,description:e.description,windowYear:l&&null!=n?n:null,matchingAchievementIds:a.slice(0,s).map(e=>e.id).filter(Boolean)}}checkCumulativeCompetitionScoreRequirement(e,t,r={}){const a=(this.profile.prerequisites||[]).filter(e=>"competition_result"===e.type),n=r&&"number"==typeof r.endYear?r.endYear:null;if(null==n)return{type:"cumulative_competition_score",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};const s=e.minCompetitions??1,i=(t=>{let n=(t=>{let r=(t||[]).filter(t=>t.disciplineType===e.disciplineType);return e.competitionType&&(r=r.filter(t=>t.competitionType===e.competitionType)),r})(a);if(null!=t)if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){const a=t-e.timeWindowYears+1,s=Math.max(a,Number.isFinite(r.minStartYear)?r.minStartYear:a);n=n.filter(e=>(e.year??0)>=s&&(e.year??0)<=t)}else n=n.filter(e=>e.year===t);let s=[];return s="ppc"===e.disciplineType?n.filter(t=>{const r=t.ppcClass,a=e.pointThreshold?.[r]?.min;return"number"==typeof t.score&&"number"==typeof a&&t.score>=a}):e.seriesBasedThresholds?n.filter(t=>{if(e.competitionType&&t.competitionType!==e.competitionType)return!1;const r=String(t.seriesCount||""),a=t.weaponGroup||"A",n=e.seriesBasedThresholds[r];if(!n)return!1;const s=n[a]?.min;return"number"==typeof t.score&&"number"==typeof s&&t.score>=s}):n.filter(t=>{const r=t.weaponGroup||"A",a=e.pointThresholds?.[r]?.min;return"number"==typeof t.score&&"number"==typeof a&&t.score>=a}),s})(n),l=i.length>=s;return{type:"cumulative_competition_score",index:t,isMet:l,progress:{current:i.length,required:s},description:e.description,windowYear:l?n:null,matchingAchievementIds:i.slice(0,s).map(e=>e.id).filter(Boolean)}}checkShootingRoundRequirement(e,t,r={}){const a=(this.profile.prerequisites||[]).filter(e=>"shooting_round"===e.type),n=r&&"number"==typeof r.endYear?r.endYear:null;if(null==n)return{type:"shooting_round",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};let s=a;const i=e.timeWindowYears;if(1===i)s=a.filter(e=>e.year===n);else if("number"==typeof i&&i>1){const e=n-i+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);s=a.filter(e=>(e.year??0)>=t&&(e.year??0)<=n)}else s=a.filter(e=>e.year===n);const l=s.filter(t=>{const r=t.weaponGroup||"A",a=e.totalPointThresholds?.[r]?.min;return"number"==typeof t.totalPoints&&"number"==typeof a&&t.totalPoints>=a}),o=e.minAchievements??1,d={current:l.length,required:o},c=d.current>=o;return{type:"shooting_round",index:t,isMet:c,progress:d,description:e.description,windowYear:c?n:null,totalPointThresholds:e.totalPointThresholds,matchingAchievementIds:l.slice(0,o).map(e=>e.id).filter(Boolean)}}checkSpeedShootingSeriesRequirement(e,t,r={}){const a=(this.profile.prerequisites||[]).filter(e=>"speed_shooting_series"===e.type);if(null==r.endYear)return{type:"speed_shooting_series",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};let n=a;const s=e.timeWindowYears;if(1===s)n=a.filter(e=>e.year===r.endYear);else if("number"==typeof s&&s>1){const e=r.endYear-s+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);n=a.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else n=a.filter(e=>e.year===r.endYear);const i=this.filterBySpeedShootingThreshold(n,e),l=e.minAchievements??1,o={current:i.length,required:l},d=o.current>=l;return{type:"speed_shooting_series",index:t,isMet:d,progress:o,description:e.description,windowYear:d?r.endYear:null,pointThresholds:{A:e.pointThresholds?.A?.min,B:e.pointThresholds?.B?.min,C:e.pointThresholds?.C?.min,R:e.pointThresholds?.R?.min},matchingAchievementIds:i.slice(0,l).map(e=>e.id).filter(Boolean)}}checkCompetitionPerformanceRequirement(e,t,r={}){const a=(this.profile.prerequisites||[]).filter(e=>"competition_performance"===e.type);if(null==r.endYear)return{type:"competition_performance",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};let n=a;const s=e.timeWindowYears;if(1===s)n=a.filter(e=>e.year===r.endYear);else if("number"==typeof s&&s>1){const e=r.endYear-s+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);n=a.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else n=a.filter(e=>e.year===r.endYear);const i=this.filterByCompetitionPerformanceThreshold(n,e),l=e.minCompetitions??e.minAchievements??1,o={current:i.length,required:l},d=o.current>=l;return{type:"competition_performance",index:t,isMet:d,progress:o,description:e.description,windowYear:d?r.endYear:null,disciplineType:e.disciplineType,matchingAchievementIds:i.slice(0,l).map(e=>e.id).filter(Boolean)}}checkAirPistolPrecisionRequirement(e,t,r={}){const a=(this.profile.prerequisites||[]).filter(e=>"air_pistol_precision"===e.type);if(null==r.endYear)return{type:"air_pistol_precision",index:t,isMet:!1,description:e.description,reason:"end_year_required",windowYear:null};let n=a;const s=e.timeWindowYears;if(1===s)n=a.filter(e=>e.year===r.endYear);else if("number"==typeof s&&s>1){const e=r.endYear-s+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);n=a.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else n=a.filter(e=>e.year===r.endYear);const i=this.filterByAirPistolThreshold(n,e),l=e.minSeries??e.minAchievements??1,o={current:i.length,required:l},d=o.current>=l;return{type:"air_pistol_precision",index:t,isMet:d,progress:o,description:e.description,windowYear:d?r.endYear:null,minPointsPerSeries:e.minPointsPerSeries,matchingAchievementIds:i.slice(0,l).map(e=>e.id).filter(Boolean)}}filterByCompetitionPerformanceThreshold(e,t){return(e||[]).filter(e=>{if(t.disciplineType&&e.disciplineType!==t.disciplineType)return!1;if(t.maxPoints){const r=this.profile.sex||"male",a=t.maxPoints[r];return"number"==typeof a&&"number"==typeof e.points&&e.points<=a}if(t.pointThresholdPercent){const r=e.weaponGroup||"A",a=t.pointThresholdPercent[r]?.min??0;if("number"==typeof e.scorePercent)return e.scorePercent>=a;if("number"==typeof e.score&&"number"==typeof e.maxScore&&e.maxScore>0){return e.score/e.maxScore*100>=a}return!1}return!0})}filterByAirPistolThreshold(e,t){const r=t.minPointsPerSeries??0;return(e||[]).filter(e=>"number"==typeof e.points&&e.points>=r)}filterBySpeedShootingThreshold(e,t){const r={A:t.pointThresholds?.A?.min??0,B:t.pointThresholds?.B?.min??0,C:t.pointThresholds?.C?.min??0,R:t.pointThresholds?.R?.min??0};return(e||[]).filter(e=>{const t=e.weaponGroup||"A",a=r[t];return"number"==typeof e.points&&e.points>=a})}evaluateAllMedals(){const e=this.medals.getAllMedals(),t={unlocked:[],eligible:[],available:[],locked:[]};return e.forEach(e=>{const r=this.evaluateMedal(e.id);t[r.status].push(r)}),t}getEligibleYears(e){if(this.hasUnlockedMedal(e))return[];const t=this.getAllAchievementYears().sort((e,t)=>t-e),r=[];for(const a of t)try{const t=this.evaluateMedal(e,{endYear:a});t&&"eligible"===t.status&&r.push(a)}catch{}return r}}function se(){const e=t.useContext(I);if(e===P)throw new Error("useMedalDatabase must be used within MedalProvider");return e}function ie(){const e=t.useContext(F);if(!e)throw new Error("useProfile must be used within ProfileProvider");return e}function le(){const{medalDatabase:e}=se(),{currentProfile:r}=ie();return t.useMemo(()=>{if(!e)return null;return new ne(e,r??{unlockedMedals:[],prerequisites:[]})},[e,r])}function oe(){const e=le();return t.useMemo(()=>e?e.evaluateAllMedals():{unlocked:[],eligible:[],available:[],locked:[]},[e])}function de({children:e}){const t=le(),a=oe();return r.jsx(re.Provider,{value:{calculator:t,allStatuses:a},children:e})}const ce=t.createContext(null);function ue({children:e}){const[a,n]=t.useState([]),[s,i]=t.useState(-1),l=t.useCallback(e=>{n(t=>{const r=t.slice(0,s+1);r.push(e);const a=r.length>200?r.slice(r.length-200):r;return i(a.length-1),a})},[s]),o=t.useCallback(()=>{let e=null;return i(t=>{const r=t>0?t-1:t;return e=r!==t?r:null,r}),e},[]),d=t.useCallback(()=>{let e=null;return i(t=>{const r=t<a.length-1?t+1:t;return e=r!==t?r:null,r}),e},[a.length]),c=s>0,u=s>=0&&s<a.length-1,m=t.useMemo(()=>({pushState:l,undo:o,redo:d,canUndo:c,canRedo:u,history:a,historyIndex:s}),[l,o,d,c,u,a,s]);return r.jsx(ce.Provider,{value:m,children:e})}const me={achievementEntry:{default:"on",env:{production:"on"},title:"Registrering av aktiviteter",message:"Registrering av aktiviteter är under utveckling. Gränssnitt och beteende kan ändras."},historyTimeline:{default:"on",env:{production:"on"},title:"Historik",message:"Historiköversikten är under utveckling. Funktioner kan saknas."},enforceCurrentYearSetting:{default:"on",env:{production:"preview"},title:"Tvinga innevarande år",message:"Inställningen är under utveckling.",overlay:"inline"},csvImport:{default:"on",env:{production:"on"},title:"CSV-import/export",message:"CSV-import/export är under utveckling. Gränssnittet kan ändras och vissa funktioner saknas."}},pe=t.createContext(null);function he(e){try{localStorage.setItem("ff:overrides",JSON.stringify(e||{}))}catch{}}function fe({children:e}){const a=function(){const e="undefined"!=typeof window&&window.location&&window.location.hostname?window.location.hostname:"";return"localhost"===e||"127.0.0.1"===e?"development":"production"}(),[n,s]=t.useState(()=>"undefined"!=typeof window?function(){try{return JSON.parse(localStorage.getItem("ff:overrides")||"{}")}catch{return{}}}():{}),i=t.useContext(F),l=i?.currentProfile,o=i?.updateProfile,d=t.useMemo(()=>l?.features?.featureFlags||{},[l]),c=t.useMemo(()=>{const e="undefined"!=typeof window?function(){try{const e=new URLSearchParams(window.location.search).get("ff");return e?e.split(",").reduce((e,t)=>{const[r,a]=t.split(":");return r&&a&&(e[r.trim()]=a.trim()),e},{}):{}}catch{return{}}}():{},t={};for(const[r,n]of Object.entries(me||{})){const e=n?.default||"off",s=n?.env?.[a]??e;t[r]=s}for(const[r,a]of Object.entries(n||{}))t[r]=a;for(const[r,a]of Object.entries(d||{}))t[r]=a;for(const[r,a]of Object.entries(e||{}))t[r]=a;return t},[a,n,d]),u=e=>{const t={...n||{},...e||{}};s(t),he(t)},m={get:e=>c[e]||"off",enabled(e){const t=c[e]||"off";return"on"===t||"preview"===t},all:()=>({...c}),set(e,t){u({[e]:t})},setMany(e){u(e)},clear(e){const t={...n||{}};delete t[e],s(t),he(t)},clearAll(){s({}),he({})},async saveToProfile(e){if(!o||!l)return!1;const t={...l.features||{},featureFlags:{...e||{}}};return await o({...l,features:t}),!0},async clearProfileOverrides(){if(!o||!l)return!1;const e={...l.features||{}};return delete e.featureFlags,await o({...l,features:e}),!0}};return r.jsx(pe.Provider,{value:m,children:e})}const xe=t.createContext(null),ge={version:"pr-154-16c4cc2",number:"168",commit:"16c4cc2",timeISO:"2026-01-15T12:06:39.878Z"},be="app:onboardingTour:seen:",ye="app:onboardingTour:manualStart",ve={medals:"v1","tree-view":"v1","achievement-entry":"v1"};function je(e="medals"){return`${e}-${ve[e]||"v1"}`}function we(e){try{return sessionStorage.setItem(ye,e),!0}catch{return!1}}const Ne={medals:[{id:"welcome",title:"Snabbguide",body:"Sök, filtrera och öppna detaljer för att se krav och status.",target:null},{id:"search",title:"Sök",body:"Skriv för att filtrera märken.",target:'[data-tour="medals-search"]'},{id:"chips",title:"Snabbfilter",body:"Tryck på en status för att filtrera snabbt.",target:'[data-tour="chip-unlocked"]'},{id:"filters",title:"Fler filter",body:"Öppna filterpanelen för fler val.",target:'[data-tour="open-filters"], [data-tour="filter-panel"]'},{id:"open",title:"Öppna ett märke",body:"Tryck på ett märke i listan för att se detaljer. Lämna guiden öppen och tryck sedan Nästa.",target:'[data-tour="medal-row-0"]',requiresTarget:!0,requiresTargetHint:"Öppna ett märke för att fortsätta.",autoAdvanceToNextOn:'[data-tour="medal-detail-panel"]'},{id:"detail",title:"Detaljer",body:"När detaljvyn är öppen ser du krav, förhandskrav och status. Tryck Nästa för att avsluta.",target:'[data-tour="medal-detail-panel"]',requiresTarget:!0,requiresTargetHint:"Öppna ett märke för att fortsätta."}],"tree-view":[{id:"welcome",title:"Välkommen till trädvyn",body:"Se alla märken i ett interaktivt träd med kopplingar och progression.",target:null},{id:"canvas",title:"Interaktiv canvas",body:"Dra för att panorera, nyp eller använd zoomknapparna för att zooma.",target:'[data-tour="tree-canvas"]'},{id:"zoom",title:"Zoomkontroller",body:"Använd dessa knappar för att zooma in, ut eller återställa vyn.",target:'[data-tour="zoom-controls"]'},{id:"legend",title:"Teckenförklaring",body:"Färgerna visar status: grönt för upplåsta, gult för uppnåeliga, grått för låsta.",target:'[data-tour="tree-legend"]'},{id:"actions",title:"Åtgärdsmeny",body:"Här hittar du fler alternativ: exportera, växla visualisering och öppna helskärm.",target:'[data-tour="tree-actions"]'},{id:"node",title:"Klicka på märken",body:"Tryck på ett märke i trädet för att se detaljer. Årsbrickor visar hur många år som krävs.",target:'[data-tour="tree-canvas"]'}],"achievement-entry":[{id:"welcome",title:"Smart inmatning",body:"Formuläret anpassas automatiskt efter märkets krav. Värden och fält väljs baserat på vad som behövs.",target:'[data-tour="achievement-dialog"]',positionCenter:!0},{id:"type-selector",title:"Aktivitetstyp",body:"Om märket kan tjänas på flera sätt, välj vilken typ av aktivitet du vill logga.",target:'[data-tour="achievement-type-selector"]',requiresTarget:!1,positionCenter:!0,autoAdvanceToNextOn:'[data-tour="achievement-primary-input"]',requiresTargetHint:"Välj en aktivitetstyp för att fortsätta."},{id:"prefilled-values",title:"Förifyllda värden",body:"Fält är ifyllda med minimikrav från märket. Justera till ditt faktiska resultat.",target:'[data-tour="achievement-primary-input"]',requiresTarget:!0,requiresTargetHint:"Välj en aktivitetstyp för att fortsätta.",positionCenter:!0},{id:"requirement-hint",title:"Kravledtext",body:"Gråa ledtexter visar vad som krävs. Fyll i minst detta värde för att kvalificera.",target:'[data-tour="achievement-hint"]',positionCenter:!0}]};function ke({children:e}){const[a,n]=t.useState(!1),[s,i]=t.useState(0),[l,o]=t.useState("medals"),d=je(l),c=Ne[l]||Ne.medals,u=t.useCallback((e="medals")=>{o(e),i(0),n(!0)},[]),m=t.useCallback(()=>{n(!1)},[]),p=t.useCallback(()=>{!function(e){try{e&&localStorage.setItem(be+e,"true")}catch{}}(d),n(!1)},[d]),h=t.useCallback(()=>{i(e=>e>=c.length-1?e:e+1)},[c.length]),f=t.useCallback(()=>{i(e=>Math.max(0,e-1))},[]),x=t.useCallback((e="medals")=>!function(e=je()){try{return"true"===localStorage.getItem(be+e)}catch{return!1}}(je(e)),[]),g=t.useMemo(()=>({open:a,stepIndex:s,steps:c,start:u,close:m,complete:p,next:h,back:f,canAutoStart:x,tourId:d,currentTourType:l}),[a,s,c,u,m,p,h,f,x,d,l]);return r.jsx(xe.Provider,{value:g,children:e})}function Se({id:e,title:a,open:n,onClose:s,swipeToDismiss:i=!0,children:l}){const o=t.useRef(null),d=t.useRef(null);t.useEffect(()=>{if(!n)return;d.current=document.activeElement;const e=o.current,t=e=>{"Escape"===e.key&&(e.stopPropagation(),s?.())},r=t=>{if("Tab"!==t.key)return;if(!e)return;const r=e.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])'),a=Array.from(r).filter(e=>!e.hasAttribute("disabled")&&"true"!==e.getAttribute("aria-hidden"));if(0===a.length)return;const n=a[0],s=a[a.length-1];t.shiftKey&&document.activeElement===n?(t.preventDefault(),s.focus()):t.shiftKey||document.activeElement!==s||(t.preventDefault(),n.focus())};document.addEventListener("keydown",t),e?.addEventListener("keydown",r);const a=setTimeout(()=>e?.focus(),0);return()=>{document.removeEventListener("keydown",t),e?.removeEventListener("keydown",r),clearTimeout(a),d.current&&"function"==typeof d.current.focus&&d.current.focus()}},[n,s]);const c=function({onSwipe:e,threshold:r=50,allowedDirections:a=["left","right","up","down"]}={}){const n=t.useRef({x:0,y:0,t:0}),s=t.useRef({x:0,y:0,t:0});return{onTouchStart:e=>{if(!e.touches||0===e.touches.length)return;const t=e.touches[0];n.current={x:t.clientX,y:t.clientY,t:Date.now()},s.current={x:t.clientX,y:t.clientY,t:Date.now()}},onTouchMove:e=>{if(!e.touches||0===e.touches.length)return;const t=e.touches[0];s.current={x:t.clientX,y:t.clientY,t:Date.now()}},onTouchEnd:()=>{const t=s.current.x-n.current.x,i=s.current.y-n.current.y,l=Math.abs(t),o=Math.abs(i);let d=null;l>o?l>=r&&(d=t>0?"right":"left"):o>=r&&(d=i>0?"down":"up"),d&&a.includes(d)&&e?.(d)}}}({onSwipe:e=>{!i||"down"!==e&&"right"!==e||s?.()}});return n?r.jsxs("div",{"aria-hidden":!n,className:"fixed inset-0 z-[80]",children:[r.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>s?.(),"aria-hidden":!0}),r.jsxs("div",{id:e,role:"dialog","aria-modal":"true","aria-labelledby":e?`${e}-title`:void 0,ref:o,tabIndex:-1,className:"absolute left-0 right-0 bottom-0 bg-bg-secondary text-foreground rounded-t-2xl shadow-2xl border-t border-border focus:outline-none",style:{transform:"translateY(0)",transition:"undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches?"none":"transform 200ms ease",maxHeight:"85dvh",WebkitOverflowScrolling:"touch"},...c,children:[r.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[r.jsx("h2",{id:e?`${e}-title`:void 0,className:"text-lg font-semibold",children:a}),r.jsx("button",{type:"button",className:"btn btn-muted h-11 w-11 inline-flex items-center justify-center",onClick:()=>s?.(),"aria-label":"Close",children:"✕"})]}),r.jsx("div",{className:"p-4 pb-[calc(env(safe-area-inset-bottom)+1rem)] overflow-auto",style:{maxHeight:"calc(85dvh - 56px)",overflowY:"auto",overscrollBehavior:"contain"},children:l})]})]}):null}function Ce({name:e,className:t="w-4 h-4",...s}){const i=a[e]||n;return r.jsx(i,{"aria-hidden":"true",focusable:"false",className:t,...s})}function Me({backup:e,onRestore:a,onCancel:n}){const{metadata:i,validation:l}=t.useMemo(()=>{const t=e.exportedAt||e.profile?.lastModified||e.profile?.createdDate,r=e.version||"1.0",a=e.profile?.prerequisites?.length||0,n=e.profile?.unlockedMedals?.length||0,s=function(e){const t=[];return e&&"object"==typeof e?"profile-backup"!==e.kind?{status:"error",warnings:["Inte en giltig säkerhetskopia"],canImport:!1}:e.profile&&"object"==typeof e.profile?(e.exportedAt||t.push("Datum för säkerhetskopia saknas"),e.version||t.push("Formatversion saknas"),e.version&&"1.0"!==e.version&&t.push(`Okänd formatversion: ${e.version}`),e.profile.displayName||t.push("Profilnamn saknas"),e.profile.sex||t.push("Kön saknas i profilen"),0===t.length?{status:"valid",warnings:[],canImport:!0}:{status:"warning",warnings:t,canImport:!0}):{status:"error",warnings:["Profil saknas i säkerhetskopian"],canImport:!1}:{status:"error",warnings:["Ogiltig fil"],canImport:!1}}(e);return{metadata:{date:t,version:r,achievementCount:a,medalCount:n},validation:s}},[e]),o=r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 bg-black/50 z-[2000]",onClick:n,"aria-hidden":"true"}),r.jsxs("div",{role:"dialog","aria-modal":"true","aria-labelledby":"restore-preview-title",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"min(90vw, 32rem)",maxHeight:"90vh",overflow:"auto",zIndex:2001},className:"\n          bg-bg-primary\n          border-2 border-border\n          rounded-xl shadow-2xl\n          p-6\n        ",children:[r.jsx("h2",{id:"restore-preview-title",className:"text-2xl font-bold text-foreground mb-6",children:"Återställ från säkerhetskopia"}),r.jsxs("div",{className:"\n            mb-6 p-4 rounded-lg\n            bg-yellow-50 dark:bg-yellow-950\n            border-2 border-yellow-400 dark:border-yellow-600\n          ",role:"alert",children:[r.jsx("p",{className:"font-semibold text-yellow-800 dark:text-yellow-200 mb-1",children:"⚠️ Detta kommer att ersätta dina nuvarande data"}),r.jsx("p",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:"Se till att du har en säkerhetskopia av dina nuvarande framsteg innan du återställer."})]}),l.warnings.length>0&&r.jsxs("div",{className:"mb-6 p-4 rounded-lg bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800",role:"status","aria-live":"polite",children:[r.jsxs("div",{className:"flex items-start gap-2 mb-2",children:[r.jsx(Ce,{name:"AlertTriangle",className:"w-5 h-5 shrink-0 text-blue-600 dark:text-blue-400 mt-0.5","aria-hidden":"true"}),r.jsx("h3",{className:"font-semibold text-blue-800 dark:text-blue-200",children:"Varningar vid import"})]}),r.jsx("ul",{className:"text-sm text-blue-700 dark:text-blue-300 space-y-1 ml-7",children:l.warnings.map((e,t)=>r.jsxs("li",{children:["• ",e]},t))}),r.jsx("p",{className:"text-sm text-blue-700 dark:text-blue-300 mt-3 ml-7",children:"Du kan fortfarande importera säkerhetskopian."})]}),r.jsxs("div",{className:"mb-6 space-y-3",children:[r.jsx("h3",{className:"font-semibold text-foreground mb-3",children:"Information om säkerhetskopia"}),r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Skapad"}),r.jsx("p",{className:"font-semibold text-foreground",children:i.date?new Date(i.date).toLocaleDateString("sv-SE",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Okänt datum"})]}),r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Format"}),r.jsxs("p",{className:"font-semibold text-foreground",children:["v",i.version]})]}),r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Aktiviteter"}),r.jsx("p",{className:"font-semibold text-foreground",children:i.achievementCount})]}),r.jsxs("div",{className:"p-3 rounded-lg bg-bg-secondary border border-border",children:[r.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Upplåsta märken"}),r.jsx("p",{className:"font-semibold text-foreground",children:i.medalCount})]})]})]}),r.jsxs("div",{className:"flex gap-3",children:[r.jsx("button",{onClick:n,className:"\n              flex-1 py-3 rounded-lg font-medium\n              bg-bg-secondary text-foreground\n              border-2 border-border\n              hover:bg-bg-tertiary\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-border\n            ",children:"Avbryt"}),r.jsx("button",{onClick:a,className:"\n              flex-1 py-3 rounded-lg font-medium\n              bg-primary text-primary-foreground\n              hover:bg-primary/90\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-primary\n            ",children:"Återställ nu"})]})]})]});return s.createPortal(o,document.body)}function Ae({id:e="profile-import-dialog",open:a,onClose:n}){const{restoreProfileFromBackup:s}=ie(),[i,l]=t.useState(""),[o,d]=t.useState("new-id"),[c,u]=t.useState(null),[m,p]=t.useState(!1),[h,f]=t.useState(!1),[x,g]=t.useState(null),[b,y]=t.useState(null),[v,j]=t.useState(!1),[w,N]=t.useState(null),k=t.useRef(null);if(t.useEffect(()=>{if(!i.trim())return void y(null);const e=function(e){if(!e||!e.trim())return{status:"error",message:"Ingen data angiven"};try{const t=JSON.parse(e);return t&&"object"==typeof t?"profile-backup"!==t.kind?{status:"error",message:"Inte en säkerhetskopia"}:t.profile?t.exportedAt&&t.version&&t.profile.displayName?{status:"valid",message:"Giltig säkerhetskopia"}:{status:"warning",message:"Säkerhetskopia kan importeras med varningar"}:{status:"error",message:"Profil saknas"}:{status:"error",message:"Ogiltig JSON-struktur"}}catch{return{status:"error",message:"Ogiltig JSON"}}}(i);y(e)},[i]),t.useEffect(()=>{a||(N(null),l(""),y(null),j(!1))},[a]),!a)return null;return r.jsxs("div",{className:"fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4",children:[r.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":`${e}-title`,id:e,className:"w-[min(92vw,32rem)] max-h-[85vh] overflow-auto rounded-xl bg-bg-secondary border border-border shadow-2xl",children:r.jsxs("form",{onSubmit:async e=>{e.preventDefault();try{if(p(!0),u(null),!i.trim())return u("Klistra in JSON eller välj en fil."),void p(!1);const e=G(i);g(e),f(!0),p(!1)}catch(t){u(t.message||"Kunde inte läsa säkerhetskopian"),p(!1)}},className:"p-6 space-y-5",children:[r.jsx("h2",{id:`${e}-title`,className:"text-2xl font-bold text-text-primary",children:"Importera profil (säkerhetskopia)"}),c&&r.jsx("div",{className:"alert alert-error",role:"alert","aria-live":"assertive",children:c}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",children:"Välj säkerhetskopia"}),r.jsx("p",{id:`${e}-file-hint`,className:"text-xs text-muted-foreground",children:"JSON-filer (.json eller .txt) accepteras"}),r.jsx("input",{ref:k,id:`${e}-file`,type:"file",accept:".json,.txt,application/json",onChange:e=>{const t=e.target.files?.[0];if(!t)return;N(t.name);const r=new FileReader;r.onload=()=>l(String(r.result||"")),r.readAsText(t)},className:"sr-only",disabled:m,"aria-describedby":`${e}-file-hint`}),r.jsxs("button",{type:"button",onClick:()=>{k.current?.click()},disabled:m,"aria-describedby":`${e}-file-hint`,className:"\n                w-full min-h-[44px] px-4 py-2\n                bg-bg-secondary border-2 border-border rounded-lg\n                hover:bg-bg-tertiary hover:border-primary\n                focus-visible:outline-none focus-visible:ring-2\n                focus-visible:ring-primary focus-visible:ring-offset-2\n                transition-colors\n                flex items-center gap-3\n                disabled:opacity-50 disabled:cursor-not-allowed\n              ",children:[r.jsx(Ce,{name:"Upload",className:"w-5 h-5 text-muted-foreground","aria-hidden":"true"}),r.jsx("span",{className:"flex-1 text-left text-sm",children:w||"Välj fil att återställa från..."}),w&&r.jsx(Ce,{name:"CheckCircle",className:"w-5 h-5 text-green-600 dark:text-green-400","aria-hidden":"true"})]})]}),r.jsxs("button",{type:"button",onClick:()=>j(!v),className:"text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 transition-colors",disabled:m,children:[r.jsx(Ce,{name:v?"ChevronDown":"ChevronRight",className:"w-4 h-4","aria-hidden":"true"}),r.jsx("span",{children:v?"Dölj avancerade alternativ":"Visa avancerade alternativ"})]}),v&&r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",htmlFor:`${e}-textarea`,children:"Klistra in JSON"}),r.jsx("textarea",{id:`${e}-textarea`,value:i,onChange:e=>l(e.target.value),className:"textarea min-h-[8rem]",placeholder:"Klistra in JSON-innehållet från din säkerhetskopia här...",disabled:m,"aria-describedby":b?`${e}-validation-status`:void 0}),b&&r.jsxs("div",{id:`${e}-validation-status`,role:"status","aria-live":"polite",className:`\n                  flex items-start gap-2 p-3 rounded-lg text-sm\n                  ${"valid"===b.status?"bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800":""}\n                  ${"warning"===b.status?"bg-yellow-50 dark:bg-yellow-950 border border-yellow-200 dark:border-yellow-800":""}\n                  ${"error"===b.status?"bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-800":""}\n                `,children:[r.jsx(Ce,{name:"valid"===b.status?"CheckCircle":"warning"===b.status?"AlertTriangle":"XCircle",className:`\n                    w-5 h-5 shrink-0 mt-0.5\n                    ${"valid"===b.status?"text-green-600 dark:text-green-400":""}\n                    ${"warning"===b.status?"text-yellow-600 dark:text-yellow-400":""}\n                    ${"error"===b.status?"text-red-600 dark:text-red-400":""}\n                  `,"aria-hidden":"true"}),r.jsx("span",{className:`\n                    ${"valid"===b.status?"text-green-800 dark:text-green-200":""}\n                    ${"warning"===b.status?"text-yellow-800 dark:text-yellow-200":""}\n                    ${"error"===b.status?"text-red-800 dark:text-red-200":""}\n                  `,children:b.message})]})]}),r.jsxs("fieldset",{className:"space-y-2",children:[r.jsx("legend",{className:"block text-sm font-medium text-text-secondary",children:"Metod"}),r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsxs("label",{className:"inline-flex items-center gap-2",children:[r.jsx("input",{type:"radio",name:`${e}-strategy`,value:"new-id",checked:"new-id"===o,onChange:()=>d("new-id"),disabled:m}),r.jsx("span",{children:"Skapa ny profil"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2",children:[r.jsx("input",{type:"radio",name:`${e}-strategy`,value:"overwrite",checked:"overwrite"===o,onChange:()=>d("overwrite"),disabled:m}),r.jsx("span",{children:"Ersätt profil med samma ID"})]})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3 pt-2",children:[r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px] disabled:opacity-50 order-1 sm:order-2",disabled:m||!i.trim()||"error"===b?.status,"aria-describedby":"error"===b?.status?`${e}-validation-status`:void 0,children:"Förhandsgranska"}),r.jsx("button",{type:"button",onClick:n,className:"btn btn-secondary min-h-[44px] order-2 sm:order-1",disabled:m,children:"Avbryt"})]})]})}),h&&x&&r.jsx(Me,{backup:x,onRestore:async()=>{try{p(!0),u(null),await s(i,{strategy:o}),l(""),f(!1),g(null),n?.()}catch(e){u(e.message||"Import misslyckades"),f(!1)}finally{p(!1)}},onCancel:()=>{f(!1),g(null)}})]})}function Te({mode:e="picker",open:a=!1,onClose:n,id:s="profile-picker",forceCreate:i=!1,convertGuest:l=!1}){const{profiles:o,currentProfile:d,loading:c,createProfile:u,updateProfile:m,selectProfile:p,deleteProfile:h,convertGuestToSaved:f,startExplorerMode:x}=ie(),[g,b]=t.useState(!1),[y,v]=t.useState("create"),[j,w]=t.useState(null),[N,k]=t.useState(""),[S,C]=t.useState(""),[M,A]=t.useState(""),[T,_]=t.useState(!1),P="picker"===e,I=P&&a&&i,D=I?"create":y,F=I?null:j,q=async e=>{if(confirm("Är du säker? Det går inte att ångra."))try{await h(e)}catch(t){console.error("Misslyckades ta bort profil:",t)}},E=e=>{if(!e)return null;const t=new Date(e);if(Number.isNaN(t.getTime()))return null;const r=new Date;let a=r.getFullYear()-t.getFullYear();const n=r.getMonth()-t.getMonth();return(n<0||0===n&&r.getDate()<t.getDate())&&a--,a},$=e=>"female"===e?"Kvinna":"male"===e?"Man":"—";return r.jsxs(r.Fragment,{children:[P?r.jsxs(Se,{id:s,title:"Välj profil",open:a,onClose:n,children:[o.length>0?r.jsx("div",{className:"space-y-2",children:o.map(e=>r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{onClick:()=>{p(e.userId),n?.()},className:"btn btn-muted flex-1 justify-start text-left",children:[e.displayName," (Ålder ",E(e.dateOfBirth)??"—"," • ",$(e.sex),")"]}),r.jsx("button",{onClick:()=>{v("edit"),w(e),k(e.displayName||""),C(e.dateOfBirth||""),A(e.sex||""),b(!0)},className:"btn btn-secondary",children:"Ändra"}),r.jsx("button",{onClick:()=>q(e.userId),className:"btn btn-danger",children:"Ta bort"})]},e.userId))}):r.jsx("p",{className:"text-text-secondary",children:"Inga profiler ännu."}),r.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[r.jsx("button",{onClick:()=>{v("create"),w(null),k(""),C(""),A(""),b(!0)},className:"btn btn-primary min-h-[44px]",children:"Skapa ny profil"}),r.jsx("button",{onClick:()=>_(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Importera profil"}),0===o.length&&r.jsx("button",{onClick:()=>{v("guest"),w(null),k("Gästläge"),C("1975-01-02"),A(""),b(!0)},className:"btn btn-muted min-h-[44px]",children:"Fortsätt i gästläge"})]})]}):r.jsx("div",{children:d?r.jsxs("div",{className:"bg-bg-secondary border border-border ring-1 ring-primary/20 rounded-lg p-4 mb-4",children:[r.jsxs("p",{className:"text-text-primary font-semibold",children:["Profile: ",d.displayName]}),r.jsxs("p",{className:"text-text-secondary text-sm",children:["Ålder: ",E(d.dateOfBirth)??"—"]}),r.jsxs("p",{className:"text-text-secondary text-sm",children:["Kön: ",$(d.sex)]})]}):r.jsxs("div",{className:"bg-bg-secondary border border-border rounded-lg p-4 mb-4",children:[r.jsx("p",{className:"text-text-primary mb-3",children:"No profile selected"}),o.length>0&&r.jsx("div",{className:"space-y-2 mb-3",children:o.map(e=>r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{onClick:()=>p(e.userId),className:"btn btn-muted flex-1 justify-start text-left",children:[e.displayName," (Age ",E(e.dateOfBirth)??"—"," • ",$(e.sex),")"]}),r.jsx("button",{onClick:()=>{v("edit"),w(e),k(e.displayName||""),C(e.dateOfBirth||""),A(e.sex||""),b(!0)},className:"btn btn-secondary",children:"Ändra"}),r.jsx("button",{onClick:()=>q(e.userId),className:"btn btn-danger",children:"Ta bort"})]},e.userId))}),r.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[r.jsx("button",{onClick:()=>{v("create"),w(null),k(""),C(""),A(""),b(!0)},className:"btn btn-primary min-h-[44px]",children:"Skapa ny profil"}),r.jsx("button",{onClick:()=>_(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Importera profil"})]})]})}),r.jsx(Ae,{id:"profile-import-dialog",open:T,onClose:()=>_(!1)}),(I||g)&&r.jsx("div",{className:"fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4",children:r.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":"create-profile-title",className:"w-[min(92vw,32rem)] max-h-[85vh] overflow-auto rounded-xl bg-bg-secondary border border-border shadow-2xl",children:r.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),M&&("guest"===y||N.trim()&&S))try{"guest"===y?await x(M):"edit"===D&&F?await m({...j,displayName:N.trim(),dateOfBirth:S,sex:M}):l&&d?.isGuest?await f(N.trim(),S,M):await u(N.trim(),S,M),k(""),C(""),A(""),w(null),b(!1),n?.()}catch(t){console.error("Misslyckades spara profil:",t)}},className:"p-6 space-y-5",children:[r.jsx("h2",{id:"create-profile-title",className:"text-2xl font-bold text-text-primary",children:"edit"===D?"Ändra profil":"guest"===y?"Gästläge":"Skapa ny profil"}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",children:"Profile Name"}),r.jsx("input",{type:"text",value:N,onChange:e=>k(e.target.value),className:"input",placeholder:"Ditt namn",disabled:c||"guest"===y,required:!0})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",children:"Födelsedatum"}),r.jsx("input",{type:"date",value:S,onChange:e=>C(e.target.value),className:"input",disabled:c||"guest"===y,required:!0}),r.jsx("p",{className:"text-xs text-text-secondary",children:"Används för att beräkna åldersberoende krav enligt regelboken."})]}),r.jsxs("fieldset",{className:"space-y-2",children:[r.jsxs("legend",{className:"block text-sm font-medium text-text-secondary",children:["Kön (enligt regelboken) ",r.jsx("span",{"aria-hidden":"true",children:"*"})]}),r.jsx("p",{className:"text-xs text-text-secondary",children:"Används endast för att beräkna medaljkrav enligt regelboken."}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[r.jsxs("label",{className:"btn btn-muted justify-start text-left min-h-[44px]",children:[r.jsx("input",{type:"radio",name:"sex",value:"female",checked:"female"===M,onChange:e=>A(e.target.value),disabled:c,className:"mr-2",required:!0}),"Kvinna"]}),r.jsxs("label",{className:"btn btn-muted justify-start text-left min-h-[44px]",children:[r.jsx("input",{type:"radio",name:"sex",value:"male",checked:"male"===M,onChange:e=>A(e.target.value),disabled:c,className:"mr-2",required:!0}),"Man"]})]})]}),r.jsxs("div",{className:"flex items-center justify-end gap-3 pt-2",children:[r.jsx("button",{type:"submit",className:"btn btn-primary disabled:opacity-50",disabled:c||!M,children:"edit"===D?"Spara":"guest"===y?"Starta gästläge":l&&d?.isGuest?"Spara framsteg":"Skapa"}),r.jsx("button",{type:"button",onClick:()=>{b(!1),I&&n?.()},className:"btn btn-secondary",disabled:c,children:"Avbryt"})]})]})})})]})}const _e=[{path:"/skill-tree",label:"Märkesträd"},{path:"/medals",label:"Alla märken"},{path:"/data",label:"Data"},{path:"/settings",label:"Inställningar"},{path:"/about",label:"Om"},{path:"/help",label:"Hjälp"}];function Pe(){const e=i(),a=l(),[n,s]=t.useState(null),d=n===e.pathname,{currentProfile:c}=ie(),[u,m]=t.useState(!1),p=c?.displayName?c.displayName.trim().split(/\s+/).map(e=>e[0]).slice(0,2).join("").toUpperCase():null;t.useEffect(()=>{if(!d)return;const e=e=>{"Escape"===e.key&&s(null)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[d]);const h=e=>{e.preventDefault(),s(null),m(!1),a("/help")};return r.jsxs("header",{className:"bg-surface border-b border-border sticky top-0 z-50",children:[r.jsx("div",{className:"max-w-6xl mx-auto px-4",children:r.jsxs("div",{className:"py-2",children:[r.jsx("a",{href:"#main",className:"absolute -top-10 left-2 focus:top-2 focus:left-2 focus:z-[60] btn btn-primary",children:"Hoppa till innehåll"}),r.jsxs("div",{className:"flex items-center justify-between gap-2",children:[r.jsxs(o,{to:"/",onClick:()=>{s(null),m(!1)},className:"inline-flex items-center gap-2 text-2xl font-bold leading-tight break-words text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsx(Ce,{name:"Award",className:"w-6 h-6 shrink-0"}),r.jsx("span",{children:"Skyttemärken"})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("button",{type:"button",onClick:()=>m(!0),className:"inline-flex items-center justify-center h-10 w-10 sm:h-11 sm:w-11 rounded-full btn btn-muted","aria-haspopup":"dialog","aria-controls":"profile-picker","aria-label":c?.displayName?`Aktiv profil: ${c.displayName}`:"Välj profil",title:c?.displayName||"Välj profil",children:p||"?"}),r.jsx("nav",{"aria-label":"Primary",className:"hidden sm:block",children:r.jsx("ul",{className:"flex gap-2",children:_e.map(t=>{const a=e.pathname===t.path,n="/help"===t.path;return r.jsx("li",{children:r.jsx(o,{to:t.path,onClick:n?h:()=>m(!1),className:"inline-flex items-center min-h-[44px] px-4 py-2 rounded transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary "+(a?"bg-primary text-primary-foreground":"text-muted-foreground hover:bg-surface"),"aria-current":a?"page":void 0,children:t.label})},t.path)})})}),r.jsx("button",{type:"button",onClick:()=>s(t=>t===e.pathname?null:e.pathname),className:"sm:hidden inline-flex items-center justify-center h-11 w-11 rounded-md btn btn-muted","aria-label":"Växla meny","aria-controls":"mobile-primary-nav","aria-expanded":d?"true":"false",children:r.jsx(Ce,{name:"Menu",size:20,className:"shrink-0"})})]})]}),r.jsx("nav",{id:"mobile-primary-nav","aria-label":"Primary",className:(d?"mt-2":"hidden")+" sm:hidden",children:r.jsx("ul",{className:"grid grid-cols-2 gap-2",children:_e.map(t=>{const a=e.pathname===t.path,n="/help"===t.path;return r.jsx("li",{children:r.jsx(o,{to:t.path,onClick:n?h:()=>{s(null),m(!1)},className:"inline-flex items-center min-h-[44px] px-4 py-2 rounded transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary "+(a?"bg-primary text-primary-foreground":"text-muted-foreground hover:bg-surface"),"aria-current":a?"page":void 0,children:t.label})},t.path)})})})]})}),r.jsx(Te,{id:"profile-picker",mode:"picker",open:u,onClose:()=>m(!1)})]})}const Ie="https://www.pistolskytteforbundet.se/",De="https://github.com/mandakan/spsf-medal-explorer",Fe="https://buymeacoffee.com/thias",qe="https://www.pistolskytteforbundet.se/om-pistolskytte/regler/skjuthandboken-och-sakb/",Ee="Skyttemärken",$e="Mathias A",Ge="MIT",Be={2024:20};function Le(e){const t=Object.entries(Be).map(([e,t])=>[Number(e),t]).sort((e,t)=>e[0]-t[0]);let r=t[0]?.[1]??null;for(const[a,n]of t)e>=a&&(r=n);return r}const Ye=Le((new Date).getFullYear());function Re({className:e="w-5 h-5",...t}){return r.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:e,...t,children:r.jsx("path",{fill:"currentColor",d:"M12 .5a12 12 0 0 0-3.79 23.4c.6.11.82-.26.82-.58v-2.03c-3.34.73-4.04-1.61-4.04-1.61-.55-1.41-1.35-1.79-1.35-1.79-1.1-.75.08-.73.08-.73 1.22.09 1.86 1.25 1.86 1.25 1.08 1.85 2.83 1.31 3.52 1 .11-.79.42-1.31.76-1.61-2.66-.3-5.46-1.33-5.46-5.93 0-1.31.47-2.38 1.24-3.22-.13-.3-.54-1.52.12-3.17 0 0 1.01-.32 3.3 1.23.96-.27 1.98-.4 3-.4s2.04.13 3 .4c2.29-1.55 3.3-1.23 3.3-1.23.66 1.65.25 2.87.12 3.17.77.84 1.24 1.91 1.24 3.22 0 4.61-2.8 5.62-5.47 5.92.43.37.82 1.1.82 2.22v3.29c0 .32.22.69.83.58A12 12 0 0 0 12 .5Z"})})}function Oe({className:e="w-5 h-5",...t}){return r.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:e,...t,children:r.jsx("path",{fill:"currentColor",d:"M3 7h13a3 3 0 0 1 3 3v1a4 4 0 0 1-3 3.87V16a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V7Zm16 3a1 1 0 0 0-1-1h-1v3.82A2 2 0 0 0 19 11v-1ZM5 18a2 2 0 0 0 2 2h5a2 2 0 0 0 2-2V9H5v9ZM10 2a1 1 0 0 1 1 1c0 .83-.5 1.25-.8 1.5-.2.17-.2.17-.2.5a1 1 0 0 1-2 0c0-1 .5-1.5.8-1.75.2-.17.2-.17.2-.5a1 1 0 0 1 1-1Zm4 0a1 1 0 0 1 1 1c0 .83-.5 1.25-.8 1.5-.2.17-.2.17-.2.5a1 1 0 0 1-2 0c0-1 .5-1.5.8-1.75.2-.17.2-.17.2-.5a1 1 0 0 1 1-1Z"})})}function Ve(){const e=(new Date).getFullYear(),t=$e,a=Ge,n=De,s=Fe,i=`${"undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/"}LICENSE`;return r.jsx("footer",{role:"contentinfo",className:"w-full border-t border-border bg-bg-primary",children:r.jsx("div",{className:"max-w-6xl mx-auto px-4 py-6",children:r.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-4",children:[r.jsxs("p",{className:"text-sm text-text-secondary text-center md:text-left",children:["© ",e," ",t," •"," ",r.jsxs("a",{href:i,target:"_blank",rel:"noopener noreferrer",className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary",children:["Licensierad under ",a]})]}),r.jsxs("nav",{className:"flex items-center gap-2","aria-label":"Sidfotslänkar",children:[r.jsxs("a",{href:n,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm min-h-[44px] text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary","aria-label":"Öppna GitHub-repositoriet",children:[r.jsx(Re,{}),r.jsx("span",{children:"Källkod"})]}),r.jsxs("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm min-h-[44px] text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary","aria-label":"Köp mig en kaffe",children:[r.jsx(Oe,{}),r.jsx("span",{children:"Köp en kaffe till mig"})]})]})]})})})}function Ue(){const e=t.useContext(Q);if(!e)throw new Error("useBackup must be used within BackupProvider");return e}function ze(e=new Date){try{return new Date(e).toISOString()}catch{return(new Date).toISOString()}}function Ke(e){return e?Array.isArray(e)?e:[e]:[]}async function He(e,{version:t="1.0"}={}){const r={kind:"profile-backup",version:t,exportedAt:ze(),profile:{userId:e?.userId||"",displayName:e?.displayName||"",createdDate:e?.createdDate||ze(),lastModified:e?.lastModified||ze(),dateOfBirth:e?.dateOfBirth||"",sex:e?.sex||"",unlockedMedals:Ke(e?.unlockedMedals),prerequisites:Ke(e?.prerequisites),features:{allowManualUnlock:!!e?.features?.allowManualUnlock,enforceCurrentYearForSustained:!!e?.features?.enforceCurrentYearForSustained},notifications:!!e?.notifications}};return JSON.stringify(r,null,2)}function We(){const{shouldShowReminder:e,dismissReminder:a,markBackupCreated:n}=Ue(),{currentProfile:s}=ie(),[i,l]=t.useState(!1);if(!e||!s)return null;return r.jsx("div",{role:"status","aria-live":"polite",className:"sticky top-0 z-[2000] bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-950 dark:to-orange-950 border-b-2 border-yellow-400 dark:border-yellow-600 px-4 py-3 shadow-sm",children:r.jsxs("div",{className:"max-w-6xl mx-auto flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4",children:[r.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[r.jsx(Ce,{name:"AlertTriangle",className:"w-6 h-6 text-yellow-600 dark:text-yellow-400 shrink-0","aria-hidden":"true"}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("p",{className:"font-semibold text-color-text-primary",children:"Dags att säkerhetskopiera dina uppgifter"}),r.jsx("p",{className:"text-sm text-color-text-secondary mt-0.5",children:"Din data finns bara på den här enheten. Säkerhetskopiera regelbundet för att vara säker."})]})]}),r.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto sm:shrink-0",children:[r.jsxs("button",{onClick:async()=>{try{l(!0);const e=(new Date).toISOString().split("T")[0],t=await He(s,{version:"1.0"});!function(e,t,r="application/octet-stream"){if("undefined"==typeof window||"undefined"==typeof document)return;let a;if(e instanceof Blob)a=e;else if(e instanceof Uint8Array)a=new Blob([e],{type:r});else if("string"==typeof e)a=new Blob([e],{type:r+";charset=utf-8"});else{if(null==e)throw new Error("downloadFile: invalid data");a=new Blob([JSON.stringify(e,null,2)],{type:"application/json;charset=utf-8"})}const n=URL.createObjectURL(a),s=document.createElement("a");s.href=n,s.download=t,s.rel="noopener",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}(t,`medal-backup-${e}.json`,"application/json"),await n().catch(e=>{console.error("Failed to mark backup as created:",e)})}catch(e){console.error("Backup error:",e)}finally{l(!1)}},disabled:i,className:"btn btn-primary flex-1 sm:flex-none min-h-[44px] px-4 py-2",children:[r.jsx(Ce,{name:"Download",className:"w-4 h-4","aria-hidden":"true"}),i?"Säkerhetskopierar...":"Säkerhetskopiera nu"]}),r.jsx("button",{onClick:async()=>{await a()},"aria-label":"Påminn mig om 7 dagar",className:"btn btn-secondary min-h-[44px] px-4 py-2",children:"Senare"})]})]})})}function Xe(){return r.jsxs("div",{className:"min-h-screen bg-bg-primary",children:[r.jsx(We,{}),r.jsx(Pe,{}),r.jsx("div",{className:"max-w-6xl mx-auto px-4 py-8",children:r.jsx("main",{id:"main",children:r.jsx(d,{})})}),r.jsx(Ve,{})]})}function Je({id:e="disclaimer-global",variant:a="info",text:n="OBS: Fristående app; ej godkänd av Svenska Pistolskytteförbundet. Vid skillnader gäller alltid senaste officiella regelbok.",linkUrl:s,linkLabel:i,dismissible:l=!0,className:o="",year:d=(new Date).getFullYear()}){const c=t.useMemo(()=>Le(d),[d]),u=t.useMemo(()=>i??(c?`Läs regelboken (v${c})`:"Läs regelboken"),[i,c]),m=t.useMemo(()=>`dismiss:${e}${c?`@${c}`:""}`,[e,c]),[p,h]=t.useState(!1);t.useEffect(()=>{h("1"===localStorage.getItem(m))},[m]);if(p)return null;const f="warning"===a?"border-review text-foreground":"border-border text-muted-foreground";return r.jsxs("div",{role:"status","aria-live":"polite",className:["relative flex items-center gap-2 rounded-md border px-3 py-2 text-sm bg-bg-secondary min-h-11",f,o].filter(Boolean).join(" "),children:[r.jsx("span",{"aria-hidden":"true",className:"warning"===a?"inline-block w-2 h-2 rounded-full bg-review":"inline-block w-2 h-2 rounded-full bg-primary opacity-60"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("span",{children:n}),s?r.jsx("a",{className:"underline underline-offset-2 ml-2 hover:opacity-80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded-sm",href:s,target:"_blank",rel:"noopener noreferrer","aria-label":"Öppna officiell regelbok i ny flik",children:u}):null]}),l?r.jsx("button",{type:"button",onClick:()=>{h(!0),localStorage.setItem(m,"1")},className:"ml-2 inline-flex items-center justify-center rounded h-11 w-11 md:h-6 md:w-6 hover:bg-bg-secondary/70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary","aria-label":"Stäng meddelande",children:r.jsx("span",{"aria-hidden":"true",children:"×"})}):null]})}function Ze(){const{medalDatabase:e,loading:t}=se();return r.jsxs("div",{className:"space-y-8",children:[r.jsxs("section",{className:"text-center mb-12",children:[r.jsx("h1",{className:"text-4xl font-bold text-foreground mb-4",children:"Skyttemärken"}),r.jsx("p",{className:"text-lg text-muted-foreground",children:"Dokumentera dina skyttemärken och medaljer med aktiviteter, utforska framtida märken och planera progression"})]}),r.jsx(Je,{id:"disclaimer-home",variant:"info",linkUrl:qe}),r.jsxs("section",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[r.jsxs(o,{to:"/skill-tree",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(Ce,{name:"Target",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Märken"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Utforska märken i ett interaktivt träd"})]}),r.jsxs(o,{to:"/medals",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(Ce,{name:"List",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Märkeslista"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Översikt över alla märken med filter och sökning"})]}),r.jsxs(o,{to:"/settings",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(Ce,{name:"Settings",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Inställningar"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Hantera din profil"})]})]}),!t&&e&&r.jsxs("section",{className:"card p-6 shadow",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:"Status"}),r.jsxs("p",{className:"text-muted-foreground",children:[r.jsx(Ce,{name:"CheckCircle",className:"inline w-4 h-4 align-text-bottom mr-1 text-muted-foreground"}),e.getAllMedals().length," märken laddade"]}),r.jsxs("p",{className:"mt-2 text-muted-foreground",children:["Version: ",r.jsx("code",{children:ge.version})," • Build: ",r.jsx("code",{children:ge.number})," • Commit: ",r.jsx("code",{children:ge.commit})]})]})]})}function Qe(e=1,r=.5,a=3,n={}){const[s,i]=t.useState(0),[l,o]=t.useState(0),[d,c]=t.useState(e),{getBounds:u=null,overscrollPx:m=48,contentPaddingPx:p={left:0,top:0,right:0,bottom:0}}=n,h=t.useRef(null),f=t.useRef(new Map),x=t.useRef({initialDistance:0,initialScale:e,lastCenter:null}),g=t.useRef({vx:0,vy:0,lastT:0,raf:0}),b=t.useRef({x:0,y:0,t:0}),y=t.useCallback(()=>{if("undefined"==typeof window||!window.matchMedia)return!1;try{return window.matchMedia("(prefers-reduced-motion: reduce)").matches}catch{return!1}},[]),v=t.useCallback(()=>{const e=g.current;e.raf&&(cancelAnimationFrame(e.raf),e.raf=0),e.vx=0,e.vy=0,e.lastT=0},[]),j=t.useRef({width:0,height:0}),w=t.useRef({x:0,y:0}),N=t.useRef(e);t.useEffect(()=>{N.current=d},[d]),t.useEffect(()=>{w.current={x:s,y:l}},[s,l]);const k=t.useCallback(e=>{const t=e?.currentTarget?.getBoundingClientRect?.();t&&(j.current={width:t.width,height:t.height})},[]),S=(e,t)=>t<=0||e<=0?0:e*t/(e+t),C=t.useCallback((e,t=j.current)=>{if(!n||!u||!t?.width)return null;const r=u(),a=Math.max(.001,e),s=t.width/a,i=t.height/a,l=(p?.left||0)/a,o=(p?.right||0)/a,d=(p?.top||0)/a,c=(p?.bottom||0)/a,m=s-(Math.max(0,r.maxX-r.minX)+l+o),h=i-(Math.max(0,r.maxY-r.minY)+d+c);return{minX:Math.min(0,m),maxX:Math.max(0,m),minY:Math.min(0,h),maxY:Math.max(0,h)}},[u,n,p]),M=t.useCallback((e,t,r,a=!1,n=j.current)=>{const s=C(r,n);if(!s)return[e,t];const{minX:i,maxX:l,minY:o,maxY:d}=s;if(a){return[Math.min(Math.max(e,i),l),Math.min(Math.max(t,o),d)]}const c=(m||0)/Math.max(.001,r);let u=e,p=t;return e<i?u=i-S(i-e,c):e>l&&(u=l+S(e-l,c)),t<o?p=o-S(o-t,c):t>d&&(p=d+S(t-d,c)),[u,p]},[C,m]),A=t.useCallback((e,t,r,a=!1,n)=>{const[s,l]=M(e,t,r,a,n);i(s),o(l),w.current={x:s,y:l}},[M]),T=t.useCallback((t,r,a)=>{if(!isFinite(t)||!isFinite(r))return;if(y())return;v();const n=g.current;n.vx=t,n.vy=r,n.lastT="undefined"!=typeof performance?performance.now():Date.now();const s=Math.max(.001,a??(N.current||e)),i=e=>{const t=n.lastT||e,r=Math.max(1,e-t);n.lastT=e;const a=Math.exp(-r/280);n.vx*=a,n.vy*=a;const l=w.current.x+n.vx*r,o=w.current.y+n.vy*r;if(A(l,o,s,!0),Math.hypot(n.vx,n.vy)<.001){v();const[e,t]=M(w.current.x,w.current.y,s,!0);return void A(e,t,s,!0)}n.raf=requestAnimationFrame(i)};n.raf=requestAnimationFrame(i)},[y,v,A,M,e]),_=t.useCallback((e,t,r,a=220)=>{if(y())return void A(e,t,r,!0);v();const n=g.current,s=w.current.x,i=w.current.y,l="undefined"!=typeof performance?performance.now():Date.now(),o=d=>{const c=Math.min(1,(d-l)/a),u=(m=c,1-Math.pow(1-m,3));var m;A(s+(e-s)*u,i+(t-i)*u,r,!0),c<1&&(n.raf=requestAnimationFrame(o))};n.raf=requestAnimationFrame(o)},[y,A,v]),P=t.useCallback((e,t)=>{e.preventDefault(),v(),k(e);const n=e.currentTarget,i=n?.getBoundingClientRect?.(),o=i?e.clientX-i.left:0,u=i?e.clientY-i.top:0,m=i?o-i.width/2:0,p=i?u-i.height/2:0,h=d,f=Math.pow(2,-e.deltaY/300),x=Math.max(r,Math.min(a,h*f)),g=Math.max(.001,t??h),b=Math.max(.001,g*(x/Math.max(.001,h))),y=m*(1/b-1/g),j=p*(1/b-1/g);c(x),A(s+y,l+j,b,!1,i)},[d,r,a,v,k,A,s,l]),I=t.useCallback(e=>{e.preventDefault(),v(),k(e),e.currentTarget?.setPointerCapture?.(e.pointerId),f.current.set(e.pointerId,{x:e.clientX,y:e.clientY});const t="undefined"!=typeof performance?performance.now():Date.now();if(b.current={x:e.clientX,y:e.clientY,t:t},1===f.current.size)h.current={x:e.clientX,y:e.clientY,panX:s,panY:l};else if(2===f.current.size){const e=Array.from(f.current.values()),t=e[1].x-e[0].x,r=e[1].y-e[0].y;x.current.initialDistance=Math.hypot(t,r),x.current.initialScale=d,x.current.lastCenter={x:(e[0].x+e[1].x)/2,y:(e[0].y+e[1].y)/2},g.current.vx=0,g.current.vy=0}},[s,l,d,v,k]),D=t.useCallback((e,t)=>{if(e.syntheticPan){v();const r=Math.max(.001,t??d),{dx:a,dy:n}=e.syntheticPan;return void A(s+a,l+n,r)}if(f.current.has(e.pointerId))if(e.preventDefault(),k(e),f.current.set(e.pointerId,{x:e.clientX,y:e.clientY}),2===f.current.size){const n=Array.from(f.current.values()),i=n[1].x-n[0].x,o=n[1].y-n[0].y,u=Math.hypot(i,o),m=u/(x.current.initialDistance||u),p=Math.max(r,Math.min(a,x.current.initialScale*m)),h=e.currentTarget,b=h?.getBoundingClientRect?.(),y=(n[0].x+n[1].x)/2,v=(n[0].y+n[1].y)/2,j=b?y-b.left:0,w=b?v-b.top:0,N=b?j-b.width/2:0,k=b?w-b.height/2:0,S=d,C=Math.max(.001,t??S),M=Math.max(.001,C*(p/Math.max(.001,S))),T=N*(1/M-1/C),_=k*(1/M-1/C);c(p),A(s+T,l+_,M,!1,b),g.current.vx=0,g.current.vy=0}else if(1===f.current.size&&h.current){const r=Math.max(.001,t??d),a="undefined"!=typeof performance?performance.now():Date.now(),n=b.current,s=Math.max(1,a-n.t),i=(e.clientX-h.current.x)/r,l=(e.clientY-h.current.y)/r,o=w.current.x,c=w.current.y;A(h.current.panX+i,h.current.panY+l,r);const u=(w.current.x-o)/s,m=(w.current.y-c)/s,p=g.current,f=.25;p.vx=(1-f)*p.vx+f*u,p.vy=(1-f)*p.vy+f*m,b.current={x:e.clientX,y:e.clientY,t:a}}},[d,r,a,v,A,k,s,l]),F=t.useCallback((e,t)=>{if(f.current.delete(e.pointerId),f.current.size<1){const e=g.current,r=Math.hypot(e.vx,e.vy),a=Math.max(.001,t??(N.current||d)),[n,s]=M(w.current.x,w.current.y,a,!0),i=(e,t)=>Math.abs(e-t)<1e-4;!i(n,w.current.x)||!i(s,w.current.y)?_(n,s,a):h.current&&r>.002?T(e.vx,e.vy,a):A(n,s,a,!0),h.current=null}f.current.size<2&&(x.current.initialDistance=0)},[T,M,A,d,_]),q=t.useCallback(()=>{v(),c(e),A(0,0,e,!0)},[e,v,A]),E=t.useCallback(e=>{const t=Math.max(r,Math.min(a,e));c(t);const{x:n,y:s}=w.current;A(n,s,t)},[r,a,A]);return{panX:s,panY:l,scale:d,setScaleAbsolute:E,handleWheel:P,handlePointerDown:I,handlePointerMove:D,handlePointerUp:F,resetView:q}}const et={review:"--color-review",placeholder:"--color-placeholder",locked:"--color-status-locked",available:"--color-status-available",eligible:"--color-status-eligible",unlocked:"--color-status-unlocked"};const tt={review:"Search",placeholder:"CircleDashed",locked:"Lock",available:"CirclePlus",eligible:"CircleCheck",unlocked:"Trophy"},rt={Lock:x,CirclePlus:f,CircleCheck:h,Trophy:p,CircleDashed:m,Search:u,Circle:c};const at=new Map;function nt(){at.clear()}function st(e,t="color"){if(at.has(`${t}:${e}`))return at.get(`${t}:${e}`);if("undefined"==typeof document)return null;const r=document.createElement("span");r.style.position="absolute",r.style.opacity="0",r.style.pointerEvents="none",r.className=e,document.body.appendChild(r);const a=getComputedStyle(r)[t];return document.body.removeChild(r),at.set(`${t}:${e}`,a),a}function it(e,t=[]){for(const r of t){const t=e.getPropertyValue(r)?.trim();if(t)return t}return null}function lt(e){return e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName}function ot(e){const t="undefined"!=typeof document?document.documentElement:null;let r=null;try{"function"==typeof getComputedStyle&&lt(e)?r=getComputedStyle(e):t&&"function"==typeof getComputedStyle&&(r=getComputedStyle(t))}catch{r=null}return{unlocked:r&&it(r,[et.unlocked])||"#22C55E",achievable:r&&it(r,["--color-success","--color-achievable"])||st("text-emerald-400")||"#20C997",available:r&&it(r,[et.available])||"#0EA5E9",eligible:r&&it(r,[et.eligible])||"#F59E0B",locked:r&&it(r,[et.locked])||"#6C757D",text:r&&it(r,["--color-text-primary","--color-foreground"])||st("text-text-primary")||st("text-slate-900")||"#111827",connection:r&&it(r,["--color-connection","--color-border-muted"])||st("text-slate-400")||"#94A3B8",border:r&&it(r,["--color-border"])||st("border-slate-500","borderTopColor")||"rgba(0,0,0,0.3)",accent:r&&it(r,["--color-primary"])||st("text-primary")||st("text-blue-500")||"#3B82F6",review:r&&it(r,[et.review])||"#8B5CF6",placeholder:r&&it(r,[et.placeholder])||"#94A3B8",surface:r&&it(r,["--color-bg-primary","--color-surface"])||"#FFFFFF"}}function dt(e){try{const t="function"==typeof getComputedStyle?getComputedStyle(lt(e)?e:document.documentElement):null,r=t?.fontFamily;return r&&r.trim().length?r:"system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"}catch{return"system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"}}function ct(e,t,r,a=3,n="…"){if(!t)return[];const s=String(t).trim().split(/\s+/),i=[];let l="";for(let o=0;o<s.length;o++){const t=l?l+" "+s[o]:s[o];if(e.measureText(t).width<=r)l=t;else{if(i.length===a-1){let t=l||s[o];for(;e.measureText(t+n).width>r&&t.length>0;)t=t.slice(0,-1);return i.push(t+n),i}l&&i.push(l),l=s[o]}}return l&&i.push(l),i.slice(0,a)}function ut(e,t,r,a,n,s,i,l=!1){if(!(n instanceof C||n&&"object"==typeof n))throw new Error("drawMedalNode requires a Medal instance or a plain medal-like object");const o=ot(e?.canvas),d="function"==typeof n?.isPlaceholder?n.isPlaceholder():"placeholder"===n?.status,u=!d&&("function"==typeof n?.isUnderReview?n.isUnderReview():"under_review"===n?.status),m=s?.status||"locked",p=o[m],h=Math.max(i,.001);e.beginPath(),e.fillStyle=o.surface,e.arc(t,r,a,0,2*Math.PI),e.fill();const f=d?o.placeholder:p,x="function"==typeof e.save;if(x&&e.save(),d&&"function"==typeof e.setLineDash){const t=Math.max(1,2*h);e.setLineDash([t,1.5*t])}e.strokeStyle=f,e.lineWidth=3,e.beginPath(),e.arc(t,r,Math.max(1,a-1.5),0,2*Math.PI),e.stroke(),d&&"function"==typeof e.setLineDash&&e.setLineDash([]),x&&"function"==typeof e.restore&&e.restore();const g=rt[tt[d?"placeholder":m]||"Circle"]||c,b=1.3*a/24;if("function"==typeof e?.save&&"function"==typeof e?.translate&&"function"==typeof e?.scale&&"function"==typeof e?.restore?(e.save(),e.translate(t,r),e.scale(b,b),e.translate(-12,-12),e.lineWidth=2,e.strokeStyle=f,e.lineCap="round",e.lineJoin="round",function(e,t){if(Array.isArray(t))for(const[r,a]of t)switch(r){case"path":{const t=a?.d;if(t&&"function"==typeof Path2D){const r=new Path2D(t);e.stroke(r)}break}case"line":{const{x1:t,y1:r,x2:n,y2:s}=a||{};[t,r,n,s].every(e=>"number"==typeof e)&&(e.beginPath(),e.moveTo(t,r),e.lineTo(n,s),e.stroke());break}case"polyline":case"polygon":{const t=(a?.points||"").trim();if(t){const a=t.split(/[\s,]+/).map(Number);if(a.length>=4){e.beginPath(),e.moveTo(a[0],a[1]);for(let t=2;t<a.length;t+=2)e.lineTo(a[t],a[t+1]);"polygon"===r&&e.closePath(),e.stroke()}}break}case"rect":{const{x:t=0,y:r=0,width:n=0,height:s=0,rx:i=0,ry:l=0}=a||{};e.beginPath(),(i||l)&&"function"==typeof e.roundRect?e.roundRect(t,r,n,s,i||l):e.rect(t,r,n,s),e.stroke();break}case"circle":{const{cx:t=0,cy:r=0,r:n=0}=a||{};e.beginPath(),e.arc(t,r,n,0,2*Math.PI),e.stroke();break}case"ellipse":{const{cx:t=0,cy:r=0,rx:n=0,ry:s=0}=a||{};"function"==typeof e.ellipse&&(e.beginPath(),e.ellipse(t,r,n,s,0,0,2*Math.PI),e.stroke());break}}}(e,g),e.restore()):(e.beginPath(),e.strokeStyle=f,e.lineWidth=Math.max(1,.15*a),e.arc(t,r,Math.max(2,.5*a),0,2*Math.PI),e.stroke()),u){const n=Math.max(3,.22*a),s=.7*a,i=.7*a;e.beginPath(),e.fillStyle=o.review,e.arc(t+s,r-i,n,0,2*Math.PI),e.fill(),e.beginPath(),e.strokeStyle=o.surface,e.lineWidth=Math.max(1,2*h),e.arc(t+s,r-i,n,0,2*Math.PI),e.stroke()}const y=("string"==typeof n?.name?n.name.trim():"")||"Medal";if((l||i>=.8)&&y){e.fillStyle=o.text,e.textAlign="center",e.textBaseline="top";const s=14,d=Math.round(1.3*s),c=dt(e.canvas);e.font=`${s}px ${c}`;const u=180,m=l||i>=1.3?3:2,p="string"==typeof n?.tierName?n.tierName.trim():"";let h;if(p){h=[(t=>{if(e.measureText(t).width<=u)return t;let r=t;for(;r.length&&e.measureText(r+"…").width>u;)r=r.slice(0,-1);return r.length?r+"…":t})(y),...ct(e,p,u,Math.max(0,m-1))]}else h=ct(e,y,u,m);const f=r+a+8,x=e.shadowColor,g=e.shadowBlur,b=e.shadowOffsetX,v=e.shadowOffsetY;e.shadowColor="rgba(0,0,0,0.2)",e.shadowBlur=2,e.shadowOffsetX=0,e.shadowOffsetY=1;for(let r=0;r<h.length;r++)e.fillText(h[r],t,f+r*d);e.shadowColor=x,e.shadowBlur=g,e.shadowOffsetX=b,e.shadowOffsetY=v}}function mt(){return{render:t.useCallback((e,t,r,a,n,s,i,l,o)=>{if(!r||!t||!a)return;const d=new Map((r.medals||[]).map(e=>[e.medalId,e]));r.connections?.forEach(t=>{const r=d.get(t.from),a=d.get(t.to);if(!r||!a)return;const l=(r.x+n)*i+e.canvas.width/2,o=(r.y+s)*i+e.canvas.height/2,c=(a.x+n)*i+e.canvas.width/2,u=(a.y+s)*i+e.canvas.height/2;!function(e,t,r,a,n,s="prerequisite",i,l){const o=ot(e?.canvas);e.strokeStyle=o.connection,e.lineWidth=2,e.beginPath(),e.moveTo(t,r),e.lineTo(a,n),e.stroke();const d=Math.atan2(n-r,a-t);e.beginPath(),e.moveTo(a,n),e.lineTo(a-10*Math.cos(d-Math.PI/6),n-10*Math.sin(d-Math.PI/6)),e.lineTo(a-10*Math.cos(d+Math.PI/6),n-10*Math.sin(d+Math.PI/6)),e.closePath(),e.fillStyle=o.connection,e.fill();const c=Math.abs(n-r)<5;if(l&&i>=.8&&!c){const s=ot(e?.canvas),i=a-t,o=n-r,d=Math.hypot(i,o)||1,c=12,u=(t+a)/2+-o/d*c,m=(r+n)/2+i/d*c,p=12,h=6,f=4,x=dt(e.canvas);e.font=`${p}px ${x}`;const g=(e.measureText(l)?.width||0)+2*h,b=p+2*f,y=u-g/2,v=m-b/2,j=6,w=e.globalAlpha;e.globalAlpha=.12,e.fillStyle=s.accent,e.beginPath(),"function"==typeof e.arcTo?(e.moveTo(y+j,v),e.arcTo(y+g,v,y+g,v+b,j),e.arcTo(y+g,v+b,y,v+b,j),e.arcTo(y,v+b,y,v,j),e.arcTo(y,v,y+g,v,j)):e.rect(y,v,g,b),e.closePath(),e.fill(),e.globalAlpha=w,e.strokeStyle=s.accent,e.lineWidth=1.5,e.beginPath(),"function"==typeof e.arcTo?(e.moveTo(y+j,v),e.arcTo(y+g,v,y+g,v+b,j),e.arcTo(y+g,v+b,y,v+b,j),e.arcTo(y,v+b,y,v,j),e.arcTo(y,v,y+g,v,j)):e.rect(y,v,g,b),e.closePath(),e.stroke(),e.fillStyle=s.text,e.textAlign="center",e.textBaseline="middle","function"==typeof e.fillText&&e.fillText(l,u,m)}}(e,l,o,c,u,t.type,i,t.label)}),Array.isArray(t)&&t.forEach(t=>{const r=d.get(t.id);if(!r)return;const c=(r.x+n)*i+e.canvas.width/2,u=(r.y+s)*i+e.canvas.height/2,m=r.radius*i,p=a.unlocked.find(e=>e.medalId===t.id)||a.eligible.find(e=>e.medalId===t.id)||a.available.find(e=>e.medalId===t.id)||{status:"locked"};if(l===t.id){const t=ot(e.canvas);e.strokeStyle=t.accent,e.lineWidth=Math.max(2,4/Math.max(i,.001)),e.beginPath(),e.arc(c,u,m+6,0,2*Math.PI),e.stroke()}const h=l===t.id||o===t.id;ut(e,c,u,m,t,p,i,h)})},[])}}function pt({status:e,className:t="w-4 h-4"}){const a=tt[e]||"Circle",n=function(e){return et[e]||null}(e);return r.jsx(Ce,{name:a,className:t,style:n?{color:`var(${n})`}:void 0,"aria-hidden":"true",focusable:"false"})}function ht({className:e="",id:t,variant:a="list"}){return r.jsxs("div",{id:t,className:["flex flex-wrap items-center gap-x-4 gap-y-2 text-xs text-muted-foreground w-full min-w-0",e].join(" "),children:[r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"review"}),r.jsx("span",{children:"Under granskning"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"placeholder"}),r.jsx("span",{children:"Platshållare"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"locked"}),r.jsx("span",{children:"Låst"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"available"}),r.jsx("span",{children:"Tillgänglig"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"eligible"}),r.jsx("span",{children:"Kvalificerad"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(pt,{status:"unlocked"}),r.jsx("span",{children:"Upplåst"})]})]})}function ft({open:e,title:a="Bekräfta",description:n="",confirmLabel:i="OK",cancelLabel:l="Avbryt",onConfirm:o,onCancel:d,variant:c="danger",id:u="confirm-dialog"}){const m=t.useRef(null),p=t.useRef(null),h=t.useRef(null),f=`${u}-title`,x=`${u}-desc`;if(t.useEffect(()=>{if(!e)return;h.current=document.activeElement;const t=p.current;if(!t)return;const r=()=>t.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),a=r()[0];a?.focus();const n=e=>{if("Escape"===e.key)e.preventDefault(),d?.();else if("Tab"===e.key){const t=r();if(0===t.length)return;const a=t[0],n=t[t.length-1];e.shiftKey&&document.activeElement===a?(e.preventDefault(),n?.focus()):e.shiftKey||document.activeElement!==n||(e.preventDefault(),a?.focus())}},s=e=>{e.target===m.current&&d?.()};document.addEventListener("keydown",n);const i=m.current;return i?.addEventListener("pointerdown",s,{capture:!0}),()=>{document.removeEventListener("keydown",n),i?.removeEventListener("pointerdown",s,{capture:!0});const e=h.current;e&&"function"==typeof e.focus&&e.focus()}},[e,d]),!e)return null;const g="danger"===c?"btn btn-danger min-h-[44px]":"btn btn-primary min-h-[44px]",b=r.jsx("div",{ref:m,className:"fixed inset-0 z-[80] bg-black/40 backdrop-blur-[1px] flex items-end sm:items-center justify-center p-3 safe-bottom",children:r.jsxs("div",{ref:p,role:"dialog","aria-modal":"true","aria-labelledby":f,"aria-describedby":x,className:"w-full sm:w-[28rem] max-w-[92vw] rounded-lg border border-border bg-background shadow-xl p-4",children:[r.jsx("h2",{id:f,className:"text-base font-semibold mb-1 text-foreground",children:a}),n?r.jsx("p",{id:x,className:"text-sm text-muted-foreground mb-4",children:n}):null,r.jsxs("div",{className:"flex flex-row-reverse flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:g,onClick:o,children:i}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:d,children:l})]})]})});return"undefined"==typeof document?b:s.createPortal(b,document.body)}const xt="timeline",gt=new Map;function bt(e){if(!e||"object"!=typeof e)throw new Error("registerLayout: def must be an object");const{id:t,generator:r}=e;if(!t||"string"!=typeof t)throw new Error("registerLayout: def.id must be a non-empty string");if("function"!=typeof r)throw new Error(`registerLayout: def.generator must be a function (id: ${t})`);if(gt.has(t))throw new Error(`registerLayout: layout id already registered: ${t}`);gt.set(t,e)}function yt(e){const t=new Map(e.map(e=>[e.id,e])),r={};e.forEach(e=>{r[e.type]||(r[e.type]=[]),r[e.type].push(e)});const a=Object.keys(r),n={medals:[],connections:[]};return a.forEach((e,a)=>{(r[e]||[]).forEach((e,r)=>{const s={medalId:e.id,type:e.type,x:200*a,y:140*r,radius:20,yearsRequired:0};n.medals.push(s);let i=0;const l=Array.isArray(e.requirements)&&e.requirements.find(e=>e&&"sustained_achievement"===e.type&&Number.isFinite(e.yearsOfAchievement))?.yearsOfAchievement||0;Array.isArray(e.prerequisites)&&e.prerequisites.forEach(r=>{if(r&&"medal"===r.type&&r.medalId){const a=t.get(r.medalId),s=a&&a.type===e.type;let o=0;Number.isFinite(r.yearOffset)&&r.yearOffset>0?o=r.yearOffset:s&&"number"==typeof l&&l>1&&(o=l),o>i&&(i=o),n.connections.push({from:r.medalId,to:e.id,type:"prerequisite"})}}),s.yearsRequired=i})}),function(e){const t=5,r=100;for(let a=0;a<t;a++)for(let t=0;t<e.medals.length;t++)for(let a=t+1;a<e.medals.length;a++){const n=e.medals[t],s=e.medals[a],i=s.x-n.x,l=s.y-n.y,o=Math.sqrt(i*i+l*l)||1,d=r/(o*o),c=i/o*d*.1,u=l/o*d*.1;n.x-=c,n.y-=u,s.x+=c,s.y+=u}return e}(n)}function vt(e){const t=Array.isArray(e?.requirements)?e.requirements:[];let r=0;for(const a of t){const e=a&&"sustained_achievement"===a.type&&Number.isFinite(a.yearsOfAchievement)?a.yearsOfAchievement:0;e>r&&(r=e)}return r}const jt={id:"timeline",label:"Tidslinje",description:"Lanes per typ. X visar minsta ackumulerade år mellan förkunskaper (yearOffset).",defaultOptions:{yearWidth:220,laneHeight:260,rowHeight:130,radius:22},generator:(e,t={})=>{const r={...jt.defaultOptions,...t||{}},a=r.yearWidth,n=r.laneHeight,s=r.rowHeight,i=r.radius,l=Array.isArray(e)?e:[],o=new Map(l.map(e=>[e.id,e])),d=new Map(l.map(e=>[e.id,vt(e)])),c=new Map,u=new Map,m=new Map,p=[],h=(e,t,r)=>(e.has(t)||e.set(t,r),e.get(t));for(const k of l)m.set(k.id,0),h(c,k.id,[]),h(u,k.id,[]);for(const k of l){const e=Array.isArray(k?.prerequisites)?k.prerequisites:[];for(const t of e){if(!t||"medal"!==t.type||!t.medalId)continue;if(!o.has(t.medalId))continue;const e=Number.isFinite(t.yearOffset)&&t.yearOffset>0?t.yearOffset:0;c.get(k.id).push({from:t.medalId,cost:e}),u.get(t.medalId).push(k.id),m.set(k.id,(m.get(k.id)||0)+1),p.push({from:t.medalId,to:k.id,type:"prerequisite",label:e>0?`${e} år`:void 0})}}const f=new Map(l.map(e=>[e.id,0])),x=new Map(l.map(e=>[e.id,0])),g=[];for(const k of l)0===(m.get(k.id)||0)&&(x.set(k.id,d.get(k.id)||0),g.push(k.id));for(;g.length;){const e=g.shift(),t=u.get(e)||[];for(const r of t){const t=(c.get(r)||[]).find(t=>t.from===e),a=t?.cost||0,n=(x.get(e)||0)+a;(f.get(r)||0)<n&&f.set(r,n),m.set(r,(m.get(r)||0)-1),0===(m.get(r)||0)&&(x.set(r,(f.get(r)||0)+(d.get(r)||0)),g.push(r))}}const b=(y=l.map(e=>e?.type||"unknown"),Array.from(new Set(y))).sort((e,t)=>String(e).localeCompare(String(t)));var y;const v=new Map(b.map((e,t)=>[e,t])),j=[],w=[],N=new Map;for(const k of l){const e=k?.type||"unknown";if(!N.has(e)){const t=k&&"string"==typeof k.typeName?k.typeName.trim():"";N.set(e,t.length?t:e)}}for(const k of b){const e=(v.get(k)||0)*n,t=N.get(k)??k;w.push({type:k,y:e,label:t});const r=l.filter(e=>(e?.type||"unknown")===k),o=new Map;for(const a of r){const e=x.get(a.id)||0;o.has(e)||o.set(e,[]),o.get(e).push(a)}const d=Array.from(o.keys()).sort((e,t)=>e-t);for(const n of d){const t=o.get(n)||[];t.sort((e,t)=>String(e.id).localeCompare(String(t.id)));for(let r=0;r<t.length;r++){const l=t[r],o=(c.get(l.id)||[]).reduce((e,t)=>Math.max(e,t.cost||0),0);j.push({medalId:l.id,type:l.type,x:n*a,y:e+r*s,radius:i,yearsRequired:o})}}}return{medals:j,connections:p,meta:{kind:"timeline",yearWidth:a,laneHeight:n,rowHeight:s,lanes:w}}}};bt({id:"columns",label:"Standard (kolumner)",description:"Grupperar märken efter typ i kolumner.",generator:e=>yt(e)}),bt(jt);const wt="skilltree:layoutPreset";function Nt(){const[e,r]=t.useState(()=>function(){if("undefined"==typeof window)return null;try{const e=window.localStorage.getItem(wt);return e&&e.length?e:null}catch{return null}}()||xt);return{presetId:e,setPresetId:t.useCallback(e=>{const t=e||xt;r(t),function(e){if("undefined"!=typeof window)try{e&&window.localStorage.setItem(wt,e)}catch{}}(t)},[])}}function kt(e){const{medalDatabase:r}=se(),a=t.useMemo(()=>{return t=e||xt,gt.has(t)?gt.get(t):gt.get(xt)||null;var t},[e]),n=t.useMemo(()=>r?.getAllMedals?.()||[],[r]);return{layout:t.useMemo(()=>a&&n&&0!==n.length?a.generator(n,a.defaultOptions):null,[a,n]),preset:a}}function St({laneLabels:e}){return e&&0!==e.length?r.jsx("div",{className:"pointer-events-none absolute inset-0",children:e.map(e=>r.jsxs("div",{role:"note","aria-label":`${e.line1} ${e.line2}`.replace("-",""),className:"absolute left-0 text-xs leading-tight font-medium text-text-primary bg-background/95 backdrop-blur-sm px-1.5 py-0.5 rounded-r border-r border-t border-b border-border/60 shadow-sm",style:{top:`${e.top}px`,transform:"translateY(-50%)",zIndex:5,maxWidth:"115px"},title:`${e.line1} ${e.line2}`.replace("-",""),children:[r.jsx("div",{className:"whitespace-nowrap",children:e.line1}),e.line2&&r.jsx("div",{className:"whitespace-nowrap",children:e.line2})]},e.id))}):null}function Ct({legendDescribedById:e}){const a=t.useRef(null),{medalDatabase:n}=se(),s=oe(),{render:o}=mt(),[d,c]=t.useState(null),[u,m]=t.useState(null),[p,h]=t.useState([]),[f,x]=t.useState([]),b=l(),y=i(),v=y.pathname.endsWith("/skill-tree/fullscreen"),j=t.useRef(null),{presetId:w,setPresetId:N}=Nt(),{layout:k}=kt(w),S=24,[C,M]=t.useState(!0),[A,T]=t.useState(C?52:0),[_,P]=t.useState({w:0,h:0}),I=t.useCallback(()=>{if(!k||!k.medals?.length)return{minX:0,minY:0,maxX:0,maxY:0};let e=1/0,t=1/0,r=-1/0,a=-1/0;for(let n=0;n<k.medals.length;n++){const s=k.medals[n],i=s.radius||20;s.x-i<e&&(e=s.x-i),s.y-i<t&&(t=s.y-i),s.x+i>r&&(r=s.x+i),s.y+i>a&&(a=s.y+i)}return{minX:e,minY:t,maxX:r,maxY:a}},[k]),D=t.useCallback((e,t=24,r=0)=>{if(!k||!e)return{baseScale:1,minX:0,minY:0};const a=e.width,n=e.height;if(!a||!n)return{baseScale:1,minX:0,minY:0};const s=k.medals||[];if(!s.length)return{baseScale:1,minX:0,minY:0};let i=1/0,l=1/0,o=-1/0,d=-1/0;for(let f=0;f<s.length;f++){const e=s[f],t=e.radius||20;e.x-t<i&&(i=e.x-t),e.y-t<l&&(l=e.y-t),e.x+t>o&&(o=e.x+t),e.y+t>d&&(d=e.y+t)}const c=Math.max(1,o-i),u=Math.max(1,d-l),m=(a-2*t)/c,p=(n-2*t-Math.max(0,r))/u,h="timeline"===k?.meta?.kind;return{baseScale:Math.max(.001,h?p:Math.min(m,p)),minX:i,minY:l}},[k]),F=1.2,q=g.useCallback(()=>"timeline"===k?.meta?.kind?{min:.2,max:1.5}:{min:.5,max:1.5},[k]),E=t.useCallback(()=>{const{min:e,max:t}=q(),r=_.w,a=_.h;if(!k||!r||!a)return{min:e,max:t};const n={width:r,height:a},{baseScale:s}=D(n,S,A),i=Math.max(.001,s),l=Math.max(.001,e/i);return{min:l,max:Math.max(l,t/i)}},[_,k,q,D,A]),{min:$,max:G}=E(),B=g.useMemo(()=>{const e="timeline"===k?.meta?.kind;return{left:(e?120:80)+S,top:(e?40:S)+A,right:104,bottom:(e?100:56)+S}},[k,A]),{panX:L,panY:Y,scale:R,setScaleAbsolute:O,handleWheel:V,handlePointerDown:U,handlePointerMove:z,handlePointerUp:K,resetView:H}=Qe(6,$,G,{getBounds:I,overscrollPx:48,contentPaddingPx:B}),[W,X]=t.useState(!1),J=t.useRef(null),Z=t.useRef(null),Q=t.useRef(!1),ee=t.useRef({x:0,y:0}),te=t.useRef(R);t.useEffect(()=>{te.current=R},[R]);const[re,ae]=t.useState(!1),[ne,le]=t.useState(!0),[de,ce]=t.useState(!1),ue=e||"skilltree-legend",me=t.useRef(null),pe=t.useRef(null),he=t.useRef(null),fe=t.useRef(null),xe=v?"fullscreen-actions-menu":"canvas-actions-menu",{currentProfile:ge,startExplorerMode:be,hydrated:ye,resetCurrentProfileData:ve}=ie(),je=Boolean(ge?.isGuest),we=!ye||void 0===ge,[Ne,ke]=t.useState(!1),[Se,Me]=t.useState(!1),[Ae,_e]=t.useState(!1),Pe=(()=>{try{return window.localStorage.getItem("app:onboardingChoice")}catch{return null}})(),Ie=v&&!we&&!ge&&!Pe&&!Ne,De=t.useCallback((e,t=24)=>{const{baseScale:r,minX:a,minY:n}=D(e,t,A),s=e?.width||0,i=e?.height||0,l=Math.max(.001,r*R),o=("timeline"===k?.meta?.kind?120:80)/l,d=Math.max(0,A)/l;return{effScale:l,effPanX:L+((t-s/2)/l-(a-o)),effPanY:Y+((t-i/2)/l-(n-d)),baseScale:r}},[D,L,Y,R,A,k]),Fe=t.useCallback((e,t=120)=>{if(!k||!e)return[];const r=e.width,a=e.height,n=k.medals||[],{effScale:s,effPanX:i,effPanY:l}=De(e),o=[];for(let d=0;d<n.length;d++){const e=n[d],c=(e.x+i)*s+r/2,u=(e.y+l)*s+a/2,m=(e.radius||20)*s;c+m>=-t&&c-m<=r+t&&u+m>=-t&&u-m<=a+t&&o.push(e)}return o},[k,De]),qe=t.useCallback(e=>{if(!e||!k)return[];if(!ne)return[];if("timeline"===k?.meta?.kind)return[];const{effScale:t,effPanX:r,effPanY:a}=De(e),n=e.width,i=e.height,l=Fe(e),o=[],c=e=>u===e||d===e||t>=.8,m=new Map;for(const s of k.medals||[])m.set(s.medalId,s);const p=Math.max(16,12),h=e=>({x:(e.x+r)*t+n/2,y:(e.y+a)*t+i/2,r:(e.radius||20)*t});for(const d of l){const e=d.yearsRequired||0;if(!e||!c(d.medalId))continue;const t=h(d);let r=t.x,a=t.y-(t.r+8+10);const n=(k.connections||[]).find(e=>e.to===d.medalId);if(n){const e=m.get(n.from);if(e){const n=h(e),s=t.x-n.x,i=t.y-n.y,l=Math.hypot(s,i)||1,o=-(i/l),d=s/l,c=r-n.x,u=a-n.y,m=Math.hypot(c,u)||1,p=n.r+Math.max(56,20)/2+6;if(m<p){const e=p-m;r+=o*e,a+=d*e}}}const i=r-t.x,l=a-t.y,u=Math.hypot(i,l)||1,f=t.r+p;if(u<f){const e=i/u,n=l/u;r=t.x+e*f,a=t.y+n*f}const x=s?.[d.medalId]?.status,g="achievable"===x||"unlocked"===x?"ready":"neutral",b=`${e} år`;o.push({id:d.medalId,left:r,top:a,text:b,variant:g,w:56,h:20})}return o},[k,De,Fe,u,d,s,ne]),Ee=t.useCallback(e=>{if(!e||!k)return[];if("timeline"!==k?.meta?.kind)return[];const{effScale:t,effPanY:r}=De(e),a=e.height,n=Array.isArray(k.meta.lanes)?k.meta.lanes:[],s=[];for(const i of n){const e=(i.y+r)*t+a/2;if(e<-50||e>a+50)continue;const n=String(i.label||i.type||"");let l=n,o="";const d=n.toLowerCase().lastIndexOf("märket");d>0&&(l=n.substring(0,d).trim()+"-",o=n.substring(d).trim()),s.push({id:i.type||`lane-${s.length}`,line1:l,line2:o,top:e})}return s},[k,De]),$e=t.useCallback(()=>{if(!a.current||!k||!n)return;const e=a.current,t=e.getContext("2d"),r=e.getBoundingClientRect();e.width===Math.floor(r.width)&&e.height===Math.floor(r.height)||(e.width=Math.floor(r.width),e.height=Math.floor(r.height),P({w:e.width,h:e.height}));const i=getComputedStyle(e).backgroundColor||"#fcfcf9";t.fillStyle=i,t.fillRect(0,0,e.width,e.height);const l=n.getAllMedals(),c=Fe(e),m=new Set(c.map(e=>e.medalId)),p=l.filter(e=>m.has(e.id)),{effScale:h,effPanX:f,effPanY:x}=De(e);if("timeline"===k?.meta?.kind){const r=ot(e)||{},a=e.width,n=e.height,s=-a/2/h-f,i=a/2/h-f,l=Number(k.meta.yearWidth)||220,o=Math.floor(s/l),d=Math.ceil(i/l),c=r.connection||"rgba(0,0,0,0.3)",u=r.text||"#111827",m=C?A+6:12;t.save(),t.lineWidth=1,t.strokeStyle=c,t.globalAlpha=.25;for(let e=Math.max(0,o);e<=d;e++){const r=(e*l+f)*h+a/2;t.beginPath(),t.moveTo(r,0),t.lineTo(r,n),t.stroke(),t.globalAlpha=.8,t.fillStyle=u,t.textAlign="center",t.textBaseline="top",t.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif",t.fillText(`${e} år`,r,m),t.globalAlpha=.25}t.restore()}o(t,p,k,s,f,x,h,d,u)},[Fe,De,k,n,s,d,o,u,A,C]),Ge=t.useCallback(()=>{const e=a.current;if(!e||!k)return;const{baseScale:t}=D(e,S,A),{min:r,max:n}=q(),s="timeline"===k?.meta?.kind?.9:.8,i=Math.min(n,Math.max(r,s))/Math.max(.001,t);H(),O(i)},[D,k,H,O,A,q]),Be=(e,t,r)=>Math.min(r,Math.max(t,e)),Le=t.useCallback(()=>{O(Be(te.current*F,$,G))},[O,$,G,F]),Ye=t.useCallback(()=>{O(Be(te.current/F,$,G))},[O,$,G,F]),Re=t.useCallback(()=>{M(e=>{const t=!e;return t||T(0),t})},[T,M]),Oe=t.useCallback(()=>{const e=y.state?.backgroundLocation;if(e&&"object"==typeof e){const t={pathname:e.pathname,search:e.search,hash:e.hash};return void b(t,{replace:!0,state:{...e.state||{},fromFullscreenClose:!0}})}if("string"==typeof e)return void b(e,{replace:!0,state:{fromFullscreenClose:!0}});const t=y.pathname.replace(/\/fullscreen$/,"");b(t||"/skill-tree",{replace:!0,state:{fromFullscreenClose:!0}})},[y,b]),Ve=t.useCallback(e=>{a.current=e},[]);t.useLayoutEffect(()=>{if(!C)return;const e=v?fe.current:he.current;if(!e)return;let t=requestAnimationFrame(()=>{const t=e.getBoundingClientRect();T(Math.max(0,Math.ceil(t.height)))});return()=>cancelAnimationFrame(t)},[C,v]),t.useEffect(()=>{let e=requestAnimationFrame($e);return()=>cancelAnimationFrame(e)},[$e]),t.useLayoutEffect(()=>{const e=a.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),n=Math.floor(t.height);r>0&&n>0&&(e.width!==r||e.height!==n)&&(e.width=r,e.height=n,P({w:r,h:n})),h(qe(e)),x(Ee(e))},[qe,Ee,L,Y,R,u,d,k]),t.useEffect(()=>{Q.current||a.current&&k&&(Q.current=!0,Ge())},[k,Ge]),t.useEffect(()=>{const e=()=>{const e=a.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),n=Math.floor(t.height);if(r>0&&n>0&&(e.width!==r||e.height!==n)&&(e.width=r,e.height=n,P({w:r,h:n})),$e(),h(qe(e)),x(Ee(e)),C){const e=v?fe.current:he.current;if(e){const t=e.getBoundingClientRect();T(Math.max(0,Math.ceil(t.height)))}}};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[$e,qe,Ee,v,C]),t.useEffect(()=>{const e=a.current;if(!e)return;const t=t=>{const{effScale:r}=De(e);V(t,r)};return e.addEventListener("wheel",t,{passive:!1}),()=>{e.removeEventListener("wheel",t,{passive:!1})}},[De,V,v]),t.useEffect(()=>{if(!v)return;Z.current=document.activeElement;const e=document.documentElement,t=e.style.overflow;e.style.overflow="hidden",me.current?.focus?.();const r=e=>{if("Escape"!==e.key)return;if(re||de)return;const t=document.activeElement;j.current&&j.current.contains(t)&&Oe()};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r),e.style.overflow=t;const a=Z.current;a&&"function"==typeof a.focus&&a.focus()}},[v,re,de,Oe]),t.useEffect(()=>{if(!re)return;const e=e=>{const t=pe.current,r=me.current;t&&r&&(t.contains(e.target)||r.contains(e.target)||ae(!1))};return window.addEventListener("pointerdown",e,{capture:!0}),()=>window.removeEventListener("pointerdown",e,{capture:!0})},[re]),t.useEffect(()=>{a.current&&requestAnimationFrame(()=>{$e()})},[v,$e]),t.useEffect(()=>{const e=()=>{requestAnimationFrame(()=>{nt();const e=a.current;e&&($e(),h(qe(e)),x(Ee(e)))})},t="undefined"!=typeof window&&window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)"):null;t&&"function"==typeof t.addEventListener&&t.addEventListener("change",e);const r=new MutationObserver(t=>{for(const r of t)if("attributes"===r.type&&"class"===r.attributeName){e();break}});return"undefined"!=typeof document&&document.documentElement&&r.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>{t&&"function"==typeof t.removeEventListener&&t.removeEventListener("change",e),r.disconnect()}},[$e,qe,Ee]),t.useEffect(()=>{const e=()=>{requestAnimationFrame(()=>{const e=a.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),n=Math.floor(t.height);r>0&&n>0&&(e.width!==r||e.height!==n)&&(e.width=r,e.height=n,P({w:r,h:n})),nt(),$e(),h(qe(e)),x(Ee(e))})},t=t=>{e()},r=()=>{"undefined"!=typeof document&&"visible"===document.visibilityState&&e()},n=()=>{e()};return window.addEventListener("pageshow",t),document.addEventListener("visibilitychange",r),window.addEventListener("orientationchange",n),()=>{window.removeEventListener("pageshow",t),document.removeEventListener("visibilitychange",r),window.removeEventListener("orientationchange",n)}},[$e,qe,Ee]);const Ue=t.useCallback(e=>{const{effScale:t}=De(a.current),r=50/Math.max(t,.001);["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","+","=","-","0"].includes(e.key)&&e.preventDefault(),"ArrowLeft"===e.key?z({syntheticPan:{dx:-r,dy:0}},t):"ArrowRight"===e.key?z({syntheticPan:{dx:r,dy:0}},t):"ArrowUp"===e.key?z({syntheticPan:{dx:0,dy:-r}},t):"ArrowDown"===e.key?z({syntheticPan:{dx:0,dy:r}},t):"+"===e.key||"="===e.key?Le():"-"===e.key?Ye():"0"===e.key&&Ge()},[De,z,Ge,Le,Ye]),ze=e=>{X(!0);const t=a.current?.getBoundingClientRect();t&&(ee.current={x:e.clientX-t.left,y:e.clientY-t.top}),U(e)},Ke=e=>{if(W){const{effScale:t}=De(a.current);return z(e,t),void(a.current&&(a.current.style.cursor="grabbing"))}if(!a.current||!k)return;const t=a.current.getBoundingClientRect(),r=e.clientX-t.left,n=e.clientY-t.top,{effScale:s,effPanX:i,effPanY:l}=De(a.current),o=Fe(a.current);for(const d of o){const e=(d.x+i)*s+a.current.width/2,t=(d.y+l)*s+a.current.height/2,o=(d.radius||20)*s,c=Math.max(o,24),u=r-e,p=n-t;if(u*u+p*p<c*c)return m(d.medalId),void(a.current.style.cursor="pointer")}m(null),a.current.style.cursor="grab"},He=e=>{X(!1);const t=a.current,{effScale:r}=t?De(t):{effScale:te.current};K(e,r),m(null)},We=e=>{if(!a.current||!k)return;const t=a.current.getBoundingClientRect(),r=e.clientX-t.left,n=e.clientY-t.top,s=r-ee.current.x,i=n-ee.current.y;if(Math.sqrt(s*s+i*i)>5)return;const{effScale:l,effPanX:o,effPanY:d}=De(a.current),u=Fe(a.current);for(const m of u){const e=(m.x+o)*l+a.current.width/2,t=(m.y+d)*l+a.current.height/2,s=(m.radius||20)*l,i=Math.max(s,24),u=r-e,p=n-t;if(u*u+p*p<i*i)return c(m.medalId),void b(`/medals/${m.medalId}`,{state:{backgroundLocation:y}})}c(null)},Xe=e=>{if(!a.current||!k)return;const t=a.current.getBoundingClientRect(),r=e.clientX-t.left,n=e.clientY-t.top,s=r-ee.current.x,i=n-ee.current.y;if(Math.sqrt(s*s+i*i)>5)return;const{effScale:l,effPanX:o,effPanY:d}=De(a.current),u=Fe(a.current);for(const m of u){const e=(m.x+o)*l+a.current.width/2,t=(m.y+d)*l+a.current.height/2,s=(m.radius||20)*l,i=Math.max(s,24),u=r-e,p=n-t;if(u*u+p*p<i*i)return window.dispatchEvent(new CustomEvent("openAchievementForm",{detail:{medalId:m.medalId}})),c(m.medalId),void b(`/medals/${m.medalId}`,{state:{backgroundLocation:y}})}},Je=()=>{a.current&&function(e,t="skill-tree.png"){try{const r=document.createElement("a");r.href=e.toDataURL("image/png"),r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r)}catch(r){window.open(e.toDataURL("image/png"),"_blank")}}(a.current,`skill-tree-${(new Date).toISOString().split("T")[0]}.png`)};return n?r.jsxs("div",{className:"space-y-4",children:[r.jsx("div",{className:"card overflow-hidden overscroll-contain mt-2",role:"region","aria-label":"Trädvy canvas","aria-describedby":["skilltree-help",ue].filter(Boolean).join(" "),children:!v&&r.jsxs("div",{className:"relative",children:[r.jsx("canvas",{ref:Ve,"data-tour":"tree-canvas",role:"img","aria-label":"Interaktiv träd-vy-canvas","aria-describedby":["skilltree-help",C?ue:null,e].filter(Boolean).join(" "),"aria-keyshortcuts":"ArrowLeft ArrowRight ArrowUp ArrowDown = + - 0",tabIndex:0,onKeyDown:Ue,className:"w-full h-[60vh] sm:h-[600px] bg-background cursor-grab active:cursor-grabbing touch-none overscroll-contain select-none",onContextMenu:e=>e.preventDefault(),onPointerDown:ze,onPointerMove:Ke,onPointerUp:He,onPointerLeave:He,onPointerCancel:He,onClick:We,onDoubleClick:Xe}),r.jsx("div",{className:"pointer-events-none absolute inset-0",children:p.map(e=>r.jsxs(g.Fragment,{children:[r.jsx("span",{"aria-hidden":"true",style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,borderRadius:"9999px",background:"var(--color-background, #fff)",boxShadow:"0 0 0 3px var(--color-background, #fff)",zIndex:0}}),r.jsx("span",{role:"note","aria-label":`Kräver ${e.text}`,title:`Kräver ${e.text}`,className:["inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium shadow-sm","ready"===e.variant?"bg-primary text-white border-primary":"bg-primary/10 dark:bg-primary/20 text-foreground border-primary"].join(" "),style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,whiteSpace:"nowrap",zIndex:1},children:r.jsx("span",{"aria-hidden":"true",children:e.text})})]},e.id))}),r.jsx(St,{laneLabels:f}),C&&r.jsx("div",{ref:he,"data-tour":"tree-legend",className:"absolute left-3 right-3 top-3 sm:left-4 sm:right-auto sm:top-4 z-[40] overflow-x-auto whitespace-nowrap rounded-md border border-border/60 bg-background/80 backdrop-blur-sm shadow-md px-3 py-1.5",style:{marginTop:"env(safe-area-inset-top)"},role:"note",id:ue,children:r.jsx(ht,{variant:"canvas"})}),r.jsx("div",{className:"absolute right-3 bottom-3 sm:right-4 sm:bottom-4 z-30",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"relative",children:[r.jsx("button",{type:"button",ref:me,"data-tour":"tree-actions","aria-haspopup":"menu","aria-controls":xe,"aria-expanded":re,onClick:()=>ae(e=>!e),className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Visa åtgärder","aria-label":"Visa åtgärder",children:r.jsx(Ce,{name:"MoreVertical",className:"w-6 h-6"})}),re&&r.jsxs("div",{id:xe,ref:pe,role:"menu","aria-label":"Åtgärder",className:"absolute right-0 bottom-14 sm:bottom-16 w-56 rounded-md border border-border bg-background shadow-xl overflow-hidden",onKeyDown:e=>{if("Escape"===e.key)e.preventDefault(),ae(!1),me.current?.focus();else if("ArrowDown"===e.key||"ArrowUp"===e.key){const t=Array.from(e.currentTarget.querySelectorAll('[role="menuitem"]'));if(0===t.length)return;const r=t.indexOf(document.activeElement);let a=0;"ArrowDown"===e.key&&(a=r>=0?(r+1)%t.length:0),"ArrowUp"===e.key&&(a=r>=0?(r-1+t.length)%t.length:t.length-1),e.preventDefault(),t[a]?.focus()}},children:[r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),Ge()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Återställ vy"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),Je()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Exportera som PNG"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),Re()},"aria-pressed":C,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:C?"Dölj teckenförklaring":"Visa teckenförklaring"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),le(e=>!e)},"aria-pressed":ne,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:ne?"Dölj årsbrickor":"Visa årsbrickor"}),r.jsxs("div",{role:"group","aria-label":"Visualisering",className:"border-t border-border/60",children:[r.jsx("button",{role:"menuitemradio","aria-checked":"columns"===w,type:"button",onClick:()=>{ae(!1),N("columns"),Ge()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Standard (kolumner)"}),r.jsx("button",{role:"menuitemradio","aria-checked":"timeline"===w,type:"button",onClick:()=>{ae(!1),N("timeline"),Ge()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Tidslinje"})]}),(!ge||je)&&r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),Me(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Spara"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),ce(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visa hjälp"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),b("/skill-tree/fullscreen",{replace:!0,state:{backgroundLocation:y}})},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","aria-haspopup":"dialog","aria-controls":"skilltree-fullscreen",children:"Öppna helskärm"})]})]})}),r.jsx("div",{className:"absolute left-3 bottom-3 sm:left-4 sm:bottom-4 z-30",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"inline-flex flex-col gap-2","data-tour":"zoom-controls",children:[r.jsx("button",{type:"button","aria-label":"Zooma in",onClick:Le,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma in",children:r.jsx(Ce,{name:"Plus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Zooma ut",onClick:Ye,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma ut",children:r.jsx(Ce,{name:"Minus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Återställ vy",onClick:Ge,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Återställ vy",children:r.jsx(Ce,{name:"RotateCcw",className:"w-6 h-6"})})]})}),r.jsx("p",{id:"skilltree-help",className:"sr-only",children:"💡 Dra för att panorera • Nyp för att zooma • Klicka på märken för detaljer"}),de&&r.jsx("div",{role:"dialog","aria-modal":"false","aria-labelledby":"skilltree-help-title",className:"absolute left-1/2 bottom-24 -translate-x-1/2 w-[min(92vw,28rem)] rounded-md border border-border bg-background text-foreground shadow-xl p-4 z-30",children:r.jsxs("div",{className:"flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsx("h3",{id:"skilltree-help-title",className:"text-sm font-semibold mb-1",children:"Hjälp"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Dra för att panorera • Nyp eller använd +/− för att zooma • 0 återställer vy • Klicka för detaljer"})]}),r.jsx("button",{type:"button","aria-label":"Stäng hjälp",className:"btn btn-muted min-h-[44px] px-3 py-2",onClick:()=>ce(!1),children:"Stäng"})]})})]})}),v&&r.jsxs("div",{id:"skilltree-fullscreen",ref:j,className:"fixed inset-0 z-50 bg-background overscroll-contain flex flex-col",role:"dialog","aria-modal":"true","aria-label":"Helskärms träd-vy",children:[r.jsx("h2",{className:"sr-only",children:"Märken"}),r.jsx("div",{className:"absolute right-3 bottom-3 sm:right-4 sm:bottom-4 z-[60]",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"relative",children:[r.jsx("button",{type:"button",ref:me,"data-tour":"tree-actions","aria-haspopup":"menu","aria-controls":xe,"aria-expanded":re,onClick:()=>ae(e=>!e),className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Visa åtgärder","aria-label":"Visa åtgärder",children:r.jsx(Ce,{name:"MoreVertical",className:"w-6 h-6"})}),re&&r.jsxs("div",{id:xe,ref:pe,role:"menu","aria-label":"Åtgärder",className:"absolute right-0 bottom-14 sm:bottom-16 w-56 rounded-md border border-border bg-background shadow-xl overflow-hidden",onKeyDown:e=>{if("Escape"===e.key)e.preventDefault(),ae(!1),me.current?.focus();else if("ArrowDown"===e.key||"ArrowUp"===e.key){const t=Array.from(e.currentTarget.querySelectorAll('[role="menuitem"]'));if(0===t.length)return;const r=t.indexOf(document.activeElement);let a=0;"ArrowDown"===e.key&&(a=r>=0?(r+1)%t.length:0),"ArrowUp"===e.key&&(a=r>=0?(r-1+t.length)%t.length:t.length-1),e.preventDefault(),t[a]?.focus()}},children:[r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),Ge()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Återställ vy"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),Je()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Exportera som PNG"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),Re()},"aria-pressed":C,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:C?"Dölj teckenförklaring":"Visa teckenförklaring"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),le(e=>!e)},"aria-pressed":ne,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:ne?"Dölj årsbrickor":"Visa årsbrickor"}),r.jsxs("div",{role:"group","aria-label":"Visualisering",className:"border-t border-border/60",children:[r.jsx("button",{role:"menuitemradio","aria-checked":"columns"===w,type:"button",onClick:()=>{ae(!1),N("columns"),Ge()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Standard (kolumner)"}),r.jsx("button",{role:"menuitemradio","aria-checked":"timeline"===w,type:"button",onClick:()=>{ae(!1),N("timeline"),Ge()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Tidslinje"})]}),(!ge||je)&&r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),Me(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Spara framsteg"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{ae(!1),ce(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visa hjälp"}),r.jsx("button",{role:"menuitem",type:"button",ref:J,onClick:()=>{ae(!1),Oe()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Stäng helskärm"})]})]})}),r.jsx("div",{className:"absolute left-3 bottom-3 sm:left-4 sm:bottom-4 z-[60]",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"inline-flex flex-col gap-2","data-tour":"zoom-controls",children:[r.jsx("button",{type:"button","aria-label":"Zooma in",onClick:Le,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma in",children:r.jsx(Ce,{name:"Plus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Zooma ut",onClick:Ye,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma ut",children:r.jsx(Ce,{name:"Minus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Återställ vy",onClick:Ge,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Återställ vy",children:r.jsx(Ce,{name:"RotateCcw",className:"w-6 h-6"})})]})}),Ie&&r.jsx("div",{role:"region","aria-label":"Onboarding",className:"absolute left-3 right-3 z-[50]",style:{marginTop:"env(safe-area-inset-top)",top:Math.max(12,A+12)},children:r.jsxs("div",{className:"rounded-md border border-border bg-background/80 backdrop-blur-sm shadow-md p-3",children:[r.jsx("p",{className:"text-sm text-foreground mb-2",children:"Spara dina framsteg?"}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:()=>{try{window.localStorage.setItem("app:onboardingChoice","saved")}catch{}ke(!0),Me(!0)},children:"Skapa profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>{try{window.localStorage.setItem("app:onboardingChoice","guest")}catch{}ke(!0),be()},children:"Fortsätt som gäst"}),r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:()=>ke(!0),children:"Inte nu"})]})]})}),v&&je&&!Ie&&r.jsxs("div",{className:"absolute left-1/2 -translate-x-1/2 z-[60] flex items-center gap-2",style:{bottom:"calc(env(safe-area-inset-bottom) + 16px)"},role:"group","aria-label":"Snabbåtgärder (gäst)",children:[r.jsx("button",{type:"button",onClick:()=>_e(!0),className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 backdrop-blur-sm px-3 py-1.5 text-sm shadow-md min-h-[36px]","aria-label":"Återställ alla",title:"Återställ alla",children:"Återställ alla"}),r.jsx("button",{type:"button",onClick:()=>Me(!0),className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 backdrop-blur-sm px-3 py-1.5 text-sm shadow-md min-h-[36px]","aria-label":"Spara framsteg",title:"Spara framsteg",children:"Spara framsteg"})]}),r.jsx("div",{className:"flex-1",children:r.jsxs("div",{className:"relative h-full",children:[r.jsx("canvas",{ref:Ve,"data-tour":"tree-canvas",role:"img","aria-label":"Interaktiv träd-vy-canvas","aria-describedby":["skilltree-help-fs",C?"skilltree-legend-fs":null,e].filter(Boolean).join(" "),"aria-keyshortcuts":"ArrowLeft ArrowRight ArrowUp ArrowDown = + - 0",tabIndex:0,onKeyDown:Ue,className:"w-full h-full bg-background cursor-grab active:cursor-grabbing touch-none overscroll-contain select-none",onContextMenu:e=>e.preventDefault(),onPointerDown:ze,onPointerMove:Ke,onPointerUp:He,onPointerLeave:He,onPointerCancel:He,onClick:We,onDoubleClick:Xe}),C&&r.jsx("div",{ref:fe,"data-tour":"tree-legend",className:"absolute left-3 right-3 top-3 sm:left-4 sm:right-auto sm:top-4 z-[40] overflow-x-auto whitespace-nowrap rounded-md border border-border/60 bg-background/80 backdrop-blur-sm shadow-md px-3 py-1.5",style:{marginTop:"env(safe-area-inset-top)"},role:"note",id:"skilltree-legend-fs",children:r.jsx(ht,{variant:"canvas"})}),r.jsx("div",{className:"pointer-events-none absolute inset-0",children:p.map(e=>r.jsxs(g.Fragment,{children:[r.jsx("span",{"aria-hidden":"true",style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,borderRadius:"9999px",background:"var(--color-background, #fff)",boxShadow:"0 0 0 3px var(--color-background, #fff)",zIndex:0}}),r.jsx("span",{role:"note","aria-label":`Kräver ${e.text}`,title:`Kräver ${e.text}`,className:["inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium shadow-sm","ready"===e.variant?"bg-primary text-white border-primary":"bg-primary/10 dark:bg-primary/20 text-foreground border-primary"].join(" "),style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,whiteSpace:"nowrap",zIndex:1},children:r.jsx("span",{"aria-hidden":"true",children:e.text})})]},e.id))}),r.jsx(St,{laneLabels:f})]})}),r.jsx("p",{id:"skilltree-help-fs",className:"sr-only",children:"💡 Dra för att panorera • Nyp för att zooma • Klicka på märken för detaljer"}),de&&r.jsx("div",{role:"dialog","aria-modal":"false","aria-labelledby":"skilltree-help-title-fs",className:"absolute left-1/2 bottom-24 -translate-x-1/2 w-[min(92vw,28rem)] rounded-md border border-border bg-background text-foreground shadow-xl p-4 z-[70]",children:r.jsxs("div",{className:"flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsx("h3",{id:"skilltree-help-title-fs",className:"text-sm font-semibold mb-1",children:"Hjälp"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Dra för att panorera • Nyp för att zooma • Klicka för detaljer"})]}),r.jsx("button",{type:"button","aria-label":"Stäng hjälp",className:"btn btn-muted min-h-[44px] px-3 py-2",onClick:()=>ce(!1),children:"Stäng"})]})})]}),r.jsx(ft,{id:"reset-confirm-skilltree",open:Ae,onCancel:()=>_e(!1),onConfirm:async()=>{_e(!1),await ve()},title:"Återställa allt?",description:"Detta rensar alla tillfälliga framsteg (märken och förkunskaper) i gästläget. Denna åtgärd går inte att ångra.",confirmLabel:"Återställ",cancelLabel:"Avbryt",variant:"danger"}),r.jsx(Te,{id:"save-progress-picker-canvas",mode:"picker",open:Se,onClose:()=>Me(!1),forceCreate:!0,convertGuest:!0})]}):r.jsx("div",{className:"flex items-center justify-center h-96",role:"status","aria-live":"polite","aria-busy":"true",children:r.jsx("p",{className:"text-text-secondary",children:"Laddar märken..."})})}function Mt(e,t){try{return window.localStorage.setItem(e,t),!0}catch{return!1}}function At({idPrefix:e="default"}){const{resetCurrentProfileData:a}=ie(),[n,s]=t.useState(!1),[i,l]=t.useState(!1);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"card p-4",role:"status","aria-live":"polite",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(Ce,{name:"Compass",className:"w-6 h-6 shrink-0"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"mb-2 text-muted-foreground",children:"Gästläge: framsteg sparas tillfälligt."}),r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{type:"button",className:"btn btn-primary",onClick:()=>s(!0),children:[r.jsx(Ce,{name:"Save",className:"w-4 h-4"}),"Spara"]}),r.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>l(!0),children:[r.jsx(Ce,{name:"RotateCcw",className:"w-4 h-4"}),"Återställ"]})]})]})]})}),r.jsx(ft,{id:`reset-confirm-${e}`,open:i,onCancel:()=>l(!1),onConfirm:async()=>{l(!1),await a()},title:"Återställa allt?",description:"Detta rensar alla tillfälliga framsteg (märken och förkunskaper) i gästläget. Denna åtgärd går inte att ångra.",confirmLabel:"Återställ",cancelLabel:"Avbryt",variant:"danger"}),r.jsx(Te,{id:`save-progress-picker-${e}`,mode:"picker",open:n,onClose:()=>s(!1),forceCreate:!0,convertGuest:!0})]})}function Tt({id:e="profile-picker-inline"}){const{currentProfile:a}=ie(),[n,s]=t.useState(!1);return a?null:r.jsxs("div",{className:"card p-4",role:"region","aria-label":"Profil krävs",children:[r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("div",{"aria-hidden":"true",className:"text-xl leading-none",children:"👤"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"text-foreground mb-2",children:"Välj eller skapa en profil."}),r.jsx("button",{type:"button",onClick:()=>s(!0),className:"btn btn-primary min-h-[44px]","aria-haspopup":"dialog","aria-controls":e,children:"Profil"})]})]}),r.jsx(Te,{id:e,mode:"picker",open:n,onClose:()=>s(!1)})]})}function _t({idPrefix:e="default",onChooseGuest:t,onChooseSaved:a}){const n=`onboarding-title-${e}`;return r.jsxs("div",{className:"card p-4",role:"dialog","aria-modal":"true","aria-labelledby":n,children:[r.jsx("h2",{id:n,className:"section-title mb-2",children:"Hur vill du börja?"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Utforska märken direkt eller skapa en profil för att spara ditt arbete."}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsxs("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:t,children:[r.jsx(Ce,{name:"Compass",className:"w-4 h-4"}),"Utforska utan att spara (Gästläge)"]}),r.jsxs("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:a,children:[r.jsx(Ce,{name:"UserPlus",className:"w-4 h-4"}),"Skapa profil"]})]})]})}function Pt({idPrefix:e="default",promptId:a}){const{isProfileLoading:n,showOnboarding:s,isGuest:i,chooseGuest:l,chooseSaved:o}=function(){const{currentProfile:e,startExplorerMode:r,hydrated:a}=ie(),[n,s]=t.useState(!1),i=t.useMemo(()=>{if("undefined"==typeof window)return null;try{return window.localStorage.getItem("app:onboardingChoice")}catch{return null}},[]),l=!a||void 0===e;return{isProfileLoading:l,showOnboarding:!(l||e||i||n),isGuest:Boolean(e?.isGuest),chooseGuest:t.useCallback(()=>{Mt("app:onboardingChoice","guest"),r()},[r]),chooseSaved:t.useCallback(()=>{Mt("app:onboardingChoice","saved"),s(!0)},[])}}();if(n)return null;if(s)return r.jsx(_t,{idPrefix:e,onChooseGuest:l,onChooseSaved:o});if(i)return r.jsx(At,{idPrefix:e});const d=a||`profile-picker-${e}`;return r.jsx(Tt,{id:d})}const It={open:!1,stepIndex:0,steps:[],start:()=>{},close:()=>{},complete:()=>{},next:()=>{},back:()=>{},canAutoStart:()=>!1,tourId:"",currentTourType:"medals"};function Dt(){const e=t.useContext(xe);if(!e){if("undefined"!=typeof process&&!0)return It;throw new Error("useOnboardingTour must be used within OnboardingTourProvider")}return e}const Ft="whatsnew:lastSeen";function qt(){return ge?.version}function Et(){try{return localStorage.getItem(Ft)}catch{return null}}function $t(){if(ge?.env)return"production"===ge.env;try{const e="undefined"!=typeof window&&window.location&&window.location.hostname?window.location.hostname:"";return!!e&&!("localhost"===e||"127.0.0.1"===e)}catch{return!1}}function Gt(){const{currentProfile:e,hydrated:a}=ie(),n=!a||void 0===e,s=l(),o=i(),d=Dt();t.useEffect(()=>{if("undefined"==typeof window)return;const e=window.innerWidth<768,t="/skill-tree"===o.pathname,r=Boolean(o.state?.fromFullscreenClose);e&&t&&!r&&s("/skill-tree/fullscreen",{replace:!0,state:{backgroundLocation:o}})},[s,o]);const c=t.useCallback(()=>{d?.open||d.start("tree-view")},[d]);return t.useEffect(()=>{if(n)return;if(!("/skill-tree"===o.pathname||"/skill-tree/fullscreen"===o.pathname))return;if(d?.open)return;let e=null;try{e=sessionStorage.getItem(ye)}catch{e=null}if("tree-view"!==e)return;try{sessionStorage.removeItem(ye)}catch{}const t=setTimeout(()=>{c()},100);return()=>clearTimeout(t)},[n,o.pathname,d,c]),t.useEffect(()=>{if(n)return;if(!("/skill-tree"===o.pathname||"/skill-tree/fullscreen"===o.pathname))return;if(d?.open)return;try{if("tree-view"===sessionStorage.getItem(ye))return}catch{}if(!d?.canAutoStart?.("tree-view"))return;if($t()){const e=qt();if(Et()!==e)return}const e=setTimeout(()=>{c()},100);return()=>clearTimeout(e)},[n,o.pathname,d,c]),n?null:r.jsxs("div",{className:"space-y-6",children:[r.jsx(Pt,{idPrefix:"skilltree",promptId:"profile-picker-skill-tree"}),r.jsx("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:r.jsxs("div",{className:"flex items-baseline gap-3 flex-wrap",children:[r.jsx("h1",{className:"text-3xl font-bold text-text-primary mb-1 sm:mb-0",children:"Trädvy"}),r.jsx("button",{type:"button",onClick:c,className:"text-sm underline hover:no-underline text-muted-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded",children:"Visa guide"})]})}),r.jsx(Ct,{})]})}const Bt="medal-app-current-filters";function Lt(e){return(e||"").toString().toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g,"")}function Yt(e,t){return t?t.unlocked?.some(t=>t.medalId===e)?"unlocked":t.eligible?.some(t=>t.medalId===e)?"eligible":t.available?.some(t=>t.medalId===e)?"available":"locked":"locked"}function Rt({value:e,onChange:a,suggestions:n,onSuggestionSelect:s,placeholder:i="Search medals…",inputRef:l}){const[o,d]=t.useState(!1);return r.jsxs("div",{className:"relative",children:[r.jsxs("div",{className:"relative",children:[r.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground","aria-hidden":!0,children:"🔍"}),r.jsx("input",{type:"text",ref:l,value:e,onChange:e=>a?.(e.target.value),onFocus:()=>{(n||[]).length>0&&d(!0)},onBlur:()=>setTimeout(()=>d(!1),100),placeholder:i,className:"input pl-8 pr-12 min-h-[44px]","aria-label":"Search medals",role:"combobox","aria-autocomplete":"list","aria-expanded":o,"aria-controls":"search-suggestions","aria-haspopup":"listbox","data-tour":"medals-search"}),e?r.jsx("button",{type:"button",onClick:()=>a?.(""),className:"absolute right-2 top-1/2 -translate-y-1/2 btn btn-muted h-9 w-9","aria-label":"Clear search",children:"✕"}):null]}),o&&(n||[]).length>0&&r.jsx("div",{id:"search-suggestions",role:"listbox","aria-label":"Search suggestions",className:"absolute top-full left-0 right-0 mt-1 bg-bg-secondary border border-border rounded-lg shadow-lg z-10 text-foreground",children:n.map((e,t)=>r.jsx("button",{type:"button",role:"option",onClick:()=>(e=>{s?.(e),d(!1)})(e),className:"w-full text-left px-4 py-2 min-h-[44px] hover:bg-background border-b border-border last:border-b-0 text-sm",children:e},`${e}-${t}`))})]})}function Ot({filters:e,onFilterChange:t,medalTypes:a,tiers:n,hasActiveFilters:s,resultCount:i,onClearAll:l,sortBy:o,onSortChange:d}){return r.jsxs("div",{className:"card flex flex-col overflow-hidden max-h-[80dvh] sm:max-h-none","data-tour":"filter-panel",children:[r.jsxs("div",{className:"p-4 flex justify-between items-center",children:[r.jsx("h3",{className:"font-bold text-foreground",children:"Filter"}),s&&r.jsx("button",{type:"button",onClick:l,className:"btn btn-muted text-sm min-h-[44px]",children:"Återställ alla"})]}),r.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto overscroll-contain p-4 pt-0",children:r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[r.jsxs("div",{className:"col-span-2 md:col-span-3",children:[r.jsx("label",{htmlFor:"sortSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Sortering"}),r.jsxs("select",{id:"sortSelect",value:o||"name",onChange:e=>d?.(e.target.value),className:"select",children:[r.jsx("option",{value:"name",children:"Namn"}),r.jsx("option",{value:"type",children:"Typ"}),r.jsx("option",{value:"tier",children:"Valör"}),r.jsx("option",{value:"status",children:"Status"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"statusSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Status"}),r.jsxs("select",{id:"statusSelect",value:e.status||"",onChange:e=>t("status",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"unlocked",children:"Upplåst"}),r.jsx("option",{value:"eligible",children:"Kvalificerad"}),r.jsx("option",{value:"available",children:"Tillgänglig"}),r.jsx("option",{value:"locked",children:"Låst"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"tierSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Valör"}),r.jsxs("select",{id:"tierSelect",value:e.tier||"",onChange:e=>t("tier",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),n.map(e=>r.jsx("option",{value:e,children:e.charAt(0).toUpperCase()+e.slice(1).replace(/_/g," ")},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"typeSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Typ"}),r.jsxs("select",{id:"typeSelect",value:e.type||"",onChange:e=>t("type",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),a.map(e=>r.jsx("option",{value:e,children:e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"weaponGroupSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Vapengrupp"}),r.jsxs("select",{id:"weaponGroupSelect",value:e.weaponGroup||"",onChange:e=>t("weaponGroup",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"reviewStatusSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Granskningsstatus"}),r.jsxs("select",{id:"reviewStatusSelect",value:e.reviewState||"",onChange:e=>t("reviewState",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"reviewed",children:"Granskad"}),r.jsx("option",{value:"under_review",children:"Under granskning"})]})]})]})}),r.jsxs("div",{className:"px-4 pt-4 border-t border-border text-sm text-muted-foreground flex-none sm:pb-4 pb-[env(safe-area-inset-bottom)]","aria-live":"polite",children:[i," märke(n) matchar filtren"]})]})}function Vt({currentFilters:e,onApplyPreset:a}){const{presets:n,savePreset:s,deletePreset:i,reload:l}=function(){const e="medal-app-filter-presets",[r,a]=t.useState(()=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):[]}catch(t){return console.error("Failed to load presets:",t),[]}}),n=t.useCallback(()=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):[]}catch(t){return console.error("Failed to load presets:",t),[]}},[]),s=t.useCallback(()=>{a(n())},[n]);return{presets:r,savePreset:t.useCallback((t,r)=>{try{const s=[...n(),{name:t,filters:r,createdAt:(new Date).toISOString()}];localStorage.setItem(e,JSON.stringify(s)),a(s)}catch(s){console.error("Failed to save preset:",s)}},[n]),deletePreset:t.useCallback(t=>{try{const r=n();t>=0&&t<r.length&&(r.splice(t,1),localStorage.setItem(e,JSON.stringify(r)),a(r))}catch(r){console.error("Failed to delete preset:",r)}},[n]),reload:s}}(),[o,d]=t.useState("");return r.jsxs("div",{className:"card p-4",children:[r.jsx("h3",{className:"font-bold text-foreground mb-3",children:"Filter presets"}),r.jsx("div",{className:"mb-4",children:r.jsxs("div",{className:"flex gap-2",children:[r.jsx("input",{type:"text",value:o,onChange:e=>d(e.target.value),placeholder:"Preset-namn (tex, 'Mina Favoriter')",className:"input"}),r.jsx("button",{type:"button",onClick:()=>{o.trim()&&(s(o.trim(),e),d(""),l())},disabled:!o.trim(),className:"btn btn-primary text-sm disabled:opacity-50",children:"Spara"})]})}),n.length>0&&r.jsx("div",{className:"space-y-2",children:n.map((e,t)=>r.jsxs("div",{className:"flex justify-between items-center p-3 bg-background border border-border rounded",children:[r.jsx("button",{type:"button",onClick:()=>a?.(e.filters),className:"btn btn-muted text-sm flex-1 text-left",children:e.name}),r.jsx("button",{type:"button",onClick:()=>(e=>{i(e),l()})(t),className:"btn btn-muted text-sm","aria-label":`Ta bort preset ${e.name}`,children:"Ta bort"})]},`${e.name}-${t}`))})]})}function Ut({active:e,onClick:t,children:a,ariaLabel:n,dataTour:s}){return r.jsx("button",{type:"button",onClick:t,"aria-pressed":e?"true":"false","aria-label":n,"data-tour":s,className:["inline-flex items-center px-4 py-2 rounded-full border text-sm min-h-[44px] shrink-0","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",e?"bg-primary/10 text-primary border-primary dark:bg-primary/20":"bg-transparent text-text-secondary border-border hover:bg-bg-secondary"].join(" "),children:a})}function zt({filters:e,onToggle:t,onOpenFilters:a,activeCount:n=0,controlsId:s,className:i=""}){const l=e.status||null;return r.jsxs("div",{className:["flex items-center gap-2 overflow-x-auto py-2 min-w-0",i].join(" "),role:"toolbar","aria-label":"Snabbfilter",children:[r.jsx(Ut,{active:"unlocked"===l,onClick:()=>t("status","unlocked"),ariaLabel:"Filtrera på Upplåst",dataTour:"chip-unlocked",children:"Upplåst"}),r.jsx(Ut,{active:"eligible"===l,onClick:()=>t("status","eligible"),ariaLabel:"Filtrera på Kvalificerad",children:"Kvalificerad"}),r.jsx(Ut,{active:"available"===l,onClick:()=>t("status","available"),ariaLabel:"Filtrera på Tillgänglig",children:"Tillgänglig"}),r.jsx(Ut,{active:"locked"===l,onClick:()=>t("status","locked"),ariaLabel:"Filtrera på Låst",children:"Låst"}),r.jsx("span",{className:"mx-2 h-5 w-px bg-border shrink-0 lg:hidden","aria-hidden":"true"}),r.jsx("button",{type:"button",onClick:a,"aria-haspopup":"dialog","aria-controls":s,"data-tour":"open-filters",className:"inline-flex items-center px-4 py-2 rounded-full border text-sm min-h-[44px] shrink-0 lg:hidden\n                   bg-background text-foreground border-border hover:bg-bg-secondary\n                   focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",children:n>0?`Filter (${n})`:"Filter"})]})}function Kt({data:e,index:t,style:a}){const{medals:n,onSelect:s,statusesById:i}=e,l=n[t],o="function"==typeof l?.isPlaceholder?l.isPlaceholder():"placeholder"===l?.status,d=!o&&("function"==typeof l?.isUnderReview?l.isUnderReview():"under_review"===l?.status),c=i?.[l.id],u=c?.status??"locked",m=o?"placeholder":u,p=!o&&"unlocked"===u,h=(()=>{if(!p)return null;const e=c?.unlockedDate;if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t.getFullYear()})(),f=l.displayName||l.name,x=o?`${f} • Plats­hållare`:`${f}${d?" • Under granskning":""}${p&&h?" • Upplåst "+h:""}`;return r.jsxs("div",{role:"listitem",tabIndex:0,onClick:()=>s?.(l),onKeyDown:e=>{"Enter"===e.key&&s?.(l)},className:["flex items-center gap-3 px-3 py-2 hover:bg-bg-secondary focus-visible:bg-bg-secondary cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary",o?"bg-placeholder-subtle border-l-2 border-placeholder":""].join(" "),style:a,"aria-label":x,"data-tour":0===t?"medal-row-0":void 0,children:[r.jsxs("div",{className:"relative w-10 h-10 flex items-center justify-center rounded bg-bg-secondary flex-shrink-0","aria-hidden":"true",children:[r.jsx(pt,{status:m,className:"w-2/3 h-2/3"}),!o&&d&&r.jsx("span",{className:"pill-flag pointer-events-none","aria-hidden":"true",children:r.jsx(pt,{status:"review",className:"w-2.5 h-2.5 text-white"})})]}),r.jsx("div",{className:"min-w-0",children:r.jsxs("div",{className:"font-medium text-text-primary flex items-start gap-x-2",children:[r.jsx("span",{className:"clamp-2 min-w-0",children:f}),o&&r.jsx("span",{className:"status-badge status--placeholder",children:"Plats­hållare"})]})})]})}function Ht({height:e,itemCount:a,itemSize:n,width:s="100%",itemData:i,children:l}){const o=t.useRef(null),[d,c]=t.useState(0),u=a*n,m=Math.max(0,Math.floor(d/n)-4),p=Math.ceil(e/n)+8,h=Math.min(a,m+p),f=[];for(let t=m;t<h;t++){const e=l({index:t,style:{position:"absolute",top:t*n,height:n,width:"100%"},data:i});f.push(g.cloneElement(e,{key:t}))}return r.jsx("div",{ref:o,className:"relative overflow-y-auto",style:{height:e,width:s,WebkitOverflowScrolling:"touch"},onScroll:e=>{c(e.currentTarget.scrollTop)},role:"list","aria-label":"Medal list",children:r.jsx("div",{style:{height:u,position:"relative"},children:f})})}function Wt({medals:e,onSelect:a,height:n=800,itemSize:s=72,statusesById:i}){const l=t.useMemo(()=>({medals:e,onSelect:a,statusesById:i}),[e,a,i]),o=e?.length||0,d=t.useCallback(e=>r.jsx(Kt,{...e}),[]);return r.jsx("div",{className:"border border-border rounded-md overflow-hidden",children:r.jsx(Ht,{height:n,itemCount:o,itemSize:s,width:"100%",itemData:l,children:d})})}function Xt(){const{medalDatabase:e}=se(),a=l(),n=i(),s=oe(),[o,d]=t.useState("name"),[c,u]=t.useState(!1),m=t.useRef(null),[p,h]=b(),{currentProfile:f,hydrated:x}=ie(),g=!x||void 0===f,y=Dt(),[v,j]=t.useState(600);t.useEffect(()=>{const e=()=>j(Math.max(360,Math.round(.7*window.innerHeight)));return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const w=t.useMemo(()=>e?.getAllMedals()||[],[e]),{filters:N,setFilter:k,setFilters:S,clearAllFilters:C,hasActiveFilters:M}=function(e,r={}){const[a,n]=t.useState(()=>{try{const e=localStorage.getItem(Bt);return{status:null,tier:null,type:null,weaponGroup:null,search:"",...(e?JSON.parse(e):null)||{},...r}}catch{return{status:null,tier:null,type:null,weaponGroup:null,search:"",...r}}});t.useEffect(()=>{try{localStorage.setItem(Bt,JSON.stringify(a))}catch{}},[a]);const s=t.useMemo(()=>Array.isArray(e)?e.filter(e=>{if(a.tier&&e.tier!==a.tier)return!1;if(a.type&&e.type!==a.type)return!1;if(a.weaponGroup&&e.weaponGroup!==a.weaponGroup)return!1;if(a.search){const t=a.search.toLowerCase();if(!((e.displayName||"").toLowerCase().includes(t)||(e.name||"").toLowerCase().includes(t)||(e.type||"").toLowerCase().includes(t)))return!1}return!0}):[],[e,a]),i=t.useCallback((e,t)=>{n(r=>({...r,[e]:t}))},[]),l=t.useCallback(e=>{n(t=>({...t,...e||{}}))},[]),o=t.useCallback(()=>{n({status:null,tier:null,type:null,weaponGroup:null,search:""})},[]),d=t.useMemo(()=>Object.values(a).some(e=>null!==e&&""!==e),[a]);return{filters:a,filteredMedals:s,setFilter:i,setFilters:l,clearAllFilters:o,hasActiveFilters:d}}(w),{query:A,setQuery:T,suggestions:_}=function(e=[]){const[r,a]=t.useState(""),n=t.useMemo(()=>e.map(e=>({ref:e,haystack:Lt([e.displayName||e.name||"",e.type||e.medals_type||"",e.tier||"",e.id].filter(Boolean).join(" "))})),[e]),s=t.useMemo(()=>{const t=Lt(r).trim();return t?n.filter(e=>e.haystack.includes(t)).map(e=>e.ref):e},[n,r,e]),i=t.useMemo(()=>{if(!Lt(r).trim())return[];const e=new Set;for(const t of s.slice(0,10)){const r=t.displayName||t.name;r&&!e.has(r)&&e.add(r)}return Array.from(e)},[s,r]);return{query:r,setQuery:a,results:s,suggestions:i}}(w);t.useEffect(()=>{const e=e=>{if("/"===e.key&&!e.metaKey&&!e.ctrlKey&&!e.altKey){const t=(document.activeElement?.tagName||"").toLowerCase();"input"!==t&&"textarea"!==t&&(e.preventDefault(),m.current?.focus())}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),t.useEffect(()=>{const e=e=>{const t=p.get(e);return t&&t.length?t:null},t={status:e("status"),type:e("type"),tier:e("tier"),weaponGroup:e("weaponGroup"),reviewState:e("reviewState")},r=e("search")||"",a=e("sort")||"name",n=Object.fromEntries(Object.entries(t).filter(([,e])=>null!=e));Object.keys(n).length&&S(n),r&&(T(r),k("search",r)),d(a)},[]),t.useEffect(()=>{const e=new URLSearchParams;N.status&&e.set("status",N.status),N.type&&e.set("type",N.type),N.tier&&e.set("tier",N.tier),N.weaponGroup&&e.set("weaponGroup",N.weaponGroup),N.reviewState&&e.set("reviewState",N.reviewState),A&&e.set("search",A),o&&"name"!==o&&e.set("sort",o);e.toString()!==p.toString()&&h(e,{replace:!0})},[N,A,o,h,p]);const P=t.useMemo(()=>[...new Set(w.map(e=>e.type))].filter(Boolean),[w]),I=t.useMemo(()=>[...new Set(w.map(e=>e.tier))].filter(Boolean),[w]),D=t.useMemo(()=>Object.entries(N).reduce((e,[t,r])=>"search"!==t&&r?e+1:e,0),[N]),F=t.useCallback((e,t)=>{k(e,N[e]===t?null:t)},[N,k]),q=t.useMemo(()=>{const e=Object.create(null);if(!s)return e;const t=(t,r)=>{(t||[]).forEach(t=>{e[t.medalId]={...t,status:r}})};return t(s.locked,"locked"),t(s.available,"available"),t(s.eligible,"eligible"),t(s.unlocked,"unlocked"),e},[s]),E=t.useMemo(()=>{const e={...N,search:A},t=function(e,t,r={}){if(!Array.isArray(e))return[];const a=(r.search||"").toLowerCase();return e.filter(e=>{const n=Yt(e.id,t);if(r.status&&n!==r.status)return!1;if(r.tier&&e.tier!==r.tier)return!1;if(r.type&&e.type!==r.type)return!1;if(r.weaponGroup&&e.weaponGroup!==r.weaponGroup)return!1;const s=!0!==e.reviewed;return("reviewed"!==r.reviewState||!s)&&(!("under_review"===r.reviewState&&!s)&&!(a&&!((e.displayName||"").toLowerCase().includes(a)||(e.name||"").toLowerCase().includes(a)||(e.type||"").toLowerCase().includes(a))))})}(w,s,e);return function(e,t="name",r){const a=Array.isArray(e)?[...e]:[];switch(t){case"name":return a.sort((e,t)=>(e.displayName||"").localeCompare(t.displayName||""));case"type":return a.sort((e,t)=>(e.type||"").localeCompare(t.type||""));case"tier":{const e={bronze:0,silver:1,gold:2,star_1:3,star_2:4,star_3:5};return a.sort((t,r)=>(e[t.tier]??99)-(e[r.tier]??99))}case"status":{const e={unlocked:0,eligible:1,available:2,locked:3};return a.sort((t,a)=>(e[Yt(t.id,r)]??99)-(e[Yt(a.id,r)]??99))}default:return a}}(t,o,s)},[w,s,N,A,o]),$=t.useMemo(()=>E.some(e=>!0!==e.reviewed),[E]),G=t.useCallback(()=>{if(y?.open)return;(M||""!==A||"name"!==o||c)&&(C(),T(""),k("search",""),d("name"),u(!1)),y.start("medals")},[y,M,A,o,c,C,T,k]);return t.useEffect(()=>{if(g)return;if("/medals"!==n.pathname)return;if(y?.open)return;let e=null;try{e=sessionStorage.getItem(ye)}catch{e=null}if("medals"===e){try{sessionStorage.removeItem(ye)}catch{}G()}},[g,n.pathname,y,G]),t.useEffect(()=>{if(!g&&"/medals"===n.pathname&&!y?.open){try{if("medals"===sessionStorage.getItem(ye))return}catch{}if(y?.canAutoStart?.()){if($t()){const e=qt();if(Et()!==e)return}G()}}},[g,n.pathname,y,G]),g?null:e?r.jsxs("div",{className:"space-y-6",children:[r.jsx(Pt,{idPrefix:"medals-list",promptId:"profile-picker-medals-list"}),r.jsxs("div",{className:"flex flex-col lg:flex-row lg:justify-between lg:items-center gap-3",children:[r.jsxs("div",{className:"flex items-baseline gap-3 flex-wrap",children:[r.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Märken"}),r.jsx("button",{type:"button",onClick:G,className:"text-sm underline hover:no-underline text-muted-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded",children:"Visa guide"})]}),r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsxs("div",{className:"text-sm text-muted-foreground","aria-live":"polite",children:[E.length," märken",M&&r.jsxs(r.Fragment,{children:[" · ",r.jsx("button",{type:"button",className:"underline hover:no-underline",onClick:C,children:"Rensa filter"})]}),$&&r.jsxs(r.Fragment,{children:[" · ",r.jsx("span",{className:"hidden lg:inline",role:"note","aria-label":"Teckenförklaring",children:r.jsx(ht,{})})]})]}),r.jsxs("select",{value:o,onChange:e=>d(e.target.value),className:"select hidden lg:block","aria-label":"Sortera",children:[r.jsx("option",{value:"name",children:"Sortera på namn"}),r.jsx("option",{value:"type",children:"Sortera på typ"}),r.jsx("option",{value:"tier",children:"Sortera på valör"}),r.jsx("option",{value:"status",children:"Sortera på status"})]})]})]}),r.jsx(Rt,{value:A,onChange:e=>{T(e),k("search",e)},suggestions:_,onSuggestionSelect:e=>{T(e),k("search",e)},inputRef:m,placeholder:"Sök märken... (klicka / för fokus)"}),r.jsx("div",{className:"flex items-center gap-2",children:r.jsx(zt,{className:"flex-1 min-w-0",filters:N,onToggle:(e,t)=>F(e,t),onOpenFilters:()=>u(!0),activeCount:D,controlsId:"mobile-filters-sheet"})}),r.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[r.jsxs("div",{className:"hidden lg:block lg:col-span-1 space-y-4",children:[r.jsx(Ot,{filters:N,onFilterChange:k,medalTypes:P,tiers:I,hasActiveFilters:M,resultCount:E.length,onClearAll:C,sortBy:o,onSortChange:d}),r.jsx(Vt,{currentFilters:N,onApplyPreset:e=>S(e)})]}),r.jsx(Se,{id:"mobile-filters-sheet",title:"Filter",open:c,onClose:()=>u(!1),swipeToDismiss:!0,children:r.jsx(Ot,{filters:N,onFilterChange:k,medalTypes:P,tiers:I,hasActiveFilters:M,resultCount:E.length,onClearAll:()=>{C(),u(!1)},sortBy:o,onSortChange:d})}),r.jsx("div",{className:"lg:col-span-3",children:0===E.length?r.jsx("div",{className:"card p-6 text-center",children:r.jsx("p",{className:"text-muted-foreground",children:"Inga märken matchar dina filter"})}):r.jsx("div",{className:"border border-border rounded-md overflow-hidden",role:"region","aria-label":"Märkes-resultat",children:r.jsx(Wt,{medals:E,height:v,itemSize:60,onSelect:e=>a(`/medals/${e.id}`,{state:{backgroundLocation:n}}),statusesById:q})})})]}),$&&r.jsx("div",{className:"mt-4 lg:hidden",role:"note","aria-label":"Teckenförklaring",children:r.jsx(ht,{})})]}):r.jsx("div",{className:"text-muted-foreground",children:"Laddar märken..."})}function Jt(e){const r=t.useContext(pe),a=r?.get(e)??"off";return{state:a,enabled:"on"===a||"preview"===a}}function Zt({feature:e,children:a,variant:n="auto"}){const s=me?.[e]||{},i=s.title||"Feature i utveckling",l=s.message||`Den här funktionen (“${e}”) visas som förhandsvisning.`,o="auto"===n?s.overlay||"auto":n,d=t.useRef(null),[c,u]=t.useState(!1);t.useEffect(()=>{if("auto"!==o)return;const e=d.current;if(!e||"undefined"==typeof ResizeObserver)return;const t=new ResizeObserver(t=>{const r=t[0]?.contentRect||e.getBoundingClientRect();u(r.width<420||r.height<160)});return t.observe(e),()=>t.disconnect()},[o]);const m="auto"===o?c?"inline":"panel":o;return r.jsxs("div",{ref:d,className:"relative isolate",children:[r.jsx("div",{className:"pointer-events-none opacity-60 [filter:blur(2px)]","aria-hidden":"true",inert:"",children:a}),"panel"===m?r.jsx("div",{role:"note","aria-label":"Feature preview","aria-live":"polite",className:"absolute inset-0 z-10 grid place-items-center bg-black/40 backdrop-blur-sm",children:r.jsx("div",{className:"w-[min(92vw,36rem,calc(100%-1rem))] max-w-none mx-4 rounded-xl border border-border bg-bg-secondary/95 p-4 shadow-lg text-foreground",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(Ce,{name:"FlaskConical",className:"w-5 h-5","aria-hidden":"true",style:{color:"var(--color-info)"}}),r.jsxs("div",{children:[r.jsx("div",{className:"font-semibold leading-5 text-balance",children:i}),r.jsx("div",{className:"mt-1 text-sm text-muted-foreground text-pretty break-words",children:l})]})]})})}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"absolute inset-0 z-10 bg-black/30 backdrop-blur-[1.5px]","aria-hidden":"true"}),r.jsx("div",{className:"absolute inset-0 z-20 grid place-items-center",children:r.jsx("div",{role:"note","aria-label":"Feature preview",className:"mx-2 w-[min(92vw,calc(100%-1rem),28rem)] rounded-lg border border-border bg-bg-secondary/95 p-3 shadow-md text-foreground",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(Ce,{name:"FlaskConical",className:"w-4 h-4","aria-hidden":"true",style:{color:"var(--color-info)"}}),r.jsxs("p",{className:"text-sm leading-5 text-pretty break-words",children:[r.jsxs("span",{className:"font-semibold",children:[i,":"]})," ",r.jsx("span",{className:"text-muted-foreground",children:l})]})]})})})]})]})}function Qt({name:e,mode:t="preview",fallback:a=null,className:n,style:s,children:i}){const{state:l}=Jt(e);return"off"===l?a:"preview"===l?"hide"===t?a:r.jsx("div",{className:n,style:s,children:r.jsx(Zt,{feature:e,children:i})}):r.jsx("div",{className:n,style:s,children:i})}const er=(new Date).getFullYear();function tr({open:e,onClose:a,initialRow:n,onSave:s,mode:i="batch",submitLabel:l,WG:o=["A","B","C","R"],DISCIPLINE_TYPES:d=["field","precision","military_fast"],COMP_TYPES:c=["national","regional/landsdels","crewmate/krets","championship","rikstavlingen","riks","nationell","landsdel","krets"],MEDAL_TYPES:u=["bronze","silver","gold"],APP_TIME_OPTIONS:m=[{value:60,label:"60, Brons"},{value:40,label:"40, Silver"},{value:17,label:"17, Guld A/R"},{value:15,label:"15, Guld B/C"}],COMP_DISCIPLINE_TYPES:p=["national_whole_match","military_fast_match","ppc","precision","field"],PPC_CLASS_SUGGESTIONS:h=["R1500","P1500","Open","SSA",'SR 4"','SR 2,75"',"Dist pistol","Dist revolver"]}){const f=t.useMemo(()=>e?JSON.stringify(n??{}):"closed",[e,n]);return r.jsx(Se,{id:"batch-row-editor",title:"Aktivitet",open:e,onClose:a,swipeToDismiss:!0,children:e?r.jsx(Qt,{name:"achievementEntry",children:r.jsx(rr,{initialRow:n,onSave:s,onClose:a,mode:i,submitLabel:l,WG:o,DISCIPLINE_TYPES:d,COMP_TYPES:c,MEDAL_TYPES:u,APP_TIME_OPTIONS:m,COMP_DISCIPLINE_TYPES:p,PPC_CLASS_SUGGESTIONS:h},f)}):null})}function rr({initialRow:e,onSave:a,onClose:n,mode:s="batch",submitLabel:i,WG:l,DISCIPLINE_TYPES:o,COMP_TYPES:d,MEDAL_TYPES:c,APP_TIME_OPTIONS:u,COMP_DISCIPLINE_TYPES:m,PPC_CLASS_SUGGESTIONS:p}){const[h,f]=t.useState(()=>e||{}),[x,g]=t.useState({}),b=!("competition_result"===h.type&&"ppc"===String(h.disciplineType||"").toLowerCase()),y=(e,t)=>f(r=>({...r,[e]:t})),v=t.useMemo(()=>e=>{const t=[],r={},a=Number(e.year);switch((!Number.isFinite(a)||a<1900||a>er)&&(t.push(`Året måste vara mellan 1900 och ${er}`),r.year=!0),l.includes(e.weaponGroup)||(t.push("Ogiltig grupp (A, B, C, R)"),r.weaponGroup=!0),e.type){case"precision_series":{const a=Number(e.points);(!Number.isFinite(a)||a<0||a>50)&&(t.push("Poäng måste vara 0-50"),r.points=!0);break}case"application_series":{const a=new Date(e.date);if(!e.date||Number.isNaN(a.getTime()))t.push("Ogiltigt datum"),r.date=!0;else{const e=new Date;e.setHours(0,0,0,0),a.setHours(0,0,0,0),a.getTime()>e.getTime()&&(t.push("Datum kan inte vara i framtiden"),r.date=!0)}const n=u.map(e=>e.value),s=Number(e.timeSeconds);Number.isFinite(s)&&n.includes(s)||(t.push("Välj giltig tid"),r.timeSeconds=!0);const i=Number(e.hits);(!Number.isFinite(i)||i<0)&&(t.push("Ange giltigt antal träffar"),r.hits=!0);break}case"shooting_round":{const a=Number(e.totalPoints);(!Number.isFinite(a)||a<0||a>150)&&(t.push("Totalpoäng måste vara 0-150"),r.totalPoints=!0);break}case"speed_shooting_series":{const a=Number(e.points);(!Number.isFinite(a)||a<0||a>50)&&(t.push("Poäng måste vara 0-50"),r.points=!0);break}case"competition_result":{const a=String(e.competitionType||"").toLowerCase(),n=String(e.disciplineType||"").toLowerCase(),s=Number(e.score);if(d.includes(a)||(t.push("Välj giltig tävlingstyp"),r.competitionType=!0),m.includes(n)||(t.push("Välj giltig gren"),r.disciplineType=!0),Number.isFinite(s)||(t.push("Poäng måste vara ett tal"),r.score=!0),"ppc"!==n||String(e.ppcClass||"").trim()||(t.push("Välj PPC-klass"),r.ppcClass=!0),null!=e.seriesCount&&""!==e.seriesCount){const a=Number(e.seriesCount);Number.isFinite(a)&&[6,7,10].includes(a)||(t.push("Antal serier måste vara 6, 7 eller 10"),r.seriesCount=!0)}break}case"competition_performance":{const a=String(e.disciplineType||"").toLowerCase();if(["field","precision","military_fast"].includes(a)||(t.push("Välj giltig gren (field, running, precision)"),r.disciplineType=!0),"running"===a||"skiing"===a){const a=Number(e.points);(!Number.isFinite(a)||a<0)&&(t.push("Poäng måste vara ett positivt tal"),r.points=!0)}else if("field"===a){const a=Number(e.score),n=Number(e.maxScore);(!Number.isFinite(a)||a<0)&&(t.push("Poäng måste vara ett positivt tal"),r.score=!0),(!Number.isFinite(n)||n<=0)&&(t.push("Max poäng måste vara större än 0"),r.maxScore=!0)}break}case"air_pistol_precision":{const a=Number(e.points);(!Number.isFinite(a)||a<0||a>100)&&(t.push("Poäng måste vara 0-100"),r.points=!0);break}case"running_shooting_course":{const a=Number(e.points);(!Number.isFinite(a)||a<0)&&(t.push("Poäng måste vara ett positivt tal"),r.points=!0);break}}return{errs:t,fields:r}},[l,d,u,m]),j=(e=!1)=>{const{errs:t,fields:r}=v(h);if(t.length)g({list:t,fields:r});else if(a?.(h,{addAnother:e}),e){const e={year:h.year,weaponGroup:h.weaponGroup,type:h.type,date:(new Date).toISOString().slice(0,10),timeSeconds:"",hits:"",points:"",totalPoints:"",competitionType:"",medalType:"",disciplineType:"",ppcClass:"",competitionName:"",weapon:"",score:"",seriesCount:"",teamName:"",position:"",participants:"",eventName:"",notes:""};f(e),g({})}else n?.()};return r.jsxs("form",{onSubmit:e=>{e.preventDefault(),j(!1)},className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{className:["grid gap-3",b?"grid-cols-2":"grid-cols-1"].join(" "),children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-year",className:"field-label mb-2",children:"År"}),r.jsx("input",{id:"br-year",type:"number",min:"1900",max:er,className:"input py-3",value:h.year??er,onChange:e=>y("year",Number(e.target.value)),"aria-invalid":x.fields?.year||void 0})]}),b&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-group",className:"field-label mb-2",children:"Grupp"}),r.jsx("select",{id:"br-group",className:"select py-3",value:h.weaponGroup??"A",onChange:e=>y("weaponGroup",e.target.value),"aria-invalid":x.fields?.weaponGroup||void 0,children:l.map(e=>r.jsx("option",{value:e,children:e},e))})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-type",className:"field-label mb-2",children:"Type"}),r.jsxs("select",{id:"br-type",className:"select py-3",value:h.type||"precision_series",onChange:e=>y("type",e.target.value),children:[r.jsx("option",{value:"precision_series",children:"Precisionsserier"}),r.jsx("option",{value:"application_series",children:"Tillämpningsserier"}),r.jsx("option",{value:"shooting_round",children:"Skjutomgång"}),r.jsx("option",{value:"speed_shooting_series",children:"Snabbskjutningsserier"}),r.jsx("option",{value:"standard_medal",children:"Standardmedalj"}),r.jsx("option",{value:"competition_result",children:"Tävlingsresultat"}),r.jsx("option",{value:"qualification_result",children:"Kvalificering"}),r.jsx("option",{value:"team_event",children:"Lag-eventt"}),r.jsx("option",{value:"event",children:"Event"}),r.jsx("option",{value:"custom",children:"Custom"})]})]}),"precision_series"===h.type&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-points",className:"field-label mb-2",children:"Poäng (0-50)"}),r.jsx("input",{id:"br-points",type:"number",min:"0",max:"50",className:"input py-3",value:h.points??"",onChange:e=>y("points",e.target.value),"aria-invalid":x.fields?.points||void 0})]}),"application_series"===h.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{id:"br-date",type:"date",className:"input py-3",value:h.date??(new Date).toISOString().slice(0,10),onChange:e=>y("date",e.target.value),"aria-invalid":x.fields?.date||void 0})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-time",className:"field-label mb-2",children:"Tid"}),r.jsxs("select",{id:"br-time",className:"select py-3",value:""===h.timeSeconds?"":Number(h.timeSeconds),onChange:e=>y("timeSeconds",""===e.target.value?"":Number(e.target.value)),"aria-invalid":x.fields?.timeSeconds||void 0,children:[r.jsx("option",{value:"",children:"Select time…"}),u.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-hits",className:"field-label mb-2",children:"Hits"}),r.jsx("input",{id:"br-hits",type:"number",min:"0",className:"input py-3",value:h.hits??"",onChange:e=>y("hits",e.target.value),"aria-invalid":x.fields?.hits||void 0})]})]}),"shooting_round"===h.type&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-totalpoints",className:"field-label mb-2",children:"Totalpoäng (0-150)"}),r.jsx("input",{id:"br-totalpoints",type:"number",min:"0",max:"150",className:"input py-3",value:h.totalPoints??"",onChange:e=>y("totalPoints",e.target.value),"aria-invalid":x.fields?.totalPoints||void 0}),r.jsx("p",{className:"text-xs text-text-tertiary mt-1",children:"Skjutomgång består av 3 serier (150s, 20s, 10s)"})]}),"speed_shooting_series"===h.type&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-speedpoints",className:"field-label mb-2",children:"Poäng (0-50)"}),r.jsx("input",{id:"br-speedpoints",type:"number",min:"0",max:"50",className:"input py-3",value:h.points??"",onChange:e=>y("points",e.target.value),"aria-invalid":x.fields?.points||void 0}),r.jsx("p",{className:"text-xs text-text-tertiary mt-1",children:"5-skottsserie mot snabbpistoltavla 25m (3 sek per skott)"})]}),"standard_medal"===h.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ctype",className:"field-label mb-2",children:"Gren"}),r.jsxs("select",{id:"br-ctype",className:"select py-3",value:h.disciplineType??"",onChange:e=>y("disciplineType",e.target.value),children:[r.jsx("option",{value:"",children:"Välj disciplin..."}),o.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-mtype",className:"field-label mb-2",children:"Medalj"}),r.jsxs("select",{id:"br-mtype",className:"select py-3",value:h.medalType??"",onChange:e=>y("medalType",e.target.value),children:[r.jsx("option",{value:"",children:"Välj medalj..."}),c.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-cname",className:"field-label mb-2",children:"Namn (valfritt)"}),r.jsx("input",{id:"br-cname",type:"text",className:"input py-3",value:h.competitionName??"",onChange:e=>y("competitionName",e.target.value)})]})]}),"competition_result"===h.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ctype",className:"field-label mb-2",children:"Tävlingstyp"}),r.jsxs("select",{id:"br-ctype",className:"select py-3",value:h.competitionType??"",onChange:e=>y("competitionType",e.target.value),"aria-invalid":x.fields?.competitionType||void 0,children:[r.jsx("option",{value:"",children:"Select type…"}),d.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-disc",className:"field-label mb-2",children:"Gren"}),r.jsxs("select",{id:"br-disc",className:"select py-3",value:h.disciplineType??"",onChange:e=>y("disciplineType",e.target.value),"aria-invalid":x.fields?.disciplineType||void 0,children:[r.jsx("option",{value:"",children:"Välj gren…"}),m.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),"ppc"===String(h.disciplineType||"")&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ppc",className:"field-label mb-2",children:"PPC-klass"}),r.jsx("input",{id:"br-ppc",type:"text",className:"input py-3",list:"ppc-classes",value:h.ppcClass??"",onChange:e=>y("ppcClass",e.target.value),placeholder:"t.ex. R1500","aria-invalid":x.fields?.ppcClass||void 0}),r.jsx("datalist",{id:"ppc-classes",children:p.map(e=>r.jsx("option",{value:e},e))})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-score",className:"field-label mb-2",children:"Poäng"}),r.jsx("input",{id:"br-score",type:"number",className:"input py-3",value:h.score??"",onChange:e=>y("score",e.target.value),"aria-invalid":x.fields?.score||void 0})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-series",className:"field-label mb-2",children:"Antal serier (valfritt)"}),r.jsxs("select",{id:"br-series",className:"select py-3",value:h.seriesCount??"",onChange:e=>y("seriesCount",""===e.target.value?"":Number(e.target.value)),"aria-invalid":x.fields?.seriesCount||void 0,children:[r.jsx("option",{value:"",children:"-"}),r.jsx("option",{value:"6",children:"6 serier"}),r.jsx("option",{value:"7",children:"7 serier"}),r.jsx("option",{value:"10",children:"10 serier"})]}),r.jsx("p",{className:"text-xs text-text-tertiary mt-1",children:"Används för Mästarmärket"})]}),r.jsxs("div",{className:"md:col-span-2",children:[r.jsx("label",{htmlFor:"br-cname",className:"field-label mb-2",children:"Namn (valfritt)"}),r.jsx("input",{id:"br-cname",type:"text",className:"input py-3",value:h.competitionName??"",onChange:e=>y("competitionName",e.target.value)})]})]}),"qualification_result"===h.type&&r.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-weapon",className:"field-label mb-2",children:"Vapen"}),r.jsx("input",{id:"br-weapon",type:"text",className:"input py-3",value:h.weapon??"",onChange:e=>y("weapon",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-score",className:"field-label mb-2",children:"Poäng"}),r.jsx("input",{id:"br-score",type:"number",className:"input py-3",value:h.score??"",onChange:e=>y("score",e.target.value)})]})]}),"team_event"===h.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-team",className:"field-label mb-2",children:"Lag"}),r.jsx("input",{id:"br-team",type:"text",className:"input py-3",value:h.teamName??"",onChange:e=>y("teamName",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-pos",className:"field-label mb-2",children:"Placering"}),r.jsx("input",{id:"br-pos",type:"number",min:"1",className:"input py-3",value:h.position??"",onChange:e=>y("position",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-part",className:"field-label mb-2",children:"Deltagare"}),r.jsx("input",{id:"br-part",type:"text",className:"input py-3",placeholder:"Anna, Björn, Carin",value:h.participants??"",onChange:e=>y("participants",e.target.value)})]})]}),("event"===h.type||"custom"===h.type)&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ename",className:"field-label mb-2",children:"Titel"}),r.jsx("input",{id:"br-ename",type:"text",className:"input py-3",value:h.eventName??"",onChange:e=>y("eventName",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-notes",className:"field-label mb-2",children:"Anteckningar (valfritt)"}),r.jsx("textarea",{id:"br-notes",className:"textarea py-3 resize-none",rows:3,value:h.notes??"",onChange:e=>y("notes",e.target.value)})]}),x.list?.length?r.jsx("div",{role:"alert",className:"alert alert-error text-sm",children:x.list.join(", ")}):null,"batch"===s?r.jsxs("div",{className:"flex gap-2 justify-end pt-2",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:n,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-muted",onClick:()=>j(!0),children:"Lägg till & lägg till en till"}),r.jsx("button",{type:"submit",className:"btn btn-primary",children:"Lägg till batch"})]}):r.jsxs("div",{className:"flex gap-2 justify-end pt-2",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:n,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary",children:i||"Spara"})]})]})}function ar({row:e,index:t,onEdit:a,onRemove:n}){const s=(()=>{switch(e.type){case"precision_series":return`Points: ${e.points??"—"}`;case"application_series":return`Time: ${e.timeSeconds??"—"} • Hits: ${e.hits??"—"}`;case"standard_medal":return`${e.disciplineType||"—"} • ${e.medalType||"—"}`;case"competition_result":return`${e.competitionType||"—"} • ${e.medalType||"—"}`;case"qualification_result":return`Weapon: ${e.weapon||"—"} • Score: ${e.score||"—"}`;case"team_event":return`Team: ${e.teamName||"—"} • Pos: ${e.position||"—"}`;default:return`${e.eventName||"—"}`}})();return r.jsxs("div",{className:"card p-4 flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsxs("div",{className:"font-medium text-foreground",children:[e.type.replace(/_/g," ")," • ",e.year," • Grupp ",e.weaponGroup]}),r.jsx("div",{className:"text-sm text-muted-foreground",children:s}),e.notes?r.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"Anteckningar"}):null]}),r.jsxs("div",{className:"flex gap-2 shrink-0",children:[r.jsx("button",{type:"button",onClick:()=>a?.(t),className:"btn btn-muted h-10 px-3","aria-label":`Ändra rad ${t+1}`,children:"Ändra"}),r.jsx("button",{type:"button",onClick:()=>n?.(t),className:"btn btn-muted h-10 px-3 text-red-600","aria-label":`Ta bort rad ${t+1}`,children:"Ta bort"})]})]})}const nr=["A","B","C","R"],sr=["national_whole_match","military_fast_match","ppc","precision","field"],ir=["rikstavlingen","riks","nationell","landsdel","krets"];function lr(e){const t=new Date(e);if(Number.isNaN(t.getTime()))return!0;const r=new Date;return r.setHours(0,0,0,0),t.setHours(0,0,0,0),t.getTime()>r.getTime()}function or(e){const t=[];if(!e||"object"!=typeof e)return{valid:!1,errors:["Invalid achievement object"]};const{type:r,year:a,weaponGroup:n}=e;if(r&&"string"==typeof r||t.push("Invalid type"),("number"!=typeof a||Number.isNaN(a))&&t.push("Invalid year"),n&&nr.includes(n)||t.push("Invalid weapon group"),"precision_series"===r){const r=e.points;"number"!=typeof r||Number.isNaN(r)?t.push("Points required for precision series"):(r<0||r>50)&&t.push("Points must be between 0 and 50")}if("application_series"===r){const r=e.timeSeconds,a=e.hits;("number"!=typeof r||Number.isNaN(r)||r<=0)&&t.push("Time required for application series"),("number"!=typeof a||Number.isNaN(a)||a<0)&&t.push("Hits required for application series")}if("competition_result"===r){const r=e.score,a=String(e.disciplineType||"").toLowerCase();if(("number"!=typeof r||Number.isNaN(r)||r<0)&&t.push("Score required for competition result"),a&&sr.includes(a)||t.push("Discipline required for competition result"),"ppc"===a){const r=e.ppcClass;r&&""!==String(r).trim()||t.push("PPC class required for PPC discipline")}if(e.competitionType&&!ir.includes(e.competitionType)&&t.push("Invalid competition type"),null!=e.seriesCount){const r=Number(e.seriesCount);!Number.isNaN(r)&&[6,7,10].includes(r)||t.push("Series count must be 6, 7, or 10")}}if("running_shooting_course"===r||"skis_shooting_course"===r){const r=e.points;("number"!=typeof r||Number.isNaN(r)||r<0)&&t.push("Points required for running/skiing shooting course"),!e.date||Number.isNaN(new Date(e.date).getTime())?t.push("Date required for running/skiing shooting course"):lr(e.date)&&t.push("Date cannot be in the future")}if("shooting_round"===r){const r=e.totalPoints;("number"!=typeof r||Number.isNaN(r)||r<0)&&t.push("Total points required for shooting round"),r>150&&t.push("Total points cannot exceed 150")}if("speed_shooting_series"===r){const r=e.points;"number"!=typeof r||Number.isNaN(r)?t.push("Points required for speed shooting series"):(r<0||r>50)&&t.push("Points must be between 0 and 50")}if("air_pistol_precision"===r){const r=e.points;"number"!=typeof r||Number.isNaN(r)?t.push("Points required for air pistol precision"):(r<0||r>100)&&t.push("Points must be between 0 and 100")}if("competition_performance"===r){const r=String(e.disciplineType||"").toLowerCase();if(r&&["field","running","skiing"].includes(r)||t.push("Discipline type required for competition performance"),"field"===r){const r=e.scorePercent;("number"!=typeof r||Number.isNaN(r)||r<0||r>100)&&t.push("Score percent required for field competition (0-100)")}if("running"===r||"skiing"===r){const r=e.points;("number"!=typeof r||Number.isNaN(r)||r<0)&&t.push("Points required for running/skiing competition")}}if("standard_medal"===r){String(e.disciplineType||"").toLowerCase()||t.push("Discipline type required for standard medal");const r=String(e.medalType||"").toLowerCase();r&&["bronze","silver","gold"].includes(r)||t.push("Medal type (bronze/silver/gold) required for standard medal")}return{valid:0===t.length,errors:t}}class dr{constructor(e){this.id=e.id||`achievement-${Date.now()}`,this.type=e.type,this.medalId=e.medalId,this.date=e.date;const t="number"==typeof e.year&&Number.isFinite(e.year),r=this.date?new Date(this.date).getFullYear():void 0;this.year=t?e.year:Number.isFinite(r)?r:void 0,this.weaponGroup=e.weaponGroup||"A",this.points="number"==typeof e.points?e.points:null!=e.points&&""!==e.points?Number(e.points):void 0,this.disciplineType=e.disciplineType,this.competitionType=e.competitionType,this.medalType=e.medalType,this.ppcClass=e.ppcClass,this.competitionName=e.competitionName||"",this.notes=e.notes||"",this.score="number"==typeof e.score?e.score:null!=e.score&&""!==e.score?Number(e.score):void 0,this.weapon=e.weapon,this.teamName=e.teamName,this.position="number"==typeof e.position?e.position:null!=e.position&&""!==e.position?Number(e.position):void 0,this.participants=Array.isArray(e.participants)?e.participants:"string"==typeof e.participants?e.participants.split(",").map(e=>e.trim()).filter(Boolean):void 0,this.eventName=e.eventName,this.timeSeconds="number"==typeof e.timeSeconds?e.timeSeconds:null!=e.timeSeconds&&""!==e.timeSeconds?Number(e.timeSeconds):void 0,this.hits="number"==typeof e.hits?e.hits:null!=e.hits&&""!==e.hits?Number(e.hits):void 0,this.scorePercent="number"==typeof e.scorePercent?e.scorePercent:null!=e.scorePercent&&""!==e.scorePercent?Number(e.scorePercent):void 0,this.maxScore="number"==typeof e.maxScore?e.maxScore:null!=e.maxScore&&""!==e.maxScore?Number(e.maxScore):void 0,this.seriesName=e.seriesName,this.courseName=e.courseName}}function cr(){const{currentProfile:e,addAchievement:r,updateAchievement:a,removeAchievement:n,unlockMedal:s}=ie(),{pushState:i,undo:l,redo:o,canUndo:d,canRedo:c,history:u,historyIndex:m}=function(){const e=t.useContext(ce);if(!e)throw new Error("useUndoRedo must be used within UndoRedoProvider");return e}(),p=t.useCallback(()=>(e?.prerequisites||[]).map(e=>({...e})),[e]),h=t.useCallback(()=>{i({type:"achievements",data:p()})},[i,p]),f=t.useCallback(async t=>{if(!e)return;const s=(e.prerequisites||[]).map(e=>({...e})),i=new Map(s.map(e=>[e.id,e])),l=new Map(t.map(e=>[e.id,e]));for(const e of s)if(!l.has(e.id)&&"function"==typeof n)try{await n(e.id)}catch{}for(const e of t)if(!i.has(e.id)&&"function"==typeof r)try{await r(new dr(e))}catch{}for(const e of t){const t=i.get(e.id);if(!t)continue;if(["type","year","weaponGroup","points","date","competitionName","notes","timeSeconds","hits"].some(r=>String(t[r]??"")!==String(e[r]??""))&&"function"==typeof a)try{await a(new dr(e))}catch{}}},[r,n,a,e]),x=t.useCallback(async(t=[])=>{if(!t.length||!e)return 0;let a=0;const n=[],s=e=>""===e||null==e?void 0:Number(e);for(let e=0;e<t.length;e++){const l=t[e],o=new dr({id:l.id,type:l.type,year:Number(l.year),weaponGroup:l.weaponGroup,date:l.date||(new Date).toISOString().slice(0,10),competitionName:l.competitionName||"",notes:l.notes||"",points:"precision_series"===l.type?s(l.points):void 0,disciplineType:"standard_medal"===l.type||"competition_result"===l.type?l.disciplineType||"":void 0,medalType:"standard_medal"===l.type?l.medalType||"":void 0,competitionType:"competition_result"===l.type?l.competitionType||"":void 0,ppcClass:"competition_result"===l.type?l.ppcClass||"":void 0,score:"competition_result"===l.type||"qualification_result"===l.type?s(l.score):void 0,weapon:"qualification_result"===l.type?l.weapon||"":void 0,teamName:"team_event"===l.type?l.teamName||"":void 0,position:"team_event"===l.type?s(l.position):void 0,participants:"team_event"===l.type?Array.isArray(l.participants)?l.participants:String(l.participants||"").split(",").map(e=>e.trim()).filter(Boolean):void 0,eventName:"event"===l.type||"custom"===l.type?l.eventName||"":void 0,timeSeconds:"application_series"===l.type?Number(l.timeSeconds):void 0,hits:"application_series"===l.type?""===l.hits||null==l.hits?void 0:Number(l.hits):void 0});if("function"==typeof r)try{await r(o),a++}catch(i){n.push({index:e,message:i?.message||"Failed to add achievement"}),console.error("addMany: add failed",{index:e+1,error:i,achievement:o})}}if(a>0)return h(),a;if(n.length>0){const e=n.map(e=>`Row ${e.index+1}: ${e.message}`).join(" | ");throw new Error(e)}return 0},[r,e,h]),g=t.useCallback(async t=>{if(!e)return!1;const r=t instanceof dr?t:new dr({...t,id:t?.id});if(!r?.id)return!1;try{return await a(r),h(),!0}catch(n){return console.error("updateAchievement failed",{error:n,payload:r}),!1}},[e,a,h]),b=t.useCallback(async t=>{if(!e||!t)return!1;let r=!1;if("function"==typeof n)try{await n(t),r=!0}catch(a){console.error("removeAchievement failed",{error:a,achievementId:t})}return r&&h(),r},[e,n,h]),y=t.useCallback(async()=>{const e=l();if(null==e)return!1;const t=u[e];return"achievements"===t?.type&&(await f(t.data),!0)},[l,u,f]),v=t.useCallback(async()=>{const e=o();if(null==e)return!1;const t=u[e];return"achievements"===t?.type&&(await f(t.data),!0)},[o,u,f]);t.useEffect(()=>{const e=e=>{(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey)&&("z"===e.key.toLowerCase()?(e.preventDefault(),y()):"y"===e.key.toLowerCase()&&(e.preventDefault(),v()))};return window.addEventListener("keydown",e,{passive:!1}),()=>window.removeEventListener("keydown",e)},[y,v]);const j=t.useCallback(async t=>{if(!e||!t)return!1;const a=t instanceof dr?t:new dr(t);if("function"!=typeof r)return!1;try{return await r(a),h(),!0}catch(n){return console.error("addAchievement failed",{error:n,achievement:a}),!1}},[e,r,h]),w=g,N=b;return{achievements:e?.prerequisites||[],addMany:x,addAchievement:j,updateAchievement:w,removeAchievement:N,unlockMedal:s,updateOne:g,removeOne:b,undoAchievements:y,redoAchievements:v,canUndo:d,canRedo:c,historyIndex:m}}const ur=["A","B","C","R"],mr=["national","regional/landsdels","crewmate/krets","championship"],pr=["field","precision","military_fast"],hr=["national_whole_match","military_fast_match","ppc"],fr=["R1500","P1500","Open","SSA",'SR 4"','SR 2,75"',"Dist pistol","Dist revolver"],xr=["bronze","silver","gold"],gr=[{value:60,label:"60, Brons"},{value:40,label:"40, Silver"},{value:17,label:"17, Guld A/R"},{value:15,label:"15, Guld B/C"}],br=(new Date).getFullYear(),yr=()=>({year:br,weaponGroup:"A",type:"precision_series",date:(new Date).toISOString().slice(0,10),timeSeconds:"",hits:"",points:"",competitionType:"",medalType:"",disciplineType:"",competitionName:"",weapon:"",score:"",ppcClass:"",teamName:"",position:"",participants:"",eventName:"",notes:""});function vr(){const{addMany:e}=cr(),[a,n]=t.useState([yr()]),[s,i]=t.useState(!1),[l,o]=t.useState(-1),[d,c]=t.useState({}),[u,m]=t.useState(0),[p,h]=t.useState(!1),[f,x]=t.useState([]),g=(e,t,r)=>{const s=[...a];s[e]={...s[e],[t]:r},n(s)},b=e=>{o(e),i(!0)},y=e=>{n(a.filter((t,r)=>r!==e))};return r.jsx(Qt,{name:"achievementEntry",children:r.jsxs("div",{className:"card p-6",children:[r.jsx("h2",{className:"text-xl font-bold mb-2 text-text-primary",children:"Lägg till aktiviteter i batch"}),r.jsx("p",{id:"batch-type-help",className:"text-sm text-text-secondary mb-4",children:"Batcher stödjer precisionsserier och tillämpningsserier. För att lägga till övriga, logga dem på ett märkeskort."}),u>0&&r.jsx("div",{role:"status","aria-live":"polite",className:"alert alert-success mb-4",children:r.jsxs("p",{children:["✓ Lyckades lägga till ",u," aktivitet(er)"]})}),f.length>0&&r.jsxs("div",{role:"alert",className:"alert alert-warning mb-4",children:[r.jsx("p",{className:"font-medium mb-1",children:"Möjliga duplikat:"}),r.jsx("ul",{className:"list-disc list-inside text-muted-foreground text-sm",children:f.map((e,t)=>r.jsx("li",{children:e},t))})]}),d.form&&r.jsx("div",{role:"alert",className:"alert alert-error mb-4",children:r.jsx("p",{children:d.form})}),r.jsxs("div",{className:"sm:hidden space-y-3 mb-4",children:[a.map((e,t)=>r.jsx(ar,{row:e,index:t,onEdit:b,onRemove:y},t)),r.jsx("div",{className:"sticky bottom-0 safe-bottom pt-2 bg-transparent",children:r.jsx("button",{type:"button",onClick:()=>{o(-1),i(!0)},className:"btn btn-primary w-full min-h-[44px]","aria-label":"Add achievement",children:"+ Lägg till"})})]}),r.jsxs("form",{onSubmit:async t=>{t.preventDefault();const r={},s=[];if(a.forEach((e,t)=>{const a=[],n={},i=Number(e.year);switch((!Number.isFinite(i)||i<2e3||i>br)&&(a.push(`Året måste vara mellan 2000 och ${br}`),n.year=!0),ur.includes(e.weaponGroup)||(a.push("Ogiltig grupp (A, B, C, R)"),n.weaponGroup=!0),e.type){case"precision_series":{const t=Number(e.points);(!Number.isFinite(t)||t<0||t>50)&&(a.push("Poäng måste vara mellan 0-50"),n.points=!0);break}case"application_series":{const t=new Date(e.date);if(!e.date||Number.isNaN(t.getTime()))a.push("Ogiltigt datum"),n.date=!0;else{const e=new Date;e.setHours(0,0,0,0),t.setHours(0,0,0,0),t.getTime()>e.getTime()&&(a.push("Datum kan inte vara i framtiden"),n.date=!0)}const r=[60,40,17,15],s=Number(e.timeSeconds);Number.isFinite(s)&&r.includes(s)||(a.push("Välj giltig tid"),n.timeSeconds=!0);const i=Number(e.hits);(!Number.isFinite(i)||i<0)&&(a.push("Ange giltigt antal träffar"),n.hits=!0);break}case"competition_result":{const t=String(e.competitionType||"").toLowerCase(),r=String(e.disciplineType||"").toLowerCase(),s=Number(e.score);mr.includes(t)||(a.push("Välj giltig tävlingstyp"),n.competitionType=!0),hr.includes(r)||(a.push("Välj giltig gren"),n.disciplineType=!0),Number.isFinite(s)||(a.push("Poäng måste vara ett tal"),n.score=!0),"ppc"!==r||String(e.ppcClass||"").trim()||(a.push("Välj PPC-klass"),n.ppcClass=!0);break}}a.length?r[t]={list:a,fields:n}:s.push(e)}),Object.keys(r).length)return void c(r);const i=function(e){const t=new Set,r=[];return e.forEach(e=>{if(!e)return;if("application_series"===e.type)return;let a;a="precision_series"===e.type?`${e.year}-${e.type}-${e.weaponGroup}-${e.points}`:"competition_result"===e.type?`${e.year}-${e.type}-${e.weaponGroup}-${e.disciplineType||""}-${e.date||""}-${e.score??""}`:`${e.year}-${e.type}-${e.weaponGroup}`,t.has(a)&&r.push(a),t.add(a)}),r}(s.filter(e=>"precision_series"===e.type));x(i);try{h(!0);const t=await e(s);t>0?(m(t),n([yr()]),c({}),setTimeout(()=>m(0),3e3)):c({form:"Inga aktiviteter blev tillagda. Granska din input."})}catch(l){c({form:l.message})}finally{h(!1)}},children:[r.jsx("div",{className:"hidden sm:block overflow-x-auto mb-4",children:r.jsxs("table",{className:"w-full text-sm text-foreground table-fixed",children:[r.jsxs("colgroup",{children:[r.jsx("col",{className:"w-[7rem]"}),r.jsx("col",{className:"w-[12rem]"}),r.jsx("col",{className:"w-[5rem]"}),r.jsx("col",{}),r.jsx("col",{className:"w-[7rem]"})]}),r.jsx("caption",{className:"sr-only",children:"Batch achievement input"}),r.jsx("thead",{children:r.jsxs("tr",{className:"border-b border-border bg-bg-secondary",children:[r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"År"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Typ"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Grupp"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Detaljer"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Åtgärd"})]})}),r.jsx("tbody",{children:a.map((e,t)=>{const n=d[t],s=n?.list||[],i=`row-${t}-errors`,l=!!n?.fields?.year,o=!!n?.fields?.weaponGroup,c=!!n?.fields?.points,u=!!n?.fields?.date,m=!!n?.fields?.timeSeconds,h=!!n?.fields?.hits;return r.jsxs("tr",{className:"border-b border-border hover:bg-bg-secondary/60",children:[r.jsx("td",{className:"px-3 py-2",children:r.jsx("input",{type:"number",min:"2000",max:(new Date).getFullYear(),value:e.year,onChange:e=>g(t,"year",e.target.value),className:"input w-full",disabled:p,"aria-label":`Year for row ${t+1}`,"aria-invalid":l||void 0,"aria-describedby":s.length?i:void 0})}),r.jsx("td",{className:"px-3 py-2",children:r.jsxs("select",{value:e.type,onChange:e=>g(t,"type",e.target.value),className:"select w-full",disabled:p,"aria-label":`Type for row ${t+1}`,"aria-describedby":"batch-type-help",children:[r.jsx("option",{value:"precision_series",children:"Precisionsserie"}),r.jsx("option",{value:"application_series",children:"Tillämpningsserie"}),r.jsx("option",{value:"standard_medal",children:"Standardmedalj"}),r.jsx("option",{value:"competition_result",children:"Tävlingsresultat"}),r.jsx("option",{value:"qualification_result",children:"Kvalificering"}),r.jsx("option",{value:"team_event",children:"Lag-Event"}),r.jsx("option",{value:"event",children:"Event"}),r.jsx("option",{value:"custom",children:"Custom"})]})}),r.jsx("td",{className:"px-3 py-2",children:"competition_result"!==e.type||"ppc"!==String(e.disciplineType||"").toLowerCase()?r.jsxs("select",{value:e.weaponGroup,onChange:e=>g(t,"weaponGroup",e.target.value),className:"select w-full",disabled:p,"aria-label":`Vapengrupp för rad ${t+1}`,"aria-invalid":o||void 0,"aria-describedby":s.length?i:void 0,children:[r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]}):r.jsx("span",{className:"text-muted-foreground text-xs",children:"—"})}),r.jsxs("td",{className:"px-3 py-2",children:["precision_series"===e.type?r.jsx("input",{type:"number",min:"0",max:"50",value:e.points,onChange:e=>g(t,"points",e.target.value),className:"input w-full",placeholder:"0-50",disabled:p,"aria-label":`Poäng för rad ${t+1}`,"aria-invalid":c||void 0,"aria-describedby":s.length?i:void 0}):"application_series"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"date",value:e.date,onChange:e=>g(t,"date",e.target.value),className:"input w-full",disabled:p,"aria-label":`Datum för rad ${t+1}`,"aria-invalid":u||void 0,"aria-describedby":s.length?i:void 0}),r.jsxs("select",{value:""===e.timeSeconds?"":Number(e.timeSeconds),onChange:e=>g(t,"timeSeconds",""===e.target.value?"":Number(e.target.value)),className:"select w-full",disabled:p,"aria-label":`Tid för rad ${t+1}`,"aria-invalid":m||void 0,"aria-describedby":s.length?i:void 0,children:[r.jsx("option",{value:"",children:"Select time…"}),gr.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]}),r.jsx("input",{type:"number",min:"0",step:"1",value:e.hits,onChange:e=>g(t,"hits",e.target.value),className:"input w-full",placeholder:"Hits",disabled:p,"aria-label":`Träffar för rad ${t+1}`,"aria-invalid":h||void 0,"aria-describedby":s.length?i:void 0})]}):"standard_medal"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsxs("select",{value:e.disciplineType,onChange:e=>g(t,"disciplineType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Tävlinggren för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj disciplin..."}),pr.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsxs("select",{value:e.medalType,onChange:e=>g(t,"medalType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Medaljtyp för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj medalj..."}),xr.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsx("input",{type:"text",value:e.competitionName,onChange:e=>g(t,"competitionName",e.target.value),className:"input w-full",placeholder:"Tävlingsnamn (valfritt)",disabled:p,"aria-label":`Tävlingsnamn för rad ${t+1}`})]}):"competition_result"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsxs("select",{value:e.competitionType,onChange:e=>g(t,"competitionType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Tävlingstyp för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Select type…"}),mr.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsxs("select",{value:e.disciplineType,onChange:e=>g(t,"disciplineType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Gren för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj gren…"}),hr.map(e=>r.jsx("option",{value:e,children:e},e))]}),"ppc"===String(e.disciplineType||"")&&r.jsxs(r.Fragment,{children:[r.jsx("input",{type:"text",value:e.ppcClass,onChange:e=>g(t,"ppcClass",e.target.value),className:"input w-full",list:`ppc-classes-row-${t}`,placeholder:"PPC-klass",disabled:p,"aria-label":`PPC-klass för rad ${t+1}`}),r.jsx("datalist",{id:`ppc-classes-row-${t}`,children:fr.map(e=>r.jsx("option",{value:e},e))})]}),r.jsx("input",{type:"number",value:e.score,onChange:e=>g(t,"score",e.target.value),className:"input w-full",placeholder:"Poäng",disabled:p,"aria-label":`Poäng för rad ${t+1}`}),r.jsx("input",{type:"text",value:e.competitionName,onChange:e=>g(t,"competitionName",e.target.value),className:"input w-full",placeholder:"Tävlingsnamn (valfritt)",disabled:p,"aria-label":`Tävlingsnamn för rad ${t+1}`})]}):"qualification_result"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"text",value:e.weapon,onChange:e=>g(t,"weapon",e.target.value),className:"input w-full",placeholder:"Weapon",disabled:p,"aria-label":`Vapen för rad ${t+1}`}),r.jsx("input",{type:"number",value:e.score,onChange:e=>g(t,"score",e.target.value),className:"input w-full",placeholder:"Score",disabled:p,"aria-label":`Poäng för rad ${t+1}`})]}):"team_event"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"text",value:e.teamName,onChange:e=>g(t,"teamName",e.target.value),className:"input w-full",placeholder:"Lagnamn",disabled:p,"aria-label":`Lagamn för rad ${t+1}`}),r.jsx("input",{type:"number",min:"1",value:e.position,onChange:e=>g(t,"position",e.target.value),className:"input w-full",placeholder:"Placering",disabled:p,"aria-label":`Placering för rad ${t+1}`}),r.jsx("input",{type:"text",value:e.participants,onChange:e=>g(t,"participants",e.target.value),className:"input w-full",placeholder:"Deltagare (komma-separerad)",disabled:p,"aria-label":`Deltagara för rad ${t+1}`})]}):r.jsx("input",{type:"text",value:e.eventName,onChange:e=>g(t,"eventName",e.target.value),className:"input w-full",placeholder:"Event-namn / detaljer",disabled:p,"aria-label":`Event-namn för rad ${t+1}`}),s.length>0&&r.jsx("div",{id:i,role:"alert",className:"text-danger text-xs mt-1",children:s.join(", ")})]}),r.jsx("td",{className:"px-3 py-2",children:a.length>1&&r.jsx("button",{type:"button",onClick:()=>y(t),className:"btn btn-danger",disabled:p,"aria-label":`Ta bort rad ${t+1}`,children:"Ta bort"})})]},t)})})]})}),r.jsx("div",{className:"sm:hidden sticky bottom-0 safe-bottom bg-bg-secondary/80 backdrop-blur p-3 border-t border-border",children:r.jsx("button",{type:"submit",className:"btn btn-primary w-full min-h-[44px]",disabled:p||0===a.length,children:p?"Lägger till...":"Lägg till alla aktiviteter"})}),r.jsxs("div",{className:"hidden sm:flex gap-2 mb-4",children:[r.jsx("button",{type:"button",onClick:()=>{n([...a,yr()])},className:"btn btn-muted disabled:opacity-50",disabled:p,children:"+ Lägg till rad"}),r.jsx("button",{type:"submit",className:"btn btn-primary disabled:opacity-50",disabled:p||0===a.length,children:p?"Lägger till...":"Lägg till alla aktiviteter"})]})]}),r.jsx(tr,{open:s,onClose:()=>{i(!1),o(-1)},initialRow:l>=0?a[l]:yr(),onSave:(e,{addAnother:t}={})=>{n(l>=0?t=>t.map((t,r)=>r===l?e:t):t=>[...t,e]),t||(i(!1),o(-1))},WG:ur,COMP_TYPES:mr,MEDAL_TYPES:xr,APP_TIME_OPTIONS:gr,COMP_DISCIPLINE_TYPES:hr,PPC_CLASS_SUGGESTIONS:fr})]})})}const jr={precision_series:"Precisionsserier",application_series:"Tillämpningsserier",competition_result:"Tävlingsresultat",qualification_result:"Kvalifikation",team_event:"Lag-event",event:"Event",custom:"Övrigt",special_achievement:"Specialprestation",standard_medal:"Standardmedalj",running_shooting_course:"Springskytte",shooting_round:"Skytterunda",speed_shooting_series:"Snabbskytteserie",competition_performance:"Tävlingsprestation",air_pistol_precision:"Luftpistol precision",cumulative_competition_score:"Kumulativt tävlingsresultat"},wr=Object.keys(jr);function Nr(e){return jr[e]||e}function kr({achievement:e}){const{addAchievement:a,updateAchievement:n,removeAchievement:s}=cr(),[i,l]=t.useState(!1),[o,d]=t.useState("add"),[c,u]=t.useState(null),m=(e,{id:t,medalId:r}={})=>{const a={id:t,medalId:r,type:e.type,year:Number(e.year),weaponGroup:e.weaponGroup,date:e.date,notes:e.notes||""};switch(e.type){case"precision_series":return{...a,points:""===e.points?void 0:Number(e.points??0),competitionName:e.competitionName||void 0};case"application_series":return{...a,timeSeconds:""===e.timeSeconds?void 0:Number(e.timeSeconds??0),hits:""===e.hits?void 0:Number(e.hits??0)};case"standard_medal":return{...a,disciplineType:e.disciplineType||"",competitionName:e.competitionName||"",medalType:e.medalType||""};case"competition_result":return{...a,score:""===e.score?void 0:Number(e.score??0),competitionName:e.competitionName||"",competitionType:e.competitionType||"",disciplineType:e.disciplineType||"",ppcClass:e.ppcClass||""};case"qualification_result":return{...a,weapon:e.weapon||"",score:""===e.score?void 0:Number(e.score??0)};case"team_event":return{...a,teamName:e.teamName||"",position:""===e.position?void 0:Number(e.position??0),participants:String(e.participants||"").split(",").map(e=>e.trim()).filter(Boolean)};default:return{...a,eventName:e.eventName||""}}},p=Nr(e.type);return r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"card p-4 flex justify-between items-start",children:[r.jsxs("div",{children:[r.jsxs("div",{className:"flex gap-2 items-center mb-1",children:[r.jsx("span",{className:"font-semibold text-text-primary",children:p}),r.jsxs("span",{className:"text-xs px-2 py-1 rounded bg-bg-secondary text-text-secondary",children:["Grupp ",e.weaponGroup]})]}),r.jsxs("p",{className:"text-sm text-text-secondary",children:[(e.date||"").toString()," • ",e.points," points"]})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{onClick:()=>{var t;d("edit"),u({id:(t=e).id,type:t.type,year:t.year,weaponGroup:t.weaponGroup,date:t.date,points:t.points,timeSeconds:t.timeSeconds,hits:t.hits,competitionType:t.competitionType,disciplineType:t.disciplineType,ppcClass:t.ppcClass,competitionName:t.competitionName,weapon:t.weapon,score:t.score,teamName:t.teamName,position:t.position,participants:Array.isArray(t.participants)?t.participants.join(", "):t.participants||"",eventName:t.eventName,notes:t.notes}),l(!0)},className:"btn btn-muted text-sm","aria-label":`Ändra aktivitet ${e.id}`,children:"Ändra"}),r.jsx("button",{onClick:()=>{d("add");const t=(new Date).toISOString().slice(0,10);u({year:new Date(t).getFullYear(),weaponGroup:e.weaponGroup||"A",type:e.type||"precision_series",date:t,points:"",timeSeconds:"",hits:"",competitionType:"",disciplineType:"",ppcClass:"",competitionName:"",weapon:"",score:"",teamName:"",position:"",participants:"",eventName:"",notes:""}),l(!0)},className:"btn btn-primary text-sm","aria-label":`Logga ny aktivitet för märke ${e.medalId}`,children:"Logga"}),r.jsx("button",{onClick:async()=>{if(confirm("Delete this achievement?"))try{await s(e.id)}catch(t){console.error("Failed to delete:",t)}},className:"btn btn-muted text-red-600 text-sm","aria-label":`Ta bort aktivitet ${e.id}`,children:"Ta bort"})]})]}),r.jsx(tr,{open:i,onClose:()=>l(!1),initialRow:c,onSave:async t=>{try{if("edit"===o){const r=m(t,{id:e.id,medalId:e.medalId});await n(r)}else{const r=m(t,{medalId:e.medalId});await a(r)}l(!1)}catch(r){console.error("Misslyckades att spara:",r)}},mode:"immediate",submitLabel:"edit"===o?"Spara":"Lägg till"})]})}function Sr(e){const t=String(e??"");return t.includes(",")||t.includes('"')||t.includes("\n")?`"${t.replace(/"/g,'""')}"`:t}const Cr=["id","type","year","weaponGroup","points","date","timeSeconds","hits","competitionName","competitionType","disciplineType","ppcClass","weapon","score","teamName","position","eventName","notes","schema_version"];function Mr(e=[],t="1"){return[Cr.join(","),...(e||[]).map(e=>Cr.map(r=>"schema_version"===r?t:e?.[r]??"").map(Sr).join(","))].join("\n")}function Ar(e="1"){return[Cr.join(","),...wr.map(t=>{const r=function(e){const t={id:"",type:e,year:"2024",weaponGroup:"A",points:"",date:"",timeSeconds:"",hits:"",competitionName:"",competitionType:"",disciplineType:"",ppcClass:"",weapon:"",score:"",teamName:"",position:"",eventName:"",notes:Nr(e)};switch(e){case"precision_series":return{...t,points:"45"};case"application_series":return{...t,timeSeconds:"25",hits:"5"};case"competition_result":return{...t,date:"2024-05-20",score:"285",disciplineType:"precision",competitionType:"krets",competitionName:"Kretsmästerskap"};case"qualification_result":return{...t,date:"2024-06-15",score:"270",disciplineType:"national_whole_match"};case"team_event":return{...t,date:"2024-08-10",teamName:"Lag A",eventName:"Lagtävling",position:"2"};case"event":return{...t,date:"2024-09-01",eventName:"Skytte-event"};case"custom":return{...t,notes:"Egen aktivitet"};case"special_achievement":return{...t,date:"2024-07-20",notes:"Specialprestation - beskrivning"};case"standard_medal":return{...t,disciplineType:"precision",notes:"Standardmedalj brons"};case"running_shooting_course":return{...t,date:"2024-04-15",points:"85"};case"shooting_round":return{...t,points:"42"};case"speed_shooting_series":return{...t,points:"48"};case"competition_performance":return{...t,date:"2024-10-05",disciplineType:"field",score:"85",competitionName:"Fälttävling"};case"air_pistol_precision":return{...t,weaponGroup:"C",points:"92"};case"cumulative_competition_score":return{...t,score:"1250",competitionName:"Säsong 2024"};default:return t}}(t);return Cr.map(t=>"schema_version"===t?e:r[t]??"").map(Sr).join(",")})].join("\n")}function Tr(e,t="achievements.csv"){if("undefined"==typeof document)return;const r=new Blob([e],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(r),n=document.createElement("a");n.href=a,n.setAttribute("download",t),document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}function _r(){const{currentProfile:e}=ie(),[a,n]=t.useState(null),[s,i]=t.useState(null),[l,o]=t.useState(null),d=t.useMemo(()=>{if(!e?.prerequisites)return[];let t=[...e.prerequisites];return a&&(t=t.filter(e=>e.year===a)),s&&(t=t.filter(e=>e.type===s)),l&&(t=t.filter(e=>e.weaponGroup===l)),t.sort((e,t)=>new Date(t.date||"1970-01-01")-new Date(e.date||"1970-01-01"))},[e,a,s,l]),c=t.useMemo(()=>e?.prerequisites?[...new Set(e.prerequisites.map(e=>e.year))].sort((e,t)=>t-e):[],[e]),u=t.useMemo(()=>e?.prerequisites?[...new Set(e.prerequisites.map(e=>e.type))].sort():[],[e]);if(!e)return r.jsx("div",{className:"card p-4",children:r.jsx("p",{className:"text-foreground",children:"Välj en profil för att se aktiviteter"})});return r.jsx(Qt,{name:"historyTimeline",children:r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"card p-4",children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsx("h3",{className:"text-lg font-bold text-text-primary",children:"Filter"}),r.jsx("button",{onClick:()=>{Tr(Mr(d),"aktivitet-historik.csv")},className:"btn btn-primary text-sm","aria-label":"Exporta aktiviteter som CSV",children:"Exporta CSV"})]}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"År"}),r.jsxs("select",{value:a||"",onChange:e=>n(e.target.value?parseInt(e.target.value):null),className:"select",children:[r.jsx("option",{value:"",children:"Alla år"}),c.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Typ"}),r.jsxs("select",{value:s||"",onChange:e=>i(e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla typer"}),u.map(e=>r.jsx("option",{value:e,children:Nr(e)},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Vapengrupp"}),r.jsxs("select",{value:l||"",onChange:e=>o(e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla grupper"}),r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]})]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("h3",{className:"text-lg font-bold text-text-primary",children:[d.length," Aktivitet(er)"]}),0===d.length?r.jsx("div",{className:"card p-6 text-center",children:r.jsx("p",{className:"text-text-secondary",children:"Inga aktiviteter än"})}):r.jsx("div",{className:"space-y-3",children:d.map(e=>r.jsx(kr,{achievement:e},e.id))})]})]})})}const Pr=["locked","available","eligible","unlocked"],Ir={locked:{id:"locked",label:"Låst",description:"Förkrav ej uppfyllda.",icon:"Lock",className:"status-badge status--locked"},available:{id:"available",label:"Tillgänglig",description:"Medaljen är tillgänglig att påbörja.",icon:"Compass",className:"status-badge status--available"},eligible:{id:"eligible",label:"Kvalificerad",description:"Förkrav uppfyllda. Prestationskrav återstår.",icon:"BadgeCheck",className:"status-badge status--eligible"},unlocked:{id:"unlocked",label:"Upplåst",description:"Medaljen är erhållen.",icon:"Medal",className:"status-badge status--unlocked"}};function Dr(e){return Ir[e]||null}function Fr(){const{currentProfile:e}=ie(),a=t.useMemo(()=>e?.prerequisites?function(e){if(!e||0===e.length)return{totalAchievements:0,avgPointsPerYear:0,bestYear:null,yearsActive:0,pointsByYear:{}};const t={};e.forEach(e=>{const r=e.year;null!=r&&(t[r]||(t[r]=0),t[r]+=Number(e.points||0))});const r=Object.keys(t).map(Number).sort((e,t)=>e-t),a=r.length>0?r.reduce((e,r)=>t[r]>(t[e]??-1/0)?r:e,r[0]):null,n=a?t[a]:0,s=e.reduce((e,t)=>e+Number(t.points||0),0),i=Math.max(1,r.length);return{totalAchievements:e.length,avgPointsPerYear:s/i,bestYear:a,bestYearPoints:n,yearsActive:r.length,pointsByYear:t}}(e.prerequisites):{totalAchievements:0,avgPointsPerYear:0,bestYear:null,yearsActive:0},[e]),n=oe(),s=t.useMemo(()=>Pr.map(e=>{const t=Dr(e);return{key:e,label:t.label,icon:t.icon,count:Array.isArray(n?.[e])?n[e].length:0}}),[n]);return e?r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Totala Aktiviteter"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:a.totalAchievements})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Genomsnitt Poäng/År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:Number.isFinite(a.avgPointsPerYear)?a.avgPointsPerYear.toFixed(1):"0.0"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Bästa År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:a.bestYear||"-"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Aktiva År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:a.yearsActive})]}),s.map(({key:e,label:t,icon:a,count:n})=>r.jsxs("div",{className:"card p-4",children:[r.jsxs("p",{className:"text-sm text-muted-foreground font-semibold inline-flex items-center gap-2",children:[r.jsx(Ce,{name:a,className:"w-4 h-4","aria-hidden":"true"}),r.jsx("span",{children:t})]}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:n})]},e))]}):null}const qr=[{value:0,label:"Påminn mig aldrig",description:"Jag säkerhetskopierar manuellt"},{value:30,label:"Var 30:e dag",description:"Rekommenderas för de flesta användare"},{value:90,label:"Var 90:e dag",description:"För avancerade användare"}];function Er(){const{reminderFrequency:e,updateReminderFrequency:t,lastBackupDate:a}=Ue(),n=function(e,t="sv-SE"){return e?new Date(e).toLocaleString(t,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Aldrig"}(a);return r.jsxs("div",{className:"card p-6",children:[r.jsxs("div",{className:"mb-6",children:[r.jsx("h2",{className:"text-lg font-semibold text-color-text-primary mb-2",children:"Säkerhetskopieringspåminnelser"}),r.jsx("p",{className:"text-sm text-color-text-secondary",children:"Få påminnelser om att säkerhetskopiera dina uppgifter regelbundet"})]}),r.jsxs("fieldset",{className:"space-y-3 mb-6",children:[r.jsx("legend",{className:"sr-only",children:"Frekvens för säkerhetskopieringspåminnelser"}),qr.map(a=>{const n=e===a.value;return r.jsx("div",{className:`\n                p-4 rounded-lg border-2 transition-colors cursor-pointer\n                ${n?"border-color-primary bg-blue-50 dark:bg-blue-950":"border-color-border bg-color-bg-secondary hover:border-color-primary/50"}\n              `,children:r.jsxs("label",{className:"flex items-start gap-3 cursor-pointer",children:[r.jsx("input",{type:"radio",name:"backup-frequency",value:a.value,checked:n,onChange:()=>{return e=a.value,void t(e);var e},className:"\n                    mt-1 w-5 h-5\n                    text-color-primary\n                    focus-visible:ring-2 focus-visible:ring-offset-2\n                    focus-visible:ring-color-primary\n                  "}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("p",{className:"font-medium text-color-text-primary",children:a.label}),r.jsx("p",{className:"text-sm text-color-text-secondary mt-1",children:a.description})]})]})},a.value)})]}),r.jsx("div",{className:"p-4 rounded-lg bg-color-bg-secondary border border-color-border mb-6",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(Ce,{name:"Clock",className:"w-4 h-4 text-color-text-secondary","aria-hidden":"true"}),r.jsxs("p",{className:"text-sm text-color-text-secondary",children:["Senaste säkerhetskopia:"," ",r.jsx("span",{className:"font-medium text-color-text-primary",children:n})]})]})}),r.jsx("div",{className:"p-4 rounded-lg bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(Ce,{name:"Lightbulb",className:"w-5 h-5 text-blue-600 dark:text-blue-400 shrink-0 mt-0.5","aria-hidden":"true"}),r.jsxs("div",{children:[r.jsx("h3",{className:"font-semibold text-color-text-primary mb-2",children:"Så håller du dina uppgifter säkra"}),r.jsxs("ul",{className:"text-sm text-color-text-secondary space-y-1",children:[r.jsx("li",{children:"• Din data finns bara på den här enheten"}),r.jsx("li",{children:"• Exportera regelbundet för att undvika att förlora framsteg"}),r.jsx("li",{children:"• Lagra säkerhetskopior i iCloud Drive, Google Drive eller USB"}),r.jsx("li",{children:"• Flera säkerhetskopior = extra säkerhet"})]})]})]})})]})}function $r(){const{currentProfile:e,setProfileFeature:a}=ie(),[n,s]=t.useState("add");return e?r.jsx(ue,{children:r.jsxs("div",{className:"space-y-8",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold text-text-primary mb-2",children:"Inställningar"}),r.jsxs("p",{className:"text-text-secondary",children:["Profile: ",r.jsx("span",{className:"font-semibold",children:e.displayName})]})]}),r.jsx(Fr,{}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"section-title mb-2",children:"Funktioner"}),r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("input",{id:"ft-manual-unlock",type:"checkbox",className:"h-5 w-5 mt-0.5",checked:!!e?.features?.allowManualUnlock,onChange:e=>a("allowManualUnlock",e.target.checked)}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"ft-manual-unlock",className:"field-label mb-1",children:"Tillåt manuell upplåsning av märken (förhandskrav gäller fortfarande)"}),r.jsx("p",{className:"field-hint",children:"Du kan låsa upp märken vilket år som helst utan att möta kraven för dem. Förhandskrav och årskrav gäller fortfarande."})]})]}),r.jsx(Qt,{name:"enforceCurrentYearSetting",children:r.jsxs("div",{className:"flex items-start gap-3 mt-3",children:[r.jsx("input",{id:"ft-enforce-current-year",type:"checkbox",className:"h-5 w-5 mt-0.5",checked:!!e?.features?.enforceCurrentYearForSustained,onChange:e=>a("enforceCurrentYearForSustained",e.target.checked)}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"ft-enforce-current-year",className:"field-label mb-1",children:"Kräv innevarande år för återkommande märken"}),r.jsx("p",{className:"field-hint",children:"Märken som kräver återkommande aktiviteter kan bara låsas upp innevarande kalenderår."})]})]})})]}),r.jsx(Er,{}),r.jsxs("div",{className:"flex gap-2 border-b border-border",role:"tablist","aria-label":"Inställnings-sektion",children:[r.jsx("button",{role:"tab","aria-selected":"add"===n,onClick:()=>s("add"),className:"px-4 py-2 font-medium border-b-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary "+("add"===n?"border-primary text-primary":"border-transparent text-text-secondary hover:text-text-primary"),children:"Lägg till aktiviteter"}),r.jsx("button",{role:"tab","aria-selected":"history"===n,onClick:()=>s("history"),className:"px-4 py-2 font-medium border-b-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary "+("history"===n?"border-primary text-primary":"border-transparent text-text-secondary hover:text-text-primary"),children:"Historik"})]}),"add"===n&&r.jsx(vr,{}),"history"===n&&r.jsx(_r,{})]})}):r.jsx(Tt,{id:"profile-picker-settings"})}function Gr(){if("undefined"==typeof navigator||!navigator.share)return!1;const e=navigator.userAgent||"";if(!/Android|iPhone|iPad|iPod/.test(e))return!1;if(navigator.canShare)try{const e=new File(["test"],"test.txt",{type:"text/plain"});return navigator.canShare({files:[e]})}catch{return!1}return!0}function Br({blob:e,filename:a,onClose:n,onComplete:i}){const[l,o]=t.useState(null),{markBackupCreated:d}=Ue(),c=Gr(),u=function(){const e="undefined"!=typeof navigator?navigator.userAgent:"",t=/iPad|iPhone|iPod/.test(e),r=/Android/.test(e);return t?"Spara till iCloud Drive, Filer eller annan app":r?"Spara till Google Drive, Filer eller annan app":"Spara till molnlagring eller annan app"}(),m=t.useRef(n);t.useEffect(()=>{m.current=n},[n]),t.useEffect(()=>{const e=e=>{"Escape"===e.key&&m.current()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);const p=r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 bg-black/50 z-[2000]",onClick:n,"aria-hidden":"true"}),r.jsxs("div",{role:"dialog","aria-modal":"true","aria-labelledby":"share-backup-title",style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"min(90vw, 28rem)",maxHeight:"90vh",overflow:"auto",zIndex:2001},className:"\n          bg-bg-primary\n          border-2 border-border\n          rounded-xl shadow-2xl\n          p-6\n        ",children:[r.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[r.jsx("div",{className:"\n              w-12 h-12 rounded-full\n              bg-green-500\n              flex items-center justify-center\n            ","aria-hidden":"true",children:r.jsx("svg",{className:"w-7 h-7 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),r.jsx("h2",{id:"share-backup-title",className:"text-2xl font-bold text-foreground",children:"Säkerhetskopia skapad"})]}),r.jsxs("div",{className:"\n            mb-4 p-4 rounded-lg\n            bg-bg-secondary\n            border border-border\n          ",children:[r.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Fil sparad som:"}),r.jsx("p",{className:"font-mono text-sm text-foreground break-all",children:a})]}),r.jsxs("div",{className:"\n            mb-6 p-4 rounded-lg\n            bg-blue-50 dark:bg-blue-950\n            border border-blue-200 dark:border-blue-800\n          ",children:[r.jsxs("p",{className:"font-semibold text-foreground mb-2",children:["💾 ",c?u:"Spara din säkerhetskopia"]}),r.jsx("p",{className:"text-sm text-muted-foreground",children:c?'Tryck "Dela till molnet" för att spara i din molnlagring':"Ladda ner och ladda upp till din föredragna molnlagring"})]}),l&&r.jsx("div",{className:"\n              mb-4 p-3 rounded-lg\n              bg-red-50 dark:bg-red-950\n              border border-red-200 dark:border-red-800\n              text-red-800 dark:text-red-200\n            ",role:"alert","aria-live":"assertive",children:r.jsxs("div",{className:"flex items-start gap-2",children:[r.jsx("svg",{className:"w-5 h-5 shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),r.jsx("p",{className:"text-sm",children:l})]})}),r.jsxs("div",{className:"space-y-2",children:[c&&r.jsxs("button",{onClick:async()=>{let t;try{t=await async function(e,t){if(!Gr())throw new Error("Fildelning stöds inte på den här enheten");const r=new File([e],t,{type:"text/plain"});try{return await navigator.share({files:[r]}),{success:!0}}catch(l){if(console.error("Share failed:",{name:l.name,message:l.message,error:l,fileType:r.type,fileSize:r.size,fileName:r.name}),"AbortError"===l.name)return{success:!1,cancelled:!0};throw new Error(`Delning misslyckades: ${l.name} - ${l.message}`)}}(e,a)}catch(r){return void o(r.message||"Delning misslyckades")}if(t.success)try{await d(),i&&i()}catch(r){o(r.message||"Kunde inte markera säkerhetskopia som skapad")}},className:"\n                w-full py-3 rounded-lg font-medium\n                bg-primary text-primary-foreground\n                hover:bg-primary/90\n                focus-visible:outline-none focus-visible:ring-2\n                focus-visible:ring-offset-2 focus-visible:ring-primary\n                flex items-center justify-center gap-2\n                min-h-[44px]\n              ",children:[r.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"})}),"Dela till molnet"]}),r.jsxs("button",{onClick:async()=>{try{const t=URL.createObjectURL(e),r=document.createElement("a");r.href=t,r.download=a,r.click(),URL.revokeObjectURL(t),await d(),i&&i()}catch(t){o(t.message||"Nedladdning misslyckades")}},className:"\n              w-full py-3 rounded-lg font-medium\n              bg-bg-secondary text-foreground\n              border-2 border-border\n              hover:bg-bg-tertiary\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-border\n              flex items-center justify-center gap-2\n              min-h-[44px]\n            ",children:[r.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","aria-hidden":"true",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Ladda ner till enhet"]}),r.jsx("button",{onClick:n,className:"\n              w-full py-2 text-muted-foreground\n              hover:text-foreground\n              focus-visible:outline-none focus-visible:ring-2\n              focus-visible:ring-offset-2 focus-visible:ring-border\n              rounded\n            ",children:"Stäng"})]})]})]});return s.createPortal(p,document.body)}function Lr({profile:e}){const[a,n]=t.useState(!1),[s,i]=t.useState(!1),[l,o]=t.useState(null),[d,c]=t.useState(!1),[u,m]=t.useState(null),[p,h]=t.useState("");return r.jsxs("div",{children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-3",children:"Säkerhetskopiera profil"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Ladda ner en komplett säkerhetskopia av din profil som en JSON-fil. Innehåller alla dina aktiviteter och upplåsta märken."}),r.jsx("button",{onClick:async()=>{try{n(!0),o(null);const t=(new Date).toISOString().split("T")[0],r=await He(e,{version:"1.0"}),a=`medal-backup-${t}.txt`,s=new Blob([r],{type:"application/json;charset=utf-8"});m(s),h(a),c(!0)}catch(t){console.error("Backup-fel:",t),o(t.message||"Säkerhetskopieringen misslyckades")}finally{n(!1)}},disabled:a,className:"btn btn-primary w-full min-h-[44px]","aria-label":"Säkerhetskopiera profil",children:a?"Skapar säkerhetskopia...":"Säkerhetskopiera profil"}),s&&r.jsxs("div",{className:"alert alert-success mt-4 flex items-center gap-2",role:"status","aria-live":"polite",children:[r.jsx("span",{"aria-hidden":"true",children:"✓"}),r.jsx("span",{children:"Säkerhetskopieringen lyckades!"})]}),l&&r.jsxs("div",{className:"alert alert-error mt-4 flex items-center gap-2",role:"alert","aria-live":"assertive",children:[r.jsx("span",{"aria-hidden":"true",children:"✕"}),r.jsx("span",{children:l})]}),d&&u&&r.jsx(Br,{blob:u,filename:p,onClose:()=>c(!1),onComplete:()=>{c(!1),i(!0),setTimeout(()=>i(!1),3e3)}})]})}function Yr({open:a,onClose:n,shareData:s}){const[i,l]=t.useState(null),[o,d]=t.useState(null),[c,u]=t.useState(!1);t.useEffect(()=>{a&&(async()=>{try{d(null);const t=await async function(t,r={}){const a="string"==typeof t?t:JSON.stringify(t);try{const t=await e(()=>import("./vendor-BbIsC1Kr.js").then(e=>e.b),[]).catch(()=>null);if(t&&t.toDataURL)return await t.toDataURL(a,{errorCorrectionLevel:"M",width:r.width||256,margin:2})}catch{}return`data:text/plain;base64,${("undefined"!=typeof globalThis&&globalThis.Buffer&&"function"==typeof globalThis.Buffer.from?globalThis.Buffer.from(a,"utf8").toString("base64"):"function"==typeof btoa?btoa(unescape(encodeURIComponent(a))):"")||""}`}(s);l(t)}catch(t){d(t.message||"Misslyckades att skapa QR-kod")}})()},[a,s]);const m="string"==typeof s?s:s?.link||"";return a?r.jsx("div",{className:"\n        fixed inset-0 bg-black/50 flex items-center justify-center p-4\n      ",role:"dialog","aria-modal":"true","aria-label":"Share progress dialog",onClick:n,children:r.jsxs("div",{className:"w-full max-w-md p-6 rounded-lg bg-bg-secondary border border-border",onClick:e=>e.stopPropagation(),children:[r.jsx("h2",{className:"text-xl font-bold text-foreground mb-4",children:"Dela dina framsteg"}),o&&r.jsx("div",{className:"alert alert-error mb-4",role:"alert","aria-live":"assertive",children:o}),!o&&r.jsxs("div",{className:"flex flex-col items-center",children:[i?r.jsx("img",{src:i,alt:"QR code for sharing progress",className:"w-48 h-48"}):r.jsx("div",{className:"w-48 h-48 flex items-center justify-center border border-dashed border-border rounded",children:r.jsx("span",{className:"text-muted-foreground",children:"Skapar..."})}),r.jsx("div",{className:"w-full mt-4",children:r.jsxs("div",{className:"flex gap-2",children:[r.jsx("input",{type:"text",readOnly:!0,value:m,className:"input flex-1","aria-label":"Share link"}),r.jsx("button",{onClick:async()=>{try{if(!m)return;await navigator.clipboard.writeText(m),u(!0),setTimeout(()=>u(!1),2e3)}catch{d("Misslyckades att kopiera länk")}},className:"btn btn-primary min-w-[96px] min-h-[44px]","aria-label":"Copy share link",children:c?"Kopierad":"Kopiera"})]})})]}),r.jsx("div",{className:"mt-6 flex justify-end",children:r.jsx("button",{onClick:n,className:"btn btn-muted min-h-[44px]","aria-label":"Stäng delningsdialogen",children:"Stäng"})})]})}):null}function Rr(){return r.jsxs("div",{className:"\n        p-6 rounded-lg\n        bg-bg-secondary\n        border-2 border-border\n      ",role:"region","aria-labelledby":"restore-guide-title",children:[r.jsx("h3",{id:"restore-guide-title",className:"text-xl font-bold text-foreground mb-4",children:"📖 Så här återställer du från molnet"}),r.jsxs("ol",{className:"space-y-4 text-muted-foreground",children:[r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"1"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Ladda ner din säkerhetskopia"}),r.jsx("p",{className:"text-sm",children:"Hitta din säkerhetskopia i iCloud Drive, Google Drive, OneDrive eller var du sparade den. Ladda ner filen till den här enheten."})]})]}),r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"2"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Öppna den här appen"}),r.jsx("p",{className:"text-sm",children:"Navigera till Inställningar → Data & Säkerhetskopia (eller använd återställningsknappen ovan)."})]})]}),r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"3"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Välj din säkerhetskopia"}),r.jsxs("p",{className:"text-sm",children:['Klicka på "Återställ från säkerhetskopia" och välj den nedladdade filen (t.ex. ',r.jsx("code",{className:"text-xs bg-bg-tertiary px-1.5 py-0.5 rounded font-mono",children:"medal-backup-2026-01-06.json"}),")."]})]})]}),r.jsxs("li",{className:"flex gap-3",children:[r.jsx("span",{className:"\n              flex-shrink-0 w-8 h-8 rounded-full\n              bg-primary text-primary-foreground\n              flex items-center justify-center\n              font-bold text-sm\n            ","aria-hidden":"true",children:"4"}),r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold text-foreground mb-1",children:"Bekräfta återställning"}),r.jsx("p",{className:"text-sm",children:'Granska förhandsgranskningen (datum, antal aktiviteter) och klicka "Återställ nu". Dina data återställs omedelbart.'})]})]})]}),r.jsxs("div",{className:"\n          mt-6 p-4 rounded-lg\n          bg-blue-50 dark:bg-blue-950\n          border border-blue-200 dark:border-blue-800\n        ",children:[r.jsx("p",{className:"text-sm font-semibold text-foreground mb-2",children:"💡 Proffsråd"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Håll flera säkerhetskopior på olika platser (molnlagring + USB-minne) för extra säkerhet. Säkerhetskopiera regelbundet för att undvika dataförlust."})]})]})}const Or=["id","type","year","weaponGroup","points","date","timeSeconds","hits","competitionName","competitionType","disciplineType","ppcClass","weapon","score","teamName","position","eventName","notes","schema_version"];function Vr(e){const t=[];let r="",a=!1;for(let n=0;n<e.length;n++){const s=e[n];'"'===s?a&&'"'===e[n+1]?(r+='"',n++):a=!a:","!==s||a?r+=s:(t.push(r),r="")}return t.push(r),t.map(e=>e.trim())}function Ur(e){if(null==e||""===e)return;const t=String(e).replace(",","."),r=Number(t);return Number.isFinite(r)?r:void 0}function zr(e){return null==e?void 0:String(e).trim().toLowerCase()}function Kr(e){if(null==e||""===String(e).trim())return"A";const t=String(e).trim().toUpperCase();return"A1"===t||"A2"===t||"A3"===t?"A":"LUFTPISTOL"===t||"LUFT"===t||"LP"===t?"C":t}function Hr(e){const t={};for(const r of Object.keys(e)){const a=r.trim(),n=e[r];switch(a){case"type":t.type=zr(n);break;case"year":t.year=Ur(n);break;case"weaponGroup":t.weaponGroup=Kr(n);break;case"points":t.points=Ur(n);break;case"timeSeconds":t.timeSeconds=Ur(n);break;case"hits":t.hits=Ur(n);break;case"score":t.score=Ur(n);break;case"position":t.position=Ur(n);break;case"competitionType":case"disciplineType":case"weapon":case"teamName":case"competitionName":case"eventName":case"notes":case"date":{const e="string"==typeof n?n.trim():n;t[a]="competitionType"===a||"disciplineType"===a||"weapon"===a?zr(e):e;break}case"ppcClass":t.ppcClass="string"==typeof n?n.trim():n;break;case"id":t.id=String(n||"").trim()||void 0}}return t}function Wr(e){const t=function(e=""){return String(e).replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n")}(e).filter(Boolean);if(!t.length)return{rows:[],errors:["Empty file"]};const r=Vr(t[0]).map(e=>e.trim()),a=r.filter(e=>!Or.includes(e)),n=[],s=a.length?[`Okända rubriker: ${a.join(", ")}`]:[];for(let i=1;i<t.length;i++){const e=Vr(t[i]),a={};for(let t=0;t<r.length;t++)a[r[t]]=e[t]??"";n.push(Hr(a))}return{rows:n,errors:s}}function Xr(e,t){const r=e&&"string"==typeof e&&""!==e.trim(),a="number"==typeof t&&!Number.isNaN(t);if(r){return{date:e,year:function(e){if(!e||"string"!=typeof e)return;const t=e.match(/^(\d{4})-\d{2}-\d{2}$/);return t?Number(t[1]):void 0}(e)??t}}return a?{date:`${t}-01-01`,year:t}:{date:void 0,year:void 0}}function Jr(e){const t=(r=e.type,a=e.weaponGroup,"air_pistol_precision"===r?"C":a||"A");var r,a;const{date:n,year:s}=Xr(e.date,e.year);return{id:e.id,type:e.type,year:s,weaponGroup:t,points:e.points,date:n,timeSeconds:e.timeSeconds,hits:e.hits,competitionName:e.competitionName,competitionType:e.competitionType,disciplineType:e.disciplineType,ppcClass:e.ppcClass,weapon:e.weapon,score:e.score,teamName:e.teamName,position:e.position,eventName:e.eventName,notes:e.notes}}function Zr({profile:e,updateProfile:a,upsertAchievements:n}){const[s,i]=t.useState(!1),[l,o]=t.useState(null),[d,c]=t.useState(null),[u,m]=t.useState(null),[p,h]=t.useState(null),[f,x]=t.useState({updateById:!0,matchNaturalKey:!1,addNew:!0}),g=t.useRef(null),[b,y]=t.useState(""),[v,j]=t.useState(null),w=t.useRef(n);w.current=n;const N=t.useMemo(()=>Array.isArray(e?.prerequisites)?e.prerequisites:[],[e?.prerequisites]);return t.useEffect(()=>{if(!d||0===d.length)return;let e=!1;return async function(){i(!0);try{const t=await w.current(d,{...f,dryRun:!0});e||m({rows:d,result:t})}catch(t){e||o(t.message||"Kunde inte validera CSV")}finally{e||i(!1)}}(),()=>{e=!0}},[f,d]),r.jsxs("div",{className:"card p-4 md:col-span-2",role:"region","aria-labelledby":"csv-title",children:[r.jsx("h2",{id:"csv-title",className:"text-lg font-semibold text-foreground mb-3",children:"CSV (Aktiviteter)"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Exportera, redigera och importera aktiviteter via CSV. För säkerhet körs en förhandsgranskning först."}),r.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[r.jsx("button",{onClick:function(){try{Tr(Mr(N,"1"),"aktiviteter.csv"),o(null)}catch(e){o(e.message||"Export av CSV misslyckades")}},className:"btn btn-primary min-h-[44px]","aria-label":"Exportera aktiviteter som CSV",children:"Exportera aktiviteter (CSV)"}),r.jsx("button",{onClick:function(){try{Tr(Ar("1"),"aktiviteter_mall.csv"),o(null)}catch(e){o(e.message||"Nedladdning av mall misslyckades")}},className:"btn btn-secondary min-h-[44px]","aria-label":"Ladda ned CSV-mall",children:"Ladda ned CSV-mall"})]}),r.jsxs("div",{className:"p-4 rounded-lg border border-border bg-bg-primary",role:"group","aria-labelledby":"csv-import-label",children:[r.jsx("div",{id:"csv-import-label",className:"field-label mb-2",children:"Importera från CSV"}),r.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:()=>g.current?.click(),children:"Välj CSV-fil"}),r.jsx("span",{className:"text-sm text-muted-foreground",children:b||"Ingen fil vald"}),r.jsx("input",{ref:g,type:"file",accept:".csv",className:"hidden",onChange:e=>e.target.files?.[0]&&async function(t){if(t){o(null),h(null),m(null),c(null),i(!0);try{const e=Wr(await t.text());if(e.errors?.length)return void o(e.errors.join("; "));const r=e.rows.map(Jr);c(r);const a=await n(r,{...f,dryRun:!0});m({rows:r,result:a}),y(t.name)}catch(e){o(e.message||"Kunde inte läsa/validera CSV")}finally{i(!1)}}}(e.target.files[0])}),u&&r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:function(){o(null),c(null),m(null),h(null),y(""),g.current&&(g.current.value="")},children:"Rensa"})]}),r.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-3 gap-2",children:[r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:f.updateById,onChange:e=>x(t=>({...t,updateById:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Uppdatera via ID"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:f.matchNaturalKey,onChange:e=>x(t=>({...t,matchNaturalKey:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Matcha utan ID via nyckel (avancerat)"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:f.addNew,onChange:e=>x(t=>({...t,addNew:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Lägg till nya rader"})]})]})]}),s&&r.jsx("div",{className:"alert alert-info mt-3",role:"status","aria-live":"polite",children:"Bearbetar..."}),l&&r.jsx("div",{className:"alert alert-error mt-3",role:"alert","aria-live":"assertive",children:l}),u&&!l&&r.jsxs("div",{className:"mt-3",children:[r.jsxs("div",{className:"alert alert-warning",role:"status","aria-live":"polite",children:[r.jsx("strong",{children:"Förhandsgranskning:"})," inga ändringar har gjorts än."]}),r.jsxs("div",{className:"mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2",children:[r.jsxs("div",{className:"flex items-center gap-2 p-2 rounded-lg bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800",children:[r.jsx(Ce,{name:"Plus",className:"w-4 h-4 text-green-600 dark:text-green-400","aria-hidden":"true"}),r.jsxs("span",{className:"text-sm text-green-800 dark:text-green-200",children:[r.jsx("strong",{children:u.result.added})," tillägg"]})]}),r.jsxs("div",{className:"flex items-center gap-2 p-2 rounded-lg bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800",children:[r.jsx(Ce,{name:"RefreshCw",className:"w-4 h-4 text-blue-600 dark:text-blue-400","aria-hidden":"true"}),r.jsxs("span",{className:"text-sm text-blue-800 dark:text-blue-200",children:[r.jsx("strong",{children:u.result.updated})," uppdateringar"]})]}),r.jsxs("div",{className:"flex items-center gap-2 p-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700",children:[r.jsx(Ce,{name:"SkipForward",className:"w-4 h-4 text-gray-500 dark:text-gray-400","aria-hidden":"true"}),r.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-300",children:[r.jsx("strong",{children:u.result.skipped})," överhoppade"]})]}),r.jsxs("div",{className:"flex items-center gap-2 p-2 rounded-lg "+(u.result.failed>0?"bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-800":"bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700"),children:[r.jsx(Ce,{name:u.result.failed>0?"XCircle":"CheckCircle",className:"w-4 h-4 "+(u.result.failed>0?"text-red-600 dark:text-red-400":"text-gray-500 dark:text-gray-400"),"aria-hidden":"true"}),r.jsxs("span",{className:"text-sm "+(u.result.failed>0?"text-red-800 dark:text-red-200":"text-gray-600 dark:text-gray-300"),children:[r.jsx("strong",{children:u.result.failed})," fel"]})]})]}),u.result.errors?.length>0&&r.jsxs("details",{className:"mt-3",open:u.result.errors.length<=10,children:[r.jsxs("summary",{className:"cursor-pointer text-sm font-medium text-red-700 dark:text-red-300 flex items-center gap-2",children:[r.jsx(Ce,{name:"AlertTriangle",className:"w-4 h-4","aria-hidden":"true"}),"Visa ",u.result.errors.length," rad(er) med fel"]}),r.jsx("div",{className:"mt-2 max-h-64 overflow-auto rounded-lg border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-950",children:r.jsxs("table",{className:"w-full text-sm",children:[r.jsx("thead",{className:"sticky top-0 bg-red-100 dark:bg-red-900",children:r.jsxs("tr",{children:[r.jsx("th",{scope:"col",className:"text-left px-3 py-2 text-red-800 dark:text-red-200 font-medium",children:"Rad"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2 text-red-800 dark:text-red-200 font-medium",children:"Fel"}),r.jsx("th",{scope:"col",className:"hidden sm:table-cell text-left px-3 py-2 text-red-800 dark:text-red-200 font-medium",children:"Data"})]})}),r.jsx("tbody",{children:u.result.errors.map((e,t)=>r.jsxs("tr",{className:"border-t border-red-200 dark:border-red-800",children:[r.jsxs("td",{className:"px-3 py-2 text-red-700 dark:text-red-300 font-mono whitespace-nowrap",children:["#",e.row]}),r.jsx("td",{className:"px-3 py-2 text-red-700 dark:text-red-300",children:e.error}),r.jsxs("td",{className:"hidden sm:table-cell px-3 py-2 text-red-600 dark:text-red-400 font-mono text-xs max-w-xs truncate",title:JSON.stringify(e.record),children:[e.record?.type||"?",", ",e.record?.year||"?",", ",e.record?.weaponGroup||"?",null!=e.record?.points&&`, p:${e.record.points}`,null!=e.record?.score&&`, s:${e.record.score}`]})]},t))})]})})]}),r.jsx("button",{onClick:async function(){if(u?.rows?.length){i(!0),o(null),h(null);try{j({userId:e.userId,prerequisites:Array.isArray(e.prerequisites)?[...e.prerequisites]:[]});const t=await n(u.rows,{...f,dryRun:!1});h(t),m(null)}catch(t){o(t.message||"Import av CSV misslyckades")}finally{i(!1)}}},disabled:s||0===u.result.added&&0===u.result.updated,className:"btn btn-primary w-full mt-3 min-h-[44px]","aria-describedby":u.result.failed>0&&(u.result.added>0||u.result.updated>0)?"csv-import-warning":void 0,children:0===u.result.added&&0===u.result.updated?"Inget att importera":`Bekräfta import (${u.result.added+u.result.updated} rader)`}),u.result.failed>0&&(u.result.added>0||u.result.updated>0)&&r.jsx("p",{id:"csv-import-warning",className:"mt-2 text-xs text-muted-foreground",children:"Rader med fel kommer att hoppas över vid import."})]}),p&&r.jsxs("div",{className:"mt-3",children:[r.jsxs("div",{className:"alert alert-success",role:"status","aria-live":"polite",children:["Import klar: ",p.added," tillagda, ",p.updated," uppdaterade, ",p.skipped," överhoppade, ",p.failed," fel."]}),r.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:async function(){try{if(!v)return;const t={...e,prerequisites:v.prerequisites,lastModified:(new Date).toISOString()};await a(t),j(null),h(null)}catch(t){o(t.message||"Ångra misslyckades")}},children:"Ångra import"})})]}),r.jsxs("details",{className:"mt-4",children:[r.jsx("summary",{className:"cursor-pointer text-sm text-foreground",children:"Hjälp: Kolumner och arbetsflöde"}),r.jsxs("div",{className:"mt-2 text-sm text-muted-foreground space-y-2",children:[r.jsxs("p",{children:["Arbetsflöde: 1) Exportera aktiviteter, 2) Redigera i kalkylark, 3) Importera CSV. Behåll kolumnen ",r.jsx("code",{children:"id"})," för att uppdatera rader; nya rader kan lämna ",r.jsx("code",{children:"id"})," tomt."]}),r.jsx("p",{children:"Tillåtna kolumner (valfria där det inte krävs): id, type, year, weaponGroup, points, date, timeSeconds, hits, competitionName, competitionType, medalType, disciplineType, weapon, score, teamName, position, eventName, notes, schema_version."}),r.jsx("p",{children:"Standardmatchning: Uppdatera via ID. Alternativt kan du matcha utan ID via naturlig nyckel (avancerat)."})]})]})]})}function Qr(){const{currentProfile:e,updateProfile:a,error:n,upsertAchievements:s}=ie(),[i,l]=t.useState(!1),[d,c]=t.useState(null),[u,m]=t.useState(null),[p,h]=t.useState(!1),f=t.useMemo(()=>!!e,[e]);return r.jsxs("div",{className:"max-w-6xl mx-auto p-4",children:[r.jsx("h1",{className:"section-title mb-4",children:"Data & Säkerhetskopia"}),(n||u)&&r.jsx("div",{className:"alert alert-error mb-4",role:"alert","aria-live":"assertive",children:n||u}),f?r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r.jsx("div",{className:"card md:row-span-2 p-4",children:r.jsx(Lr,{profile:e})}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-3",children:"Återställ från säkerhetskopia"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Återställ en hel profil från en säkerhetskopia. Du kan skapa en ny profil eller ersätta en profil med samma ID."}),r.jsx("button",{onClick:()=>h(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Återställ från säkerhetskopia"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-3",children:"Dela profil"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Skapa en QR-kod som innehåller profilen för att dela eller göra backup."}),r.jsx("button",{onClick:async()=>{try{m(null);const t=await He(e,{version:"1.0"});c(t),l(!0)}catch(t){m(t.message||"Misslyckades med förberedelser för att dela data")}},className:"btn btn-primary min-h-[44px]","aria-label":"Öppna delningsdialog",children:"Dela via QR-kod"})]}),r.jsx(Qt,{name:"csvImport",className:"md:col-span-2",children:r.jsx(Zr,{profile:e,updateProfile:a,upsertAchievements:s})})]}):r.jsxs("div",{className:"card p-6",children:[r.jsx("p",{className:"text-muted-foreground",children:"Välj eller skapa en profil för att säkerhetskopiera/återställa data."}),r.jsx("div",{className:"mt-4",children:r.jsx(o,{to:"/settings",className:"btn btn-primary min-h-[44px]",children:"Till Inställningar"})})]}),f&&r.jsx("div",{className:"mt-6",children:r.jsx(Rr,{})}),r.jsx(Yr,{open:i,onClose:()=>l(!1),shareData:d}),r.jsx(Ae,{id:"profile-import-dialog",open:p,onClose:()=>h(!1)})]})}function ea({open:e,onClose:a}){const n=t.useContext(pe)??{get:()=>"off",enabled:()=>!1,all:()=>({}),set:()=>{},setMany:()=>{},clear:()=>{},clearAll:()=>{},saveToProfile:async()=>!1,clearProfileOverrides:async()=>!1},{currentProfile:i,hydrated:l}=ie(),[o,d]=t.useState(!1),[c,u]=t.useState(""),[m,p]=t.useState(()=>n.all()),h=t.useMemo(()=>Object.keys(me||n.all()||{}).map(e=>({name:e,state:m[e]??n.get(e)??"off",meta:me?.[e]||{}})),[m,n]);if(!e)return null;const f="idkfa"===c,x="admin-flags-heading",g=r.jsx("div",{className:"fixed inset-0 z-50 grid place-items-center p-4 sm:p-6 bg-black/50",onClick:a,onKeyDown:e=>{"Escape"===e.key&&a?.(),!o&&"Enter"===e.key&&f&&d(!0)},role:"dialog","aria-modal":"true","aria-labelledby":x,children:r.jsx("div",{className:"card flex-none w-full max-w-[calc(100vw-2rem)] sm:max-w-[calc(100vw-3rem)] md:max-w-3xl min-w-[20rem] p-4 md:p-6 mx-auto overflow-auto max-h-[calc(100dvh-3rem)]",onClick:e=>e.stopPropagation(),children:o?r.jsxs(r.Fragment,{children:[r.jsx("h2",{id:x,className:"section-title mb-2",children:"Feature-flaggor"}),r.jsxs("div",{className:"space-y-3 max-h-[60vh] overflow-auto pr-1",children:[h.map(e=>r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-[minmax(0,1fr)_12rem] md:grid-cols-[minmax(0,1fr)_14rem] items-start sm:items-center gap-2 sm:gap-4",children:[r.jsxs("div",{className:"min-w-0",children:[r.jsx("div",{className:"font-medium",children:e.meta.title||e.name}),e.meta.message&&r.jsx("div",{className:"text-xs text-muted-foreground",children:e.meta.message})]}),r.jsx("label",{className:"sr-only",htmlFor:`flag-${e.name}`,children:e.meta.title||e.name}),r.jsxs("select",{id:`flag-${e.name}`,className:"select w-full",value:m[e.name]??"off",onChange:t=>p(r=>({...r,[e.name]:t.target.value})),children:[r.jsx("option",{value:"off",children:"Off"}),r.jsx("option",{value:"preview",children:"Preview"}),r.jsx("option",{value:"on",children:"On"})]})]},e.name)),0===h.length&&r.jsx("div",{className:"text-sm text-muted-foreground",children:"Inga flaggor hittades."})]}),r.jsxs("div",{className:"flex gap-2 justify-between mt-4 safe-bottom",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:async()=>{n.clearAll(),p({}),l&&i&&await(n.clearProfileOverrides?.()),a?.()},children:"Återställ till default"}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:a,children:"Stäng"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:async()=>{n.setMany(m),l&&i&&await(n.saveToProfile?.(m)),a?.()},children:"Spara"})]})]})]}):r.jsxs(r.Fragment,{children:[r.jsx("h2",{id:x,className:"section-title mb-2",children:"Admin-läge"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Ange lösenord för att hantera feature-gates."}),r.jsx("label",{className:"field-label sr-only",htmlFor:"admin-password",children:"Lösenord"}),r.jsx("input",{id:"admin-password",type:"password",className:"input mb-3",placeholder:"Lösenord",value:c,onChange:e=>u(e.target.value),autoFocus:!0}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:a,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>f&&d(!0),disabled:!f,children:"Fortsätt"})]})]})})});return s.createPortal(g,document.body)}function ta(){const e="undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/",[a,n]=t.useState(!1),s=i(),o=l(),d=(()=>{const e=qt();return Et()!==e})();return r.jsxs("div",{className:"max-w-3xl mx-auto px-4 sm:px-6 py-6",children:[r.jsxs("article",{className:"prose prose-headings:text-foreground prose-p:text-foreground prose-a:text-primary dark:prose-invert max-w-none",children:[r.jsxs("header",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:Ee}),r.jsx("p",{className:"mt-2 text-muted-foreground",children:"Spåra dina skyttemärken och medaljer enligt Svenska Pistolskytteförbundets regler"})]}),r.jsx(Je,{id:"disclaimer-about",variant:"warning",text:"Fristående app. Regelboken gäller före appen.",linkUrl:qe}),r.jsxs("section",{"aria-labelledby":"about-links",className:"mt-8",children:[r.jsx("h2",{id:"about-links",className:"text-2xl font-semibold",children:"Användbara länkar"}),r.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[r.jsx("li",{children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary inline-flex items-center min-h-[44px]",href:Ie,target:"_blank",rel:"noreferrer noopener",children:"SPSF"})}),r.jsx("li",{children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary inline-flex items-center min-h-[44px]",href:De,target:"_blank",rel:"noreferrer noopener",children:"GitHub-projekt"})})]})]}),r.jsxs("section",{"aria-labelledby":"about-author",className:"mt-8",children:[r.jsx("h2",{id:"about-author",className:"text-2xl font-semibold",children:"Skapare"}),r.jsx("p",{className:"mt-2",children:$e})]}),r.jsxs("section",{"aria-labelledby":"about-support",className:"mt-8",children:[r.jsx("h2",{id:"about-support",className:"text-2xl font-semibold",children:"Stötta projektet"}),r.jsx("p",{className:"mt-2",children:"Gillar du appen? Bjud utvecklaren på en kaffe."}),r.jsx("p",{className:"mt-2",children:r.jsx("a",{className:"inline-flex items-center rounded focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:Fe,target:"_blank",rel:"noreferrer noopener","aria-label":"Köp en kaffe (öppnas i ny flik)",children:r.jsx("img",{src:"https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png",alt:"Köp en kaffe",height:"48",className:"h-12",loading:"lazy"})})})]}),r.jsxs("section",{"aria-labelledby":"about-version",className:"mt-8",children:[r.jsxs("h2",{id:"about-version",className:"text-2xl font-semibold",children:[r.jsx("button",{type:"button",className:"inline p-0 m-0 bg-transparent decoration-dotted underline-offset-4 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",onClick:()=>n(!0),"aria-label":"Öppna admin",children:"Om"})," ","versionen"]}),r.jsxs("p",{className:"mt-2",children:["Den här versionen använder skjuthandboken upplaga: ",r.jsx("strong",{children:Ye})," (2024)"]}),r.jsxs("p",{className:"mt-2 text-muted-foreground",children:["Version: ",r.jsx("code",{children:ge.version})," • Build: ",r.jsx("code",{children:ge.number})," • Commit: ",r.jsx("code",{children:ge.commit})]}),r.jsxs("p",{className:"mt-1 text-muted-foreground",children:["Byggtid: ",r.jsx("time",{dateTime:ge.timeISO,children:new Date(ge.timeISO).toLocaleString()})]}),r.jsx("div",{className:"mt-3",children:r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>o("/whats-new",{state:{backgroundLocation:s}}),"aria-label":"Visa vad som är nytt",children:d?"Visa nyheter (Ny)":"Visa nyheter"})})]}),r.jsxs("section",{"aria-labelledby":"about-license",className:"mt-8",children:[r.jsx("h2",{id:"about-license",className:"text-2xl font-semibold",children:"Licens"}),r.jsxs("p",{className:"mt-2",children:["Denna applikation är licensierad under ",r.jsx("strong",{children:Ge}),". Se ",r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:`${e}LICENSE`,target:"_blank",rel:"noreferrer noopener",children:"LICENSE"})," för fullständig text."]})]})]}),r.jsx(ea,{open:a,onClose:()=>n(!1)})]})}function ra(){const e=l(),a=t.useCallback(()=>{we("medals"),e("/medals")},[e]),n=t.useCallback(()=>{we("tree-view"),e("/skill-tree")},[e]);return r.jsxs("div",{className:"space-y-8",children:[r.jsxs("section",{children:[r.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-foreground mb-3",children:"Hjälp & Guider"}),r.jsx("p",{className:"text-base sm:text-lg text-muted-foreground",children:"Välj en guide nedan för att lära dig hur du använder appen"})]}),r.jsxs("section",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[r.jsxs("article",{className:"card p-6 shadow",children:[r.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[r.jsx("div",{className:"p-3 rounded-lg bg-primary/10",children:r.jsx(Ce,{name:"List",className:"w-6 h-6 text-primary","aria-hidden":"true"})}),r.jsxs("div",{className:"flex-1",children:[r.jsx("h2",{className:"text-xl font-bold text-foreground mb-1",children:"Märkeslista-guide"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Lär dig hur du söker, filtrerar och utforskar märken"})]})]}),r.jsxs("div",{className:"space-y-2 mb-5",children:[r.jsx("h3",{className:"text-sm font-semibold text-foreground",children:"Guiden visar dig:"}),r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1.5","aria-label":"Steg i märkeslista-guiden",children:[r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Ce,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Hur du söker efter märken"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Ce,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Använd snabbfilter för statusar"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Ce,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Öppna och läs detaljerad information"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Ce,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Filtrera efter ålder, kategori och mer"})]})]})]}),r.jsxs("button",{type:"button",onClick:a,className:"btn btn-primary w-full min-h-[44px] inline-flex items-center justify-center gap-2","aria-label":"Starta märkeslista-guide",children:[r.jsx(Ce,{name:"PlayCircle",className:"w-5 h-5","aria-hidden":"true"}),r.jsx("span",{children:"Starta Guide"})]})]}),r.jsxs("article",{className:"card p-6 shadow",children:[r.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[r.jsx("div",{className:"p-3 rounded-lg bg-primary/10",children:r.jsx(Ce,{name:"Target",className:"w-6 h-6 text-primary","aria-hidden":"true"})}),r.jsxs("div",{className:"flex-1",children:[r.jsx("h2",{className:"text-xl font-bold text-foreground mb-1",children:"Trädvy-guide"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Upptäck hur du navigerar det interaktiva märkesträdet"})]})]}),r.jsxs("div",{className:"space-y-2 mb-5",children:[r.jsx("h3",{className:"text-sm font-semibold text-foreground",children:"Guiden visar dig:"}),r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1.5","aria-label":"Steg i trädvy-guiden",children:[r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Ce,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Hur du panorerar och zoomar i trädet"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Ce,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Förstå färgkodning och status"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Ce,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Klicka på märken för detaljer"})]}),r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Ce,{name:"CheckCircle",className:"w-4 h-4 shrink-0 mt-0.5 text-success","aria-hidden":"true"}),r.jsx("span",{children:"Använd zoomkontroller och helskärmsläge"})]})]})]}),r.jsxs("button",{type:"button",onClick:n,className:"btn btn-primary w-full min-h-[44px] inline-flex items-center justify-center gap-2","aria-label":"Starta trädvy-guide",children:[r.jsx(Ce,{name:"PlayCircle",className:"w-5 h-5","aria-hidden":"true"}),r.jsx("span",{children:"Starta Guide"})]})]})]}),r.jsx("section",{className:"card p-6 shadow",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(Ce,{name:"Info",className:"w-5 h-5 shrink-0 mt-0.5 text-muted-foreground","aria-hidden":"true"}),r.jsxs("div",{children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-2",children:"Kontextbaserad hjälp"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:'Du hittar också snabblänkar till guider direkt på sidorna där de är relevanta. Titta efter "Visa guide"-länkarna bredvid sidtitlarna på Märkeslista och Märkesträd.'})]})]})})]})}function aa({medal:e,open:a,onClose:n,preferredYear:s=null}){const i=le(),{currentProfile:l,unlockMedal:o}=ie(),d=!!l?.features?.allowManualUnlock,[c,u]=t.useState({value:"",sessionKey:null}),m=a?`${s}`:null,p=c.sessionKey===m?c.value:"",h=t.useCallback(e=>{u({value:e,sessionKey:m})},[m]),f=t.useMemo(()=>{if(!a||!i||!e?.id)return[];try{return i.getEligibleYears(e.id)||[]}catch{return[]}},[a,i,e]),x=t.useMemo(()=>{const e=l?.dateOfBirth;if(!e)return null;const t=new Date(e).getFullYear();return Number.isFinite(t)?t:null},[l]),g=(new Date).getFullYear(),b=t.useMemo(()=>{if(!i||!e)return null;try{return i.getEarliestCountingYearForMedal(e)}catch{return null}},[i,e]),y=t.useMemo(()=>{if(!i||!e)return null;try{return i.getMinimalUnlockYearForSustained(e)}catch{return null}},[i,e]),v=!!l?.features?.enforceCurrentYearForSustained,j=Array.isArray(e?.requirements)&&e.requirements.some(e=>"sustained_achievement"===e?.type),w=t.useCallback(()=>{if(!i||!e)return"";if(v&&j){if(d)return g;if(f?.includes(g))return g}if(!d)return f&&0!==f.length?Math.min(...f):"";const t=(()=>{const e=[];return"number"==typeof b&&e.push(b),"number"==typeof y&&e.push(y),e.length?Math.max(...e):null})(),r=Math.max(Number.isFinite(x)?x:-1/0,Number.isFinite(t)?t:-1/0);for(let a=Number.isFinite(r)?r:g;a<=g;a++)try{const t=i.checkPrerequisites(e,a);if(t?.allMet)return a}catch{}return v&&j?g:""},[d,i,e,f,b,y,x,g,v,j]),N=t.useMemo(()=>{if(!a)return"";if(null!=s&&Number.isFinite(s))return s;const e=w();return""!==e&&Number.isFinite(e)?e:""},[a,s,w]),k=d?""===p?N:p:null,S=d?""===k?"":Number(k):f.length<=1?f[0]??"":p||(f[0]??""),C=d&&(!Number.isFinite(S)||"number"!=typeof x||S<x||S>g),M=v&&j&&Number.isFinite(S)&&S!==g,A=(()=>{const e=[];return"number"==typeof b&&e.push(b),"number"==typeof y&&e.push(y),0===e.length?null:Math.max(...e)})(),T=d&&Number.isFinite(S)&&"number"==typeof A&&S<A,_=d?!C&&!M&&!T:""!==S,P=t.useMemo(()=>{if(!d)return!0;if(!i||!e?.id||!Number.isFinite(S))return!1;try{const t=i.checkPrerequisites(e,S);return!!t?.allMet}catch{return!1}},[d,i,e,S]),I=d?_&&P:f.length>0&&""!==S,D=async()=>{if(!I)return;const t=d?S:Number(S),r=`${t}-12-31`,a=i?.getContributingAchievements?.(e.id,t)||[];await o(e.id,r,a),n?.()};return r.jsx(Se,{id:"unlock-medal",title:`Lås upp ${e?.displayName||"medalj"}`,open:a,onClose:n,swipeToDismiss:!0,children:d?r.jsxs("form",{className:"space-y-4",onSubmit:e=>{e.preventDefault(),I&&D()},noValidate:!0,children:[r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"unlock-year",className:"field-label mb-2",children:["År","number"==typeof A&&r.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["(Tidigast: ",A,")"]})]}),r.jsx("input",{id:"unlock-year",type:"number",inputMode:"numeric",className:"input py-3 mb-2",min:x??void 0,max:g,list:"eligible-years",value:k,onChange:e=>{const t=e.target.value;h(""===t?"":Number(t))},"aria-invalid":(()=>{if(d&&""!==p&&Number.isFinite(S))return!!(C||M||T||_&&!P)||void 0})(),"aria-describedby":"unlock-year-hint"}),r.jsx("datalist",{id:"eligible-years",children:f.map(e=>r.jsx("option",{value:e},e))}),r.jsxs("p",{id:"unlock-year-hint",className:"field-hint mt-2",children:["Välj ett år mellan ",x," och ",g,". Vi stämmer av med förhandskraven för året."]}),(()=>{if(!d)return null;if(""===p||!Number.isFinite(S))return null;let e=null;return C?e=`Året måste vara mellan ${x} och ${g}.`:M?e="Det här märket kräver att innevarande år väljs.":T?e=`Tidigaste året du kan låsa upp märket är ${A}.`:P||(e=`Förhandskraven är inte mötta för ${S}.`),e?r.jsx("p",{className:"field-hint mt-2 text-danger",role:"status",children:e}):null})()]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:n,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px]",disabled:!I,children:"Lås upp"})]})]}):0===f.length?r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-text-secondary",children:"Inga giltiga år funna."}),r.jsx("div",{className:"flex justify-end",children:r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:n,children:"Stäng"})})]}):1===f.length?r.jsxs("div",{className:"space-y-4",children:[r.jsxs("p",{className:"text-sm",children:["Lås upp för: ",r.jsx("strong",{children:f[0]}),"?"]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:n,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:D,children:"Lås upp"})]})]}):r.jsxs("form",{className:"space-y-4",onSubmit:e=>{e.preventDefault(),""!==S&&D()},noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"unlock-year",className:"field-label mb-2",children:"År"}),r.jsx("select",{id:"unlock-year",className:"select py-3",value:S,onChange:e=>h(Number(e.target.value)),children:f.map(e=>r.jsx("option",{value:e,children:e},e))})]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:n,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px]",disabled:""===S,children:"Lås upp"})]})]})})}function na({medal:e,open:t,onClose:a,variant:n="confirm",blockingMedals:s=[],onConfirmRemove:i}){const l=`${e?`remove-medal-${e.id}`:"remove-medal"}-${n}`;return r.jsx(Se,{id:l,title:"confirm"===n?"Ta bort upplåsning":"Kan inte ta bort än",open:t,onClose:a,children:"confirm"===n?r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground",children:"Det här påverkar inte andra märken."}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{type:"button",onClick:a,className:"btn btn-muted flex-1 min-h-[44px]",children:"Avbryt"}),r.jsx("button",{type:"button",onClick:async()=>{const e=await(i?.());e?.ok&&a?.()},className:"btn btn-primary flex-1 min-h-[44px]",children:"Ta bort"})]})]}):r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground",children:"De här upplåsta märkena beror på detta:"}),r.jsx("ul",{className:"text-sm text-muted-foreground list-disc ml-5 space-y-1",children:s.map(e=>r.jsx("li",{className:"break-words",children:e.displayName||e.name},e.id))}),r.jsx("div",{className:"pt-1",children:r.jsx("button",{type:"button",onClick:a,className:"btn btn-muted w-full min-h-[44px]",children:"OK"})})]})})}function sa({initialValues:e,validate:r,onSubmit:a}){const[n,s]=t.useState({...e||{}}),[i,l]=t.useState({}),o=t.useRef(null),d=t.useCallback(e=>{const{name:t,value:r,type:a}=e.target;let n=r;if("number"===a){const e=Number(r);n=Number.isFinite(e)?e:r}s(e=>({...e,[t]:n}))},[]),c=t.useCallback(e=>{if("function"==typeof r){return r(e)||{}}return{}},[r]),u=t.useCallback(async e=>{e?.preventDefault();const t=c(n);l(t),Object.keys(t).length>0||await(a?.(n))},[a,c,n]),m=t.useMemo(()=>({onTouchStart:e=>{const t=e.changedTouches?.[0];t&&(o.current={x:t.clientX,y:t.clientY,time:Date.now()})},onTouchEnd:()=>{o.current=null}}),[]);return{values:n,errors:i,handleChange:d,handleSubmit:u,validate:c,formProps:m,setValues:s,setErrors:l}}function ia({onSubmit:e,loading:t,preservedValues:a}){const{values:n,errors:s,handleChange:i,handleSubmit:l}=sa({initialValues:{date:a?.date??(new Date).toISOString().split("T")[0],weaponGroup:a?.weaponGroup??"C",eventName:a?.eventName??"",notes:""},validate:e=>{const t={};return e.date||(t.date="Datum krävs"),e.weaponGroup||(t.weaponGroup="Vapengrupp krävs"),t},onSubmit:e});return r.jsxs("form",{onSubmit:l,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"c-date",className:"field-label mb-2",children:"Date"}),r.jsx("input",{id:"c-date",type:"date",name:"date","aria-label":"Date","aria-invalid":Boolean(s.date),"aria-describedby":s.date?"c-error-date":void 0,value:n.date,onChange:i,className:"input py-3",required:!0}),s.date&&r.jsx("p",{id:"c-error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"c-weapon-group",className:"field-label mb-2",children:"Weapon Group"}),r.jsxs("select",{id:"c-weapon-group",name:"weaponGroup","aria-label":"Weapon group","aria-invalid":Boolean(s.weaponGroup),"aria-describedby":s.weaponGroup?"c-error-weaponGroup":void 0,value:n.weaponGroup,onChange:i,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"C",children:"Group C"}),r.jsx("option",{value:"B",children:"Group B"}),r.jsx("option",{value:"A",children:"Group A"}),r.jsx("option",{value:"R",children:"Group R"})]}),s.weaponGroup&&r.jsx("p",{id:"c-error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"c-name",className:"field-label mb-2",children:"Title (optional)"}),r.jsx("input",{id:"c-name",type:"text",name:"eventName","aria-label":"Title",value:n.eventName,onChange:i,className:"input py-3"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"c-notes",className:"field-label mb-2",children:"Notes"}),r.jsx("textarea",{id:"c-notes",name:"notes","aria-label":"Notes",value:n.notes,onChange:i,className:"textarea py-3 resize-none",rows:3})]}),r.jsx("button",{type:"submit",disabled:t,className:"btn btn-primary w-full py-3 disabled:opacity-50 disabled:cursor-not-allowed",children:t?"Saving...":"Log Achievement"})]})}function la(e,t,r=20){if(!e)return null;return function e(a,n=0){if(!a)return null;if(n>=r)return null;if(Array.isArray(a)){for(const t of a){const r=e(t,n+1);if(r)return r}return null}if("object"!=typeof a)return null;if(a.type===t)return a;if(a.and&&Array.isArray(a.and))for(const t of a.and){const r=e(t,n+1);if(r)return r}if(a.or&&Array.isArray(a.or))for(const t of a.or){const r=e(t,n+1);if(r)return r}return null}(e)}function oa(e,t){const r=la(e?.requirements,t);return r&&r.description||null}function da({children:e,label:a="Valfria fält",defaultExpanded:n=!1}){const[s,i]=t.useState(n);return r.jsxs("div",{className:"border-t border-border pt-4",children:[r.jsxs("button",{type:"button",onClick:()=>i(!s),className:"\n          flex items-center justify-between w-full\n          text-left text-sm font-medium text-text-secondary\n          hover:text-text-primary transition-colors\n          focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary\n          rounded-md p-2 -m-2\n          min-h-[44px]\n        ","aria-expanded":s,"aria-controls":"optional-fields-content",children:[r.jsxs("span",{className:"flex items-center gap-2",children:[r.jsx(Ce,{name:s?"ChevronDown":"ChevronRight",className:"w-4 h-4 transition-transform","aria-hidden":"true"}),a]}),r.jsx("span",{className:"text-xs text-text-tertiary",children:s?"Dölj":"Visa"})]}),s&&r.jsx("div",{id:"optional-fields-content",className:"mt-4 space-y-4 animate-slide-down",children:e})]})}function ca({medal:e,onSubmit:a,onSubmitAndAddAnother:n,loading:s,preservedValues:i}){const l=t.useRef(null),{currentProfile:o}=ie(),d=t.useMemo(()=>function(e,t=null,r=null){let a=null,n=null;if(r&&(a=la(e?.requirements,r),a&&(n=r)),a||(a=la(e?.requirements,"running_shooting_course"),a&&(n="running_shooting_course")),a||(a=la(e?.requirements,"skis_shooting_course"),a&&(n="skis_shooting_course")),!a)return{maxPoints:null,achievementType:r||"running_shooting_course"};const s=t?.sex||"male";let i=a.maxPoints?.[s]??a.maxPoints?.male??null;if(t?.dateOfBirth&&a.ageCategories){const e=new Date(t.dateOfBirth).getFullYear(),r=(new Date).getFullYear()-e,n=a.ageCategories.find(e=>r>=(e.ageMin??0)&&r<=(e.ageMax??999));n?.maxPoints?.[s]&&(i=n.maxPoints[s])}return{maxPoints:i,achievementType:n}}(e,o),[e,o]),c=t.useMemo(()=>oa(e,d.achievementType)||oa(e,"running_shooting_course")||oa(e,"skis_shooting_course"),[e,d.achievementType]),{values:u,errors:m,handleChange:p,handleSubmit:h,validate:f,setErrors:x}=sa({initialValues:{date:i?.date??(new Date).toISOString().split("T")[0],points:i?.points??d.maxPoints??"",courseName:i?.courseName??"",notes:""},validate:e=>{const t={};e.date||(t.date="Datum krävs");const r=Number(e.points);return""===e.points||void 0===e.points?t.points="Poäng krävs":(!Number.isFinite(r)||r<0)&&(t.points="Poäng måste vara 0 eller högre"),t},onSubmit:e=>a({...e,achievementType:d.achievementType||"running_shooting_course"})});t.useEffect(()=>{const e=setTimeout(()=>{l.current?.focus()},100);return()=>clearTimeout(e)},[]);return r.jsxs("form",{onSubmit:h,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"running-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{ref:l,id:"running-date",type:"date",name:"date","aria-label":"Datum för terränglopp","aria-invalid":Boolean(m.date),"aria-describedby":m.date?"error-date":void 0,value:u.date,onChange:p,className:"input py-3",required:!0}),m.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:m.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"running-points",className:"field-label mb-2",children:"Totalpoäng (lägre är bättre)"}),r.jsx("input",{id:"running-points",type:"number",name:"points",inputMode:"numeric",min:"0",step:"1","aria-label":"Totalpoäng","aria-invalid":Boolean(m.points),"aria-describedby":m.points?"error-points":"hint-points",value:u.points,onChange:p,className:"input py-3",required:!0}),m.points?r.jsx("p",{id:"error-points",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:m.points}):r.jsxs("p",{id:"hint-points",className:"mt-1 text-sm text-text-secondary",children:[c||"Summa av löppoäng och skjutpoäng",d.maxPoints&&` (Max ${d.maxPoints} poäng krävs)`]})]}),r.jsxs(da,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"running-course",className:"field-label mb-2",children:"Bana / Tävling"}),r.jsx("input",{id:"running-course",type:"text",name:"courseName","aria-label":"Bana eller tävlingsnamn",value:u.courseName,onChange:p,className:"input py-3",placeholder:"T.ex. Klubbmästerskap, DM Springskytte"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"running-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"running-notes",name:"notes","aria-label":"Anteckningar",value:u.notes,onChange:p,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, utrustning, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sparar..."]}):"Spara & Stäng"}),n&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=f(u);x(t),0===Object.keys(t).length&&n&&n({...u,achievementType:d.achievementType||"running_shooting_course"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})}const ua=[{value:"field",label:"Fält"},{value:"precision",label:"Precision"},{value:"national_whole_match",label:"Nationell hel match"},{value:"military_fast_match",label:"Militär snabbmatch"},{value:"ppc",label:"PPC"}],ma=[{value:"bronze",label:"Brons"},{value:"silver",label:"Silver"},{value:"gold",label:"Guld"}];function pa({medal:e,medalType:t,formData:r}){const a=(n=r?.date,n||(new Date).toISOString().slice(0,10));var n;const s=Number(r?.year),i=Number.isFinite(s)?s:Number(String(a).slice(0,4)),l=String(r?.weaponGroup||"A").toUpperCase(),o=["A","B","C","R"].includes(l)?l:"A";let d=r?.achievementType||"custom";if(!r?.achievementType)if("running_shooting"===t)d="running_shooting_course";else if("competition"===t){d=Array.isArray(e?.requirements)&&e.requirements.some(e=>"precision_series"===(e?.type||"").toLowerCase())?"precision_series":"competition_result"}else d="qualification"===t?"qualification_result":"team_event"===t?"team_event":"event"===t?"event":"custom";const c={id:r?.id||`achievement-${crypto?.randomUUID?crypto.randomUUID():Date.now()}`,type:d,medalId:e?.id||e?.medalId||"",year:i,weaponGroup:o,date:a,notes:r?.notes||"",createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};switch(d){case"running_shooting_course":case"skis_shooting_course":return{...c,points:Number(r?.points??r?.score??0),courseName:r?.courseName||""};case"precision_series":case"speed_shooting_series":return{...c,points:Number(r?.points??r?.score??0),competitionName:r?.competitionName||""};case"application_series":return{...c,hits:Number(r?.hits??0),timeSeconds:Number(r?.timeSeconds??0),competitionName:r?.competitionName||""};case"standard_medal":return{...c,disciplineType:String(r?.disciplineType||"").toLowerCase(),medalType:String(r?.medalType??e?.tier??"").toLowerCase()};case"competition_result":return{...c,score:Number(r?.score??0),competitionName:r?.competitionName||"",competitionType:String(r?.competitionType||"").toLowerCase(),disciplineType:String(r?.disciplineType||"").toLowerCase(),ppcClass:r?.ppcClass||""};case"competition_performance":return{...c,points:Number(r?.points??r?.score??0),score:Number(r?.score??0),scorePercent:Number(r?.scorePercent??0),maxScore:Number(r?.maxScore??0),competitionName:r?.competitionName||"",disciplineType:String(r?.disciplineType||"").toLowerCase()};case"air_pistol_precision":return{...c,points:Number(r?.points??r?.score??0),seriesName:r?.seriesName||r?.competitionName||""};case"qualification_result":return{...c,weapon:r?.weapon||"",score:Number(r?.score??0)};case"team_event":return{...c,teamName:r?.teamName||"",position:Number(r?.position??0),participants:(r?.participants||"").split(",").map(e=>e.trim()).filter(Boolean)};default:return{...c,eventName:r?.eventName||""}}}const ha={competition:function({medal:e,onSubmit:t,loading:a,preservedValues:n}){const{values:s,errors:i,handleChange:l,handleSubmit:o}=sa({initialValues:{date:n?.date??(new Date).toISOString().split("T")[0],weaponGroup:n?.weaponGroup??"C",score:n?.score??"",competitionName:n?.competitionName??"",notes:""},validate:e=>function(e){const t={};e.date?lr(e.date)&&(t.date="Date cannot be in the future"):t.date="Date is required",e.weaponGroup&&nr.includes(e.weaponGroup)||(t.weaponGroup="Select a valid weapon group");const r=String(e.disciplineType||"").toLowerCase();sr.includes(r)||(t.disciplineType="Select a valid discipline"),"ppc"===r&&(String(e.ppcClass||"").trim()||(t.ppcClass="PPC class is required for PPC discipline"));""===e.score||null==e.score||Number.isNaN(Number(e.score))?t.score="Enter a valid score/points":Number(e.score)<0&&(t.score="Score cannot be negative");return t}(e),onSubmit:t});return r.jsxs("form",{onSubmit:o,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"achievement-date",className:"field-label mb-2",children:"Date of Achievement"}),r.jsx("input",{id:"achievement-date",type:"date",name:"date","aria-label":"Achievement date","aria-invalid":Boolean(i.date),"aria-describedby":i.date?"error-date":void 0,value:s.date,onChange:l,className:"input py-3",required:!0}),i.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:i.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"weapon-group",className:"field-label mb-2",children:"Weapon Group"}),r.jsxs("select",{id:"weapon-group",name:"weaponGroup","aria-label":"Weapon group","aria-invalid":Boolean(i.weaponGroup),"aria-describedby":i.weaponGroup?"error-weaponGroup":void 0,value:s.weaponGroup,onChange:l,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"C",children:"Group C"}),r.jsx("option",{value:"B",children:"Group B"}),r.jsx("option",{value:"A",children:"Group A"}),r.jsx("option",{value:"R",children:"Group R"})]}),i.weaponGroup&&r.jsx("p",{id:"error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:i.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"achievement-score",className:"field-label mb-2",children:"Score / Points"}),r.jsx("input",{id:"achievement-score",type:"number",name:"score",inputMode:"decimal","aria-label":"Score or points","aria-invalid":Boolean(i.score),"aria-describedby":i.score?"error-score":void 0,value:s.score,onChange:l,className:"input py-3",required:!0}),i.score&&r.jsx("p",{id:"error-score",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:i.score})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-name",className:"field-label mb-2",children:"Competition (optional)"}),r.jsx("input",{id:"competition-name",type:"text",name:"competitionName","aria-label":"Competition name",value:s.competitionName,onChange:l,className:"input py-3"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"achievement-notes",className:"field-label mb-2",children:"Notes (optional)"}),r.jsx("textarea",{id:"achievement-notes",name:"notes","aria-label":"Notes",value:s.notes,onChange:l,className:"textarea py-3 resize-none",rows:3})]}),r.jsx("button",{type:"submit",disabled:a,className:"btn btn-primary w-full py-3 disabled:opacity-50 disabled:cursor-not-allowed",children:a?"Saving...":"Log Achievement"})]})},qualification:function({onSubmit:e,loading:t,preservedValues:a}){const{values:n,errors:s,handleChange:i,handleSubmit:l}=sa({initialValues:{date:a?.date??(new Date).toISOString().split("T")[0],weaponGroup:a?.weaponGroup??"C",weapon:a?.weapon??"",score:a?.score??"",notes:""},validate:e=>{const t={};e.date||(t.date="Date is required"),e.weaponGroup||(t.weaponGroup="Weapon group is required"),e.weapon?.trim()||(t.weapon="Weapon is required");const r=Number(e.score);return(!Number.isFinite(r)||r<0)&&(t.score="Enter a valid score"),t},onSubmit:e});return r.jsxs("form",{onSubmit:l,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"q-date",className:"field-label mb-2",children:"Date"}),r.jsx("input",{id:"q-date",type:"date",name:"date","aria-label":"Qualification date","aria-invalid":Boolean(s.date),"aria-describedby":s.date?"q-error-date":void 0,value:n.date,onChange:i,className:"input py-3",required:!0}),s.date&&r.jsx("p",{id:"q-error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"q-weapon-group",className:"field-label mb-2",children:"Weapon Group"}),r.jsxs("select",{id:"q-weapon-group",name:"weaponGroup","aria-label":"Weapon group","aria-invalid":Boolean(s.weaponGroup),"aria-describedby":s.weaponGroup?"q-error-weaponGroup":void 0,value:n.weaponGroup,onChange:i,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"C",children:"Group C"}),r.jsx("option",{value:"B",children:"Group B"}),r.jsx("option",{value:"A",children:"Group A"}),r.jsx("option",{value:"R",children:"Group R"})]}),s.weaponGroup&&r.jsx("p",{id:"q-error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"q-weapon",className:"field-label mb-2",children:"Weapon"}),r.jsx("input",{id:"q-weapon",type:"text",name:"weapon","aria-label":"Weapon","aria-invalid":Boolean(s.weapon),"aria-describedby":s.weapon?"q-error-weapon":void 0,value:n.weapon,onChange:i,className:"input py-3",required:!0}),s.weapon&&r.jsx("p",{id:"q-error-weapon",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.weapon})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"q-score",className:"field-label mb-2",children:"Score"}),r.jsx("input",{id:"q-score",type:"number",name:"score","aria-label":"Score","aria-invalid":Boolean(s.score),"aria-describedby":s.score?"q-error-score":void 0,value:n.score,onChange:i,className:"input py-3",required:!0}),s.score&&r.jsx("p",{id:"q-error-score",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.score})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"q-notes",className:"field-label mb-2",children:"Notes (optional)"}),r.jsx("textarea",{id:"q-notes",name:"notes","aria-label":"Notes",value:n.notes,onChange:i,className:"textarea py-3 resize-none",rows:3})]}),r.jsx("button",{type:"submit",disabled:t,className:"btn btn-primary w-full py-3 disabled:opacity-50 disabled:cursor-not-allowed",children:t?"Saving...":"Log Qualification"})]})},team_event:function({onSubmit:e,loading:t,preservedValues:a}){const{values:n,errors:s,handleChange:i,handleSubmit:l}=sa({initialValues:{date:a?.date??(new Date).toISOString().split("T")[0],weaponGroup:a?.weaponGroup??"C",teamName:a?.teamName??"",position:a?.position??"",participants:a?.participants??"",notes:""},validate:e=>{const t={};e.date||(t.date="Date is required"),e.weaponGroup||(t.weaponGroup="Weapon group is required"),e.teamName?.trim()||(t.teamName="Team name is required");const r=Number(e.position);return(!Number.isFinite(r)||r<1)&&(t.position="Enter a valid position (1 or higher)"),t},onSubmit:e});return r.jsxs("form",{onSubmit:l,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-date",className:"field-label mb-2",children:"Date"}),r.jsx("input",{id:"t-date",type:"date",name:"date","aria-label":"Team event date","aria-invalid":Boolean(s.date),"aria-describedby":s.date?"t-error-date":void 0,value:n.date,onChange:i,className:"input py-3",required:!0}),s.date&&r.jsx("p",{id:"t-error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-weapon-group",className:"field-label mb-2",children:"Weapon Group"}),r.jsxs("select",{id:"t-weapon-group",name:"weaponGroup","aria-label":"Weapon group","aria-invalid":Boolean(s.weaponGroup),"aria-describedby":s.weaponGroup?"t-error-weaponGroup":void 0,value:n.weaponGroup,onChange:i,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"C",children:"Group C"}),r.jsx("option",{value:"B",children:"Group B"}),r.jsx("option",{value:"A",children:"Group A"}),r.jsx("option",{value:"R",children:"Group R"})]}),s.weaponGroup&&r.jsx("p",{id:"t-error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-team",className:"field-label mb-2",children:"Team Name"}),r.jsx("input",{id:"t-team",type:"text",name:"teamName","aria-label":"Team name","aria-invalid":Boolean(s.teamName),"aria-describedby":s.teamName?"t-error-team":void 0,value:n.teamName,onChange:i,className:"input py-3",required:!0}),s.teamName&&r.jsx("p",{id:"t-error-team",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.teamName})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-position",className:"field-label mb-2",children:"Position (1-10)"}),r.jsx("input",{id:"t-position",type:"number",name:"position","aria-label":"Team position","aria-invalid":Boolean(s.position),"aria-describedby":s.position?"t-error-position":void 0,min:1,max:10,value:n.position,onChange:i,className:"input py-3",required:!0}),s.position&&r.jsx("p",{id:"t-error-position",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.position})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-participants",className:"field-label mb-2",children:"Participants (comma-separated)"}),r.jsx("input",{id:"t-participants",type:"text",name:"participants","aria-label":"Participants",value:n.participants,onChange:i,className:"input py-3",placeholder:"Anna, Björn, Carin"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"t-notes",className:"field-label mb-2",children:"Notes (optional)"}),r.jsx("textarea",{id:"t-notes",name:"notes","aria-label":"Notes",value:n.notes,onChange:i,className:"textarea py-3 resize-none",rows:3})]}),r.jsx("button",{type:"submit",disabled:t,className:"btn btn-primary w-full py-3 disabled:opacity-50 disabled:cursor-not-allowed",children:t?"Saving...":"Log Team Event"})]})},event:function({onSubmit:e,loading:t,preservedValues:a}){const{values:n,errors:s,handleChange:i,handleSubmit:l}=sa({initialValues:{date:a?.date??(new Date).toISOString().split("T")[0],weaponGroup:a?.weaponGroup??"C",eventName:a?.eventName??"",notes:""},validate:e=>{const t={};return e.date||(t.date="Datum krävs"),e.weaponGroup||(t.weaponGroup="Vapengrupp krävs"),e.eventName?.trim()||(t.eventName="Händelsenamn krävs"),t},onSubmit:e});return r.jsxs("form",{onSubmit:l,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"e-date",className:"field-label mb-2",children:"Date"}),r.jsx("input",{id:"e-date",type:"date",name:"date","aria-label":"Event date","aria-invalid":Boolean(s.date),"aria-describedby":s.date?"e-error-date":void 0,value:n.date,onChange:i,className:"input py-3",required:!0}),s.date&&r.jsx("p",{id:"e-error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"e-weapon-group",className:"field-label mb-2",children:"Weapon Group"}),r.jsxs("select",{id:"e-weapon-group",name:"weaponGroup","aria-label":"Weapon group","aria-invalid":Boolean(s.weaponGroup),"aria-describedby":s.weaponGroup?"e-error-weaponGroup":void 0,value:n.weaponGroup,onChange:i,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"C",children:"Group C"}),r.jsx("option",{value:"B",children:"Group B"}),r.jsx("option",{value:"A",children:"Group A"}),r.jsx("option",{value:"R",children:"Group R"})]}),s.weaponGroup&&r.jsx("p",{id:"e-error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"e-name",className:"field-label mb-2",children:"Event Name"}),r.jsx("input",{id:"e-name",type:"text",name:"eventName","aria-label":"Event name","aria-invalid":Boolean(s.eventName),"aria-describedby":s.eventName?"e-error-name":void 0,value:n.eventName,onChange:i,className:"input py-3",required:!0}),s.eventName&&r.jsx("p",{id:"e-error-name",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:s.eventName})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"e-notes",className:"field-label mb-2",children:"Notes (optional)"}),r.jsx("textarea",{id:"e-notes",name:"notes","aria-label":"Notes",value:n.notes,onChange:i,className:"textarea py-3 resize-none",rows:3})]}),r.jsx("button",{type:"submit",disabled:t,className:"btn btn-primary w-full py-3 disabled:opacity-50 disabled:cursor-not-allowed",children:t?"Saving...":"Log Event"})]})},custom:ia},fa={precision_series:function({medal:e,onSubmit:a,onSubmitAndAddAnother:n,loading:s,preservedValues:i}){const l=t.useRef(null),{currentProfile:o}=ie(),d=t.useMemo(()=>function(e,t=null){const r=la(e?.requirements,"precision_series");if(!r)return{weaponGroup:"C",points:""};const a="C";let n=r.pointThresholds?.[a]?.min;if(t?.dateOfBirth&&r.ageCategories){const e=new Date(t.dateOfBirth).getFullYear(),s=(new Date).getFullYear()-e,i=r.ageCategories.find(e=>s>=(e.ageMin??0)&&s<=(e.ageMax??999));i?.pointThresholds?.[a]?.min&&(n=i.pointThresholds[a].min)}return{weaponGroup:a,points:n??""}}(e,o),[e,o]),c=t.useMemo(()=>oa(e,"precision_series"),[e]),{values:u,errors:m,handleChange:p,handleSubmit:h,validate:f,setErrors:x}=sa({initialValues:{date:i?.date??(new Date).toISOString().split("T")[0],weaponGroup:i?.weaponGroup??d.weaponGroup,points:i?.points??d.points,competitionName:i?.competitionName??"",notes:""},validate:e=>{const t={};e.date||(t.date="Datum krävs");const r=Number(e.points);return(!Number.isFinite(r)||r<0||r>50)&&(t.points="Poäng måste vara mellan 0-50"),t},onSubmit:e=>a({...e,achievementType:"precision_series"})}),g=t.useMemo(()=>function(e,t,r=null){const a=la(e?.requirements,"precision_series");if(!a)return{min:null};if(r?.dateOfBirth&&a.ageCategories){const e=new Date(r.dateOfBirth).getFullYear(),n=(new Date).getFullYear()-e,s=a.ageCategories.find(e=>n>=(e.ageMin??0)&&n<=(e.ageMax??999));if(s?.pointThresholds?.[t])return{min:s.pointThresholds[t].min??null}}const n=a.pointThresholds?.[t];return{min:n?.min??null}}(e,u.weaponGroup,o),[e,u.weaponGroup,o]);return t.useEffect(()=>{const e=setTimeout(()=>{l.current?.focus()},100);return()=>clearTimeout(e)},[]),r.jsxs("form",{onSubmit:h,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"precision-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{ref:l,id:"precision-date",type:"date",name:"date","aria-label":"Datum för precisionsserie","aria-invalid":Boolean(m.date),"aria-describedby":m.date?"error-date":void 0,value:u.date,onChange:p,className:"input py-3",required:!0}),m.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:m.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"precision-weapon-group",className:"field-label mb-2",children:"Vapengrupp"}),r.jsxs("select",{id:"precision-weapon-group",name:"weaponGroup","aria-label":"Vapengrupp","aria-invalid":Boolean(m.weaponGroup),"aria-describedby":m.weaponGroup?"error-weaponGroup":void 0,value:u.weaponGroup,onChange:p,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"C",children:"Grupp C"}),r.jsx("option",{value:"B",children:"Grupp B"}),r.jsx("option",{value:"A",children:"Grupp A"}),r.jsx("option",{value:"R",children:"Grupp R"})]}),m.weaponGroup&&r.jsx("p",{id:"error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:m.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"precision-points",className:"field-label mb-2",children:"Poäng (0-50)"}),r.jsx("input",{id:"precision-points","data-tour":"achievement-primary-input",type:"number",name:"points",inputMode:"decimal",min:"0",max:"50",step:"0.1","aria-label":"Poäng i precisionsserie","aria-invalid":Boolean(m.points),"aria-describedby":m.points?"error-points":"hint-points",value:u.points,onChange:p,className:"input py-3",required:!0}),m.points?r.jsx("p",{id:"error-points",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:m.points}):r.jsxs("p",{id:"hint-points",className:"mt-1 text-sm text-text-secondary","data-tour":"achievement-hint",children:[c||"Resultat från 5 skott på 25m pistoltavla",null!=g.min&&` (Minst ${g.min} poäng krävs för grupp ${u.weaponGroup})`]})]}),r.jsxs(da,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"precision-competition",className:"field-label mb-2",children:"Tävling / Bana"}),r.jsx("input",{id:"precision-competition",type:"text",name:"competitionName","aria-label":"Tävlingsnamn",value:u.competitionName,onChange:p,className:"input py-3",placeholder:"T.ex. Klubbmästerskap"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"precision-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"precision-notes",name:"notes","aria-label":"Anteckningar",value:u.notes,onChange:p,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, vapen använt, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sparar..."]}):"Spara & Stäng"}),n&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=f(u);x(t),0===Object.keys(t).length&&n&&n({...u,achievementType:"precision_series"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})},application_series:function({medal:e,onSubmit:a,onSubmitAndAddAnother:n,loading:s,preservedValues:i}){const l=t.useMemo(()=>function(e){const t=la(e?.requirements,"application_series");if(!t)return{weaponGroup:"C",hits:"",timeSeconds:""};const r=t.thresholds?.C;return{weaponGroup:"C",hits:r?.minHits??"",timeSeconds:r?.maxTimeSeconds??""}}(e),[e]),o=t.useMemo(()=>oa(e,"application_series"),[e]),{values:d,errors:c,handleChange:u,handleSubmit:m,validate:p,setErrors:h}=sa({initialValues:{date:i?.date??(new Date).toISOString().split("T")[0],weaponGroup:i?.weaponGroup??l.weaponGroup,hits:i?.hits??l.hits,timeSeconds:i?.timeSeconds??l.timeSeconds,competitionName:i?.competitionName??"",notes:""},validate:e=>{const t={};e.date||(t.date="Datum krävs");const r=Number(e.hits);(!Number.isFinite(r)||r<0||r>6)&&(t.hits="Antal träffar måste vara mellan 0-6");const a=Number(e.timeSeconds);return(!Number.isFinite(a)||a<=0)&&(t.timeSeconds="Tid måste vara större än 0 sekunder"),t},onSubmit:e=>a({...e,achievementType:"application_series"})}),f=t.useMemo(()=>function(e,t){const r=la(e?.requirements,"application_series");if(!r)return{minHits:null,maxTimeSeconds:null};const a=r.thresholds?.[t];return{minHits:a?.minHits??null,maxTimeSeconds:a?.maxTimeSeconds??null}}(e,d.weaponGroup),[e,d.weaponGroup]);return r.jsxs("form",{onSubmit:m,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{id:"application-date",type:"date",name:"date","aria-label":"Datum för tillämpningsserie","aria-invalid":Boolean(c.date),"aria-describedby":c.date?"error-date":void 0,value:d.date,onChange:u,className:"input py-3",required:!0}),c.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:c.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-weapon-group",className:"field-label mb-2",children:"Vapengrupp"}),r.jsxs("select",{id:"application-weapon-group",name:"weaponGroup","aria-label":"Vapengrupp","aria-invalid":Boolean(c.weaponGroup),"aria-describedby":c.weaponGroup?"error-weaponGroup":void 0,value:d.weaponGroup,onChange:u,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"C",children:"Grupp C"}),r.jsx("option",{value:"B",children:"Grupp B"}),r.jsx("option",{value:"A",children:"Grupp A"}),r.jsx("option",{value:"R",children:"Grupp R"})]}),c.weaponGroup&&r.jsx("p",{id:"error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:c.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-hits",className:"field-label mb-2",children:"Antal träffar (0-6)"}),r.jsx("input",{id:"application-hits","data-tour":"achievement-primary-input",type:"number",name:"hits",inputMode:"numeric",min:"0",max:"6",step:"1","aria-label":"Antal träffar i tillämpningsserie","aria-invalid":Boolean(c.hits),"aria-describedby":c.hits?"error-hits":"hint-hits",value:d.hits,onChange:u,className:"input py-3",required:!0}),c.hits?r.jsx("p",{id:"error-hits",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:c.hits}):r.jsxs("p",{id:"hint-hits",className:"mt-1 text-sm text-text-secondary","data-tour":"achievement-hint",children:[o||"6 skott på B100 (50m) eller 1/6 mål C30 (25m)",null!=f.minHits&&` (Minst ${f.minHits} träffar krävs för grupp ${d.weaponGroup})`]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-time",className:"field-label mb-2",children:"Tid (sekunder)"}),r.jsx("input",{id:"application-time",type:"number",name:"timeSeconds",inputMode:"decimal",min:"0",step:"0.1","aria-label":"Tid i sekunder","aria-invalid":Boolean(c.timeSeconds),"aria-describedby":c.timeSeconds?"error-time":"hint-time",value:d.timeSeconds,onChange:u,className:"input py-3",required:!0,placeholder:"T.ex. 45.5"}),c.timeSeconds?r.jsx("p",{id:"error-time",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:c.timeSeconds}):r.jsxs("p",{id:"hint-time",className:"mt-1 text-sm text-text-secondary",children:["Skjuttid från första till sista skottet",null!=f.maxTimeSeconds&&` (Max ${f.maxTimeSeconds}s krävs för grupp ${d.weaponGroup})`]})]}),r.jsxs(da,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-competition",className:"field-label mb-2",children:"Tävling / Bana"}),r.jsx("input",{id:"application-competition",type:"text",name:"competitionName","aria-label":"Tävlingsnamn",value:d.competitionName,onChange:u,className:"input py-3",placeholder:"T.ex. Träning, Klubbmästerskap"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"application-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"application-notes",name:"notes","aria-label":"Anteckningar",value:d.notes,onChange:u,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, utgångsställning, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Stäng"}),n&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=p(d);h(t),0===Object.keys(t).length&&n&&n({...d,achievementType:"application_series"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})},speed_shooting_series:function({medal:e,onSubmit:a,onSubmitAndAddAnother:n,loading:s,preservedValues:i}){const l=t.useMemo(()=>function(e){const t=la(e?.requirements,"speed_shooting_series");if(!t)return{weaponGroup:"C",points:""};const r=t.pointThresholds?.C?.min;return{weaponGroup:"C",points:r??""}}(e),[e]),o=t.useMemo(()=>oa(e,"speed_shooting_series"),[e]),{values:d,errors:c,handleChange:u,handleSubmit:m,validate:p,setErrors:h}=sa({initialValues:{date:i?.date??(new Date).toISOString().split("T")[0],weaponGroup:i?.weaponGroup??l.weaponGroup,points:i?.points??l.points,competitionName:i?.competitionName??"",notes:""},validate:e=>{const t={};e.date||(t.date="Datum krävs");const r=Number(e.points);return(!Number.isFinite(r)||r<0||r>50)&&(t.points="Poäng måste vara mellan 0-50"),t},onSubmit:e=>a({...e,achievementType:"speed_shooting_series"})}),f=t.useMemo(()=>function(e,t){const r=la(e?.requirements,"speed_shooting_series");if(!r)return{min:null};const a=r.pointThresholds?.[t];return{min:a?.min??null}}(e,d.weaponGroup),[e,d.weaponGroup]);return r.jsxs("form",{onSubmit:m,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"speed-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{id:"speed-date",type:"date",name:"date","aria-label":"Datum för duellserie","aria-invalid":Boolean(c.date),"aria-describedby":c.date?"error-date":void 0,value:d.date,onChange:u,className:"input py-3",required:!0}),c.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:c.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"speed-weapon-group",className:"field-label mb-2",children:"Vapengrupp"}),r.jsxs("select",{id:"speed-weapon-group",name:"weaponGroup","aria-label":"Vapengrupp","aria-invalid":Boolean(c.weaponGroup),"aria-describedby":c.weaponGroup?"error-weaponGroup":void 0,value:d.weaponGroup,onChange:u,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"C",children:"Grupp C"}),r.jsx("option",{value:"B",children:"Grupp B"}),r.jsx("option",{value:"A",children:"Grupp A"}),r.jsx("option",{value:"R",children:"Grupp R"})]}),c.weaponGroup&&r.jsx("p",{id:"error-weaponGroup",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:c.weaponGroup})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"speed-points",className:"field-label mb-2",children:"Poäng (0-50)"}),r.jsx("input",{id:"speed-points",type:"number",name:"points",inputMode:"decimal",min:"0",max:"50",step:"0.1","aria-label":"Poäng i duellserie","aria-invalid":Boolean(c.points),"aria-describedby":c.points?"error-points":"hint-points",value:d.points,onChange:u,className:"input py-3",required:!0}),c.points?r.jsx("p",{id:"error-points",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:c.points}):r.jsxs("p",{id:"hint-points",className:"mt-1 text-sm text-text-secondary",children:[o||"Resultat från duellskjutning",null!=f.min&&` (Minst ${f.min} poäng krävs för grupp ${d.weaponGroup})`]})]}),r.jsxs(da,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"speed-competition",className:"field-label mb-2",children:"Tävling / Bana"}),r.jsx("input",{id:"speed-competition",type:"text",name:"competitionName","aria-label":"Tävlingsnamn",value:d.competitionName,onChange:u,className:"input py-3",placeholder:"T.ex. Elitmärkestävling"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"speed-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"speed-notes",name:"notes","aria-label":"Anteckningar",value:d.notes,onChange:u,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, vapen använt, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Stäng"}),n&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=p(d);h(t),0===Object.keys(t).length&&n&&n({...d,achievementType:"speed_shooting_series"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})},air_pistol_precision:function({medal:e,onSubmit:a,onSubmitAndAddAnother:n,loading:s,preservedValues:i}){const l=t.useRef(null),o=t.useMemo(()=>function(e){const t=la(e?.requirements,"air_pistol_precision");return t?{minPointsPerSeries:t.minPointsPerSeries??null,minSeries:t.minSeries??5}:{minPointsPerSeries:null,minSeries:5}}(e),[e]),d=t.useMemo(()=>oa(e,"air_pistol_precision"),[e]),{values:c,errors:u,handleChange:m,handleSubmit:p,validate:h,setErrors:f}=sa({initialValues:{date:i?.date??(new Date).toISOString().split("T")[0],points:i?.points??o.minPointsPerSeries??"",seriesName:"",notes:""},validate:e=>{const t={};e.date||(t.date="Datum krävs");const r=Number(e.points);return""===e.points||void 0===e.points?t.points="Poäng krävs":(!Number.isFinite(r)||r<0||r>100)&&(t.points="Poäng måste vara mellan 0-100"),t},onSubmit:e=>a({...e,achievementType:"air_pistol_precision"})});return t.useEffect(()=>{const e=setTimeout(()=>{l.current?.focus()},100);return()=>clearTimeout(e)},[]),r.jsxs("form",{onSubmit:p,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"airpistol-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{ref:l,id:"airpistol-date",type:"date",name:"date","aria-label":"Datum för luftpistolserie","aria-invalid":Boolean(u.date),"aria-describedby":u.date?"error-date":void 0,value:c.date,onChange:m,className:"input py-3",required:!0}),u.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:u.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"airpistol-points",className:"field-label mb-2",children:"Poäng (0-100)"}),r.jsx("input",{id:"airpistol-points",type:"number",name:"points",inputMode:"decimal",min:"0",max:"100",step:"1","aria-label":"Poäng i luftpistolserie","aria-invalid":Boolean(u.points),"aria-describedby":u.points?"error-points":"hint-points",value:c.points,onChange:m,className:"input py-3",required:!0}),u.points?r.jsx("p",{id:"error-points",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:u.points}):r.jsxs("p",{id:"hint-points",className:"mt-1 text-sm text-text-secondary",children:[d||"10 skott mot 10-ringad internationell luftpistoltavla",o.minPointsPerSeries&&` (Minst ${o.minPointsPerSeries} poäng krävs)`]})]}),r.jsxs(da,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"airpistol-series",className:"field-label mb-2",children:"Serienamn"}),r.jsx("input",{id:"airpistol-series",type:"text",name:"seriesName","aria-label":"Serienamn",value:c.seriesName,onChange:m,className:"input py-3",placeholder:"T.ex. Serie 1, Klubbtävling"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"airpistol-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"airpistol-notes",name:"notes","aria-label":"Anteckningar",value:c.notes,onChange:m,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, pistol använd, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sparar..."]}):"Spara & Stäng"}),n&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=h(c);f(t),0===Object.keys(t).length&&n&&n({...c,achievementType:"air_pistol_precision"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})},competition_performance:function({medal:e,onSubmit:a,onSubmitAndAddAnother:n,loading:s,preservedValues:i}){const l=t.useRef(null),{currentProfile:o}=ie(),d=t.useMemo(()=>function(e,t=null){const r=la(e?.requirements,"competition_performance");if(!r)return{disciplineType:"",weaponGroup:"C",maxPoints:null,thresholds:null};const a=r.disciplineType||"",n=t?.sex||"male";let s=null;return r.maxPoints&&(s=r.maxPoints[n]??r.maxPoints.male??null),{disciplineType:a,weaponGroup:"C",maxPoints:s,thresholds:r.pointThresholdPercent||null}}(e,o),[e,o]),c=t.useMemo(()=>oa(e,"competition_performance"),[e]),u=Boolean(d.disciplineType),m=e=>"field"===e.disciplineType&&e.maxScore>0?Math.round(Number(e.score)/Number(e.maxScore)*100):0,{values:p,errors:h,handleChange:f,handleSubmit:x,validate:g,setErrors:b}=sa({initialValues:{date:i?.date??(new Date).toISOString().split("T")[0],disciplineType:i?.disciplineType??d.disciplineType??"",weaponGroup:i?.weaponGroup??d.weaponGroup??"C",score:i?.score??"",maxScore:i?.maxScore??"",points:i?.points??d.maxPoints??"",competitionName:i?.competitionName??"",notes:""},validate:e=>{const t={};if(e.date||(t.date="Datum krävs"),e.disciplineType||(t.disciplineType="Disciplin krävs"),"field"===e.disciplineType){const r=Number(e.score),a=Number(e.maxScore);(""===e.score||!Number.isFinite(r)||r<0)&&(t.score="Uppnådd poäng krävs (0 eller högre)"),(""===e.maxScore||!Number.isFinite(a)||a<=0)&&(t.maxScore="Maxpoäng krävs (större än 0)"),r>a&&Number.isFinite(r)&&Number.isFinite(a)&&(t.score="Uppnådd poäng kan inte vara högre än maxpoäng")}else if("running"===e.disciplineType||"skiing"===e.disciplineType){const r=Number(e.points);(""===e.points||!Number.isFinite(r)||r<0)&&(t.points="Totalpoäng krävs (0 eller högre)")}return t},onSubmit:e=>{a({...e,scorePercent:m(e),achievementType:"competition_performance"})}});t.useEffect(()=>{const e=setTimeout(()=>{l.current?.focus()},100);return()=>clearTimeout(e)},[]);const y=t.useMemo(()=>{if("field"!==p.disciplineType)return null;const e=Number(p.score),t=Number(p.maxScore);return!Number.isFinite(e)||!Number.isFinite(t)||t<=0?null:Math.round(e/t*100)},[p.disciplineType,p.score,p.maxScore]),v=t.useMemo(()=>{if("field"!==p.disciplineType)return null;const e=d.thresholds?.[p.weaponGroup]?.min;return e?`Minst ${e}% krävs för grupp ${p.weaponGroup}`:null},[p.disciplineType,p.weaponGroup,d.thresholds]);return r.jsxs("form",{onSubmit:x,className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{ref:l,id:"competition-date",type:"date",name:"date","aria-label":"Datum för tävling","aria-invalid":Boolean(h.date),"aria-describedby":h.date?"error-date":void 0,value:p.date,onChange:f,className:"input py-3",required:!0}),h.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:h.date})]}),!u&&r.jsxs("fieldset",{children:[r.jsx("legend",{className:"field-label mb-2",children:"Disciplin"}),r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsxs("label",{className:"flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-bg-secondary",children:[r.jsx("input",{type:"radio",name:"disciplineType",value:"field",checked:"field"===p.disciplineType,onChange:f,className:"w-5 h-5"}),r.jsx("span",{children:"Fältskytte"})]}),r.jsxs("label",{className:"flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-bg-secondary",children:[r.jsx("input",{type:"radio",name:"disciplineType",value:"running",checked:"running"===p.disciplineType,onChange:f,className:"w-5 h-5"}),r.jsx("span",{children:"Terränglöpning/springskytte"})]})]}),h.disciplineType&&r.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:h.disciplineType})]}),u&&r.jsxs("div",{className:"p-3 bg-bg-secondary rounded-lg",children:[r.jsx("span",{className:"text-sm text-text-secondary",children:"Disciplin: "}),r.jsx("span",{className:"font-medium",children:"field"===p.disciplineType?"Fältskytte":"Terränglöpning/springskytte"})]}),"field"===p.disciplineType&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-weapon-group",className:"field-label mb-2",children:"Vapengrupp"}),r.jsxs("select",{id:"competition-weapon-group",name:"weaponGroup","aria-label":"Vapengrupp",value:p.weaponGroup,onChange:f,className:"select py-3 cursor-pointer",required:!0,children:[r.jsx("option",{value:"C",children:"Grupp C"}),r.jsx("option",{value:"B",children:"Grupp B"}),r.jsx("option",{value:"A",children:"Grupp A"}),r.jsx("option",{value:"R",children:"Grupp R"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-score",className:"field-label mb-2",children:"Uppnådd poäng"}),r.jsx("input",{id:"competition-score","data-tour":"achievement-primary-input",type:"number",name:"score",inputMode:"numeric",min:"0",step:"1","aria-label":"Uppnådd poäng","aria-invalid":Boolean(h.score),"aria-describedby":h.score?"error-score":"hint-score",value:p.score,onChange:f,className:"input py-3",required:!0}),h.score?r.jsx("p",{id:"error-score",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:h.score}):r.jsx("p",{id:"hint-score",className:"mt-1 text-sm text-text-secondary","data-tour":"achievement-hint",children:v||"Antal träff/poäng du uppnådde"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-maxscore",className:"field-label mb-2",children:"Maxpoäng"}),r.jsx("input",{id:"competition-maxscore",type:"number",name:"maxScore",inputMode:"numeric",min:"1",step:"1","aria-label":"Maxpoäng","aria-invalid":Boolean(h.maxScore),"aria-describedby":h.maxScore?"error-maxScore":"hint-maxScore",value:p.maxScore,onChange:f,className:"input py-3",required:!0}),h.maxScore?r.jsx("p",{id:"error-maxScore",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:h.maxScore}):r.jsx("p",{id:"hint-maxScore",className:"mt-1 text-sm text-text-secondary",children:"Maximal möjlig poäng för tävlingen (t.ex. 60 för 10 stationer)"})]}),null!==y&&r.jsxs("div",{className:"p-3 bg-bg-secondary rounded-lg",children:[r.jsx("span",{className:"text-sm text-text-secondary",children:"Beräknad procent: "}),r.jsxs("span",{className:"font-medium text-lg",children:[y,"%"]}),v&&r.jsxs("span",{className:"text-sm text-text-secondary ml-2",children:["(",v,")"]})]})]}),("running"===p.disciplineType||"skiing"===p.disciplineType)&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-points",className:"field-label mb-2",children:"Totalpoäng (lägre är bättre)"}),r.jsx("input",{id:"competition-points",type:"number",name:"points",inputMode:"numeric",min:"0",step:"1","aria-label":"Totalpoäng","aria-invalid":Boolean(h.points),"aria-describedby":h.points?"error-points":"hint-points",value:p.points,onChange:f,className:"input py-3",required:!0}),h.points?r.jsx("p",{id:"error-points",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:h.points}):r.jsxs("p",{id:"hint-points",className:"mt-1 text-sm text-text-secondary",children:[c||"Summa av löppoäng och skjutpoäng",d.maxPoints&&` (Max ${d.maxPoints} poäng krävs)`]})]}),r.jsxs(da,{label:"Valfria fält",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-name",className:"field-label mb-2",children:"Tävlingsnamn"}),r.jsx("input",{id:"competition-name",type:"text",name:"competitionName","aria-label":"Tävlingsnamn",value:p.competitionName,onChange:f,className:"input py-3",placeholder:"T.ex. DM Fältskytte, Klubbmästerskap"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"competition-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"competition-notes",name:"notes","aria-label":"Anteckningar",value:p.notes,onChange:f,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. väderförhållanden, vapen använt, etc."})]})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sparar..."]}):"Spara & Stäng"}),n&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=g(p);b(t),0===Object.keys(t).length&&n&&n({...p,scorePercent:m(p),achievementType:"competition_performance"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})},running_shooting_course:ca,skis_shooting_course:ca,standard_medal:function({medal:e,onSubmit:a,onSubmitAndAddAnother:n,loading:s,preservedValues:i}){const l=t.useRef(null),o=t.useMemo(()=>function(e){const t=la(e?.requirements,"standard_medal");return t?{disciplineType:t.disciplineType||"",medalType:t.medalType||""}:{disciplineType:"",medalType:""}}(e),[e]),d=t.useMemo(()=>oa(e,"standard_medal"),[e]),c=Boolean(o.disciplineType),{values:u,errors:m,handleChange:p,handleSubmit:h,validate:f,setErrors:x}=sa({initialValues:{date:i?.date??(new Date).toISOString().split("T")[0],disciplineType:o.disciplineType||"",medalType:o.medalType||"",notes:""},validate:e=>{const t={};return e.date||(t.date="Datum krävs"),e.disciplineType||(t.disciplineType="Välj en disciplin"),e.medalType||(t.medalType="Välj medaljnivå"),t},onSubmit:e=>a({...e,achievementType:"standard_medal"})});return t.useEffect(()=>{const e=setTimeout(()=>{l.current?.focus()},100);return()=>clearTimeout(e)},[]),r.jsxs("form",{onSubmit:h,className:"space-y-4",noValidate:!0,children:[d&&r.jsx("p",{className:"text-sm text-text-secondary bg-bg-secondary p-3 rounded-lg","data-tour":"achievement-hint",children:d}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"standard-medal-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{ref:l,id:"standard-medal-date",type:"date",name:"date","aria-label":"Datum för standardmedalj","aria-invalid":Boolean(m.date),"aria-describedby":m.date?"error-date":void 0,value:u.date,onChange:p,className:"input py-3",required:!0}),m.date&&r.jsx("p",{id:"error-date",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:m.date})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"standard-medal-discipline",className:"field-label mb-2",children:"Disciplin"}),c?r.jsxs(r.Fragment,{children:[r.jsx("input",{type:"hidden",name:"disciplineType",value:u.disciplineType}),r.jsxs("div",{className:"input py-3 bg-bg-secondary text-text-secondary",children:[ua.find(e=>e.value===u.disciplineType)?.label||u.disciplineType,r.jsx("span",{className:"text-xs ml-2",children:"(bestämt av märkeskrav)"})]})]}):r.jsxs("select",{id:"standard-medal-discipline",name:"disciplineType","aria-label":"Välj disciplin","aria-invalid":Boolean(m.disciplineType),"aria-describedby":m.disciplineType?"error-discipline":void 0,value:u.disciplineType,onChange:p,className:"input py-3",required:!0,children:[r.jsx("option",{value:"",children:"Välj disciplin..."}),ua.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]}),m.disciplineType?r.jsx("p",{id:"error-discipline",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:m.disciplineType}):!c&&r.jsx("p",{className:"mt-1 text-sm text-text-secondary",children:"Vilken skyttedisciplin standardmedaljen gäller"})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"standard-medal-type",className:"field-label mb-2",children:"Medaljnivå"}),r.jsxs("select",{id:"standard-medal-type","data-tour":"achievement-primary-input",name:"medalType","aria-label":"Välj medaljnivå","aria-invalid":Boolean(m.medalType),"aria-describedby":m.medalType?"error-medal-type":void 0,value:u.medalType,onChange:p,className:"input py-3",required:!0,children:[r.jsx("option",{value:"",children:"Välj nivå..."}),ma.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]}),m.medalType?r.jsx("p",{id:"error-medal-type",className:"mt-1 text-sm text-red-600 dark:text-red-400",children:m.medalType}):r.jsx("p",{className:"mt-1 text-sm text-text-secondary",children:"Vilken nivå på standardmedaljen du uppnått"})]}),r.jsx(da,{label:"Valfria fält",children:r.jsxs("div",{children:[r.jsx("label",{htmlFor:"standard-medal-notes",className:"field-label mb-2",children:"Anteckningar"}),r.jsx("textarea",{id:"standard-medal-notes",name:"notes","aria-label":"Anteckningar",value:u.notes,onChange:p,className:"textarea py-3 resize-none",rows:3,placeholder:"T.ex. tävlingsnamn, plats, etc."})]})}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-2",children:[r.jsx("button",{type:"submit",disabled:s,className:"btn btn-primary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsxs("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sparar..."]}):"Spara & Stäng"}),n&&r.jsx("button",{type:"button",onClick:e=>{e.preventDefault();const t=f(u);x(t),0===Object.keys(t).length&&n&&n({...u,achievementType:"standard_medal"})},disabled:s,className:"btn btn-secondary flex-1 py-3 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed",children:s?"Sparar...":"Spara & Lägg till fler"})]})]})}},xa={precision_series:"Precisionsserie",application_series:"Tillämpningsserie",speed_shooting_series:"Duellserie",competition_performance:"Tävlingsprestation",air_pistol_precision:"Luftpistolprecision",running_shooting_course:"Terränglopp med skytte",skis_shooting_course:"Skidlopp med skytte",standard_medal:"Standardmedalj"};function ga({medal:e,onSuccess:a,unlockMode:n=!1,compact:s=!1}){const{addAchievement:i,unlockMedal:l}=cr(),[o,d]=t.useState(null),[c,u]=t.useState(!1),[m,p]=t.useState(0),[h,f]=t.useState(null),[x,g]=t.useState(null),[b,y]=t.useState(null);t.useEffect(()=>{if(x){const e=setTimeout(()=>g(null),3e3);return()=>clearTimeout(e)}},[x]);const v=t.useMemo(()=>{if(n)return[];return function(e,t=20){if(!e)return[];const r=new Set;return function e(a,n=0){a&&"object"==typeof a&&(n>=t||(Array.isArray(a)?a.forEach(t=>e(t,n+1)):(a.type&&"string"==typeof a.type&&(["and","or","medal"].includes(a.type.toLowerCase())||r.add(a.type)),a.and&&Array.isArray(a.and)&&a.and.forEach(t=>e(t,n+1)),a.or&&Array.isArray(a.or)&&a.or.forEach(t=>e(t,n+1)))))}(e),Array.from(r)}(e?.requirements).filter(e=>fa[e])},[e,n]),j=t.useMemo(()=>function(e){if(!e||"object"!=typeof e)return"custom";const t=String(e.medals_type||e.category||"").toLowerCase(),r=String(e.type||"").toLowerCase(),a=String(e.displayName||e.name||"").toLowerCase(),n=String(e.tier||"").toLowerCase();if(r.includes("running")||r.includes("run")||/spring/.test(a)||/springskytte/.test(a))return"running_shooting";if("serie"===t||/series|serie/.test(r)||["gold","silver","bronze"].includes(n))return"competition";if("kvalificering"===t||/qual|kval/.test(r)||/qual|kval/.test(a))return"qualification";if(Boolean(e.team_medal)||/team|lag/.test(r)||/team|lag/.test(a))return"team_event";if(Boolean(e.event_only)||/event|cup|championship|mästerskap/.test(r)||/event|cup|championship|mästerskap/.test(a))return"event";const s=Array.isArray(e.requirements)?e.requirements:[];if(s.length){const e=s.map(e=>String(e?.type||"").toLowerCase());if(e.includes("running_shooting_course"))return"running_shooting";if(e.includes("precision_series"))return"competition";if(e.some(e=>e.includes("qualification")))return"qualification"}return"custom"}(e),[e]),w=n?"event":j,N=t.useMemo(()=>n?ia:h&&fa[h]?fa[h]:1===v.length&&fa[v[0]]?fa[v[0]]:ha[j]||ia,[n,h,v,j]),k=t.useMemo(()=>`achievement-logger-title-${e?.id||e?.medalId||"unknown"}`,[e]);return r.jsxs("div",{role:"region","aria-labelledby":k,className:s?"w-full":"card p-4 w-full",children:[!s&&r.jsxs("h2",{id:k,className:"section-title mb-4 break-words",children:[n?"Lås upp märke":"Logga Aktivitet",": ",e?.displayName||e?.name||e?.id]}),s&&r.jsxs("h2",{id:k,className:"sr-only",children:[n?"Lås upp märke":"Logga Aktivitet",": ",e?.displayName||e?.name||e?.id]}),x&&r.jsxs("div",{role:"status","aria-live":"polite",className:"mb-4 p-3 rounded-lg bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 border border-green-200 dark:border-green-800 flex items-center gap-2 animate-slide-down",children:[r.jsx(Ce,{name:"CheckCircle",className:"w-5 h-5","aria-hidden":"true"}),r.jsx("span",{children:x})]}),o&&r.jsxs("div",{className:"\n            mb-4 p-3 rounded-lg\n            bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300\n            border border-red-200 dark:border-red-800\n            flex items-center gap-2\n          ",role:"alert","aria-live":"assertive",children:[r.jsx("span",{"aria-hidden":"true",children:"✕"}),r.jsx("span",{children:o})]}),v.length>1&&!h&&r.jsxs("div",{className:"space-y-3 mb-4 animate-fade-in","data-tour":"achievement-type-selector",children:[!s&&r.jsx("p",{className:"text-sm text-text-secondary",children:"Detta märke kan tjänas genom olika typer av aktiviteter. Välj vilken typ du vill logga:"}),r.jsx("div",{className:"grid gap-2",children:v.map((e,t)=>r.jsx("button",{type:"button",onClick:()=>f(e),className:"btn btn-secondary py-3 min-h-[44px] text-left justify-start transform transition-all hover:scale-[1.02]",style:{animationDelay:50*t+"ms",animation:"slideInUp 0.2s ease-out forwards",opacity:0},children:xa[e]||e},e))})]}),(v.length<=1||h)&&r.jsxs(r.Fragment,{children:[v.length>1&&h&&r.jsx("div",{className:"mb-4 rounded-lg "+(s?"p-2 bg-bg-secondary/50":"p-3 bg-bg-secondary border border-border"),children:r.jsxs("p",{className:"text-sm text-text-secondary flex items-center justify-between",children:[r.jsxs("span",{children:[r.jsx("span",{className:"font-medium text-text-primary",children:"Typ:"})," ",xa[h]||h]}),r.jsx("button",{type:"button",onClick:()=>f(null),className:"text-xs text-primary hover:underline ml-2",children:"Byt typ"})]})}),r.jsx(N,{medal:e,preservedValues:b,onSubmit:async t=>{try{u(!0),d(null);const r=pa({medal:e,medalType:w,formData:t}),s=or(r);if(!s.valid)throw new Error(s.errors.join(" "));await i(r),n&&e?.id&&await l(e.id,r.date),a?.(r)}catch(r){d(r?.message||"Misslyckades att spara aktivitet")}finally{u(!1)}},onSubmitAndAddAnother:async t=>{try{u(!0),d(null);const r=pa({medal:e,medalType:w,formData:t}),a=or(r);if(!a.valid)throw new Error(a.errors.join(" "));await i(r),n&&e?.id&&await l(e.id,r.date),y({date:t.date,weaponGroup:t.weaponGroup,competitionName:t.competitionName,disciplineType:t.disciplineType,courseName:t.courseName,points:t.points,hits:t.hits,timeSeconds:t.timeSeconds,score:t.score,maxScore:t.maxScore,eventName:t.eventName,weapon:t.weapon,teamName:t.teamName,position:t.position,participants:t.participants}),g("Aktivitet sparad!"),p(e=>e+1),d(null)}catch(r){y({date:t.date,weaponGroup:t.weaponGroup,competitionName:t.competitionName,disciplineType:t.disciplineType,courseName:t.courseName,points:t.points,hits:t.hits,timeSeconds:t.timeSeconds,score:t.score,maxScore:t.maxScore,eventName:t.eventName,weapon:t.weapon,teamName:t.teamName,position:t.position,participants:t.participants,notes:t.notes}),p(e=>e+1),d(r?.message||"Misslyckades att spara aktivitet")}finally{u(!1)}},loading:c},m)]})]})}const ba=3e3,ya=3001,va=4e3,ja=4e3,wa=4001;function Na({medal:e,open:a,onClose:n}){const i=Dt();if(t.useEffect(()=>{if(!a)return;if(!i?.canAutoStart?.("achievement-entry"))return;const e=setTimeout(()=>{i.start("achievement-entry")},300);return()=>clearTimeout(e)},[a,i?.canAutoStart,i?.start]),!a||!e)return null;const l=r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 bg-black/50",style:{zIndex:ba},onClick:n,"aria-hidden":"true"}),r.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":"achievement-entry-title",style:{position:"fixed",zIndex:ya,inset:0,display:"flex",alignItems:"flex-end"},className:"sm:items-center sm:justify-center",children:r.jsxs("div",{"data-tour":"achievement-dialog",style:{width:"100%",maxWidth:"42rem",maxHeight:"90vh",overflow:"hidden"},className:"\n            bg-bg-primary rounded-t-xl sm:rounded-xl shadow-xl\n            flex flex-col\n            border-t border-border sm:border\n          ",children:[r.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border bg-bg-secondary",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("h2",{id:"achievement-entry-title",className:"text-lg font-semibold text-text-primary",children:"Logga aktivitet"}),r.jsx("button",{type:"button",onClick:()=>i?.start?.("achievement-entry"),className:"shrink-0 inline-flex min-h-[44px] min-w-[44px] items-center justify-center rounded-md text-muted-foreground hover:text-foreground hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","aria-label":"Visa guide",title:"Visa guide",children:r.jsx(Ce,{name:"HelpCircle",className:"w-5 h-5"})})]}),r.jsx("button",{type:"button",onClick:n,className:"shrink-0 inline-flex h-10 w-10 items-center justify-center rounded-md text-foreground hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","aria-label":"Stäng",children:r.jsx(Ce,{name:"X",className:"w-5 h-5"})})]}),r.jsx("div",{className:"flex-1 overflow-y-auto overscroll-contain p-4 sm:p-6",children:r.jsx(ga,{medal:e,onSuccess:n,unlockMode:!1,compact:!0})})]})})]});return s.createPortal(l,document.body)}function ka(e){const{medalDatabase:r}=se(),{currentProfile:a,lockMedal:n}=ie(),s=t.useMemo(()=>function(e=[]){const t=new Map;for(const r of e){const e=Array.isArray(r?.prerequisites)?r.prerequisites:[];for(const a of e)a&&"medal"===a.type&&a.medalId&&(t.has(a.medalId)||t.set(a.medalId,new Set),t.get(a.medalId).add(r.id))}return t}(r?.getAllMedals?.()||[]),[r]),i=t.useMemo(()=>function(e,t){const r=new Set;if(!e||!t)return r;const a=[e];for(;a.length;){const e=a.shift(),n=t.get(e);if(n)for(const t of n)r.has(t)||(r.add(t),a.push(t))}return r}(e,s),[e,s]),l=t.useMemo(()=>new Set((a?.unlockedMedals||[]).map(e=>e.medalId)),[a]),o=t.useMemo(()=>Array.from(i).filter(e=>l.has(e)),[i,l]),d=0===o.length,c=t.useCallback(async()=>{if(!e)return{ok:!1};if(!d)return{ok:!1,blocking:o};return{ok:!!(await n(e))}},[e,d,o,n]);return{canRemove:d,blocking:o,tryRemove:c}}function Sa(e){if(e.description)return e.description;const t=e.ageMin??0,r=e.ageMax??999;return r>=999?`${t}+ år`:0===t?`Under ${r+1} år`:`${t}-${r} år`}function Ca({matchedCategory:e}){if(!e)return null;const t=Sa(e);return r.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary",role:"status","aria-label":`Din ålderskategori: ${t}`,children:[r.jsx(Ce,{name:"User",className:"w-3 h-3","aria-hidden":"true"}),r.jsx("span",{children:t})]})}function Ma({ageCategories:e,matchedAgeCategory:a,type:n}){const[s,i]=t.useState(!1),l=t.useId();if(!e||0===e.length)return null;const o="precision_series"===n,d=o?"Poängkrav per ålderskategori":"Tidskrav per ålderskategori",c=o?"Min poäng":"Max tid";return r.jsxs("div",{className:"mt-2",children:[r.jsxs("button",{type:"button",onClick:()=>i(e=>!e),"aria-expanded":s,"aria-controls":l,className:["inline-flex items-center gap-1 text-xs text-muted-foreground","hover:text-foreground focus-visible:outline-none focus-visible:ring-2","focus-visible:ring-primary rounded px-1 py-0.5","min-h-[44px] min-w-[44px]"].join(" "),children:[r.jsx(Ce,{name:s?"ChevronDown":"ChevronRight",className:"w-3 h-3","aria-hidden":"true"}),r.jsx("span",{children:"Visa alla ålderskategorier"})]}),s&&r.jsxs("div",{id:l,className:"mt-2 overflow-x-auto",role:"region","aria-label":d,children:[r.jsxs("table",{className:"w-full text-xs border-collapse",children:[r.jsx("caption",{className:"sr-only",children:d}),r.jsx("thead",{children:r.jsxs("tr",{className:"border-b border-border",children:[r.jsx("th",{scope:"col",className:"text-left py-1 px-2 font-medium text-muted-foreground",children:"Ålderskategori"}),r.jsx("th",{scope:"col",className:"text-center py-1 px-2 font-medium text-muted-foreground","aria-label":`${c} vapengrupp A`,title:"Vapengrupp A: Grovkalibriga pistoler och revolvrar",children:"A"}),r.jsx("th",{scope:"col",className:"text-center py-1 px-2 font-medium text-muted-foreground","aria-label":`${c} vapengrupp B`,title:"Vapengrupp B: .22 sportpistol och revolver",children:"B"}),r.jsx("th",{scope:"col",className:"text-center py-1 px-2 font-medium text-muted-foreground","aria-label":`${c} vapengrupp C`,title:"Vapengrupp C: Finkalibriga pistoler och revolvrar",children:"C"})]})}),r.jsx("tbody",{children:e.map((e,t)=>{const n=e.name===a,s=function(e,t){if("precision"===t){const t=e.pointThresholds||{};return{A:t.A?.min??"-",B:t.B?.min??"-",C:t.C?.min??"-"}}const r=e.thresholds||{};return{A:"number"==typeof r.A?.maxTimeSeconds?`${r.A.maxTimeSeconds}s`:"-",B:"number"==typeof r.B?.maxTimeSeconds?`${r.B.maxTimeSeconds}s`:"-",C:"number"==typeof r.C?.maxTimeSeconds?`${r.C.maxTimeSeconds}s`:"-"}}(e,o?"precision":"application"),i=n?"bg-primary/10 font-medium":t%2==0?"bg-bg-secondary/50":"";return r.jsxs("tr",{className:i,"aria-current":n?"true":void 0,children:[r.jsx("td",{className:"py-1 px-2 text-left",children:r.jsxs("span",{className:"inline-flex items-center gap-1",children:[Sa(e),n&&r.jsxs(r.Fragment,{children:[r.jsx(Ce,{name:"ArrowLeft",className:"w-3 h-3 text-primary","aria-hidden":"true"}),r.jsx("span",{className:"sr-only",children:"(din kategori)"})]})]})}),r.jsx("td",{className:"py-1 px-2 text-center tabular-nums",children:s.A}),r.jsx("td",{className:"py-1 px-2 text-center tabular-nums",children:s.B}),r.jsx("td",{className:"py-1 px-2 text-center tabular-nums",children:s.C})]},e.name||t)})})]}),r.jsx("p",{className:"mt-1 text-xs text-muted-foreground","aria-live":"polite",children:a&&r.jsx("span",{className:"sr-only",children:"Din ålderskategori är markerad i tabellen."})})]})]})}function Aa({ageCategories:e,matchedAgeCategory:t,age:a,type:n}){if(!e||0===e.length)return null;const s=e.find(e=>e.name===t);return r.jsxs("div",{className:"mt-1",children:[r.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[r.jsx(Ca,{matchedCategory:s}),s&&r.jsxs("span",{className:"sr-only",children:["Åldersrabatt tillämpas baserat på din ålder (",a," år)."]})]}),r.jsx(Ma,{ageCategories:e,matchedAgeCategory:t,type:n})]})}function Ta({met:e}){return r.jsx(Ce,{name:e?"CheckCircle2":"Circle",className:e?"w-4 h-4 text-foreground shrink-0":"w-4 h-4 text-muted-foreground shrink-0"})}function _a({id:e,label:t,met:a,summary:n,expanded:s,onToggle:i}){return r.jsxs("button",{type:"button",onClick:i,"aria-expanded":s,"aria-controls":e,className:["w-full text-left inline-flex items-center justify-between","px-2 py-2 rounded","hover:bg-bg-secondary","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","min-h-[44px]"].join(" "),children:[r.jsxs("span",{className:"inline-flex items-center gap-2",children:[r.jsx(Ta,{met:a}),r.jsx("span",{className:"text-sm font-semibold text-foreground",children:t}),n?r.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",n,")"]}):null]}),r.jsx("span",{"aria-hidden":"true",className:"ml-2",children:s?"▼":"▶"})]})}function Pa({leaf:e}){const t=e.description||e.type||"Krav",a=e.progress&&Number.isFinite(e.progress.current)&&Number.isFinite(e.progress.required)?`${e.progress.current}/${e.progress.required}`:null,n=null!=e.windowYear?e.windowYear:null!=e.subtreeYear?e.subtreeYear:null,s=null!=n?`• År ${n}`:null,i=Array.isArray(e.ageCategories)&&e.ageCategories.length>0;return r.jsxs("div",{className:"px-2 py-1",children:[r.jsxs("div",{className:"flex items-start gap-2",children:[r.jsx(Ta,{met:!!e.isMet}),r.jsxs("span",{className:(e.isMet?"text-foreground":"text-muted-foreground")+" flex-1 min-w-0",children:[t," ",s?r.jsx("span",{className:"text-xs text-muted-foreground",children:s}):null]}),a?r.jsx("span",{className:"ml-auto shrink-0 text-xs text-muted-foreground tabular-nums",children:a}):null]}),i&&r.jsx("div",{className:"ml-6",children:r.jsx(Aa,{ageCategories:e.ageCategories,matchedAgeCategory:e.matchedAgeCategory,age:e.age,type:e.type})})]})}function Ia(e=[]){const t=e.length;return{met:e.reduce((e,t)=>e+(t.isMet?1:0),0),total:t}}function Da({node:e,path:a="root",level:n=0,defaultExpanded:s=0===n}){const[i,l]=t.useState(s),o=`${a}-group`,d="and"===e?.node||"or"===e?.node;if(!e)return null;const c=n>0?"border-l border-border pl-3":"pl-0";if(d){const t=e.children||[];if(1===t.length)return r.jsx(Da,{node:t[0],path:a,level:n,defaultExpanded:s})}if(!d){const t=e.leaf||{isMet:!1,description:"Okänt krav"};if(t.subtree){const e=`${a}-leaf`,s=t.subtree,o=s&&("and"===s.node||"or"===s.node),d=Array.isArray(s?.children),u=o&&d&&1===s.children.length;if(!o||u)return r.jsx("li",{className:c,children:r.jsx(Da,{node:t.subtree,path:`${a}-sub`,level:n,defaultExpanded:n<1})});let m=null;const p="and"===s.node?"Alla följande":"Minst en av följande",h=t.description||p;if(d){const{met:e,total:r}=Ia(s.children),a=`${e}/${r} uppfyllda`;m=t.description?`${p} • ${a}`:a}return r.jsxs("li",{className:c,children:[r.jsx(_a,{id:e,label:h,met:!!t.isMet,summary:m,expanded:i,onToggle:()=>l(e=>!e)}),i&&r.jsx("ul",{id:e,role:"group",className:"ml-2 list-none m-0 p-0",children:(Array.isArray(s.children)?s.children:[]).map((e,t)=>r.jsx(Da,{node:e,path:`${a}-sub-${t}`,level:n+1,defaultExpanded:n<1},`${a}-sub-${t}`))})]})}return r.jsx("li",{className:c,children:r.jsx(Pa,{leaf:t})})}const u=e.children||[],{met:m,total:p}=Ia(u),h="and"===e.node?"Alla följande":"Minst en av följande",f=e.description||h,x=e.description?`${h} • ${m}/${p} uppfyllda`:`${m}/${p} uppfyllda`;return r.jsxs("li",{className:c,children:[r.jsx(_a,{id:o,label:f,met:!!e.isMet,summary:x,expanded:i,onToggle:()=>l(e=>!e)}),i&&r.jsx("ul",{id:o,role:"group",className:"ml-2 list-none m-0 p-0",children:u.map((e,t)=>r.jsx(Da,{node:e,path:`${a}-${t}`,level:n+1,defaultExpanded:n<1},`${a}-${t}`))})]})}function Fa({tree:e,bare:a=!1}){const n=t.useMemo(()=>{let t=e||null;for(;t&&("and"===t.node||"or"===t.node)&&Array.isArray(t.children)&&1===t.children.length;)t=t.children[0];return t},[e]);if(!n)return null;const s="and"===n.node,i=r.jsx("ul",{className:"list-none m-0 p-0 text-sm text-muted-foreground space-y-1",children:s?(n.children||[]).map((e,t)=>r.jsx(Da,{node:e,path:`root-${t}`,level:0,defaultExpanded:!0},`root-${t}`)):r.jsx(Da,{node:n,level:0,defaultExpanded:!0})});return a?i:r.jsx("div",{className:"bg-background border border-border rounded p-3",role:"region","aria-label":"Krav",children:i})}function qa({id:e,title:a,summary:n,collapsible:s=!1,defaultOpen:i=!0,children:l}){const o=t.useId(),d=e?`${e}-body`:`${o}-body`,[c,u]=t.useState(i),m=s?"button":"div",p=s?{type:"button",onClick:()=>u(e=>!e),"aria-expanded":c,"aria-controls":d}:{};return r.jsxs("div",{className:"mb-4 bg-background border border-border rounded",children:[r.jsxs(m,{...p,className:"w-full text-left px-3 py-2 flex items-center justify-between hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded-t min-h-[44px]",children:[r.jsx("span",{className:"text-sm font-semibold text-foreground",children:a}),r.jsxs("span",{className:"inline-flex items-center gap-2 text-xs text-muted-foreground",children:[n?r.jsxs("span",{children:["(",n,")"]}):null,s?r.jsx("span",{"aria-hidden":"true",children:c?"▼":"▶"}):null]})]}),(!s||c)&&r.jsx("div",{id:d,className:"px-3 pb-3",children:l})]})}function Ea({status:e,className:t="",id:a,...n}){const s=Dr(e);return s?r.jsxs("span",{id:a,className:`${s.className} ${t}`.trim(),title:s.description,"aria-label":`${s.label}. ${s.description}`,...n,children:[r.jsx(Ce,{name:s.icon,className:"w-4 h-4"}),r.jsx("span",{children:s.label})]}):null}function $a(e){const t=Nr(e.type),r=[],a=function(e){if(!e)return null;try{const t=new Date(e);return Number.isNaN(t.getTime())?null:t.toISOString().slice(0,10)}catch{return null}}(e.date);switch(a?r.push(a):e.year&&r.push(String(e.year)),e.weaponGroup&&r.push(`Grupp ${e.weaponGroup}`),e.type){case"precision_series":case"speed_shooting_series":case"air_pistol_precision":case"running_shooting_course":"number"==typeof e.points&&r.push(`${e.points} p`);break;case"application_series":"number"==typeof e.hits&&r.push(`${e.hits} tr`),"number"==typeof e.timeSeconds&&r.push(`${e.timeSeconds} s`);break;case"competition_result":case"cumulative_competition_score":"number"==typeof e.score&&r.push(`${e.score} p`),e.competitionName&&r.push(e.competitionName);break;case"competition_performance":"number"==typeof e.scorePercent?r.push(`${e.scorePercent}%`):"number"==typeof e.points&&r.push(`${e.points} p`);break;case"shooting_round":"number"==typeof e.totalPoints&&r.push(`${e.totalPoints} p`);break;case"standard_medal":if(e.disciplineType&&r.push(e.disciplineType),e.medalType){const t={bronze:"Brons",silver:"Silver",gold:"Guld"};r.push(t[e.medalType]||e.medalType)}}return{id:e.id,type:e.type,label:t,details:r.join(" - "),date:a||(e.year?String(e.year):null),year:e.year}}function Ga({medal:e,unlockedEntry:a,profile:n}){const[s,i]=t.useState(!1),l=t.useMemo(()=>function({unlockedEntry:e,profile:t}){if(!e?.achievementIds?.length)return[];if(!t?.prerequisites?.length)return[];const r=new Set(e.achievementIds);return t.prerequisites.filter(e=>e.id&&r.has(e.id))}({unlockedEntry:a,profile:n}),[a,n]),o=t.useMemo(()=>l.map($a),[l]),d=t.useMemo(()=>function({medal:e,achievements:t,unlockedDate:r,profileName:a}){const n=[];if(n.push("KVALIFICERINGSKVITTO"),n.push("===================="),n.push(`Marke: ${e?.displayName||e?.name||"Okant"}`),r){const e=new Date(r).getFullYear();n.push(`Upplast: ${e}`)}return a&&n.push(`Profil: ${a}`),n.push(""),n.push("KVALIFICERANDE AKTIVITETER:"),n.push("---------------------------"),0===t.length?n.push("(Inga aktiviteter registrerade)"):t.forEach((e,t)=>{const r=$a(e);n.push(`${t+1}. ${r.label}`),r.details&&n.push(`   ${r.details}`),n.push("")}),n.push("---------------------------"),n.push("Genererat av SPSF Medal Explorer"),n.join("\n")}({medal:e,achievements:l,unlockedDate:a?.unlockedDate,profileName:n?.displayName}),[e,l,a,n]);if(!a?.achievementIds?.length)return null;if(0===l.length)return null;return r.jsxs(qa,{id:`receipt-${e?.id||"unknown"}`,title:"Kvalificeringskvitto",summary:`${l.length} aktivitet${1!==l.length?"er":""}`,collapsible:!0,defaultOpen:!1,children:[r.jsx("ul",{className:"space-y-3 mb-4",role:"list",children:o.map(e=>r.jsxs("li",{className:"flex items-start gap-2 text-sm",children:[r.jsx(Ce,{name:"CheckCircle2",className:"w-4 h-4 text-foreground shrink-0 mt-0.5","aria-hidden":"true"}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("div",{className:"text-foreground font-medium",children:e.label}),e.details&&r.jsx("div",{className:"text-muted-foreground text-xs mt-0.5",children:e.details})]})]},e.id))}),r.jsxs("button",{type:"button",onClick:async()=>{try{await navigator.clipboard.writeText(d),i(!0),setTimeout(()=>i(!1),2e3)}catch{const e=document.createElement("textarea");e.value=d,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.select();try{document.execCommand("copy"),i(!0),setTimeout(()=>i(!1),2e3)}catch{}document.body.removeChild(e)}},className:"w-full sm:w-auto min-h-[44px] px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary flex items-center justify-center gap-2",children:[r.jsx(Ce,{name:s?"Check":"Copy",className:"w-4 h-4","aria-hidden":"true"}),r.jsx("span",{"aria-live":"polite",children:s?"Kopierat!":"Kopiera som text"})]})]})}const Ba=t.lazy(()=>e(()=>import("./vendor-BbIsC1Kr.js").then(e=>e.p),[]));function La({medalId:e,onClose:a,onNavigateMedal:n}){const{medalDatabase:s}=se(),o=oe(),d=le(),{currentProfile:c}=ie(),u=!!c?.features?.allowManualUnlock,m=s?.getMedalById(e),[p,h]=t.useState({value:null,medalId:null}),f=p.medalId===e?p.value:null,{state:x}=Jt("achievementEntry"),[g,b]=t.useState(!1),[v,j]=t.useState(!1),w=l(),N=i(),k=m?`medal-req-original-${m.id}`:void 0,S=m?`medal-unlock-targets-${m.id}`:void 0,{canRemove:C,blocking:M,tryRemove:A}=ka(e),[T,_]=t.useState(!1),[P,I]=t.useState(!1),D=t.useMemo(()=>o&&(o.unlocked.find(t=>t.medalId===e)||o.eligible.find(t=>t.medalId===e)||o.available.find(t=>t.medalId===e)||o.locked.find(t=>t.medalId===e))||null,[o,e]),F=t.useMemo(()=>"unlocked"!==D?.status?null:D?.unlockedDate||d?.getUnlockedDate?.(e)||null,[D,d,e]),q=t.useMemo(()=>{if(!F)return null;const e=new Date(F);return Number.isNaN(e.getTime())?null:e.getFullYear()},[F]),E=t.useMemo(()=>{if(!d||!e)return[];try{return d.getEligibleYears(e)||[]}catch{return[]}},[d,e]),$=t.useMemo(()=>{if(!d)return[];try{return d.getAllAchievementYears()||[]}catch{return[]}},[d]),G=(new Date).getFullYear(),B=t.useMemo(()=>null!=q?q:null!=f?f:E.includes(G)?G:E.length>0?Math.max(...E):G,[q,f,E,G]),L=t.useMemo(()=>{const e=new Set([G,...E]);return Array.from(e).sort((e,t)=>t-e)},[G,E]),Y=t.useMemo(()=>{if(!m)return null;if("unlocked"===D?.status&&D?.details?.tree)return D.details.tree;try{return d?.checkRequirements?.(m,{endYear:B})?.tree??null}catch{return null}},[d,m,D,B]),R=t.useMemo(()=>{if(!Y)return null;const e={met:0,total:0},t=r=>{if(r){if("leaf"===r.node)return e.total+=1,void(r.leaf?.isMet&&(e.met+=1));for(const e of r.children||[])t(e)}};return t(Y),e},[Y]),O=t.useMemo(()=>{if(!d||!m)return{allMet:!0,items:[],missingItems:[]};try{return d.checkPrerequisites(m)}catch{return{allMet:!0,items:[],missingItems:[]}}},[d,m]),V=t.useMemo(()=>{const e=new Set;for(const t of O.missingItems||[])t&&"medal"===t.type&&t.offsetChecked&&e.add(t.medalId);return e},[O]),U=t.useMemo(()=>(O.items||[]).map(e=>{if("medal"===e.type){const t=s?.getMedalById?.(e.medalId),r=V.has(e.medalId);return{...e,displayName:t?.displayName||t?.name||e.medalId,displayMet:e.isMet&&!r,gapFailed:r}}return{...e,displayMet:e.isMet}}),[O,V,s]),z=t.useMemo(()=>{const e=U||[],t=e.length;return{met:e.reduce((e,t)=>e+(t.displayMet?1:0),0),total:t}},[U]),K=!0===O?.allMet,H=m?`unlock-prereq-hint-${m.id}`:void 0,W=t.useMemo(()=>(M||[]).map(e=>s?.getMedalById(e)).filter(Boolean),[M,s]),X=t.useMemo(()=>(Array.isArray(m?.references)?m.references:[]).map(e=>{const t=s?.getMedalById?.(e.medalId);return t?{target:t,description:e.description||""}:null}).filter(Boolean),[m,s]),J=t.useMemo(()=>{if(!m||!s?.getAllMedals)return[];return s.getAllMedals().filter(e=>e?.id!==m.id&&Array.isArray(e?.prerequisites)&&e.prerequisites.some(e=>"medal"===e?.type&&e.medalId===m.id)).map(e=>({target:e}))},[m,s]),Z=t.useRef(null),Q=t.useRef(null),ee=t.useRef(null),te=`medal-detail-title-${e||"unknown"}`,re=!!m&&("function"==typeof m.isPlaceholder?m.isPlaceholder():"placeholder"===m.status),ae=!(!m||re)&&("function"==typeof m.isUnderReview?m.isUnderReview():"under_review"===m.status),ne=m?.description?`medal-detail-desc-${e||"unknown"}`:null,de=ae&&m?`under-review-note-${m.id}`:null,ce=re&&m?`placeholder-note-${m.id}`:null,ue=[ne,de,ce].filter(Boolean).join(" ")||void 0;if(t.useEffect(()=>{if(!m)return;ee.current="undefined"!=typeof document?document.activeElement:null;const e="undefined"!=typeof document?document.body:null,t=e?e.style.overflow:"";e&&(e.style.overflow="hidden");const r=Q.current;r&&(r.classList.remove("translate-y-full","sm:translate-x-full"),r.classList.add("translate-y-0","sm:translate-x-0"));const n=setTimeout(()=>{const e=Q.current?.querySelector(`#${te}`);e&&e.focus?e.focus():Q.current?.focus()},0),s=e=>{"Escape"===e.key&&(e.preventDefault(),a?.())};return window.addEventListener("keydown",s),()=>{clearTimeout(n),window.removeEventListener("keydown",s),e&&(e.style.overflow=t);const r=ee.current;if(r&&"function"==typeof r.focus)try{r.focus()}catch{}}},[a,te,m]),t.useEffect(()=>{if(!m)return;if("undefined"==typeof document)return;const t=document.title,r=m.displayName||m.name||String(e);try{document.title=`${r} - Detaljer`}catch{}return()=>{try{document.title=t}catch{}}},[m,e]),!m)return null;const me={ul:e=>r.jsx("ul",{className:"list-disc pl-5 my-2 space-y-1",...e}),ol:e=>r.jsx("ol",{className:"list-decimal pl-5 my-2 space-y-1",...e}),li:e=>r.jsx("li",{className:"marker:text-muted-foreground",...e}),table:e=>r.jsx("div",{className:"my-2 overflow-x-auto",children:r.jsx("table",{className:"w-full text-sm border-collapse",...e})}),thead:e=>r.jsx("thead",{className:"bg-bg-secondary",...e}),th:e=>r.jsx("th",{className:"border border-border px-2 py-1 text-left font-semibold",...e}),td:e=>r.jsx("td",{className:"border border-border px-2 py-1 align-top",...e}),a:({href:e,children:t,...a})=>r.jsx("a",{href:e,className:"underline text-primary hover:text-primary-hover",target:"_blank",rel:"noopener noreferrer",...a,children:t}),code:e=>r.jsx("code",{className:"px-1 py-0.5 rounded bg-bg-secondary",...e})},pe=e=>t=>{if(!!(0!==t.button||t.metaKey||t.ctrlKey||t.altKey||t.shiftKey))return;if(t.preventDefault(),"function"==typeof n)return void n(e);const r=N.state?.backgroundLocation;w(`/medals/${e}`,{state:r?{backgroundLocation:r}:void 0})};return r.jsxs("div",{ref:Z,onClick:e=>{e.target===Z.current&&a?.()},className:"fixed inset-0 z-50 bg-black/50",children:[r.jsx("div",{ref:Q,role:"dialog","data-tour":"medal-detail-panel","aria-modal":"true","aria-labelledby":te,"aria-describedby":ue,tabIndex:-1,onKeyDown:e=>{if("Tab"!==e.key)return;const t=Q.current;if(!t)return;const r=t.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');if(0===r.length)return void e.preventDefault();const a=r[0],n=r[r.length-1],s=document.activeElement;e.shiftKey&&s===a?(e.preventDefault(),n.focus()):e.shiftKey||s!==n||(e.preventDefault(),a.focus())},className:["pointer-events-auto fixed","inset-x-0 bottom-0 w-full h-[90svh] max-h-[90vh]","sm:inset-y-0 sm:right-0 sm:left-auto sm:w-[32rem] lg:w-[40rem] xl:w-[48rem] sm:h-full","bg-bg-secondary shadow-2xl overflow-hidden","rounded-t-2xl sm:rounded-none sm:rounded-l-2xl","transform transition-transform duration-200 ease-out motion-reduce:transition-none","translate-y-full sm:translate-y-0 sm:translate-x-full","focus:outline-none"].join(" "),children:r.jsxs("div",{className:"flex h-full flex-col",children:[r.jsxs("div",{className:"sticky top-0 z-10 flex items-start justify-between gap-4 p-4 sm:p-6 bg-bg-secondary border-b border-border",children:[r.jsx("div",{className:"min-w-0",children:r.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[r.jsx("h2",{id:te,"data-tour":"medal-detail-title",className:"text-xl sm:text-2xl font-bold text-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary break-words",tabIndex:-1,children:m.displayName}),r.jsx("div",{role:"status","aria-live":"polite",className:"mt-1 sm:mt-0",children:re?r.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-900 border border-indigo-300 dark:bg-indigo-900/30 dark:text-indigo-200 dark:border-indigo-700","aria-label":"Status: plats­hållare",children:[r.jsx(pt,{status:"placeholder",className:"w-3.5 h-3.5"}),"Plats­hållare"]}):r.jsx(Ea,{status:D?.status||"locked"})}),ae&&r.jsxs("span",{className:"mt-1 sm:mt-0 inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-900 border border-amber-300 dark:bg-amber-900/40 dark:text-amber-200 dark:border-amber-700","aria-label":"Status för regler: under granskning",children:[r.jsx(pt,{status:"review",className:"w-3.5 h-3.5"}),"Under granskning"]})]})}),r.jsx("button",{onClick:a,className:"shrink-0 inline-flex h-10 w-10 items-center justify-center rounded-md text-foreground hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary","aria-label":"Stäng medal-detaljer",title:"Stäng",children:r.jsx("span",{"aria-hidden":"true",children:"✕"})})]}),r.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto overscroll-contain p-4 sm:p-6",children:[r.jsx("div",{className:"mb-4",children:r.jsx(Je,{id:"disclaimer-rules",variant:"warning",text:"Regelboken gäller före appens tolkning. Kontrollera alltid senaste officiella regelbok.",linkUrl:qe})}),re&&r.jsxs(r.Fragment,{children:[r.jsx("p",{id:ce,className:"sr-only",children:"Detta är ett platshållarmärke. Avsnitten nedan visar exempel på information som kommer att finnas här när märket publiceras."}),r.jsx(qa,{id:`placeholder-unlocked-${m.id}`,title:"Upplåst",collapsible:!1,children:r.jsx("p",{className:"text-sm text-muted-foreground",children:"Här visas normalt vilket år du låste upp märket."})}),r.jsx(qa,{id:`placeholder-prereq-${m.id}`,title:"Förhandskrav",collapsible:!1,children:r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[r.jsx("li",{children:"• Exempel: krav eller förkunskap 1"}),r.jsx("li",{children:"• Exempel: krav eller förkunskap 2"}),r.jsx("li",{children:"• Exempel: krav eller förkunskap 3"})]})}),r.jsx(qa,{id:`placeholder-req-${m.id}`,title:"Krav",collapsible:!1,children:r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[r.jsxs("li",{children:[r.jsx("span",{className:"text-foreground",children:"✓"})," Exempel: uppfyllt krav"]}),r.jsxs("li",{children:[r.jsx("span",{className:"text-muted-foreground",children:"○"})," Exempel: krav som återstår"]}),r.jsxs("li",{children:[r.jsx("span",{className:"text-muted-foreground",children:"○"})," Exempel: ytterligare krav"]})]})}),r.jsx(qa,{id:ne||`placeholder-desc-${m.id}`,title:"Beskrivning",collapsible:!1,children:r.jsx("p",{className:"text-muted-foreground break-words",children:"Beskrivning kommer att visas här när innehållet är klart."})}),r.jsx(qa,{id:k,title:"Visa ursprunglig kravtext",collapsible:!0,defaultOpen:!1,children:r.jsx("div",{className:"text-sm text-foreground break-words",children:r.jsx(t.Suspense,{fallback:null,children:r.jsx(Ba,{remarkPlugins:[y],components:me,children:"Det här avsnittet visar vanligtvis den ursprungliga kravtexten från regelboken.\n\n- Exempelpunkt 1\n- Exempelpunkt 2\n- Exempelpunkt 3"})})})}),r.jsx(qa,{id:`placeholder-refs-${m.id}`,title:"Uppfyller också kraven för",collapsible:!1,children:r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:r.jsx("li",{children:"• Kommer snart"})})}),r.jsx(qa,{id:`placeholder-required-for-${m.id}`,title:"Detta märke krävs för",collapsible:!1,children:r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:r.jsx("li",{children:"• Kommer snart"})})})]}),!re&&null!=q&&r.jsx(qa,{id:`unlocked-${m.id}`,title:"Upplåst",collapsible:!1,children:r.jsx("div",{role:"status","aria-live":"polite",children:r.jsx("p",{className:"text-sm text-foreground",children:r.jsx("time",{dateTime:function(){try{return new Date(F).toISOString().slice(0,10)}catch{return String(F)}}(),children:q})})})}),!re&&"unlocked"===D?.status&&r.jsx(Ga,{medal:m,unlockedEntry:c?.unlockedMedals?.find(t=>t.medalId===e),profile:c}),!re&&U.length>0&&r.jsx(qa,{id:`prereq-${m.id}`,title:"Förhandskrav",summary:`${z.met}/${z.total} uppfyllda`,collapsible:!1,children:r.jsx("ul",{className:"list-none m-0 p-0 text-sm text-muted-foreground space-y-1",children:U.map((e,t)=>r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(Ce,{name:e.displayMet?"CheckCircle2":"Circle",className:e.displayMet?"w-4 h-4 text-foreground shrink-0":"w-4 h-4 text-muted-foreground shrink-0"}),r.jsx("span",{className:"sr-only",children:e.displayMet?"Uppfyllt":"Saknas"}),r.jsx("span",{className:"text-foreground flex-1 min-w-0 break-words",children:"medal"===e.type?e.displayName||e.medalId:e.description||e.type}),"medal"===e.type&&"number"==typeof e.yearOffset?r.jsxs("span",{className:e.gapFailed?"text-danger":"text-muted-foreground",children:["Kräver ",e.yearOffset," års gap"]}):null]},t))})}),ae&&r.jsx("div",{id:`under-review-note-${m.id}`,className:"mb-4 alert alert-warning",children:"Reglerna för det här märket är under granskning och kan komma att ändras."}),!re&&m.description&&r.jsx("div",{className:"mb-4",children:r.jsx("p",{id:ne,className:"text-muted-foreground break-words",children:m.description})}),!re&&D?.details?.missingItems?.length>0&&r.jsxs("div",{className:"mb-4 bg-background border border-border rounded p-3",children:[r.jsx("p",{className:"text-sm font-semibold text-foreground mb-2",children:"Saknade förhandskrav:"}),r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:D.details.missingItems.map((e,t)=>r.jsxs("li",{className:"break-words",children:["• ",e.description]},t))})]}),!re&&Y&&r.jsxs(r.Fragment,{children:["unlocked"!==D?.status&&L.length>1&&r.jsxs("div",{className:"mb-4",children:[r.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[r.jsx("label",{htmlFor:"year-selector",className:"text-sm font-medium text-foreground",children:"Visa framsteg för år:"}),r.jsx("button",{type:"button","aria-label":"Information om årsvisa krav",className:"inline-flex items-center justify-center w-5 h-5 rounded-full bg-bg-secondary hover:bg-background border border-border text-xs text-muted-foreground",title:"Kraven måste uppfyllas under samma kalenderår",children:r.jsx(Ce,{name:"Info",className:"w-3.5 h-3.5"})})]}),r.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-thin",role:"group","aria-label":"Välj år",children:L.map(t=>{const a=t===B,n=E.includes(t),s=t===G,i=$.includes(t);return r.jsx("button",{type:"button",onClick:()=>(t=>h({value:t,medalId:e}))(t),"aria-pressed":a,"aria-label":`År ${t}${s?" (nuvarande år)":""}${n?" (kvalificerad)":""}${i?" (har aktiviteter)":""}`,className:["shrink-0 px-4 py-2 rounded-lg text-sm font-medium transition-colors min-h-[44px]","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",a?n?"bg-green-100 text-green-900 border-2 border-green-500 dark:bg-green-900/30 dark:text-green-100 dark:border-green-600":s?"bg-primary text-primary-foreground border-2 border-primary":"bg-bg-secondary text-foreground border-2 border-primary":"bg-bg-secondary text-foreground border border-border hover:bg-background"].join(" "),children:r.jsxs("span",{className:"flex items-center gap-1.5",children:[t,n&&r.jsx(Ce,{name:"CheckCircle2",className:a?"w-4 h-4":"w-4 h-4 text-green-600 dark:text-green-400","aria-hidden":"true"}),s&&!n&&r.jsx(Ce,{name:"Circle",className:"w-3 h-3 fill-current","aria-hidden":"true"})]})},t)})}),r.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:[r.jsx(Ce,{name:"CheckCircle2",className:"w-3 h-3 inline text-green-600 dark:text-green-400","aria-hidden":"true"})," = Kvalificerad för detta år"," • ",r.jsx(Ce,{name:"Circle",className:"w-2.5 h-2.5 inline fill-current","aria-hidden":"true"})," = Nuvarande år"]})]}),r.jsx(qa,{id:`req-${m.id}`,title:"Krav",summary:R?`${R.met}/${R.total} uppfyllda${"unlocked"!==D?.status?` • ${B}`:""}`:void 0,collapsible:!1,children:r.jsx(Fa,{tree:Y,bare:!0})})]}),!re&&m.requirementsOriginal&&r.jsx(qa,{id:k,title:"Visa ursprunglig kravtext",collapsible:!0,defaultOpen:!1,children:r.jsx("div",{className:"text-sm text-foreground break-words",children:r.jsx(t.Suspense,{fallback:null,children:r.jsx(Ba,{remarkPlugins:[y],components:me,children:m.requirementsOriginal})})})}),!re&&X.length>0&&r.jsx(qa,{id:`refs-${m.id}`,title:"Uppfyller också kraven för",summary:`${X.length}`,collapsible:!0,defaultOpen:!1,children:r.jsx("ul",{className:"space-y-1",children:X.map(({target:e})=>r.jsx("li",{children:r.jsx("a",{href:`/medals/${e.id}`,onClick:pe(e.id),className:"inline-flex items-center underline text-primary hover:text-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary px-2 py-2 rounded min-h-[44px]",children:e.displayName||e.name})},e.id))})}),!re&&J.length>0&&r.jsx(qa,{id:S,title:"Detta märke krävs för",summary:`${J.length}`,collapsible:!0,defaultOpen:!1,children:r.jsx("ul",{className:"space-y-1",children:J.map(({target:e})=>r.jsx("li",{children:r.jsx("a",{href:`/medals/${e.id}`,onClick:pe(e.id),className:"inline-flex items-center underline text-primary hover:text-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary px-2 py-2 rounded min-h-[44px]",children:e.displayName||e.name})},e.id))})})]}),r.jsxs("div",{className:"flex flex-wrap gap-3 p-4 sm:p-6 border-t border-border pb-[calc(env(safe-area-inset-bottom)+1rem)]",children:[r.jsx("button",{onClick:a,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-background text-foreground hover:bg-bg-secondary ring-1 ring-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Stäng"}),c&&!re&&"locked"!==D?.status&&"off"!==x&&r.jsx("button",{type:"button",onClick:()=>j(!0),"aria-haspopup":"dialog",className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:r.jsxs("span",{className:"flex items-center justify-center gap-2",children:[r.jsx(Ce,{name:"Plus",className:"w-5 h-5"}),"Logga aktivitet"]})}),"unlocked"===D?.status&&c&&!re&&r.jsxs("div",{className:"flex-1 flex items-center gap-2",children:[r.jsx("button",{type:"button",onClick:()=>{C?(I(!1),_(!0)):(_(!1),I(!0))},"aria-haspopup":"dialog","aria-expanded":T||P,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-background text-foreground hover:bg-bg-secondary ring-1 ring-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Ta bort upplåst"}),!C&&r.jsx("button",{type:"button",onClick:()=>I(!0),className:"text-sm text-muted-foreground underline","aria-label":"Why can’t I remove this medal?",children:"Varför kan jag inte?"})]}),c&&!re&&("eligible"===D?.status||u&&"unlocked"!==D?.status)&&r.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[r.jsx("button",{type:"button",onClick:()=>b(!0),"aria-haspopup":"dialog","aria-controls":"unlock-medal",disabled:!K,"aria-disabled":!K,"aria-describedby":K?void 0:H,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary-hover disabled:opacity-60 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Lås upp nu"}),!K&&r.jsx("p",{id:H,className:"text-xs text-muted-foreground",children:"Förhandskraven måste uppnåst innan märket kan låsas upp."})]})]})]})}),r.jsx(aa,{medal:m,open:g,onClose:()=>b(!1),preferredYear:B}),r.jsx(na,{medal:m,open:T,onClose:()=>_(!1),variant:"confirm",onConfirmRemove:A}),r.jsx(na,{medal:m,open:P,onClose:()=>I(!1),variant:"blocked",blockingMedals:W}),r.jsx(Na,{medal:m,open:v,onClose:()=>j(!1)})]})}function Ya({children:e}){const{currentProfile:t}=ie(),a=l(),[n,s]=g.useState(!1),[i,o]=g.useState(!0);return t&&!t.isGuest?e:r.jsxs("div",{className:"p-6",children:[r.jsxs("div",{className:"card block p-6 w-full min-w-full max-w-xl mx-auto",role:"region","aria-labelledby":"profile-required-heading",children:[r.jsx("h2",{id:"profile-required-heading",className:"section-title mb-2",children:"Profil krävs för att fortsätta"}),r.jsxs("div",{className:"text-sm text-muted-foreground space-y-3 mb-4",children:[r.jsx("p",{children:"För att använda Inställningar och import/export behöver du en sparad profil."}),r.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[r.jsx("li",{children:"Spara dina framsteg och säkerhetskopiera data"}),r.jsx("li",{children:"Hantera inställningar per profil"}),r.jsx("li",{children:"Exportera och importera mellan enheter"})]}),t?.isGuest&&r.jsx("p",{children:"Du kan spara ditt nuvarande Gästläge som en profil och fortsätta utan att förlora något."})]}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",autoFocus:!0,onClick:()=>{o(!0),s(!0)},"aria-haspopup":"dialog","aria-controls":"save-progress-picker-guard",children:"Skapa profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>{o(!1),s(!0)},"aria-haspopup":"dialog","aria-controls":"save-progress-picker-guard",children:"Välj profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>a("/medals"),children:"Tillbaka till märken"})]})]}),r.jsx(Te,{id:"save-progress-picker-guard",mode:"picker",open:n,onClose:()=>s(!1),forceCreate:i,convertGuest:!0})]})}const Ra=[{id:"0.9.8",date:"2026-01-15",title:"Förhandsvisning av funktion för att registrera aktiviteter",highlights:["Förhandsvisning av funktion för att lägga in aktiviteter både direkt via märken och i bulk från inställnignar","Guide för hur man lägger in aktiviteter","Fixa inkorrekta åldersrabatter för vissa märken","Visa fler nästlade detaljer i kravlistan","Import och export av aktiviteter via CSV"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.8"},{id:"0.9.7",date:"2026-01-11",title:"Fixa buggar i gästläge",highlights:["Fixa buggar som gjorde gästläget oanvändbart","Visa vilka aktiviteter som låst upp respektive märke"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.7"},{id:"0.9.6",date:"2026-01-10",title:"Säkerhetsuppdatering",highlights:["Förbättringar av användarupplevelsen i trädvy","Buggfix av hantering årtal för medaljkrav","Säkerhetsuppdatering av beroenden"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.6"},{id:"0.9.5",date:"2026-01-08",title:"Fler märken och kön i profil",highlights:["Skidskyttemärken är tillagda för granskning","Mästarmärken är tillagda för granskning","Ett fåtal märken särskiljer kraven för män och kvinnor så profilen måste hålla den informationen","Interaktiv användarguide för trädvyn med stöd för mobil och helskärmsläge","Förenklad funktionalitet för backup och flytt av profildata"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.5"},{id:"0.9.4",date:"2026-01-04",title:"Buggfixar",highlights:["Mindre buggfixar"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.4"},{id:"0.9.3",date:"2026-01-03",title:"Användarguide",highlights:["Interaktiv användarguide för medaljlistan","Hänvisa till regelbok version 20 tillsvidare"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.3"},{id:"0.9.2",date:"2026-01-01",title:"Versionsnytt",highlights:["Versionsinformation med förändringslogg tillagd."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.2"},{id:"0.9.1",date:"2025-12-31",title:"Uppdateringar av märken för luftpistol",highlights:["Årsmärken för luftpistol korrigerade."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.1"},{id:"0.9.0",date:"2025-12-31",title:"Ny trädvy",highlights:["Ny trädvy för märken med tidslinje per märkestyp."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.0"}];function Oa(){const e=l(),a=i(),n=a.state?.backgroundLocation,s=qt(),o=t.useMemo(()=>function(e){const t=[...Ra].sort((e,t)=>{const r=String(e.id).split(".").map(e=>parseInt(e,10)||0),a=String(t.id).split(".").map(e=>parseInt(e,10)||0);for(let n=0;n<3;n++)if(r[n]!==a[n])return a[n]-r[n];return 0});if(!e)return t;const r=t.findIndex(t=>t.id===e);return r<=0?t:t.slice(0,r)}(Et()),[]),d=t.useRef(null),c=t.useRef(null),u=t.useCallback(()=>{if(function(e){try{e&&localStorage.setItem(Ft,e)}catch{}}(s),n&&n.pathname){const t=`${n.pathname}${n.search||""}${n.hash||""}`;e(t,{replace:!0})}else e(-1)},[s,n,e]);t.useEffect(()=>{c.current=document.activeElement;const e=d.current;if(!e)return;const t=()=>e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),r=e=>{const r=t(),a=r[0],n=r[r.length-1];if("Escape"===e.key)e.preventDefault(),u();else if("Tab"===e.key){if(0===r.length)return;e.shiftKey&&document.activeElement===a?(e.preventDefault(),n?.focus()):e.shiftKey||document.activeElement!==n||(e.preventDefault(),a?.focus())}},a=t();return a[0]?.focus(),e.addEventListener("keydown",r),()=>{e.removeEventListener("keydown",r),c.current&&"function"==typeof c.current.focus&&c.current.focus()}},[u]);const m=o[0]?.link||null,p=o.length>1?`Det finns ${o.length} uppdateringar sedan du senast tittade.`:"Här är det senaste som är nytt i appen.";return r.jsxs("div",{className:"fixed inset-0 z-50",onMouseDown:e=>{e.target===e.currentTarget&&u()},"aria-hidden":!1,children:[r.jsx("div",{className:"absolute inset-0 bg-black/50"}),r.jsx("div",{ref:d,role:"dialog","aria-modal":"true","aria-labelledby":"whatsnew-title","aria-describedby":"whatsnew-desc",className:["card","fixed inset-x-0 bottom-0 w-full max-h-[85vh] rounded-t-2xl shadow-lg","md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2","md:w-[min(90vw,640px)] md:rounded-xl","outline-none"].join(" "),tabIndex:-1,children:r.jsxs("div",{className:"p-4 sm:p-6",children:[r.jsxs("header",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{children:[r.jsx("h2",{id:"whatsnew-title",className:"text-xl font-semibold",children:"Nyheter"}),r.jsx("p",{id:"whatsnew-desc",className:"mt-1 text-sm text-muted-foreground",children:p})]}),r.jsx("button",{type:"button",className:"btn btn-muted","aria-label":"Stäng nyheter",onClick:u,children:"Stäng"})]}),r.jsx("div",{className:"mt-4 space-y-3 overflow-y-auto pr-1",style:{maxHeight:"55vh"},children:o.map((e,t)=>r.jsxs("details",{className:"rounded-lg border border-border p-3",open:0===t,children:[r.jsxs("summary",{className:"cursor-pointer select-none font-medium",children:[e.title||"Uppdatering"," • ",e.date," • ",e.id]}),r.jsx("ul",{className:"mt-2 list-disc pl-5 space-y-1 text-sm",children:(e.highlights||[]).map((e,t)=>r.jsx("li",{children:e},t))}),e.link&&r.jsx("div",{className:"mt-2",children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:e.link,target:"_blank",rel:"noreferrer",children:"Läs mer"})})]},e.id))}),r.jsxs("div",{className:"mt-4 flex items-center justify-end gap-3 safe-bottom",children:[m&&r.jsx("a",{className:"btn btn-secondary",href:m,target:"_blank",rel:"noreferrer",children:"Läs mer"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:u,children:"Ok, visa appen"})]})]})})]})}function Va(e,t,r){return Math.max(t,Math.min(r,e))}function Ua(e){if(!e)return null;try{return document.querySelector(e)}catch{return null}}function za(){const{open:e,stepIndex:a,steps:n,complete:s,next:i,back:l}=Dt(),o=n?.[a]||null,d=t.useRef(null),c=t.useRef(null),u=t.useRef(!1),[m,p]=t.useState(null),[h,f]=t.useState(!1);t.useEffect(()=>{u.current=!1},[a]);const x=t.useCallback(()=>{if(!e)return;if("undefined"==typeof document)return;const t=Ua(o?.target);if(!t)return p(null),void f(!1);f(!0);try{const e=t.getBoundingClientRect(),r=window.innerHeight;!(e.bottom>r/2)&&(e.top<0||e.bottom>r)&&t.scrollIntoView({block:"center",inline:"nearest",behavior:"smooth"})}catch{}const r=t.getBoundingClientRect();p({top:r.top,left:r.left,width:r.width,height:r.height,right:r.right,bottom:r.bottom})},[e,o?.target]),g=a>=(n?.length||1)-1,b=t.useMemo(()=>`tour-title-${o?.id||a}`,[o?.id,a]),y=t.useMemo(()=>`tour-desc-${o?.id||a}`,[o?.id,a]),v=t.useMemo(()=>`tour-hint-${o?.id||a}`,[o?.id,a]),j=t.useCallback(()=>{s()},[s]),w=t.useCallback(()=>{s()},[s]),N=!!o?.requiresTarget,k=o?.autoAdvanceToNextOn&&!Ua(o.autoAdvanceToNextOn),S=N&&!h||k,C=t.useCallback(()=>{S||(g?s():i())},[S,g,s,i]),M=t.useCallback(()=>{if("undefined"!=typeof document&&"detail"===o?.id){const e=Ua('button[aria-label="Stäng medal-detaljer"]');e?.click?.()}l()},[l,o?.id]);if(t.useEffect(()=>{if(!e)return;if("undefined"==typeof document)return;c.current=document.activeElement;const t=d.current;if(!t)return;const r=()=>t.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),a=e=>{if("Escape"===e.key)return e.preventDefault(),void j();if("Tab"!==e.key)return;const t=r();if(!t.length)return void e.preventDefault();const a=t[0],n=t[t.length-1];e.shiftKey&&document.activeElement===a?(e.preventDefault(),n?.focus()):e.shiftKey||document.activeElement!==n||(e.preventDefault(),a?.focus())},n=r();return(n[0]||t)?.focus?.(),t.addEventListener("keydown",a),()=>{t.removeEventListener("keydown",a);const e=c.current;if(e&&"function"==typeof e.focus)try{e.focus()}catch{}}},[e,j]),t.useEffect(()=>{if(!e)return;if("undefined"==typeof window)return;const t=window.requestAnimationFrame(()=>x()),r=window.requestAnimationFrame(()=>x()),a=window.setTimeout(()=>x(),220);let n=0;const s=()=>{n||(n=window.requestAnimationFrame(()=>{n=0,x()}))},i=()=>s();window.addEventListener("resize",i);const l=Ua(o?.target),d=l?function(e){if("undefined"==typeof window||!e)return null;let t=e;for(;t&&t!==document.body;){const e=window.getComputedStyle(t).overflowY;if("auto"===e||"scroll"===e)return t;t=t.parentElement}return window}(l):null;return d&&d!==window?d.addEventListener("scroll",s,{passive:!0}):window.addEventListener("scroll",s,!0),()=>{window.cancelAnimationFrame(t),window.cancelAnimationFrame(r),window.clearTimeout(a),window.removeEventListener("resize",i),d&&d!==window?d.removeEventListener("scroll",s):window.removeEventListener("scroll",s,!0),n&&window.cancelAnimationFrame(n)}},[e,a,o?.target,x]),t.useEffect(()=>{if(!e)return;if(g)return;if("undefined"==typeof document)return;const t=o?.autoAdvanceToNextOn;if(!t)return;const r=()=>{if(u.current)return;Ua(t)&&(u.current=!0,i())};r();const a=new MutationObserver(()=>r());return a.observe(document.body,{childList:!0,subtree:!0}),()=>a.disconnect()},[e,g,o?.autoAdvanceToNextOn,i]),!e||!o)return null;const A=(()=>{if(!m)return!1;if("undefined"==typeof window)return!1;const e=window.innerHeight;return m.bottom>e/2})(),T=(()=>{if(!m)return null;if("undefined"==typeof window)return null;if(o?.positionCenter)return null;const e=window.innerWidth,t=window.innerHeight;if(e<768)return null;const r="detail"===o?.id;return{position:"fixed",top:Va(r?m.top:m.bottom+10,12,t-12-220),left:Va(r?m.left-10-360:m.left,12,e-12-360),width:360}})(),_=m?{position:"fixed",top:Math.max(0,m.top-8),left:Math.max(0,m.left-8),width:Math.max(0,m.width+16),height:Math.max(0,m.height+16),borderRadius:16,boxShadow:"0 0 0 9999px rgba(0,0,0,0.55)",pointerEvents:"none",zIndex:va}:null;return r.jsxs("div",{className:"fixed inset-0 pointer-events-none",style:{zIndex:ja},"aria-hidden":!1,children:[_?r.jsx("div",{"aria-hidden":"true",style:_}):r.jsx("div",{className:"absolute inset-0 bg-black/50","aria-hidden":"true"}),r.jsx("div",{ref:d,role:"dialog","aria-modal":"true","aria-labelledby":b,"aria-describedby":S?`${y} ${v}`:y,tabIndex:-1,style:{...T,zIndex:wa,...A&&!T?{paddingTop:"env(safe-area-inset-top)"}:{}},className:["card","pointer-events-auto",T?"rounded-xl shadow-lg":A?"fixed inset-x-0 top-0 w-full max-h-[85vh] rounded-b-2xl shadow-lg":"fixed inset-x-0 bottom-0 w-full max-h-[85vh] rounded-t-2xl shadow-lg",T?"":"md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[min(90vw,520px)] md:rounded-xl","outline-none"].join(" "),children:r.jsxs("div",{className:A?"p-4 sm:p-6 pt-2":"p-4 sm:p-6",children:[r.jsxs("header",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{className:"min-w-0",children:[r.jsx("h2",{id:b,className:"text-lg sm:text-xl font-semibold text-foreground",children:o.title}),r.jsx("p",{id:y,className:"mt-1 text-sm text-muted-foreground",children:o.body}),S&&r.jsx("p",{id:v,className:"mt-2 text-xs text-muted-foreground",children:o.requiresTargetHint||"Slutför steget ovan för att fortsätta."})]}),r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:j,"aria-label":"Avsluta guiden",children:"Stäng"})]}),r.jsxs("div",{className:"mt-4 flex items-center justify-between gap-3",children:[r.jsxs("div",{className:"text-xs text-muted-foreground","aria-live":"polite",children:["Steg ",a+1," av ",n.length]}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:w,children:"Hoppa över"})]}),r.jsxs("div",{className:"mt-4 flex items-center justify-end gap-2 safe-bottom",children:[r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:M,disabled:0===a,"aria-disabled":0===a,children:"Tillbaka"}),r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:C,disabled:S,"aria-disabled":S,children:g?"Klart":"Nästa"})]})]})})]})}function Ka(){const{id:e}=N(),t=l(),a=i(),n=a.state?.backgroundLocation;return r.jsx(La,{medalId:e,onClose:()=>{if(n&&n.pathname){const e=`${n.pathname}${n.search||""}${n.hash||""}`;t(e,{replace:!0})}else t(-1)}})}function Ha(){const e=i(),a=l(),n=e.state?.backgroundLocation,s=e.pathname.startsWith("/medals/"),o="/whats-new"===e.pathname,d=(s||o)&&n?n:e,c=t.useRef(!1);return t.useEffect(()=>{if(c.current)return;if(c.current=!0,!$t())return;const t=qt();if(Et()===t)return;const r=setTimeout(()=>{a("/whats-new",{replace:!0,state:{backgroundLocation:e}})},700);return()=>clearTimeout(r)},[e,a]),r.jsxs(r.Fragment,{children:[r.jsx(j,{location:d,children:r.jsxs(w,{path:"/",element:r.jsx(Xe,{}),children:[r.jsx(w,{index:!0,element:r.jsx(Ze,{})}),r.jsx(w,{path:"skill-tree",element:r.jsx(Gt,{})}),r.jsx(w,{path:"skill-tree/fullscreen",element:r.jsx(Gt,{})}),r.jsx(w,{path:"medals",element:r.jsx(Xt,{})}),r.jsx(w,{path:"medals/:id",element:r.jsx(Xt,{})}),r.jsx(w,{path:"settings",element:r.jsx(Ya,{children:r.jsx($r,{})})}),r.jsx(w,{path:"data",element:r.jsx(Ya,{children:r.jsx(Qr,{})})}),r.jsx(w,{path:"about",element:r.jsx(ta,{})}),r.jsx(w,{path:"help",element:r.jsx(ra,{})}),r.jsx(w,{path:"whats-new",element:r.jsx(Oa,{})})]})}),s&&n&&r.jsx(j,{children:r.jsx(w,{path:"/medals/:id",element:r.jsx(Ka,{})})}),o&&n&&r.jsx(j,{children:r.jsx(w,{path:"/whats-new",element:r.jsx(Oa,{})})}),r.jsx(za,{})]})}function Wa(){const e="undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/";return t.useEffect(()=>{if("undefined"==typeof window||!("matchMedia"in window))return;const e=window.matchMedia("(prefers-color-scheme: dark)"),t=e=>{document.documentElement.classList.toggle("dark",e)};t(e.matches);const r=e=>t(e.matches);return e.addEventListener?.("change",r),()=>e.removeEventListener?.("change",r)},[]),r.jsx(D,{children:r.jsx(Z,{children:r.jsx(te,{children:r.jsx(fe,{children:r.jsx(de,{children:r.jsx(ue,{children:r.jsx(ke,{children:r.jsx(v,{basename:e,children:r.jsx(Ha,{})})})})})})})})})}k.createRoot(document.getElementById("root")).render(r.jsx(t.StrictMode,{children:r.jsx(Wa,{})})),function(){if("undefined"!=typeof window){if("serviceWorker"in navigator){const e="/spsf-medal-explorer/pr/154/service-worker.js",t="/spsf-medal-explorer/pr/154/";navigator.serviceWorker.register(e,{scope:t}).catch(()=>{})}window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),window.dispatchEvent(new CustomEvent("pwa:install-available"))})}}();export{_ as m};
