import{_ as e,r as t,j as r,I as n,C as s,u as a,a as i,L as l,O as o,c,S as d,d as u,T as m,e as p,f,g as h,h as b,R as x,i as g,k as y,B as v,l as w,m as j,n as k,o as N}from"./vendor-BYCxJfch.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const S=new Set(["placeholder","under_review","reviewed"]);class C{constructor(e){var t;this.id=e.id,this.type=e.type,this.tier=e.tier,this.name=e.name,this.displayName=e.displayName,this.tierName=e.tierName,this.color=e.color,this.icon=e.icon,this.typeName=e.typeName??null,this.status=(t=e.status,S.has(t)?t:"placeholder"),this.prerequisites=e.prerequisites||[],this.requirements=e.requirements||[],this.unlocksFollowingMedals=e.unlocksFollowingMedals||[],this.description=e.description||"",this.requirementsOriginal=e.requirements_original||"",this.references=Array.isArray(e.references)?e.references:[],this.yearIntroduced=e.yearIntroduced,this.sortOrder=e.sortOrder}getFullName(){const e=this.tier?this.tier.charAt(0).toUpperCase()+this.tier.slice(1).replace("_"," "):"";return`${this.displayName}${e?` (${e})`:""}`}getColorClass(){return{"#FFD700":"text-medal-gold","#C0C0C0":"text-medal-silver","#CD7F32":"text-medal-bronze"}[this.color]||"text-foreground"}isPlaceholder(){return"placeholder"===this.status}isUnderReview(){return"under_review"===this.status}isReviewed(){return"reviewed"===this.status}}class M{constructor(e){this.medals=(e.medals||[]).map(e=>new C(e))}getMedalById(e){return this.medals.find(t=>t.id===e)}getMedalsByType(e){return this.medals.filter(t=>t.type===e)}getMedalsByTier(e){return this.medals.filter(t=>t.tier===e)}getAllMedals(){return[...this.medals]}}function A(e){return e?.id||e?.medalId}function I(e){const t=e?.medals||[],r=[],n=function(e=[]){const t=new Map;for(const r of e){const e=A(r);e&&t.set(e,r)}return t}(t);return t.forEach(e=>{(e.prerequisites||[]).forEach((t,s)=>{if("medal"===t?.type){const a=t.medalId;n.has(a)||r.push(`Medal ${A(e)} prerequisite #${s} references missing medalId: ${a}`)}})}),{ok:0===r.length,errors:r}}const T={medalDatabase:null,loading:!0,error:null},P=t.createContext(T);function E({children:n}){const[s,a]=t.useState(null),[i,l]=t.useState(!0),[o,c]=t.useState(null);return t.useEffect(()=>{let t=!1;return async function(r){l(!0);try{const n=r??await async function(){const t=await e(()=>import("./medals-BZlpLe49.js"),[]);return t.default||t}(),s=I(n);s.ok||console.warn("Medal dataset validation errors:",s.errors);const i=new M(n);t||(a(i),c(null))}catch(n){t||(c(`Failed to load medal database: ${n.message}`),console.error("Medal database error:",n))}finally{t||l(!1)}}(),()=>{t=!0}},[]),r.jsx(P.Provider,{value:{medalDatabase:s,loading:i,error:o},children:n})}const D=t.createContext(null);class F{async getUserProfile(){throw new Error("Not implemented")}async saveUserProfile(){throw new Error("Not implemented")}async getAllProfiles(){throw new Error("Not implemented")}async deleteProfile(){throw new Error("Not implemented")}async getAchievements(){throw new Error("Not implemented")}async addAchievement(){throw new Error("Not implemented")}async updateAchievement(){throw new Error("Not implemented")}async upsertAchievements(){throw new Error("Not implemented")}async removeAchievement(){throw new Error("Not implemented")}async exportData(){throw new Error("Not implemented")}async importData(){throw new Error("Not implemented")}}const $={allowManualUnlock:!0,enforceCurrentYearForSustained:!1};class _{constructor(e){this.userId=e.userId||`user-${Date.now()}`,this.displayName=e.displayName||"",this.createdDate=e.createdDate||(new Date).toISOString(),this.lastModified=e.lastModified||(new Date).toISOString(),this.dateOfBirth=e.dateOfBirth||"",this.unlockedMedals=e.unlockedMedals||[],this.prerequisites=e.prerequisites||[],this.features={...$,...e.features||{}},this.isGuest=Boolean(e.isGuest)}touch(){this.lastModified=(new Date).toISOString()}}class Y extends F{constructor(){super(),this.storageKey="medal-app-data",this.initializeStorage()}initializeStorage(){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");if(!localStorage.getItem(this.storageKey)){const e={version:"2.0",profiles:[],lastBackup:(new Date).toISOString()};return void localStorage.setItem(this.storageKey,JSON.stringify(e))}try{const e=localStorage.getItem(this.storageKey),t=e?JSON.parse(e):null;if(t&&"2.0"!==t.version){const e=this._migrateToV2(t);this.saveStorageData(e)}}catch{const e={version:"2.0",profiles:[],lastBackup:(new Date).toISOString()};localStorage.setItem(this.storageKey,JSON.stringify(e))}}async getUserProfile(e){return this.getStorageData().profiles.find(t=>t.userId===e)||null}async saveUserProfile(e){if(!this.validateProfile(e))throw new Error("Invalid profile structure");const t={allowManualUnlock:null!=e.features?.allowManualUnlock?!!e.features.allowManualUnlock:$.allowManualUnlock,enforceCurrentYearForSustained:null!=e.features?.enforceCurrentYearForSustained?!!e.features.enforceCurrentYearForSustained:$.enforceCurrentYearForSustained},r=this.getStorageData(),n=(new Date).toISOString();e.lastModified=n;const s=r.profiles.findIndex(t=>t.userId===e.userId);if(s>=0)r.profiles[s]={...r.profiles[s],...e,features:t,userId:r.profiles[s].userId};else{const s={userId:e.userId||new _(e).userId,displayName:e.displayName||"",createdDate:n,lastModified:n,dateOfBirth:e.dateOfBirth,unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:Boolean(e.notifications),features:t};r.profiles.push(s),e=s}return this.saveStorageData(r),e}async getAllProfiles(){return this.getStorageData().profiles}async deleteProfile(e){const t=this.getStorageData(),r=t.profiles.length;t.profiles=t.profiles.filter(t=>t.userId!==e),t.profiles.length!==r&&this.saveStorageData(t)}_ensureAchievementIds(e){let t=!1;return e.prerequisites=Array.isArray(e.prerequisites)?e.prerequisites:[],e.prerequisites.forEach((e,r)=>{e.id||(e.id=`achievement-${Date.now()}-${r}-${Math.random().toString(36).slice(2,8)}`,t=!0)}),t}async getAchievements(e){const t=await this.getUserProfile(e);if(!t)return[];return this._ensureAchievementIds(t)&&await this.saveUserProfile(t),t&&t.prerequisites||[]}buildNaturalKey(e){const t=[e.type,e.year,e.weaponGroup].map(e=>String(e??"").trim().toLowerCase()).join("|");switch(e.type){case"precision_series":return`${t}|${String(e.points??"").trim()}`;case"standard_medal":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.medalType||"").toLowerCase()}`;case"competition_result":return`${t}|${(e.disciplineType||"").toLowerCase()}|${(e.ppcClass||"").toLowerCase()}|${String(e.date||"").toLowerCase()}|${String(e.score??"").trim()}`;case"qualification_result":return`${t}|${(e.weapon||"").toLowerCase()}|${String(e.score??"").trim()}`;case"team_event":return`${t}|${(e.teamName||"").toLowerCase()}|${String(e.position??"").trim()}`;case"event":return`${t}|${(e.eventName||"").toLowerCase()}`;default:return null}}async upsertAchievements(e,t,{updateById:r=!0,matchNaturalKey:n=!1,addNew:s=!0,dryRun:a=!0}={}){const i=await this.getUserProfile(e);if(!i)throw new Error("Profile not found");this._ensureAchievementIds(i);const l=Array.isArray(i.prerequisites)?i.prerequisites:[],o=new Map(l.map(e=>[e.id,e])),c=new Map;if(n)for(const p of l){const e=this.buildNaturalKey(p);e&&c.set(e,p)}const d=[...l],u={added:0,updated:0,skipped:0,failed:0,errors:[]};for(let p=0;p<(t||[]).length;p++){const e=t[p];try{if(!this.validateAchievement(e)){const t=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";console.groupCollapsed(`[LocalStorageDataManager] Validation failed for row #${p+1}`),console.error("Reason:",t),console.log("Record:",e),console.groupEnd(),u.failed++,u.errors.push({record:e,row:p+1,error:t});continue}}catch(m){console.groupCollapsed(`[LocalStorageDataManager] Exception validating row #${p+1}`),console.error(m),console.log("Record:",e),console.groupEnd(),u.failed++,u.errors.push({record:e,row:p+1,error:m?.message||"Validation failed"});continue}let a=null;if(r&&e.id&&o.has(e.id))a=o.get(e.id),console.debug("[LocalStorageDataManager] Matched by id",{row:p+1,id:e.id});else if(n){const t=this.buildNaturalKey(e);t?c.has(t)?(console.debug("[LocalStorageDataManager] Matched by natural key",{row:p+1,key:t}),a=c.get(t)):console.debug("[LocalStorageDataManager] No match by natural key",{row:p+1,key:t}):console.debug("[LocalStorageDataManager] No natural key for record",{row:p+1})}if(a){const t=d.findIndex(e=>e.id===a.id);t>=0&&(d[t]={...e,id:a.id},u.updated++,console.info("[LocalStorageDataManager] Updated achievement",{row:p+1,id:a.id}));continue}if(s){const t=e.id&&!o.has(e.id)?e.id:`achievement-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;d.push({...e,id:t}),u.added++,console.info("[LocalStorageDataManager] Added achievement",{row:p+1,id:t})}else u.skipped++,console.info("[LocalStorageDataManager] Skipped (addNew=false)",{row:p+1})}return a||(i.prerequisites=d,await this.saveUserProfile(i)),u}async addAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");if(!this.validateAchievement(t)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}const n=t.id||`achievement-${Date.now()}`,s={...t,id:n};return r.prerequisites=Array.isArray(r.prerequisites)?r.prerequisites:[],r.prerequisites.push(s),await this.saveUserProfile(r),s}async updateAchievement(e,t,r){const n=await this.getUserProfile(e);if(!n)throw new Error("Profile not found");const s=(n.prerequisites||[]).findIndex(e=>e.id===t);if(s<0)throw new Error("Achievement not found");const a={...r,id:t};if(!this.validateAchievement(a)){const e=Array.isArray(this._lastValidationReasons)&&this._lastValidationReasons.length?this._lastValidationReasons.join("; "):"Invalid achievement structure";throw new Error(e)}return n.prerequisites[s]=a,await this.saveUserProfile(n),n.prerequisites[s]}async removeAchievement(e,t){const r=await this.getUserProfile(e);if(!r)throw new Error("Profile not found");r.prerequisites=(r.prerequisites||[]).filter(e=>e.id!==t),await this.saveUserProfile(r)}validateProfile(e){if(!e||"object"!=typeof e)return!1;if(!e.userId||"string"!=typeof e.userId)return!1;if("string"!=typeof e.displayName)return!1;if(!Array.isArray(e.unlockedMedals))return!1;if(!Array.isArray(e.prerequisites))return!1;if(!this._isValidDob(e.dateOfBirth))return!1;if(null!=e.features){if("object"!=typeof e.features)return!1;if("allowManualUnlock"in e.features&&"boolean"!=typeof e.features.allowManualUnlock)return!1;if("enforceCurrentYearForSustained"in e.features&&"boolean"!=typeof e.features.enforceCurrentYearForSustained)return!1}const t=this._computeAge(e.dateOfBirth);return!(t<8||t>100)}validateAchievement(e){const t=[];if(e&&"object"==typeof e){e.type&&"string"==typeof e.type||t.push("type missing or not a string"),("number"!=typeof e.year||Number.isNaN(e.year))&&t.push("year must be a finite number");const r=e.weaponGroup||"";if(["A","B","C","R"].includes(r)||t.push(`weaponGroup must be one of A/B/C/R (got "${r}")`),"precision_series"===e.type&&("number"!=typeof e.points||Number.isNaN(e.points)?t.push("points must be a number"):(e.points<0||e.points>50)&&t.push("points must be between 0 and 50")),"application_series"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}("number"!=typeof e.timeSeconds||!Number.isFinite(e.timeSeconds)||e.timeSeconds<=0)&&t.push("timeSeconds must be a positive number"),("number"!=typeof e.hits||!Number.isFinite(e.hits)||e.hits<0)&&t.push("hits must be a non-negative number")}if("competition_result"===e.type){if(!e.date||Number.isNaN(new Date(e.date).getTime()))t.push("date must be a valid ISO date");else{const r=new Date(e.date),n=new Date;n.setHours(0,0,0,0),r.setHours(0,0,0,0),r.getTime()>n.getTime()&&t.push("date cannot be in the future")}"number"==typeof e.score&&Number.isFinite(e.score)?e.score<0&&t.push("score must be >= 0"):t.push("score must be a number");const r=["national_whole_match","military_fast_match","ppc"],n=String(e.disciplineType||"").toLowerCase();if(r.includes(n)||t.push(`disciplineType must be one of ${r.join(", ")} (got "${n||"(empty)"}")`),"ppc"===n){const r=e.ppcClass;r&&""!==String(r).trim()||t.push('ppcClass is required when disciplineType is "ppc"')}}}else t.push("achievement must be an object");const r=0===t.length;if(this._lastValidationReasons=t,!r)try{console.groupCollapsed("[LocalStorageDataManager] validateAchievement failed"),console.error("Reasons:",t),console.log("Achievement:",e),console.groupEnd()}catch{}return r}getStorageData(){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");try{const e=localStorage.getItem(this.storageKey);if(!e)return this.initializeStorage(),this.getStorageData();const t=JSON.parse(e);if(!t||"object"!=typeof t||!Array.isArray(t.profiles))throw new Error("Malformed storage root");return t}catch(e){throw console.error("Failed to read storage:",e),new Error("Storage data corrupted")}}saveStorageData(e){if(!this._hasStorage())throw new Error("localStorage is not available in this environment");try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(t){if(t&&("QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name||22===t.code))throw new Error("Storage quota exceeded");throw t}}_isValidDob(e){if(!e||"string"!=typeof e)return!1;if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const t=new Date(e);return!Number.isNaN(t.getTime())}_computeAge(e){if(!this._isValidDob(e))return NaN;const t=new Date(e),r=new Date;let n=r.getFullYear()-t.getFullYear();const s=r.getMonth()-t.getMonth();return(s<0||0===s&&r.getDate()<t.getDate())&&n--,n}_defaultDob(){return"2000-01-01"}_migrateToV2(e){const t={...e};return t.version="2.0",t.profiles=Array.isArray(e.profiles)?e.profiles.map(e=>{const t={...e};return delete t.weaponGroupPreference,this._isValidDob(t.dateOfBirth)||(t.dateOfBirth=this._defaultDob()),t.features?("boolean"!=typeof t.features.allowManualUnlock&&(t.features.allowManualUnlock=$.allowManualUnlock),"boolean"!=typeof t.features.enforceCurrentYearForSustained&&(t.features.enforceCurrentYearForSustained=$.enforceCurrentYearForSustained)):t.features={...$},t.lastModified=(new Date).toISOString(),t}):[],t}_hasStorage(){try{return"undefined"!=typeof localStorage}catch{return!1}}_generateUserId(){try{if("undefined"!=typeof crypto){if("function"==typeof crypto.randomUUID)return`user-${crypto.randomUUID()}`;if("function"==typeof crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e);return`user-${Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}`}}}catch{}return`user-${Date.now()}`}_ensureUniqueId(e){const t=this.getStorageData(),r=e&&"string"==typeof e&&e.trim()?e.trim():this._generateUserId();let n=r,s=1;for(;t.profiles.some(e=>e.userId===n);)n=`${r}-${s++}`;return n}async restoreProfile(e,{strategy:t="new-id"}={}){if(!e||"object"!=typeof e)throw new Error("Invalid profile");const r=(new Date).toISOString(),n={userId:String(e.userId||""),displayName:String(e.displayName||""),createdDate:e.createdDate||r,lastModified:r,dateOfBirth:e.dateOfBirth||"",unlockedMedals:Array.isArray(e.unlockedMedals)?e.unlockedMedals:[],prerequisites:Array.isArray(e.prerequisites)?e.prerequisites:[],notifications:!!e.notifications,features:{...$,...e.features?{allowManualUnlock:!!e.features.allowManualUnlock,enforceCurrentYearForSustained:!!e.features.enforceCurrentYearForSustained}:{}}};if("new-id"===t)n.userId=this._ensureUniqueId(this._generateUserId());else{if("overwrite"!==t)throw new Error("Invalid restore strategy");if(!n.userId)throw new Error("userId is required for overwrite")}if(!this.validateProfile(n))throw new Error("Invalid profile structure");const s=this.getStorageData(),a=s.profiles.findIndex(e=>e.userId===n.userId);return a>=0?s.profiles[a]=n:s.profiles.push(n),this.saveStorageData(s),n}}const q="app:onboardingChoice",L="app:lastProfileId";function R(e){if("undefined"!=typeof window)try{e?window.localStorage.setItem(L,e):window.localStorage.removeItem(L)}catch{}}function O(){return new _({userId:"guest",displayName:"Gästläge",dateOfBirth:"1975-01-02",unlockedMedals:[],prerequisites:[],isGuest:!0})}function B({children:e}){const[n]=t.useState(()=>new Y),[s,a]=t.useState(void 0),[i,l]=t.useState([]),[o,c]=t.useState(!1),[d,u]=t.useState(null),[m,p]=t.useState(!1),f=t.useCallback(async()=>{try{c(!0);const e=await n.getAllProfiles();l(e),u(null)}catch(e){u(e.message),console.error("Failed to load profiles:",e)}finally{c(!1)}},[n]),h=t.useCallback(()=>{try{window.localStorage.setItem(q,"guest")}catch(e){}a(O())},[]);t.useEffect(()=>{let e=!1;return(async()=>{try{c(!0);const r=await n.getAllProfiles();if(e)return;l(r);let s=null;const i=function(){if("undefined"==typeof window)return null;try{return new URL(window.location.href).searchParams.get("profile")||null}catch{return null}}();if(i&&r.some(e=>e.userId===i))s=r.find(e=>e.userId===i)||null,R(i);else{const e=function(){if("undefined"==typeof window)return null;try{return window.localStorage.getItem(L)}catch{return null}}();if(e&&r.some(t=>t.userId===e))s=r.find(t=>t.userId===e)||null;else if(r.length>0)s=[...r].sort((e,t)=>new Date(t.lastModified)-new Date(e.lastModified))[0];else try{"guest"===window.localStorage.getItem(q)&&(s=O())}catch(t){}}a(s??null),u(null)}catch(r){e||(u(r.message),console.error("Failed to bootstrap profiles:",r))}finally{e||(c(!1),p(!0))}})(),()=>{e=!0}},[n]);const b=t.useCallback(async(e,t)=>{try{c(!0);const r=new _({displayName:e,dateOfBirth:t}),s=await n.saveUserProfile(r);return a(s),R(s.userId),await f(),s}catch(r){throw u(r.message),r}finally{c(!1)}},[n,f]),x=t.useCallback(async e=>{try{c(!0);const t=await n.getUserProfile(e);if(!t)throw new Error("Profile not found");a(t),R(t.userId),u(null)}catch(t){u(t.message)}finally{c(!1)}},[n]);t.useEffect(()=>{if(m&&s&&!s.isGuest)try{window.localStorage.removeItem(q)}catch(e){}},[s,m]);const g=t.useCallback(async e=>{try{c(!0);const t=await n.saveUserProfile(e);return a(t),R(t.userId),await f(),t}catch(t){throw u(t.message),t}finally{c(!1)}},[n,f]),y=t.useCallback(async e=>{try{c(!0),await n.deleteProfile(e),s?.userId===e&&(a(null),R(null)),await f()}catch(t){throw u(t.message),t}finally{c(!1)}},[n,s,f]),v=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(s.isGuest)return a(t=>({...t,prerequisites:[...t?.prerequisites||[],e],lastModified:(new Date).toISOString()})),e;try{c(!0);const t=await n.addAchievement(s.userId,e),r=await n.getUserProfile(s.userId);return a(r),t}catch(t){throw u(t.message),t}finally{c(!1)}},[s,n]),w=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(!e?.id)throw new Error("Achievement id is required");if(s.isGuest)return a(t=>{const r=Array.isArray(t?.prerequisites)?[...t.prerequisites]:[],n=r.findIndex(t=>t.id===e.id);return-1!==n&&(r[n]={...r[n],...e}),{...t,prerequisites:r,lastModified:(new Date).toISOString()}}),e;try{c(!0);const t=await n.getUserProfile(s.userId),r=Array.isArray(t.prerequisites)?[...t.prerequisites]:[],i=r.findIndex(t=>t.id===e.id);if(-1===i)throw new Error("Achievement not found");r[i]={...r[i],...e};const l={...t,prerequisites:r,lastModified:(new Date).toISOString()},o=await n.saveUserProfile(l);return a(o),o.prerequisites[i]}catch(t){throw u(t.message),t}finally{c(!1)}},[s,n]),j=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("Achievement id is required");if(s.isGuest)return a(t=>({...t,prerequisites:(t?.prerequisites||[]).filter(t=>t.id!==e),lastModified:(new Date).toISOString()})),!0;try{c(!0);const t=await n.getUserProfile(s.userId),r=Array.isArray(t.prerequisites)?t.prerequisites.filter(t=>t.id!==e):[],i={...t,prerequisites:r,lastModified:(new Date).toISOString()},l=await n.saveUserProfile(i);return a(l),!0}catch(t){throw u(t.message),t}finally{c(!1)}},[s,n]),k=t.useCallback(async(e,t)=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("medalId is required");if(s.isGuest)return a(r=>{const n=Array.isArray(r?.unlockedMedals)?[...r.unlockedMedals]:[];if(n.some(t=>t.medalId===e))return r;const s={medalId:e,unlockedDate:t||(new Date).toISOString().slice(0,10)};return{...r,unlockedMedals:[...n,s],lastModified:(new Date).toISOString()}}),!0;try{c(!0);const r=await n.getUserProfile(s.userId),i=Array.isArray(r.unlockedMedals)?[...r.unlockedMedals]:[];if(i.some(t=>t.medalId===e))return!1;const l={medalId:e,unlockedDate:t||(new Date).toISOString().slice(0,10)},o={...r,unlockedMedals:[...i,l],lastModified:(new Date).toISOString()},d=await n.saveUserProfile(o);return a(d),!0}catch(r){throw u(r.message),r}finally{c(!1)}},[s,n]),N=t.useCallback(async e=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("medalId is required");if(s.isGuest)return a(t=>({...t,unlockedMedals:(t?.unlockedMedals||[]).filter(t=>t.medalId!==e),lastModified:(new Date).toISOString()})),!0;try{c(!0);const t=await n.getUserProfile(s.userId),r=Array.isArray(t.unlockedMedals)?t.unlockedMedals:[],i=r.filter(t=>t.medalId!==e);if(i.length===r.length)return!1;const l={...t,unlockedMedals:i,lastModified:(new Date).toISOString()},o=await n.saveUserProfile(l);return a(o),!0}catch(t){throw u(t.message),t}finally{c(!1)}},[s,n]),S=t.useCallback(async(e,t)=>{if(!s)throw new Error("No profile selected");if(!e)throw new Error("Feature name is required");if(s.isGuest)return a(r=>({...r,features:{...r?.features||{},[e]:!!t},lastModified:(new Date).toISOString()})),u(null),s;try{c(!0);const r=await n.getUserProfile(s.userId),i={...r.features||{},[e]:!!t},l={...r,features:i,lastModified:(new Date).toISOString()},o=await n.saveUserProfile(l);return a(o),u(null),o}catch(r){throw u(r.message),r}finally{c(!1)}},[s,n]),C=t.useCallback(async(e,t={strategy:"new-id"})=>{try{c(!0);const r=function(e){let t;try{t="string"==typeof e?JSON.parse(e):e}catch{throw new Error("Invalid JSON")}if(!t||"profile-backup"!==t.kind||"1.0"!==t.version||!t.profile||"object"!=typeof t.profile)throw new Error("Invalid profile backup");const r=t.profile,n=Array.isArray(r.prerequisites)?r.prerequisites.map((e,t)=>({...e,id:e?.id||`achievement-${Date.now()}-${t}`})):[];return{userId:"string"==typeof r.userId?r.userId.trim():"",displayName:"string"==typeof r.displayName?r.displayName:"",createdDate:r.createdDate||(new Date).toISOString(),lastModified:r.lastModified||(new Date).toISOString(),dateOfBirth:"string"==typeof r.dateOfBirth?r.dateOfBirth:"",unlockedMedals:Array.isArray(r.unlockedMedals)?r.unlockedMedals:[],prerequisites:n,features:{allowManualUnlock:!(!r.features||!r.features.allowManualUnlock),enforceCurrentYearForSustained:!(!r.features||!r.features.enforceCurrentYearForSustained)},notifications:!!r.notifications}}(e),s=await n.restoreProfile(r,t);return a(s),R(s.userId),await f(),u(null),s}catch(r){throw u(r.message),r}finally{c(!1)}},[n,f]),M=t.useCallback(async(e,t)=>{if(!s)throw new Error("No profile selected");if(s.isGuest)return t?.dryRun||a(t=>({...t,prerequisites:(Array.isArray(t?.prerequisites),[...e]),lastModified:(new Date).toISOString()})),u(null),{added:e?.length||0,updated:0,duplicates:0};try{c(!0);const r=await n.upsertAchievements(s.userId,e,t);if(!t?.dryRun){const e=await n.getUserProfile(s.userId);a(e),R(e.userId),await f()}return u(null),r}catch(r){throw u(r.message),r}finally{c(!1)}},[s,n,f]),A=t.useCallback(async(e,t="")=>{if(!s?.isGuest)return null;const r=new _({...s,userId:void 0,displayName:e||"Profil",dateOfBirth:t,isGuest:!1}),i=await n.saveUserProfile(r);return a(i),R(i.userId),await f(),i},[s,n,f]),I=t.useCallback(async()=>{if(!s)return!1;const e={...s,unlockedMedals:[],prerequisites:[],lastModified:(new Date).toISOString()};if(s.isGuest)return a(e),!0;const t=await n.saveUserProfile(e);return a(t),await f(),!0},[s,n,f]),T={currentProfile:s,profiles:i,loading:o,hydrated:m,error:d,createProfile:b,selectProfile:x,updateProfile:g,deleteProfile:y,addAchievement:v,updateAchievement:w,removeAchievement:j,unlockMedal:k,lockMedal:N,setProfileFeature:S,restoreProfileFromBackup:C,upsertAchievements:M,startExplorerMode:h,convertGuestToSaved:A,resetCurrentProfileData:I};return r.jsx(D.Provider,{value:T,children:e})}const U=t.createContext(null),G=new Map;class V{constructor(e,t){this.medals=e,this.profile=t||{unlockedMedals:[],prerequisites:[]}}static registerCustomCriterion(e,t){if("string"!=typeof e||!e)throw new Error("custom_criterion name must be a non-empty string");if("function"!=typeof t)throw new Error("custom_criterion handler must be a function");G.set(e,t)}evaluateMedal(e,t={}){const r=this.medals.getMedalById(e);if(!r)throw new Error(`Medal not found: ${e}`);if("function"==typeof r.isPlaceholder&&r.isPlaceholder()||"placeholder"===r.status)return{medalId:e,status:"locked",reason:"placeholder",details:{message:"Placeholder medal"}};if(this.hasUnlockedMedal(e))return{medalId:e,status:"unlocked",unlockedDate:this.getUnlockedDate(e),details:{}};if(Array.isArray(r.prerequisites)){const n=r.prerequisites.filter(e=>"medal"===e?.type).filter(e=>{if(!this.hasUnlockedMedal(e.medalId))return!0;if("number"==typeof t.endYear){const r=this.getUnlockedYear(e.medalId);return!("number"==typeof r&&r<=t.endYear)}return!1});if(n.length)return{medalId:e,status:"locked",reason:"prerequisites_not_met",details:{prerequisites:{missingMedals:n.map(e=>e.medalId)}}}}const n=this.checkRequirements(r,t);if(!n.allMet)return{medalId:e,status:"available",reason:"requirements_not_met",details:n};const s=this.checkPrerequisites(r,n.unlockYear??t.endYear);return s.allMet?{medalId:e,status:"eligible",eligibleYear:n.unlockYear??null,details:{...n,prerequisites:s}}:{medalId:e,status:"locked",reason:"prerequisites_not_met",details:s}}hasUnlockedMedal(e){return this.profile.unlockedMedals?.some(t=>t.medalId===e)||!1}getUnlockedDate(e){const t=this.profile.unlockedMedals?.find(t=>t.medalId===e);return t?t.unlockedDate:null}checkPrerequisites(e,t){if(!e.prerequisites||0===e.prerequisites.length)return{allMet:!0,items:[],missingItems:[]};const r=[],n=[];return e.prerequisites.forEach(e=>{if("medal"===e.type){const s=this.getUnlockedYear(e.medalId),a=this.hasUnlockedMedal(e.medalId)&&("number"!=typeof t||"number"==typeof s&&s<=t),i={type:"medal",medalId:e.medalId,isMet:a,achieved:a?this.getUnlockedDate(e.medalId):null,description:e.description,yearOffset:e.yearOffset};if(r.push(i),a){if("number"==typeof e.yearOffset){const r=this.getUnlockedYear(e.medalId),s="number"==typeof t?t:this.getMostRecentAchievementYear()??(new Date).getFullYear(),a=null!==r&&s-r>=e.yearOffset,l={...i,isMet:a,offsetChecked:!0,plannedYear:s};a||n.push(l)}}else n.push(i)}else if("age_requirement"===e.type){const s=this.profile?.dateOfBirth;let a=null,i=!1;if(s){const r=new Date(s);if(!Number.isNaN(r.getTime())){const n="number"==typeof t?new Date(t,11,31):new Date;let s=n.getFullYear()-r.getFullYear();const l=n.getMonth()-r.getMonth();(l<0||0===l&&n.getDate()<r.getDate())&&(s-=1),a=s;const o="number"!=typeof e.minAge||a>=e.minAge,c="number"!=typeof e.maxAge||a<=e.maxAge;i=o&&c}}const l={type:"age_requirement",isMet:i,minAge:e.minAge,...null!=e.maxAge?{maxAge:e.maxAge}:{},...null!=a?{age:a}:{},description:e.description};r.push(l),i||n.push(l)}}),{allMet:0===n.length,items:r,missingItems:n}}getUnlockedYear(e){const t=this.profile.unlockedMedals?.find(t=>t.medalId===e);return t?t.year?t.year:t.unlockedDate?new Date(t.unlockedDate).getFullYear():null:null}getMostRecentAchievementYear(){const e=this.profile.prerequisites||[];return e.length?e.reduce((e,t)=>Math.max(e,t.year||e),0):null}getSameTypePrereqMedalIds(e){const t=e?.type;return t?(e?.prerequisites||[]).filter(e=>"medal"===e?.type).map(e=>e.medalId).filter(e=>{const r=this.medals.getMedalById(e);return r&&r.type===t}):[]}getEarliestCountingYearForMedal(e){const t=this.getSameTypePrereqMedalIds(e).map(e=>this.getUnlockedYear(e)).filter(e=>"number"==typeof e);return t.length?Math.max(...t)+1:null}getMinimalUnlockYearForSustained(e){if(!e)return null;const t=(e.requirements||[]).find(e=>"sustained_achievement"===e?.type);if(!t)return null;const r=Number.isFinite(t?.yearsOfAchievement)?t.yearsOfAchievement:1,n=this.getSameTypePrereqMedalIds(e).map(e=>this.getUnlockedYear(e)).filter(e=>"number"==typeof e);if(!n.length)return null;return Math.max(...n)+r}getAllAchievementYears(){const e=this.profile.prerequisites||[],t=new Set;for(const r of e){const e=Number(r.year);Number.isNaN(e)||t.add(e)}return Array.from(t).sort((e,t)=>e-t)}requirementsMetInYear(e,t,r={}){const n="string"==typeof e?this.medals.getMedalById(e):e;if(!n)return!1;return this.checkRequirements(n,{...r,endYear:t}).allMet}checkRequirements(e,t={}){const r=e.requirements;if(!r||Array.isArray(r)&&0===r.length)return{allMet:!0,items:[],unlockYear:null,tree:{node:"and",isMet:!0,children:[]}};const n=this.normalizeRequirementSpec(r),s=r=>this.evaluateReqNode(n,e,{...t,endYear:r});if("number"==typeof t.endYear){const e=s(t.endYear),r=!!e.isMet;return{allMet:r,items:this.flattenLeaves(e),unlockYear:r?t.endYear:null,tree:e}}const a=this.getCandidateYearsForTree();for(const l of a){const e=s(l);if(e.isMet)return{allMet:!0,items:this.flattenLeaves(e),unlockYear:l,tree:e}}const i=this.evaluateReqNode(n,e,t);return{allMet:!1,items:this.flattenLeaves(i),unlockYear:null,tree:i}}checkPrecisionSeriesRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type);if(null!=r.endYear){let s=n;const a=e.timeWindowYears;if(1===a)s=n.filter(e=>e.year===r.endYear);else if("number"==typeof a&&a>1){const e=r.endYear-a+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);s=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else s=n.filter(e=>e.year===r.endYear);const i=this.filterByPrecisionSeriesThreshold(s,e),l=e.minAchievements??1,o={current:i.length,required:l},c=o.current>=l;return{type:"precision_series",index:t,isMet:c,progress:o,description:e.description,pointThresholds:{A:e.pointThresholds?.A?.min,B:e.pointThresholds?.B?.min,C:e.pointThresholds?.C?.min,R:e.pointThresholds?.R?.min},windowYear:c?r.endYear:null}}const s=t=>this.filterByPrecisionSeriesThreshold(t,e);let a=[],i=null;if(1===e.timeWindowYears){const e=this.groupBy(n,e=>e.year);let t=null,r=[];Object.entries(e).forEach(([e,n])=>{const a=s(n);a.length>r.length&&(r=a,t=Number(e))}),a=r,i=t}else if("number"==typeof e.timeWindowYears&&e.timeWindowYears>1){const t=Array.from(new Set(n.map(e=>e.year).filter(e=>"number"==typeof e))).sort((e,t)=>e-t);let r=null,l=[];for(const a of t){const t=a-e.timeWindowYears+1,i=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=a),o=s(i);o.length>l.length&&(l=o,r=a)}a=l,i=r}else a=s(n);const l=e.minAchievements??1,o={current:a.length,required:l},c=o.current>=l;return{type:"precision_series",index:t,isMet:c,progress:o,description:e.description,pointThresholds:{A:e.pointThresholds?.A?.min,B:e.pointThresholds?.B?.min,C:e.pointThresholds?.C?.min,R:e.pointThresholds?.R?.min},windowYear:c?i:null}}checkApplicationSeriesRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"application_series"===e.type),s=t=>{const r=t.weaponGroup||"A",n=e.thresholds?.[r];if(!n)return!1;const s="number"==typeof t.timeSeconds&&t.timeSeconds>0,a="number"==typeof t.hits&&t.hits>=0,i="number"!=typeof n.maxTimeSeconds||t.timeSeconds<=n.maxTimeSeconds,l="number"!=typeof n.minHits||t.hits>=n.minHits;return s&&a&&i&&l};if(null!=r.endYear){let a=n;const i=e.timeWindowYears;if(1===i)a=n.filter(e=>e.year===r.endYear);else if("number"==typeof i&&i>1){const e=r.endYear-i+1,t=Math.max(e,Number.isFinite(r.minStartYear)?r.minStartYear:e);a=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=r.endYear)}else a=n.filter(e=>e.year===r.endYear);const l=a.filter(s),o=e.minAchievements??1,c={current:l.length,required:o},d=c.current>=o;return{type:"application_series",index:t,isMet:d,progress:c,description:e.description,windowYear:d?r.endYear:null}}let a=[],i=null;if(1===e.timeWindowYears){const e=this.groupBy(n,e=>e.year);let t=[],r=null;Object.entries(e).forEach(([e,n])=>{const a=n.filter(s);a.length>t.length&&(t=a,r=Number(e))}),a=t,i=r}else if("number"==typeof e.timeWindowYears&&e.timeWindowYears>1){const t=Array.from(new Set(n.map(e=>e.year).filter(e=>"number"==typeof e))).sort((e,t)=>e-t);let r=null,l=[];for(const a of t){const t=a-e.timeWindowYears+1,i=n.filter(e=>(e.year??0)>=t&&(e.year??0)<=a).filter(s);i.length>l.length&&(l=i,r=a)}a=l,i=r}else a=n.filter(s);const l=e.minAchievements??1,o={current:a.length,required:l},c=o.current>=l;return{type:"application_series",index:t,isMet:c,progress:o,description:e.description,windowYear:c?i:null}}filterByPrecisionSeriesThreshold(e,t){const r={A:t.pointThresholds?.A?.min??0,B:t.pointThresholds?.B?.min??0,C:t.pointThresholds?.C?.min??0,R:t.pointThresholds?.R?.min??0};return(e||[]).filter(e=>{const t=e.weaponGroup||"A",n=r[t];return"number"==typeof e.points&&e.points>=n})}groupBy(e,t){return(e||[]).reduce((e,r)=>{const n=t(r);return e[n]=e[n]||[],e[n].push(r),e},{})}normalizeRequirementSpec(e){return Array.isArray(e)?{op:"and",children:e.map(e=>this.normalizeRequirementSpec(e))}:e&&"object"==typeof e?Array.isArray(e.and)?{op:"and",children:e.and.map(e=>this.normalizeRequirementSpec(e))}:Array.isArray(e.or)?{op:"or",children:e.or.map(e=>this.normalizeRequirementSpec(e))}:{op:"leaf",req:e}:{op:"leaf",req:{}}}evaluateReqNode(e,t,r={}){if(!e)return{node:"leaf",isMet:!1,leaf:{type:"unknown",index:-1,isMet:!1}};if("and"===e.op){const n=e.children?.map(e=>this.evaluateReqNode(e,t,r))||[];return{node:"and",isMet:n.every(e=>e.isMet),children:n}}if("or"===e.op){const n=e.children?.map(e=>this.evaluateReqNode(e,t,r))||[];return{node:"or",isMet:n.some(e=>e.isMet),children:n}}const n=e.req||{};let s;switch(n.type){case"precision_series":s=this.checkPrecisionSeriesRequirement(n,-1,r);break;case"application_series":s=this.checkApplicationSeriesRequirement(n,-1,r);break;case"sustained_achievement":s=this.checkSustainedAchievementRequirement(n,-1,t,r);break;case"cumulative_competition_score":s=this.checkCumulativeCompetitionScoreRequirement(n,-1,r);break;case"standard_medal":s=this.checkStandardMedalRequirement(n,-1,r);break;case"sustained_reference":s=this.checkSustainedReferenceRequirement(n,-1,t,r);break;case"custom_criterion":s=this.checkCustomCriterionRequirement(n,-1,r);break;default:s={type:n.type,index:-1,isMet:!1,reason:"unsupported_requirement_type",description:n.description}}return{node:"leaf",isMet:!!s.isMet,leaf:s}}flattenLeaves(e,t=[]){if(!e)return t;if("leaf"===e.node)return t.push(e.leaf),t;for(const r of e.children||[])this.flattenLeaves(r,t);return t}getCandidateYearsForTree(){const e=new Set(this.getAllAchievementYears()),t=(new Date).getFullYear();return e.add(t),Array.from(e).sort((e,t)=>t-e)}getAgeAtYear(e){const t=this.profile?.dateOfBirth;if(!t)return null;const r=new Date(t);if(Number.isNaN(r.getTime()))return null;const n=new Date(e,11,31);let s=n.getFullYear()-r.getFullYear();const a=n.getMonth()-r.getMonth();return(a<0||0===a&&n.getDate()<r.getDate())&&(s-=1),s}resolveSustainedReferences(e,t,r){const n=e?.references??t?.references,s=e=>(e||[]).map(e=>"string"==typeof e?{medalId:e}:e).filter(e=>e&&e.medalId);if(Array.isArray(n)){const e=s(n);if(0===e.length)throw new Error("sustained_achievement.references must list at least one medalId");return e}if(n&&"object"==typeof n){const e=Array.isArray(n.when)?n.when:null;let t=null;if(e){const n=this.getAgeAtYear(r);for(const r of e){if(!r||"object"!=typeof r)continue;const e=r.if||{};let s=!0;if(e&&Object.prototype.hasOwnProperty.call(e,"age")){const t=e.age||{};null==n?s=!1:(null==t.gte||n>=t.gte||(s=!1),null==t.gt||n>t.gt||(s=!1),null==t.lte||n<=t.lte||(s=!1),null==t.lt||n<t.lt||(s=!1),null!=t.eq&&n!==t.eq&&(s=!1))}else s=!1;if(s){t=r.refs;break}}}if(!t&&n.otherwise&&(t=n.otherwise),t){const e=s(t);if(0===e.length)throw new Error("sustained_achievement.references rule must provide at least one medalId");return e}}else if(null!=n)throw new Error("Invalid sustained_achievement.references: expected array or object");return this.getSameTypePrereqMedalIds(t).map(e=>({medalId:e}))}checkSustainedReferenceRequirement(e,t,r,n={}){const s=n&&"number"==typeof n.endYear?n.endYear:null;if(null==s)return{type:"sustained_reference",index:t,isMet:!1,description:e.description,windowYear:null,reason:"end_year_required"};const a=this.resolveSustainedReferences(e,r,s);if(!Array.isArray(a)||0===a.length)throw new Error("sustained_reference.references must resolve to at least one medalId");const i=Number.isFinite(n.minStartYear)?{minStartYear:n.minStartYear}:{},l=a.every(e=>this.requirementsMetInYear(e.medalId,s,i));return{type:"sustained_reference",index:t,isMet:l,description:e.description,windowYear:l?s:null}}checkSustainedAchievementRequirement(e,t,r,n={}){const s=e.yearsOfAchievement??3,a=!0===this.profile?.features?.enforceCurrentYearForSustained,i=a?(new Date).getFullYear():n&&"number"==typeof n.endYear?n.endYear:(new Date).getFullYear();if(e&&e.perYear){const s=this.getEarliestCountingYearForMedal(r);let l=!0===e.mustIncludeCurrentYear;a&&(l=!0);let o=this.getAllAchievementYears();o.includes(i)||o.push(i),o=o.sort((e,t)=>e-t),"number"==typeof s&&(o=o.filter(e=>e>=s)),l&&(o=o.filter(e=>e<=i));const c=this.normalizeRequirementSpec(e.perYear),d="number"==typeof s?{minStartYear:s}:{},u=o.filter(e=>!!this.evaluateReqNode(c,r,{...n,endYear:e,...d}).isMet),m=new Set(u);let p,f,h=null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){let t=o;l&&o.includes(i)&&(t=[i]);let r=null,n=0;for(const s of t){let t=0;for(let r=s-e.timeWindowYears+1;r<=s;r++)m.has(r)&&t++;t>n&&(n=t,r=s)}p={current:n,required:e.yearsOfAchievement??1},f=n>=(e.yearsOfAchievement??1),h=f?r:null}else{const t=m.size;p={current:t,required:e.yearsOfAchievement??1},f=t>=(e.yearsOfAchievement??1),f&&l&&!m.has(i)&&(f=!1)}const b=f?h??i:i,x=this.evaluateReqNode(c,r,{...n,endYear:b,...d});return{type:"sustained_achievement",index:t,isMet:f,progress:p,description:e.description,windowYear:h,subtree:x,subtreeYear:b}}const l=this.resolveSustainedReferences(e,r,i),o=this.getEarliestCountingYearForMedal(r);let c,d,u=!0===e.mustIncludeCurrentYear||!0===r?.mustIncludeCurrentYear||l&&l.length>0;if(a&&(u=!0),l.length>0)c=this.getAllAchievementYears();else{const e=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type),t=this.groupBy(e,e=>e.year);c=Object.keys(t).map(e=>Number(e)).filter(e=>!Number.isNaN(e)).sort((e,t)=>e-t)}if("number"==typeof o&&(c=c.filter(e=>e>=o)),u&&(c=c.filter(e=>e<=i)),l.length>0){const e=e=>l.every(t=>this.requirementsMetInYear(t.medalId,e,"number"==typeof o?{minStartYear:o}:{}));d=new Set(c.filter(e))}else{const t=(this.profile.prerequisites||[]).filter(e=>"precision_series"===e.type),r=this.groupBy(t,e=>e.year),n=e.minPointsPerYear??0,s=t=>(t||[]).some(t=>{const r=t.weaponGroup||"A",s=e.pointThresholds?.[r]?.min??n;return"number"==typeof t.points&&t.points>=s});d=new Set(c.filter(e=>s(r[e])))}let m,p,f=null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){let t=c;u&&c.includes(i)&&(t=[i]);let r=null,n=0;for(const s of t){let t=0;for(let r=s-e.timeWindowYears+1;r<=s;r++)d.has(r)&&t++;t>n&&(n=t,r=s)}m={current:n,required:s},p=n>=s,f=p?r:null}else{const e=d.size;m={current:e,required:s},p=e>=s,p&&u&&!d.has(i)&&(p=!1)}return{type:"sustained_achievement",index:t,isMet:p,progress:m,description:e.description,windowYear:f}}checkCustomCriterionRequirement(e,t,r={}){const n=r&&"number"==typeof r.endYear?r.endYear:null,s=G.get(e.name);if(!s)return{type:"custom_criterion",index:t,isMet:!1,description:e.description,reason:"unknown_custom_criterion"};try{const a=s({profile:this.profile,medalsDb:this.medals,endYear:n,minStartYear:Number.isFinite(r.minStartYear)?r.minStartYear:void 0,params:e.params??{}}),i=!(!a||!("object"==typeof a?a.isMet:a));return{type:"custom_criterion",index:t,isMet:i,description:e.description,windowYear:i&&null!=n?n:null}}catch(a){return{type:"custom_criterion",index:t,isMet:!1,description:e.description,error:a?.message}}}checkStandardMedalRequirement(e,t,r={}){let n=(this.profile.prerequisites||[]).filter(e=>"standard_medal"===e.type);e.disciplineType&&(n=n.filter(t=>t.disciplineType===e.disciplineType)),e.medalTier&&(n=n.filter(t=>t.medalType===e.medalTier));const s=r&&"number"==typeof r.endYear?r.endYear:null;if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){const t=null!=s?s:(new Date).getFullYear(),a=t-e.timeWindowYears+1,i=Math.max(a,Number.isFinite(r.minStartYear)?r.minStartYear:a);n=n.filter(e=>(e.year??0)>=i&&(e.year??0)<=t)}else null!=s&&(n=n.filter(e=>e.year===s));const a=e.minAchievements??1,i={current:n.length,required:a},l=i.current>=a;return{type:"standard_medal",index:t,isMet:l,progress:i,description:e.description,windowYear:l&&null!=s?s:null}}checkCumulativeCompetitionScoreRequirement(e,t,r={}){const n=(this.profile.prerequisites||[]).filter(e=>"competition_result"===e.type),s=t=>{const r=e.disciplineType;return(t||[]).filter(e=>e.disciplineType===r)},a=t=>{let a=s(n);if(null!=t)if("number"==typeof e.timeWindowYears&&e.timeWindowYears>0){const n=t-e.timeWindowYears+1,s=Math.max(n,Number.isFinite(r.minStartYear)?r.minStartYear:n);a=a.filter(e=>(e.year??0)>=s&&(e.year??0)<=t)}else a=a.filter(e=>e.year===t);let i=[];return i="ppc"===e.disciplineType?a.filter(t=>{const r=t.ppcClass,n=e.pointThreshold?.[r]?.min;return"number"==typeof t.score&&"number"==typeof n&&t.score>=n}):a.filter(t=>{const r=t.weaponGroup||"A",n=e.pointThresholds?.[r]?.min;return"number"==typeof t.score&&"number"==typeof n&&t.score>=n}),i},i=r&&"number"==typeof r.endYear?r.endYear:null,l=e.minCompetitions??1;if(null!=i){const r=a(i),n=r.length>=l;return{type:"cumulative_competition_score",index:t,isMet:n,progress:{current:r.length,required:l},description:e.description,windowYear:n?i:null}}const o=Array.from(new Set(s(n).map(e=>e.year).filter(e=>"number"==typeof e))).sort((e,t)=>e-t);let c=null,d=0;for(const m of o){const e=a(m);e.length>d&&(d=e.length,c=m)}const u=d>=l;return{type:"cumulative_competition_score",index:t,isMet:u,progress:{current:d,required:l},description:e.description,windowYear:u?c:null}}evaluateAllMedals(){const e=this.medals.getAllMedals(),t={unlocked:[],eligible:[],available:[],locked:[]};return e.forEach(e=>{const r=this.evaluateMedal(e.id);t[r.status].push(r)}),t}getEligibleYears(e){if(this.hasUnlockedMedal(e))return[];const t=this.getAllAchievementYears().sort((e,t)=>t-e),r=[];for(const n of t)try{const t=this.evaluateMedal(e,{endYear:n});t&&"eligible"===t.status&&r.push(n)}catch{}return r}}function K(){const e=t.useContext(P);if(e===T)throw new Error("useMedalDatabase must be used within MedalProvider");return e}function z(){const e=t.useContext(D);if(!e)throw new Error("useProfile must be used within ProfileProvider");return e}function W(){const{medalDatabase:e}=K(),{currentProfile:r}=z();return t.useMemo(()=>{if(!e)return null;return new V(e,r??{unlockedMedals:[],prerequisites:[]})},[e,r])}function H(){const e=W();return t.useMemo(()=>e?e.evaluateAllMedals():{unlocked:[],eligible:[],available:[],locked:[]},[e])}function X({children:e}){const t=W(),n=H();return r.jsx(U.Provider,{value:{calculator:t,allStatuses:n},children:e})}const J=t.createContext(null);function Z({children:e}){const[n,s]=t.useState([]),[a,i]=t.useState(-1),l=t.useCallback(e=>{s(t=>{const r=t.slice(0,a+1);r.push(e);const n=r.length>200?r.slice(r.length-200):r;return i(n.length-1),n})},[a]),o=t.useCallback(()=>{let e=null;return i(t=>{const r=t>0?t-1:t;return e=r!==t?r:null,r}),e},[]),c=t.useCallback(()=>{let e=null;return i(t=>{const r=t<n.length-1?t+1:t;return e=r!==t?r:null,r}),e},[n.length]),d=a>0,u=a>=0&&a<n.length-1,m=t.useMemo(()=>({pushState:l,undo:o,redo:c,canUndo:d,canRedo:u,history:n,historyIndex:a}),[l,o,c,d,u,n,a]);return r.jsx(J.Provider,{value:m,children:e})}const Q={achievementEntry:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"Registrering av prestationer är under utveckling. Gränssnitt och beteende kan ändras."},historyTimeline:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"Historiköversikten är under utveckling. Funktioner kan saknas."},enforceCurrentYearSetting:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"Inställningen är under utveckling.",overlay:"inline"},csvImport:{default:"on",env:{production:"preview"},title:"Förhandsvisning",message:"CSV-import/export är under utveckling. Gränssnittet kan ändras och vissa funktioner saknas."}},ee=t.createContext(null);function te(e){try{localStorage.setItem("ff:overrides",JSON.stringify(e||{}))}catch{}}function re({children:e}){const n=function(){const e="undefined"!=typeof window&&window.location&&window.location.hostname?window.location.hostname:"";return"localhost"===e||"127.0.0.1"===e?"development":"production"}(),[s,a]=t.useState(()=>"undefined"!=typeof window?function(){try{return JSON.parse(localStorage.getItem("ff:overrides")||"{}")}catch{return{}}}():{}),i=t.useContext(D),l=i?.currentProfile,o=i?.updateProfile,c=t.useMemo(()=>l?.features?.featureFlags||{},[l]),d=t.useMemo(()=>{const e="undefined"!=typeof window?function(){try{const e=new URLSearchParams(window.location.search).get("ff");return e?e.split(",").reduce((e,t)=>{const[r,n]=t.split(":");return r&&n&&(e[r.trim()]=n.trim()),e},{}):{}}catch{return{}}}():{},t={};for(const[r,s]of Object.entries(Q||{})){const e=s?.default||"off",a=s?.env?.[n]??e;t[r]=a}for(const[r,n]of Object.entries(s||{}))t[r]=n;for(const[r,n]of Object.entries(c||{}))t[r]=n;for(const[r,n]of Object.entries(e||{}))t[r]=n;return t},[n,s,c]),u=e=>{const t={...s||{},...e||{}};a(t),te(t)},m={get:e=>d[e]||"off",enabled(e){const t=d[e]||"off";return"on"===t||"preview"===t},all:()=>({...d}),set(e,t){u({[e]:t})},setMany(e){u(e)},clear(e){const t={...s||{}};delete t[e],a(t),te(t)},clearAll(){a({}),te({})},async saveToProfile(e){if(!o||!l)return!1;const t={...l.features||{},featureFlags:{...e||{}}};return await o({...l,features:t}),!0},async clearProfileOverrides(){if(!o||!l)return!1;const e={...l.features||{}};return delete e.featureFlags,await o({...l,features:e}),!0}};return r.jsx(ee.Provider,{value:m,children:e})}const ne=t.createContext(null),se={version:"0.9.3",number:"114",commit:"a38164f",timeISO:"2026-01-04T08:06:35.957Z"},ae="app:onboardingTour:lastSeen";function ie(e="v1"){return function(){try{return localStorage.getItem(ae)}catch{return null}}()===e}const le=[{id:"welcome",title:"Snabbguide",body:"Sök, filtrera och öppna detaljer för att se krav och status.",target:null},{id:"search",title:"Sök",body:"Skriv för att filtrera märken.",target:'[data-tour="medals-search"]'},{id:"chips",title:"Snabbfilter",body:"Tryck på en status för att filtrera snabbt.",target:'[data-tour="chip-unlocked"]'},{id:"filters",title:"Fler filter",body:"Öppna filterpanelen för fler val.",target:'[data-tour="open-filters"], [data-tour="filter-panel"]'},{id:"open",title:"Öppna ett märke",body:"Tryck på ett märke i listan för att se detaljer. Lämna guiden öppen och tryck sedan Nästa.",target:'[data-tour="medal-row-0"]',requiresTarget:!0,autoAdvanceToNextOn:'[data-tour="medal-detail-panel"]'},{id:"detail",title:"Detaljer",body:"När detaljvyn är öppen ser du krav, förhandskrav och status. Tryck Nästa för att avsluta.",target:'[data-tour="medal-detail-panel"]',requiresTarget:!0}];function oe({children:e}){const[n,s]=t.useState(!1),[a,i]=t.useState(0),l="v1",o=t.useCallback(()=>{i(0),s(!0)},[]),c=t.useCallback(()=>{s(!1)},[]),d=t.useCallback(()=>{!function(e){try{e&&localStorage.setItem(ae,e)}catch{}}(l),s(!1)},[l]),u=t.useCallback(()=>{i(e=>e>=le.length-1?e:e+1)},[]),m=t.useCallback(()=>{i(e=>Math.max(0,e-1))},[]),p=t.useCallback(()=>!ie(l),[l]),f=t.useMemo(()=>({open:n,stepIndex:a,steps:le,start:o,close:c,complete:d,next:u,back:m,canAutoStart:p,tourId:l}),[n,a,o,c,d,u,m,p,l]);return r.jsx(ne.Provider,{value:f,children:e})}function ce({id:e,title:n,open:s,onClose:a,swipeToDismiss:i=!0,children:l}){const o=t.useRef(null),c=t.useRef(null);t.useEffect(()=>{if(!s)return;c.current=document.activeElement;const e=o.current,t=e=>{"Escape"===e.key&&(e.stopPropagation(),a?.())},r=t=>{if("Tab"!==t.key)return;if(!e)return;const r=e.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])'),n=Array.from(r).filter(e=>!e.hasAttribute("disabled")&&"true"!==e.getAttribute("aria-hidden"));if(0===n.length)return;const s=n[0],a=n[n.length-1];t.shiftKey&&document.activeElement===s?(t.preventDefault(),a.focus()):t.shiftKey||document.activeElement!==a||(t.preventDefault(),s.focus())};document.addEventListener("keydown",t),e?.addEventListener("keydown",r);const n=setTimeout(()=>e?.focus(),0);return()=>{document.removeEventListener("keydown",t),e?.removeEventListener("keydown",r),clearTimeout(n),c.current&&"function"==typeof c.current.focus&&c.current.focus()}},[s,a]);const d=function({onSwipe:e,threshold:r=50,allowedDirections:n=["left","right","up","down"]}={}){const s=t.useRef({x:0,y:0,t:0}),a=t.useRef({x:0,y:0,t:0});return{onTouchStart:e=>{if(!e.touches||0===e.touches.length)return;const t=e.touches[0];s.current={x:t.clientX,y:t.clientY,t:Date.now()},a.current={x:t.clientX,y:t.clientY,t:Date.now()}},onTouchMove:e=>{if(!e.touches||0===e.touches.length)return;const t=e.touches[0];a.current={x:t.clientX,y:t.clientY,t:Date.now()}},onTouchEnd:()=>{const t=a.current.x-s.current.x,i=a.current.y-s.current.y,l=Math.abs(t),o=Math.abs(i);let c=null;l>o?l>=r&&(c=t>0?"right":"left"):o>=r&&(c=i>0?"down":"up"),c&&n.includes(c)&&e?.(c)}}}({onSwipe:e=>{!i||"down"!==e&&"right"!==e||a?.()}});return s?r.jsxs("div",{"aria-hidden":!s,className:"fixed inset-0 z-[80]",children:[r.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>a?.(),"aria-hidden":!0}),r.jsxs("div",{id:e,role:"dialog","aria-modal":"true","aria-labelledby":e?`${e}-title`:void 0,ref:o,tabIndex:-1,className:"absolute left-0 right-0 bottom-0 bg-bg-secondary text-foreground rounded-t-2xl shadow-2xl border-t border-border focus:outline-none",style:{transform:"translateY(0)",transition:"undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches?"none":"transform 200ms ease",maxHeight:"85dvh",WebkitOverflowScrolling:"touch"},...d,children:[r.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[r.jsx("h2",{id:e?`${e}-title`:void 0,className:"text-lg font-semibold",children:n}),r.jsx("button",{type:"button",className:"btn btn-muted h-11 w-11 inline-flex items-center justify-center",onClick:()=>a?.(),"aria-label":"Close",children:"✕"})]}),r.jsx("div",{className:"p-4 pb-[calc(env(safe-area-inset-bottom)+1rem)] overflow-auto",style:{maxHeight:"calc(85dvh - 56px)",overflowY:"auto",overscrollBehavior:"contain"},children:l})]})]}):null}function de({id:e="profile-import-dialog",open:n,onClose:s}){const{restoreProfileFromBackup:a}=z(),[i,l]=t.useState(""),[o,c]=t.useState("new-id"),[d,u]=t.useState(null),[m,p]=t.useState(!1);if(!n)return null;return r.jsx("div",{className:"fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4",children:r.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":`${e}-title`,id:e,className:"w-[min(92vw,32rem)] max-h-[85vh] overflow-auto rounded-xl bg-bg-secondary border border-border shadow-2xl",children:r.jsxs("form",{onSubmit:async e=>{e.preventDefault();try{if(p(!0),u(null),!i.trim())return void u("Klistra in JSON eller välj en fil.");await a(i,{strategy:o}),l(""),s?.()}catch(t){u(t.message||"Import misslyckades")}finally{p(!1)}},className:"p-6 space-y-5",children:[r.jsx("h2",{id:`${e}-title`,className:"text-2xl font-bold text-text-primary",children:"Importera profil (backup)"}),d&&r.jsx("div",{className:"alert alert-error",role:"alert","aria-live":"assertive",children:d}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",htmlFor:`${e}-file`,children:"Välj fil"}),r.jsx("input",{id:`${e}-file`,type:"file",accept:".json,application/json",onChange:e=>{const t=e.target.files?.[0];if(!t)return;const r=new FileReader;r.onload=()=>l(String(r.result||"")),r.readAsText(t)},className:"input text-sm file:mr-3 file:px-3 file:py-2 file:rounded-md file:bg-primary file:text-primary-foreground hover:file:bg-primary-hover file:cursor-pointer",disabled:m})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",htmlFor:`${e}-textarea`,children:"Eller klistra in JSON"}),r.jsx("textarea",{id:`${e}-textarea`,value:i,onChange:e=>l(e.target.value),className:"textarea min-h-[8rem]",placeholder:'{"kind":"profile-backup","version":"1.0","profile":{...}}',disabled:m})]}),r.jsxs("fieldset",{className:"space-y-2",children:[r.jsx("legend",{className:"block text-sm font-medium text-text-secondary",children:"Metod"}),r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsxs("label",{className:"inline-flex items-center gap-2",children:[r.jsx("input",{type:"radio",name:`${e}-strategy`,value:"new-id",checked:"new-id"===o,onChange:()=>c("new-id"),disabled:m}),r.jsx("span",{children:"Skapa ny profil"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2",children:[r.jsx("input",{type:"radio",name:`${e}-strategy`,value:"overwrite",checked:"overwrite"===o,onChange:()=>c("overwrite"),disabled:m}),r.jsx("span",{children:"Ersätt profil med samma ID"})]})]})]}),r.jsxs("div",{className:"flex items-center justify-end gap-3 pt-2",children:[r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px] disabled:opacity-50",disabled:m,children:"Importera profil"}),r.jsx("button",{type:"button",onClick:s,className:"btn btn-secondary min-h-[44px]",disabled:m,children:"Avbryt"})]})]})})})}function ue({mode:e="picker",open:n=!1,onClose:s,id:a="profile-picker",forceCreate:i=!1,convertGuest:l=!1}){const{profiles:o,currentProfile:c,loading:d,createProfile:u,updateProfile:m,selectProfile:p,deleteProfile:f,convertGuestToSaved:h}=z(),[b,x]=t.useState(!1),[g,y]=t.useState("create"),[v,w]=t.useState(null),[j,k]=t.useState(""),[N,S]=t.useState(""),[C,M]=t.useState(!1),A="picker"===e,I=A&&n&&i,T=I?"create":g,P=I?null:v,E=async e=>{if(confirm("Är du säker? Det går inte att ångra."))try{await f(e)}catch(t){console.error("Misslyckades ta bort profil:",t)}},D=e=>{if(!e)return null;const t=new Date(e);if(Number.isNaN(t.getTime()))return null;const r=new Date;let n=r.getFullYear()-t.getFullYear();const s=r.getMonth()-t.getMonth();return(s<0||0===s&&r.getDate()<t.getDate())&&n--,n};return r.jsxs(r.Fragment,{children:[A?r.jsxs(ce,{id:a,title:"Välj profil",open:n,onClose:s,children:[o.length>0?r.jsx("div",{className:"space-y-2",children:o.map(e=>r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{onClick:()=>{p(e.userId),s?.()},className:"btn btn-muted flex-1 justify-start text-left",children:[e.displayName," (Ålder ",D(e.dateOfBirth)??"—",")"]}),r.jsx("button",{onClick:()=>{y("edit"),w(e),k(e.displayName||""),S(e.dateOfBirth||""),x(!0)},className:"btn btn-secondary",children:"Ändra"}),r.jsx("button",{onClick:()=>E(e.userId),className:"btn btn-danger",children:"Ta bort"})]},e.userId))}):r.jsx("p",{className:"text-text-secondary",children:"Inga profiler ännu."}),r.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[r.jsx("button",{onClick:()=>{y("create"),w(null),k(""),S(""),x(!0)},className:"btn btn-primary min-h-[44px]",children:"Skapa ny profil"}),r.jsx("button",{onClick:()=>M(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Importera profil"})]})]}):r.jsx("div",{children:c?r.jsxs("div",{className:"bg-bg-secondary border border-border ring-1 ring-primary/20 rounded-lg p-4 mb-4",children:[r.jsxs("p",{className:"text-text-primary font-semibold",children:["Profile: ",c.displayName]}),r.jsxs("p",{className:"text-text-secondary text-sm",children:["Ålder: ",D(c.dateOfBirth)??"—"]})]}):r.jsxs("div",{className:"bg-bg-secondary border border-border rounded-lg p-4 mb-4",children:[r.jsx("p",{className:"text-text-primary mb-3",children:"No profile selected"}),o.length>0&&r.jsx("div",{className:"space-y-2 mb-3",children:o.map(e=>r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{onClick:()=>p(e.userId),className:"btn btn-muted flex-1 justify-start text-left",children:[e.displayName," (Age ",D(e.dateOfBirth)??"—",")"]}),r.jsx("button",{onClick:()=>{y("edit"),w(e),k(e.displayName||""),S(e.dateOfBirth||""),x(!0)},className:"btn btn-secondary",children:"Ändra"}),r.jsx("button",{onClick:()=>E(e.userId),className:"btn btn-danger",children:"Ta bort"})]},e.userId))}),r.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[r.jsx("button",{onClick:()=>{y("create"),w(null),k(""),S(""),x(!0)},className:"btn btn-primary min-h-[44px]",children:"Skapa ny profil"}),r.jsx("button",{onClick:()=>M(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Importera profil"})]})]})}),r.jsx(de,{id:"profile-import-dialog",open:C,onClose:()=>M(!1)}),(I||b)&&r.jsx("div",{className:"fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4",children:r.jsx("div",{role:"dialog","aria-modal":"true","aria-labelledby":"create-profile-title",className:"w-[min(92vw,32rem)] max-h-[85vh] overflow-auto rounded-xl bg-bg-secondary border border-border shadow-2xl",children:r.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),j.trim()&&N)try{"edit"===T&&P?await m({...v,displayName:j.trim(),dateOfBirth:N}):l&&c?.isGuest?await h(j.trim(),N):await u(j.trim(),N),k(""),S(""),w(null),x(!1),s?.()}catch(t){console.error("Misslyckades spara profil:",t)}},className:"p-6 space-y-5",children:[r.jsx("h2",{id:"create-profile-title",className:"text-2xl font-bold text-text-primary",children:"edit"===T?"Ändra profil":"Skapa ny profil"}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",children:"Profile Name"}),r.jsx("input",{type:"text",value:j,onChange:e=>k(e.target.value),className:"input",placeholder:"Ditt namn",disabled:d,required:!0})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"block text-sm font-medium text-text-secondary",children:"Födelsedatum"}),r.jsx("input",{type:"date",value:N,onChange:e=>S(e.target.value),className:"input",disabled:d,required:!0}),r.jsx("p",{className:"text-xs text-text-secondary",children:"Används för att beräkna åldersberoende krav (tex gränser för precisionsserier)"})]}),r.jsxs("div",{className:"flex items-center justify-end gap-3 pt-2",children:[r.jsx("button",{type:"submit",className:"btn btn-primary disabled:opacity-50",disabled:d,children:"edit"===T?"Spara":l&&c?.isGuest?"Spara framsteg":"Skapa"}),r.jsx("button",{type:"button",onClick:()=>{x(!1),I&&s?.()},className:"btn btn-secondary",disabled:d,children:"Avbryt"})]})]})})})]})}function me({name:e,className:t="w-4 h-4",...a}){const i=n[e]||s;return r.jsx(i,{"aria-hidden":"true",focusable:"false",className:t,...a})}function pe(){const e=t.useContext(ne);if(!e)throw new Error("useOnboardingTour must be used within OnboardingTourProvider");return e}const fe=[{path:"/skill-tree",label:"Märkesträd"},{path:"/medals",label:"Alla märken"},{path:"/data",label:"Data"},{path:"/settings",label:"Inställningar"},{path:"/about",label:"Om"}];function he(){const e=a(),n=i(),[s,o]=t.useState(null),c=s===e.pathname,{currentProfile:d}=z(),[u,m]=t.useState(!1),[p,f]=t.useState(!1),h=pe(),b=d?.displayName?d.displayName.trim().split(/\s+/).map(e=>e[0]).slice(0,2).join("").toUpperCase():null;t.useEffect(()=>{if(!c)return;const e=e=>{"Escape"===e.key&&o(null)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[c]);const x=()=>{"/medals"===e.pathname?(f(!1),o(null),m(!1),h.start()):f(!0)};return r.jsxs("header",{className:"bg-surface border-b border-border sticky top-0 z-50",children:[r.jsx("div",{className:"max-w-6xl mx-auto px-4",children:r.jsxs("div",{className:"py-2",children:[r.jsx("a",{href:"#main",className:"absolute -top-10 left-2 focus:top-2 focus:left-2 focus:z-[60] btn btn-primary",children:"Hoppa till innehåll"}),r.jsxs("div",{className:"flex items-center justify-between gap-2",children:[r.jsxs(l,{to:"/",onClick:()=>{o(null),m(!1),f(!1)},className:"inline-flex items-center gap-2 text-2xl font-bold leading-tight break-words text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsx(me,{name:"Award",className:"w-6 h-6 shrink-0"}),r.jsx("span",{children:"Skyttemärken"})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("button",{type:"button",onClick:x,className:"hidden sm:inline-flex items-center justify-center min-h-[44px] px-3 rounded-md btn btn-muted","aria-haspopup":"dialog","aria-controls":"guide-prompt",children:"Guide"}),r.jsx("button",{type:"button",onClick:()=>m(!0),className:"inline-flex items-center justify-center h-10 w-10 sm:h-11 sm:w-11 rounded-full btn btn-muted","aria-haspopup":"dialog","aria-controls":"profile-picker","aria-label":d?.displayName?`Aktiv profil: ${d.displayName}`:"Välj profil",title:d?.displayName||"Välj profil",children:b||"?"}),r.jsx("nav",{"aria-label":"Primary",className:"hidden sm:block",children:r.jsx("ul",{className:"flex gap-2",children:fe.map(t=>{const n=e.pathname===t.path;return r.jsx("li",{children:r.jsx(l,{to:t.path,onClick:()=>m(!1),className:"inline-flex items-center min-h-[44px] px-4 py-2 rounded transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary "+(n?"bg-primary text-primary-foreground":"text-muted-foreground hover:bg-surface"),"aria-current":n?"page":void 0,children:t.label})},t.path)})})}),r.jsx("button",{type:"button",onClick:()=>o(t=>t===e.pathname?null:e.pathname),className:"sm:hidden inline-flex items-center justify-center h-11 w-11 rounded-md btn btn-muted","aria-label":"Växla meny","aria-controls":"mobile-primary-nav","aria-expanded":c?"true":"false",children:r.jsx(me,{name:"Menu",size:20,className:"shrink-0"})})]})]}),r.jsx("nav",{id:"mobile-primary-nav","aria-label":"Primary",className:(c?"mt-2":"hidden")+" sm:hidden",children:r.jsxs("ul",{className:"grid grid-cols-2 gap-2",children:[r.jsx("li",{className:"col-span-2",children:r.jsx("button",{type:"button",onClick:x,className:"w-full inline-flex items-center justify-center min-h-[44px] px-4 py-2 rounded transition-colors btn btn-muted","aria-haspopup":"dialog","aria-controls":"guide-prompt",children:"Guide"})}),fe.map(t=>{const n=e.pathname===t.path;return r.jsx("li",{children:r.jsx(l,{to:t.path,onClick:()=>{o(null),m(!1),f(!1)},className:"inline-flex items-center min-h-[44px] px-4 py-2 rounded transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary "+(n?"bg-primary text-primary-foreground":"text-muted-foreground hover:bg-surface"),"aria-current":n?"page":void 0,children:t.label})},t.path)})]})})]})}),r.jsx(ue,{id:"profile-picker",mode:"picker",open:u,onClose:()=>m(!1)}),p&&r.jsx("div",{id:"guide-prompt",role:"dialog","aria-modal":"true","aria-labelledby":"guide-prompt-title",className:"fixed inset-0 z-[60] bg-black/50 flex items-end sm:items-center justify-center p-4",onMouseDown:e=>{e.target===e.currentTarget&&f(!1)},children:r.jsxs("div",{className:"card w-full sm:w-[min(520px,90vw)] rounded-t-2xl sm:rounded-xl p-4 sm:p-6",children:[r.jsx("h2",{id:"guide-prompt-title",className:"text-lg font-semibold text-foreground",children:"Starta guide"}),r.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Den här guiden finns i Märkeslistan."}),r.jsxs("div",{className:"mt-4 flex flex-col sm:flex-row gap-2 sm:justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>f(!1),children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:()=>{try{sessionStorage.setItem("app:onboardingTour:manualStart","medals")}catch{}f(!1),o(null),m(!1),n("/medals")},children:"Öppna Märkeslista"})]})]})})]})}const be="https://www.pistolskytteforbundet.se/",xe="https://github.com/mandakan/spsf-medal-explorer",ge="https://buymeacoffee.com/thias",ye="https://www.pistolskytteforbundet.se/om-pistolskytte/regler/skjuthandboken-och-sakb/",ve="Skyttemärken",we="Mathias A",je="MIT",ke={2024:20};function Ne(e){const t=Object.entries(ke).map(([e,t])=>[Number(e),t]).sort((e,t)=>e[0]-t[0]);let r=t[0]?.[1]??null;for(const[n,s]of t)e>=n&&(r=s);return r}const Se=Ne((new Date).getFullYear());function Ce({className:e="w-5 h-5",...t}){return r.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:e,...t,children:r.jsx("path",{fill:"currentColor",d:"M12 .5a12 12 0 0 0-3.79 23.4c.6.11.82-.26.82-.58v-2.03c-3.34.73-4.04-1.61-4.04-1.61-.55-1.41-1.35-1.79-1.35-1.79-1.1-.75.08-.73.08-.73 1.22.09 1.86 1.25 1.86 1.25 1.08 1.85 2.83 1.31 3.52 1 .11-.79.42-1.31.76-1.61-2.66-.3-5.46-1.33-5.46-5.93 0-1.31.47-2.38 1.24-3.22-.13-.3-.54-1.52.12-3.17 0 0 1.01-.32 3.3 1.23.96-.27 1.98-.4 3-.4s2.04.13 3 .4c2.29-1.55 3.3-1.23 3.3-1.23.66 1.65.25 2.87.12 3.17.77.84 1.24 1.91 1.24 3.22 0 4.61-2.8 5.62-5.47 5.92.43.37.82 1.1.82 2.22v3.29c0 .32.22.69.83.58A12 12 0 0 0 12 .5Z"})})}function Me({className:e="w-5 h-5",...t}){return r.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:e,...t,children:r.jsx("path",{fill:"currentColor",d:"M3 7h13a3 3 0 0 1 3 3v1a4 4 0 0 1-3 3.87V16a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V7Zm16 3a1 1 0 0 0-1-1h-1v3.82A2 2 0 0 0 19 11v-1ZM5 18a2 2 0 0 0 2 2h5a2 2 0 0 0 2-2V9H5v9ZM10 2a1 1 0 0 1 1 1c0 .83-.5 1.25-.8 1.5-.2.17-.2.17-.2.5a1 1 0 0 1-2 0c0-1 .5-1.5.8-1.75.2-.17.2-.17.2-.5a1 1 0 0 1 1-1Zm4 0a1 1 0 0 1 1 1c0 .83-.5 1.25-.8 1.5-.2.17-.2.17-.2.5a1 1 0 0 1-2 0c0-1 .5-1.5.8-1.75.2-.17.2-.17.2-.5a1 1 0 0 1 1-1Z"})})}function Ae(){const e=(new Date).getFullYear(),t=we,n=je,s=xe,a=ge,i=`${"undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/"}LICENSE`;return r.jsx("footer",{role:"contentinfo",className:"w-full border-t border-border bg-bg-primary",children:r.jsx("div",{className:"max-w-6xl mx-auto px-4 py-6",children:r.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-4",children:[r.jsxs("p",{className:"text-sm text-text-secondary text-center md:text-left",children:["© ",e," ",t," •"," ",r.jsxs("a",{href:i,target:"_blank",rel:"noopener noreferrer",className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary",children:["Licensierad under ",n]})]}),r.jsxs("nav",{className:"flex items-center gap-2","aria-label":"Sidfotslänkar",children:[r.jsxs("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm min-h-[44px] text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary","aria-label":"Öppna GitHub-repositoriet",children:[r.jsx(Ce,{}),r.jsx("span",{children:"Källkod"})]}),r.jsxs("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm min-h-[44px] text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary","aria-label":"Köp mig en kaffe",children:[r.jsx(Me,{}),r.jsx("span",{children:"Köp en kaffe till mig"})]})]})]})})})}function Ie(){return r.jsxs("div",{className:"min-h-screen bg-bg-primary",children:[r.jsx(he,{}),r.jsx("div",{className:"max-w-6xl mx-auto px-4 py-8",children:r.jsx("main",{id:"main",children:r.jsx(o,{})})}),r.jsx(Ae,{})]})}function Te({id:e="disclaimer-global",variant:n="info",text:s="OBS: Fristående app; ej godkänd av Svenska Pistolskytteförbundet. Vid skillnader gäller alltid senaste officiella regelbok.",linkUrl:a,linkLabel:i,dismissible:l=!0,className:o="",year:c=(new Date).getFullYear()}){const d=t.useMemo(()=>Ne(c),[c]),u=t.useMemo(()=>i??(d?`Läs regelboken (v${d})`:"Läs regelboken"),[i,d]),m=t.useMemo(()=>`dismiss:${e}${d?`@${d}`:""}`,[e,d]),[p,f]=t.useState(!1);t.useEffect(()=>{f("1"===localStorage.getItem(m))},[m]);if(p)return null;const h="warning"===n?"border-review text-foreground":"border-border text-muted-foreground";return r.jsxs("div",{role:"status","aria-live":"polite",className:["relative flex items-center gap-2 rounded-md border px-3 py-2 text-sm bg-bg-secondary min-h-11",h,o].filter(Boolean).join(" "),children:[r.jsx("span",{"aria-hidden":"true",className:"warning"===n?"inline-block w-2 h-2 rounded-full bg-review":"inline-block w-2 h-2 rounded-full bg-primary opacity-60"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("span",{children:s}),a?r.jsx("a",{className:"underline underline-offset-2 ml-2 hover:opacity-80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded-sm",href:a,target:"_blank",rel:"noopener noreferrer","aria-label":"Öppna officiell regelbok i ny flik",children:u}):null]}),l?r.jsx("button",{type:"button",onClick:()=>{f(!0),localStorage.setItem(m,"1")},className:"ml-2 inline-flex items-center justify-center rounded h-11 w-11 md:h-6 md:w-6 hover:bg-bg-secondary/70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary","aria-label":"Stäng meddelande",children:r.jsx("span",{"aria-hidden":"true",children:"×"})}):null]})}function Pe(){const{medalDatabase:e,loading:t}=K();return r.jsxs("div",{className:"space-y-8",children:[r.jsxs("section",{className:"text-center mb-12",children:[r.jsx("h1",{className:"text-4xl font-bold text-foreground mb-4",children:"Skyttemärken"}),r.jsx("p",{className:"text-lg text-muted-foreground",children:"Dokumentera dina skyttemärken och medaljer med aktiviteter, utforska framtida märken och planera progression"}),r.jsx("div",{className:"mt-6 flex justify-center",children:r.jsx(l,{to:"/medals",className:"btn btn-secondary min-h-[44px] inline-flex items-center justify-center",children:"Visa snabbguide"})})]}),r.jsx(Te,{id:"disclaimer-home",variant:"info",linkUrl:ye}),r.jsxs("section",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[r.jsxs(l,{to:"/skill-tree",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(me,{name:"Target",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Märken"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Utforska märken i ett interaktivt träd"})]}),r.jsxs(l,{to:"/medals",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(me,{name:"List",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Märkeslista"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Översikt över alla märken med filter och sökning"})]}),r.jsxs(l,{to:"/settings",className:"card p-6 shadow hover:shadow-lg transition-shadow cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2 text-foreground flex items-center gap-2",children:[r.jsx(me,{name:"Settings",className:"w-5 h-5 shrink-0 text-muted-foreground"}),r.jsx("span",{children:"Inställningar"})]}),r.jsx("p",{className:"text-muted-foreground",children:"Hantera din profil"})]})]}),!t&&e&&r.jsxs("section",{className:"card p-6 shadow",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:"Status"}),r.jsxs("p",{className:"text-muted-foreground",children:[r.jsx(me,{name:"CheckCircle",className:"inline w-4 h-4 align-text-bottom mr-1 text-muted-foreground"}),e.getAllMedals().length," märken laddade"]}),r.jsxs("p",{className:"mt-2 text-muted-foreground",children:["Version: ",r.jsx("code",{children:se.version})," • Build: ",r.jsx("code",{children:se.number})," • Commit: ",r.jsx("code",{children:se.commit})]})]})]})}function Ee(e=1,r=.5,n=3,s={}){const[a,i]=t.useState(0),[l,o]=t.useState(0),[c,d]=t.useState(e),{getBounds:u=null,overscrollPx:m=48,contentPaddingPx:p={left:0,top:0,right:0,bottom:0}}=s,f=t.useRef(null),h=t.useRef(new Map),b=t.useRef({initialDistance:0,initialScale:e,lastCenter:null}),x=t.useRef({vx:0,vy:0,lastT:0,raf:0}),g=t.useRef({x:0,y:0,t:0}),y=t.useCallback(()=>{if("undefined"==typeof window||!window.matchMedia)return!1;try{return window.matchMedia("(prefers-reduced-motion: reduce)").matches}catch{return!1}},[]),v=t.useCallback(()=>{const e=x.current;e.raf&&(cancelAnimationFrame(e.raf),e.raf=0),e.vx=0,e.vy=0,e.lastT=0},[]),w=t.useRef({width:0,height:0}),j=t.useRef({x:0,y:0}),k=t.useRef(e);t.useEffect(()=>{k.current=c},[c]),t.useEffect(()=>{j.current={x:a,y:l}},[a,l]);const N=t.useCallback(e=>{const t=e?.currentTarget?.getBoundingClientRect?.();t&&(w.current={width:t.width,height:t.height})},[]),S=(e,t)=>t<=0||e<=0?0:e*t/(e+t),C=t.useCallback((e,t=w.current)=>{if(!s||!u||!t?.width)return null;const r=u(),n=Math.max(.001,e),a=t.width/n,i=t.height/n,l=(p?.left||0)/n,o=(p?.right||0)/n,c=(p?.top||0)/n,d=(p?.bottom||0)/n,m=a-(Math.max(0,r.maxX-r.minX)+l+o),f=i-(Math.max(0,r.maxY-r.minY)+c+d);return{minX:Math.min(0,m),maxX:Math.max(0,m),minY:Math.min(0,f),maxY:Math.max(0,f)}},[u,s,p]),M=t.useCallback((e,t,r,n=!1,s=w.current)=>{const a=C(r,s);if(!a)return[e,t];const{minX:i,maxX:l,minY:o,maxY:c}=a;if(n){return[Math.min(Math.max(e,i),l),Math.min(Math.max(t,o),c)]}const d=(m||0)/Math.max(.001,r);let u=e,p=t;return e<i?u=i-S(i-e,d):e>l&&(u=l+S(e-l,d)),t<o?p=o-S(o-t,d):t>c&&(p=c+S(t-c,d)),[u,p]},[C,m]),A=t.useCallback((e,t,r,n=!1,s)=>{const[a,l]=M(e,t,r,n,s);i(a),o(l),j.current={x:a,y:l}},[M]),I=t.useCallback((t,r,n)=>{if(!isFinite(t)||!isFinite(r))return;if(y())return;v();const s=x.current;s.vx=t,s.vy=r,s.lastT="undefined"!=typeof performance?performance.now():Date.now();const a=Math.max(.001,n??(k.current||e)),i=e=>{const t=s.lastT||e,r=Math.max(1,e-t);s.lastT=e;const n=Math.exp(-r/280);s.vx*=n,s.vy*=n;const l=j.current.x+s.vx*r,o=j.current.y+s.vy*r;if(A(l,o,a,!0),Math.hypot(s.vx,s.vy)<.001){v();const[e,t]=M(j.current.x,j.current.y,a,!0);return void A(e,t,a,!0)}s.raf=requestAnimationFrame(i)};s.raf=requestAnimationFrame(i)},[y,v,A,M,e]),T=t.useCallback((e,t,r,n=220)=>{if(y())return void A(e,t,r,!0);v();const s=x.current,a=j.current.x,i=j.current.y,l="undefined"!=typeof performance?performance.now():Date.now(),o=c=>{const d=Math.min(1,(c-l)/n),u=(m=d,1-Math.pow(1-m,3));var m;A(a+(e-a)*u,i+(t-i)*u,r,!0),d<1&&(s.raf=requestAnimationFrame(o))};s.raf=requestAnimationFrame(o)},[y,A,v]),P=t.useCallback((e,t)=>{e.preventDefault(),v(),N(e);const s=e.currentTarget,i=s?.getBoundingClientRect?.(),o=i?e.clientX-i.left:0,u=i?e.clientY-i.top:0,m=i?o-i.width/2:0,p=i?u-i.height/2:0,f=c,h=Math.pow(2,-e.deltaY/300),b=Math.max(r,Math.min(n,f*h)),x=Math.max(.001,t??f),g=Math.max(.001,x*(b/Math.max(.001,f))),y=m*(1/g-1/x),w=p*(1/g-1/x);d(b),A(a+y,l+w,g,!1,i)},[c,r,n,v,N,A,a,l]),E=t.useCallback(e=>{e.preventDefault(),v(),N(e),e.currentTarget?.setPointerCapture?.(e.pointerId),h.current.set(e.pointerId,{x:e.clientX,y:e.clientY});const t="undefined"!=typeof performance?performance.now():Date.now();if(g.current={x:e.clientX,y:e.clientY,t:t},1===h.current.size)f.current={x:e.clientX,y:e.clientY,panX:a,panY:l};else if(2===h.current.size){const e=Array.from(h.current.values()),t=e[1].x-e[0].x,r=e[1].y-e[0].y;b.current.initialDistance=Math.hypot(t,r),b.current.initialScale=c,b.current.lastCenter={x:(e[0].x+e[1].x)/2,y:(e[0].y+e[1].y)/2},x.current.vx=0,x.current.vy=0}},[a,l,c,v,N]),D=t.useCallback((e,t)=>{if(e.syntheticPan){v();const r=Math.max(.001,t??c),{dx:n,dy:s}=e.syntheticPan;return void A(a+n,l+s,r)}if(h.current.has(e.pointerId))if(e.preventDefault(),N(e),h.current.set(e.pointerId,{x:e.clientX,y:e.clientY}),2===h.current.size){const s=Array.from(h.current.values()),i=s[1].x-s[0].x,o=s[1].y-s[0].y,u=Math.hypot(i,o),m=u/(b.current.initialDistance||u),p=Math.max(r,Math.min(n,b.current.initialScale*m)),f=e.currentTarget,g=f?.getBoundingClientRect?.(),y=(s[0].x+s[1].x)/2,v=(s[0].y+s[1].y)/2,w=g?y-g.left:0,j=g?v-g.top:0,k=g?w-g.width/2:0,N=g?j-g.height/2:0,S=c,C=Math.max(.001,t??S),M=Math.max(.001,C*(p/Math.max(.001,S))),I=k*(1/M-1/C),T=N*(1/M-1/C);d(p),A(a+I,l+T,M,!1,g),x.current.vx=0,x.current.vy=0}else if(1===h.current.size&&f.current){const r=Math.max(.001,t??c),n="undefined"!=typeof performance?performance.now():Date.now(),s=g.current,a=Math.max(1,n-s.t),i=(e.clientX-f.current.x)/r,l=(e.clientY-f.current.y)/r,o=j.current.x,d=j.current.y;A(f.current.panX+i,f.current.panY+l,r);const u=(j.current.x-o)/a,m=(j.current.y-d)/a,p=x.current,h=.25;p.vx=(1-h)*p.vx+h*u,p.vy=(1-h)*p.vy+h*m,g.current={x:e.clientX,y:e.clientY,t:n}}},[c,r,n,v,A,N,a,l]),F=t.useCallback((e,t)=>{if(h.current.delete(e.pointerId),h.current.size<1){const e=x.current,r=Math.hypot(e.vx,e.vy),n=Math.max(.001,t??(k.current||c)),[s,a]=M(j.current.x,j.current.y,n,!0),i=(e,t)=>Math.abs(e-t)<1e-4;!i(s,j.current.x)||!i(a,j.current.y)?T(s,a,n):f.current&&r>.002?I(e.vx,e.vy,n):A(s,a,n,!0),f.current=null}h.current.size<2&&(b.current.initialDistance=0)},[I,M,A,c,T]),$=t.useCallback(()=>{v(),d(e),A(0,0,e,!0)},[e,v,A]),_=t.useCallback(e=>{const t=Math.max(r,Math.min(n,e));d(t);const{x:s,y:a}=j.current;A(s,a,t)},[r,n,A]);return{panX:a,panY:l,scale:c,setScaleAbsolute:_,handleWheel:P,handlePointerDown:E,handlePointerMove:D,handlePointerUp:F,resetView:$}}const De={review:"--color-review",placeholder:"--color-placeholder",locked:"--color-status-locked",available:"--color-status-available",eligible:"--color-status-eligible",unlocked:"--color-status-unlocked"};const Fe={review:"Search",placeholder:"CircleDashed",locked:"Lock",available:"CirclePlus",eligible:"CircleCheck",unlocked:"Trophy"},$e={Lock:h,CirclePlus:f,CircleCheck:p,Trophy:m,CircleDashed:u,Search:d,Circle:c};const _e=new Map;function Ye(){_e.clear()}function qe(e,t="color"){if(_e.has(`${t}:${e}`))return _e.get(`${t}:${e}`);if("undefined"==typeof document)return null;const r=document.createElement("span");r.style.position="absolute",r.style.opacity="0",r.style.pointerEvents="none",r.className=e,document.body.appendChild(r);const n=getComputedStyle(r)[t];return document.body.removeChild(r),_e.set(`${t}:${e}`,n),n}function Le(e,t=[]){for(const r of t){const t=e.getPropertyValue(r)?.trim();if(t)return t}return null}function Re(e){return e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName}function Oe(e){const t="undefined"!=typeof document?document.documentElement:null;let r=null;try{"function"==typeof getComputedStyle&&Re(e)?r=getComputedStyle(e):t&&"function"==typeof getComputedStyle&&(r=getComputedStyle(t))}catch{r=null}return{unlocked:r&&Le(r,[De.unlocked])||"#22C55E",achievable:r&&Le(r,["--color-success","--color-achievable"])||qe("text-emerald-400")||"#20C997",available:r&&Le(r,[De.available])||"#0EA5E9",eligible:r&&Le(r,[De.eligible])||"#F59E0B",locked:r&&Le(r,[De.locked])||"#6C757D",text:r&&Le(r,["--color-text-primary","--color-foreground"])||qe("text-text-primary")||qe("text-slate-900")||"#111827",connection:r&&Le(r,["--color-connection","--color-border-muted"])||qe("text-slate-400")||"#94A3B8",border:r&&Le(r,["--color-border"])||qe("border-slate-500","borderTopColor")||"rgba(0,0,0,0.3)",accent:r&&Le(r,["--color-primary"])||qe("text-primary")||qe("text-blue-500")||"#3B82F6",review:r&&Le(r,[De.review])||"#8B5CF6",placeholder:r&&Le(r,[De.placeholder])||"#94A3B8",surface:r&&Le(r,["--color-bg-primary","--color-surface"])||"#FFFFFF"}}function Be(e){try{const t="function"==typeof getComputedStyle?getComputedStyle(Re(e)?e:document.documentElement):null,r=t?.fontFamily;return r&&r.trim().length?r:"system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"}catch{return"system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"}}function Ue(e,t,r,n=3,s="…"){if(!t)return[];const a=String(t).trim().split(/\s+/),i=[];let l="";for(let o=0;o<a.length;o++){const t=l?l+" "+a[o]:a[o];if(e.measureText(t).width<=r)l=t;else{if(i.length===n-1){let t=l||a[o];for(;e.measureText(t+s).width>r&&t.length>0;)t=t.slice(0,-1);return i.push(t+s),i}l&&i.push(l),l=a[o]}}return l&&i.push(l),i.slice(0,n)}function Ge(e,t,r,n,s,a,i,l=!1){if(!(s instanceof C||s&&"object"==typeof s))throw new Error("drawMedalNode requires a Medal instance or a plain medal-like object");const o=Oe(e?.canvas),d="function"==typeof s?.isPlaceholder?s.isPlaceholder():"placeholder"===s?.status,u=!d&&("function"==typeof s?.isUnderReview?s.isUnderReview():"under_review"===s?.status),m=a?.status||"locked",p=o[m],f=Math.max(i,.001);e.beginPath(),e.fillStyle=o.surface,e.arc(t,r,n,0,2*Math.PI),e.fill();const h=d?o.placeholder:p,b="function"==typeof e.save;if(b&&e.save(),d&&"function"==typeof e.setLineDash){const t=Math.max(1,2*f);e.setLineDash([t,1.5*t])}e.strokeStyle=h,e.lineWidth=3,e.beginPath(),e.arc(t,r,Math.max(1,n-1.5),0,2*Math.PI),e.stroke(),d&&"function"==typeof e.setLineDash&&e.setLineDash([]),b&&"function"==typeof e.restore&&e.restore();const x=$e[Fe[d?"placeholder":m]||"Circle"]||c,g=1.3*n/24;if("function"==typeof e?.save&&"function"==typeof e?.translate&&"function"==typeof e?.scale&&"function"==typeof e?.restore?(e.save(),e.translate(t,r),e.scale(g,g),e.translate(-12,-12),e.lineWidth=2,e.strokeStyle=h,e.lineCap="round",e.lineJoin="round",function(e,t){if(Array.isArray(t))for(const[r,n]of t)switch(r){case"path":{const t=n?.d;if(t&&"function"==typeof Path2D){const r=new Path2D(t);e.stroke(r)}break}case"line":{const{x1:t,y1:r,x2:s,y2:a}=n||{};[t,r,s,a].every(e=>"number"==typeof e)&&(e.beginPath(),e.moveTo(t,r),e.lineTo(s,a),e.stroke());break}case"polyline":case"polygon":{const t=(n?.points||"").trim();if(t){const n=t.split(/[\s,]+/).map(Number);if(n.length>=4){e.beginPath(),e.moveTo(n[0],n[1]);for(let t=2;t<n.length;t+=2)e.lineTo(n[t],n[t+1]);"polygon"===r&&e.closePath(),e.stroke()}}break}case"rect":{const{x:t=0,y:r=0,width:s=0,height:a=0,rx:i=0,ry:l=0}=n||{};e.beginPath(),(i||l)&&"function"==typeof e.roundRect?e.roundRect(t,r,s,a,i||l):e.rect(t,r,s,a),e.stroke();break}case"circle":{const{cx:t=0,cy:r=0,r:s=0}=n||{};e.beginPath(),e.arc(t,r,s,0,2*Math.PI),e.stroke();break}case"ellipse":{const{cx:t=0,cy:r=0,rx:s=0,ry:a=0}=n||{};"function"==typeof e.ellipse&&(e.beginPath(),e.ellipse(t,r,s,a,0,0,2*Math.PI),e.stroke());break}}}(e,x),e.restore()):(e.beginPath(),e.strokeStyle=h,e.lineWidth=Math.max(1,.15*n),e.arc(t,r,Math.max(2,.5*n),0,2*Math.PI),e.stroke()),u){const s=Math.max(3,.22*n),a=.7*n,i=.7*n;e.beginPath(),e.fillStyle=o.review,e.arc(t+a,r-i,s,0,2*Math.PI),e.fill(),e.beginPath(),e.strokeStyle=o.surface,e.lineWidth=Math.max(1,2*f),e.arc(t+a,r-i,s,0,2*Math.PI),e.stroke()}const y=("string"==typeof s?.name?s.name.trim():"")||"Medal";if((l||i>=.8)&&y){e.fillStyle=o.text,e.textAlign="center",e.textBaseline="top";const a=14,c=Math.round(1.3*a),d=Be(e.canvas);e.font=`${a}px ${d}`;const u=180,m=l||i>=1.3?3:2,p="string"==typeof s?.tierName?s.tierName.trim():"";let f;if(p){f=[(t=>{if(e.measureText(t).width<=u)return t;let r=t;for(;r.length&&e.measureText(r+"…").width>u;)r=r.slice(0,-1);return r.length?r+"…":t})(y),...Ue(e,p,u,Math.max(0,m-1))]}else f=Ue(e,y,u,m);const h=r+n+8,b=e.shadowColor,x=e.shadowBlur,g=e.shadowOffsetX,v=e.shadowOffsetY;e.shadowColor="rgba(0,0,0,0.2)",e.shadowBlur=2,e.shadowOffsetX=0,e.shadowOffsetY=1;for(let r=0;r<f.length;r++)e.fillText(f[r],t,h+r*c);e.shadowColor=b,e.shadowBlur=x,e.shadowOffsetX=g,e.shadowOffsetY=v}}function Ve(){return{render:t.useCallback((e,t,r,n,s,a,i,l,o)=>{if(!r||!t||!n)return;const c=new Map((r.medals||[]).map(e=>[e.medalId,e]));r.connections?.forEach(t=>{const r=c.get(t.from),n=c.get(t.to);if(!r||!n)return;const l=(r.x+s)*i+e.canvas.width/2,o=(r.y+a)*i+e.canvas.height/2,d=(n.x+s)*i+e.canvas.width/2,u=(n.y+a)*i+e.canvas.height/2;!function(e,t,r,n,s,a="prerequisite",i,l){const o=Oe(e?.canvas);e.strokeStyle=o.connection,e.lineWidth=2,e.beginPath(),e.moveTo(t,r),e.lineTo(n,s),e.stroke();const c=Math.atan2(s-r,n-t);if(e.beginPath(),e.moveTo(n,s),e.lineTo(n-10*Math.cos(c-Math.PI/6),s-10*Math.sin(c-Math.PI/6)),e.lineTo(n-10*Math.cos(c+Math.PI/6),s-10*Math.sin(c+Math.PI/6)),e.closePath(),e.fillStyle=o.connection,e.fill(),l&&i>=.8){const a=Oe(e?.canvas),i=n-t,o=s-r,c=Math.hypot(i,o)||1,d=12,u=(t+n)/2+-o/c*d,m=(r+s)/2+i/c*d,p=12,f=6,h=4,b=Be(e.canvas);e.font=`${p}px ${b}`;const x=(e.measureText(l)?.width||0)+2*f,g=p+2*h,y=u-x/2,v=m-g/2,w=6,j=e.globalAlpha;e.globalAlpha=.12,e.fillStyle=a.accent,e.beginPath(),"function"==typeof e.arcTo?(e.moveTo(y+w,v),e.arcTo(y+x,v,y+x,v+g,w),e.arcTo(y+x,v+g,y,v+g,w),e.arcTo(y,v+g,y,v,w),e.arcTo(y,v,y+x,v,w)):e.rect(y,v,x,g),e.closePath(),e.fill(),e.globalAlpha=j,e.strokeStyle=a.accent,e.lineWidth=1.5,e.beginPath(),"function"==typeof e.arcTo?(e.moveTo(y+w,v),e.arcTo(y+x,v,y+x,v+g,w),e.arcTo(y+x,v+g,y,v+g,w),e.arcTo(y,v+g,y,v,w),e.arcTo(y,v,y+x,v,w)):e.rect(y,v,x,g),e.closePath(),e.stroke(),e.fillStyle=a.text,e.textAlign="center",e.textBaseline="middle","function"==typeof e.fillText&&e.fillText(l,u,m)}}(e,l,o,d,u,t.type,i,t.label)}),Array.isArray(t)&&t.forEach(t=>{const r=c.get(t.id);if(!r)return;const d=(r.x+s)*i+e.canvas.width/2,u=(r.y+a)*i+e.canvas.height/2,m=r.radius*i,p=n.unlocked.find(e=>e.medalId===t.id)||n.eligible.find(e=>e.medalId===t.id)||n.available.find(e=>e.medalId===t.id)||{status:"locked"};if(l===t.id){const t=Oe(e.canvas);e.strokeStyle=t.accent,e.lineWidth=Math.max(2,4/Math.max(i,.001)),e.beginPath(),e.arc(d,u,m+6,0,2*Math.PI),e.stroke()}const f=l===t.id||o===t.id;Ge(e,d,u,m,t,p,i,f)})},[])}}function Ke({status:e,className:t="w-4 h-4"}){const n=Fe[e]||"Circle",s=function(e){return De[e]||null}(e);return r.jsx(me,{name:n,className:t,style:s?{color:`var(${s})`}:void 0,"aria-hidden":"true",focusable:"false"})}function ze({className:e="",id:t,variant:n="list"}){return r.jsxs("div",{id:t,className:["flex flex-wrap items-center gap-x-4 gap-y-2 text-xs text-muted-foreground w-full min-w-0",e].join(" "),children:[r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(Ke,{status:"review"}),r.jsx("span",{children:"Under granskning"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(Ke,{status:"placeholder"}),r.jsx("span",{children:"Platshållare"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(Ke,{status:"locked"}),r.jsx("span",{children:"Låst"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(Ke,{status:"available"}),r.jsx("span",{children:"Tillgänglig"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(Ke,{status:"eligible"}),r.jsx("span",{children:"Kvalificerad"})]}),r.jsxs("span",{className:"inline-flex items-center gap-2 whitespace-nowrap",children:[r.jsx(Ke,{status:"unlocked"}),r.jsx("span",{children:"Upplåst"})]})]})}function We({open:e,title:n="Bekräfta",description:s="",confirmLabel:a="OK",cancelLabel:i="Avbryt",onConfirm:l,onCancel:o,variant:c="danger",id:d="confirm-dialog"}){const u=t.useRef(null),m=t.useRef(null),p=t.useRef(null),f=`${d}-title`,h=`${d}-desc`;if(t.useEffect(()=>{if(!e)return;p.current=document.activeElement;const t=m.current;if(!t)return;const r=()=>t.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),n=r()[0];n?.focus();const s=e=>{if("Escape"===e.key)e.preventDefault(),o?.();else if("Tab"===e.key){const t=r();if(0===t.length)return;const n=t[0],s=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),s?.focus()):e.shiftKey||document.activeElement!==s||(e.preventDefault(),n?.focus())}},a=e=>{e.target===u.current&&o?.()};document.addEventListener("keydown",s);const i=u.current;return i?.addEventListener("pointerdown",a,{capture:!0}),()=>{document.removeEventListener("keydown",s),i?.removeEventListener("pointerdown",a,{capture:!0});const e=p.current;e&&"function"==typeof e.focus&&e.focus()}},[e,o]),!e)return null;const x="danger"===c?"btn btn-danger min-h-[44px]":"btn btn-primary min-h-[44px]",g=r.jsx("div",{ref:u,className:"fixed inset-0 z-[80] bg-black/40 backdrop-blur-[1px] flex items-end sm:items-center justify-center p-3 safe-bottom",children:r.jsxs("div",{ref:m,role:"dialog","aria-modal":"true","aria-labelledby":f,"aria-describedby":h,className:"w-full sm:w-[28rem] max-w-[92vw] rounded-lg border border-border bg-background shadow-xl p-4",children:[r.jsx("h2",{id:f,className:"text-base font-semibold mb-1 text-foreground",children:n}),s?r.jsx("p",{id:h,className:"text-sm text-muted-foreground mb-4",children:s}):null,r.jsxs("div",{className:"flex flex-row-reverse flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:x,onClick:l,children:a}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:o,children:i})]})]})});return"undefined"==typeof document?g:b.createPortal(g,document.body)}const He="columns",Xe=new Map;function Je(e){if(!e||"object"!=typeof e)throw new Error("registerLayout: def must be an object");const{id:t,generator:r}=e;if(!t||"string"!=typeof t)throw new Error("registerLayout: def.id must be a non-empty string");if("function"!=typeof r)throw new Error(`registerLayout: def.generator must be a function (id: ${t})`);if(Xe.has(t))throw new Error(`registerLayout: layout id already registered: ${t}`);Xe.set(t,e)}function Ze(e){const t=new Map(e.map(e=>[e.id,e])),r={};e.forEach(e=>{r[e.type]||(r[e.type]=[]),r[e.type].push(e)});const n=Object.keys(r),s={medals:[],connections:[]};return n.forEach((e,n)=>{(r[e]||[]).forEach((e,r)=>{const a={medalId:e.id,type:e.type,x:200*n,y:140*r,radius:20,yearsRequired:0};s.medals.push(a);let i=0;const l=Array.isArray(e.requirements)&&e.requirements.find(e=>e&&"sustained_achievement"===e.type&&Number.isFinite(e.yearsOfAchievement))?.yearsOfAchievement||0;Array.isArray(e.prerequisites)&&e.prerequisites.forEach(r=>{if(r&&"medal"===r.type&&r.medalId){const n=t.get(r.medalId),a=n&&n.type===e.type;let o=0;Number.isFinite(r.yearOffset)&&r.yearOffset>0?o=r.yearOffset:a&&"number"==typeof l&&l>1&&(o=l),o>i&&(i=o),s.connections.push({from:r.medalId,to:e.id,type:"prerequisite"})}}),a.yearsRequired=i})}),function(e){const t=5,r=100;for(let n=0;n<t;n++)for(let t=0;t<e.medals.length;t++)for(let n=t+1;n<e.medals.length;n++){const s=e.medals[t],a=e.medals[n],i=a.x-s.x,l=a.y-s.y,o=Math.sqrt(i*i+l*l)||1,c=r/(o*o),d=i/o*c*.1,u=l/o*c*.1;s.x-=d,s.y-=u,a.x+=d,a.y+=u}return e}(s)}function Qe(e){const t=Array.isArray(e?.requirements)?e.requirements:[];let r=0;for(const n of t){const e=n&&"sustained_achievement"===n.type&&Number.isFinite(n.yearsOfAchievement)?n.yearsOfAchievement:0;e>r&&(r=e)}return r}const et={id:"timeline",label:"Tidslinje",description:"Lanes per typ. X visar minsta ackumulerade år mellan förkunskaper (yearOffset).",defaultOptions:{yearWidth:220,laneHeight:260,rowHeight:130,radius:22},generator:(e,t={})=>{const r={...et.defaultOptions,...t||{}},n=r.yearWidth,s=r.laneHeight,a=r.rowHeight,i=r.radius,l=Array.isArray(e)?e:[],o=new Map(l.map(e=>[e.id,e])),c=new Map(l.map(e=>[e.id,Qe(e)])),d=new Map,u=new Map,m=new Map,p=[],f=(e,t,r)=>(e.has(t)||e.set(t,r),e.get(t));for(const N of l)m.set(N.id,0),f(d,N.id,[]),f(u,N.id,[]);for(const N of l){const e=Array.isArray(N?.prerequisites)?N.prerequisites:[];for(const t of e){if(!t||"medal"!==t.type||!t.medalId)continue;if(!o.has(t.medalId))continue;const e=Number.isFinite(t.yearOffset)&&t.yearOffset>0?t.yearOffset:0;d.get(N.id).push({from:t.medalId,cost:e}),u.get(t.medalId).push(N.id),m.set(N.id,(m.get(N.id)||0)+1),p.push({from:t.medalId,to:N.id,type:"prerequisite",label:e>0?`${e} år`:void 0})}}const h=new Map(l.map(e=>[e.id,0])),b=new Map(l.map(e=>[e.id,0])),x=[];for(const N of l)0===(m.get(N.id)||0)&&(b.set(N.id,c.get(N.id)||0),x.push(N.id));for(;x.length;){const e=x.shift(),t=u.get(e)||[];for(const r of t){const t=(d.get(r)||[]).find(t=>t.from===e),n=t?.cost||0,s=(b.get(e)||0)+n;(h.get(r)||0)<s&&h.set(r,s),m.set(r,(m.get(r)||0)-1),0===(m.get(r)||0)&&(b.set(r,(h.get(r)||0)+(c.get(r)||0)),x.push(r))}}const g=(y=l.map(e=>e?.type||"unknown"),Array.from(new Set(y))).sort((e,t)=>String(e).localeCompare(String(t)));var y;const v=new Map(g.map((e,t)=>[e,t])),w=[],j=[],k=new Map;for(const N of l){const e=N?.type||"unknown";if(!k.has(e)){const t=N&&"string"==typeof N.typeName?N.typeName.trim():"";k.set(e,t.length?t:e)}}for(const N of g){const e=(v.get(N)||0)*s,t=k.get(N)??N;j.push({type:N,y:e,label:t});const r=l.filter(e=>(e?.type||"unknown")===N),o=new Map;for(const n of r){const e=b.get(n.id)||0;o.has(e)||o.set(e,[]),o.get(e).push(n)}const c=Array.from(o.keys()).sort((e,t)=>e-t);for(const s of c){const t=o.get(s)||[];t.sort((e,t)=>String(e.id).localeCompare(String(t.id)));for(let r=0;r<t.length;r++){const l=t[r],o=(d.get(l.id)||[]).reduce((e,t)=>Math.max(e,t.cost||0),0);w.push({medalId:l.id,type:l.type,x:s*n,y:e+r*a,radius:i,yearsRequired:o})}}}return{medals:w,connections:p,meta:{kind:"timeline",yearWidth:n,laneHeight:s,rowHeight:a,lanes:j}}}};Je({id:"columns",label:"Standard (kolumner)",description:"Grupperar märken efter typ i kolumner.",generator:e=>Ze(e)}),Je(et);const tt="skilltree:layoutPreset";function rt(){const[e,r]=t.useState(()=>function(){if("undefined"==typeof window)return null;try{const e=window.localStorage.getItem(tt);return e&&e.length?e:null}catch{return null}}()||He);return{presetId:e,setPresetId:t.useCallback(e=>{const t=e||He;r(t),function(e){if("undefined"!=typeof window)try{e&&window.localStorage.setItem(tt,e)}catch{}}(t)},[])}}function nt(e){const{medalDatabase:r}=K(),n=t.useMemo(()=>{return t=e||He,Xe.has(t)?Xe.get(t):Xe.get(He)||null;var t},[e]),s=t.useMemo(()=>r?.getAllMedals?.()||[],[r]);return{layout:t.useMemo(()=>n&&s&&0!==s.length?n.generator(s,n.defaultOptions):null,[n,s]),preset:n}}function st({legendDescribedById:e}){const n=t.useRef(null),{medalDatabase:s}=K(),l=H(),{render:o}=Ve(),[c,d]=t.useState(null),[u,m]=t.useState(null),[p,f]=t.useState([]),h=i(),b=a(),g=b.pathname.endsWith("/skill-tree/fullscreen"),y=t.useRef(null),{presetId:v,setPresetId:w}=rt(),{layout:j}=nt(v),k=24,[N,S]=t.useState(!0),[C,M]=t.useState(N?72:0),[A,I]=t.useState({w:0,h:0}),T=t.useCallback(()=>{if(!j||!j.medals?.length)return{minX:0,minY:0,maxX:0,maxY:0};let e=1/0,t=1/0,r=-1/0,n=-1/0;for(let s=0;s<j.medals.length;s++){const a=j.medals[s],i=a.radius||20;a.x-i<e&&(e=a.x-i),a.y-i<t&&(t=a.y-i),a.x+i>r&&(r=a.x+i),a.y+i>n&&(n=a.y+i)}return{minX:e,minY:t,maxX:r,maxY:n}},[j]),P=t.useCallback((e,t=24,r=0)=>{if(!j||!e)return{baseScale:1,minX:0,minY:0};const n=e.width,s=e.height;if(!n||!s)return{baseScale:1,minX:0,minY:0};const a=j.medals||[];if(!a.length)return{baseScale:1,minX:0,minY:0};let i=1/0,l=1/0,o=-1/0,c=-1/0;for(let h=0;h<a.length;h++){const e=a[h],t=e.radius||20;e.x-t<i&&(i=e.x-t),e.y-t<l&&(l=e.y-t),e.x+t>o&&(o=e.x+t),e.y+t>c&&(c=e.y+t)}const d=Math.max(1,o-i),u=Math.max(1,c-l),m=(n-2*t)/d,p=(s-2*t-Math.max(0,r))/u,f="timeline"===j?.meta?.kind;return{baseScale:Math.max(.001,f?p:Math.min(m,p)),minX:i,minY:l}},[j]),E=1.2,D=x.useCallback(()=>"timeline"===j?.meta?.kind?{min:.2,max:1.5}:{min:.5,max:1.5},[j]),F=t.useCallback(()=>{const{min:e,max:t}=D(),r=A.w,n=A.h;if(!j||!r||!n)return{min:e,max:t};const s={width:r,height:n},{baseScale:a}=P(s,k,C),i=Math.max(.001,a),l=Math.max(.001,e/i);return{min:l,max:Math.max(l,t/i)}},[A,j,D,P,C]),{min:$,max:_}=F(),{panX:Y,panY:q,scale:L,setScaleAbsolute:R,handleWheel:O,handlePointerDown:B,handlePointerMove:U,handlePointerUp:G,resetView:V}=Ee(6,$,_,{getBounds:T,overscrollPx:48,contentPaddingPx:{left:104,top:k+C,right:104,bottom:80}}),[W,X]=t.useState(!1),J=t.useRef(null),Z=t.useRef(null),Q=t.useRef(!1),ee=t.useRef(L);t.useEffect(()=>{ee.current=L},[L]);const[te,re]=t.useState(!1),[ne,se]=t.useState(!0),[ae,ie]=t.useState(!1),le=e||"skilltree-legend",oe=t.useRef(null),ce=t.useRef(null),de=t.useRef(null),pe=t.useRef(null),fe=g?"fullscreen-actions-menu":"canvas-actions-menu",{currentProfile:he,startExplorerMode:be,hydrated:xe,resetCurrentProfileData:ge}=z(),ye=Boolean(he?.isGuest),ve=!xe||void 0===he,[we,je]=t.useState(!1),[ke,Ne]=t.useState(!1),[Se,Ce]=t.useState(!1),Me=(()=>{try{return window.localStorage.getItem("app:onboardingChoice")}catch{return null}})(),Ae=g&&!ve&&!he&&!Me&&!we,Ie=t.useCallback((e,t=24)=>{const{baseScale:r,minX:n,minY:s}=P(e,t,C),a=e?.width||0,i=e?.height||0,l=Math.max(.001,r*L),o=80/l,c=Math.max(0,C)/l;return{effScale:l,effPanX:Y+((t-a/2)/l-(n-o)),effPanY:q+((t-i/2)/l-(s-c)),baseScale:r}},[P,Y,q,L,C]),Te=t.useCallback((e,t=120)=>{if(!j||!e)return[];const r=e.width,n=e.height,s=j.medals||[],{effScale:a,effPanX:i,effPanY:l}=Ie(e),o=[];for(let c=0;c<s.length;c++){const e=s[c],d=(e.x+i)*a+r/2,u=(e.y+l)*a+n/2,m=(e.radius||20)*a;d+m>=-t&&d-m<=r+t&&u+m>=-t&&u-m<=n+t&&o.push(e)}return o},[j,Ie]),Pe=t.useCallback(e=>{if(!e||!j)return[];if(!ne)return[];const{effScale:t,effPanX:r,effPanY:n}=Ie(e),s=e.width,a=e.height,i=Te(e),o=[],d=e=>u===e||c===e||t>=.8,m=new Map;for(const l of j.medals||[])m.set(l.medalId,l);const p=Math.max(16,12),f=e=>({x:(e.x+r)*t+s/2,y:(e.y+n)*t+a/2,r:(e.radius||20)*t});for(const c of i){const e=c.yearsRequired||0;if(!e||!d(c.medalId))continue;const t=f(c);let r=t.x,n=t.y-(t.r+8+10);const s=(j.connections||[]).find(e=>e.to===c.medalId);if(s){const e=m.get(s.from);if(e){const s=f(e),a=t.x-s.x,i=t.y-s.y,l=Math.hypot(a,i)||1,o=-(i/l),c=a/l,d=r-s.x,u=n-s.y,m=Math.hypot(d,u)||1,p=s.r+Math.max(56,20)/2+6;if(m<p){const e=p-m;r+=o*e,n+=c*e}}}const a=r-t.x,i=n-t.y,u=Math.hypot(a,i)||1,h=t.r+p;if(u<h){const e=a/u,s=i/u;r=t.x+e*h,n=t.y+s*h}const b=l?.[c.medalId]?.status,x="achievable"===b||"unlocked"===b?"ready":"neutral",g=`${e} år`;o.push({id:c.medalId,left:r,top:n,text:g,variant:x,w:56,h:20})}return o},[j,Ie,Te,u,c,l,ne]),De=t.useCallback(()=>{if(!n.current||!j||!s)return;const e=n.current,t=e.getContext("2d"),r=e.getBoundingClientRect();e.width===Math.floor(r.width)&&e.height===Math.floor(r.height)||(e.width=Math.floor(r.width),e.height=Math.floor(r.height),I({w:e.width,h:e.height}));const a=getComputedStyle(e).backgroundColor||"#fcfcf9";t.fillStyle=a,t.fillRect(0,0,e.width,e.height);const i=s.getAllMedals(),d=Te(e),m=new Set(d.map(e=>e.medalId)),p=i.filter(e=>m.has(e.id)),{effScale:f,effPanX:h,effPanY:b}=Ie(e);if("timeline"===j?.meta?.kind){const r=Oe(e)||{},n=e.width,s=e.height,a=-n/2/f-h,i=n/2/f-h,l=Number(j.meta.yearWidth)||220,o=Math.floor(a/l),c=Math.ceil(i/l),d=r.connection||"rgba(0,0,0,0.3)",u=r.text||"#111827",m=Math.max(12,N?C+12:12);t.save(),t.lineWidth=1,t.strokeStyle=d,t.globalAlpha=.25;for(let e=o;e<=c;e++){const r=(e*l+h)*f+n/2;t.beginPath(),t.moveTo(r,0),t.lineTo(r,s),t.stroke(),t.globalAlpha=.8,t.fillStyle=u,t.textAlign="center",t.textBaseline="top",t.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif",t.fillText(`${e} år`,r,m),t.globalAlpha=.25}t.restore();const p=Array.isArray(j.meta.lanes)?j.meta.lanes:[];if(p.length){t.save(),t.fillStyle=u,t.textAlign="left",t.textBaseline="middle",t.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif";for(const e of p){const r=(e.y+b)*f+s/2;r<-24||r>s+24||t.fillText(String(e.label||e.type||""),8,r)}t.restore()}}o(t,p,j,l,h,b,f,c,u)},[Te,Ie,j,s,l,c,o,u,C,N]),Fe=t.useCallback(()=>{const e=n.current;if(!e||!j)return;const{baseScale:t}=P(e,k,C),{min:r,max:s}=D(),a="timeline"===j?.meta?.kind?.9:.8,i=Math.min(s,Math.max(r,a))/Math.max(.001,t);V(),R(i)},[P,j,V,R,C,D]),$e=(e,t,r)=>Math.min(r,Math.max(t,e)),_e=t.useCallback(()=>{R($e(ee.current*E,$,_))},[R,$,_,E]),qe=t.useCallback(()=>{R($e(ee.current/E,$,_))},[R,$,_,E]),Le=t.useCallback(()=>{S(e=>{const t=!e;return t||M(0),t})},[M,S]),Re=t.useCallback(()=>{const e=b.state?.backgroundLocation;if(e&&"object"==typeof e){const t={pathname:e.pathname,search:e.search,hash:e.hash};return void h(t,{replace:!0,state:{...e.state||{},fromFullscreenClose:!0}})}if("string"==typeof e)return void h(e,{replace:!0,state:{fromFullscreenClose:!0}});const t=b.pathname.replace(/\/fullscreen$/,"");h(t||"/skill-tree",{replace:!0,state:{fromFullscreenClose:!0}})},[b,h]),Be=t.useCallback(e=>{n.current=e},[]);t.useLayoutEffect(()=>{if(!N)return;const e=g?pe.current:de.current;if(!e)return;let t=requestAnimationFrame(()=>{const t=e.getBoundingClientRect();M(Math.max(0,Math.ceil(t.height)))});return()=>cancelAnimationFrame(t)},[N,g]),t.useEffect(()=>{let e=requestAnimationFrame(De);return()=>cancelAnimationFrame(e)},[De]),t.useLayoutEffect(()=>{const e=n.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),s=Math.floor(t.height);r>0&&s>0&&(e.width!==r||e.height!==s)&&(e.width=r,e.height=s,I({w:r,h:s})),f(Pe(e))},[Pe,Y,q,L,u,c,j]),t.useEffect(()=>{Q.current||n.current&&j&&(Q.current=!0,Fe())},[j,Fe]),t.useEffect(()=>{const e=()=>{const e=n.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),s=Math.floor(t.height);if(r>0&&s>0&&(e.width!==r||e.height!==s)&&(e.width=r,e.height=s,I({w:r,h:s})),De(),f(Pe(e)),N){const e=g?pe.current:de.current;if(e){const t=e.getBoundingClientRect();M(Math.max(0,Math.ceil(t.height)))}}};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[De,Pe,g,N]),t.useEffect(()=>{const e=n.current;if(!e)return;const t=t=>{const{effScale:r}=Ie(e);O(t,r)};return e.addEventListener("wheel",t,{passive:!1}),()=>{e.removeEventListener("wheel",t,{passive:!1})}},[Ie,O,g]),t.useEffect(()=>{if(!g)return;Z.current=document.activeElement;const e=document.documentElement,t=e.style.overflow;e.style.overflow="hidden",oe.current?.focus?.();const r=e=>{if("Escape"!==e.key)return;if(te||ae)return;const t=document.activeElement;y.current&&y.current.contains(t)&&Re()};return window.addEventListener("keydown",r),()=>{window.removeEventListener("keydown",r),e.style.overflow=t;const n=Z.current;n&&"function"==typeof n.focus&&n.focus()}},[g,te,ae,Re]),t.useEffect(()=>{if(!te)return;const e=e=>{const t=ce.current,r=oe.current;t&&r&&(t.contains(e.target)||r.contains(e.target)||re(!1))};return window.addEventListener("pointerdown",e,{capture:!0}),()=>window.removeEventListener("pointerdown",e,{capture:!0})},[te]),t.useEffect(()=>{n.current&&requestAnimationFrame(()=>{De()})},[g,De]),t.useEffect(()=>{const e=()=>{requestAnimationFrame(()=>{Ye();const e=n.current;e&&(De(),f(Pe(e)))})},t="undefined"!=typeof window&&window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)"):null;t&&"function"==typeof t.addEventListener&&t.addEventListener("change",e);const r=new MutationObserver(t=>{for(const r of t)if("attributes"===r.type&&"class"===r.attributeName){e();break}});return"undefined"!=typeof document&&document.documentElement&&r.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>{t&&"function"==typeof t.removeEventListener&&t.removeEventListener("change",e),r.disconnect()}},[De,Pe]),t.useEffect(()=>{const e=()=>{requestAnimationFrame(()=>{const e=n.current;if(!e)return;const t=e.getBoundingClientRect(),r=Math.floor(t.width),s=Math.floor(t.height);r>0&&s>0&&(e.width!==r||e.height!==s)&&(e.width=r,e.height=s,I({w:r,h:s})),Ye(),De(),f(Pe(e))})},t=t=>{e()},r=()=>{"undefined"!=typeof document&&"visible"===document.visibilityState&&e()},s=()=>{e()};return window.addEventListener("pageshow",t),document.addEventListener("visibilitychange",r),window.addEventListener("orientationchange",s),()=>{window.removeEventListener("pageshow",t),document.removeEventListener("visibilitychange",r),window.removeEventListener("orientationchange",s)}},[De,Pe]);const Ue=t.useCallback(e=>{const{effScale:t}=Ie(n.current),r=50/Math.max(t,.001);["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","+","=","-","0"].includes(e.key)&&e.preventDefault(),"ArrowLeft"===e.key?U({syntheticPan:{dx:-r,dy:0}},t):"ArrowRight"===e.key?U({syntheticPan:{dx:r,dy:0}},t):"ArrowUp"===e.key?U({syntheticPan:{dx:0,dy:-r}},t):"ArrowDown"===e.key?U({syntheticPan:{dx:0,dy:r}},t):"+"===e.key||"="===e.key?_e():"-"===e.key?qe():"0"===e.key&&Fe()},[Ie,U,Fe,_e,qe]),Ge=e=>{X(!0),B(e)},Ke=e=>{if(W){const{effScale:t}=Ie(n.current);return U(e,t),void(n.current&&(n.current.style.cursor="grabbing"))}if(!n.current||!j)return;const t=n.current.getBoundingClientRect(),r=e.clientX-t.left,s=e.clientY-t.top,{effScale:a,effPanX:i,effPanY:l}=Ie(n.current),o=Te(n.current);for(const c of o){const e=(c.x+i)*a+n.current.width/2,t=(c.y+l)*a+n.current.height/2,o=(c.radius||20)*a,d=Math.max(o,24),u=r-e,p=s-t;if(u*u+p*p<d*d)return m(c.medalId),void(n.current.style.cursor="pointer")}m(null),n.current.style.cursor="grab"},He=e=>{X(!1);const t=n.current,{effScale:r}=t?Ie(t):{effScale:ee.current};G(e,r),m(null)},Xe=e=>{if(!n.current||!j)return;const t=n.current.getBoundingClientRect(),r=e.clientX-t.left,s=e.clientY-t.top,{effScale:a,effPanX:i,effPanY:l}=Ie(n.current),o=Te(n.current);for(const c of o){const e=(c.x+i)*a+n.current.width/2,t=(c.y+l)*a+n.current.height/2,o=(c.radius||20)*a,u=Math.max(o,24),m=r-e,p=s-t;if(m*m+p*p<u*u)return d(c.medalId),void h(`/medals/${c.medalId}`,{state:{backgroundLocation:b}})}d(null)},Je=e=>{if(!n.current||!j)return;const t=n.current.getBoundingClientRect(),r=e.clientX-t.left,s=e.clientY-t.top,{effScale:a,effPanX:i,effPanY:l}=Ie(n.current),o=Te(n.current);for(const c of o){const e=(c.x+i)*a+n.current.width/2,t=(c.y+l)*a+n.current.height/2,o=(c.radius||20)*a,u=Math.max(o,24),m=r-e,p=s-t;if(m*m+p*p<u*u)return window.dispatchEvent(new CustomEvent("openAchievementForm",{detail:{medalId:c.medalId}})),d(c.medalId),void h(`/medals/${c.medalId}`,{state:{backgroundLocation:b}})}},Ze=()=>{n.current&&function(e,t="skill-tree.png"){try{const r=document.createElement("a");r.href=e.toDataURL("image/png"),r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r)}catch(r){window.open(e.toDataURL("image/png"),"_blank")}}(n.current,`skill-tree-${(new Date).toISOString().split("T")[0]}.png`)};return s?r.jsxs("div",{className:"space-y-4",children:[r.jsx("div",{className:"card overflow-hidden overscroll-contain mt-2",role:"region","aria-label":"Trädvy canvas","aria-describedby":["skilltree-help",le].filter(Boolean).join(" "),children:!g&&r.jsxs("div",{className:"relative",children:[r.jsx("canvas",{ref:Be,role:"img","aria-label":"Interaktiv träd-vy-canvas","aria-describedby":["skilltree-help",N?le:null,e].filter(Boolean).join(" "),"aria-keyshortcuts":"ArrowLeft ArrowRight ArrowUp ArrowDown = + - 0",tabIndex:0,onKeyDown:Ue,className:"w-full h-[60vh] sm:h-[600px] bg-background cursor-grab active:cursor-grabbing touch-none overscroll-contain select-none",onContextMenu:e=>e.preventDefault(),onPointerDown:Ge,onPointerMove:Ke,onPointerUp:He,onPointerLeave:He,onPointerCancel:He,onClick:Xe,onDoubleClick:Je}),r.jsx("div",{className:"pointer-events-none absolute inset-0",children:p.map(e=>r.jsxs(x.Fragment,{children:[r.jsx("span",{"aria-hidden":"true",style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,borderRadius:"9999px",background:"var(--color-background, #fff)",boxShadow:"0 0 0 3px var(--color-background, #fff)",zIndex:0}}),r.jsx("span",{role:"note","aria-label":`Kräver ${e.text}`,title:`Kräver ${e.text}`,className:["inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium shadow-sm","ready"===e.variant?"bg-primary text-white border-primary":"bg-primary/10 dark:bg-primary/20 text-foreground border-primary"].join(" "),style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,whiteSpace:"nowrap",zIndex:1},children:r.jsx("span",{"aria-hidden":"true",children:e.text})})]},e.id))}),N&&r.jsx("div",{ref:de,className:"absolute left-3 right-3 top-3 sm:left-4 sm:right-auto sm:top-4 z-[40] overflow-x-auto whitespace-nowrap rounded-md border border-border/60 bg-background/80 backdrop-blur-sm shadow-md px-3 py-1.5",style:{marginTop:"env(safe-area-inset-top)"},role:"note",id:le,children:r.jsx(ze,{variant:"canvas"})}),r.jsx("div",{className:"absolute right-3 bottom-3 sm:right-4 sm:bottom-4 z-30",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"relative",children:[r.jsx("button",{type:"button",ref:oe,"aria-haspopup":"menu","aria-controls":fe,"aria-expanded":te,onClick:()=>re(e=>!e),className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Visa åtgärder","aria-label":"Visa åtgärder",children:r.jsx(me,{name:"MoreVertical",className:"w-6 h-6"})}),te&&r.jsxs("div",{id:fe,ref:ce,role:"menu","aria-label":"Åtgärder",className:"absolute right-0 bottom-14 sm:bottom-16 w-56 rounded-md border border-border bg-background shadow-xl overflow-hidden",onKeyDown:e=>{if("Escape"===e.key)e.preventDefault(),re(!1),oe.current?.focus();else if("ArrowDown"===e.key||"ArrowUp"===e.key){const t=Array.from(e.currentTarget.querySelectorAll('[role="menuitem"]'));if(0===t.length)return;const r=t.indexOf(document.activeElement);let n=0;"ArrowDown"===e.key&&(n=r>=0?(r+1)%t.length:0),"ArrowUp"===e.key&&(n=r>=0?(r-1+t.length)%t.length:t.length-1),e.preventDefault(),t[n]?.focus()}},children:[r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),Fe()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Återställ vy"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),Ze()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Exportera som PNG"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),Le()},"aria-pressed":N,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:N?"Dölj teckenförklaring":"Visa teckenförklaring"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),se(e=>!e)},"aria-pressed":ne,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:ne?"Dölj årsbrickor":"Visa årsbrickor"}),r.jsxs("div",{role:"group","aria-label":"Visualisering",className:"border-t border-border/60",children:[r.jsx("button",{role:"menuitemradio","aria-checked":"columns"===v,type:"button",onClick:()=>{re(!1),w("columns"),Fe()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Standard (kolumner)"}),r.jsx("button",{role:"menuitemradio","aria-checked":"timeline"===v,type:"button",onClick:()=>{re(!1),w("timeline"),Fe()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Tidslinje"})]}),(!he||ye)&&r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),Ne(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Spara"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),ie(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visa hjälp"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),h("/skill-tree/fullscreen",{replace:!0,state:{backgroundLocation:b}})},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","aria-haspopup":"dialog","aria-controls":"skilltree-fullscreen",children:"Öppna helskärm"})]})]})}),r.jsx("div",{className:"absolute left-3 bottom-3 sm:left-4 sm:bottom-4 z-30",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"inline-flex flex-col gap-2",children:[r.jsx("button",{type:"button","aria-label":"Zooma in",onClick:_e,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma in",children:r.jsx(me,{name:"Plus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Zooma ut",onClick:qe,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma ut",children:r.jsx(me,{name:"Minus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Återställ vy",onClick:Fe,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Återställ vy",children:r.jsx(me,{name:"RotateCcw",className:"w-6 h-6"})})]})}),r.jsx("p",{id:"skilltree-help",className:"sr-only",children:"💡 Dra för att panorera • Nyp för att zooma • Klicka på märken för detaljer"}),ae&&r.jsx("div",{role:"dialog","aria-modal":"false","aria-labelledby":"skilltree-help-title",className:"absolute left-1/2 bottom-24 -translate-x-1/2 w-[min(92vw,28rem)] rounded-md border border-border bg-background text-foreground shadow-xl p-4 z-30",children:r.jsxs("div",{className:"flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsx("h3",{id:"skilltree-help-title",className:"text-sm font-semibold mb-1",children:"Hjälp"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Dra för att panorera • Nyp eller använd +/− för att zooma • 0 återställer vy • Klicka för detaljer"})]}),r.jsx("button",{type:"button","aria-label":"Stäng hjälp",className:"btn btn-muted min-h-[44px] px-3 py-2",onClick:()=>ie(!1),children:"Stäng"})]})})]})}),g&&r.jsxs("div",{id:"skilltree-fullscreen",ref:y,className:"fixed inset-0 z-50 bg-background overscroll-contain flex flex-col",role:"dialog","aria-modal":"true","aria-label":"Helskärms träd-vy",children:[r.jsx("h2",{className:"sr-only",children:"Märken"}),r.jsx("div",{className:"absolute right-3 bottom-3 sm:right-4 sm:bottom-4 z-[60]",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"relative",children:[r.jsx("button",{type:"button",ref:oe,"aria-haspopup":"menu","aria-controls":fe,"aria-expanded":te,onClick:()=>re(e=>!e),className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Visa åtgärder","aria-label":"Visa åtgärder",children:r.jsx(me,{name:"MoreVertical",className:"w-6 h-6"})}),te&&r.jsxs("div",{id:fe,ref:ce,role:"menu","aria-label":"Åtgärder",className:"absolute right-0 bottom-14 sm:bottom-16 w-56 rounded-md border border-border bg-background shadow-xl overflow-hidden",onKeyDown:e=>{if("Escape"===e.key)e.preventDefault(),re(!1),oe.current?.focus();else if("ArrowDown"===e.key||"ArrowUp"===e.key){const t=Array.from(e.currentTarget.querySelectorAll('[role="menuitem"]'));if(0===t.length)return;const r=t.indexOf(document.activeElement);let n=0;"ArrowDown"===e.key&&(n=r>=0?(r+1)%t.length:0),"ArrowUp"===e.key&&(n=r>=0?(r-1+t.length)%t.length:t.length-1),e.preventDefault(),t[n]?.focus()}},children:[r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),Fe()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Återställ vy"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),Ze()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Exportera som PNG"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),Le()},"aria-pressed":N,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:N?"Dölj teckenförklaring":"Visa teckenförklaring"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),se(e=>!e)},"aria-pressed":ne,className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:ne?"Dölj årsbrickor":"Visa årsbrickor"}),r.jsxs("div",{role:"group","aria-label":"Visualisering",className:"border-t border-border/60",children:[r.jsx("button",{role:"menuitemradio","aria-checked":"columns"===v,type:"button",onClick:()=>{re(!1),w("columns"),Fe()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Standard (kolumner)"}),r.jsx("button",{role:"menuitemradio","aria-checked":"timeline"===v,type:"button",onClick:()=>{re(!1),w("timeline"),Fe()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visualisering: Tidslinje"})]}),(!he||ye)&&r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),Ne(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Spara framsteg"}),r.jsx("button",{role:"menuitem",type:"button",onClick:()=>{re(!1),ie(!0)},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Visa hjälp"}),r.jsx("button",{role:"menuitem",type:"button",ref:J,onClick:()=>{re(!1),Re()},className:"w-full text-left px-4 py-3 min-h-[44px] text-foreground hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:"Stäng helskärm"})]})]})}),r.jsx("div",{className:"absolute left-3 bottom-3 sm:left-4 sm:bottom-4 z-[60]",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:r.jsxs("div",{className:"inline-flex flex-col gap-2",children:[r.jsx("button",{type:"button","aria-label":"Zooma in",onClick:_e,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma in",children:r.jsx(me,{name:"Plus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Zooma ut",onClick:qe,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Zooma ut",children:r.jsx(me,{name:"Minus",className:"w-6 h-6"})}),r.jsx("button",{type:"button","aria-label":"Återställ vy",onClick:Fe,className:"inline-flex items-center justify-center h-12 w-12 rounded-full bg-bg-secondary border border-border text-foreground shadow-lg hover:bg-bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",title:"Återställ vy",children:r.jsx(me,{name:"RotateCcw",className:"w-6 h-6"})})]})}),Ae&&r.jsx("div",{role:"region","aria-label":"Onboarding",className:"absolute left-3 right-3 z-[50]",style:{marginTop:"env(safe-area-inset-top)",top:Math.max(12,C+12)},children:r.jsxs("div",{className:"rounded-md border border-border bg-background/80 backdrop-blur-sm shadow-md p-3",children:[r.jsx("p",{className:"text-sm text-foreground mb-2",children:"Spara dina framsteg?"}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:()=>{try{window.localStorage.setItem("app:onboardingChoice","saved")}catch{}je(!0),Ne(!0)},children:"Skapa profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>{try{window.localStorage.setItem("app:onboardingChoice","guest")}catch{}je(!0),be()},children:"Fortsätt som gäst"}),r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:()=>je(!0),children:"Inte nu"})]})]})}),g&&ye&&!Ae&&r.jsxs("div",{className:"absolute left-1/2 -translate-x-1/2 z-[60] flex items-center gap-2",style:{bottom:"calc(env(safe-area-inset-bottom) + 16px)"},role:"group","aria-label":"Snabbåtgärder (gäst)",children:[r.jsx("button",{type:"button",onClick:()=>Ce(!0),className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 backdrop-blur-sm px-3 py-1.5 text-sm shadow-md min-h-[36px]","aria-label":"Återställ alla",title:"Återställ alla",children:"Återställ alla"}),r.jsx("button",{type:"button",onClick:()=>Ne(!0),className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 backdrop-blur-sm px-3 py-1.5 text-sm shadow-md min-h-[36px]","aria-label":"Spara framsteg",title:"Spara framsteg",children:"Spara framsteg"})]}),r.jsx("div",{className:"flex-1",children:r.jsxs("div",{className:"relative h-full",children:[r.jsx("canvas",{ref:Be,role:"img","aria-label":"Interaktiv träd-vy-canvas","aria-describedby":["skilltree-help-fs",N?"skilltree-legend-fs":null,e].filter(Boolean).join(" "),"aria-keyshortcuts":"ArrowLeft ArrowRight ArrowUp ArrowDown = + - 0",tabIndex:0,onKeyDown:Ue,className:"w-full h-full bg-background cursor-grab active:cursor-grabbing touch-none overscroll-contain select-none",onContextMenu:e=>e.preventDefault(),onPointerDown:Ge,onPointerMove:Ke,onPointerUp:He,onPointerLeave:He,onPointerCancel:He,onClick:Xe,onDoubleClick:Je}),N&&r.jsx("div",{ref:pe,className:"absolute left-3 right-3 top-3 sm:left-4 sm:right-auto sm:top-4 z-[40] overflow-x-auto whitespace-nowrap rounded-md border border-border/60 bg-background/80 backdrop-blur-sm shadow-md px-3 py-1.5",style:{marginTop:"env(safe-area-inset-top)"},role:"note",id:"skilltree-legend-fs",children:r.jsx(ze,{variant:"canvas"})}),r.jsx("div",{className:"pointer-events-none absolute inset-0",children:p.map(e=>r.jsxs(x.Fragment,{children:[r.jsx("span",{"aria-hidden":"true",style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,borderRadius:"9999px",background:"var(--color-background, #fff)",boxShadow:"0 0 0 3px var(--color-background, #fff)",zIndex:0}}),r.jsx("span",{role:"note","aria-label":`Kräver ${e.text}`,title:`Kräver ${e.text}`,className:["inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium shadow-sm","ready"===e.variant?"bg-primary text-white border-primary":"bg-primary/10 dark:bg-primary/20 text-foreground border-primary"].join(" "),style:{position:"absolute",left:`${e.left}px`,top:`${e.top}px`,transform:"translate3d(-50%, -50%, 0)",willChange:"transform",width:`${e.w}px`,height:`${e.h}px`,whiteSpace:"nowrap",zIndex:1},children:r.jsx("span",{"aria-hidden":"true",children:e.text})})]},e.id))})]})}),r.jsx("p",{id:"skilltree-help-fs",className:"sr-only",children:"💡 Dra för att panorera • Nyp för att zooma • Klicka på märken för detaljer"}),ae&&r.jsx("div",{role:"dialog","aria-modal":"false","aria-labelledby":"skilltree-help-title-fs",className:"absolute left-1/2 bottom-24 -translate-x-1/2 w-[min(92vw,28rem)] rounded-md border border-border bg-background text-foreground shadow-xl p-4 z-[70]",children:r.jsxs("div",{className:"flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsx("h3",{id:"skilltree-help-title-fs",className:"text-sm font-semibold mb-1",children:"Hjälp"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Dra för att panorera • Nyp för att zooma • Klicka för detaljer"})]}),r.jsx("button",{type:"button","aria-label":"Stäng hjälp",className:"btn btn-muted min-h-[44px] px-3 py-2",onClick:()=>ie(!1),children:"Stäng"})]})})]}),r.jsx(We,{id:"reset-confirm-skilltree",open:Se,onCancel:()=>Ce(!1),onConfirm:async()=>{Ce(!1),await ge()},title:"Återställa allt?",description:"Detta rensar alla tillfälliga framsteg (märken och förkunskaper) i gästläget. Denna åtgärd går inte att ångra.",confirmLabel:"Återställ",cancelLabel:"Avbryt",variant:"danger"}),r.jsx(ue,{id:"save-progress-picker-canvas",mode:"picker",open:ke,onClose:()=>Ne(!1),forceCreate:!0,convertGuest:!0})]}):r.jsx("div",{className:"flex items-center justify-center h-96",role:"status","aria-live":"polite","aria-busy":"true",children:r.jsx("p",{className:"text-text-secondary",children:"Laddar märken..."})})}function at(e,t){try{return window.localStorage.setItem(e,t),!0}catch{return!1}}function it({idPrefix:e="default"}){const{resetCurrentProfileData:n}=z(),[s,a]=t.useState(!1),[i,l]=t.useState(!1);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"card p-4",role:"status","aria-live":"polite",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(me,{name:"Compass",className:"w-6 h-6 shrink-0"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"mb-2 text-muted-foreground",children:"Gästläge: framsteg sparas tillfälligt."}),r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{type:"button",className:"btn btn-primary",onClick:()=>a(!0),children:[r.jsx(me,{name:"Save",className:"w-4 h-4"}),"Spara"]}),r.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>l(!0),children:[r.jsx(me,{name:"RotateCcw",className:"w-4 h-4"}),"Återställ"]})]})]})]})}),r.jsx(We,{id:`reset-confirm-${e}`,open:i,onCancel:()=>l(!1),onConfirm:async()=>{l(!1),await n()},title:"Återställa allt?",description:"Detta rensar alla tillfälliga framsteg (märken och förkunskaper) i gästläget. Denna åtgärd går inte att ångra.",confirmLabel:"Återställ",cancelLabel:"Avbryt",variant:"danger"}),r.jsx(ue,{id:`save-progress-picker-${e}`,mode:"picker",open:s,onClose:()=>a(!1),forceCreate:!0,convertGuest:!0})]})}function lt({id:e="profile-picker-inline"}){const{currentProfile:n}=z(),[s,a]=t.useState(!1);return n?null:r.jsxs("div",{className:"card p-4",role:"region","aria-label":"Profil krävs",children:[r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("div",{"aria-hidden":"true",className:"text-xl leading-none",children:"👤"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"text-foreground mb-2",children:"Välj eller skapa en profil."}),r.jsx("button",{type:"button",onClick:()=>a(!0),className:"btn btn-primary min-h-[44px]","aria-haspopup":"dialog","aria-controls":e,children:"Profil"})]})]}),r.jsx(ue,{id:e,mode:"picker",open:s,onClose:()=>a(!1)})]})}function ot({idPrefix:e="default",onChooseGuest:t,onChooseSaved:n}){const s=`onboarding-title-${e}`;return r.jsxs("div",{className:"card p-4",role:"dialog","aria-modal":"true","aria-labelledby":s,children:[r.jsx("h2",{id:s,className:"section-title mb-2",children:"Hur vill du börja?"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Utforska märken direkt eller skapa en profil för att spara ditt arbete."}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsxs("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:t,children:[r.jsx(me,{name:"Compass",className:"w-4 h-4"}),"Utforska utan att spara (Gästläge)"]}),r.jsxs("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:n,children:[r.jsx(me,{name:"UserPlus",className:"w-4 h-4"}),"Skapa profil"]})]})]})}function ct({idPrefix:e="default",promptId:n}){const{isProfileLoading:s,showOnboarding:a,isGuest:i,chooseGuest:l,chooseSaved:o}=function(){const{currentProfile:e,startExplorerMode:r,hydrated:n}=z(),[s,a]=t.useState(!1),i=t.useMemo(()=>{if("undefined"==typeof window)return null;try{return window.localStorage.getItem("app:onboardingChoice")}catch{return null}},[]),l=!n||void 0===e;return{isProfileLoading:l,showOnboarding:!(l||e||i||s),isGuest:Boolean(e?.isGuest),chooseGuest:t.useCallback(()=>{at("app:onboardingChoice","guest"),r()},[r]),chooseSaved:t.useCallback(()=>{at("app:onboardingChoice","saved"),a(!0)},[])}}();if(s)return null;if(a)return r.jsx(ot,{idPrefix:e,onChooseGuest:l,onChooseSaved:o});if(i)return r.jsx(it,{idPrefix:e});const c=n||`profile-picker-${e}`;return r.jsx(lt,{id:c})}function dt(){const{currentProfile:e,hydrated:n}=z(),s=!n||void 0===e,l=i(),o=a();return t.useEffect(()=>{if("undefined"==typeof window)return;const e=window.innerWidth<768,t="/skill-tree"===o.pathname,r=Boolean(o.state?.fromFullscreenClose);e&&t&&!r&&l("/skill-tree/fullscreen",{replace:!0,state:{backgroundLocation:o}})},[l,o]),s?null:r.jsxs("div",{className:"space-y-6",children:[r.jsx(ct,{idPrefix:"skilltree",promptId:"profile-picker-skill-tree"}),r.jsx("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:r.jsx("h1",{className:"text-3xl font-bold text-text-primary mb-1 sm:mb-0",children:"Trädvy"})}),r.jsx(st,{})]})}const ut="medal-app-current-filters";function mt(e){return(e||"").toString().toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g,"")}function pt(e,t){return t?t.unlocked?.some(t=>t.medalId===e)?"unlocked":t.eligible?.some(t=>t.medalId===e)?"eligible":t.available?.some(t=>t.medalId===e)?"available":"locked":"locked"}function ft({value:e,onChange:n,suggestions:s,onSuggestionSelect:a,placeholder:i="Search medals…",inputRef:l}){const[o,c]=t.useState(!1);return r.jsxs("div",{className:"relative",children:[r.jsxs("div",{className:"relative",children:[r.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground","aria-hidden":!0,children:"🔍"}),r.jsx("input",{type:"text",ref:l,value:e,onChange:e=>n?.(e.target.value),onFocus:()=>{(s||[]).length>0&&c(!0)},onBlur:()=>setTimeout(()=>c(!1),100),placeholder:i,className:"input pl-8 pr-12 min-h-[44px]","aria-label":"Search medals",role:"combobox","aria-autocomplete":"list","aria-expanded":o,"aria-controls":"search-suggestions","aria-haspopup":"listbox","data-tour":"medals-search"}),e?r.jsx("button",{type:"button",onClick:()=>n?.(""),className:"absolute right-2 top-1/2 -translate-y-1/2 btn btn-muted h-9 w-9","aria-label":"Clear search",children:"✕"}):null]}),o&&(s||[]).length>0&&r.jsx("div",{id:"search-suggestions",role:"listbox","aria-label":"Search suggestions",className:"absolute top-full left-0 right-0 mt-1 bg-bg-secondary border border-border rounded-lg shadow-lg z-10 text-foreground",children:s.map((e,t)=>r.jsx("button",{type:"button",role:"option",onClick:()=>(e=>{a?.(e),c(!1)})(e),className:"w-full text-left px-4 py-2 min-h-[44px] hover:bg-background border-b border-border last:border-b-0 text-sm",children:e},`${e}-${t}`))})]})}function ht({filters:e,onFilterChange:t,medalTypes:n,tiers:s,hasActiveFilters:a,resultCount:i,onClearAll:l,sortBy:o,onSortChange:c}){return r.jsxs("div",{className:"card flex flex-col overflow-hidden max-h-[80dvh] sm:max-h-none","data-tour":"filter-panel",children:[r.jsxs("div",{className:"p-4 flex justify-between items-center",children:[r.jsx("h3",{className:"font-bold text-foreground",children:"Filter"}),a&&r.jsx("button",{type:"button",onClick:l,className:"btn btn-muted text-sm min-h-[44px]",children:"Återställ alla"})]}),r.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto overscroll-contain p-4 pt-0",children:r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[r.jsxs("div",{className:"col-span-2 md:col-span-3",children:[r.jsx("label",{htmlFor:"sortSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Sortering"}),r.jsxs("select",{id:"sortSelect",value:o||"name",onChange:e=>c?.(e.target.value),className:"select",children:[r.jsx("option",{value:"name",children:"Namn"}),r.jsx("option",{value:"type",children:"Typ"}),r.jsx("option",{value:"tier",children:"Valör"}),r.jsx("option",{value:"status",children:"Status"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"statusSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Status"}),r.jsxs("select",{id:"statusSelect",value:e.status||"",onChange:e=>t("status",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"unlocked",children:"Upplåst"}),r.jsx("option",{value:"eligible",children:"Kvalificerad"}),r.jsx("option",{value:"available",children:"Tillgänglig"}),r.jsx("option",{value:"locked",children:"Låst"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"tierSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Valör"}),r.jsxs("select",{id:"tierSelect",value:e.tier||"",onChange:e=>t("tier",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),s.map(e=>r.jsx("option",{value:e,children:e.charAt(0).toUpperCase()+e.slice(1).replace(/_/g," ")},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"typeSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Typ"}),r.jsxs("select",{id:"typeSelect",value:e.type||"",onChange:e=>t("type",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),n.map(e=>r.jsx("option",{value:e,children:e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"weaponGroupSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Vapengrupp"}),r.jsxs("select",{id:"weaponGroupSelect",value:e.weaponGroup||"",onChange:e=>t("weaponGroup",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"reviewStatusSelect",className:"block text-sm font-medium text-muted-foreground mb-1",children:"Granskningsstatus"}),r.jsxs("select",{id:"reviewStatusSelect",value:e.reviewState||"",onChange:e=>t("reviewState",e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla"}),r.jsx("option",{value:"reviewed",children:"Granskad"}),r.jsx("option",{value:"under_review",children:"Under granskning"})]})]})]})}),r.jsxs("div",{className:"px-4 pt-4 border-t border-border text-sm text-muted-foreground flex-none sm:pb-4 pb-[env(safe-area-inset-bottom)]","aria-live":"polite",children:[i," märke(n) matchar filtren"]})]})}function bt({currentFilters:e,onApplyPreset:n}){const{presets:s,savePreset:a,deletePreset:i,reload:l}=function(){const e="medal-app-filter-presets",[r,n]=t.useState(()=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):[]}catch(t){return console.error("Failed to load presets:",t),[]}}),s=t.useCallback(()=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):[]}catch(t){return console.error("Failed to load presets:",t),[]}},[]),a=t.useCallback(()=>{n(s())},[s]);return{presets:r,savePreset:t.useCallback((t,r)=>{try{const a=[...s(),{name:t,filters:r,createdAt:(new Date).toISOString()}];localStorage.setItem(e,JSON.stringify(a)),n(a)}catch(a){console.error("Failed to save preset:",a)}},[s]),deletePreset:t.useCallback(t=>{try{const r=s();t>=0&&t<r.length&&(r.splice(t,1),localStorage.setItem(e,JSON.stringify(r)),n(r))}catch(r){console.error("Failed to delete preset:",r)}},[s]),reload:a}}(),[o,c]=t.useState("");return r.jsxs("div",{className:"card p-4",children:[r.jsx("h3",{className:"font-bold text-foreground mb-3",children:"Filter presets"}),r.jsx("div",{className:"mb-4",children:r.jsxs("div",{className:"flex gap-2",children:[r.jsx("input",{type:"text",value:o,onChange:e=>c(e.target.value),placeholder:"Preset-namn (tex, 'Mina Favoriter')",className:"input"}),r.jsx("button",{type:"button",onClick:()=>{o.trim()&&(a(o.trim(),e),c(""),l())},disabled:!o.trim(),className:"btn btn-primary text-sm disabled:opacity-50",children:"Spara"})]})}),s.length>0&&r.jsx("div",{className:"space-y-2",children:s.map((e,t)=>r.jsxs("div",{className:"flex justify-between items-center p-3 bg-background border border-border rounded",children:[r.jsx("button",{type:"button",onClick:()=>n?.(e.filters),className:"btn btn-muted text-sm flex-1 text-left",children:e.name}),r.jsx("button",{type:"button",onClick:()=>(e=>{i(e),l()})(t),className:"btn btn-muted text-sm","aria-label":`Ta bort preset ${e.name}`,children:"Ta bort"})]},`${e.name}-${t}`))})]})}function xt({active:e,onClick:t,children:n,ariaLabel:s,dataTour:a}){return r.jsx("button",{type:"button",onClick:t,"aria-pressed":e?"true":"false","aria-label":s,"data-tour":a,className:["inline-flex items-center px-4 py-2 rounded-full border text-sm min-h-[44px] shrink-0","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",e?"bg-primary/10 text-primary border-primary dark:bg-primary/20":"bg-transparent text-text-secondary border-border hover:bg-bg-secondary"].join(" "),children:n})}function gt({filters:e,onToggle:t,onOpenFilters:n,activeCount:s=0,controlsId:a,className:i=""}){const l=e.status||null;return r.jsxs("div",{className:["flex items-center gap-2 overflow-x-auto py-2 min-w-0",i].join(" "),role:"toolbar","aria-label":"Snabbfilter",children:[r.jsx(xt,{active:"unlocked"===l,onClick:()=>t("status","unlocked"),ariaLabel:"Filtrera på Upplåst",dataTour:"chip-unlocked",children:"Upplåst"}),r.jsx(xt,{active:"eligible"===l,onClick:()=>t("status","eligible"),ariaLabel:"Filtrera på Kvalificerad",children:"Kvalificerad"}),r.jsx(xt,{active:"available"===l,onClick:()=>t("status","available"),ariaLabel:"Filtrera på Tillgänglig",children:"Tillgänglig"}),r.jsx(xt,{active:"locked"===l,onClick:()=>t("status","locked"),ariaLabel:"Filtrera på Låst",children:"Låst"}),r.jsx("span",{className:"mx-2 h-5 w-px bg-border shrink-0 lg:hidden","aria-hidden":"true"}),r.jsx("button",{type:"button",onClick:n,"aria-haspopup":"dialog","aria-controls":a,"data-tour":"open-filters",className:"inline-flex items-center px-4 py-2 rounded-full border text-sm min-h-[44px] shrink-0 lg:hidden\n                   bg-background text-foreground border-border hover:bg-bg-secondary\n                   focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",children:s>0?`Filter (${s})`:"Filter"})]})}function yt({data:e,index:t,style:n}){const{medals:s,onSelect:a,statusesById:i}=e,l=s[t],o="function"==typeof l?.isPlaceholder?l.isPlaceholder():"placeholder"===l?.status,c=!o&&("function"==typeof l?.isUnderReview?l.isUnderReview():"under_review"===l?.status),d=i?.[l.id],u=d?.status??"locked",m=o?"placeholder":u,p=!o&&"unlocked"===u,f=(()=>{if(!p)return null;const e=d?.unlockedDate;if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t.getFullYear()})(),h=l.displayName||l.name,b=o?`${h} • Plats­hållare`:`${h}${c?" • Under granskning":""}${p&&f?" • Upplåst "+f:""}`;return r.jsxs("div",{role:"listitem",tabIndex:0,onClick:()=>a?.(l),onKeyDown:e=>{"Enter"===e.key&&a?.(l)},className:["flex items-center gap-3 px-3 py-2 hover:bg-bg-secondary focus-visible:bg-bg-secondary cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary",o?"bg-placeholder-subtle border-l-2 border-placeholder":""].join(" "),style:n,"aria-label":b,"data-tour":0===t?"medal-row-0":void 0,children:[r.jsxs("div",{className:"relative w-10 h-10 flex items-center justify-center rounded bg-bg-secondary flex-shrink-0","aria-hidden":"true",children:[r.jsx(Ke,{status:m,className:"w-2/3 h-2/3"}),!o&&c&&r.jsx("span",{className:"pill-flag pointer-events-none","aria-hidden":"true",children:r.jsx(Ke,{status:"review",className:"w-2.5 h-2.5 text-white"})})]}),r.jsx("div",{className:"min-w-0",children:r.jsxs("div",{className:"font-medium text-text-primary flex items-start gap-x-2",children:[r.jsx("span",{className:"clamp-2 min-w-0",children:h}),o&&r.jsx("span",{className:"status-badge status--placeholder",children:"Plats­hållare"})]})})]})}function vt({height:e,itemCount:n,itemSize:s,width:a="100%",itemData:i,children:l}){const o=t.useRef(null),[c,d]=t.useState(0),u=n*s,m=Math.max(0,Math.floor(c/s)-4),p=Math.ceil(e/s)+8,f=Math.min(n,m+p),h=[];for(let t=m;t<f;t++){const e=l({index:t,style:{position:"absolute",top:t*s,height:s,width:"100%"},data:i});h.push(x.cloneElement(e,{key:t}))}return r.jsx("div",{ref:o,className:"relative overflow-y-auto",style:{height:e,width:a,WebkitOverflowScrolling:"touch"},onScroll:e=>{d(e.currentTarget.scrollTop)},role:"list","aria-label":"Medal list",children:r.jsx("div",{style:{height:u,position:"relative"},children:h})})}function wt({medals:e,onSelect:n,height:s=800,itemSize:a=72,statusesById:i}){const l=t.useMemo(()=>({medals:e,onSelect:n,statusesById:i}),[e,n,i]),o=e?.length||0,c=t.useCallback(e=>r.jsx(yt,{...e}),[]);return r.jsx("div",{className:"border border-border rounded-md overflow-hidden",children:r.jsx(vt,{height:s,itemCount:o,itemSize:a,width:"100%",itemData:l,children:c})})}const jt="whatsnew:lastSeen";function kt(){return se?.version}function Nt(){try{return localStorage.getItem(jt)}catch{return null}}function St(){if(se?.env)return"production"===se.env;try{const e="undefined"!=typeof window&&window.location&&window.location.hostname?window.location.hostname:"";return!!e&&!("localhost"===e||"127.0.0.1"===e)}catch{return!1}}const Ct="app:onboardingTour:manualStart";function Mt(){const{medalDatabase:e}=K(),n=i(),s=a(),l=H(),[o,c]=t.useState("name"),[d,u]=t.useState(!1),m=t.useRef(null),[p,f]=g(),{currentProfile:h,hydrated:b}=z(),x=!b||void 0===h,y=pe(),[v,w]=t.useState(600);t.useEffect(()=>{const e=()=>w(Math.max(360,Math.round(.7*window.innerHeight)));return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const j=t.useMemo(()=>e?.getAllMedals()||[],[e]),{filters:k,setFilter:N,setFilters:S,clearAllFilters:C,hasActiveFilters:M}=function(e,r={}){const[n,s]=t.useState(()=>{try{const e=localStorage.getItem(ut);return{status:null,tier:null,type:null,weaponGroup:null,search:"",...(e?JSON.parse(e):null)||{},...r}}catch{return{status:null,tier:null,type:null,weaponGroup:null,search:"",...r}}});t.useEffect(()=>{try{localStorage.setItem(ut,JSON.stringify(n))}catch{}},[n]);const a=t.useMemo(()=>Array.isArray(e)?e.filter(e=>{if(n.tier&&e.tier!==n.tier)return!1;if(n.type&&e.type!==n.type)return!1;if(n.weaponGroup&&e.weaponGroup!==n.weaponGroup)return!1;if(n.search){const t=n.search.toLowerCase();if(!((e.displayName||"").toLowerCase().includes(t)||(e.name||"").toLowerCase().includes(t)||(e.type||"").toLowerCase().includes(t)))return!1}return!0}):[],[e,n]),i=t.useCallback((e,t)=>{s(r=>({...r,[e]:t}))},[]),l=t.useCallback(e=>{s(t=>({...t,...e||{}}))},[]),o=t.useCallback(()=>{s({status:null,tier:null,type:null,weaponGroup:null,search:""})},[]),c=t.useMemo(()=>Object.values(n).some(e=>null!==e&&""!==e),[n]);return{filters:n,filteredMedals:a,setFilter:i,setFilters:l,clearAllFilters:o,hasActiveFilters:c}}(j),{query:A,setQuery:I,suggestions:T}=function(e=[]){const[r,n]=t.useState(""),s=t.useMemo(()=>e.map(e=>({ref:e,haystack:mt([e.displayName||e.name||"",e.type||e.medals_type||"",e.tier||"",e.id].filter(Boolean).join(" "))})),[e]),a=t.useMemo(()=>{const t=mt(r).trim();return t?s.filter(e=>e.haystack.includes(t)).map(e=>e.ref):e},[s,r,e]),i=t.useMemo(()=>{if(!mt(r).trim())return[];const e=new Set;for(const t of a.slice(0,10)){const r=t.displayName||t.name;r&&!e.has(r)&&e.add(r)}return Array.from(e)},[a,r]);return{query:r,setQuery:n,results:a,suggestions:i}}(j);t.useEffect(()=>{const e=e=>{if("/"===e.key&&!e.metaKey&&!e.ctrlKey&&!e.altKey){const t=(document.activeElement?.tagName||"").toLowerCase();"input"!==t&&"textarea"!==t&&(e.preventDefault(),m.current?.focus())}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),t.useEffect(()=>{const e=e=>{const t=p.get(e);return t&&t.length?t:null},t={status:e("status"),type:e("type"),tier:e("tier"),weaponGroup:e("weaponGroup"),reviewState:e("reviewState")},r=e("search")||"",n=e("sort")||"name",s=Object.fromEntries(Object.entries(t).filter(([,e])=>null!=e));Object.keys(s).length&&S(s),r&&(I(r),N("search",r)),c(n)},[]),t.useEffect(()=>{const e=new URLSearchParams;k.status&&e.set("status",k.status),k.type&&e.set("type",k.type),k.tier&&e.set("tier",k.tier),k.weaponGroup&&e.set("weaponGroup",k.weaponGroup),k.reviewState&&e.set("reviewState",k.reviewState),A&&e.set("search",A),o&&"name"!==o&&e.set("sort",o);e.toString()!==p.toString()&&f(e,{replace:!0})},[k,A,o,f,p]);const P=t.useMemo(()=>[...new Set(j.map(e=>e.type))].filter(Boolean),[j]),E=t.useMemo(()=>[...new Set(j.map(e=>e.tier))].filter(Boolean),[j]),D=t.useMemo(()=>Object.entries(k).reduce((e,[t,r])=>"search"!==t&&r?e+1:e,0),[k]),F=t.useCallback((e,t)=>{N(e,k[e]===t?null:t)},[k,N]),$=t.useMemo(()=>{const e=Object.create(null);if(!l)return e;const t=(t,r)=>{(t||[]).forEach(t=>{e[t.medalId]={...t,status:r}})};return t(l.locked,"locked"),t(l.available,"available"),t(l.eligible,"eligible"),t(l.unlocked,"unlocked"),e},[l]),_=t.useMemo(()=>{const e={...k,search:A},t=function(e,t,r={}){if(!Array.isArray(e))return[];const n=(r.search||"").toLowerCase();return e.filter(e=>{const s=pt(e.id,t);if(r.status&&s!==r.status)return!1;if(r.tier&&e.tier!==r.tier)return!1;if(r.type&&e.type!==r.type)return!1;if(r.weaponGroup&&e.weaponGroup!==r.weaponGroup)return!1;const a=!0!==e.reviewed;return("reviewed"!==r.reviewState||!a)&&(!("under_review"===r.reviewState&&!a)&&!(n&&!((e.displayName||"").toLowerCase().includes(n)||(e.name||"").toLowerCase().includes(n)||(e.type||"").toLowerCase().includes(n))))})}(j,l,e);return function(e,t="name",r){const n=Array.isArray(e)?[...e]:[];switch(t){case"name":return n.sort((e,t)=>(e.displayName||"").localeCompare(t.displayName||""));case"type":return n.sort((e,t)=>(e.type||"").localeCompare(t.type||""));case"tier":{const e={bronze:0,silver:1,gold:2,star_1:3,star_2:4,star_3:5};return n.sort((t,r)=>(e[t.tier]??99)-(e[r.tier]??99))}case"status":{const e={unlocked:0,eligible:1,available:2,locked:3};return n.sort((t,n)=>(e[pt(t.id,r)]??99)-(e[pt(n.id,r)]??99))}default:return n}}(t,o,l)},[j,l,k,A,o]),Y=t.useMemo(()=>_.some(e=>!0!==e.reviewed),[_]),q=t.useCallback(()=>{if(y?.open)return;(M||""!==A||"name"!==o||d)&&(C(),I(""),N("search",""),c("name"),u(!1)),y.start()},[y,M,A,o,d,C,I,N]);return t.useEffect(()=>{if(x)return;if("/medals"!==s.pathname)return;if(y?.open)return;let e=null;try{e=sessionStorage.getItem(Ct)}catch{e=null}if("medals"===e){try{sessionStorage.removeItem(Ct)}catch{}q()}},[x,s.pathname,y,q]),t.useEffect(()=>{if(!x&&"/medals"===s.pathname&&!y?.open){try{if("medals"===sessionStorage.getItem(Ct))return}catch{}if(y?.canAutoStart?.()){if(St()){const e=kt();if(Nt()!==e)return}q()}}},[x,s.pathname,y,q]),x?null:e?r.jsxs("div",{className:"space-y-6",children:[r.jsx(ct,{idPrefix:"medals-list",promptId:"profile-picker-medals-list"}),r.jsxs("div",{className:"flex flex-col lg:flex-row lg:justify-between lg:items-center gap-3",children:[r.jsxs("div",{className:"flex items-baseline gap-3 flex-wrap",children:[r.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Märken"}),r.jsx("button",{type:"button",onClick:q,className:"text-sm underline hover:no-underline text-muted-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded",children:"Visa guide"})]}),r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsxs("div",{className:"text-sm text-muted-foreground","aria-live":"polite",children:[_.length," märken",M&&r.jsxs(r.Fragment,{children:[" · ",r.jsx("button",{type:"button",className:"underline hover:no-underline",onClick:C,children:"Rensa filter"})]}),Y&&r.jsxs(r.Fragment,{children:[" · ",r.jsx("span",{className:"hidden lg:inline",role:"note","aria-label":"Teckenförklaring",children:r.jsx(ze,{})})]})]}),r.jsxs("select",{value:o,onChange:e=>c(e.target.value),className:"select hidden lg:block","aria-label":"Sortera",children:[r.jsx("option",{value:"name",children:"Sortera på namn"}),r.jsx("option",{value:"type",children:"Sortera på typ"}),r.jsx("option",{value:"tier",children:"Sortera på valör"}),r.jsx("option",{value:"status",children:"Sortera på status"})]})]})]}),r.jsx(ft,{value:A,onChange:e=>{I(e),N("search",e)},suggestions:T,onSuggestionSelect:e=>{I(e),N("search",e)},inputRef:m,placeholder:"Sök märken... (klicka / för fokus)"}),r.jsx("div",{className:"flex items-center gap-2",children:r.jsx(gt,{className:"flex-1 min-w-0",filters:k,onToggle:(e,t)=>F(e,t),onOpenFilters:()=>u(!0),activeCount:D,controlsId:"mobile-filters-sheet"})}),r.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[r.jsxs("div",{className:"hidden lg:block lg:col-span-1 space-y-4",children:[r.jsx(ht,{filters:k,onFilterChange:N,medalTypes:P,tiers:E,hasActiveFilters:M,resultCount:_.length,onClearAll:C,sortBy:o,onSortChange:c}),r.jsx(bt,{currentFilters:k,onApplyPreset:e=>S(e)})]}),r.jsx(ce,{id:"mobile-filters-sheet",title:"Filter",open:d,onClose:()=>u(!1),swipeToDismiss:!0,children:r.jsx(ht,{filters:k,onFilterChange:N,medalTypes:P,tiers:E,hasActiveFilters:M,resultCount:_.length,onClearAll:()=>{C(),u(!1)},sortBy:o,onSortChange:c})}),r.jsx("div",{className:"lg:col-span-3",children:0===_.length?r.jsx("div",{className:"card p-6 text-center",children:r.jsx("p",{className:"text-muted-foreground",children:"Inga märken matchar dina filter"})}):r.jsx("div",{className:"border border-border rounded-md overflow-hidden",role:"region","aria-label":"Märkes-resultat",children:r.jsx(wt,{medals:_,height:v,itemSize:60,onSelect:e=>n(`/medals/${e.id}`,{state:{backgroundLocation:s}}),statusesById:$})})})]}),Y&&r.jsx("div",{className:"mt-4 lg:hidden",role:"note","aria-label":"Teckenförklaring",children:r.jsx(ze,{})})]}):r.jsx("div",{className:"text-muted-foreground",children:"Laddar märken..."})}function At({feature:e,children:n,variant:s="auto"}){const a=Q?.[e]||{},i=a.title||"Feature i utveckling",l=a.message||`Den här funktionen (“${e}”) visas som förhandsvisning.`,o="auto"===s?a.overlay||"auto":s,c=t.useRef(null),[d,u]=t.useState(!1);t.useEffect(()=>{if("auto"!==o)return;const e=c.current;if(!e||"undefined"==typeof ResizeObserver)return;const t=new ResizeObserver(t=>{const r=t[0]?.contentRect||e.getBoundingClientRect();u(r.width<420||r.height<160)});return t.observe(e),()=>t.disconnect()},[o]);const m="auto"===o?d?"inline":"panel":o;return r.jsxs("div",{ref:c,className:"relative isolate",children:[r.jsx("div",{className:"pointer-events-none opacity-60 [filter:blur(2px)]","aria-hidden":"true",inert:"",children:n}),"panel"===m?r.jsx("div",{role:"note","aria-label":"Feature preview","aria-live":"polite",className:"absolute inset-0 z-10 grid place-items-center bg-black/40 backdrop-blur-sm",children:r.jsx("div",{className:"w-[min(92vw,36rem,calc(100%-1rem))] max-w-none mx-4 rounded-xl border border-border bg-bg-secondary/95 p-4 shadow-lg text-foreground",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx(me,{name:"FlaskConical",className:"w-5 h-5","aria-hidden":"true",style:{color:"var(--color-info)"}}),r.jsxs("div",{children:[r.jsx("div",{className:"font-semibold leading-5 text-balance",children:i}),r.jsx("div",{className:"mt-1 text-sm text-muted-foreground text-pretty break-words",children:l})]})]})})}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"absolute inset-0 z-10 bg-black/30 backdrop-blur-[1.5px]","aria-hidden":"true"}),r.jsx("div",{className:"absolute inset-0 z-20 grid place-items-center",children:r.jsx("div",{role:"note","aria-label":"Feature preview",className:"mx-2 w-[min(92vw,calc(100%-1rem),28rem)] rounded-lg border border-border bg-bg-secondary/95 p-3 shadow-md text-foreground",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(me,{name:"FlaskConical",className:"w-4 h-4","aria-hidden":"true",style:{color:"var(--color-info)"}}),r.jsxs("p",{className:"text-sm leading-5 text-pretty break-words",children:[r.jsxs("span",{className:"font-semibold",children:[i,":"]})," ",r.jsx("span",{className:"text-muted-foreground",children:l})]})]})})})]})]})}function It({name:e,mode:n="preview",fallback:s=null,className:a,style:i,children:l}){const{state:o}=function(e){const r=t.useContext(ee),n=r?.get(e)??"off";return{state:n,enabled:"on"===n||"preview"===n}}(e);return"off"===o?s:"preview"===o?"hide"===n?s:r.jsx("div",{className:a,style:i,children:r.jsx(At,{feature:e,children:l})}):r.jsx("div",{className:a,style:i,children:l})}const Tt=(new Date).getFullYear();function Pt({open:e,onClose:n,initialRow:s,onSave:a,mode:i="batch",submitLabel:l,WG:o=["A","B","C","R"],DISCIPLINE_TYPES:c=["field","precision","military_fast"],COMP_TYPES:d=["national","regional/landsdels","crewmate/krets","championship"],MEDAL_TYPES:u=["bronze","silver","gold"],APP_TIME_OPTIONS:m=[{value:60,label:"60, Brons"},{value:40,label:"40, Silver"},{value:17,label:"17, Guld A/R"},{value:15,label:"15, Guld B/C"}],COMP_DISCIPLINE_TYPES:p=["national_whole_match","military_fast_match","ppc"],PPC_CLASS_SUGGESTIONS:f=["R1500","P1500","Open","SSA",'SR 4"','SR 2,75"',"Dist pistol","Dist revolver"]}){const h=t.useMemo(()=>e?JSON.stringify(s??{}):"closed",[e,s]);return r.jsx(ce,{id:"batch-row-editor",title:"Aktivitet",open:e,onClose:n,swipeToDismiss:!0,children:e?r.jsx(It,{name:"achievementEntry",children:r.jsx(Et,{initialRow:s,onSave:a,onClose:n,mode:i,submitLabel:l,WG:o,DISCIPLINE_TYPES:c,COMP_TYPES:d,MEDAL_TYPES:u,APP_TIME_OPTIONS:m,COMP_DISCIPLINE_TYPES:p,PPC_CLASS_SUGGESTIONS:f},h)}):null})}function Et({initialRow:e,onSave:n,onClose:s,mode:a="batch",submitLabel:i,WG:l,DISCIPLINE_TYPES:o,COMP_TYPES:c,MEDAL_TYPES:d,APP_TIME_OPTIONS:u,COMP_DISCIPLINE_TYPES:m,PPC_CLASS_SUGGESTIONS:p}){const[f,h]=t.useState(()=>e||{}),[b,x]=t.useState({}),g=!("competition_result"===f.type&&"ppc"===String(f.disciplineType||"").toLowerCase()),y=(e,t)=>h(r=>({...r,[e]:t})),v=t.useMemo(()=>e=>{const t=[],r={},n=Number(e.year);switch((!Number.isFinite(n)||n<1900||n>Tt)&&(t.push(`Året måste vara mellan 1900 och ${Tt}`),r.year=!0),l.includes(e.weaponGroup)||(t.push("Ogiltig grupp (A, B, C, R)"),r.weaponGroup=!0),e.type){case"precision_series":{const n=Number(e.points);(!Number.isFinite(n)||n<0||n>50)&&(t.push("Poäng måste vara 0-50"),r.points=!0);break}case"application_series":{const n=new Date(e.date);if(!e.date||Number.isNaN(n.getTime()))t.push("Ogiltigt datum"),r.date=!0;else{const e=new Date;e.setHours(0,0,0,0),n.setHours(0,0,0,0),n.getTime()>e.getTime()&&(t.push("Datum kan inte vara i framtiden"),r.date=!0)}const s=u.map(e=>e.value),a=Number(e.timeSeconds);Number.isFinite(a)&&s.includes(a)||(t.push("Välj giltig tid"),r.timeSeconds=!0);const i=Number(e.hits);(!Number.isFinite(i)||i<0)&&(t.push("Ange giltigt antal träffar"),r.hits=!0);break}case"competition_result":{const n=String(e.competitionType||"").toLowerCase(),s=String(e.disciplineType||"").toLowerCase(),a=Number(e.score);c.includes(n)||(t.push("Välj giltig tävlingstyp"),r.competitionType=!0),m.includes(s)||(t.push("Välj giltig gren"),r.disciplineType=!0),Number.isFinite(a)||(t.push("Poäng måste vara ett tal"),r.score=!0),"ppc"!==s||String(e.ppcClass||"").trim()||(t.push("Välj PPC-klass"),r.ppcClass=!0);break}}return{errs:t,fields:r}},[l,c,u,m]),w=(e=!1)=>{const{errs:t,fields:r}=v(f);if(t.length)x({list:t,fields:r});else if(n?.(f,{addAnother:e}),e){const e={year:f.year,weaponGroup:f.weaponGroup,type:f.type,date:(new Date).toISOString().slice(0,10),timeSeconds:"",hits:"",points:"",competitionType:"",medalType:"",disciplineType:"",ppcClass:"",competitionName:"",weapon:"",score:"",teamName:"",position:"",participants:"",eventName:"",notes:""};h(e),x({})}else s?.()};return r.jsxs("form",{onSubmit:e=>{e.preventDefault(),w(!1)},className:"space-y-4",noValidate:!0,children:[r.jsxs("div",{className:["grid gap-3",g?"grid-cols-2":"grid-cols-1"].join(" "),children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-year",className:"field-label mb-2",children:"År"}),r.jsx("input",{id:"br-year",type:"number",min:"1900",max:Tt,className:"input py-3",value:f.year??Tt,onChange:e=>y("year",Number(e.target.value)),"aria-invalid":b.fields?.year||void 0})]}),g&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-group",className:"field-label mb-2",children:"Grupp"}),r.jsx("select",{id:"br-group",className:"select py-3",value:f.weaponGroup??"A",onChange:e=>y("weaponGroup",e.target.value),"aria-invalid":b.fields?.weaponGroup||void 0,children:l.map(e=>r.jsx("option",{value:e,children:e},e))})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-type",className:"field-label mb-2",children:"Type"}),r.jsxs("select",{id:"br-type",className:"select py-3",value:f.type||"precision_series",onChange:e=>y("type",e.target.value),children:[r.jsx("option",{value:"precision_series",children:"Precisionsserier"}),r.jsx("option",{value:"application_series",children:"Tillämpningsserier"}),r.jsx("option",{value:"standard_medal",children:"Standardmedalj"}),r.jsx("option",{value:"competition_result",children:"Tävlingsresultat"}),r.jsx("option",{value:"qualification_result",children:"Kvalificering"}),r.jsx("option",{value:"team_event",children:"Lag-eventt"}),r.jsx("option",{value:"event",children:"Event"}),r.jsx("option",{value:"custom",children:"Custom"})]})]}),"precision_series"===f.type&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-points",className:"field-label mb-2",children:"Poäng (0-50)"}),r.jsx("input",{id:"br-points",type:"number",min:"0",max:"50",className:"input py-3",value:f.points??"",onChange:e=>y("points",e.target.value),"aria-invalid":b.fields?.points||void 0})]}),"application_series"===f.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-date",className:"field-label mb-2",children:"Datum"}),r.jsx("input",{id:"br-date",type:"date",className:"input py-3",value:f.date??(new Date).toISOString().slice(0,10),onChange:e=>y("date",e.target.value),"aria-invalid":b.fields?.date||void 0})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-time",className:"field-label mb-2",children:"Tid"}),r.jsxs("select",{id:"br-time",className:"select py-3",value:""===f.timeSeconds?"":Number(f.timeSeconds),onChange:e=>y("timeSeconds",""===e.target.value?"":Number(e.target.value)),"aria-invalid":b.fields?.timeSeconds||void 0,children:[r.jsx("option",{value:"",children:"Select time…"}),u.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-hits",className:"field-label mb-2",children:"Hits"}),r.jsx("input",{id:"br-hits",type:"number",min:"0",className:"input py-3",value:f.hits??"",onChange:e=>y("hits",e.target.value),"aria-invalid":b.fields?.hits||void 0})]})]}),"standard_medal"===f.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ctype",className:"field-label mb-2",children:"Gren"}),r.jsxs("select",{id:"br-ctype",className:"select py-3",value:f.disciplineType??"",onChange:e=>y("disciplineType",e.target.value),children:[r.jsx("option",{value:"",children:"Välj disciplin..."}),o.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-mtype",className:"field-label mb-2",children:"Medalj"}),r.jsxs("select",{id:"br-mtype",className:"select py-3",value:f.medalType??"",onChange:e=>y("medalType",e.target.value),children:[r.jsx("option",{value:"",children:"Välj medalj..."}),d.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-cname",className:"field-label mb-2",children:"Namn (valfritt)"}),r.jsx("input",{id:"br-cname",type:"text",className:"input py-3",value:f.competitionName??"",onChange:e=>y("competitionName",e.target.value)})]})]}),"competition_result"===f.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ctype",className:"field-label mb-2",children:"Tävlingstyp"}),r.jsxs("select",{id:"br-ctype",className:"select py-3",value:f.competitionType??"",onChange:e=>y("competitionType",e.target.value),"aria-invalid":b.fields?.competitionType||void 0,children:[r.jsx("option",{value:"",children:"Select type…"}),c.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-disc",className:"field-label mb-2",children:"Gren"}),r.jsxs("select",{id:"br-disc",className:"select py-3",value:f.disciplineType??"",onChange:e=>y("disciplineType",e.target.value),"aria-invalid":b.fields?.disciplineType||void 0,children:[r.jsx("option",{value:"",children:"Välj gren…"}),m.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),"ppc"===String(f.disciplineType||"")&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ppc",className:"field-label mb-2",children:"PPC-klass"}),r.jsx("input",{id:"br-ppc",type:"text",className:"input py-3",list:"ppc-classes",value:f.ppcClass??"",onChange:e=>y("ppcClass",e.target.value),placeholder:"t.ex. R1500","aria-invalid":b.fields?.ppcClass||void 0}),r.jsx("datalist",{id:"ppc-classes",children:p.map(e=>r.jsx("option",{value:e},e))})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-score",className:"field-label mb-2",children:"Poäng"}),r.jsx("input",{id:"br-score",type:"number",className:"input py-3",value:f.score??"",onChange:e=>y("score",e.target.value),"aria-invalid":b.fields?.score||void 0})]}),r.jsxs("div",{className:"md:col-span-2",children:[r.jsx("label",{htmlFor:"br-cname",className:"field-label mb-2",children:"Namn (valfritt)"}),r.jsx("input",{id:"br-cname",type:"text",className:"input py-3",value:f.competitionName??"",onChange:e=>y("competitionName",e.target.value)})]})]}),"qualification_result"===f.type&&r.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-weapon",className:"field-label mb-2",children:"Vapen"}),r.jsx("input",{id:"br-weapon",type:"text",className:"input py-3",value:f.weapon??"",onChange:e=>y("weapon",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-score",className:"field-label mb-2",children:"Poäng"}),r.jsx("input",{id:"br-score",type:"number",className:"input py-3",value:f.score??"",onChange:e=>y("score",e.target.value)})]})]}),"team_event"===f.type&&r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-team",className:"field-label mb-2",children:"Lag"}),r.jsx("input",{id:"br-team",type:"text",className:"input py-3",value:f.teamName??"",onChange:e=>y("teamName",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-pos",className:"field-label mb-2",children:"Placering"}),r.jsx("input",{id:"br-pos",type:"number",min:"1",className:"input py-3",value:f.position??"",onChange:e=>y("position",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-part",className:"field-label mb-2",children:"Deltagare"}),r.jsx("input",{id:"br-part",type:"text",className:"input py-3",placeholder:"Anna, Björn, Carin",value:f.participants??"",onChange:e=>y("participants",e.target.value)})]})]}),("event"===f.type||"custom"===f.type)&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-ename",className:"field-label mb-2",children:"Titel"}),r.jsx("input",{id:"br-ename",type:"text",className:"input py-3",value:f.eventName??"",onChange:e=>y("eventName",e.target.value)})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"br-notes",className:"field-label mb-2",children:"Anteckningar (valfritt)"}),r.jsx("textarea",{id:"br-notes",className:"textarea py-3 resize-none",rows:3,value:f.notes??"",onChange:e=>y("notes",e.target.value)})]}),b.list?.length?r.jsx("div",{role:"alert",className:"alert alert-error text-sm",children:b.list.join(", ")}):null,"batch"===a?r.jsxs("div",{className:"flex gap-2 justify-end pt-2",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:s,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-muted",onClick:()=>w(!0),children:"Lägg till & lägg till en till"}),r.jsx("button",{type:"submit",className:"btn btn-primary",children:"Lägg till batch"})]}):r.jsxs("div",{className:"flex gap-2 justify-end pt-2",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:s,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary",children:i||"Spara"})]})]})}function Dt({row:e,index:t,onEdit:n,onRemove:s}){const a=(()=>{switch(e.type){case"precision_series":return`Points: ${e.points??"—"}`;case"application_series":return`Time: ${e.timeSeconds??"—"} • Hits: ${e.hits??"—"}`;case"standard_medal":return`${e.disciplineType||"—"} • ${e.medalType||"—"}`;case"competition_result":return`${e.competitionType||"—"} • ${e.medalType||"—"}`;case"qualification_result":return`Weapon: ${e.weapon||"—"} • Score: ${e.score||"—"}`;case"team_event":return`Team: ${e.teamName||"—"} • Pos: ${e.position||"—"}`;default:return`${e.eventName||"—"}`}})();return r.jsxs("div",{className:"card p-4 flex items-start justify-between gap-3",children:[r.jsxs("div",{children:[r.jsxs("div",{className:"font-medium text-foreground",children:[e.type.replace(/_/g," ")," • ",e.year," • Grupp ",e.weaponGroup]}),r.jsx("div",{className:"text-sm text-muted-foreground",children:a}),e.notes?r.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"Anteckningar"}):null]}),r.jsxs("div",{className:"flex gap-2 shrink-0",children:[r.jsx("button",{type:"button",onClick:()=>n?.(t),className:"btn btn-muted h-10 px-3","aria-label":`Ändra rad ${t+1}`,children:"Ändra"}),r.jsx("button",{type:"button",onClick:()=>s?.(t),className:"btn btn-muted h-10 px-3 text-red-600","aria-label":`Ta bort rad ${t+1}`,children:"Ta bort"})]})]})}class Ft{constructor(e){this.id=e.id||`achievement-${Date.now()}`,this.type=e.type,this.medalId=e.medalId,this.date=e.date;const t="number"==typeof e.year&&Number.isFinite(e.year),r=this.date?new Date(this.date).getFullYear():void 0;this.year=t?e.year:Number.isFinite(r)?r:void 0,this.weaponGroup=e.weaponGroup||"A",this.points="number"==typeof e.points?e.points:null!=e.points&&""!==e.points?Number(e.points):void 0,this.disciplineType=e.disciplineType,this.competitionType=e.competitionType,this.medalType=e.medalType,this.ppcClass=e.ppcClass,this.competitionName=e.competitionName||"",this.notes=e.notes||"",this.score="number"==typeof e.score?e.score:null!=e.score&&""!==e.score?Number(e.score):void 0,this.weapon=e.weapon,this.teamName=e.teamName,this.position="number"==typeof e.position?e.position:null!=e.position&&""!==e.position?Number(e.position):void 0,this.participants=Array.isArray(e.participants)?e.participants:"string"==typeof e.participants?e.participants.split(",").map(e=>e.trim()).filter(Boolean):void 0,this.eventName=e.eventName,this.timeSeconds="number"==typeof e.timeSeconds?e.timeSeconds:null!=e.timeSeconds&&""!==e.timeSeconds?Number(e.timeSeconds):void 0,this.hits="number"==typeof e.hits?e.hits:null!=e.hits&&""!==e.hits?Number(e.hits):void 0}}function $t(){const{currentProfile:e,addAchievement:r,updateAchievement:n,removeAchievement:s,unlockMedal:a}=z(),{pushState:i,undo:l,redo:o,canUndo:c,canRedo:d,history:u,historyIndex:m}=function(){const e=t.useContext(J);if(!e)throw new Error("useUndoRedo must be used within UndoRedoProvider");return e}(),p=t.useCallback(()=>(e?.prerequisites||[]).map(e=>({...e})),[e]),f=t.useCallback(()=>{i({type:"achievements",data:p()})},[i,p]),h=t.useCallback(async t=>{if(!e)return;const a=(e.prerequisites||[]).map(e=>({...e})),i=new Map(a.map(e=>[e.id,e])),l=new Map(t.map(e=>[e.id,e]));for(const e of a)if(!l.has(e.id)&&"function"==typeof s)try{await s(e.id)}catch{}for(const e of t)if(!i.has(e.id)&&"function"==typeof r)try{await r(new Ft(e))}catch{}for(const e of t){const t=i.get(e.id);if(!t)continue;if(["type","year","weaponGroup","points","date","competitionName","notes","timeSeconds","hits"].some(r=>String(t[r]??"")!==String(e[r]??""))&&"function"==typeof n)try{await n(new Ft(e))}catch{}}},[r,s,n,e]),b=t.useCallback(async(t=[])=>{if(!t.length||!e)return 0;let n=0;const s=[],a=e=>""===e||null==e?void 0:Number(e);for(let e=0;e<t.length;e++){const l=t[e],o=new Ft({id:l.id,type:l.type,year:Number(l.year),weaponGroup:l.weaponGroup,date:l.date||(new Date).toISOString().slice(0,10),competitionName:l.competitionName||"",notes:l.notes||"",points:"precision_series"===l.type?a(l.points):void 0,disciplineType:"standard_medal"===l.type||"competition_result"===l.type?l.disciplineType||"":void 0,medalType:"standard_medal"===l.type?l.medalType||"":void 0,competitionType:"competition_result"===l.type?l.competitionType||"":void 0,ppcClass:"competition_result"===l.type?l.ppcClass||"":void 0,score:"competition_result"===l.type||"qualification_result"===l.type?a(l.score):void 0,weapon:"qualification_result"===l.type?l.weapon||"":void 0,teamName:"team_event"===l.type?l.teamName||"":void 0,position:"team_event"===l.type?a(l.position):void 0,participants:"team_event"===l.type?Array.isArray(l.participants)?l.participants:String(l.participants||"").split(",").map(e=>e.trim()).filter(Boolean):void 0,eventName:"event"===l.type||"custom"===l.type?l.eventName||"":void 0,timeSeconds:"application_series"===l.type?Number(l.timeSeconds):void 0,hits:"application_series"===l.type?""===l.hits||null==l.hits?void 0:Number(l.hits):void 0});if("function"==typeof r)try{await r(o),n++}catch(i){s.push({index:e,message:i?.message||"Failed to add achievement"}),console.error("addMany: add failed",{index:e+1,error:i,achievement:o})}}if(n>0)return f(),n;if(s.length>0){const e=s.map(e=>`Row ${e.index+1}: ${e.message}`).join(" | ");throw new Error(e)}return 0},[r,e,f]),x=t.useCallback(async t=>{if(!e)return!1;const r=t instanceof Ft?t:new Ft({...t,id:t?.id});if(!r?.id)return!1;try{return await n(r),f(),!0}catch(s){return console.error("updateAchievement failed",{error:s,payload:r}),!1}},[e,n,f]),g=t.useCallback(async t=>{if(!e||!t)return!1;let r=!1;if("function"==typeof s)try{await s(t),r=!0}catch(n){console.error("removeAchievement failed",{error:n,achievementId:t})}return r&&f(),r},[e,s,f]),y=t.useCallback(async()=>{const e=l();if(null==e)return!1;const t=u[e];return"achievements"===t?.type&&(await h(t.data),!0)},[l,u,h]),v=t.useCallback(async()=>{const e=o();if(null==e)return!1;const t=u[e];return"achievements"===t?.type&&(await h(t.data),!0)},[o,u,h]);t.useEffect(()=>{const e=e=>{(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey)&&("z"===e.key.toLowerCase()?(e.preventDefault(),y()):"y"===e.key.toLowerCase()&&(e.preventDefault(),v()))};return window.addEventListener("keydown",e,{passive:!1}),()=>window.removeEventListener("keydown",e)},[y,v]);const w=t.useCallback(async t=>{if(!e||!t)return!1;const n=t instanceof Ft?t:new Ft(t);if("function"!=typeof r)return!1;try{return await r(n),f(),!0}catch(s){return console.error("addAchievement failed",{error:s,achievement:n}),!1}},[e,r,f]),j=x,k=g;return{achievements:e?.prerequisites||[],addMany:b,addAchievement:w,updateAchievement:j,removeAchievement:k,unlockMedal:a,updateOne:x,removeOne:g,undoAchievements:y,redoAchievements:v,canUndo:c,canRedo:d,historyIndex:m}}const _t=["A","B","C","R"],Yt=["national","regional/landsdels","crewmate/krets","championship"],qt=["field","precision","military_fast"],Lt=["national_whole_match","military_fast_match","ppc"],Rt=["R1500","P1500","Open","SSA",'SR 4"','SR 2,75"',"Dist pistol","Dist revolver"],Ot=["bronze","silver","gold"],Bt=[{value:60,label:"60, Brons"},{value:40,label:"40, Silver"},{value:17,label:"17, Guld A/R"},{value:15,label:"15, Guld B/C"}],Ut=(new Date).getFullYear(),Gt=()=>({year:Ut,weaponGroup:"A",type:"precision_series",date:(new Date).toISOString().slice(0,10),timeSeconds:"",hits:"",points:"",competitionType:"",medalType:"",disciplineType:"",competitionName:"",weapon:"",score:"",ppcClass:"",teamName:"",position:"",participants:"",eventName:"",notes:""});function Vt(){const{addMany:e}=$t(),[n,s]=t.useState([Gt()]),[a,i]=t.useState(!1),[l,o]=t.useState(-1),[c,d]=t.useState({}),[u,m]=t.useState(0),[p,f]=t.useState(!1),[h,b]=t.useState([]),x=(e,t,r)=>{const a=[...n];a[e]={...a[e],[t]:r},s(a)},g=e=>{o(e),i(!0)},y=e=>{s(n.filter((t,r)=>r!==e))};return r.jsx(It,{name:"achievementEntry",children:r.jsxs("div",{className:"card p-6",children:[r.jsx("h2",{className:"text-xl font-bold mb-2 text-text-primary",children:"Lägg till aktiviteter i batch"}),r.jsx("p",{id:"batch-type-help",className:"text-sm text-text-secondary mb-4",children:"Batcher stödjer precisionsserier och tillämpningsserier. För att lägga till övriga, logga dem på ett märkeskort."}),u>0&&r.jsx("div",{role:"status","aria-live":"polite",className:"alert alert-success mb-4",children:r.jsxs("p",{children:["✓ Lyckades lägga till ",u," aktivitet(er)"]})}),h.length>0&&r.jsxs("div",{role:"alert",className:"alert alert-warning mb-4",children:[r.jsx("p",{className:"font-medium mb-1",children:"Möjliga duplikat:"}),r.jsx("ul",{className:"list-disc list-inside text-muted-foreground text-sm",children:h.map((e,t)=>r.jsx("li",{children:e},t))})]}),c.form&&r.jsx("div",{role:"alert",className:"alert alert-error mb-4",children:r.jsx("p",{children:c.form})}),r.jsxs("div",{className:"sm:hidden space-y-3 mb-4",children:[n.map((e,t)=>r.jsx(Dt,{row:e,index:t,onEdit:g,onRemove:y},t)),r.jsx("div",{className:"sticky bottom-0 safe-bottom pt-2 bg-transparent",children:r.jsx("button",{type:"button",onClick:()=>{o(-1),i(!0)},className:"btn btn-primary w-full min-h-[44px]","aria-label":"Add achievement",children:"+ Lägg till"})})]}),r.jsxs("form",{onSubmit:async t=>{t.preventDefault();const r={},a=[];if(n.forEach((e,t)=>{const n=[],s={},i=Number(e.year);switch((!Number.isFinite(i)||i<2e3||i>Ut)&&(n.push(`Året måste vara mellan 2000 och ${Ut}`),s.year=!0),_t.includes(e.weaponGroup)||(n.push("Ogiltig grupp (A, B, C, R)"),s.weaponGroup=!0),e.type){case"precision_series":{const t=Number(e.points);(!Number.isFinite(t)||t<0||t>50)&&(n.push("Poäng måste vara mellan 0-50"),s.points=!0);break}case"application_series":{const t=new Date(e.date);if(!e.date||Number.isNaN(t.getTime()))n.push("Ogiltigt datum"),s.date=!0;else{const e=new Date;e.setHours(0,0,0,0),t.setHours(0,0,0,0),t.getTime()>e.getTime()&&(n.push("Datum kan inte vara i framtiden"),s.date=!0)}const r=[60,40,17,15],a=Number(e.timeSeconds);Number.isFinite(a)&&r.includes(a)||(n.push("Välj giltig tid"),s.timeSeconds=!0);const i=Number(e.hits);(!Number.isFinite(i)||i<0)&&(n.push("Ange giltigt antal träffar"),s.hits=!0);break}case"competition_result":{const t=String(e.competitionType||"").toLowerCase(),r=String(e.disciplineType||"").toLowerCase(),a=Number(e.score);Yt.includes(t)||(n.push("Välj giltig tävlingstyp"),s.competitionType=!0),Lt.includes(r)||(n.push("Välj giltig gren"),s.disciplineType=!0),Number.isFinite(a)||(n.push("Poäng måste vara ett tal"),s.score=!0),"ppc"!==r||String(e.ppcClass||"").trim()||(n.push("Välj PPC-klass"),s.ppcClass=!0);break}}n.length?r[t]={list:n,fields:s}:a.push(e)}),Object.keys(r).length)return void d(r);const i=function(e){const t=new Set,r=[];return e.forEach(e=>{if(!e)return;if("application_series"===e.type)return;let n;n="precision_series"===e.type?`${e.year}-${e.type}-${e.weaponGroup}-${e.points}`:"competition_result"===e.type?`${e.year}-${e.type}-${e.weaponGroup}-${e.disciplineType||""}-${e.date||""}-${e.score??""}`:`${e.year}-${e.type}-${e.weaponGroup}`,t.has(n)&&r.push(n),t.add(n)}),r}(a.filter(e=>"precision_series"===e.type));b(i);try{f(!0);const t=await e(a);t>0?(m(t),s([Gt()]),d({}),setTimeout(()=>m(0),3e3)):d({form:"Inga aktiviteter blev tillagda. Granska din input."})}catch(l){d({form:l.message})}finally{f(!1)}},children:[r.jsx("div",{className:"hidden sm:block overflow-x-auto mb-4",children:r.jsxs("table",{className:"w-full text-sm text-foreground table-fixed",children:[r.jsxs("colgroup",{children:[r.jsx("col",{className:"w-[7rem]"}),r.jsx("col",{className:"w-[12rem]"}),r.jsx("col",{className:"w-[5rem]"}),r.jsx("col",{}),r.jsx("col",{className:"w-[7rem]"})]}),r.jsx("caption",{className:"sr-only",children:"Batch achievement input"}),r.jsx("thead",{children:r.jsxs("tr",{className:"border-b border-border bg-bg-secondary",children:[r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"År"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Typ"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Grupp"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Detaljer"}),r.jsx("th",{scope:"col",className:"text-left px-3 py-2",children:"Åtgärd"})]})}),r.jsx("tbody",{children:n.map((e,t)=>{const s=c[t],a=s?.list||[],i=`row-${t}-errors`,l=!!s?.fields?.year,o=!!s?.fields?.weaponGroup,d=!!s?.fields?.points,u=!!s?.fields?.date,m=!!s?.fields?.timeSeconds,f=!!s?.fields?.hits;return r.jsxs("tr",{className:"border-b border-border hover:bg-bg-secondary/60",children:[r.jsx("td",{className:"px-3 py-2",children:r.jsx("input",{type:"number",min:"2000",max:(new Date).getFullYear(),value:e.year,onChange:e=>x(t,"year",e.target.value),className:"input w-full",disabled:p,"aria-label":`Year for row ${t+1}`,"aria-invalid":l||void 0,"aria-describedby":a.length?i:void 0})}),r.jsx("td",{className:"px-3 py-2",children:r.jsxs("select",{value:e.type,onChange:e=>x(t,"type",e.target.value),className:"select w-full",disabled:p,"aria-label":`Type for row ${t+1}`,"aria-describedby":"batch-type-help",children:[r.jsx("option",{value:"precision_series",children:"Precisionsserie"}),r.jsx("option",{value:"application_series",children:"Tillämpningsserie"}),r.jsx("option",{value:"standard_medal",children:"Standardmedalj"}),r.jsx("option",{value:"competition_result",children:"Tävlingsresultat"}),r.jsx("option",{value:"qualification_result",children:"Kvalificering"}),r.jsx("option",{value:"team_event",children:"Lag-Event"}),r.jsx("option",{value:"event",children:"Event"}),r.jsx("option",{value:"custom",children:"Custom"})]})}),r.jsx("td",{className:"px-3 py-2",children:"competition_result"!==e.type||"ppc"!==String(e.disciplineType||"").toLowerCase()?r.jsxs("select",{value:e.weaponGroup,onChange:e=>x(t,"weaponGroup",e.target.value),className:"select w-full",disabled:p,"aria-label":`Vapengrupp för rad ${t+1}`,"aria-invalid":o||void 0,"aria-describedby":a.length?i:void 0,children:[r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]}):r.jsx("span",{className:"text-muted-foreground text-xs",children:"—"})}),r.jsxs("td",{className:"px-3 py-2",children:["precision_series"===e.type?r.jsx("input",{type:"number",min:"0",max:"50",value:e.points,onChange:e=>x(t,"points",e.target.value),className:"input w-full",placeholder:"0-50",disabled:p,"aria-label":`Poäng för rad ${t+1}`,"aria-invalid":d||void 0,"aria-describedby":a.length?i:void 0}):"application_series"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"date",value:e.date,onChange:e=>x(t,"date",e.target.value),className:"input w-full",disabled:p,"aria-label":`Datum för rad ${t+1}`,"aria-invalid":u||void 0,"aria-describedby":a.length?i:void 0}),r.jsxs("select",{value:""===e.timeSeconds?"":Number(e.timeSeconds),onChange:e=>x(t,"timeSeconds",""===e.target.value?"":Number(e.target.value)),className:"select w-full",disabled:p,"aria-label":`Tid för rad ${t+1}`,"aria-invalid":m||void 0,"aria-describedby":a.length?i:void 0,children:[r.jsx("option",{value:"",children:"Select time…"}),Bt.map(e=>r.jsx("option",{value:e.value,children:e.label},e.value))]}),r.jsx("input",{type:"number",min:"0",step:"1",value:e.hits,onChange:e=>x(t,"hits",e.target.value),className:"input w-full",placeholder:"Hits",disabled:p,"aria-label":`Träffar för rad ${t+1}`,"aria-invalid":f||void 0,"aria-describedby":a.length?i:void 0})]}):"standard_medal"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsxs("select",{value:e.disciplineType,onChange:e=>x(t,"disciplineType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Tävlinggren för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj disciplin..."}),qt.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsxs("select",{value:e.medalType,onChange:e=>x(t,"medalType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Medaljtyp för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj medalj..."}),Ot.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsx("input",{type:"text",value:e.competitionName,onChange:e=>x(t,"competitionName",e.target.value),className:"input w-full",placeholder:"Tävlingsnamn (valfritt)",disabled:p,"aria-label":`Tävlingsnamn för rad ${t+1}`})]}):"competition_result"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsxs("select",{value:e.competitionType,onChange:e=>x(t,"competitionType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Tävlingstyp för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Select type…"}),Yt.map(e=>r.jsx("option",{value:e,children:e},e))]}),r.jsxs("select",{value:e.disciplineType,onChange:e=>x(t,"disciplineType",e.target.value),className:"select w-full",disabled:p,"aria-label":`Gren för rad ${t+1}`,children:[r.jsx("option",{value:"",children:"Välj gren…"}),Lt.map(e=>r.jsx("option",{value:e,children:e},e))]}),"ppc"===String(e.disciplineType||"")&&r.jsxs(r.Fragment,{children:[r.jsx("input",{type:"text",value:e.ppcClass,onChange:e=>x(t,"ppcClass",e.target.value),className:"input w-full",list:`ppc-classes-row-${t}`,placeholder:"PPC-klass",disabled:p,"aria-label":`PPC-klass för rad ${t+1}`}),r.jsx("datalist",{id:`ppc-classes-row-${t}`,children:Rt.map(e=>r.jsx("option",{value:e},e))})]}),r.jsx("input",{type:"number",value:e.score,onChange:e=>x(t,"score",e.target.value),className:"input w-full",placeholder:"Poäng",disabled:p,"aria-label":`Poäng för rad ${t+1}`}),r.jsx("input",{type:"text",value:e.competitionName,onChange:e=>x(t,"competitionName",e.target.value),className:"input w-full",placeholder:"Tävlingsnamn (valfritt)",disabled:p,"aria-label":`Tävlingsnamn för rad ${t+1}`})]}):"qualification_result"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"text",value:e.weapon,onChange:e=>x(t,"weapon",e.target.value),className:"input w-full",placeholder:"Weapon",disabled:p,"aria-label":`Vapen för rad ${t+1}`}),r.jsx("input",{type:"number",value:e.score,onChange:e=>x(t,"score",e.target.value),className:"input w-full",placeholder:"Score",disabled:p,"aria-label":`Poäng för rad ${t+1}`})]}):"team_event"===e.type?r.jsxs("div",{className:"flex flex-wrap gap-2 min-w-0 whitespace-normal",children:[r.jsx("input",{type:"text",value:e.teamName,onChange:e=>x(t,"teamName",e.target.value),className:"input w-full",placeholder:"Lagnamn",disabled:p,"aria-label":`Lagamn för rad ${t+1}`}),r.jsx("input",{type:"number",min:"1",value:e.position,onChange:e=>x(t,"position",e.target.value),className:"input w-full",placeholder:"Placering",disabled:p,"aria-label":`Placering för rad ${t+1}`}),r.jsx("input",{type:"text",value:e.participants,onChange:e=>x(t,"participants",e.target.value),className:"input w-full",placeholder:"Deltagare (komma-separerad)",disabled:p,"aria-label":`Deltagara för rad ${t+1}`})]}):r.jsx("input",{type:"text",value:e.eventName,onChange:e=>x(t,"eventName",e.target.value),className:"input w-full",placeholder:"Event-namn / detaljer",disabled:p,"aria-label":`Event-namn för rad ${t+1}`}),a.length>0&&r.jsx("div",{id:i,role:"alert",className:"text-danger text-xs mt-1",children:a.join(", ")})]}),r.jsx("td",{className:"px-3 py-2",children:n.length>1&&r.jsx("button",{type:"button",onClick:()=>y(t),className:"btn btn-danger",disabled:p,"aria-label":`Ta bort rad ${t+1}`,children:"Ta bort"})})]},t)})})]})}),r.jsx("div",{className:"sm:hidden sticky bottom-0 safe-bottom bg-bg-secondary/80 backdrop-blur p-3 border-t border-border",children:r.jsx("button",{type:"submit",className:"btn btn-primary w-full min-h-[44px]",disabled:p||0===n.length,children:p?"Lägger till...":"Lägg till alla aktiviteter"})}),r.jsxs("div",{className:"hidden sm:flex gap-2 mb-4",children:[r.jsx("button",{type:"button",onClick:()=>{s([...n,Gt()])},className:"btn btn-muted disabled:opacity-50",disabled:p,children:"+ Lägg till rad"}),r.jsx("button",{type:"submit",className:"btn btn-primary disabled:opacity-50",disabled:p||0===n.length,children:p?"Lägger till...":"Lägg till alla aktiviteter"})]})]}),r.jsx(Pt,{open:a,onClose:()=>{i(!1),o(-1)},initialRow:l>=0?n[l]:Gt(),onSave:(e,{addAnother:t}={})=>{s(l>=0?t=>t.map((t,r)=>r===l?e:t):t=>[...t,e]),t||(i(!1),o(-1))},WG:_t,COMP_TYPES:Yt,MEDAL_TYPES:Ot,APP_TIME_OPTIONS:Bt,COMP_DISCIPLINE_TYPES:Lt,PPC_CLASS_SUGGESTIONS:Rt})]})})}const Kt={precision_series:"Precisionsserier",application_series:"Tillämpningsserier",competition_result:"Tävlingsresultat",qualification_result:"Qualification",team_event:"Lag-event",event:"Event",custom:"Custom",special_achievement:"Special achievement",standard_medal:"Standardmedalj"};function zt(e){return Kt[e]||e}function Wt({achievement:e}){const{addAchievement:n,updateAchievement:s,removeAchievement:a}=$t(),[i,l]=t.useState(!1),[o,c]=t.useState("add"),[d,u]=t.useState(null),m=(e,{id:t,medalId:r}={})=>{const n={id:t,medalId:r,type:e.type,year:Number(e.year),weaponGroup:e.weaponGroup,date:e.date,notes:e.notes||""};switch(e.type){case"precision_series":return{...n,points:""===e.points?void 0:Number(e.points??0),competitionName:e.competitionName||void 0};case"application_series":return{...n,timeSeconds:""===e.timeSeconds?void 0:Number(e.timeSeconds??0),hits:""===e.hits?void 0:Number(e.hits??0)};case"standard_medal":return{...n,disciplineType:e.disciplineType||"",competitionName:e.competitionName||"",medalType:e.medalType||""};case"competition_result":return{...n,score:""===e.score?void 0:Number(e.score??0),competitionName:e.competitionName||"",competitionType:e.competitionType||"",disciplineType:e.disciplineType||"",ppcClass:e.ppcClass||""};case"qualification_result":return{...n,weapon:e.weapon||"",score:""===e.score?void 0:Number(e.score??0)};case"team_event":return{...n,teamName:e.teamName||"",position:""===e.position?void 0:Number(e.position??0),participants:String(e.participants||"").split(",").map(e=>e.trim()).filter(Boolean)};default:return{...n,eventName:e.eventName||""}}},p=zt(e.type);return r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"card p-4 flex justify-between items-start",children:[r.jsxs("div",{children:[r.jsxs("div",{className:"flex gap-2 items-center mb-1",children:[r.jsx("span",{className:"font-semibold text-text-primary",children:p}),r.jsxs("span",{className:"text-xs px-2 py-1 rounded bg-bg-secondary text-text-secondary",children:["Grupp ",e.weaponGroup]})]}),r.jsxs("p",{className:"text-sm text-text-secondary",children:[(e.date||"").toString()," • ",e.points," points"]})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{onClick:()=>{var t;c("edit"),u({id:(t=e).id,type:t.type,year:t.year,weaponGroup:t.weaponGroup,date:t.date,points:t.points,timeSeconds:t.timeSeconds,hits:t.hits,competitionType:t.competitionType,disciplineType:t.disciplineType,ppcClass:t.ppcClass,competitionName:t.competitionName,weapon:t.weapon,score:t.score,teamName:t.teamName,position:t.position,participants:Array.isArray(t.participants)?t.participants.join(", "):t.participants||"",eventName:t.eventName,notes:t.notes}),l(!0)},className:"btn btn-muted text-sm","aria-label":`Ändra aktivitet ${e.id}`,children:"Ändra"}),r.jsx("button",{onClick:()=>{c("add");const t=(new Date).toISOString().slice(0,10);u({year:new Date(t).getFullYear(),weaponGroup:e.weaponGroup||"A",type:e.type||"precision_series",date:t,points:"",timeSeconds:"",hits:"",competitionType:"",disciplineType:"",ppcClass:"",competitionName:"",weapon:"",score:"",teamName:"",position:"",participants:"",eventName:"",notes:""}),l(!0)},className:"btn btn-primary text-sm","aria-label":`Logga ny aktivitet för märke ${e.medalId}`,children:"Logga"}),r.jsx("button",{onClick:async()=>{if(confirm("Delete this achievement?"))try{await a(e.id)}catch(t){console.error("Failed to delete:",t)}},className:"btn btn-muted text-red-600 text-sm","aria-label":`Ta bort aktivitet ${e.id}`,children:"Ta bort"})]})]}),r.jsx(Pt,{open:i,onClose:()=>l(!1),initialRow:d,onSave:async t=>{try{if("edit"===o){const r=m(t,{id:e.id,medalId:e.medalId});await s(r)}else{const r=m(t,{medalId:e.medalId});await n(r)}l(!1)}catch(r){console.error("Misslyckades att spara:",r)}},mode:"immediate",submitLabel:"edit"===o?"Spara":"Lägg till"})]})}function Ht(e){const t=String(e??"");return t.includes(",")||t.includes('"')||t.includes("\n")?`"${t.replace(/"/g,'""')}"`:t}const Xt=["id","type","year","weaponGroup","points","date","timeSeconds","hits","competitionName","competitionType","disciplineType","ppcClass","weapon","score","teamName","position","eventName","notes","schema_version"];function Jt(e=[],t="1"){return[Xt.join(","),...(e||[]).map(e=>Xt.map(r=>"schema_version"===r?t:e?.[r]??"").map(Ht).join(","))].join("\n")}function Zt(e,t="achievements.csv"){if("undefined"==typeof document)return;const r=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(r),s=document.createElement("a");s.href=n,s.setAttribute("download",t),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}function Qt(){const{currentProfile:e}=z(),[n,s]=t.useState(null),[a,i]=t.useState(null),[l,o]=t.useState(null),c=t.useMemo(()=>{if(!e?.prerequisites)return[];let t=[...e.prerequisites];return n&&(t=t.filter(e=>e.year===n)),a&&(t=t.filter(e=>e.type===a)),l&&(t=t.filter(e=>e.weaponGroup===l)),t.sort((e,t)=>new Date(t.date||"1970-01-01")-new Date(e.date||"1970-01-01"))},[e,n,a,l]),d=t.useMemo(()=>e?.prerequisites?[...new Set(e.prerequisites.map(e=>e.year))].sort((e,t)=>t-e):[],[e]);if(!e)return r.jsx("div",{className:"card p-4",children:r.jsx("p",{className:"text-foreground",children:"Välj en profil för att se aktiviteter"})});return r.jsx(It,{name:"historyTimeline",children:r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"card p-4",children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsx("h3",{className:"text-lg font-bold text-text-primary",children:"Filters"}),r.jsx("button",{onClick:()=>{Zt(Jt(c),"aktivitet-historik.csv")},className:"btn btn-primary text-sm","aria-label":"Exporta aktiviteter som CSV",children:"Exporta CSV"})]}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Year"}),r.jsxs("select",{value:n||"",onChange:e=>s(e.target.value?parseInt(e.target.value):null),className:"select",children:[r.jsx("option",{value:"",children:"All Years"}),d.map(e=>r.jsx("option",{value:e,children:e},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Type"}),r.jsxs("select",{value:a||"",onChange:e=>i(e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"All typer"}),["precision_series","competition_result","standard_medal"].map(e=>r.jsx("option",{value:e,children:zt(e)},e))]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Weapon Group"}),r.jsxs("select",{value:l||"",onChange:e=>o(e.target.value||null),className:"select",children:[r.jsx("option",{value:"",children:"Alla grupper"}),r.jsx("option",{value:"A",children:"A"}),r.jsx("option",{value:"B",children:"B"}),r.jsx("option",{value:"C",children:"C"}),r.jsx("option",{value:"R",children:"R"})]})]})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("h3",{className:"text-lg font-bold text-text-primary",children:[c.length," Aktivitet(er)"]}),0===c.length?r.jsx("div",{className:"card p-6 text-center",children:r.jsx("p",{className:"text-text-secondary",children:"Inga aktiviteter än"})}):r.jsx("div",{className:"space-y-3",children:c.map(e=>r.jsx(Wt,{achievement:e},e.id))})]})]})})}const er=["locked","available","eligible","unlocked"],tr={locked:{id:"locked",label:"Låst",description:"Förkrav ej uppfyllda.",icon:"Lock",className:"status-badge status--locked"},available:{id:"available",label:"Tillgänglig",description:"Medaljen är tillgänglig att påbörja.",icon:"Compass",className:"status-badge status--available"},eligible:{id:"eligible",label:"Kvalificerad",description:"Förkrav uppfyllda. Prestationskrav återstår.",icon:"BadgeCheck",className:"status-badge status--eligible"},unlocked:{id:"unlocked",label:"Upplåst",description:"Medaljen är erhållen.",icon:"Medal",className:"status-badge status--unlocked"}};function rr(e){return tr[e]||null}function nr(){const{currentProfile:e}=z(),n=t.useMemo(()=>e?.prerequisites?function(e){if(!e||0===e.length)return{totalAchievements:0,avgPointsPerYear:0,bestYear:null,yearsActive:0,pointsByYear:{}};const t={};e.forEach(e=>{const r=e.year;null!=r&&(t[r]||(t[r]=0),t[r]+=Number(e.points||0))});const r=Object.keys(t).map(Number).sort((e,t)=>e-t),n=r.length>0?r.reduce((e,r)=>t[r]>(t[e]??-1/0)?r:e,r[0]):null,s=n?t[n]:0,a=e.reduce((e,t)=>e+Number(t.points||0),0),i=Math.max(1,r.length);return{totalAchievements:e.length,avgPointsPerYear:a/i,bestYear:n,bestYearPoints:s,yearsActive:r.length,pointsByYear:t}}(e.prerequisites):{totalAchievements:0,avgPointsPerYear:0,bestYear:null,yearsActive:0},[e]),s=H(),a=t.useMemo(()=>er.map(e=>{const t=rr(e);return{key:e,label:t.label,icon:t.icon,count:Array.isArray(s?.[e])?s[e].length:0}}),[s]);return e?r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Totala Aktiviteter"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:n.totalAchievements})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Genomsnitt Poäng/År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:Number.isFinite(n.avgPointsPerYear)?n.avgPointsPerYear.toFixed(1):"0.0"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Bästa År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:n.bestYear||"-"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground font-semibold",children:"Aktiva År"}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:n.yearsActive})]}),a.map(({key:e,label:t,icon:n,count:s})=>r.jsxs("div",{className:"card p-4",children:[r.jsxs("p",{className:"text-sm text-muted-foreground font-semibold inline-flex items-center gap-2",children:[r.jsx(me,{name:n,className:"w-4 h-4","aria-hidden":"true"}),r.jsx("span",{children:t})]}),r.jsx("p",{className:"text-3xl font-bold text-foreground",children:s})]},e))]}):null}function sr(){const{currentProfile:e,setProfileFeature:n}=z(),[s,a]=t.useState("add");return e?r.jsx(Z,{children:r.jsxs("div",{className:"space-y-8",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold text-text-primary mb-2",children:"Inställningar"}),r.jsxs("p",{className:"text-text-secondary",children:["Profile: ",r.jsx("span",{className:"font-semibold",children:e.displayName})]})]}),r.jsx(nr,{}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"section-title mb-2",children:"Funktioner"}),r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("input",{id:"ft-manual-unlock",type:"checkbox",className:"h-5 w-5 mt-0.5",checked:!!e?.features?.allowManualUnlock,onChange:e=>n("allowManualUnlock",e.target.checked)}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"ft-manual-unlock",className:"field-label mb-1",children:"Tillåt manuell upplåsning av märken (förhandskrav gäller fortfarande)"}),r.jsx("p",{className:"field-hint",children:"Du kan låsa upp märken vilket år som helst utan att möta kraven för dem. Förhandskrav och årskrav gäller fortfarande."})]})]}),r.jsx(It,{name:"enforceCurrentYearSetting",children:r.jsxs("div",{className:"flex items-start gap-3 mt-3",children:[r.jsx("input",{id:"ft-enforce-current-year",type:"checkbox",className:"h-5 w-5 mt-0.5",checked:!!e?.features?.enforceCurrentYearForSustained,onChange:e=>n("enforceCurrentYearForSustained",e.target.checked)}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"ft-enforce-current-year",className:"field-label mb-1",children:"Kräv innevarande år för återkommande märken"}),r.jsx("p",{className:"field-hint",children:"Märken som kräver återkommande aktiviteter kan bara låsas upp innevarande kalenderår."})]})]})})]}),r.jsxs("div",{className:"flex gap-2 border-b border-border",role:"tablist","aria-label":"Inställnings-sektion",children:[r.jsx("button",{role:"tab","aria-selected":"add"===s,onClick:()=>a("add"),className:"px-4 py-2 font-medium border-b-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary "+("add"===s?"border-primary text-primary":"border-transparent text-text-secondary hover:text-text-primary"),children:"Lägg till aktiviteter"}),r.jsx("button",{role:"tab","aria-selected":"history"===s,onClick:()=>a("history"),className:"px-4 py-2 font-medium border-b-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary "+("history"===s?"border-primary text-primary":"border-transparent text-text-secondary hover:text-text-primary"),children:"Historik"})]}),"add"===s&&r.jsx(Vt,{}),"history"===s&&r.jsx(Qt,{})]})}):r.jsx(lt,{id:"profile-picker-settings"})}function ar(e=new Date){try{return new Date(e).toISOString()}catch{return(new Date).toISOString()}}function ir(e){return e?Array.isArray(e)?e:[e]:[]}function lr(e){if(null==e)return"";const t=String(e);return/[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}function or(e){const t=e?.achievements??e?.prerequisites??[],r=e?.unlockedMedals??[];return{totalAchievements:t.length,unlocked:r.length}}async function cr(e){const t=[];return t.push(["Medal","Type","DisciplineType","PPCClass","Date","Score","Position","Weapon","Team","Notes","Status"]),ir(e).forEach(e=>{const r=e.medalName||e.medalId||"",n=e.type||"",s=e.disciplineType||"",a=e.ppcClass||"",i=e.date||e.competitionDate||"",l=e.points??e.score??"",o=e.position??"",c=e.weapon??e.weaponGroup??"",d=e.team??"",u=e.notes??"",m=e.status??"";t.push([r,n,s,a,i,l,o,c,d,u,m])}),function(e){return e.map(e=>e.map(lr).join(",")).join("\n")}(t)}async function dr(t){try{const r=await e(()=>import("./vendor-BYCxJfch.js").then(e=>e.p),[]).catch(()=>null);if(r&&r.jsPDF){const{jsPDF:e}=r,n=new e;n.setFontSize(16),n.text("Medal Progress Report",14,18),n.setFontSize(10),n.text(`Generated: ${(new Date).toLocaleString()}`,14,26);const s=or(t),a=["Summary:",`- Total Achievements: ${s.totalAchievements}`,`- Unlocked Medals: ${s.unlocked}`];let i=36;return a.forEach(e=>{n.text(e,14,i),i+=6}),n.output("arraybuffer")}}catch{}return function(e){const t=or(e),r=["Medal Progress Report","---------------------",`Generated: ${(new Date).toLocaleDateString()}`,"","Summary:",`- Total Achievements: ${t.totalAchievements}`,`- Unlocked Medals: ${t.unlocked}`].join("\n"),n=`%PDF-1.4\n1 0 obj <</Type /Catalog /Pages 2 0 R>> endobj\n2 0 obj <</Type /Pages /Kids [3 0 R] /Count 1>> endobj\n3 0 obj <</Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R /Resources <</Font <</F1 5 0 R>>>>>> endobj\n4 0 obj <</Length ${r.length+100}>> stream\nBT\n/F1 12 Tf\n72 720 Td\n(${r.replace(/[\r\n]+/g,") Tj\nT* (")}) Tj\nET\nendstream endobj\n5 0 obj <</Type /Font /Subtype /Type1 /BaseFont /Helvetica>> endobj\nxref\n0 6\n0000000000 65535 f \n0000000010 00000 n \n0000000075 00000 n \n0000000136 00000 n \n0000000327 00000 n \n0000000584 00000 n \ntrailer <</Size 6 /Root 1 0 R>>\nstartxref\n692\n%%EOF`;return(new TextEncoder).encode(n)}(t)}async function ur(e,{version:t="1.0"}={}){const r={kind:"profile-backup",version:t,exportedAt:ar(),profile:{userId:e?.userId||"",displayName:e?.displayName||"",createdDate:e?.createdDate||ar(),lastModified:e?.lastModified||ar(),dateOfBirth:e?.dateOfBirth||"",unlockedMedals:ir(e?.unlockedMedals),prerequisites:ir(e?.prerequisites),features:{allowManualUnlock:!!e?.features?.allowManualUnlock,enforceCurrentYearForSustained:!!e?.features?.enforceCurrentYearForSustained},notifications:!!e?.notifications}};return JSON.stringify(r,null,2)}function mr({profile:e}){const[n,s]=t.useState("json"),[a,i]=t.useState(!1),[l,o]=t.useState(!1),[c,d]=t.useState(null),u=async t=>{try{let r,n,s;i(!0),d(null);const a=(new Date).toISOString().split("T")[0];switch(t){case"json":r=await ur(e,{version:"1.0"}),n=`profil-${a}.json`,s="application/json";break;case"csv":{const t=e?.achievements??e?.prerequisites??[];r=await cr(t),n=`aktiviteter-${a}.csv`,s="text/csv";break}case"pdf":r=await dr(e),n=`märkes-rapport-${a}.pdf`,s="application/pdf";break;default:throw new Error("Felaktigt export-format")}!function(e,t,r="application/octet-stream"){if("undefined"==typeof window||"undefined"==typeof document)return;let n;if(e instanceof Blob)n=e;else if(e instanceof Uint8Array)n=new Blob([e],{type:r});else if("string"==typeof e)n=new Blob([e],{type:r+";charset=utf-8"});else{if(null==e)throw new Error("downloadFile: invalid data");n=new Blob([JSON.stringify(e,null,2)],{type:"application/json;charset=utf-8"})}const s=URL.createObjectURL(n),a=document.createElement("a");a.href=s,a.download=t,a.rel="noopener",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}(r,n,s),o(!0),setTimeout(()=>o(!1),3e3)}catch(r){console.error("Export-fel:",r),d(r.message||"Export misslyckades")}finally{i(!1)}};return r.jsxs("div",{className:"card p-6",children:[r.jsx("h2",{className:"text-xl font-bold text-foreground mb-6",children:"Exporta profil"}),r.jsxs("fieldset",{className:"mb-6 space-y-3",children:[r.jsx("legend",{className:"text-sm font-medium text-foreground mb-3",children:"Export-format"}),["json","csv","pdf"].map(e=>r.jsxs("div",{className:"flex items-center",children:[r.jsx("input",{id:`format-${e}`,type:"radio",name:"format",value:e,checked:n===e,onChange:e=>s(e.target.value),className:"\n                w-5 h-5 rounded\n                bg-field border border-field\n                focus-visible:ring-2 focus-visible:ring-primary\n                focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary\n              ","aria-label":`Choose ${e.toUpperCase()} format`}),r.jsxs("label",{htmlFor:`format-${e}`,className:"ml-3 text-base font-medium text-foreground cursor-pointer",children:[e.toUpperCase()," ",pr(e)]})]},e))]}),r.jsx("button",{onClick:()=>u(n),disabled:a,className:"btn btn-primary w-full min-h-[44px]","aria-label":`Export as ${n.toUpperCase()}`,children:a?"Exporterar...":`Exporta som ${n.toUpperCase()}`}),l&&r.jsxs("div",{className:"alert alert-success mt-4 flex items-center gap-2",role:"status","aria-live":"polite",children:[r.jsx("span",{"aria-hidden":"true",children:"✓"}),r.jsx("span",{children:"Exporten lyckades!"})]}),c&&r.jsxs("div",{className:"alert alert-error mt-4 flex items-center gap-2",role:"alert","aria-live":"assertive",children:[r.jsx("span",{"aria-hidden":"true",children:"✕"}),r.jsx("span",{children:c})]})]})}function pr(e){switch(e){case"json":return"(Komplett profil-backup)";case"csv":return"(Spreadsheet-kompatibel)";case"pdf":return"(Utskriftsvänlig rapport)";default:return""}}function fr({open:n,onClose:s,shareData:a}){const[i,l]=t.useState(null),[o,c]=t.useState(null),[d,u]=t.useState(!1);t.useEffect(()=>{n&&(async()=>{try{c(null);const t=await async function(t,r={}){const n="string"==typeof t?t:JSON.stringify(t);try{const t=await e(()=>import("./vendor-BYCxJfch.js").then(e=>e.b),[]).catch(()=>null);if(t&&t.toDataURL)return await t.toDataURL(n,{errorCorrectionLevel:"M",width:r.width||256,margin:2})}catch{}return`data:text/plain;base64,${("undefined"!=typeof globalThis&&globalThis.Buffer&&"function"==typeof globalThis.Buffer.from?globalThis.Buffer.from(n,"utf8").toString("base64"):"function"==typeof btoa?btoa(unescape(encodeURIComponent(n))):"")||""}`}(a);l(t)}catch(t){c(t.message||"Misslyckades att skapa QR-kod")}})()},[n,a]);const m="string"==typeof a?a:a?.link||"";return n?r.jsx("div",{className:"\n        fixed inset-0 bg-black/50 flex items-center justify-center p-4\n      ",role:"dialog","aria-modal":"true","aria-label":"Share progress dialog",onClick:s,children:r.jsxs("div",{className:"w-full max-w-md p-6 rounded-lg bg-bg-secondary border border-border",onClick:e=>e.stopPropagation(),children:[r.jsx("h2",{className:"text-xl font-bold text-foreground mb-4",children:"Dela dina framsteg"}),o&&r.jsx("div",{className:"alert alert-error mb-4",role:"alert","aria-live":"assertive",children:o}),!o&&r.jsxs("div",{className:"flex flex-col items-center",children:[i?r.jsx("img",{src:i,alt:"QR code for sharing progress",className:"w-48 h-48"}):r.jsx("div",{className:"w-48 h-48 flex items-center justify-center border border-dashed border-border rounded",children:r.jsx("span",{className:"text-muted-foreground",children:"Skapar..."})}),r.jsx("div",{className:"w-full mt-4",children:r.jsxs("div",{className:"flex gap-2",children:[r.jsx("input",{type:"text",readOnly:!0,value:m,className:"input flex-1","aria-label":"Share link"}),r.jsx("button",{onClick:async()=>{try{if(!m)return;await navigator.clipboard.writeText(m),u(!0),setTimeout(()=>u(!1),2e3)}catch{c("Misslyckades att kopiera länk")}},className:"btn btn-primary min-w-[96px] min-h-[44px]","aria-label":"Copy share link",children:d?"Kopierad":"Kopiera"})]})})]}),r.jsx("div",{className:"mt-6 flex justify-end",children:r.jsx("button",{onClick:s,className:"btn btn-muted min-h-[44px]","aria-label":"Stäng delningsdialogen",children:"Stäng"})})]})}):null}const hr=["id","type","year","weaponGroup","points","date","timeSeconds","hits","competitionName","competitionType","disciplineType","ppcClass","weapon","score","teamName","position","eventName","notes","schema_version"];function br(e){const t=[];let r="",n=!1;for(let s=0;s<e.length;s++){const a=e[s];'"'===a?n&&'"'===e[s+1]?(r+='"',s++):n=!n:","!==a||n?r+=a:(t.push(r),r="")}return t.push(r),t.map(e=>e.trim())}function xr(e){if(null==e||""===e)return;const t=String(e).replace(",","."),r=Number(t);return Number.isFinite(r)?r:void 0}function gr(e){return null==e?void 0:String(e).trim().toLowerCase()}function yr(e){const t={};for(const r of Object.keys(e)){const n=r.trim(),s=e[r];switch(n){case"type":t.type=gr(s);break;case"year":t.year=xr(s);break;case"weaponGroup":t.weaponGroup=String(s||"A").trim().toUpperCase();break;case"points":t.points=xr(s);break;case"timeSeconds":t.timeSeconds=xr(s);break;case"hits":t.hits=xr(s);break;case"score":t.score=xr(s);break;case"position":t.position=xr(s);break;case"competitionType":case"disciplineType":case"weapon":case"teamName":case"competitionName":case"eventName":case"notes":case"date":{const e="string"==typeof s?s.trim():s;t[n]="competitionType"===n||"disciplineType"===n||"weapon"===n?gr(e):e;break}case"ppcClass":t.ppcClass="string"==typeof s?s.trim():s;break;case"id":t.id=String(s||"").trim()||void 0}}return t}function vr(e){const t=function(e=""){return String(e).replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n")}(e).filter(Boolean);if(!t.length)return{rows:[],errors:["Empty file"]};const r=br(t[0]).map(e=>e.trim()),n=r.filter(e=>!hr.includes(e)),s=[],a=n.length?[`Okända rubriker: ${n.join(", ")}`]:[];for(let i=1;i<t.length;i++){const e=br(t[i]),n={};for(let t=0;t<r.length;t++)n[r[t]]=e[t]??"";s.push(yr(n))}return{rows:s,errors:a}}function wr(e){return{id:e.id,type:e.type,year:e.year,weaponGroup:e.weaponGroup||"A",points:e.points,date:e.date,timeSeconds:e.timeSeconds,hits:e.hits,competitionName:e.competitionName,competitionType:e.competitionType,disciplineType:e.disciplineType,ppcClass:e.ppcClass,weapon:e.weapon,score:e.score,teamName:e.teamName,position:e.position,eventName:e.eventName,notes:e.notes}}function jr({profile:e,updateProfile:n,upsertAchievements:s}){const[a,i]=t.useState(!1),[l,o]=t.useState(null),[c,d]=t.useState(null),[u,m]=t.useState(null),[p,f]=t.useState({updateById:!0,matchNaturalKey:!1,addNew:!0}),h=t.useRef(null),[b,x]=t.useState(""),[g,y]=t.useState(null),v=t.useMemo(()=>Array.isArray(e?.prerequisites)?e.prerequisites:[],[e?.prerequisites]);return r.jsxs("div",{className:"card p-4 md:col-span-2",role:"region","aria-labelledby":"csv-title",children:[r.jsx("h2",{id:"csv-title",className:"text-lg font-semibold text-foreground mb-3",children:"CSV (Aktiviteter)"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Exportera, redigera och importera aktiviteter via CSV. För säkerhet körs en förhandsgranskning först."}),r.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[r.jsx("button",{onClick:function(){try{Zt(Jt(v,"1"),"aktiviteter.csv"),o(null)}catch(e){o(e.message||"Export av CSV misslyckades")}},className:"btn btn-primary min-h-[44px]","aria-label":"Exportera aktiviteter som CSV",children:"Exportera aktiviteter (CSV)"}),r.jsx("button",{onClick:function(){try{Zt(function(e="1"){return[Xt.join(","),["","precision_series","2024","A","45","2024-05-20","","","","","","","","","","","","Exempelrad",e].map(Ht).join(",")].join("\n")}("1"),"aktiviteter_mall.csv"),o(null)}catch(e){o(e.message||"Nedladdning av mall misslyckades")}},className:"btn btn-secondary min-h-[44px]","aria-label":"Ladda ned CSV-mall",children:"Ladda ned CSV-mall"})]}),r.jsxs("div",{className:"p-4 rounded-lg border border-border bg-bg-primary",role:"group","aria-labelledby":"csv-import-label",children:[r.jsx("div",{id:"csv-import-label",className:"field-label mb-2",children:"Importera från CSV"}),r.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:()=>h.current?.click(),children:"Välj CSV-fil"}),r.jsx("span",{className:"text-sm text-muted-foreground",children:b||"Ingen fil vald"}),r.jsx("input",{ref:h,type:"file",accept:".csv",className:"hidden",onChange:e=>e.target.files?.[0]&&async function(t){if(t){o(null),m(null),d(null),i(!0);try{const e=vr(await t.text());if(e.errors?.length)return void o(e.errors.join("; "));const r=e.rows.map(wr),n=await s(r,{...p,dryRun:!0});d({rows:r,result:n}),x(t.name)}catch(e){o(e.message||"Kunde inte läsa/validera CSV")}finally{i(!1)}}}(e.target.files[0])}),c&&r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:function(){o(null),d(null),m(null),x("")},children:"Rensa"})]}),r.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-3 gap-2",children:[r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:p.updateById,onChange:e=>f(t=>({...t,updateById:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Uppdatera via ID"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:p.matchNaturalKey,onChange:e=>f(t=>({...t,matchNaturalKey:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Matcha utan ID via nyckel (avancerat)"})]}),r.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded bg-bg-primary border border-border focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",checked:p.addNew,onChange:e=>f(t=>({...t,addNew:e.target.checked}))}),r.jsx("span",{className:"text-foreground",children:"Lägg till nya rader"})]})]})]}),a&&r.jsx("div",{className:"alert alert-info mt-3",role:"status","aria-live":"polite",children:"Bearbetar..."}),l&&r.jsx("div",{className:"alert alert-error mt-3",role:"alert","aria-live":"assertive",children:l}),c&&!l&&r.jsxs("div",{className:"mt-3",children:[r.jsx("div",{className:"alert alert-warning",role:"status","aria-live":"polite",children:"Förhandsgranskning: inga ändringar har gjorts än."}),r.jsxs("div",{className:"mt-2 text-sm text-muted-foreground",children:["Skulle importera: ",c.result.added," tillägg, ",c.result.updated," uppdateringar, ",c.result.skipped," överhoppade, ",c.result.failed," fel."]}),r.jsx("button",{onClick:async function(){if(c?.rows?.length){i(!0),o(null),m(null);try{y({userId:e.userId,prerequisites:Array.isArray(e.prerequisites)?[...e.prerequisites]:[]});const t=await s(c.rows,{...p,dryRun:!1});m(t),d(null)}catch(t){o(t.message||"Import av CSV misslyckades")}finally{i(!1)}}},disabled:a,className:"btn btn-primary w-full mt-3 min-h-[44px]",children:"Bekräfta import"})]}),u&&r.jsxs("div",{className:"mt-3",children:[r.jsxs("div",{className:"alert alert-success",role:"status","aria-live":"polite",children:["Import klar: ",u.added," tillagda, ",u.updated," uppdaterade, ",u.skipped," överhoppade, ",u.failed," fel."]}),r.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:async function(){try{if(!g)return;const t={...e,prerequisites:g.prerequisites,lastModified:(new Date).toISOString()};await n(t),y(null),m(null)}catch(t){o(t.message||"Ångra misslyckades")}},children:"Ångra import"})})]}),r.jsxs("details",{className:"mt-4",children:[r.jsx("summary",{className:"cursor-pointer text-sm text-foreground",children:"Hjälp: Kolumner och arbetsflöde"}),r.jsxs("div",{className:"mt-2 text-sm text-muted-foreground space-y-2",children:[r.jsxs("p",{children:["Arbetsflöde: 1) Exportera aktiviteter, 2) Redigera i kalkylark, 3) Importera CSV. Behåll kolumnen ",r.jsx("code",{children:"id"})," för att uppdatera rader; nya rader kan lämna ",r.jsx("code",{children:"id"})," tomt."]}),r.jsx("p",{children:"Tillåtna kolumner (valfria där det inte krävs): id, type, year, weaponGroup, points, date, timeSeconds, hits, competitionName, competitionType, medalType, disciplineType, weapon, score, teamName, position, eventName, notes, schema_version."}),r.jsx("p",{children:"Standardmatchning: Uppdatera via ID. Alternativt kan du matcha utan ID via naturlig nyckel (avancerat)."})]})]})]})}function kr(){const{currentProfile:e,updateProfile:n,loading:s,error:a,upsertAchievements:i}=z(),[o,c]=t.useState(!1),[d,u]=t.useState(null),[m,p]=t.useState(null),[f,h]=t.useState(!1),b=t.useMemo(()=>!!e&&!s,[e,s]);return r.jsxs("div",{className:"max-w-6xl mx-auto p-4",children:[r.jsx("h1",{className:"section-title mb-4",children:"Data & Backup"}),(a||m)&&r.jsx("div",{className:"alert alert-error mb-4",role:"alert","aria-live":"assertive",children:a||m}),b?r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r.jsx("div",{className:"card md:row-span-2 p-4",children:r.jsx(mr,{profile:e})}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-3",children:"Importera profil (backup)"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Återställ en hel profil från en JSON-backup. Du kan skapa en ny profil eller ersätta en profil med samma ID."}),r.jsx("button",{onClick:()=>h(!0),className:"btn btn-secondary min-h-[44px]","aria-haspopup":"dialog","aria-controls":"profile-import-dialog",children:"Importera profil"})]}),r.jsxs("div",{className:"card p-4",children:[r.jsx("h2",{className:"text-lg font-semibold text-foreground mb-3",children:"Share"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Skapa en QR-kod som innehåller profilen för att dela eller göra backup."}),r.jsx("button",{onClick:async()=>{try{p(null);const t=await ur(e,{version:"1.0"});u(t),c(!0)}catch(t){p(t.message||"Misslyckades med förberedelser för att dela data")}},className:"btn btn-primary min-h-[44px]","aria-label":"Open share dialog",children:"Dela via QR-kod"})]}),r.jsx(It,{name:"csvImport",className:"md:col-span-2",children:r.jsx(jr,{profile:e,updateProfile:n,upsertAchievements:i})})]}):r.jsxs("div",{className:"card p-6",children:[r.jsx("p",{className:"text-muted-foreground",children:"Välj eller skapa en profil för att importera/exportera aktiviteter."}),r.jsx("div",{className:"mt-4",children:r.jsx(l,{to:"/settings",className:"btn btn-primary min-h-[44px]",children:"Till Inställningar"})})]}),r.jsx(fr,{open:o,onClose:()=>c(!1),shareData:d}),r.jsx(de,{id:"profile-import-dialog",open:f,onClose:()=>h(!1)})]})}function Nr({open:e,onClose:n}){const s=t.useContext(ee)??{get:()=>"off",enabled:()=>!1,all:()=>({}),set:()=>{},setMany:()=>{},clear:()=>{},clearAll:()=>{},saveToProfile:async()=>!1,clearProfileOverrides:async()=>!1},{currentProfile:a,hydrated:i}=z(),[l,o]=t.useState(!1),[c,d]=t.useState(""),[u,m]=t.useState(()=>s.all()),p=t.useMemo(()=>Object.keys(Q||s.all()||{}).map(e=>({name:e,state:u[e]??s.get(e)??"off",meta:Q?.[e]||{}})),[u,s]);if(!e)return null;const f="idkfa"===c,h="admin-flags-heading",x=r.jsx("div",{className:"fixed inset-0 z-50 grid place-items-center p-4 sm:p-6 bg-black/50",onClick:n,onKeyDown:e=>{"Escape"===e.key&&n?.(),!l&&"Enter"===e.key&&f&&o(!0)},role:"dialog","aria-modal":"true","aria-labelledby":h,children:r.jsx("div",{className:"card flex-none w-full max-w-[calc(100vw-2rem)] sm:max-w-[calc(100vw-3rem)] md:max-w-3xl min-w-[20rem] p-4 md:p-6 mx-auto overflow-auto max-h-[calc(100dvh-3rem)]",onClick:e=>e.stopPropagation(),children:l?r.jsxs(r.Fragment,{children:[r.jsx("h2",{id:h,className:"section-title mb-2",children:"Feature-flaggor"}),r.jsxs("div",{className:"space-y-3 max-h-[60vh] overflow-auto pr-1",children:[p.map(e=>r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-[minmax(0,1fr)_12rem] md:grid-cols-[minmax(0,1fr)_14rem] items-start sm:items-center gap-2 sm:gap-4",children:[r.jsxs("div",{className:"min-w-0",children:[r.jsx("div",{className:"font-medium",children:e.meta.title||e.name}),e.meta.message&&r.jsx("div",{className:"text-xs text-muted-foreground",children:e.meta.message})]}),r.jsx("label",{className:"sr-only",htmlFor:`flag-${e.name}`,children:e.meta.title||e.name}),r.jsxs("select",{id:`flag-${e.name}`,className:"select w-full",value:u[e.name]??"off",onChange:t=>m(r=>({...r,[e.name]:t.target.value})),children:[r.jsx("option",{value:"off",children:"Off"}),r.jsx("option",{value:"preview",children:"Preview"}),r.jsx("option",{value:"on",children:"On"})]})]},e.name)),0===p.length&&r.jsx("div",{className:"text-sm text-muted-foreground",children:"Inga flaggor hittades."})]}),r.jsxs("div",{className:"flex gap-2 justify-between mt-4 safe-bottom",children:[r.jsx("button",{type:"button",className:"btn btn-muted",onClick:async()=>{s.clearAll(),m({}),i&&a&&await(s.clearProfileOverrides?.()),n?.()},children:"Återställ till default"}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:n,children:"Stäng"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:async()=>{s.setMany(u),i&&a&&await(s.saveToProfile?.(u)),n?.()},children:"Spara"})]})]})]}):r.jsxs(r.Fragment,{children:[r.jsx("h2",{id:h,className:"section-title mb-2",children:"Admin-läge"}),r.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Ange lösenord för att hantera feature-gates."}),r.jsx("label",{className:"field-label sr-only",htmlFor:"admin-password",children:"Lösenord"}),r.jsx("input",{id:"admin-password",type:"password",className:"input mb-3",placeholder:"Lösenord",value:c,onChange:e=>d(e.target.value),autoFocus:!0}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:n,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>f&&o(!0),disabled:!f,children:"Fortsätt"})]})]})})});return b.createPortal(x,document.body)}const Sr=[{id:"0.9.3",date:"2026-01-03",title:"Användarguide",highlights:["Interaktiv användarguide för medaljlistan","Hänvisa till regelbok version 20 tillsvidare"],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.3"},{id:"0.9.2",date:"2026-01-01",title:"Versionsnytt",highlights:["Versionsinformation med förändringslogg tillagd."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.2"},{id:"0.9.1",date:"2025-12-31",title:"Uppdateringar av märken för luftpistol",highlights:["Årsmärken för luftpistol korrigerade."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.1"},{id:"0.9.0",date:"2025-12-31",title:"Ny trädvy",highlights:["Ny trädvy för märken med tidslinje per märkestyp."],link:"https://github.com/mandakan/spsf-medal-explorer/releases/tag/v0.9.0"}];function Cr(){const e="undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/",[n,s]=t.useState(!1),l=a(),o=i(),c=(()=>{const e=kt();return Nt()!==e})();return r.jsxs("div",{className:"max-w-3xl mx-auto px-4 sm:px-6 py-6",children:[r.jsxs("article",{className:"prose prose-headings:text-foreground prose-p:text-foreground prose-a:text-primary dark:prose-invert max-w-none",children:[r.jsxs("header",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:ve}),r.jsx("p",{className:"mt-2 text-muted-foreground",children:"Spåra dina skyttemärken och medaljer enligt Svenska Pistolskytteförbundets regler"})]}),r.jsx(Te,{id:"disclaimer-about",variant:"warning",text:"Fristående app. Regelboken gäller före appen.",linkUrl:ye}),r.jsxs("section",{"aria-labelledby":"about-links",className:"mt-8",children:[r.jsx("h2",{id:"about-links",className:"text-2xl font-semibold",children:"Användbara länkar"}),r.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[r.jsx("li",{children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary inline-flex items-center min-h-[44px]",href:be,target:"_blank",rel:"noreferrer noopener",children:"SPSF"})}),r.jsx("li",{children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary inline-flex items-center min-h-[44px]",href:xe,target:"_blank",rel:"noreferrer noopener",children:"GitHub-projekt"})})]})]}),r.jsxs("section",{"aria-labelledby":"about-author",className:"mt-8",children:[r.jsx("h2",{id:"about-author",className:"text-2xl font-semibold",children:"Skapare"}),r.jsx("p",{className:"mt-2",children:we})]}),r.jsxs("section",{"aria-labelledby":"about-support",className:"mt-8",children:[r.jsx("h2",{id:"about-support",className:"text-2xl font-semibold",children:"Stötta projektet"}),r.jsx("p",{className:"mt-2",children:"Gillar du appen? Bjud utvecklaren på en kaffe."}),r.jsx("p",{className:"mt-2",children:r.jsx("a",{className:"inline-flex items-center rounded focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:ge,target:"_blank",rel:"noreferrer noopener","aria-label":"Köp en kaffe (öppnas i ny flik)",children:r.jsx("img",{src:"https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png",alt:"Köp en kaffe",height:"48",className:"h-12",loading:"lazy"})})})]}),r.jsxs("section",{"aria-labelledby":"about-version",className:"mt-8",children:[r.jsxs("h2",{id:"about-version",className:"text-2xl font-semibold",children:[r.jsx("button",{type:"button",className:"inline p-0 m-0 bg-transparent decoration-dotted underline-offset-4 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",onClick:()=>s(!0),"aria-label":"Öppna admin",children:"Om"})," ","versionen"]}),r.jsxs("p",{className:"mt-2",children:["Den här versionen använder skjuthandboken upplaga: ",r.jsx("strong",{children:Se})," (2024)"]}),r.jsxs("p",{className:"mt-2 text-muted-foreground",children:["Version: ",r.jsx("code",{children:se.version})," • Build: ",r.jsx("code",{children:se.number})," • Commit: ",r.jsx("code",{children:se.commit})]}),r.jsxs("p",{className:"mt-1 text-muted-foreground",children:["Byggtid: ",r.jsx("time",{dateTime:se.timeISO,children:new Date(se.timeISO).toLocaleString()})]}),r.jsx("div",{className:"mt-3",children:r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>o("/whats-new",{state:{backgroundLocation:l}}),"aria-label":"Visa vad som är nytt",children:c?"Visa nyheter (Ny)":"Visa nyheter"})})]}),r.jsxs("section",{"aria-labelledby":"about-whatsnew",className:"mt-8",children:[r.jsx("h2",{id:"about-whatsnew",className:"text-2xl font-semibold",children:"Versionsnytt"}),r.jsx("p",{className:"mt-2 text-muted-foreground",children:"Kort sammanfattning av senaste ändringarna. Öppna modalen för en fokuserad vy."}),r.jsx("div",{className:"mt-3 space-y-3",children:Sr.map(e=>r.jsxs("article",{className:"rounded-lg border border-border p-3",children:[r.jsxs("h3",{className:"text-base font-semibold",children:[e.title||"Uppdatering"," • ",e.date," • ",e.id]}),r.jsx("ul",{className:"mt-2 list-disc pl-5 space-y-1 text-sm",children:(e.highlights||[]).map((e,t)=>r.jsx("li",{children:e},t))}),e.link&&r.jsx("p",{className:"mt-2",children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:e.link,target:"_blank",rel:"noreferrer noopener",children:"Läs mer"})})]},e.id))})]}),r.jsxs("section",{"aria-labelledby":"about-license",className:"mt-8",children:[r.jsx("h2",{id:"about-license",className:"text-2xl font-semibold",children:"Licens"}),r.jsxs("p",{className:"mt-2",children:["Denna applikation är licensierad under ",r.jsx("strong",{children:je}),". Se ",r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:`${e}LICENSE`,target:"_blank",rel:"noreferrer noopener",children:"LICENSE"})," för fullständig text."]})]})]}),r.jsx(Nr,{open:n,onClose:()=>s(!1)})]})}function Mr({medal:e,open:n,onClose:s}){const a=W(),{currentProfile:i,unlockMedal:l}=z(),o=!!i?.features?.allowManualUnlock,[c,d]=t.useState(""),u=t.useMemo(()=>{if(!n||!a||!e?.id)return[];try{return a.getEligibleYears(e.id)||[]}catch{return[]}},[n,a,e]),m=t.useMemo(()=>{const e=i?.dateOfBirth;if(!e)return null;const t=new Date(e).getFullYear();return Number.isFinite(t)?t:null},[i]),p=(new Date).getFullYear(),f=t.useMemo(()=>{if(!a||!e)return null;try{return a.getEarliestCountingYearForMedal(e)}catch{return null}},[a,e]),h=t.useMemo(()=>{if(!a||!e)return null;try{return a.getMinimalUnlockYearForSustained(e)}catch{return null}},[a,e]),b=!!i?.features?.enforceCurrentYearForSustained,x=Array.isArray(e?.requirements)&&e.requirements.some(e=>"sustained_achievement"===e?.type),g=t.useCallback(()=>{if(!a||!e)return"";if(b&&x){if(o)return p;if(u?.includes(p))return p}if(!o)return u&&0!==u.length?Math.min(...u):"";const t=(()=>{const e=[];return"number"==typeof f&&e.push(f),"number"==typeof h&&e.push(h),e.length?Math.max(...e):null})(),r=Math.max(Number.isFinite(m)?m:-1/0,Number.isFinite(t)?t:-1/0);for(let n=Number.isFinite(r)?r:p;n<=p;n++)try{const t=a.checkPrerequisites(e,n);if(t?.allMet)return n}catch{}return b&&x?p:""},[o,a,e,u,f,h,m,p,b,x]),y=t.useMemo(()=>{if(!n)return"";const e=g();return""!==e&&Number.isFinite(e)?e:""},[n,g]),v=o?""===c?y:c:null,w=o?""===v?"":Number(v):u.length<=1?u[0]??"":c||(u[0]??""),j=o&&(!Number.isFinite(w)||"number"!=typeof m||w<m||w>p),k=b&&x&&Number.isFinite(w)&&w!==p,N=(()=>{const e=[];return"number"==typeof f&&e.push(f),"number"==typeof h&&e.push(h),0===e.length?null:Math.max(...e)})(),S=o&&Number.isFinite(w)&&"number"==typeof N&&w<N,C=o?!j&&!k&&!S:""!==w,M=t.useMemo(()=>{if(!o)return!0;if(!a||!e?.id||!Number.isFinite(w))return!1;try{const t=a.checkPrerequisites(e,w);return!!t?.allMet}catch{return!1}},[o,a,e,w]),A=o?C&&M:u.length>0&&""!==w,I=async()=>{if(!A)return;const t=`${o?w:Number(w)}-12-31`;await l(e.id,t),s?.()};return r.jsx(ce,{id:"unlock-medal",title:`Lås upp ${e?.displayName||"medalj"}`,open:n,onClose:s,swipeToDismiss:!0,children:o?r.jsxs("form",{className:"space-y-4",onSubmit:e=>{e.preventDefault(),A&&I()},noValidate:!0,children:[r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"unlock-year",className:"field-label mb-2",children:["År","number"==typeof N&&r.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["(Tidigast: ",N,")"]})]}),r.jsx("input",{id:"unlock-year",type:"number",inputMode:"numeric",className:"input py-3 mb-2",min:m??void 0,max:p,list:"eligible-years",value:v,onChange:e=>{const t=e.target.value;d(""===t?"":Number(t))},"aria-invalid":(()=>{if(o&&""!==c&&Number.isFinite(w))return!!(j||k||S||C&&!M)||void 0})(),"aria-describedby":"unlock-year-hint"}),r.jsx("datalist",{id:"eligible-years",children:u.map(e=>r.jsx("option",{value:e},e))}),r.jsxs("p",{id:"unlock-year-hint",className:"field-hint mt-2",children:["Välj ett år mellan ",m," och ",p,". Vi stämmer av med förhandskraven för året."]}),(()=>{if(!o)return null;if(""===c||!Number.isFinite(w))return null;let e=null;return j?e=`Året måste vara mellan ${m} och ${p}.`:k?e="Det här märket kräver att innevarande år väljs.":S?e=`Tidigaste året du kan låsa upp märket är ${N}.`:M||(e=`Förhandskraven är inte mötta för ${w}.`),e?r.jsx("p",{className:"field-hint mt-2 text-danger",role:"status",children:e}):null})()]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:s,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px]",disabled:!A,children:"Lås upp"})]})]}):0===u.length?r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-text-secondary",children:"Inga giltiga år funna."}),r.jsx("div",{className:"flex justify-end",children:r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:s,children:"Stäng"})})]}):1===u.length?r.jsxs("div",{className:"space-y-4",children:[r.jsxs("p",{className:"text-sm",children:["Lås upp för: ",r.jsx("strong",{children:u[0]}),"?"]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:s,children:"Avbryt"}),r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:I,children:"Lås upp"})]})]}):r.jsxs("form",{className:"space-y-4",onSubmit:e=>{e.preventDefault(),""!==w&&I()},noValidate:!0,children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"unlock-year",className:"field-label mb-2",children:"År"}),r.jsx("select",{id:"unlock-year",className:"select py-3",value:w,onChange:e=>d(Number(e.target.value)),children:u.map(e=>r.jsx("option",{value:e,children:e},e))})]}),r.jsxs("div",{className:"flex gap-2 justify-end",children:[r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:s,children:"Avbryt"}),r.jsx("button",{type:"submit",className:"btn btn-primary min-h-[44px]",disabled:""===w,children:"Lås upp"})]})]})})}function Ar({medal:e,open:t,onClose:n,variant:s="confirm",blockingMedals:a=[],onConfirmRemove:i}){const l=`${e?`remove-medal-${e.id}`:"remove-medal"}-${s}`;return r.jsx(ce,{id:l,title:"confirm"===s?"Ta bort upplåsning":"Kan inte ta bort än",open:t,onClose:n,children:"confirm"===s?r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground",children:"Det här påverkar inte andra märken."}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{type:"button",onClick:n,className:"btn btn-muted flex-1 min-h-[44px]",children:"Avbryt"}),r.jsx("button",{type:"button",onClick:async()=>{const e=await(i?.());e?.ok&&n?.()},className:"btn btn-primary flex-1 min-h-[44px]",children:"Ta bort"})]})]}):r.jsxs("div",{className:"space-y-4",children:[r.jsx("p",{className:"text-sm text-muted-foreground",children:"De här upplåsta märkena beror på detta:"}),r.jsx("ul",{className:"text-sm text-muted-foreground list-disc ml-5 space-y-1",children:a.map(e=>r.jsx("li",{className:"break-words",children:e.displayName||e.name},e.id))}),r.jsx("div",{className:"pt-1",children:r.jsx("button",{type:"button",onClick:n,className:"btn btn-muted w-full min-h-[44px]",children:"OK"})})]})})}function Ir(e){const{medalDatabase:r}=K(),{currentProfile:n,lockMedal:s}=z(),a=t.useMemo(()=>function(e=[]){const t=new Map;for(const r of e){const e=Array.isArray(r?.prerequisites)?r.prerequisites:[];for(const n of e)n&&"medal"===n.type&&n.medalId&&(t.has(n.medalId)||t.set(n.medalId,new Set),t.get(n.medalId).add(r.id))}return t}(r?.getAllMedals?.()||[]),[r]),i=t.useMemo(()=>function(e,t){const r=new Set;if(!e||!t)return r;const n=[e];for(;n.length;){const e=n.shift(),s=t.get(e);if(s)for(const t of s)r.has(t)||(r.add(t),n.push(t))}return r}(e,a),[e,a]),l=t.useMemo(()=>new Set((n?.unlockedMedals||[]).map(e=>e.medalId)),[n]),o=t.useMemo(()=>Array.from(i).filter(e=>l.has(e)),[i,l]),c=0===o.length,d=t.useCallback(async()=>{if(!e)return{ok:!1};if(!c)return{ok:!1,blocking:o};return{ok:!!(await s(e))}},[e,c,o,s]);return{canRemove:c,blocking:o,tryRemove:d}}function Tr({met:e}){return r.jsx(me,{name:e?"CheckCircle2":"Circle",className:e?"w-4 h-4 text-foreground shrink-0":"w-4 h-4 text-muted-foreground shrink-0"})}function Pr({id:e,label:t,met:n,summary:s,expanded:a,onToggle:i}){return r.jsxs("button",{type:"button",onClick:i,"aria-expanded":a,"aria-controls":e,className:["w-full text-left inline-flex items-center justify-between","px-2 py-2 rounded","hover:bg-bg-secondary","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","min-h-[44px]"].join(" "),children:[r.jsxs("span",{className:"inline-flex items-center gap-2",children:[r.jsx(Tr,{met:n}),r.jsx("span",{className:"text-sm font-semibold text-foreground",children:t}),s?r.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",s,")"]}):null]}),r.jsx("span",{"aria-hidden":"true",className:"ml-2",children:a?"▼":"▶"})]})}function Er({leaf:e}){const t=e.description||e.type||"Krav",n=e.progress&&Number.isFinite(e.progress.current)&&Number.isFinite(e.progress.required)?`${e.progress.current}/${e.progress.required}`:null,s=null!=e.windowYear?e.windowYear:null!=e.subtreeYear?e.subtreeYear:null,a=null!=s?`• År ${s}`:null;return r.jsxs("div",{className:"px-2 py-1 flex items-start gap-2",children:[r.jsx(Tr,{met:!!e.isMet}),r.jsxs("span",{className:(e.isMet?"text-foreground":"text-muted-foreground")+" flex-1 min-w-0",children:[t," ",a?r.jsx("span",{className:"text-xs text-muted-foreground",children:a}):null]}),n?r.jsx("span",{className:"ml-auto shrink-0 text-xs text-muted-foreground tabular-nums",children:n}):null]})}function Dr(e=[]){const t=e.length;return{met:e.reduce((e,t)=>e+(t.isMet?1:0),0),total:t}}function Fr({node:e,path:n="root",level:s=0,defaultExpanded:a=0===s}){const[i,l]=t.useState(a),o=`${n}-group`,c="and"===e?.node||"or"===e?.node;if(!e)return null;const d=s>0?"border-l border-border pl-3":"pl-0";if(c){const t=e.children||[];if(1===t.length)return r.jsx(Fr,{node:t[0],path:n,level:s,defaultExpanded:a})}if(!c){const t=e.leaf||{isMet:!1,description:"Okänt krav"};if(t.subtree){const e=`${n}-leaf`,a=t.subtree,o=a&&("and"===a.node||"or"===a.node),c=Array.isArray(a?.children),u=o&&c&&1===a.children.length;if(!o||u)return r.jsx("li",{className:d,children:r.jsx(Fr,{node:t.subtree,path:`${n}-sub`,level:s,defaultExpanded:s<1})});let m=null;const p="and"===a.node?"Alla följande":"Minst en av följande",f=t.description||p;if(c){const{met:e,total:r}=Dr(a.children),n=`${e}/${r} uppfyllda`;m=t.description?`${p} • ${n}`:n}return r.jsxs("li",{className:d,children:[r.jsx(Pr,{id:e,label:f,met:!!t.isMet,summary:m,expanded:i,onToggle:()=>l(e=>!e)}),i&&r.jsx("ul",{id:e,role:"group",className:"ml-2 list-none m-0 p-0",children:(Array.isArray(a.children)?a.children:[]).map((e,t)=>r.jsx(Fr,{node:e,path:`${n}-sub-${t}`,level:s+1,defaultExpanded:s<1},`${n}-sub-${t}`))})]})}return r.jsx("li",{className:d,children:r.jsx(Er,{leaf:t})})}const u=e.children||[],{met:m,total:p}=Dr(u),f="and"===e.node?"Alla följande":"Minst en av följande",h=`${m}/${p} uppfyllda`;return r.jsxs("li",{className:d,children:[r.jsx(Pr,{id:o,label:f,met:!!e.isMet,summary:h,expanded:i,onToggle:()=>l(e=>!e)}),i&&r.jsx("ul",{id:o,role:"group",className:"ml-2 list-none m-0 p-0",children:u.map((e,t)=>r.jsx(Fr,{node:e,path:`${n}-${t}`,level:s+1,defaultExpanded:s<1},`${n}-${t}`))})]})}function $r({tree:e,bare:n=!1}){const s=t.useMemo(()=>{let t=e||null;for(;t&&("and"===t.node||"or"===t.node)&&Array.isArray(t.children)&&1===t.children.length;)t=t.children[0];return t},[e]);if(!s)return null;const a="and"===s.node,i=r.jsx("ul",{className:"list-none m-0 p-0 text-sm text-muted-foreground space-y-1",children:a?(s.children||[]).map((e,t)=>r.jsx(Fr,{node:e,path:`root-${t}`,level:0,defaultExpanded:!0},`root-${t}`)):r.jsx(Fr,{node:s,level:0,defaultExpanded:!0})});return n?i:r.jsx("div",{className:"bg-background border border-border rounded p-3",role:"region","aria-label":"Krav",children:i})}function _r({id:e,title:n,summary:s,collapsible:a=!1,defaultOpen:i=!0,children:l}){const o=t.useId(),c=e?`${e}-body`:`${o}-body`,[d,u]=t.useState(i),m=a?"button":"div",p=a?{type:"button",onClick:()=>u(e=>!e),"aria-expanded":d,"aria-controls":c}:{};return r.jsxs("div",{className:"mb-4 bg-background border border-border rounded",children:[r.jsxs(m,{...p,className:"w-full text-left px-3 py-2 flex items-center justify-between hover:bg-bg-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary rounded-t min-h-[44px]",children:[r.jsx("span",{className:"text-sm font-semibold text-foreground",children:n}),r.jsxs("span",{className:"inline-flex items-center gap-2 text-xs text-muted-foreground",children:[s?r.jsxs("span",{children:["(",s,")"]}):null,a?r.jsx("span",{"aria-hidden":"true",children:d?"▼":"▶"}):null]})]}),(!a||d)&&r.jsx("div",{id:c,className:"px-3 pb-3",children:l})]})}function Yr({status:e,className:t="",id:n,...s}){const a=rr(e);return a?r.jsxs("span",{id:n,className:`${a.className} ${t}`.trim(),title:a.description,"aria-label":`${a.label}. ${a.description}`,...s,children:[r.jsx(me,{name:a.icon,className:"w-4 h-4"}),r.jsx("span",{children:a.label})]}):null}const qr=t.lazy(()=>e(()=>import("./vendor-BYCxJfch.js").then(e=>e.q),[]));function Lr({medalId:e,onClose:n,onNavigateMedal:s}){const{medalDatabase:l}=K(),o=H(),c=W(),{currentProfile:d}=z(),u=!!d?.features?.allowManualUnlock,m=l?.getMedalById(e),[p,f]=t.useState(!1),h=i(),b=a(),x=m?`medal-req-original-${m.id}`:void 0,g=m?`medal-unlock-targets-${m.id}`:void 0,{canRemove:v,blocking:w,tryRemove:j}=Ir(e),[k,N]=t.useState(!1),[S,C]=t.useState(!1),M=t.useMemo(()=>o&&(o.unlocked.find(t=>t.medalId===e)||o.eligible.find(t=>t.medalId===e)||o.available.find(t=>t.medalId===e)||o.locked.find(t=>t.medalId===e))||null,[o,e]),A=t.useMemo(()=>"unlocked"!==M?.status?null:M?.unlockedDate||c?.getUnlockedDate?.(e)||null,[M,c,e]),I=t.useMemo(()=>{if(!A)return null;const e=new Date(A);return Number.isNaN(e.getTime())?null:e.getFullYear()},[A]),T=t.useMemo(()=>{if(!m)return null;const e=M?.details?.tree;if(e)return e;try{return c?.checkRequirements?.(m)?.tree??null}catch{return null}},[c,m,M]),P=t.useMemo(()=>{if(!T)return null;const e={met:0,total:0},t=r=>{if(r){if("leaf"===r.node)return e.total+=1,void(r.leaf?.isMet&&(e.met+=1));for(const e of r.children||[])t(e)}};return t(T),e},[T]),E=t.useMemo(()=>{if(!c||!m)return{allMet:!0,items:[],missingItems:[]};try{return c.checkPrerequisites(m)}catch{return{allMet:!0,items:[],missingItems:[]}}},[c,m]),D=t.useMemo(()=>{const e=new Set;for(const t of E.missingItems||[])t&&"medal"===t.type&&t.offsetChecked&&e.add(t.medalId);return e},[E]),F=t.useMemo(()=>(E.items||[]).map(e=>{if("medal"===e.type){const t=l?.getMedalById?.(e.medalId),r=D.has(e.medalId);return{...e,displayName:t?.displayName||t?.name||e.medalId,displayMet:e.isMet&&!r,gapFailed:r}}return e}),[E,D,l]),$=t.useMemo(()=>{const e=F||[],t=e.length;return{met:e.reduce((e,t)=>e+(t.displayMet?1:0),0),total:t}},[F]),_=!0===E?.allMet,Y=m?`unlock-prereq-hint-${m.id}`:void 0,q=t.useMemo(()=>(w||[]).map(e=>l?.getMedalById(e)).filter(Boolean),[w,l]),L=t.useMemo(()=>(Array.isArray(m?.references)?m.references:[]).map(e=>{const t=l?.getMedalById?.(e.medalId);return t?{target:t,description:e.description||""}:null}).filter(Boolean),[m,l]),R=t.useMemo(()=>{if(!m||!l?.getAllMedals)return[];return l.getAllMedals().filter(e=>e?.id!==m.id&&Array.isArray(e?.prerequisites)&&e.prerequisites.some(e=>"medal"===e?.type&&e.medalId===m.id)).map(e=>({target:e}))},[m,l]),O=t.useRef(null),B=t.useRef(null),U=t.useRef(null),G=`medal-detail-title-${e||"unknown"}`,V=!!m&&("function"==typeof m.isPlaceholder?m.isPlaceholder():"placeholder"===m.status),X=!(!m||V)&&("function"==typeof m.isUnderReview?m.isUnderReview():"under_review"===m.status),J=m?.description?`medal-detail-desc-${e||"unknown"}`:null,Z=X&&m?`under-review-note-${m.id}`:null,Q=V&&m?`placeholder-note-${m.id}`:null,ee=[J,Z,Q].filter(Boolean).join(" ")||void 0;if(t.useEffect(()=>{if(!m)return;U.current="undefined"!=typeof document?document.activeElement:null;const e="undefined"!=typeof document?document.body:null,t=e?e.style.overflow:"";e&&(e.style.overflow="hidden");const r=B.current;r&&(r.classList.remove("translate-y-full","sm:translate-x-full"),r.classList.add("translate-y-0","sm:translate-x-0"));const s=setTimeout(()=>{const e=B.current?.querySelector(`#${G}`);e&&e.focus?e.focus():B.current?.focus()},0),a=e=>{"Escape"===e.key&&(e.preventDefault(),n?.())};return window.addEventListener("keydown",a),()=>{clearTimeout(s),window.removeEventListener("keydown",a),e&&(e.style.overflow=t);const r=U.current;if(r&&"function"==typeof r.focus)try{r.focus()}catch{}}},[n,G,m]),t.useEffect(()=>{if(!m)return;if("undefined"==typeof document)return;const t=document.title,r=m.displayName||m.name||String(e);try{document.title=`${r} - Detaljer`}catch{}return()=>{try{document.title=t}catch{}}},[m,e]),!m)return null;const te={ul:e=>r.jsx("ul",{className:"list-disc pl-5 my-2 space-y-1",...e}),ol:e=>r.jsx("ol",{className:"list-decimal pl-5 my-2 space-y-1",...e}),li:e=>r.jsx("li",{className:"marker:text-muted-foreground",...e}),table:e=>r.jsx("div",{className:"my-2 overflow-x-auto",children:r.jsx("table",{className:"w-full text-sm border-collapse",...e})}),thead:e=>r.jsx("thead",{className:"bg-bg-secondary",...e}),th:e=>r.jsx("th",{className:"border border-border px-2 py-1 text-left font-semibold",...e}),td:e=>r.jsx("td",{className:"border border-border px-2 py-1 align-top",...e}),a:({href:e,children:t,...n})=>r.jsx("a",{href:e,className:"underline text-primary hover:text-primary-hover",target:"_blank",rel:"noopener noreferrer",...n,children:t}),code:e=>r.jsx("code",{className:"px-1 py-0.5 rounded bg-bg-secondary",...e})},re=e=>t=>{if(!!(0!==t.button||t.metaKey||t.ctrlKey||t.altKey||t.shiftKey))return;if(t.preventDefault(),"function"==typeof s)return void s(e);const r=b.state?.backgroundLocation;h(`/medals/${e}`,{state:r?{backgroundLocation:r}:void 0})};return r.jsxs("div",{ref:O,onClick:e=>{e.target===O.current&&n?.()},className:"fixed inset-0 z-50 bg-black/50",children:[r.jsx("div",{ref:B,role:"dialog","data-tour":"medal-detail-panel","aria-modal":"true","aria-labelledby":G,"aria-describedby":ee,tabIndex:-1,onKeyDown:e=>{if("Tab"!==e.key)return;const t=B.current;if(!t)return;const r=t.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');if(0===r.length)return void e.preventDefault();const n=r[0],s=r[r.length-1],a=document.activeElement;e.shiftKey&&a===n?(e.preventDefault(),s.focus()):e.shiftKey||a!==s||(e.preventDefault(),n.focus())},className:["pointer-events-auto fixed","inset-x-0 bottom-0 w-full h-[90svh] max-h-[90vh]","sm:inset-y-0 sm:right-0 sm:left-auto sm:w-[32rem] sm:h-full","bg-bg-secondary shadow-2xl overflow-hidden","rounded-t-2xl sm:rounded-none sm:rounded-l-2xl","transform transition-transform duration-200 ease-out motion-reduce:transition-none","translate-y-full sm:translate-y-0 sm:translate-x-full","focus:outline-none"].join(" "),children:r.jsxs("div",{className:"flex h-full flex-col",children:[r.jsxs("div",{className:"sticky top-0 z-10 flex items-start justify-between gap-4 p-4 sm:p-6 bg-bg-secondary border-b border-border",children:[r.jsx("div",{className:"min-w-0",children:r.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[r.jsx("h2",{id:G,"data-tour":"medal-detail-title",className:"text-xl sm:text-2xl font-bold text-foreground focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary break-words",tabIndex:-1,children:m.displayName}),r.jsx("div",{role:"status","aria-live":"polite",className:"mt-1 sm:mt-0",children:V?r.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-900 border border-indigo-300 dark:bg-indigo-900/30 dark:text-indigo-200 dark:border-indigo-700","aria-label":"Status: plats­hållare",children:[r.jsx(Ke,{status:"placeholder",className:"w-3.5 h-3.5"}),"Plats­hållare"]}):r.jsx(Yr,{status:M?.status||"locked"})}),X&&r.jsxs("span",{className:"mt-1 sm:mt-0 inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-900 border border-amber-300 dark:bg-amber-900/40 dark:text-amber-200 dark:border-amber-700","aria-label":"Status för regler: under granskning",children:[r.jsx(Ke,{status:"review",className:"w-3.5 h-3.5"}),"Under granskning"]})]})}),r.jsx("button",{onClick:n,className:"shrink-0 inline-flex h-10 w-10 items-center justify-center rounded-md text-foreground hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary","aria-label":"Stäng medal-detaljer",title:"Stäng",children:r.jsx("span",{"aria-hidden":"true",children:"✕"})})]}),r.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto overscroll-contain p-4 sm:p-6",children:[r.jsx("div",{className:"mb-4",children:r.jsx(Te,{id:"disclaimer-rules",variant:"warning",text:"Regelboken gäller före appens tolkning. Kontrollera alltid senaste officiella regelbok.",linkUrl:ye})}),V&&r.jsxs(r.Fragment,{children:[r.jsx("p",{id:Q,className:"sr-only",children:"Detta är ett platshållarmärke. Avsnitten nedan visar exempel på information som kommer att finnas här när märket publiceras."}),r.jsx(_r,{id:`placeholder-unlocked-${m.id}`,title:"Upplåst",collapsible:!1,children:r.jsx("p",{className:"text-sm text-muted-foreground",children:"Här visas normalt vilket år du låste upp märket."})}),r.jsx(_r,{id:`placeholder-prereq-${m.id}`,title:"Förhandskrav",collapsible:!1,children:r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[r.jsx("li",{children:"• Exempel: krav eller förkunskap 1"}),r.jsx("li",{children:"• Exempel: krav eller förkunskap 2"}),r.jsx("li",{children:"• Exempel: krav eller förkunskap 3"})]})}),r.jsx(_r,{id:`placeholder-req-${m.id}`,title:"Krav",collapsible:!1,children:r.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[r.jsxs("li",{children:[r.jsx("span",{className:"text-foreground",children:"✓"})," Exempel: uppfyllt krav"]}),r.jsxs("li",{children:[r.jsx("span",{className:"text-muted-foreground",children:"○"})," Exempel: krav som återstår"]}),r.jsxs("li",{children:[r.jsx("span",{className:"text-muted-foreground",children:"○"})," Exempel: ytterligare krav"]})]})}),r.jsx(_r,{id:J||`placeholder-desc-${m.id}`,title:"Beskrivning",collapsible:!1,children:r.jsx("p",{className:"text-muted-foreground break-words",children:"Beskrivning kommer att visas här när innehållet är klart."})}),r.jsx(_r,{id:x,title:"Visa ursprunglig kravtext",collapsible:!0,defaultOpen:!1,children:r.jsx("div",{className:"text-sm text-foreground break-words",children:r.jsx(t.Suspense,{fallback:null,children:r.jsx(qr,{remarkPlugins:[y],components:te,children:"Det här avsnittet visar vanligtvis den ursprungliga kravtexten från regelboken.\n\n- Exempelpunkt 1\n- Exempelpunkt 2\n- Exempelpunkt 3"})})})}),r.jsx(_r,{id:`placeholder-refs-${m.id}`,title:"Uppfyller också kraven för",collapsible:!1,children:r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:r.jsx("li",{children:"• Kommer snart"})})}),r.jsx(_r,{id:`placeholder-required-for-${m.id}`,title:"Detta märke krävs för",collapsible:!1,children:r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:r.jsx("li",{children:"• Kommer snart"})})})]}),!V&&null!=I&&r.jsx(_r,{id:`unlocked-${m.id}`,title:"Upplåst",collapsible:!1,children:r.jsx("div",{role:"status","aria-live":"polite",children:r.jsx("p",{className:"text-sm text-foreground",children:r.jsx("time",{dateTime:function(){try{return new Date(A).toISOString().slice(0,10)}catch{return String(A)}}(),children:I})})})}),!V&&F.length>0&&r.jsx(_r,{id:`prereq-${m.id}`,title:"Förhandskrav",summary:`${$.met}/${$.total} uppfyllda`,collapsible:!1,children:r.jsx("ul",{className:"list-none m-0 p-0 text-sm text-muted-foreground space-y-1",children:F.map((e,t)=>r.jsxs("li",{className:"flex items-start gap-2",children:[r.jsx(me,{name:e.displayMet?"CheckCircle2":"Circle",className:e.displayMet?"w-4 h-4 text-foreground shrink-0":"w-4 h-4 text-muted-foreground shrink-0"}),r.jsx("span",{className:"sr-only",children:e.displayMet?"Uppfyllt":"Saknas"}),r.jsx("span",{className:"text-foreground flex-1 min-w-0 break-words",children:"medal"===e.type?e.displayName||e.medalId:e.description||e.type}),"medal"===e.type&&"number"==typeof e.yearOffset?r.jsxs("span",{className:e.gapFailed?"text-danger":"text-muted-foreground",children:["Kräver ",e.yearOffset," års gap"]}):null]},t))})}),X&&r.jsx("div",{id:`under-review-note-${m.id}`,className:"mb-4 alert alert-warning",children:"Reglerna för det här märket är under granskning och kan komma att ändras."}),!V&&m.description&&r.jsx("div",{className:"mb-4",children:r.jsx("p",{id:J,className:"text-muted-foreground break-words",children:m.description})}),!V&&M?.details?.missingItems?.length>0&&r.jsxs("div",{className:"mb-4 bg-background border border-border rounded p-3",children:[r.jsx("p",{className:"text-sm font-semibold text-foreground mb-2",children:"Saknade förhandskrav:"}),r.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:M.details.missingItems.map((e,t)=>r.jsxs("li",{className:"break-words",children:["• ",e.description]},t))})]}),!V&&T&&r.jsx(_r,{id:`req-${m.id}`,title:"Krav",summary:P?`${P.met}/${P.total} uppfyllda`:void 0,collapsible:!1,children:r.jsx($r,{tree:T,bare:!0})}),!V&&m.requirementsOriginal&&r.jsx(_r,{id:x,title:"Visa ursprunglig kravtext",collapsible:!0,defaultOpen:!1,children:r.jsx("div",{className:"text-sm text-foreground break-words",children:r.jsx(t.Suspense,{fallback:null,children:r.jsx(qr,{remarkPlugins:[y],components:te,children:m.requirementsOriginal})})})}),!V&&L.length>0&&r.jsx(_r,{id:`refs-${m.id}`,title:"Uppfyller också kraven för",summary:`${L.length}`,collapsible:!0,defaultOpen:!1,children:r.jsx("ul",{className:"space-y-1",children:L.map(({target:e})=>r.jsx("li",{children:r.jsx("a",{href:`/medals/${e.id}`,onClick:re(e.id),className:"inline-flex items-center underline text-primary hover:text-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary px-2 py-2 rounded min-h-[44px]",children:e.displayName||e.name})},e.id))})}),!V&&R.length>0&&r.jsx(_r,{id:g,title:"Detta märke krävs för",summary:`${R.length}`,collapsible:!0,defaultOpen:!1,children:r.jsx("ul",{className:"space-y-1",children:R.map(({target:e})=>r.jsx("li",{children:r.jsx("a",{href:`/medals/${e.id}`,onClick:re(e.id),className:"inline-flex items-center underline text-primary hover:text-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary px-2 py-2 rounded min-h-[44px]",children:e.displayName||e.name})},e.id))})})]}),r.jsxs("div",{className:"flex gap-3 p-4 sm:p-6 border-t border-border pb-[calc(env(safe-area-inset-bottom)+1rem)]",children:[r.jsx("button",{onClick:n,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-background text-foreground hover:bg-bg-secondary ring-1 ring-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Stäng"}),"unlocked"===M?.status&&d&&!V&&r.jsxs("div",{className:"flex-1 flex items-center gap-2",children:[r.jsx("button",{type:"button",onClick:()=>{v?(C(!1),N(!0)):(N(!1),C(!0))},"aria-haspopup":"dialog","aria-expanded":k||S,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-background text-foreground hover:bg-bg-secondary ring-1 ring-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Ta bort upplåst"}),!v&&r.jsx("button",{type:"button",onClick:()=>C(!0),className:"text-sm text-muted-foreground underline","aria-label":"Why can’t I remove this medal?",children:"Varför kan jag inte?"})]}),d&&!V&&("eligible"===M?.status||u&&"unlocked"!==M?.status)&&r.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[r.jsx("button",{type:"button",onClick:()=>f(!0),"aria-haspopup":"dialog","aria-controls":"unlock-medal",disabled:!_,"aria-disabled":!_,"aria-describedby":_?void 0:Y,className:"flex-1 min-h-[44px] px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary-hover disabled:opacity-60 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-bg-secondary",children:"Lås upp nu"}),!_&&r.jsx("p",{id:Y,className:"text-xs text-muted-foreground",children:"Förhandskraven måste uppnåst innan märket kan låsas upp."})]})]})]})}),r.jsx(Mr,{medal:m,open:p,onClose:()=>f(!1)}),r.jsx(Ar,{medal:m,open:k,onClose:()=>N(!1),variant:"confirm",onConfirmRemove:j}),r.jsx(Ar,{medal:m,open:S,onClose:()=>C(!1),variant:"blocked",blockingMedals:q})]})}function Rr({children:e}){const{currentProfile:t}=z(),n=i(),[s,a]=x.useState(!1),[l,o]=x.useState(!0);return t&&!t.isGuest?e:r.jsxs("div",{className:"p-6",children:[r.jsxs("div",{className:"card block p-6 w-full min-w-full max-w-xl mx-auto",role:"region","aria-labelledby":"profile-required-heading",children:[r.jsx("h2",{id:"profile-required-heading",className:"section-title mb-2",children:"Profil krävs för att fortsätta"}),r.jsxs("div",{className:"text-sm text-muted-foreground space-y-3 mb-4",children:[r.jsx("p",{children:"För att använda Inställningar och import/export behöver du en sparad profil."}),r.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[r.jsx("li",{children:"Spara dina framsteg och säkerhetskopiera data"}),r.jsx("li",{children:"Hantera inställningar per profil"}),r.jsx("li",{children:"Exportera och importera mellan enheter"})]}),t?.isGuest&&r.jsx("p",{children:"Du kan spara ditt nuvarande Gästläge som en profil och fortsätta utan att förlora något."})]}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",autoFocus:!0,onClick:()=>{o(!0),a(!0)},"aria-haspopup":"dialog","aria-controls":"save-progress-picker-guard",children:"Skapa profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>{o(!1),a(!0)},"aria-haspopup":"dialog","aria-controls":"save-progress-picker-guard",children:"Välj profil"}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:()=>n("/medals"),children:"Tillbaka till märken"})]})]}),r.jsx(ue,{id:"save-progress-picker-guard",mode:"picker",open:s,onClose:()=>a(!1),forceCreate:l,convertGuest:!0})]})}function Or(){const e=i(),n=a(),s=n.state?.backgroundLocation,l=kt(),o=t.useMemo(()=>function(e){const t=[...Sr].sort((e,t)=>{const r=String(e.id).split(".").map(e=>parseInt(e,10)||0),n=String(t.id).split(".").map(e=>parseInt(e,10)||0);for(let s=0;s<3;s++)if(r[s]!==n[s])return n[s]-r[s];return 0});if(!e)return t;const r=t.findIndex(t=>t.id===e);return r<=0?t:t.slice(0,r)}(Nt()),[]),c=t.useRef(null),d=t.useRef(null),u=t.useCallback(()=>{if(function(e){try{e&&localStorage.setItem(jt,e)}catch{}}(l),s&&s.pathname){const t=`${s.pathname}${s.search||""}${s.hash||""}`;e(t,{replace:!0})}else e(-1)},[l,s,e]);t.useEffect(()=>{d.current=document.activeElement;const e=c.current;if(!e)return;const t=()=>e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),r=e=>{const r=t(),n=r[0],s=r[r.length-1];if("Escape"===e.key)e.preventDefault(),u();else if("Tab"===e.key){if(0===r.length)return;e.shiftKey&&document.activeElement===n?(e.preventDefault(),s?.focus()):e.shiftKey||document.activeElement!==s||(e.preventDefault(),n?.focus())}},n=t();return n[0]?.focus(),e.addEventListener("keydown",r),()=>{e.removeEventListener("keydown",r),d.current&&"function"==typeof d.current.focus&&d.current.focus()}},[u]);const m=o[0]?.link||null,p=o.length>1?`Det finns ${o.length} uppdateringar sedan du senast tittade.`:"Här är det senaste som är nytt i appen.";return r.jsxs("div",{className:"fixed inset-0 z-50",onMouseDown:e=>{e.target===e.currentTarget&&u()},"aria-hidden":!1,children:[r.jsx("div",{className:"absolute inset-0 bg-black/50"}),r.jsx("div",{ref:c,role:"dialog","aria-modal":"true","aria-labelledby":"whatsnew-title","aria-describedby":"whatsnew-desc",className:["card","fixed inset-x-0 bottom-0 w-full max-h-[85vh] rounded-t-2xl shadow-lg","md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2","md:w-[min(90vw,640px)] md:rounded-xl","outline-none"].join(" "),tabIndex:-1,children:r.jsxs("div",{className:"p-4 sm:p-6",children:[r.jsxs("header",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{children:[r.jsx("h2",{id:"whatsnew-title",className:"text-xl font-semibold",children:"Nyheter"}),r.jsx("p",{id:"whatsnew-desc",className:"mt-1 text-sm text-muted-foreground",children:p})]}),r.jsx("button",{type:"button",className:"btn btn-muted","aria-label":"Stäng nyheter",onClick:u,children:"Stäng"})]}),r.jsx("div",{className:"mt-4 space-y-3 overflow-y-auto pr-1",style:{maxHeight:"55vh"},children:o.map((e,t)=>r.jsxs("details",{className:"rounded-lg border border-border p-3",open:0===t,children:[r.jsxs("summary",{className:"cursor-pointer select-none font-medium",children:[e.title||"Uppdatering"," • ",e.date," • ",e.id]}),r.jsx("ul",{className:"mt-2 list-disc pl-5 space-y-1 text-sm",children:(e.highlights||[]).map((e,t)=>r.jsx("li",{children:e},t))}),e.link&&r.jsx("div",{className:"mt-2",children:r.jsx("a",{className:"text-primary underline underline-offset-2 hover:no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-bg-primary focus-visible:ring-primary",href:e.link,target:"_blank",rel:"noreferrer",children:"Läs mer"})})]},e.id))}),r.jsxs("div",{className:"mt-4 flex items-center justify-end gap-3 safe-bottom",children:[m&&r.jsx("a",{className:"btn btn-secondary",href:m,target:"_blank",rel:"noreferrer",children:"Läs mer"}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:u,children:"Ok, visa appen"})]})]})})]})}function Br(e,t,r){return Math.max(t,Math.min(r,e))}function Ur(e){if(!e)return null;try{return document.querySelector(e)}catch{return null}}function Gr(){const{open:e,stepIndex:n,steps:s,complete:a,next:i,back:l}=pe(),o=s?.[n]||null,c=t.useRef(null),d=t.useRef(null),[u,m]=t.useState(null),[p,f]=t.useState(!1),h=t.useCallback(()=>{if(!e)return;if("undefined"==typeof document)return;const t=Ur(o?.target);if(!t)return m(null),void f(!1);f(!0);try{t.scrollIntoView({block:"center",inline:"nearest"})}catch{}const r=t.getBoundingClientRect();m({top:r.top,left:r.left,width:r.width,height:r.height,right:r.right,bottom:r.bottom})},[e,o?.target]),b=n>=(s?.length||1)-1,x=t.useMemo(()=>`tour-title-${o?.id||n}`,[o?.id,n]),g=t.useMemo(()=>`tour-desc-${o?.id||n}`,[o?.id,n]),y=t.useMemo(()=>`tour-hint-${o?.id||n}`,[o?.id,n]),v=t.useCallback(()=>{a()},[a]),w=t.useCallback(()=>{a()},[a]),j=!!o?.requiresTarget&&!p,k=t.useCallback(()=>{j||(b?a():i())},[j,b,a,i]),N=t.useCallback(()=>{if("undefined"!=typeof document&&"detail"===o?.id){const e=Ur('button[aria-label="Stäng medal-detaljer"]');e?.click?.()}l()},[l,o?.id]);if(t.useEffect(()=>{if(!e)return;if("undefined"==typeof document)return;d.current=document.activeElement;const t=c.current;if(!t)return;const r=()=>t.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),n=e=>{if("Escape"===e.key)return e.preventDefault(),void v();if("Tab"!==e.key)return;const t=r();if(!t.length)return void e.preventDefault();const n=t[0],s=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),s?.focus()):e.shiftKey||document.activeElement!==s||(e.preventDefault(),n?.focus())},s=r();return(s[0]||t)?.focus?.(),t.addEventListener("keydown",n),()=>{t.removeEventListener("keydown",n);const e=d.current;if(e&&"function"==typeof e.focus)try{e.focus()}catch{}}},[e,v]),t.useEffect(()=>{if(!e)return;if("undefined"==typeof window)return;const t=window.requestAnimationFrame(()=>h()),r=window.requestAnimationFrame(()=>h()),n=window.setTimeout(()=>h(),220);let s=0;const a=()=>{s||(s=window.requestAnimationFrame(()=>{s=0,h()}))},i=()=>a();window.addEventListener("resize",i);const l=Ur(o?.target),c=l?function(e){if("undefined"==typeof window||!e)return null;let t=e;for(;t&&t!==document.body;){const e=window.getComputedStyle(t).overflowY;if("auto"===e||"scroll"===e)return t;t=t.parentElement}return window}(l):null;return c&&c!==window?c.addEventListener("scroll",a,{passive:!0}):window.addEventListener("scroll",a,!0),()=>{window.cancelAnimationFrame(t),window.cancelAnimationFrame(r),window.clearTimeout(n),window.removeEventListener("resize",i),c&&c!==window?c.removeEventListener("scroll",a):window.removeEventListener("scroll",a,!0),s&&window.cancelAnimationFrame(s)}},[e,n,o?.target,h]),t.useEffect(()=>{if(!e)return;if(b)return;if("undefined"==typeof document)return;const t=o?.autoAdvanceToNextOn;if(!t)return;const r=()=>{Ur(t)&&i()};r();const n=new MutationObserver(()=>r());return n.observe(document.body,{childList:!0,subtree:!0}),()=>n.disconnect()},[e,b,o?.autoAdvanceToNextOn,i]),!e||!o)return null;const S=(()=>{if(!u)return null;if("undefined"==typeof window)return null;const e=window.innerWidth,t=window.innerHeight;if(e<768)return null;const r="detail"===o?.id;return{position:"fixed",top:Br(r?u.top:u.bottom+10,12,t-12-220),left:Br(r?u.left-10-360:u.left,12,e-12-360),width:360}})(),C=u?{position:"fixed",top:Math.max(0,u.top-6),left:Math.max(0,u.left-6),width:Math.max(0,u.width+12),height:Math.max(0,u.height+12),borderRadius:12,boxShadow:"0 0 0 9999px rgba(0,0,0,0.55)",pointerEvents:"none"}:null;return r.jsxs("div",{className:"fixed inset-0 z-50 pointer-events-none","aria-hidden":!1,children:[C?r.jsx("div",{"aria-hidden":"true",style:C}):r.jsx("div",{className:"absolute inset-0 bg-black/50","aria-hidden":"true"}),r.jsx("div",{ref:c,role:"dialog","aria-modal":"true","aria-labelledby":x,"aria-describedby":j?`${g} ${y}`:g,tabIndex:-1,className:["card","pointer-events-auto",S?"rounded-xl shadow-lg":"fixed inset-x-0 bottom-0 w-full max-h-[85vh] rounded-t-2xl shadow-lg",S?"":"md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[min(90vw,520px)] md:rounded-xl","outline-none"].join(" "),style:S||void 0,children:r.jsxs("div",{className:"p-4 sm:p-6",children:[r.jsxs("header",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{className:"min-w-0",children:[r.jsx("h2",{id:x,className:"text-lg sm:text-xl font-semibold text-foreground",children:o.title}),r.jsx("p",{id:g,className:"mt-1 text-sm text-muted-foreground",children:o.body}),j&&r.jsx("p",{id:y,className:"mt-2 text-xs text-muted-foreground",children:"Öppna en medalj för att fortsätta."})]}),r.jsx("button",{type:"button",className:"btn btn-muted min-h-[44px]",onClick:v,"aria-label":"Avsluta guiden",children:"Stäng"})]}),r.jsxs("div",{className:"mt-4 flex items-center justify-between gap-3",children:[r.jsxs("div",{className:"text-xs text-muted-foreground","aria-live":"polite",children:["Steg ",n+1," av ",s.length]}),r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:w,children:"Hoppa över"})]}),r.jsxs("div",{className:"mt-4 flex items-center justify-end gap-2 safe-bottom",children:[r.jsx("button",{type:"button",className:"btn btn-secondary min-h-[44px]",onClick:N,disabled:0===n,"aria-disabled":0===n,children:"Tillbaka"}),r.jsx("button",{type:"button",className:"btn btn-primary min-h-[44px]",onClick:k,disabled:j,"aria-disabled":j,children:b?"Klart":"Nästa"})]})]})})]})}function Vr(){const{id:e}=k(),t=i(),n=a(),s=n.state?.backgroundLocation;return r.jsx(Lr,{medalId:e,onClose:()=>{if(s&&s.pathname){const e=`${s.pathname}${s.search||""}${s.hash||""}`;t(e,{replace:!0})}else t(-1)}})}function Kr(){const e=a(),n=i(),s=e.state?.backgroundLocation,l=e.pathname.startsWith("/medals/"),o="/whats-new"===e.pathname,c=(l||o)&&s?s:e,d=t.useRef(!1);return t.useEffect(()=>{if(d.current)return;if(d.current=!0,!St())return;const t=kt();if(Nt()===t)return;const r=setTimeout(()=>{n("/whats-new",{replace:!0,state:{backgroundLocation:e}})},700);return()=>clearTimeout(r)},[e,n]),r.jsxs(r.Fragment,{children:[r.jsx(w,{location:c,children:r.jsxs(j,{path:"/",element:r.jsx(Ie,{}),children:[r.jsx(j,{index:!0,element:r.jsx(Pe,{})}),r.jsx(j,{path:"skill-tree",element:r.jsx(dt,{})}),r.jsx(j,{path:"skill-tree/fullscreen",element:r.jsx(dt,{})}),r.jsx(j,{path:"medals",element:r.jsx(Mt,{})}),r.jsx(j,{path:"medals/:id",element:r.jsx(Mt,{})}),r.jsx(j,{path:"settings",element:r.jsx(Rr,{children:r.jsx(sr,{})})}),r.jsx(j,{path:"data",element:r.jsx(Rr,{children:r.jsx(kr,{})})}),r.jsx(j,{path:"about",element:r.jsx(Cr,{})}),r.jsx(j,{path:"whats-new",element:r.jsx(Or,{})})]})}),l&&s&&r.jsx(w,{children:r.jsx(j,{path:"/medals/:id",element:r.jsx(Vr,{})})}),o&&s&&r.jsx(w,{children:r.jsx(j,{path:"/whats-new",element:r.jsx(Or,{})})}),r.jsx(Gr,{})]})}function zr(){const e="undefined"!=typeof document&&document.querySelector("base")?.getAttribute("href")||"/";return t.useEffect(()=>{if("undefined"==typeof window||!("matchMedia"in window))return;const e=window.matchMedia("(prefers-color-scheme: dark)"),t=e=>{document.documentElement.classList.toggle("dark",e)};t(e.matches);const r=e=>t(e.matches);return e.addEventListener?.("change",r),()=>e.removeEventListener?.("change",r)},[]),r.jsx(E,{children:r.jsx(B,{children:r.jsx(re,{children:r.jsx(X,{children:r.jsx(Z,{children:r.jsx(oe,{children:r.jsx(v,{basename:e,children:r.jsx(Kr,{})})})})})})})})}N.createRoot(document.getElementById("root")).render(r.jsx(t.StrictMode,{children:r.jsx(zr,{})})),function(){if("undefined"!=typeof window){if("serviceWorker"in navigator){const e="/spsf-medal-explorer/pre/service-worker.js",t="/spsf-medal-explorer/pre/";navigator.serviceWorker.register(e,{scope:t}).catch(()=>{})}window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),window.dispatchEvent(new CustomEvent("pwa:install-available"))})}}();
