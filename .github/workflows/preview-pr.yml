name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: "pages-pr-${{ github.event.pull_request.number }}"
  cancel-in-progress: true

jobs:
  preview:
    runs-on: ubuntu-22.04
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run linting
        run: npm run lint

      - name: Run tests
        run: npm run test

      - name: Clone gh-pages site store
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          rm -rf site
          git clone --depth 1 --branch gh-pages "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" site

      - name: Compute PR app version (from git hash)
        id: prver
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA="$(git rev-parse --short HEAD)"
          echo "version=pr-${{ github.event.pull_request.number }}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build PR preview
        env:
          VITE_BASE: /${{ github.event.repository.name }}/pr/${{ github.event.pull_request.number }}/
          BUILD_NUMBER: ${{ github.run_number }}
          APP_VERSION: ${{ steps.prver.outputs.version }}
        run: npm run build

      - name: Add Pages helpers into dist
        run: bash scripts/add-pages-helpers.sh dist

      - name: Place preview under /pr/<n>
        run: |
          set -euo pipefail
          mkdir -p "site/pr/${{ github.event.pull_request.number }}"
          rsync -a dist/ "site/pr/${{ github.event.pull_request.number }}/"

      - name: Verify PR preview exists
        run: |
          set -euo pipefail
          test -f "site/pr/${{ github.event.pull_request.number }}/index.html"

      - name: Label PR manifest
        run: |
          set -euo pipefail
          sed -i 's/"name": "Skyttem채rken"/"name": "Skyttem채rken (PR #${{ github.event.pull_request.number }})"/' "site/pr/${{ github.event.pull_request.number }}/manifest.json"
          sed -i 's/"short_name": "Skyttem채rken"/"short_name": "Skyttem채rken (PR #${{ github.event.pull_request.number }})"/' "site/pr/${{ github.event.pull_request.number }}/manifest.json"

      - name: Stamp PR service worker version
        run: |
          set -euo pipefail
          sed -i "s/^const VERSION = .*/const VERSION = 'build-${{ github.run_number }}'/" "site/pr/${{ github.event.pull_request.number }}/service-worker.js" || true

      - name: Collect open PR numbers
        id: openprs
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            return data.map(pr => String(pr.number)).join(',');

      - name: Prune closed PR previews
        run: |
          set -euo pipefail
          OPEN="${{ steps.openprs.outputs.result }}"
          mkdir -p site/pr
          if [ -d site/pr ]; then
            for d in site/pr/*; do
              [ -d "$d" ] || continue
              num="$(basename "$d")"
              case ",$OPEN," in
                *,"$num",*) ;; # keep
                *) echo "Removing closed PR preview $num"; rm -rf "$d";;
              esac
            done
          fi

      - name: Commit and push PR preview to gh-pages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          cd site

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git remote get-url origin >/dev/null 2>&1; then
            git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          else
            git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          fi

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "pages store: add/update PR #${{ github.event.pull_request.number }} preview"
          fi

          # Push with a small retry in case gh-pages moved between clone and push
          for i in 1 2 3; do
            if git push -u origin gh-pages; then
              echo "Push succeeded"
              exit 0
            fi
            echo "Push failed (attempt $i). Fetching and retrying..."
            git fetch origin gh-pages
            git reset --hard origin/gh-pages
            sleep $((i * 2))
          done

          echo "ERROR: failed to push gh-pages after retries"
          exit 1

      - name: Comment preview URL
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            Preview ready:
            ${{
              endsWith(github.event.repository.name, '.github.io')
              && format('https://{0}/pr/{1}/', github.event.repository.name, github.event.pull_request.number)
              || format('https://{0}.github.io/{1}/pr/{2}/', github.repository_owner, github.event.repository.name, github.event.pull_request.number)
            }}
