name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read
  pages: write
  id-token: write

concurrency:
  group: 'pages-deploy'
  cancel-in-progress: true

jobs:
  release-to-root:
    name: Release -> /
    if: github.event_name == 'release'
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - name: Checkout code at tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event.release.tag_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test

      - name: Compute release version (strip v-prefix)
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          RAW_TAG="${{ github.event.release.tag_name }}"
          APP_VERSION="${RAW_TAG#v}"
          echo "app_version=${APP_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Release tag: ${RAW_TAG}"
          echo "App version: ${APP_VERSION}"

      - name: Build (prod, root)
        env:
          VITE_BASE: /${{ github.event.repository.name }}/
          APP_VERSION: ${{ steps.ver.outputs.app_version }}
        run: npm run build

      - name: Add Pages helpers into dist
        run: bash scripts/add-pages-helpers.sh dist

      - name: Clone gh-pages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          rm -rf site
          git clone --depth 1 --branch gh-pages "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" site
          git -C site fetch origin gh-pages
          git -C site switch gh-pages || git -C site switch -c gh-pages --track origin/gh-pages
          git -C site reset --hard origin/gh-pages
          git config --global --add safe.directory "$PWD/site" || true
          git -C site config user.name "github-actions[bot]"
          git -C site config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prune closed PR previews
        id: openprs
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            return data.map(pr => String(pr.number)).join(',');
      - name: Apply PR preview pruning
        run: |
          set -euo pipefail
          OPEN="${{ steps.openprs.outputs.result }}"
          mkdir -p site/pr
          if [ -d site/pr ]; then
            for d in site/pr/*; do
              [ -d "$d" ] || continue
              num="$(basename "$d")"
              case ",$OPEN," in
                *,"$num",*) ;; # keep
                *) echo "Removing closed PR preview $num"; rm -rf "$d";;
              esac
            done
          fi

      - name: Deploy built root to gh-pages /
        run: |
          set -euo pipefail
          # Sync dist -> site root, but preserve /pre, /pr, CNAME, .nojekyll
          rsync -a --delete \
            --filter='protect .git/***' \
            --filter='protect /pre/***' \
            --filter='protect /pr/***' \
            --filter='protect /CNAME' \
            --filter='protect /.nojekyll' \
            dist/ site/

      - name: Commit and push (root)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          for i in 1 2 3 4 5; do
            # Refresh to latest remote before applying changes
            git -C site fetch origin gh-pages
            git -C site reset --hard origin/gh-pages

            # Re-apply build output to root while preserving protected paths
            rsync -a --delete \
              --filter='protect .git/***' \
              --filter='protect /pre/***' \
              --filter='protect /pr/***' \
              --filter='protect /CNAME' \
              --filter='protect /.nojekyll' \
              dist/ site/

            git -C site add -A
            if git -C site diff --cached --quiet; then
              echo "No changes to commit."
            else
              git -C site commit -m "deploy: release ${{ github.event.release.tag_name }} to / (run ${{ github.run_number }})"
            fi

            if git -C site push origin HEAD:gh-pages; then
              echo "Push succeeded"
              exit 0
            fi

            echo "Push failed (attempt $i). Retrying after backoff..."
            sleep $((i * 2))
          done
          echo "ERROR: failed to push gh-pages after retries"
          exit 1

  main-to-pre:
    name: main -> /pre
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test

      - name: Compute preview version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          PKG_VERSION="$(node -p "require('./package.json').version")"
          SHA="$(git rev-parse --short HEAD)"
          APP_VERSION="${PKG_VERSION}-pre.${{ github.run_number }}+${SHA}"
          echo "app_version=${APP_VERSION}" >> "$GITHUB_OUTPUT"
          echo "App version: ${APP_VERSION}"

      - name: Build (preview, /pre)
        env:
          VITE_BASE: /${{ github.event.repository.name }}/pre/
          APP_VERSION: ${{ steps.ver.outputs.app_version }}
        run: npm run build

      - name: Add Pages helpers into dist
        run: bash scripts/add-pages-helpers.sh dist

      - name: Clone gh-pages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          rm -rf site
          git clone --depth 1 --branch gh-pages "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" site
          git -C site fetch origin gh-pages
          git -C site switch gh-pages || git -C site switch -c gh-pages --track origin/gh-pages
          git -C site reset --hard origin/gh-pages
          git config --global --add safe.directory "$PWD/site" || true
          git -C site config user.name "github-actions[bot]"
          git -C site config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prune closed PR previews
        id: openprs
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            return data.map(pr => String(pr.number)).join(',');
      - name: Apply PR preview pruning
        run: |
          set -euo pipefail
          OPEN="${{ steps.openprs.outputs.result }}"
          mkdir -p site/pr
          if [ -d site/pr ]; then
            for d in site/pr/*; do
              [ -d "$d" ] || continue
              num="$(basename "$d")"
              case ",$OPEN," in
                *,"$num",*) ;; # keep
                *) echo "Removing closed PR preview $num"; rm -rf "$d";;
              esac
            done
          fi

      - name: Deploy built preview to gh-pages /pre
        run: |
          set -euo pipefail
          mkdir -p site/pre
          rsync -a --delete dist/ site/pre/

      - name: Commit and push (/pre)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          for i in 1 2 3 4 5; do
            # Refresh to latest remote before applying changes
            git -C site fetch origin gh-pages
            git -C site reset --hard origin/gh-pages

            # Re-apply build output into /pre
            mkdir -p site/pre
            rsync -a --delete dist/ site/pre/

            git -C site add -A
            if git -C site diff --cached --quiet; then
              echo "No changes to commit."
            else
              git -C site commit -m "deploy: main to /pre (run ${{ github.run_number }})"
            fi

            if git -C site push origin HEAD:gh-pages; then
              echo "Push succeeded"
              exit 0
            fi

            echo "Push failed (attempt $i). Retrying after backoff..."
            sleep $((i * 2))
          done
          echo "ERROR: failed to push gh-pages after retries"
          exit 1
